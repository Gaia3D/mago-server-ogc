"use strict";function changeMagoStateAPI(e,t){if(null!==e){var r=new Mago3D.API("changeMagoState");r.setMagoEnable(t),e.callAPI(r)}}function changeLabelAPI(e,t){if(null!==e){var r=new Mago3D.API("changeLabel");r.setShowLabelInfo(t),e.callAPI(r)}}function changeOriginAPI(e,t){if(null!==e){var r=new Mago3D.API("changeOrigin");r.setShowOrigin(t),e.callAPI(r)}}function changeBoundingBoxAPI(e,t){if(null!==e){var r=new Mago3D.API("changeBoundingBox");r.setShowBoundingBox(t),e.callAPI(r)}}function changePropertyRenderingAPI(e,t,r,i){if(null!==e){var o=new Mago3D.API("changePropertyRendering");o.setShowShadow(t),o.setProjectId(r),o.setProperty(i),e.callAPI(o)}}function changeShadowAPI(e,t){if(null!==e){var r=new Mago3D.API("changeShadow");r.setShowShadow(t),e.callAPI(r)}}function changeColorAPI(e,t,r,i,o,n){if(null!==e){var a=new Mago3D.API("changeColor");a.setProjectId(t),a.setDataKey(r),a.setObjectIds(i),a.setProperty(o),a.setColor(n),e.callAPI(a)}}function changeLocationAndRotationAPI(e,t,r,i,o,n,a,s,l,u){if(null!==e){var c=new Mago3D.API("changeLocationAndRotation");c.setProjectId(t),c.setDataKey(r),c.setLatitude(i),c.setLongitude(o),c.setElevation(n),c.setHeading(a),c.setPitch(s),c.setRoll(l),c.setAnimationOption(u),e.callAPI(c)}}function changeObjectMoveAPI(e,t){if(null!==e){var r=new Mago3D.API("changeObjectMove");r.setObjectMoveMode(t),e.callAPI(r)}}function saveObjectMoveAPI(e,t){if(null!==e){var r=new Mago3D.API("saveObjectMove");r.setObjectMoveMode(t),e.callAPI(r)}}function deleteAllObjectMoveAPI(e,t){if(null!==e){var r=new Mago3D.API("deleteAllObjectMove");r.setObjectMoveMode(t),e.callAPI(r)}}function deleteAllChangeColorAPI(e){if(null!==e){var t=new Mago3D.API("deleteAllChangeColor");e.callAPI(t)}}function changeInsertIssueModeAPI(e,t){if(null!==e){var r=new Mago3D.API("changeInsertIssueMode");r.setIssueInsertEnable(t),e.callAPI(r)}}function changeObjectInfoViewModeAPI(e,t){if(null!==e){var r=new Mago3D.API("changeObjectInfoViewMode");r.setObjectInfoViewEnable(t),e.callAPI(r)}}function changeOcclusionCullingAPI(e,t,r){if(null!==e){var i=new Mago3D.API("changeOcclusionCulling");i.setOcclusionCullingEnable(t),i.setDataKey(r),e.callAPI(i)}}function changeFPVModeAPI(e,t){if(null!==e){var r=new Mago3D.API("changeFPVMode");r.setFPVMode(t),e.callAPI(r)}}function changeMagoModeAPI(e,t){if(null!==e){var r=new Mago3D.API("changeMagoMode");r.setMagoMode(t),e.callAPI(r)}}function changeNearGeoIssueListViewModeAPI(e,t){if(null!==e){var r=new Mago3D.API("changeNearGeoIssueListViewMode");r.setNearGeoIssueListEnable(t),e.callAPI(r)}}function changeInsertIssueStateAPI(e,t){if(null!==e){var r=new Mago3D.API("changeInsertIssueState");r.setInsertIssueState(t),e.callAPI(r)}}function changeLodAPI(e,t,r,i,o,n,a){if(null!==e){var s=new Mago3D.API("changeLod");s.setLod0DistInMeters(t),s.setLod1DistInMeters(r),s.setLod2DistInMeters(i),s.setLod3DistInMeters(o),s.setLod4DistInMeters(n),s.setLod5DistInMeters(a),e.callAPI(s)}}function changeLightingAPI(e,t,r,i,o,n){if(null!==e){var a=new Mago3D.API("changeLighting");a.setAmbientReflectionCoef(t),a.setDiffuseReflectionCoef(r),a.setSpecularReflectionCoef(i),a.setAmbientColor(o),a.setSpecularColor(n),e.callAPI(a)}}function changeSsaoRadiusAPI(e,t){if(null!==e){var r=new Mago3D.API("changeSsaoRadius");r.setSsaoRadius(t),e.callAPI(r)}}function clearAllDataAPI(e){if(null!==e){var t=new Mago3D.API("clearAllData");e.getMagoManager().config.clearAllData(),e.callAPI(t)}}function drawInsertIssueImageAPI(e,t,r,i,o,n,a,s){if(null!==e){var l=new Mago3D.API("drawInsertIssueImage");l.setDrawType(t),l.setIssueId(r),l.setIssueId(i),l.setDataKey(o),l.setLatitude(n),l.setLongitude(a),l.setElevation(s),e.callAPI(l)}}function gotoProjectAPI(e,t,r,i,o,n,a,s){if(null!==e){e.getMagoManager().config.setData(Mago3D.CODE.PROJECT_ID_PREFIX+t,r),e.getMagoManager().config.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+i,i);var l=new Mago3D.API("gotoProject");l.setProjectId(t),l.setProjectDataFolder(i),l.setLatitude(n),l.setLongitude(o),l.setElevation(a),l.setDuration(s),e.callAPI(l)}}function gotoIssueAPI(e,t,r,i,o,n,a,s,l,u){if(null!==e){e.getMagoManager().config.setData(Mago3D.CODE.PROJECT_ID_PREFIX+t,r),e.getMagoManager().config.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+i,i);var c=new Mago3D.API("gotoIssue");c.setProjectId(t),c.setProjectDataFolder(i),c.setIssueId(o),c.setIssueType(n),c.setLatitude(s),c.setLongitude(a),c.setElevation(l),c.setDuration(u),e.callAPI(c)}}function gotoFlyAPI(e,t,r,i,o){if(null!==e){var n=new Mago3D.API("gotoFly");n.setLongitude(t),n.setLatitude(r),n.setElevation(i),n.setDuration(o),e.callAPI(n)}}function mouseMoveAPI(e,t){null!==e&&e.mouseMove(t)}function searchDataAPI(e,t,r){if(null!==e){var i=new Mago3D.API("searchData");i.setProjectId(t),i.setDataKey(r),e.callAPI(i)}}function isDataExistAPI(e,t){return!!e.getMagoManager().config.isDataExist(t)}function getDataAPI(e,t){return e.getMagoManager().config.getData(t)}function getDataInfoByDataKeyAPI(e,t,r){if(null!==e){var i=new Mago3D.API("getDataInfoByDataKey");return i.setReturnable(!0),i.setProjectId(t),i.setDataKey(r),e.callAPI(i)}}function drawAppendDataAPI(e,t,r,i){if(null!==e&&!(t.length<=0)){var o=new Mago3D.API("drawAppendData");t.forEach(function(t,n){e.getMagoManager().config.setData(Mago3D.CODE.PROJECT_ID_PREFIX+t,r[n]),e.getMagoManager().config.setProjectDataFolder(Mago3D.CODE.PROJECT_DATA_FOLDER_PREFIX+i[n],i[n]),o.setProjectId(t),o.setProjectDataFolder(i[n]),e.callAPI(o)})}}function getCoordinateRelativeToBuildingAPI(e,t,r,i,o){if(null!==e){var n=new Mago3D.API("getCoordinateRelativeToBuilding");return n.setReturnable(!0),n.setProjectId(t),n.setDataKey(r),n.setInputPoint(i),n.setResultPoint(o),e.callAPI(n)}}function getAbsoluteCoodinateOfBuildingPointAPI(e,t,r,i,o){if(null!==e){var n=new Mago3D.API("getAbsoluteCoodinateOfBuildingPoint");return n.setReturnable(!0),n.setProjectId(t),n.setDataKey(r),n.setInputPoint(i),n.setResultPoint(o),e.callAPI(n)}}function getCameraCurrentPositionAPI(e,t){var r=new Mago3D.API("getCameraCurrentPosition");return r.setReturnable(!0),r.setUnit(t),e.callAPI(r)}function getCameraCurrentOrientaionAPI(e){var t=new Mago3D.API("getCameraCurrentOrientaion");return t.setReturnable(!0),e.callAPI(t)}function changeCameraOrientationAPI(e,t,r,i,o){var n=new Mago3D.API("changeCameraOrientation");n.setHeading(t),n.setPitch(r),n.setRoll(i),n.setDuration(o),e.callAPI(n)}function instantiateStaticModelAPI(e,t){var r=new Mago3D.API("instantiateStaticModel");r.setInstantiateObj(t),e.callAPI(r)}function addStaticModelAPI(e,t){var r=new Mago3D.API("addStaticModel");r.setStaticModelAttributeObj(t),e.callAPI(r)}function setTrackNodeAPI(e,t,r,i){var o=new Mago3D.API("setTrackNode");o.setProjectId(t),o.setDataKey(r),o.setTrackOption(i),e.callAPI(o)}function stopTrackAPI(e){var t=new Mago3D.API("stopTrack");e.callAPI(t)}function isExistStaticModelAPI(e,t){var r=new Mago3D.API("isExistStaticModel");return r.setReturnable(!0),r.setProjectId(t),e.callAPI(r)}function isExistDataAPI(e,t,r){var i=new Mago3D.API("isExistData");return i.setReturnable(!0),i.setProjectId(t),i.setDataKey(r),e.callAPI(i)}function isDataReadyToRenderAPI(e,t,r){var i=new Mago3D.API("isDataReadyToRender");return i.setReturnable(!0),i.setProjectId(t),i.setDataKey(r),e.callAPI(i)}function setNodeAttributeAPI(e,t,r,i){var o=new Mago3D.API("setNodeAttribute");o.setProjectId(t),o.setDataKey(r),o.setNodeAttribute(i),e.callAPI(o)}function togglePointCloudColorAPI(e){var t=new Mago3D.API("togglePointCloudColor");e.callAPI(t)}function selectF4dAPI(e,t,r){var i=new Mago3D.API("selectF4d");i.setProjectId(t),i.setDataKey(r),e.callAPI(i)}WebGL2RenderingContext=void 0;var geobuf,Pbf,DataStream=function(e,t,r){this._byteOffset=t||0,e instanceof ArrayBuffer?this.buffer=e:"object"==typeof e?(this.dataView=e,t&&(this._byteOffset+=t)):this.buffer=new ArrayBuffer(e||1),this.position=0,this.endianness=null==r?DataStream.LITTLE_ENDIAN:r};DataStream.prototype={},void 0===Uint8Array.prototype.BYTES_PER_ELEMENT&&(Uint8Array.prototype.BYTES_PER_ELEMENT=Uint8Array.BYTES_PER_ELEMENT,Int8Array.prototype.BYTES_PER_ELEMENT=Int8Array.BYTES_PER_ELEMENT,Uint8ClampedArray.prototype.BYTES_PER_ELEMENT=Uint8ClampedArray.BYTES_PER_ELEMENT,Uint16Array.prototype.BYTES_PER_ELEMENT=Uint16Array.BYTES_PER_ELEMENT,Int16Array.prototype.BYTES_PER_ELEMENT=Int16Array.BYTES_PER_ELEMENT,Uint32Array.prototype.BYTES_PER_ELEMENT=Uint32Array.BYTES_PER_ELEMENT,Int32Array.prototype.BYTES_PER_ELEMENT=Int32Array.BYTES_PER_ELEMENT,Float64Array.prototype.BYTES_PER_ELEMENT=Float64Array.BYTES_PER_ELEMENT),DataStream.prototype.save=function(e){var t=new Blob(this.buffer),r=window.webkitURL||window.URL;if(!r||!r.createObjectURL)throw"DataStream.save: Can't create object URL.";var i=r.createObjectURL(t),o=document.createElement("a");o.setAttribute("href",i),o.setAttribute("download",e),o.click(),r.revokeObjectURL(i)},DataStream.BIG_ENDIAN=!1,DataStream.LITTLE_ENDIAN=!0,DataStream.prototype._dynamicSize=!0,Object.defineProperty(DataStream.prototype,"dynamicSize",{get:function(){return this._dynamicSize},set:function(e){e||this._trimAlloc(),this._dynamicSize=e}}),DataStream.prototype._byteLength=0,Object.defineProperty(DataStream.prototype,"byteLength",{get:function(){return this._byteLength-this._byteOffset}}),Object.defineProperty(DataStream.prototype,"buffer",{get:function(){return this._trimAlloc(),this._buffer},set:function(e){this._buffer=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"byteOffset",{get:function(){return this._byteOffset},set:function(e){this._byteOffset=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}}),Object.defineProperty(DataStream.prototype,"dataView",{get:function(){return this._dataView},set:function(e){this._byteOffset=e.byteOffset,this._buffer=e.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+e.byteLength}}),DataStream.prototype._realloc=function(e){if(this._dynamicSize){var t=this._byteOffset+this.position+e,r=this._buffer.byteLength;if(t<=r)t>this._byteLength&&(this._byteLength=t);else{for(r<1&&(r=1);t>r;)r*=2;var i=new ArrayBuffer(r),o=new Uint8Array(this._buffer);new Uint8Array(i,0,o.length).set(o),this.buffer=i,this._byteLength=t}}},DataStream.prototype._trimAlloc=function(){if(this._byteLength!=this._buffer.byteLength){var e=new ArrayBuffer(this._byteLength),t=new Uint8Array(e),r=new Uint8Array(this._buffer,0,t.length);t.set(r),this.buffer=e}},DataStream.prototype.seek=function(e){var t=Math.max(0,Math.min(this.byteLength,e));this.position=isNaN(t)||!isFinite(t)?0:t},DataStream.prototype.isEof=function(){return this.position>=this.byteLength},DataStream.prototype.mapInt32Array=function(e,t){this._realloc(4*e);var r=new Int32Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=4*e,r},DataStream.prototype.mapInt16Array=function(e,t){this._realloc(2*e);var r=new Int16Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=2*e,r},DataStream.prototype.mapInt8Array=function(e){this._realloc(1*e);var t=new Int8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=1*e,t},DataStream.prototype.mapUint32Array=function(e,t){this._realloc(4*e);var r=new Uint32Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=4*e,r},DataStream.prototype.mapUint16Array=function(e,t){this._realloc(2*e);var r=new Uint16Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=2*e,r},DataStream.prototype.mapUint8Array=function(e){this._realloc(1*e);var t=new Uint8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=1*e,t},DataStream.prototype.mapFloat64Array=function(e,t){this._realloc(8*e);var r=new Float64Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=8*e,r},DataStream.prototype.mapFloat32Array=function(e,t){this._realloc(4*e);var r=new Float32Array(this._buffer,this.byteOffset+this.position,e);return DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=4*e,r},DataStream.prototype.readInt32Array=function(e,t){e=null==e?this.byteLength-this.position/4:e;var r=new Int32Array(e);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=r.byteLength,r},DataStream.prototype.readInt16Array=function(e,t){e=null==e?this.byteLength-this.position/2:e;var r=new Int16Array(e);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=r.byteLength,r},DataStream.prototype.readInt8Array=function(e){e=null==e?this.byteLength-this.position:e;var t=new Int8Array(e);return DataStream.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT),this.position+=t.byteLength,t},DataStream.prototype.readUint32Array=function(e,t){e=null==e?this.byteLength-this.position/4:e;var r=new Uint32Array(e);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=r.byteLength,r},DataStream.prototype.readUint16Array=function(e,t){e=null==e?this.byteLength-this.position/2:e;var r=new Uint16Array(e);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=r.byteLength,r},DataStream.prototype.readUint8Array=function(e){e=null==e?this.byteLength-this.position:e;var t=new Uint8Array(e);return DataStream.memcpy(t.buffer,0,this.buffer,this.byteOffset+this.position,e*t.BYTES_PER_ELEMENT),this.position+=t.byteLength,t},DataStream.prototype.readFloat64Array=function(e,t){e=null==e?this.byteLength-this.position/8:e;var r=new Float64Array(e);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=r.byteLength,r},DataStream.prototype.readFloat32Array=function(e,t){e=null==e?this.byteLength-this.position/4:e;var r=new Float32Array(e);return DataStream.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,e*r.BYTES_PER_ELEMENT),DataStream.arrayToNative(r,null==t?this.endianness:t),this.position+=r.byteLength,r},DataStream.prototype.writeInt32Array=function(e,t){if(this._realloc(4*e.length),e instanceof Int32Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapInt32Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeInt32(e[r],t)},DataStream.prototype.writeInt16Array=function(e,t){if(this._realloc(2*e.length),e instanceof Int16Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapInt16Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeInt16(e[r],t)},DataStream.prototype.writeInt8Array=function(e){if(this._realloc(1*e.length),e instanceof Int8Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapInt8Array(e.length);else for(var t=0;t<e.length;t++)this.writeInt8(e[t])},DataStream.prototype.writeUint32Array=function(e,t){if(this._realloc(4*e.length),e instanceof Uint32Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapUint32Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeUint32(e[r],t)},DataStream.prototype.writeUint16Array=function(e,t){if(this._realloc(2*e.length),e instanceof Uint16Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapUint16Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeUint16(e[r],t)},DataStream.prototype.writeUint8Array=function(e){if(this._realloc(1*e.length),e instanceof Uint8Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapUint8Array(e.length);else for(var t=0;t<e.length;t++)this.writeUint8(e[t])},DataStream.prototype.writeFloat64Array=function(e,t){if(this._realloc(8*e.length),e instanceof Float64Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapFloat64Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeFloat64(e[r],t)},DataStream.prototype.writeFloat32Array=function(e,t){if(this._realloc(4*e.length),e instanceof Float32Array&&(this.byteOffset+this.position)%e.BYTES_PER_ELEMENT==0)DataStream.memcpy(this._buffer,this.byteOffset+this.position,e.buffer,e.byteOffset,e.byteLength),this.mapFloat32Array(e.length,t);else for(var r=0;r<e.length;r++)this.writeFloat32(e[r],t)},DataStream.prototype.readInt32=function(e){var t=this._dataView.getInt32(this.position,null==e?this.endianness:e);return this.position+=4,t},DataStream.prototype.readInt16=function(e){var t=this._dataView.getInt16(this.position,null==e?this.endianness:e);return this.position+=2,t},DataStream.prototype.readInt8=function(){var e=this._dataView.getInt8(this.position);return this.position+=1,e},DataStream.prototype.readUint32=function(e){var t=this._dataView.getUint32(this.position,null==e?this.endianness:e);return this.position+=4,t},DataStream.prototype.readUint16=function(e){var t=this._dataView.getUint16(this.position,null==e?this.endianness:e);return this.position+=2,t},DataStream.prototype.readUint8=function(){var e=this._dataView.getUint8(this.position);return this.position+=1,e},DataStream.prototype.readFloat32=function(e){var t=this._dataView.getFloat32(this.position,null==e?this.endianness:e);return this.position+=4,t},DataStream.prototype.readFloat64=function(e){var t=this._dataView.getFloat64(this.position,null==e?this.endianness:e);return this.position+=8,t},DataStream.prototype.writeInt32=function(e,t){this._realloc(4),this._dataView.setInt32(this.position,e,null==t?this.endianness:t),this.position+=4},DataStream.prototype.writeInt16=function(e,t){this._realloc(2),this._dataView.setInt16(this.position,e,null==t?this.endianness:t),this.position+=2},DataStream.prototype.writeInt8=function(e){this._realloc(1),this._dataView.setInt8(this.position,e),this.position+=1},DataStream.prototype.writeUint32=function(e,t){this._realloc(4),this._dataView.setUint32(this.position,e,null==t?this.endianness:t),this.position+=4},DataStream.prototype.writeUint16=function(e,t){this._realloc(2),this._dataView.setUint16(this.position,e,null==t?this.endianness:t),this.position+=2},DataStream.prototype.writeUint8=function(e){this._realloc(1),this._dataView.setUint8(this.position,e),this.position+=1},DataStream.prototype.writeFloat32=function(e,t){this._realloc(4),this._dataView.setFloat32(this.position,e,null==t?this.endianness:t),this.position+=4},DataStream.prototype.writeFloat64=function(e,t){this._realloc(8),this._dataView.setFloat64(this.position,e,null==t?this.endianness:t),this.position+=8},DataStream.endianness=new Int8Array(new Int16Array([1]).buffer)[0]>0,DataStream.memcpy=function(e,t,r,i,o){var n=new Uint8Array(e,t,o),a=new Uint8Array(r,i,o);n.set(a)},DataStream.arrayToNative=function(e,t){return t==this.endianness?e:this.flipArrayEndianness(e)},DataStream.nativeToEndian=function(e,t){return this.endianness==t?e:this.flipArrayEndianness(e)},DataStream.flipArrayEndianness=function(e){for(var t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=0;r<e.byteLength;r+=e.BYTES_PER_ELEMENT)for(var i=r+e.BYTES_PER_ELEMENT-1,o=r;i>o;i--,o++){var n=t[o];t[o]=t[i],t[i]=n}return e},DataStream.createStringFromArray=function(e){for(var t=[],r=0;r<e.length;r+=32768)t.push(String.fromCharCode.apply(null,e.subarray(r,r+32768)));return t.join("")},DataStream.prototype.failurePosition=0,DataStream.prototype.readStruct=function(e){for(var t,r,i={},o=this.position,n=0;n<e.length;n+=2){if(t=e[n+1],null==(r=this.readType(t,i)))return 0==this.failurePosition&&(this.failurePosition=this.position),this.position=o,null;i[e[n]]=r}return i},DataStream.prototype.readUCS2String=function(e,t){return DataStream.createStringFromArray(this.readUint16Array(e,t))},DataStream.prototype.writeUCS2String=function(e,t,r){null==r&&(r=e.length);for(var i=0;i<e.length&&i<r;i++)this.writeUint16(e.charCodeAt(i),t);for(;i<r;i++)this.writeUint16(0)},DataStream.prototype.readString=function(e,t){return null==t||"ASCII"==t?DataStream.createStringFromArray(this.mapUint8Array(null==e?this.byteLength-this.position:e)):new TextDecoder(t).decode(this.mapUint8Array(e))},DataStream.prototype.writeString=function(e,t,r){if(null==t||"ASCII"==t)if(null!=r){var i=0,o=Math.min(e.length,r);for(i=0;i<o;i++)this.writeUint8(e.charCodeAt(i));for(;i<r;i++)this.writeUint8(0)}else for(i=0;i<e.length;i++)this.writeUint8(e.charCodeAt(i));else this.writeUint8Array(new TextEncoder(t).encode(e.substring(0,r)))},DataStream.prototype.readCString=function(e){var t=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position),i=t;null!=e&&(i=Math.min(e,t));for(var o=0;o<i&&0!=r[o];o++);var n=DataStream.createStringFromArray(this.mapUint8Array(o));return null!=e?this.position+=i-o:o!=t&&(this.position+=1),n},DataStream.prototype.writeCString=function(e,t){if(null!=t){var r=0,i=Math.min(e.length,t);for(r=0;r<i;r++)this.writeUint8(e.charCodeAt(r));for(;r<t;r++)this.writeUint8(0)}else{for(r=0;r<e.length;r++)this.writeUint8(e.charCodeAt(r));this.writeUint8(0)}},DataStream.prototype.readType=function(e,t){if("function"==typeof e)return e(this,t);if(!("object"!=typeof e||e instanceof Array))return e.get(this,t);if(e instanceof Array&&3!=e.length)return this.readStruct(e,t);var r,i=null,o=null,n="ASCII",a=this.position;"string"==typeof e&&/:/.test(e)&&(e=(r=e.split(":"))[0],o=null!=t[s=r[1]]?parseInt(t[s]):parseInt(r[1]));"string"==typeof e&&/,/.test(e)&&(e=(r=e.split(","))[0],n=parseInt(r[1]));switch(e){case"uint8":i=this.readUint8();break;case"int8":i=this.readInt8();break;case"uint16":i=this.readUint16(this.endianness);break;case"int16":i=this.readInt16(this.endianness);break;case"uint32":i=this.readUint32(this.endianness);break;case"int32":i=this.readInt32(this.endianness);break;case"float32":i=this.readFloat32(this.endianness);break;case"float64":i=this.readFloat64(this.endianness);break;case"uint16be":i=this.readUint16(DataStream.BIG_ENDIAN);break;case"int16be":i=this.readInt16(DataStream.BIG_ENDIAN);break;case"uint32be":i=this.readUint32(DataStream.BIG_ENDIAN);break;case"int32be":i=this.readInt32(DataStream.BIG_ENDIAN);break;case"float32be":i=this.readFloat32(DataStream.BIG_ENDIAN);break;case"float64be":i=this.readFloat64(DataStream.BIG_ENDIAN);break;case"uint16le":i=this.readUint16(DataStream.LITTLE_ENDIAN);break;case"int16le":i=this.readInt16(DataStream.LITTLE_ENDIAN);break;case"uint32le":i=this.readUint32(DataStream.LITTLE_ENDIAN);break;case"int32le":i=this.readInt32(DataStream.LITTLE_ENDIAN);break;case"float32le":i=this.readFloat32(DataStream.LITTLE_ENDIAN);break;case"float64le":i=this.readFloat64(DataStream.LITTLE_ENDIAN);break;case"cstring":i=this.readCString(o);break;case"string":i=this.readString(o,n);break;case"u16string":i=this.readUCS2String(o,this.endianness);break;case"u16stringle":i=this.readUCS2String(o,DataStream.LITTLE_ENDIAN);break;case"u16stringbe":i=this.readUCS2String(o,DataStream.BIG_ENDIAN);break;default:if(3==e.length){var s,l=e[1],u=0;if(u="function"==typeof(s=e[2])?s(t,this,e):"string"==typeof s&&null!=t[s]?parseInt(t[s]):parseInt(s),"string"==typeof l){var c=l.replace(/(le|be)$/,""),d=null;switch(/le$/.test(l)?d=DataStream.LITTLE_ENDIAN:/be$/.test(l)&&(d=DataStream.BIG_ENDIAN),"*"==s&&(u=null),c){case"uint8":i=this.readUint8Array(u);break;case"uint16":i=this.readUint16Array(u,d);break;case"uint32":i=this.readUint32Array(u,d);break;case"int8":i=this.readInt8Array(u);break;case"int16":i=this.readInt16Array(u,d);break;case"int32":i=this.readInt32Array(u,d);break;case"float32":i=this.readFloat32Array(u,d);break;case"float64":i=this.readFloat64Array(u,d);break;case"cstring":case"utf16string":case"string":if(null==u)for(i=[];!this.isEof();){if(null==(p=this.readType(l,t)))break;i.push(p)}else{i=new Array(u);for(var h=0;h<u;h++)i[h]=this.readType(l,t)}}}else if("*"==s)for(i=[],this.buffer;;){var f=this.position;try{var g=this.readType(l,t);if(null==g){this.position=f;break}i.push(g)}catch(e){this.position=f;break}}else{i=new Array(u);for(h=0;h<u;h++){var p;if(null==(p=this.readType(l,t)))return null;i[h]=p}}break}}return null!=o&&(this.position=a+o),i},DataStream.prototype.writeStruct=function(e,t){for(var r=0;r<e.length;r+=2){var i=e[r+1];this.writeType(i,t[e[r]],t)}},DataStream.prototype.writeType=function(e,t,r){if("function"==typeof e)return e(this,t);if("object"==typeof e&&!(e instanceof Array))return e.set(this,t,r);var i,o=null,n="ASCII",a=this.position;"string"==typeof e&&/:/.test(e)&&(e=(i=e.split(":"))[0],o=parseInt(i[1]));"string"==typeof e&&/,/.test(e)&&(e=(i=e.split(","))[0],n=parseInt(i[1]));switch(e){case"uint8":this.writeUint8(t);break;case"int8":this.writeInt8(t);break;case"uint16":this.writeUint16(t,this.endianness);break;case"int16":this.writeInt16(t,this.endianness);break;case"uint32":this.writeUint32(t,this.endianness);break;case"int32":this.writeInt32(t,this.endianness);break;case"float32":this.writeFloat32(t,this.endianness);break;case"float64":this.writeFloat64(t,this.endianness);break;case"uint16be":this.writeUint16(t,DataStream.BIG_ENDIAN);break;case"int16be":this.writeInt16(t,DataStream.BIG_ENDIAN);break;case"uint32be":this.writeUint32(t,DataStream.BIG_ENDIAN);break;case"int32be":this.writeInt32(t,DataStream.BIG_ENDIAN);break;case"float32be":this.writeFloat32(t,DataStream.BIG_ENDIAN);break;case"float64be":this.writeFloat64(t,DataStream.BIG_ENDIAN);break;case"uint16le":this.writeUint16(t,DataStream.LITTLE_ENDIAN);break;case"int16le":this.writeInt16(t,DataStream.LITTLE_ENDIAN);break;case"uint32le":this.writeUint32(t,DataStream.LITTLE_ENDIAN);break;case"int32le":this.writeInt32(t,DataStream.LITTLE_ENDIAN);break;case"float32le":this.writeFloat32(t,DataStream.LITTLE_ENDIAN);break;case"float64le":this.writeFloat64(t,DataStream.LITTLE_ENDIAN);break;case"cstring":this.writeCString(t,o);break;case"string":this.writeString(t,n,o);break;case"u16string":this.writeUCS2String(t,this.endianness,o);break;case"u16stringle":this.writeUCS2String(t,DataStream.LITTLE_ENDIAN,o);break;case"u16stringbe":this.writeUCS2String(t,DataStream.BIG_ENDIAN,o);break;default:if(3==e.length){for(var s=e[1],l=0;l<t.length;l++)this.writeType(s,t[l]);break}this.writeStruct(e,t)}null!=o&&(this.position=a,this._realloc(o),this.position=a+o)},"function"==typeof define&&define.amd&&define("DataStream",[],function(){return DataStream}),"object"==typeof module&&module&&module.exports&&(module.exports=DataStream),(()=>{var e={289:e=>{var t,r,i,o,n;e.exports=function(e){o=2,n=Math.pow(10,6),i=null,t=[],r=[];var a=e.readFields(s,{});return t=null,a};var a=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon","GeometryCollection"];function s(e,r,i){1===e?t.push(i.readString()):2===e?o=i.readVarint():3===e?n=Math.pow(10,i.readVarint()):4===e?function(e,t){t.type="FeatureCollection",t.features=[],e.readMessage(c,t)}(i,r):5===e?l(i,r):6===e&&u(i,r)}function l(e,t){t.type="Feature";var r=e.readMessage(d,t);return"geometry"in r||(r.geometry=null),r}function u(e,t){return t.type="Point",e.readMessage(h,t)}function c(e,t,i){1===e?t.features.push(l(i,{})):13===e?r.push(f(i)):15===e&&g(i,t)}function d(e,t,i){1===e?t.geometry=u(i,{}):11===e?t.id=i.readString():12===e?t.id=i.readSVarint():13===e?r.push(f(i)):14===e?t.properties=g(i,{}):15===e&&g(i,t)}function h(e,t,o){1===e?t.type=a[o.readVarint()]:2===e?i=o.readPackedVarint():3===e?function(e,t,r){"Point"===r?e.coordinates=function(e){for(var t=e.readVarint()+e.pos,r=[];e.pos<t;)r.push(e.readSVarint()/n);return r}(t):"MultiPoint"===r||"LineString"===r?e.coordinates=function(e){return p(e,e.readVarint()+e.pos)}(t):"MultiLineString"===r?e.coordinates=m(t):"Polygon"===r?e.coordinates=m(t,!0):"MultiPolygon"===r&&(e.coordinates=function(e){var t=e.readVarint()+e.pos;if(!i)return[[p(e,t,null,!0)]];for(var r=[],o=1,n=0;n<i[0];n++){for(var a=[],s=0;s<i[o];s++)a.push(p(e,t,i[o+1+s],!0));o+=i[o]+1,r.push(a)}return i=null,r}(t))}(t,o,t.type):4===e?(t.geometries=t.geometries||[],t.geometries.push(u(o,{}))):13===e?r.push(f(o)):15===e&&g(o,t)}function f(e){for(var t=e.readVarint()+e.pos,r=null;e.pos<t;){var i=e.readVarint()>>3;1===i?r=e.readString():2===i?r=e.readDouble():3===i?r=e.readVarint():4===i?r=-e.readVarint():5===i?r=e.readBoolean():6===i&&(r=JSON.parse(e.readString()))}return r}function g(e,i){for(var o=e.readVarint()+e.pos;e.pos<o;)i[t[e.readVarint()]]=r[e.readVarint()];return r=[],i}function p(e,t,r,i){var a,s,l=0,u=[],c=[];for(s=0;s<o;s++)c[s]=0;for(;r?l<r:e.pos<t;){for(a=[],s=0;s<o;s++)c[s]+=e.readSVarint(),a[s]=c[s]/n;u.push(a),l++}return i&&u.push(u[0]),u}function m(e,t){var r=e.readVarint()+e.pos;if(!i)return[p(e,r,null,t)];for(var o=[],n=0;n<i.length;n++)o.push(p(e,r,i[n],t));return i=null,o}},408:e=>{e.exports=function(e,s){t={},i=[],r=0,o=0,n=1,l(e),n=Math.min(n,a);for(var u=Math.ceil(Math.log(n)/Math.LN10),c=0;c<i.length;c++)s.writeStringField(1,i[c]);return 2!==o&&s.writeVarintField(2,o),6!==u&&s.writeVarintField(3,u),"FeatureCollection"===e.type?s.writeMessage(4,f,e):"Feature"===e.type?s.writeMessage(5,g,e):s.writeMessage(6,p,e),t=null,s.finish()};var t,r,i,o,n,a=1e6,s={Point:0,MultiPoint:1,LineString:2,MultiLineString:3,Polygon:4,MultiPolygon:5,GeometryCollection:6};function l(e){var t,r;if("FeatureCollection"===e.type)for(t=0;t<e.features.length;t++)l(e.features[t]);else if("Feature"===e.type)for(r in null!==e.geometry&&l(e.geometry),e.properties)h(r);else if("Point"===e.type)d(e.coordinates);else if("MultiPoint"===e.type)c(e.coordinates);else if("GeometryCollection"===e.type)for(t=0;t<e.geometries.length;t++)l(e.geometries[t]);else if("LineString"===e.type)c(e.coordinates);else if("Polygon"===e.type||"MultiLineString"===e.type)u(e.coordinates);else if("MultiPolygon"===e.type)for(t=0;t<e.coordinates.length;t++)u(e.coordinates[t]);for(r in e)T(r,e.type)||h(r)}function u(e){for(var t=0;t<e.length;t++)c(e[t])}function c(e){for(var t=0;t<e.length;t++)d(e[t])}function d(e){o=Math.max(o,e.length);for(var t=0;t<e.length;t++)for(;Math.round(e[t]*n)/n!==e[t]&&n<a;)n*=10}function h(e){void 0===t[e]&&(i.push(e),t[e]=r++)}function f(e,t){for(var r=0;r<e.features.length;r++)t.writeMessage(1,g,e.features[r]);m(e,t,!0)}function g(e,t){null!==e.geometry&&t.writeMessage(1,p,e.geometry),void 0!==e.id&&("number"==typeof e.id&&e.id%1==0?t.writeSVarintField(12,e.id):t.writeStringField(11,e.id)),e.properties&&m(e.properties,t),m(e,t,!0)}function p(e,t){t.writeVarintField(1,s[e.type]);var r=e.coordinates;if("Point"===e.type)!function(e,t){for(var r=[],i=0;i<o;i++)r.push(Math.round(e[i]*n));t.writePackedSVarint(3,r)}(r,t);else if("MultiPoint"===e.type)x(r,t);else if("LineString"===e.type)x(r,t);else if("MultiLineString"===e.type)_(r,t);else if("Polygon"===e.type)_(r,t,!0);else if("MultiPolygon"===e.type)!function(e,t){var r,i,o=e.length;if(1!==o||1!==e[0].length){var n=[o];for(r=0;r<o;r++)for(n.push(e[r].length),i=0;i<e[r].length;i++)n.push(e[r][i].length-1);t.writePackedVarint(2,n)}var a=[];for(r=0;r<o;r++)for(i=0;i<e[r].length;i++)y(a,e[r][i],!0);t.writePackedSVarint(3,a)}(r,t);else if("GeometryCollection"===e.type)for(var i=0;i<e.geometries.length;i++)t.writeMessage(4,p,e.geometries[i]);m(e,t,!0)}function m(e,r,i){var o=[],n=0;for(var a in e)i&&T(a,e.type)||(r.writeMessage(13,v,e[a]),o.push(t[a]),o.push(n++));r.writePackedVarint(i?15:14,o)}function v(e,t){if(null!==e){var r=typeof e;"string"===r?t.writeStringField(1,e):"boolean"===r?t.writeBooleanField(5,e):"object"===r?t.writeStringField(6,JSON.stringify(e)):"number"===r&&(e%1!=0?t.writeDoubleField(2,e):e>=0?t.writeVarintField(3,e):t.writeVarintField(4,-e))}}function x(e,t){var r=[];y(r,e),t.writePackedSVarint(3,r)}function _(e,t,r){var i,o=e.length;if(1!==o){var n=[];for(i=0;i<o;i++)n.push(e[i].length-(r?1:0));t.writePackedVarint(2,n)}var a=[];for(i=0;i<o;i++)y(a,e[i],r);t.writePackedSVarint(3,a)}function y(e,t,r){var i,a,s=t.length-(r?1:0),l=new Array(o);for(a=0;a<o;a++)l[a]=0;for(i=0;i<s;i++)for(a=0;a<o;a++){var u=Math.round(t[i][a]*n)-l[a];e.push(u),l[a]+=u}}function T(e,t){if("type"===e)return!0;if("FeatureCollection"===t){if("features"===e)return!0}else if("Feature"===t){if("id"===e||"properties"===e||"geometry"===e)return!0}else if("GeometryCollection"===t){if("geometries"===e)return!0}else if("coordinates"===e)return!0;return!1}}},t={};function r(i){var o=t[i];if(void 0!==o)return o.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,r),n.exports}var i={};(()=>{var e=i;const t=r(408),o=r(289);e.geobuf={encode:t,decode:o}})(),geobuf=i})(),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.glMatrix={})}(this,function(e){var t=1e-6,r="undefined"!=typeof Float32Array?Float32Array:Array,i=Math.random;var o=Math.PI/180;var n=Object.freeze({EPSILON:t,get ARRAY_TYPE(){return r},RANDOM:i,setMatrixArrayType:function(e){r=e},toRadian:function(e){return e*o},equals:function(e,r){return Math.abs(e-r)<=t*Math.max(1,Math.abs(e),Math.abs(r))}});function a(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[0],l=r[1],u=r[2],c=r[3];return e[0]=i*s+n*l,e[1]=o*s+a*l,e[2]=i*u+n*c,e[3]=o*u+a*c,e}function s(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}var l=a,u=s,c=Object.freeze({create:function(){var e=new r(4);return r!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},clone:function(e){var t=new r(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},fromValues:function(e,t,i,o){var n=new r(4);return n[0]=e,n[1]=t,n[2]=i,n[3]=o,n},set:function(e,t,r,i,o){return e[0]=t,e[1]=r,e[2]=i,e[3]=o,e},transpose:function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},invert:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=r*n-o*i;return a?(a=1/a,e[0]=n*a,e[1]=-i*a,e[2]=-o*a,e[3]=r*a,e):null},adjoint:function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},multiply:a,rotate:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=Math.sin(r),l=Math.cos(r);return e[0]=i*l+n*s,e[1]=o*l+a*s,e[2]=i*-s+n*l,e[3]=o*-s+a*l,e},scale:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[0],l=r[1];return e[0]=i*s,e[1]=o*s,e[2]=n*l,e[3]=a*l,e},fromRotation:function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=-r,e[3]=i,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},str:function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2))},LDU:function(e,t,r,i){return e[2]=i[2]/i[0],r[0]=i[0],r[1]=i[1],r[3]=i[3]-e[2]*r[1],[e,t,r]},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},subtract:s,exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},equals:function(e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1],u=r[2],c=r[3];return Math.abs(i-s)<=t*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(o-l)<=t*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(n-u)<=t*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(a-c)<=t*Math.max(1,Math.abs(a),Math.abs(c))},multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},multiplyScalarAndAdd:function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e},mul:l,sub:u});function d(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=r[0],c=r[1],d=r[2],h=r[3],f=r[4],g=r[5];return e[0]=i*u+n*c,e[1]=o*u+a*c,e[2]=i*d+n*h,e[3]=o*d+a*h,e[4]=i*f+n*g+s,e[5]=o*f+a*g+l,e}function h(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e}var f=d,g=h,p=Object.freeze({create:function(){var e=new r(6);return r!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},clone:function(e){var t=new r(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},fromValues:function(e,t,i,o,n,a){var s=new r(6);return s[0]=e,s[1]=t,s[2]=i,s[3]=o,s[4]=n,s[5]=a,s},set:function(e,t,r,i,o,n,a){return e[0]=t,e[1]=r,e[2]=i,e[3]=o,e[4]=n,e[5]=a,e},invert:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=t[4],s=t[5],l=r*n-i*o;return l?(l=1/l,e[0]=n*l,e[1]=-i*l,e[2]=-o*l,e[3]=r*l,e[4]=(o*s-n*a)*l,e[5]=(i*a-r*s)*l,e):null},determinant:function(e){return e[0]*e[3]-e[1]*e[2]},multiply:d,rotate:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=Math.sin(r),c=Math.cos(r);return e[0]=i*c+n*u,e[1]=o*c+a*u,e[2]=i*-u+n*c,e[3]=o*-u+a*c,e[4]=s,e[5]=l,e},scale:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=r[0],c=r[1];return e[0]=i*u,e[1]=o*u,e[2]=n*c,e[3]=a*c,e[4]=s,e[5]=l,e},translate:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=r[0],c=r[1];return e[0]=i,e[1]=o,e[2]=n,e[3]=a,e[4]=i*u+n*c+s,e[5]=o*u+a*c+l,e},fromRotation:function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=-r,e[3]=i,e[4]=0,e[5]=0,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},str:function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+1)},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e},subtract:h,multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e},multiplyScalarAndAdd:function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},equals:function(e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],u=r[0],c=r[1],d=r[2],h=r[3],f=r[4],g=r[5];return Math.abs(i-u)<=t*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(o-c)<=t*Math.max(1,Math.abs(o),Math.abs(c))&&Math.abs(n-d)<=t*Math.max(1,Math.abs(n),Math.abs(d))&&Math.abs(a-h)<=t*Math.max(1,Math.abs(a),Math.abs(h))&&Math.abs(s-f)<=t*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(l-g)<=t*Math.max(1,Math.abs(l),Math.abs(g))},mul:f,sub:g});function m(){var e=new r(9);return r!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function v(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],d=t[8],h=r[0],f=r[1],g=r[2],p=r[3],m=r[4],v=r[5],x=r[6],_=r[7],y=r[8];return e[0]=h*i+f*a+g*u,e[1]=h*o+f*s+g*c,e[2]=h*n+f*l+g*d,e[3]=p*i+m*a+v*u,e[4]=p*o+m*s+v*c,e[5]=p*n+m*l+v*d,e[6]=x*i+_*a+y*u,e[7]=x*o+_*s+y*c,e[8]=x*n+_*l+y*d,e}function x(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}var _=v,y=x,T=Object.freeze({create:m,fromMat4:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},clone:function(e){var t=new r(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},fromValues:function(e,t,i,o,n,a,s,l,u){var c=new r(9);return c[0]=e,c[1]=t,c[2]=i,c[3]=o,c[4]=n,c[5]=a,c[6]=s,c[7]=l,c[8]=u,c},set:function(e,t,r,i,o,n,a,s,l,u){return e[0]=t,e[1]=r,e[2]=i,e[3]=o,e[4]=n,e[5]=a,e[6]=s,e[7]=l,e[8]=u,e},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},transpose:function(e,t){if(e===t){var r=t[1],i=t[2],o=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=i,e[7]=o}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},invert:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8],d=c*a-s*u,h=-c*n+s*l,f=u*n-a*l,g=r*d+i*h+o*f;return g?(g=1/g,e[0]=d*g,e[1]=(-c*i+o*u)*g,e[2]=(s*i-o*a)*g,e[3]=h*g,e[4]=(c*r-o*l)*g,e[5]=(-s*r+o*n)*g,e[6]=f*g,e[7]=(-u*r+i*l)*g,e[8]=(a*r-i*n)*g,e):null},adjoint:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8];return e[0]=a*c-s*u,e[1]=o*u-i*c,e[2]=i*s-o*a,e[3]=s*l-n*c,e[4]=r*c-o*l,e[5]=o*n-r*s,e[6]=n*u-a*l,e[7]=i*l-r*u,e[8]=r*a-i*n,e},determinant:function(e){var t=e[0],r=e[1],i=e[2],o=e[3],n=e[4],a=e[5],s=e[6],l=e[7],u=e[8];return t*(u*n-a*l)+r*(-u*o+a*s)+i*(l*o-n*s)},multiply:v,translate:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],d=t[8],h=r[0],f=r[1];return e[0]=i,e[1]=o,e[2]=n,e[3]=a,e[4]=s,e[5]=l,e[6]=h*i+f*a+u,e[7]=h*o+f*s+c,e[8]=h*n+f*l+d,e},rotate:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],d=t[8],h=Math.sin(r),f=Math.cos(r);return e[0]=f*i+h*a,e[1]=f*o+h*s,e[2]=f*n+h*l,e[3]=f*a-h*i,e[4]=f*s-h*o,e[5]=f*l-h*n,e[6]=u,e[7]=c,e[8]=d,e},scale:function(e,t,r){var i=r[0],o=r[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=o*t[3],e[4]=o*t[4],e[5]=o*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},fromRotation:function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=-r,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fromMat2d:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},fromQuat:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=r+r,s=i+i,l=o+o,u=r*a,c=i*a,d=i*s,h=o*a,f=o*s,g=o*l,p=n*a,m=n*s,v=n*l;return e[0]=1-d-g,e[3]=c-v,e[6]=h+m,e[1]=c+v,e[4]=1-u-g,e[7]=f-p,e[2]=h-m,e[5]=f+p,e[8]=1-u-d,e},normalFromMat4:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8],d=t[9],h=t[10],f=t[11],g=t[12],p=t[13],m=t[14],v=t[15],x=r*s-i*a,_=r*l-o*a,y=r*u-n*a,T=i*l-o*s,C=i*u-n*s,b=o*u-n*l,M=c*p-d*g,A=c*m-h*g,E=c*v-f*g,L=d*m-h*p,w=d*v-f*p,S=h*v-f*m,D=x*S-_*w+y*L+T*E-C*A+b*M;return D?(D=1/D,e[0]=(s*S-l*w+u*L)*D,e[1]=(l*E-a*S-u*A)*D,e[2]=(a*w-s*E+u*M)*D,e[3]=(o*w-i*S-n*L)*D,e[4]=(r*S-o*E+n*A)*D,e[5]=(i*E-r*w-n*M)*D,e[6]=(p*b-m*C+v*T)*D,e[7]=(m*y-g*b-v*_)*D,e[8]=(g*C-p*y+v*x)*D,e):null},projection:function(e,t,r){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/r,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},str:function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2))},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e},subtract:x,multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e},multiplyScalarAndAdd:function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e[6]=t[6]+r[6]*i,e[7]=t[7]+r[7]*i,e[8]=t[8]+r[8]*i,e},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},equals:function(e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],u=e[6],c=e[7],d=e[8],h=r[0],f=r[1],g=r[2],p=r[3],m=r[4],v=r[5],x=r[6],_=r[7],y=r[8];return Math.abs(i-h)<=t*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(o-f)<=t*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(n-g)<=t*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(a-p)<=t*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(s-m)<=t*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(l-v)<=t*Math.max(1,Math.abs(l),Math.abs(v))&&Math.abs(u-x)<=t*Math.max(1,Math.abs(u),Math.abs(x))&&Math.abs(c-_)<=t*Math.max(1,Math.abs(c),Math.abs(_))&&Math.abs(d-y)<=t*Math.max(1,Math.abs(d),Math.abs(y))},mul:_,sub:y});function C(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function b(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],d=t[8],h=t[9],f=t[10],g=t[11],p=t[12],m=t[13],v=t[14],x=t[15],_=r[0],y=r[1],T=r[2],C=r[3];return e[0]=_*i+y*s+T*d+C*p,e[1]=_*o+y*l+T*h+C*m,e[2]=_*n+y*u+T*f+C*v,e[3]=_*a+y*c+T*g+C*x,_=r[4],y=r[5],T=r[6],C=r[7],e[4]=_*i+y*s+T*d+C*p,e[5]=_*o+y*l+T*h+C*m,e[6]=_*n+y*u+T*f+C*v,e[7]=_*a+y*c+T*g+C*x,_=r[8],y=r[9],T=r[10],C=r[11],e[8]=_*i+y*s+T*d+C*p,e[9]=_*o+y*l+T*h+C*m,e[10]=_*n+y*u+T*f+C*v,e[11]=_*a+y*c+T*g+C*x,_=r[12],y=r[13],T=r[14],C=r[15],e[12]=_*i+y*s+T*d+C*p,e[13]=_*o+y*l+T*h+C*m,e[14]=_*n+y*u+T*f+C*v,e[15]=_*a+y*c+T*g+C*x,e}function M(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=i+i,l=o+o,u=n+n,c=i*s,d=i*l,h=i*u,f=o*l,g=o*u,p=n*u,m=a*s,v=a*l,x=a*u;return e[0]=1-(f+p),e[1]=d+x,e[2]=h-v,e[3]=0,e[4]=d-x,e[5]=1-(c+p),e[6]=g+m,e[7]=0,e[8]=h+v,e[9]=g-m,e[10]=1-(c+f),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function A(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function E(e,t){var r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function L(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e[9]=t[9]-r[9],e[10]=t[10]-r[10],e[11]=t[11]-r[11],e[12]=t[12]-r[12],e[13]=t[13]-r[13],e[14]=t[14]-r[14],e[15]=t[15]-r[15],e}var w=b,S=L,D=Object.freeze({create:function(){var e=new r(16);return r!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},clone:function(e){var t=new r(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},fromValues:function(e,t,i,o,n,a,s,l,u,c,d,h,f,g,p,m){var v=new r(16);return v[0]=e,v[1]=t,v[2]=i,v[3]=o,v[4]=n,v[5]=a,v[6]=s,v[7]=l,v[8]=u,v[9]=c,v[10]=d,v[11]=h,v[12]=f,v[13]=g,v[14]=p,v[15]=m,v},set:function(e,t,r,i,o,n,a,s,l,u,c,d,h,f,g,p,m){return e[0]=t,e[1]=r,e[2]=i,e[3]=o,e[4]=n,e[5]=a,e[6]=s,e[7]=l,e[8]=u,e[9]=c,e[10]=d,e[11]=h,e[12]=f,e[13]=g,e[14]=p,e[15]=m,e},identity:C,transpose:function(e,t){if(e===t){var r=t[1],i=t[2],o=t[3],n=t[6],a=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=n,e[11]=t[14],e[12]=o,e[13]=a,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},invert:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8],d=t[9],h=t[10],f=t[11],g=t[12],p=t[13],m=t[14],v=t[15],x=r*s-i*a,_=r*l-o*a,y=r*u-n*a,T=i*l-o*s,C=i*u-n*s,b=o*u-n*l,M=c*p-d*g,A=c*m-h*g,E=c*v-f*g,L=d*m-h*p,w=d*v-f*p,S=h*v-f*m,D=x*S-_*w+y*L+T*E-C*A+b*M;return D?(D=1/D,e[0]=(s*S-l*w+u*L)*D,e[1]=(o*w-i*S-n*L)*D,e[2]=(p*b-m*C+v*T)*D,e[3]=(h*C-d*b-f*T)*D,e[4]=(l*E-a*S-u*A)*D,e[5]=(r*S-o*E+n*A)*D,e[6]=(m*y-g*b-v*_)*D,e[7]=(c*b-h*y+f*_)*D,e[8]=(a*w-s*E+u*M)*D,e[9]=(i*E-r*w-n*M)*D,e[10]=(g*C-p*y+v*x)*D,e[11]=(d*y-c*C-f*x)*D,e[12]=(s*A-a*L-l*M)*D,e[13]=(r*L-i*A+o*M)*D,e[14]=(p*_-g*T-m*x)*D,e[15]=(c*T-d*_+h*x)*D,e):null},adjoint:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8],d=t[9],h=t[10],f=t[11],g=t[12],p=t[13],m=t[14],v=t[15];return e[0]=s*(h*v-f*m)-d*(l*v-u*m)+p*(l*f-u*h),e[1]=-(i*(h*v-f*m)-d*(o*v-n*m)+p*(o*f-n*h)),e[2]=i*(l*v-u*m)-s*(o*v-n*m)+p*(o*u-n*l),e[3]=-(i*(l*f-u*h)-s*(o*f-n*h)+d*(o*u-n*l)),e[4]=-(a*(h*v-f*m)-c*(l*v-u*m)+g*(l*f-u*h)),e[5]=r*(h*v-f*m)-c*(o*v-n*m)+g*(o*f-n*h),e[6]=-(r*(l*v-u*m)-a*(o*v-n*m)+g*(o*u-n*l)),e[7]=r*(l*f-u*h)-a*(o*f-n*h)+c*(o*u-n*l),e[8]=a*(d*v-f*p)-c*(s*v-u*p)+g*(s*f-u*d),e[9]=-(r*(d*v-f*p)-c*(i*v-n*p)+g*(i*f-n*d)),e[10]=r*(s*v-u*p)-a*(i*v-n*p)+g*(i*u-n*s),e[11]=-(r*(s*f-u*d)-a*(i*f-n*d)+c*(i*u-n*s)),e[12]=-(a*(d*m-h*p)-c*(s*m-l*p)+g*(s*h-l*d)),e[13]=r*(d*m-h*p)-c*(i*m-o*p)+g*(i*h-o*d),e[14]=-(r*(s*m-l*p)-a*(i*m-o*p)+g*(i*l-o*s)),e[15]=r*(s*h-l*d)-a*(i*h-o*d)+c*(i*l-o*s),e},determinant:function(e){var t=e[0],r=e[1],i=e[2],o=e[3],n=e[4],a=e[5],s=e[6],l=e[7],u=e[8],c=e[9],d=e[10],h=e[11],f=e[12],g=e[13],p=e[14],m=e[15];return(t*a-r*n)*(d*m-h*p)-(t*s-i*n)*(c*m-h*g)+(t*l-o*n)*(c*p-d*g)+(r*s-i*a)*(u*m-h*f)-(r*l-o*a)*(u*p-d*f)+(i*l-o*s)*(u*g-c*f)},multiply:b,translate:function(e,t,r){var i,o,n,a,s,l,u,c,d,h,f,g,p=r[0],m=r[1],v=r[2];return t===e?(e[12]=t[0]*p+t[4]*m+t[8]*v+t[12],e[13]=t[1]*p+t[5]*m+t[9]*v+t[13],e[14]=t[2]*p+t[6]*m+t[10]*v+t[14],e[15]=t[3]*p+t[7]*m+t[11]*v+t[15]):(i=t[0],o=t[1],n=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],d=t[8],h=t[9],f=t[10],g=t[11],e[0]=i,e[1]=o,e[2]=n,e[3]=a,e[4]=s,e[5]=l,e[6]=u,e[7]=c,e[8]=d,e[9]=h,e[10]=f,e[11]=g,e[12]=i*p+s*m+d*v+t[12],e[13]=o*p+l*m+h*v+t[13],e[14]=n*p+u*m+f*v+t[14],e[15]=a*p+c*m+g*v+t[15]),e},scale:function(e,t,r){var i=r[0],o=r[1],n=r[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*o,e[5]=t[5]*o,e[6]=t[6]*o,e[7]=t[7]*o,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},rotate:function(e,r,i,o){var n,a,s,l,u,c,d,h,f,g,p,m,v,x,_,y,T,C,b,M,A,E,L,w,S=o[0],D=o[1],R=o[2],P=Math.sqrt(S*S+D*D+R*R);return P<t?null:(S*=P=1/P,D*=P,R*=P,n=Math.sin(i),s=1-(a=Math.cos(i)),l=r[0],u=r[1],c=r[2],d=r[3],h=r[4],f=r[5],g=r[6],p=r[7],m=r[8],v=r[9],x=r[10],_=r[11],y=S*S*s+a,T=D*S*s+R*n,C=R*S*s-D*n,b=S*D*s-R*n,M=D*D*s+a,A=R*D*s+S*n,E=S*R*s+D*n,L=D*R*s-S*n,w=R*R*s+a,e[0]=l*y+h*T+m*C,e[1]=u*y+f*T+v*C,e[2]=c*y+g*T+x*C,e[3]=d*y+p*T+_*C,e[4]=l*b+h*M+m*A,e[5]=u*b+f*M+v*A,e[6]=c*b+g*M+x*A,e[7]=d*b+p*M+_*A,e[8]=l*E+h*L+m*w,e[9]=u*E+f*L+v*w,e[10]=c*E+g*L+x*w,e[11]=d*E+p*L+_*w,r!==e&&(e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e)},rotateX:function(e,t,r){var i=Math.sin(r),o=Math.cos(r),n=t[4],a=t[5],s=t[6],l=t[7],u=t[8],c=t[9],d=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*o+u*i,e[5]=a*o+c*i,e[6]=s*o+d*i,e[7]=l*o+h*i,e[8]=u*o-n*i,e[9]=c*o-a*i,e[10]=d*o-s*i,e[11]=h*o-l*i,e},rotateY:function(e,t,r){var i=Math.sin(r),o=Math.cos(r),n=t[0],a=t[1],s=t[2],l=t[3],u=t[8],c=t[9],d=t[10],h=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*o-u*i,e[1]=a*o-c*i,e[2]=s*o-d*i,e[3]=l*o-h*i,e[8]=n*i+u*o,e[9]=a*i+c*o,e[10]=s*i+d*o,e[11]=l*i+h*o,e},rotateZ:function(e,t,r){var i=Math.sin(r),o=Math.cos(r),n=t[0],a=t[1],s=t[2],l=t[3],u=t[4],c=t[5],d=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*o+u*i,e[1]=a*o+c*i,e[2]=s*o+d*i,e[3]=l*o+h*i,e[4]=u*o-n*i,e[5]=c*o-a*i,e[6]=d*o-s*i,e[7]=h*o-l*i,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromRotation:function(e,r,i){var o,n,a,s=i[0],l=i[1],u=i[2],c=Math.sqrt(s*s+l*l+u*u);return c<t?null:(s*=c=1/c,l*=c,u*=c,o=Math.sin(r),a=1-(n=Math.cos(r)),e[0]=s*s*a+n,e[1]=l*s*a+u*o,e[2]=u*s*a-l*o,e[3]=0,e[4]=s*l*a-u*o,e[5]=l*l*a+n,e[6]=u*l*a+s*o,e[7]=0,e[8]=s*u*a+l*o,e[9]=l*u*a-s*o,e[10]=u*u*a+n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},fromXRotation:function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromYRotation:function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromZRotation:function(e,t){var r=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromRotationTranslation:M,fromQuat2:function(e,t){var i=new r(3),o=-t[0],n=-t[1],a=-t[2],s=t[3],l=t[4],u=t[5],c=t[6],d=t[7],h=o*o+n*n+a*a+s*s;return h>0?(i[0]=2*(l*s+d*o+u*a-c*n)/h,i[1]=2*(u*s+d*n+c*o-l*a)/h,i[2]=2*(c*s+d*a+l*n-u*o)/h):(i[0]=2*(l*s+d*o+u*a-c*n),i[1]=2*(u*s+d*n+c*o-l*a),i[2]=2*(c*s+d*a+l*n-u*o)),M(e,t,i),e},getTranslation:A,getScaling:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[4],a=t[5],s=t[6],l=t[8],u=t[9],c=t[10];return e[0]=Math.sqrt(r*r+i*i+o*o),e[1]=Math.sqrt(n*n+a*a+s*s),e[2]=Math.sqrt(l*l+u*u+c*c),e},getRotation:E,fromRotationTranslationScale:function(e,t,r,i){var o=t[0],n=t[1],a=t[2],s=t[3],l=o+o,u=n+n,c=a+a,d=o*l,h=o*u,f=o*c,g=n*u,p=n*c,m=a*c,v=s*l,x=s*u,_=s*c,y=i[0],T=i[1],C=i[2];return e[0]=(1-(g+m))*y,e[1]=(h+_)*y,e[2]=(f-x)*y,e[3]=0,e[4]=(h-_)*T,e[5]=(1-(d+m))*T,e[6]=(p+v)*T,e[7]=0,e[8]=(f+x)*C,e[9]=(p-v)*C,e[10]=(1-(d+g))*C,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e},fromRotationTranslationScaleOrigin:function(e,t,r,i,o){var n=t[0],a=t[1],s=t[2],l=t[3],u=n+n,c=a+a,d=s+s,h=n*u,f=n*c,g=n*d,p=a*c,m=a*d,v=s*d,x=l*u,_=l*c,y=l*d,T=i[0],C=i[1],b=i[2],M=o[0],A=o[1],E=o[2],L=(1-(p+v))*T,w=(f+y)*T,S=(g-_)*T,D=(f-y)*C,R=(1-(h+v))*C,P=(m+x)*C,I=(g+_)*b,F=(m-x)*b,O=(1-(h+p))*b;return e[0]=L,e[1]=w,e[2]=S,e[3]=0,e[4]=D,e[5]=R,e[6]=P,e[7]=0,e[8]=I,e[9]=F,e[10]=O,e[11]=0,e[12]=r[0]+M-(L*M+D*A+I*E),e[13]=r[1]+A-(w*M+R*A+F*E),e[14]=r[2]+E-(S*M+P*A+O*E),e[15]=1,e},fromQuat:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=r+r,s=i+i,l=o+o,u=r*a,c=i*a,d=i*s,h=o*a,f=o*s,g=o*l,p=n*a,m=n*s,v=n*l;return e[0]=1-d-g,e[1]=c+v,e[2]=h-m,e[3]=0,e[4]=c-v,e[5]=1-u-g,e[6]=f+p,e[7]=0,e[8]=h+m,e[9]=f-p,e[10]=1-u-d,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},frustum:function(e,t,r,i,o,n,a){var s=1/(r-t),l=1/(o-i),u=1/(n-a);return e[0]=2*n*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*l,e[6]=0,e[7]=0,e[8]=(r+t)*s,e[9]=(o+i)*l,e[10]=(a+n)*u,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*n*2*u,e[15]=0,e},perspective:function(e,t,r,i,o){var n,a=1/Math.tan(t/2);return e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=o&&o!==1/0?(n=1/(i-o),e[10]=(o+i)*n,e[14]=2*o*i*n):(e[10]=-1,e[14]=-2*i),e},perspectiveFromFieldOfView:function(e,t,r,i){var o=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),s=Math.tan(t.rightDegrees*Math.PI/180),l=2/(a+s),u=2/(o+n);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=u,e[6]=0,e[7]=0,e[8]=-(a-s)*l*.5,e[9]=(o-n)*u*.5,e[10]=i/(r-i),e[11]=-1,e[12]=0,e[13]=0,e[14]=i*r/(r-i),e[15]=0,e},ortho:function(e,t,r,i,o,n,a){var s=1/(t-r),l=1/(i-o),u=1/(n-a);return e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+r)*s,e[13]=(o+i)*l,e[14]=(a+n)*u,e[15]=1,e},lookAt:function(e,r,i,o){var n,a,s,l,u,c,d,h,f,g,p=r[0],m=r[1],v=r[2],x=o[0],_=o[1],y=o[2],T=i[0],b=i[1],M=i[2];return Math.abs(p-T)<t&&Math.abs(m-b)<t&&Math.abs(v-M)<t?C(e):(d=p-T,h=m-b,f=v-M,n=_*(f*=g=1/Math.sqrt(d*d+h*h+f*f))-y*(h*=g),a=y*(d*=g)-x*f,s=x*h-_*d,(g=Math.sqrt(n*n+a*a+s*s))?(n*=g=1/g,a*=g,s*=g):(n=0,a=0,s=0),l=h*s-f*a,u=f*n-d*s,c=d*a-h*n,(g=Math.sqrt(l*l+u*u+c*c))?(l*=g=1/g,u*=g,c*=g):(l=0,u=0,c=0),e[0]=n,e[1]=l,e[2]=d,e[3]=0,e[4]=a,e[5]=u,e[6]=h,e[7]=0,e[8]=s,e[9]=c,e[10]=f,e[11]=0,e[12]=-(n*p+a*m+s*v),e[13]=-(l*p+u*m+c*v),e[14]=-(d*p+h*m+f*v),e[15]=1,e)},targetTo:function(e,t,r,i){var o=t[0],n=t[1],a=t[2],s=i[0],l=i[1],u=i[2],c=o-r[0],d=n-r[1],h=a-r[2],f=c*c+d*d+h*h;f>0&&(c*=f=1/Math.sqrt(f),d*=f,h*=f);var g=l*h-u*d,p=u*c-s*h,m=s*d-l*c;return(f=g*g+p*p+m*m)>0&&(g*=f=1/Math.sqrt(f),p*=f,m*=f),e[0]=g,e[1]=p,e[2]=m,e[3]=0,e[4]=d*m-h*p,e[5]=h*g-c*m,e[6]=c*p-d*g,e[7]=0,e[8]=c,e[9]=d,e[10]=h,e[11]=0,e[12]=o,e[13]=n,e[14]=a,e[15]=1,e},str:function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},frob:function(e){return Math.sqrt(Math.pow(e[0],2)+Math.pow(e[1],2)+Math.pow(e[2],2)+Math.pow(e[3],2)+Math.pow(e[4],2)+Math.pow(e[5],2)+Math.pow(e[6],2)+Math.pow(e[7],2)+Math.pow(e[8],2)+Math.pow(e[9],2)+Math.pow(e[10],2)+Math.pow(e[11],2)+Math.pow(e[12],2)+Math.pow(e[13],2)+Math.pow(e[14],2)+Math.pow(e[15],2))},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e[9]=t[9]+r[9],e[10]=t[10]+r[10],e[11]=t[11]+r[11],e[12]=t[12]+r[12],e[13]=t[13]+r[13],e[14]=t[14]+r[14],e[15]=t[15]+r[15],e},subtract:L,multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12]*r,e[13]=t[13]*r,e[14]=t[14]*r,e[15]=t[15]*r,e},multiplyScalarAndAdd:function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e[4]=t[4]+r[4]*i,e[5]=t[5]+r[5]*i,e[6]=t[6]+r[6]*i,e[7]=t[7]+r[7]*i,e[8]=t[8]+r[8]*i,e[9]=t[9]+r[9]*i,e[10]=t[10]+r[10]*i,e[11]=t[11]+r[11]*i,e[12]=t[12]+r[12]*i,e[13]=t[13]+r[13]*i,e[14]=t[14]+r[14]*i,e[15]=t[15]+r[15]*i,e},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},equals:function(e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],u=e[6],c=e[7],d=e[8],h=e[9],f=e[10],g=e[11],p=e[12],m=e[13],v=e[14],x=e[15],_=r[0],y=r[1],T=r[2],C=r[3],b=r[4],M=r[5],A=r[6],E=r[7],L=r[8],w=r[9],S=r[10],D=r[11],R=r[12],P=r[13],I=r[14],F=r[15];return Math.abs(i-_)<=t*Math.max(1,Math.abs(i),Math.abs(_))&&Math.abs(o-y)<=t*Math.max(1,Math.abs(o),Math.abs(y))&&Math.abs(n-T)<=t*Math.max(1,Math.abs(n),Math.abs(T))&&Math.abs(a-C)<=t*Math.max(1,Math.abs(a),Math.abs(C))&&Math.abs(s-b)<=t*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(l-M)<=t*Math.max(1,Math.abs(l),Math.abs(M))&&Math.abs(u-A)<=t*Math.max(1,Math.abs(u),Math.abs(A))&&Math.abs(c-E)<=t*Math.max(1,Math.abs(c),Math.abs(E))&&Math.abs(d-L)<=t*Math.max(1,Math.abs(d),Math.abs(L))&&Math.abs(h-w)<=t*Math.max(1,Math.abs(h),Math.abs(w))&&Math.abs(f-S)<=t*Math.max(1,Math.abs(f),Math.abs(S))&&Math.abs(g-D)<=t*Math.max(1,Math.abs(g),Math.abs(D))&&Math.abs(p-R)<=t*Math.max(1,Math.abs(p),Math.abs(R))&&Math.abs(m-P)<=t*Math.max(1,Math.abs(m),Math.abs(P))&&Math.abs(v-I)<=t*Math.max(1,Math.abs(v),Math.abs(I))&&Math.abs(x-F)<=t*Math.max(1,Math.abs(x),Math.abs(F))},mul:w,sub:S});function R(){var e=new r(3);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function P(e){var t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)}function I(e,t,i){var o=new r(3);return o[0]=e,o[1]=t,o[2]=i,o}function F(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function O(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function B(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function N(e,t){var r=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return Math.sqrt(r*r+i*i+o*o)}function U(e,t){var r=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2];return r*r+i*i+o*o}function G(e){var t=e[0],r=e[1],i=e[2];return t*t+r*r+i*i}function z(e,t){var r=t[0],i=t[1],o=t[2],n=r*r+i*i+o*o;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function H(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function V(e,t,r){var i=t[0],o=t[1],n=t[2],a=r[0],s=r[1],l=r[2];return e[0]=o*l-n*s,e[1]=n*a-i*l,e[2]=i*s-o*a,e}var k,j=F,W=O,X=B,Y=N,q=U,K=P,Z=G,J=(k=R(),function(e,t,r,i,o,n){var a,s;for(t||(t=3),r||(r=0),s=i?Math.min(i*t+r,e.length):e.length,a=r;a<s;a+=t)k[0]=e[a],k[1]=e[a+1],k[2]=e[a+2],o(k,k,n),e[a]=k[0],e[a+1]=k[1],e[a+2]=k[2];return e}),Q=Object.freeze({create:R,clone:function(e){var t=new r(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},length:P,fromValues:I,copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},set:function(e,t,r,i){return e[0]=t,e[1]=r,e[2]=i,e},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e},subtract:F,multiply:O,divide:B,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},min:function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},max:function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},scale:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e},scaleAndAdd:function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e},distance:N,squaredDistance:U,squaredLength:G,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},normalize:z,dot:H,cross:V,lerp:function(e,t,r,i){var o=t[0],n=t[1],a=t[2];return e[0]=o+i*(r[0]-o),e[1]=n+i*(r[1]-n),e[2]=a+i*(r[2]-a),e},hermite:function(e,t,r,i,o,n){var a=n*n,s=a*(2*n-3)+1,l=a*(n-2)+n,u=a*(n-1),c=a*(3-2*n);return e[0]=t[0]*s+r[0]*l+i[0]*u+o[0]*c,e[1]=t[1]*s+r[1]*l+i[1]*u+o[1]*c,e[2]=t[2]*s+r[2]*l+i[2]*u+o[2]*c,e},bezier:function(e,t,r,i,o,n){var a=1-n,s=a*a,l=n*n,u=s*a,c=3*n*s,d=3*l*a,h=l*n;return e[0]=t[0]*u+r[0]*c+i[0]*d+o[0]*h,e[1]=t[1]*u+r[1]*c+i[1]*d+o[1]*h,e[2]=t[2]*u+r[2]*c+i[2]*d+o[2]*h,e},random:function(e,t){t=t||1;var r=2*i()*Math.PI,o=2*i()-1,n=Math.sqrt(1-o*o)*t;return e[0]=Math.cos(r)*n,e[1]=Math.sin(r)*n,e[2]=o*t,e},transformMat4:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=r[3]*i+r[7]*o+r[11]*n+r[15];return a=a||1,e[0]=(r[0]*i+r[4]*o+r[8]*n+r[12])/a,e[1]=(r[1]*i+r[5]*o+r[9]*n+r[13])/a,e[2]=(r[2]*i+r[6]*o+r[10]*n+r[14])/a,e},transformMat3:function(e,t,r){var i=t[0],o=t[1],n=t[2];return e[0]=i*r[0]+o*r[3]+n*r[6],e[1]=i*r[1]+o*r[4]+n*r[7],e[2]=i*r[2]+o*r[5]+n*r[8],e},transformQuat:function(e,t,r){var i=r[0],o=r[1],n=r[2],a=r[3],s=t[0],l=t[1],u=t[2],c=o*u-n*l,d=n*s-i*u,h=i*l-o*s,f=o*h-n*d,g=n*c-i*h,p=i*d-o*c,m=2*a;return c*=m,d*=m,h*=m,f*=2,g*=2,p*=2,e[0]=s+c+f,e[1]=l+d+g,e[2]=u+h+p,e},rotateX:function(e,t,r,i){var o=[],n=[];return o[0]=t[0]-r[0],o[1]=t[1]-r[1],o[2]=t[2]-r[2],n[0]=o[0],n[1]=o[1]*Math.cos(i)-o[2]*Math.sin(i),n[2]=o[1]*Math.sin(i)+o[2]*Math.cos(i),e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e},rotateY:function(e,t,r,i){var o=[],n=[];return o[0]=t[0]-r[0],o[1]=t[1]-r[1],o[2]=t[2]-r[2],n[0]=o[2]*Math.sin(i)+o[0]*Math.cos(i),n[1]=o[1],n[2]=o[2]*Math.cos(i)-o[0]*Math.sin(i),e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e},rotateZ:function(e,t,r,i){var o=[],n=[];return o[0]=t[0]-r[0],o[1]=t[1]-r[1],o[2]=t[2]-r[2],n[0]=o[0]*Math.cos(i)-o[1]*Math.sin(i),n[1]=o[0]*Math.sin(i)+o[1]*Math.cos(i),n[2]=o[2],e[0]=n[0]+r[0],e[1]=n[1]+r[1],e[2]=n[2]+r[2],e},angle:function(e,t){var r=I(e[0],e[1],e[2]),i=I(t[0],t[1],t[2]);z(r,r),z(i,i);var o=H(r,i);return o>1?0:o<-1?Math.PI:Math.acos(o)},zero:function(e){return e[0]=0,e[1]=0,e[2]=0,e},str:function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},equals:function(e,r){var i=e[0],o=e[1],n=e[2],a=r[0],s=r[1],l=r[2];return Math.abs(i-a)<=t*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(o-s)<=t*Math.max(1,Math.abs(o),Math.abs(s))&&Math.abs(n-l)<=t*Math.max(1,Math.abs(n),Math.abs(l))},sub:j,mul:W,div:X,dist:Y,sqrDist:q,len:K,sqrLen:Z,forEach:J});function $(){var e=new r(4);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function ee(e){var t=new r(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function te(e,t,i,o){var n=new r(4);return n[0]=e,n[1]=t,n[2]=i,n[3]=o,n}function re(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function ie(e,t,r,i,o){return e[0]=t,e[1]=r,e[2]=i,e[3]=o,e}function oe(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e}function ne(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}function ae(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e}function se(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e}function le(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}function ue(e,t){var r=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2],n=t[3]-e[3];return Math.sqrt(r*r+i*i+o*o+n*n)}function ce(e,t){var r=t[0]-e[0],i=t[1]-e[1],o=t[2]-e[2],n=t[3]-e[3];return r*r+i*i+o*o+n*n}function de(e){var t=e[0],r=e[1],i=e[2],o=e[3];return Math.sqrt(t*t+r*r+i*i+o*o)}function he(e){var t=e[0],r=e[1],i=e[2],o=e[3];return t*t+r*r+i*i+o*o}function fe(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=r*r+i*i+o*o+n*n;return a>0&&(a=1/Math.sqrt(a)),e[0]=r*a,e[1]=i*a,e[2]=o*a,e[3]=n*a,e}function ge(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function pe(e,t,r,i){var o=t[0],n=t[1],a=t[2],s=t[3];return e[0]=o+i*(r[0]-o),e[1]=n+i*(r[1]-n),e[2]=a+i*(r[2]-a),e[3]=s+i*(r[3]-s),e}function me(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function ve(e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=r[0],l=r[1],u=r[2],c=r[3];return Math.abs(i-s)<=t*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(o-l)<=t*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(n-u)<=t*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(a-c)<=t*Math.max(1,Math.abs(a),Math.abs(c))}var xe=ne,_e=ae,ye=se,Te=ue,Ce=ce,be=de,Me=he,Ae=function(){var e=$();return function(t,r,i,o,n,a){var s,l;for(r||(r=4),i||(i=0),l=o?Math.min(o*r+i,t.length):t.length,s=i;s<l;s+=r)e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],e[3]=t[s+3],n(e,e,a),t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2],t[s+3]=e[3];return t}}(),Ee=Object.freeze({create:$,clone:ee,fromValues:te,copy:re,set:ie,add:oe,subtract:ne,multiply:ae,divide:se,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},min:function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e},max:function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},scale:le,scaleAndAdd:function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e[2]=t[2]+r[2]*i,e[3]=t[3]+r[3]*i,e},distance:ue,squaredDistance:ce,length:de,squaredLength:he,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},normalize:fe,dot:ge,cross:function(e,t,r,i){var o=r[0]*i[1]-r[1]*i[0],n=r[0]*i[2]-r[2]*i[0],a=r[0]*i[3]-r[3]*i[0],s=r[1]*i[2]-r[2]*i[1],l=r[1]*i[3]-r[3]*i[1],u=r[2]*i[3]-r[3]*i[2],c=t[0],d=t[1],h=t[2],f=t[3];return e[0]=d*u-h*l+f*s,e[1]=-c*u+h*a-f*n,e[2]=c*l-d*a+f*o,e[3]=-c*s+d*n-h*o,e},lerp:pe,random:function(e,t){var r,o,n,a,s,l;t=t||1;do{s=(r=2*i()-1)*r+(o=2*i()-1)*o}while(s>=1);do{l=(n=2*i()-1)*n+(a=2*i()-1)*a}while(l>=1);var u=Math.sqrt((1-s)/l);return e[0]=t*r,e[1]=t*o,e[2]=t*n*u,e[3]=t*a*u,e},transformMat4:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3];return e[0]=r[0]*i+r[4]*o+r[8]*n+r[12]*a,e[1]=r[1]*i+r[5]*o+r[9]*n+r[13]*a,e[2]=r[2]*i+r[6]*o+r[10]*n+r[14]*a,e[3]=r[3]*i+r[7]*o+r[11]*n+r[15]*a,e},transformQuat:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=r[0],s=r[1],l=r[2],u=r[3],c=u*i+s*n-l*o,d=u*o+l*i-a*n,h=u*n+a*o-s*i,f=-a*i-s*o-l*n;return e[0]=c*u+f*-a+d*-l-h*-s,e[1]=d*u+f*-s+h*-a-c*-l,e[2]=h*u+f*-l+c*-s-d*-a,e[3]=t[3],e},zero:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},str:function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},exactEquals:me,equals:ve,sub:xe,mul:_e,div:ye,dist:Te,sqrDist:Ce,len:be,sqrLen:Me,forEach:Ae});function Le(){var e=new r(4);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function we(e,t,r){r*=.5;var i=Math.sin(r);return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=Math.cos(r),e}function Se(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[0],l=r[1],u=r[2],c=r[3];return e[0]=i*c+a*s+o*u-n*l,e[1]=o*c+a*l+n*s-i*u,e[2]=n*c+a*u+i*l-o*s,e[3]=a*c-i*s-o*l-n*u,e}function De(e,t,r){r*=.5;var i=t[0],o=t[1],n=t[2],a=t[3],s=Math.sin(r),l=Math.cos(r);return e[0]=i*l+a*s,e[1]=o*l+n*s,e[2]=n*l-o*s,e[3]=a*l-i*s,e}function Re(e,t,r){r*=.5;var i=t[0],o=t[1],n=t[2],a=t[3],s=Math.sin(r),l=Math.cos(r);return e[0]=i*l-n*s,e[1]=o*l+a*s,e[2]=n*l+i*s,e[3]=a*l-o*s,e}function Pe(e,t,r){r*=.5;var i=t[0],o=t[1],n=t[2],a=t[3],s=Math.sin(r),l=Math.cos(r);return e[0]=i*l+o*s,e[1]=o*l-i*s,e[2]=n*l+a*s,e[3]=a*l-n*s,e}function Ie(e,r,i,o){var n,a,s,l,u,c=r[0],d=r[1],h=r[2],f=r[3],g=i[0],p=i[1],m=i[2],v=i[3];return(a=c*g+d*p+h*m+f*v)<0&&(a=-a,g=-g,p=-p,m=-m,v=-v),1-a>t?(n=Math.acos(a),s=Math.sin(n),l=Math.sin((1-o)*n)/s,u=Math.sin(o*n)/s):(l=1-o,u=o),e[0]=l*c+u*g,e[1]=l*d+u*p,e[2]=l*h+u*m,e[3]=l*f+u*v,e}function Fe(e,t){var r,i=t[0]+t[4]+t[8];if(i>0)r=Math.sqrt(i+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var o=0;t[4]>t[0]&&(o=1),t[8]>t[3*o+o]&&(o=2);var n=(o+1)%3,a=(o+2)%3;r=Math.sqrt(t[3*o+o]-t[3*n+n]-t[3*a+a]+1),e[o]=.5*r,r=.5/r,e[3]=(t[3*n+a]-t[3*a+n])*r,e[n]=(t[3*n+o]+t[3*o+n])*r,e[a]=(t[3*a+o]+t[3*o+a])*r}return e}var Oe,Be,Ne,Ue,Ge,ze,He=ee,Ve=te,ke=re,je=ie,We=oe,Xe=Se,Ye=le,qe=ge,Ke=pe,Ze=de,Je=Ze,Qe=he,$e=Qe,et=fe,tt=me,rt=ve,it=(Oe=R(),Be=I(1,0,0),Ne=I(0,1,0),function(e,t,r){var i=H(t,r);return i<-.999999?(V(Oe,Be,t),K(Oe)<1e-6&&V(Oe,Ne,t),z(Oe,Oe),we(e,Oe,Math.PI),e):i>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(V(Oe,t,r),e[0]=Oe[0],e[1]=Oe[1],e[2]=Oe[2],e[3]=1+i,et(e,e))}),ot=(Ue=Le(),Ge=Le(),function(e,t,r,i,o,n){return Ie(Ue,t,o,n),Ie(Ge,r,i,n),Ie(e,Ue,Ge,2*n*(1-n)),e}),nt=(ze=m(),function(e,t,r,i){return ze[0]=r[0],ze[3]=r[1],ze[6]=r[2],ze[1]=i[0],ze[4]=i[1],ze[7]=i[2],ze[2]=-t[0],ze[5]=-t[1],ze[8]=-t[2],et(e,Fe(e,ze))}),at=Object.freeze({create:Le,identity:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},setAxisAngle:we,getAxisAngle:function(e,r){var i=2*Math.acos(r[3]),o=Math.sin(i/2);return o>t?(e[0]=r[0]/o,e[1]=r[1]/o,e[2]=r[2]/o):(e[0]=1,e[1]=0,e[2]=0),i},multiply:Se,rotateX:De,rotateY:Re,rotateZ:Pe,calculateW:function(e,t){var r=t[0],i=t[1],o=t[2];return e[0]=r,e[1]=i,e[2]=o,e[3]=Math.sqrt(Math.abs(1-r*r-i*i-o*o)),e},slerp:Ie,random:function(e){var t=i(),r=i(),o=i(),n=Math.sqrt(1-t),a=Math.sqrt(t);return e[0]=n*Math.sin(2*Math.PI*r),e[1]=n*Math.cos(2*Math.PI*r),e[2]=a*Math.sin(2*Math.PI*o),e[3]=a*Math.cos(2*Math.PI*o),e},invert:function(e,t){var r=t[0],i=t[1],o=t[2],n=t[3],a=r*r+i*i+o*o+n*n,s=a?1/a:0;return e[0]=-r*s,e[1]=-i*s,e[2]=-o*s,e[3]=n*s,e},conjugate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},fromMat3:Fe,fromEuler:function(e,t,r,i){var o=.5*Math.PI/180;t*=o,r*=o,i*=o;var n=Math.sin(t),a=Math.cos(t),s=Math.sin(r),l=Math.cos(r),u=Math.sin(i),c=Math.cos(i);return e[0]=n*l*c-a*s*u,e[1]=a*s*c+n*l*u,e[2]=a*l*u-n*s*c,e[3]=a*l*c+n*s*u,e},str:function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},clone:He,fromValues:Ve,copy:ke,set:je,add:We,mul:Xe,scale:Ye,dot:qe,lerp:Ke,length:Ze,len:Je,squaredLength:Qe,sqrLen:$e,normalize:et,exactEquals:tt,equals:rt,rotationTo:it,sqlerp:ot,setAxes:nt});function st(e,t,r){var i=.5*r[0],o=.5*r[1],n=.5*r[2],a=t[0],s=t[1],l=t[2],u=t[3];return e[0]=a,e[1]=s,e[2]=l,e[3]=u,e[4]=i*u+o*l-n*s,e[5]=o*u+n*a-i*l,e[6]=n*u+i*s-o*a,e[7]=-i*a-o*s-n*l,e}function lt(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}var ut=ke;var ct=ke;function dt(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[4],l=r[5],u=r[6],c=r[7],d=t[4],h=t[5],f=t[6],g=t[7],p=r[0],m=r[1],v=r[2],x=r[3];return e[0]=i*x+a*p+o*v-n*m,e[1]=o*x+a*m+n*p-i*v,e[2]=n*x+a*v+i*m-o*p,e[3]=a*x-i*p-o*m-n*v,e[4]=i*c+a*s+o*u-n*l+d*x+g*p+h*v-f*m,e[5]=o*c+a*l+n*s-i*u+h*x+g*m+f*p-d*v,e[6]=n*c+a*u+i*l-o*s+f*x+g*v+d*m-h*p,e[7]=a*c-i*s-o*l-n*u+g*x-d*p-h*m-f*v,e}var ht=dt;var ft=qe;var gt=Ze,pt=gt,mt=Qe,vt=mt;var xt=Object.freeze({create:function(){var e=new r(8);return r!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},clone:function(e){var t=new r(8);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},fromValues:function(e,t,i,o,n,a,s,l){var u=new r(8);return u[0]=e,u[1]=t,u[2]=i,u[3]=o,u[4]=n,u[5]=a,u[6]=s,u[7]=l,u},fromRotationTranslationValues:function(e,t,i,o,n,a,s){var l=new r(8);l[0]=e,l[1]=t,l[2]=i,l[3]=o;var u=.5*n,c=.5*a,d=.5*s;return l[4]=u*o+c*i-d*t,l[5]=c*o+d*e-u*i,l[6]=d*o+u*t-c*e,l[7]=-u*e-c*t-d*i,l},fromRotationTranslation:st,fromTranslation:function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},fromRotation:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},fromMat4:function(e,t){var i=Le();E(i,t);var o=new r(3);return A(o,t),st(e,i,o),e},copy:lt,identity:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},set:function(e,t,r,i,o,n,a,s,l){return e[0]=t,e[1]=r,e[2]=i,e[3]=o,e[4]=n,e[5]=a,e[6]=s,e[7]=l,e},getReal:ut,getDual:function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},setReal:ct,setDual:function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},getTranslation:function(e,t){var r=t[4],i=t[5],o=t[6],n=t[7],a=-t[0],s=-t[1],l=-t[2],u=t[3];return e[0]=2*(r*u+n*a+i*l-o*s),e[1]=2*(i*u+n*s+o*a-r*l),e[2]=2*(o*u+n*l+r*s-i*a),e},translate:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=.5*r[0],l=.5*r[1],u=.5*r[2],c=t[4],d=t[5],h=t[6],f=t[7];return e[0]=i,e[1]=o,e[2]=n,e[3]=a,e[4]=a*s+o*u-n*l+c,e[5]=a*l+n*s-i*u+d,e[6]=a*u+i*l-o*s+h,e[7]=-i*s-o*l-n*u+f,e},rotateX:function(e,t,r){var i=-t[0],o=-t[1],n=-t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],d=s*a+c*i+l*n-u*o,h=l*a+c*o+u*i-s*n,f=u*a+c*n+s*o-l*i,g=c*a-s*i-l*o-u*n;return De(e,t,r),i=e[0],o=e[1],n=e[2],a=e[3],e[4]=d*a+g*i+h*n-f*o,e[5]=h*a+g*o+f*i-d*n,e[6]=f*a+g*n+d*o-h*i,e[7]=g*a-d*i-h*o-f*n,e},rotateY:function(e,t,r){var i=-t[0],o=-t[1],n=-t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],d=s*a+c*i+l*n-u*o,h=l*a+c*o+u*i-s*n,f=u*a+c*n+s*o-l*i,g=c*a-s*i-l*o-u*n;return Re(e,t,r),i=e[0],o=e[1],n=e[2],a=e[3],e[4]=d*a+g*i+h*n-f*o,e[5]=h*a+g*o+f*i-d*n,e[6]=f*a+g*n+d*o-h*i,e[7]=g*a-d*i-h*o-f*n,e},rotateZ:function(e,t,r){var i=-t[0],o=-t[1],n=-t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],d=s*a+c*i+l*n-u*o,h=l*a+c*o+u*i-s*n,f=u*a+c*n+s*o-l*i,g=c*a-s*i-l*o-u*n;return Pe(e,t,r),i=e[0],o=e[1],n=e[2],a=e[3],e[4]=d*a+g*i+h*n-f*o,e[5]=h*a+g*o+f*i-d*n,e[6]=f*a+g*n+d*o-h*i,e[7]=g*a-d*i-h*o-f*n,e},rotateByQuatAppend:function(e,t,r){var i=r[0],o=r[1],n=r[2],a=r[3],s=t[0],l=t[1],u=t[2],c=t[3];return e[0]=s*a+c*i+l*n-u*o,e[1]=l*a+c*o+u*i-s*n,e[2]=u*a+c*n+s*o-l*i,e[3]=c*a-s*i-l*o-u*n,s=t[4],l=t[5],u=t[6],c=t[7],e[4]=s*a+c*i+l*n-u*o,e[5]=l*a+c*o+u*i-s*n,e[6]=u*a+c*n+s*o-l*i,e[7]=c*a-s*i-l*o-u*n,e},rotateByQuatPrepend:function(e,t,r){var i=t[0],o=t[1],n=t[2],a=t[3],s=r[0],l=r[1],u=r[2],c=r[3];return e[0]=i*c+a*s+o*u-n*l,e[1]=o*c+a*l+n*s-i*u,e[2]=n*c+a*u+i*l-o*s,e[3]=a*c-i*s-o*l-n*u,s=r[4],l=r[5],u=r[6],c=r[7],e[4]=i*c+a*s+o*u-n*l,e[5]=o*c+a*l+n*s-i*u,e[6]=n*c+a*u+i*l-o*s,e[7]=a*c-i*s-o*l-n*u,e},rotateAroundAxis:function(e,r,i,o){if(Math.abs(o)<t)return lt(e,r);var n=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);o*=.5;var a=Math.sin(o),s=a*i[0]/n,l=a*i[1]/n,u=a*i[2]/n,c=Math.cos(o),d=r[0],h=r[1],f=r[2],g=r[3];e[0]=d*c+g*s+h*u-f*l,e[1]=h*c+g*l+f*s-d*u,e[2]=f*c+g*u+d*l-h*s,e[3]=g*c-d*s-h*l-f*u;var p=r[4],m=r[5],v=r[6],x=r[7];return e[4]=p*c+x*s+m*u-v*l,e[5]=m*c+x*l+v*s-p*u,e[6]=v*c+x*u+p*l-m*s,e[7]=x*c-p*s-m*l-v*u,e},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e},multiply:dt,mul:ht,scale:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e},dot:ft,lerp:function(e,t,r,i){var o=1-i;return ft(t,r)<0&&(i=-i),e[0]=t[0]*o+r[0]*i,e[1]=t[1]*o+r[1]*i,e[2]=t[2]*o+r[2]*i,e[3]=t[3]*o+r[3]*i,e[4]=t[4]*o+r[4]*i,e[5]=t[5]*o+r[5]*i,e[6]=t[6]*o+r[6]*i,e[7]=t[7]*o+r[7]*i,e},invert:function(e,t){var r=mt(t);return e[0]=-t[0]/r,e[1]=-t[1]/r,e[2]=-t[2]/r,e[3]=t[3]/r,e[4]=-t[4]/r,e[5]=-t[5]/r,e[6]=-t[6]/r,e[7]=t[7]/r,e},conjugate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},length:gt,len:pt,squaredLength:mt,sqrLen:vt,normalize:function(e,t){var r=mt(t);if(r>0){r=Math.sqrt(r);var i=t[0]/r,o=t[1]/r,n=t[2]/r,a=t[3]/r,s=t[4],l=t[5],u=t[6],c=t[7],d=i*s+o*l+n*u+a*c;e[0]=i,e[1]=o,e[2]=n,e[3]=a,e[4]=(s-i*d)/r,e[5]=(l-o*d)/r,e[6]=(u-n*d)/r,e[7]=(c-a*d)/r}return e},str:function(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},equals:function(e,r){var i=e[0],o=e[1],n=e[2],a=e[3],s=e[4],l=e[5],u=e[6],c=e[7],d=r[0],h=r[1],f=r[2],g=r[3],p=r[4],m=r[5],v=r[6],x=r[7];return Math.abs(i-d)<=t*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(o-h)<=t*Math.max(1,Math.abs(o),Math.abs(h))&&Math.abs(n-f)<=t*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(a-g)<=t*Math.max(1,Math.abs(a),Math.abs(g))&&Math.abs(s-p)<=t*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(l-m)<=t*Math.max(1,Math.abs(l),Math.abs(m))&&Math.abs(u-v)<=t*Math.max(1,Math.abs(u),Math.abs(v))&&Math.abs(c-x)<=t*Math.max(1,Math.abs(c),Math.abs(x))}});function _t(){var e=new r(2);return r!=Float32Array&&(e[0]=0,e[1]=0),e}function yt(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function Tt(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function Ct(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function bt(e,t){var r=t[0]-e[0],i=t[1]-e[1];return Math.sqrt(r*r+i*i)}function Mt(e,t){var r=t[0]-e[0],i=t[1]-e[1];return r*r+i*i}function At(e){var t=e[0],r=e[1];return Math.sqrt(t*t+r*r)}function Et(e){var t=e[0],r=e[1];return t*t+r*r}var Lt=At,wt=yt,St=Tt,Dt=Ct,Rt=bt,Pt=Mt,It=Et,Ft=function(){var e=_t();return function(t,r,i,o,n,a){var s,l;for(r||(r=2),i||(i=0),l=o?Math.min(o*r+i,t.length):t.length,s=i;s<l;s+=r)e[0]=t[s],e[1]=t[s+1],n(e,e,a),t[s]=e[0],t[s+1]=e[1];return t}}(),Ot=Object.freeze({create:_t,clone:function(e){var t=new r(2);return t[0]=e[0],t[1]=e[1],t},fromValues:function(e,t){var i=new r(2);return i[0]=e,i[1]=t,i},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e},set:function(e,t,r){return e[0]=t,e[1]=r,e},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e},subtract:yt,multiply:Tt,divide:Ct,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},min:function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e},max:function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},scale:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e},scaleAndAdd:function(e,t,r,i){return e[0]=t[0]+r[0]*i,e[1]=t[1]+r[1]*i,e},distance:bt,squaredDistance:Mt,length:At,squaredLength:Et,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},normalize:function(e,t){var r=t[0],i=t[1],o=r*r+i*i;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e},dot:function(e,t){return e[0]*t[0]+e[1]*t[1]},cross:function(e,t,r){var i=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=i,e},lerp:function(e,t,r,i){var o=t[0],n=t[1];return e[0]=o+i*(r[0]-o),e[1]=n+i*(r[1]-n),e},random:function(e,t){t=t||1;var r=2*i()*Math.PI;return e[0]=Math.cos(r)*t,e[1]=Math.sin(r)*t,e},transformMat2:function(e,t,r){var i=t[0],o=t[1];return e[0]=r[0]*i+r[2]*o,e[1]=r[1]*i+r[3]*o,e},transformMat2d:function(e,t,r){var i=t[0],o=t[1];return e[0]=r[0]*i+r[2]*o+r[4],e[1]=r[1]*i+r[3]*o+r[5],e},transformMat3:function(e,t,r){var i=t[0],o=t[1];return e[0]=r[0]*i+r[3]*o+r[6],e[1]=r[1]*i+r[4]*o+r[7],e},transformMat4:function(e,t,r){var i=t[0],o=t[1];return e[0]=r[0]*i+r[4]*o+r[12],e[1]=r[1]*i+r[5]*o+r[13],e},rotate:function(e,t,r,i){var o=t[0]-r[0],n=t[1]-r[1],a=Math.sin(i),s=Math.cos(i);return e[0]=o*s-n*a+r[0],e[1]=o*a+n*s+r[1],e},angle:function(e,t){var r=e[0],i=e[1],o=t[0],n=t[1],a=r*r+i*i;a>0&&(a=1/Math.sqrt(a));var s=o*o+n*n;s>0&&(s=1/Math.sqrt(s));var l=(r*o+i*n)*a*s;return l>1?0:l<-1?Math.PI:Math.acos(l)},zero:function(e){return e[0]=0,e[1]=0,e},str:function(e){return"vec2("+e[0]+", "+e[1]+")"},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]},equals:function(e,r){var i=e[0],o=e[1],n=r[0],a=r[1];return Math.abs(i-n)<=t*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(o-a)<=t*Math.max(1,Math.abs(o),Math.abs(a))},len:Lt,sub:wt,mul:St,div:Dt,dist:Rt,sqrDist:Pt,sqrLen:It,forEach:Ft});e.glMatrix=n,e.mat2=c,e.mat2d=p,e.mat3=T,e.mat4=D,e.quat=at,e.quat2=xt,e.vec2=Ot,e.vec3=Q,e.vec4=Ee,Object.defineProperty(e,"__esModule",{value:!0})}),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).i18next=t()}(this,function(){function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function i(e,t,i){return t&&r(e.prototype,t),i&&r(e,i),e}function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},i=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),i.forEach(function(t){o(e,t,r[t])})}return e}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}function s(e){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?u(e):t}function d(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=[],i=!0,o=!1,n=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);i=!0);}catch(e){o=!0,n=e}finally{try{i||null==s.return||s.return()}finally{if(o)throw n}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function h(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var f={type:"logger",log:function(e){this.output("log",e)},warn:function(e){this.output("warn",e)},error:function(e){this.output("error",e)},output:function(e,t){var r;console&&console[e]&&(r=console)[e].apply(r,h(t))}},g=new(function(){function e(r){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t(this,e),this.init(r,i)}return i(e,[{key:"init",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.prefix=t.prefix||"i18next:",this.logger=e||f,this.options=t,this.debug=t.debug}},{key:"setDebug",value:function(e){this.debug=e}},{key:"log",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.forward(t,"log","",!0)}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.forward(t,"warn","",!0)}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.forward(t,"error","")}},{key:"deprecate",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.forward(t,"warn","WARNING DEPRECATED: ",!0)}},{key:"forward",value:function(e,t,r,i){return i&&!this.debug?null:("string"==typeof e[0]&&(e[0]="".concat(r).concat(this.prefix," ").concat(e[0])),this.logger[t](e))}},{key:"create",value:function(t){return new e(this.logger,n({},{prefix:"".concat(this.prefix,":").concat(t,":")},this.options))}}]),e}()),p=function(){function e(){t(this,e),this.observers={}}return i(e,[{key:"on",value:function(e,t){var r=this;return e.split(" ").forEach(function(e){r.observers[e]=r.observers[e]||[],r.observers[e].push(t)}),this}},{key:"off",value:function(e,t){var r=this;this.observers[e]&&this.observers[e].forEach(function(){if(t){var i=r.observers[e].indexOf(t);i>-1&&r.observers[e].splice(i,1)}else delete r.observers[e]})}},{key:"emit",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];this.observers[e]&&[].concat(this.observers[e]).forEach(function(e){e.apply(void 0,r)});this.observers["*"]&&[].concat(this.observers["*"]).forEach(function(t){t.apply(t,[e].concat(r))})}}]),e}();function m(){var e,t,r=new Promise(function(r,i){e=r,t=i});return r.resolve=e,r.reject=t,r}function v(e){return null==e?"":""+e}function x(e,t,r){function i(e){return e&&e.indexOf("###")>-1?e.replace(/###/g,"."):e}function o(){return!e||"string"==typeof e}for(var n="string"!=typeof t?[].concat(t):t.split(".");n.length>1;){if(o())return{};var a=i(n.shift());!e[a]&&r&&(e[a]=new r),e=e[a]}return o()?{}:{obj:e,k:i(n.shift())}}function _(e,t,r){var i=x(e,t,Object);i.obj[i.k]=r}function y(e,t){var r=x(e,t),i=r.obj,o=r.k;if(i)return i[o]}function T(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}var C={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};function b(e){return"string"==typeof e?e.replace(/[&<>"'\/]/g,function(e){return C[e]}):e}var M=function(e){function r(e){var i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{ns:["translation"],defaultNS:"translation"};return t(this,r),i=c(this,s(r).call(this)),p.call(u(u(i))),i.data=e||{},i.options=o,void 0===i.options.keySeparator&&(i.options.keySeparator="."),i}return a(r,p),i(r,[{key:"addNamespaces",value:function(e){this.options.ns.indexOf(e)<0&&this.options.ns.push(e)}},{key:"removeNamespaces",value:function(e){var t=this.options.ns.indexOf(e);t>-1&&this.options.ns.splice(t,1)}},{key:"getResource",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=void 0!==i.keySeparator?i.keySeparator:this.options.keySeparator,n=[e,t];return r&&"string"!=typeof r&&(n=n.concat(r)),r&&"string"==typeof r&&(n=n.concat(o?r.split(o):r)),e.indexOf(".")>-1&&(n=e.split(".")),y(this.data,n)}},{key:"addResource",value:function(e,t,r,i){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{silent:!1},n=this.options.keySeparator;void 0===n&&(n=".");var a=[e,t];r&&(a=a.concat(n?r.split(n):r)),e.indexOf(".")>-1&&(i=t,t=(a=e.split("."))[1]),this.addNamespaces(t),_(this.data,a,i),o.silent||this.emit("added",e,t,r,i)}},{key:"addResources",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{silent:!1};for(var o in r)"string"!=typeof r[o]&&"[object Array]"!==Object.prototype.toString.apply(r[o])||this.addResource(e,t,o,r[o],{silent:!0});i.silent||this.emit("added",e,t,r)}},{key:"addResourceBundle",value:function(e,t,r,i,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{silent:!1},s=[e,t];e.indexOf(".")>-1&&(i=r,r=t,t=(s=e.split("."))[1]),this.addNamespaces(t);var l=y(this.data,s)||{};i?function e(t,r,i){for(var o in r)o in t?"string"==typeof t[o]||t[o]instanceof String||"string"==typeof r[o]||r[o]instanceof String?i&&(t[o]=r[o]):e(t[o],r[o],i):t[o]=r[o];return t}(l,r,o):l=n({},l,r),_(this.data,s,l),a.silent||this.emit("added",e,t,r)}},{key:"removeResourceBundle",value:function(e,t){this.hasResourceBundle(e,t)&&delete this.data[e][t],this.removeNamespaces(t),this.emit("removed",e,t)}},{key:"hasResourceBundle",value:function(e,t){return void 0!==this.getResource(e,t)}},{key:"getResourceBundle",value:function(e,t){return t||(t=this.options.defaultNS),"v1"===this.options.compatibilityAPI?n({},{},this.getResource(e,t)):this.getResource(e,t)}},{key:"getDataByLanguage",value:function(e){return this.data[e]}},{key:"toJSON",value:function(){return this.data}}]),r}(),A={processors:{},addPostProcessor:function(e){this.processors[e.name]=e},handle:function(e,t,r,i,o){var n=this;return e.forEach(function(e){n.processors[e]&&(t=n.processors[e].process(t,r,i,o))}),t}},E=function(r){function o(e){var r,i,n,a,l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t(this,o),r=c(this,s(o).call(this)),p.call(u(u(r))),i=["resourceStore","languageUtils","pluralResolver","interpolator","backendConnector","i18nFormat"],n=e,a=u(u(r)),i.forEach(function(e){n[e]&&(a[e]=n[e])}),r.options=l,void 0===r.options.keySeparator&&(r.options.keySeparator="."),r.logger=g.create("translator"),r}return a(o,p),i(o,[{key:"changeLanguage",value:function(e){e&&(this.language=e)}},{key:"exists",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{interpolation:{}},r=this.resolve(e,t);return r&&void 0!==r.res}},{key:"extractFromKey",value:function(e,t){var r=t.nsSeparator||this.options.nsSeparator;void 0===r&&(r=":");var i=void 0!==t.keySeparator?t.keySeparator:this.options.keySeparator,o=t.ns||this.options.defaultNS;if(r&&e.indexOf(r)>-1){var n=e.split(r);(r!==i||r===i&&this.options.ns.indexOf(n[0])>-1)&&(o=n.shift()),e=n.join(i)}return"string"==typeof o&&(o=[o]),{key:e,namespaces:o}}},{key:"translate",value:function(t,r){var i=this;if("object"!==e(r)&&this.options.overloadTranslationOptionHandler&&(r=this.options.overloadTranslationOptionHandler(arguments)),r||(r={}),void 0===t||null===t)return"";Array.isArray(t)||(t=[String(t)]);var o=void 0!==r.keySeparator?r.keySeparator:this.options.keySeparator,a=this.extractFromKey(t[t.length-1],r),s=a.key,l=a.namespaces,u=l[l.length-1],c=r.lng||this.language,d=r.appendNamespaceToCIMode||this.options.appendNamespaceToCIMode;if(c&&"cimode"===c.toLowerCase()){if(d){var h=r.nsSeparator||this.options.nsSeparator;return u+h+s}return s}var f=this.resolve(t,r),g=f&&f.res,p=f&&f.usedKey||s,m=f&&f.exactUsedKey||s,v=Object.prototype.toString.apply(g),x=void 0!==r.joinArrays?r.joinArrays:this.options.joinArrays,_=!this.i18nFormat||this.i18nFormat.handleAsObject;if(_&&g&&("string"!=typeof g&&"boolean"!=typeof g&&"number"!=typeof g)&&["[object Number]","[object Function]","[object RegExp]"].indexOf(v)<0&&("string"!=typeof x||"[object Array]"!==v)){if(!r.returnObjects&&!this.options.returnObjects)return this.logger.warn("accessing an object - but returnObjects options is not enabled!"),this.options.returnedObjectHandler?this.options.returnedObjectHandler(p,g,r):"key '".concat(s," (").concat(this.language,")' returned an object instead of string.");if(o){var y="[object Array]"===v,T=y?[]:{},C=y?m:p;for(var b in g)if(Object.prototype.hasOwnProperty.call(g,b)){var M="".concat(C).concat(o).concat(b);T[b]=this.translate(M,n({},r,{joinArrays:!1,ns:l})),T[b]===M&&(T[b]=g[b])}g=T}}else if(_&&"string"==typeof x&&"[object Array]"===v)(g=g.join(x))&&(g=this.extendTranslation(g,t,r));else{var A=!1,E=!1;if(!this.isValidLookup(g)&&void 0!==r.defaultValue){if(A=!0,void 0!==r.count){var L=this.pluralResolver.getSuffix(c,r.count);g=r["defaultValue".concat(L)]}g||(g=r.defaultValue)}this.isValidLookup(g)||(E=!0,g=s);var w=r.defaultValue&&r.defaultValue!==g&&this.options.updateMissing;if(E||A||w){this.logger.log(w?"updateKey":"missingKey",c,u,s,w?r.defaultValue:g);var S=[],D=this.languageUtils.getFallbackCodes(this.options.fallbackLng,r.lng||this.language);if("fallback"===this.options.saveMissingTo&&D&&D[0])for(var R=0;R<D.length;R++)S.push(D[R]);else"all"===this.options.saveMissingTo?S=this.languageUtils.toResolveHierarchy(r.lng||this.language):S.push(r.lng||this.language);var P=function(e,t){i.options.missingKeyHandler?i.options.missingKeyHandler(e,u,t,w?r.defaultValue:g,w,r):i.backendConnector&&i.backendConnector.saveMissing&&i.backendConnector.saveMissing(e,u,t,w?r.defaultValue:g,w,r),i.emit("missingKey",e,u,t,g)};if(this.options.saveMissing){var I=void 0!==r.count&&"string"!=typeof r.count;this.options.saveMissingPlurals&&I?S.forEach(function(e){i.pluralResolver.getPluralFormsOfKey(e,s).forEach(function(t){return P([e],t)})}):P(S,s)}}g=this.extendTranslation(g,t,r,f),E&&g===s&&this.options.appendNamespaceToMissingKey&&(g="".concat(u,":").concat(s)),E&&this.options.parseMissingKeyHandler&&(g=this.options.parseMissingKeyHandler(g))}return g}},{key:"extendTranslation",value:function(e,t,r,i){var o=this;if(this.i18nFormat&&this.i18nFormat.parse)e=this.i18nFormat.parse(e,r,i.usedLng,i.usedNS,i.usedKey,{resolved:i});else if(!r.skipInterpolation){r.interpolation&&this.interpolator.init(n({},r,{interpolation:n({},this.options.interpolation,r.interpolation)}));var a=r.replace&&"string"!=typeof r.replace?r.replace:r;this.options.interpolation.defaultVariables&&(a=n({},this.options.interpolation.defaultVariables,a)),e=this.interpolator.interpolate(e,a,r.lng||this.language,r),!1!==r.nest&&(e=this.interpolator.nest(e,function(){return o.translate.apply(o,arguments)},r)),r.interpolation&&this.interpolator.reset()}var s=r.postProcess||this.options.postProcess,l="string"==typeof s?[s]:s;return void 0!==e&&null!==e&&l&&l.length&&!1!==r.applyPostProcessor&&(e=A.handle(l,e,t,r,this)),e}},{key:"resolve",value:function(e){var t,r,i,o,n,a=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return"string"==typeof e&&(e=[e]),e.forEach(function(e){if(!a.isValidLookup(t)){var l=a.extractFromKey(e,s),u=l.key;r=u;var c=l.namespaces;a.options.fallbackNS&&(c=c.concat(a.options.fallbackNS));var d=void 0!==s.count&&"string"!=typeof s.count,h=void 0!==s.context&&"string"==typeof s.context&&""!==s.context,f=s.lngs?s.lngs:a.languageUtils.toResolveHierarchy(s.lng||a.language,s.fallbackLng);c.forEach(function(e){a.isValidLookup(t)||(n=e,f.forEach(function(r){if(!a.isValidLookup(t)){o=r;var n,l,c=u,f=[c];if(a.i18nFormat&&a.i18nFormat.addLookupKeys)a.i18nFormat.addLookupKeys(f,u,r,e,s);else d&&(n=a.pluralResolver.getSuffix(r,s.count)),d&&h&&f.push(c+n),h&&f.push(c+="".concat(a.options.contextSeparator).concat(s.context)),d&&f.push(c+=n);for(;l=f.pop();)a.isValidLookup(t)||(i=l,t=a.getResource(r,e,l,s))}}))})}}),{res:t,usedKey:r,exactUsedKey:i,usedLng:o,usedNS:n}}},{key:"isValidLookup",value:function(e){return!(void 0===e||!this.options.returnNull&&null===e||!this.options.returnEmptyString&&""===e)}},{key:"getResource",value:function(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.i18nFormat&&this.i18nFormat.getResource?this.i18nFormat.getResource(e,t,r,i):this.resourceStore.getResource(e,t,r,i)}}]),o}();function L(e){return e.charAt(0).toUpperCase()+e.slice(1)}var w=function(){function e(r){t(this,e),this.options=r,this.whitelist=this.options.whitelist||!1,this.logger=g.create("languageUtils")}return i(e,[{key:"getScriptPartFromCode",value:function(e){if(!e||e.indexOf("-")<0)return null;var t=e.split("-");return 2===t.length?null:(t.pop(),this.formatLanguageCode(t.join("-")))}},{key:"getLanguagePartFromCode",value:function(e){if(!e||e.indexOf("-")<0)return e;var t=e.split("-");return this.formatLanguageCode(t[0])}},{key:"formatLanguageCode",value:function(e){if("string"==typeof e&&e.indexOf("-")>-1){var t=["hans","hant","latn","cyrl","cans","mong","arab"],r=e.split("-");return this.options.lowerCaseLng?r=r.map(function(e){return e.toLowerCase()}):2===r.length?(r[0]=r[0].toLowerCase(),r[1]=r[1].toUpperCase(),t.indexOf(r[1].toLowerCase())>-1&&(r[1]=L(r[1].toLowerCase()))):3===r.length&&(r[0]=r[0].toLowerCase(),2===r[1].length&&(r[1]=r[1].toUpperCase()),"sgn"!==r[0]&&2===r[2].length&&(r[2]=r[2].toUpperCase()),t.indexOf(r[1].toLowerCase())>-1&&(r[1]=L(r[1].toLowerCase())),t.indexOf(r[2].toLowerCase())>-1&&(r[2]=L(r[2].toLowerCase()))),r.join("-")}return this.options.cleanCode||this.options.lowerCaseLng?e.toLowerCase():e}},{key:"isWhitelisted",value:function(e){return("languageOnly"===this.options.load||this.options.nonExplicitWhitelist)&&(e=this.getLanguagePartFromCode(e)),!this.whitelist||!this.whitelist.length||this.whitelist.indexOf(e)>-1}},{key:"getFallbackCodes",value:function(e,t){if(!e)return[];if("string"==typeof e&&(e=[e]),"[object Array]"===Object.prototype.toString.apply(e))return e;if(!t)return e.default||[];var r=e[t];return r||(r=e[this.getScriptPartFromCode(t)]),r||(r=e[this.formatLanguageCode(t)]),r||(r=e.default),r||[]}},{key:"toResolveHierarchy",value:function(e,t){var r=this,i=this.getFallbackCodes(t||this.options.fallbackLng||[],e),o=[],n=function(e){e&&(r.isWhitelisted(e)?o.push(e):r.logger.warn("rejecting non-whitelisted language code: ".concat(e)))};return"string"==typeof e&&e.indexOf("-")>-1?("languageOnly"!==this.options.load&&n(this.formatLanguageCode(e)),"languageOnly"!==this.options.load&&"currentOnly"!==this.options.load&&n(this.getScriptPartFromCode(e)),"currentOnly"!==this.options.load&&n(this.getLanguagePartFromCode(e))):"string"==typeof e&&n(this.formatLanguageCode(e)),i.forEach(function(e){o.indexOf(e)<0&&n(r.formatLanguageCode(e))}),o}}]),e}(),S=[{lngs:["ach","ak","am","arn","br","fil","gun","ln","mfe","mg","mi","oc","pt","pt-BR","tg","ti","tr","uz","wa"],nr:[1,2],fc:1},{lngs:["af","an","ast","az","bg","bn","ca","da","de","dev","el","en","eo","es","et","eu","fi","fo","fur","fy","gl","gu","ha","hi","hu","hy","ia","it","kn","ku","lb","mai","ml","mn","mr","nah","nap","nb","ne","nl","nn","no","nso","pa","pap","pms","ps","pt-PT","rm","sco","se","si","so","son","sq","sv","sw","ta","te","tk","ur","yo"],nr:[1,2],fc:2},{lngs:["ay","bo","cgg","fa","id","ja","jbo","ka","kk","km","ko","ky","lo","ms","sah","su","th","tt","ug","vi","wo","zh"],nr:[1],fc:3},{lngs:["be","bs","dz","hr","ru","sr","uk"],nr:[1,2,5],fc:4},{lngs:["ar"],nr:[0,1,2,3,11,100],fc:5},{lngs:["cs","sk"],nr:[1,2,5],fc:6},{lngs:["csb","pl"],nr:[1,2,5],fc:7},{lngs:["cy"],nr:[1,2,3,8],fc:8},{lngs:["fr"],nr:[1,2],fc:9},{lngs:["ga"],nr:[1,2,3,7,11],fc:10},{lngs:["gd"],nr:[1,2,3,20],fc:11},{lngs:["is"],nr:[1,2],fc:12},{lngs:["jv"],nr:[0,1],fc:13},{lngs:["kw"],nr:[1,2,3,4],fc:14},{lngs:["lt"],nr:[1,2,10],fc:15},{lngs:["lv"],nr:[1,2,0],fc:16},{lngs:["mk"],nr:[1,2],fc:17},{lngs:["mnk"],nr:[0,1,2],fc:18},{lngs:["mt"],nr:[1,2,11,20],fc:19},{lngs:["or"],nr:[2,1],fc:2},{lngs:["ro"],nr:[1,2,20],fc:20},{lngs:["sl"],nr:[5,1,2,3],fc:21},{lngs:["he"],nr:[1,2,20,21],fc:22}],D={1:function(e){return Number(e>1)},2:function(e){return Number(1!=e)},3:function(e){return 0},4:function(e){return Number(e%10==1&&e%100!=11?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2)},5:function(e){return Number(0===e?0:1==e?1:2==e?2:e%100>=3&&e%100<=10?3:e%100>=11?4:5)},6:function(e){return Number(1==e?0:e>=2&&e<=4?1:2)},7:function(e){return Number(1==e?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2)},8:function(e){return Number(1==e?0:2==e?1:8!=e&&11!=e?2:3)},9:function(e){return Number(e>=2)},10:function(e){return Number(1==e?0:2==e?1:e<7?2:e<11?3:4)},11:function(e){return Number(1==e||11==e?0:2==e||12==e?1:e>2&&e<20?2:3)},12:function(e){return Number(e%10!=1||e%100==11)},13:function(e){return Number(0!==e)},14:function(e){return Number(1==e?0:2==e?1:3==e?2:3)},15:function(e){return Number(e%10==1&&e%100!=11?0:e%10>=2&&(e%100<10||e%100>=20)?1:2)},16:function(e){return Number(e%10==1&&e%100!=11?0:0!==e?1:2)},17:function(e){return Number(1==e||e%10==1?0:1)},18:function(e){return Number(0==e?0:1==e?1:2)},19:function(e){return Number(1==e?0:0===e||e%100>1&&e%100<11?1:e%100>10&&e%100<20?2:3)},20:function(e){return Number(1==e?0:0===e||e%100>0&&e%100<20?1:2)},21:function(e){return Number(e%100==1?1:e%100==2?2:e%100==3||e%100==4?3:0)},22:function(e){return Number(1===e?0:2===e?1:(e<0||e>10)&&e%10==0?2:3)}};var R=function(){function e(r){var i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t(this,e),this.languageUtils=r,this.options=o,this.logger=g.create("pluralResolver"),this.rules=(i={},S.forEach(function(e){e.lngs.forEach(function(t){i[t]={numbers:e.nr,plurals:D[e.fc]}})}),i)}return i(e,[{key:"addRule",value:function(e,t){this.rules[e]=t}},{key:"getRule",value:function(e){return this.rules[e]||this.rules[this.languageUtils.getLanguagePartFromCode(e)]}},{key:"needsPlural",value:function(e){var t=this.getRule(e);return t&&t.numbers.length>1}},{key:"getPluralFormsOfKey",value:function(e,t){var r=this,i=[],o=this.getRule(e);return o?(o.numbers.forEach(function(o){var n=r.getSuffix(e,o);i.push("".concat(t).concat(n))}),i):i}},{key:"getSuffix",value:function(e,t){var r=this,i=this.getRule(e);if(i){var o=i.noAbs?i.plurals(t):i.plurals(Math.abs(t)),n=i.numbers[o];this.options.simplifyPluralSuffix&&2===i.numbers.length&&1===i.numbers[0]&&(2===n?n="plural":1===n&&(n=""));var a=function(){return r.options.prepend&&n.toString()?r.options.prepend+n.toString():n.toString()};return"v1"===this.options.compatibilityJSON?1===n?"":"number"==typeof n?"_plural_".concat(n.toString()):a():"v2"===this.options.compatibilityJSON?a():this.options.simplifyPluralSuffix&&2===i.numbers.length&&1===i.numbers[0]?a():this.options.prepend&&o.toString()?this.options.prepend+o.toString():o.toString()}return this.logger.warn("no plural rule found for: ".concat(e)),""}}]),e}(),P=function(){function e(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,e),this.logger=g.create("interpolator"),this.init(r,!0)}return i(e,[{key:"init",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(arguments.length>1?arguments[1]:void 0)&&(this.options=e,this.format=e.interpolation&&e.interpolation.format||function(e){return e}),e.interpolation||(e.interpolation={escapeValue:!0});var t=e.interpolation;this.escape=void 0!==t.escape?t.escape:b,this.escapeValue=void 0===t.escapeValue||t.escapeValue,this.useRawValueToEscape=void 0!==t.useRawValueToEscape&&t.useRawValueToEscape,this.prefix=t.prefix?T(t.prefix):t.prefixEscaped||"{{",this.suffix=t.suffix?T(t.suffix):t.suffixEscaped||"}}",this.formatSeparator=t.formatSeparator?t.formatSeparator:t.formatSeparator||",",this.unescapePrefix=t.unescapeSuffix?"":t.unescapePrefix||"-",this.unescapeSuffix=this.unescapePrefix?"":t.unescapeSuffix||"",this.nestingPrefix=t.nestingPrefix?T(t.nestingPrefix):t.nestingPrefixEscaped||T("$t("),this.nestingSuffix=t.nestingSuffix?T(t.nestingSuffix):t.nestingSuffixEscaped||T(")"),this.maxReplaces=t.maxReplaces?t.maxReplaces:1e3,this.resetRegExp()}},{key:"reset",value:function(){this.options&&this.init(this.options)}},{key:"resetRegExp",value:function(){var e="".concat(this.prefix,"(.+?)").concat(this.suffix);this.regexp=new RegExp(e,"g");var t="".concat(this.prefix).concat(this.unescapePrefix,"(.+?)").concat(this.unescapeSuffix).concat(this.suffix);this.regexpUnescape=new RegExp(t,"g");var r="".concat(this.nestingPrefix,"(.+?)").concat(this.nestingSuffix);this.nestingRegexp=new RegExp(r,"g")}},{key:"interpolate",value:function(e,t,r,i){var o,n,a,s=this;function l(e){return e.replace(/\$/g,"$$$$")}var u=function(e){if(e.indexOf(s.formatSeparator)<0)return y(t,e);var i=e.split(s.formatSeparator),o=i.shift().trim(),n=i.join(s.formatSeparator).trim();return s.format(y(t,o),n,r)};this.resetRegExp();var c=i&&i.missingInterpolationHandler||this.options.missingInterpolationHandler;for(a=0;(o=this.regexpUnescape.exec(e))&&(n=u(o[1].trim()),e=e.replace(o[0],n),this.regexpUnescape.lastIndex=0,!(++a>=this.maxReplaces)););for(a=0;o=this.regexp.exec(e);){if(void 0===(n=u(o[1].trim())))if("function"==typeof c){var d=c(e,o,i);n="string"==typeof d?d:""}else this.logger.warn("missed to pass in variable ".concat(o[1]," for interpolating ").concat(e)),n="";else"string"==typeof n||this.useRawValueToEscape||(n=v(n));if(n=this.escapeValue?l(this.escape(n)):l(n),e=e.replace(o[0],n),this.regexp.lastIndex=0,++a>=this.maxReplaces)break}return e}},{key:"nest",value:function(e,t){var r,i,o=n({},arguments.length>2&&void 0!==arguments[2]?arguments[2]:{});function a(e,t){if(e.indexOf(",")<0)return e;var r=e.split(",");e=r.shift();var i=r.join(",");i=(i=this.interpolate(i,o)).replace(/'/g,'"');try{o=JSON.parse(i),t&&(o=n({},t,o))}catch(t){this.logger.error("failed parsing options string in nesting for key ".concat(e),t)}return e}for(o.applyPostProcessor=!1;r=this.nestingRegexp.exec(e);){if((i=t(a.call(this,r[1].trim(),o),o))&&r[0]===e&&"string"!=typeof i)return i;"string"!=typeof i&&(i=v(i)),i||(this.logger.warn("missed to resolve ".concat(r[1]," for nesting ").concat(e)),i=""),e=e.replace(r[0],i),this.regexp.lastIndex=0}return e}}]),e}();var I=function(e){function r(e,i,o){var n,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return t(this,r),n=c(this,s(r).call(this)),p.call(u(u(n))),n.backend=e,n.store=i,n.languageUtils=o.languageUtils,n.options=a,n.logger=g.create("backendConnector"),n.state={},n.queue=[],n.backend&&n.backend.init&&n.backend.init(o,a.backend,a),n}return a(r,p),i(r,[{key:"queueLoad",value:function(e,t,r,i){var o=this,n=[],a=[],s=[],l=[];return e.forEach(function(e){var i=!0;t.forEach(function(t){var s="".concat(e,"|").concat(t);!r.reload&&o.store.hasResourceBundle(e,t)?o.state[s]=2:o.state[s]<0||(1===o.state[s]?a.indexOf(s)<0&&a.push(s):(o.state[s]=1,i=!1,a.indexOf(s)<0&&a.push(s),n.indexOf(s)<0&&n.push(s),l.indexOf(t)<0&&l.push(t)))}),i||s.push(e)}),(n.length||a.length)&&this.queue.push({pending:a,loaded:{},errors:[],callback:i}),{toLoad:n,pending:a,toLoadLanguages:s,toLoadNamespaces:l}}},{key:"loaded",value:function(e,t,r){var i=d(e.split("|"),2),o=i[0],n=i[1];t&&this.emit("failedLoading",o,n,t),r&&this.store.addResourceBundle(o,n,r),this.state[e]=t?-1:2;var a={};this.queue.forEach(function(r){var i,s,l,u,c,d;i=r.loaded,s=n,u=x(i,[o],Object),c=u.obj,d=u.k,c[d]=c[d]||[],l&&(c[d]=c[d].concat(s)),l||c[d].push(s),function(e,t){for(var r=e.indexOf(t);-1!==r;)e.splice(r,1),r=e.indexOf(t)}(r.pending,e),t&&r.errors.push(t),0!==r.pending.length||r.done||(Object.keys(r.loaded).forEach(function(e){a[e]||(a[e]=[]),r.loaded[e].length&&r.loaded[e].forEach(function(t){a[e].indexOf(t)<0&&a[e].push(t)})}),r.done=!0,r.errors.length?r.callback(r.errors):r.callback())}),this.emit("loaded",a),this.queue=this.queue.filter(function(e){return!e.done})}},{key:"read",value:function(e,t,r){var i=this,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:250,a=arguments.length>5?arguments[5]:void 0;return e.length?this.backend[r](e,t,function(s,l){s&&l&&o<5?setTimeout(function(){i.read.call(i,e,t,r,o+1,2*n,a)},n):a(s,l)}):a(null,{})}},{key:"prepareLoading",value:function(e,t){var r=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3?arguments[3]:void 0;if(!this.backend)return this.logger.warn("No backend was added via i18next.use. Will not load resources."),o&&o();"string"==typeof e&&(e=this.languageUtils.toResolveHierarchy(e)),"string"==typeof t&&(t=[t]);var n=this.queueLoad(e,t,i,o);if(!n.toLoad.length)return n.pending.length||o(),null;n.toLoad.forEach(function(e){r.loadOne(e)})}},{key:"load",value:function(e,t,r){this.prepareLoading(e,t,{},r)}},{key:"reload",value:function(e,t,r){this.prepareLoading(e,t,{reload:!0},r)}},{key:"loadOne",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",i=d(e.split("|"),2),o=i[0],n=i[1];this.read(o,n,"read",null,null,function(i,a){i&&t.logger.warn("".concat(r,"loading namespace ").concat(n," for language ").concat(o," failed"),i),!i&&a&&t.logger.log("".concat(r,"loaded namespace ").concat(n," for language ").concat(o),a),t.loaded(e,i,a)})}},{key:"saveMissing",value:function(e,t,r,i,o){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};this.backend&&this.backend.create&&this.backend.create(e,t,r,i,null,n({},a,{isUpdate:o})),e&&e[0]&&this.store.addResource(e[0],t,r,i)}}]),r}();function F(e){return"string"==typeof e.ns&&(e.ns=[e.ns]),"string"==typeof e.fallbackLng&&(e.fallbackLng=[e.fallbackLng]),"string"==typeof e.fallbackNS&&(e.fallbackNS=[e.fallbackNS]),e.whitelist&&e.whitelist.indexOf("cimode")<0&&(e.whitelist=e.whitelist.concat(["cimode"])),e}function O(){}return new(function(r){function o(){var e,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;if(t(this,o),e=c(this,s(o).call(this)),p.call(u(u(e))),e.options=F(r),e.services={},e.logger=g,e.modules={external:[]},i&&!e.isInitialized&&!r.isClone){if(!e.options.initImmediate)return e.init(r,i),c(e,u(u(e)));setTimeout(function(){e.init(r,i)},0)}return e}return a(o,p),i(o,[{key:"init",value:function(){var t=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;function o(e){return e?"function"==typeof e?new e:e:null}if("function"==typeof r&&(i=r,r={}),this.options=n({},{debug:!1,initImmediate:!0,ns:["translation"],defaultNS:["translation"],fallbackLng:["dev"],fallbackNS:!1,whitelist:!1,nonExplicitWhitelist:!1,load:"all",preload:!1,simplifyPluralSuffix:!0,keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_",partialBundledLanguages:!1,saveMissing:!1,updateMissing:!1,saveMissingTo:"fallback",saveMissingPlurals:!0,missingKeyHandler:!1,missingInterpolationHandler:!1,postProcess:!1,returnNull:!0,returnEmptyString:!0,returnObjects:!1,joinArrays:!1,returnedObjectHandler:function(){},parseMissingKeyHandler:!1,appendNamespaceToMissingKey:!1,appendNamespaceToCIMode:!1,overloadTranslationOptionHandler:function(t){var r={};if("object"===e(t[1])&&(r=t[1]),"string"==typeof t[1]&&(r.defaultValue=t[1]),"string"==typeof t[2]&&(r.tDescription=t[2]),"object"===e(t[2])||"object"===e(t[3])){var i=t[3]||t[2];Object.keys(i).forEach(function(e){r[e]=i[e]})}return r},interpolation:{escapeValue:!0,format:function(e,t,r){return e},prefix:"{{",suffix:"}}",formatSeparator:",",unescapePrefix:"-",nestingPrefix:"$t(",nestingSuffix:")",maxReplaces:1e3}},this.options,F(r)),this.format=this.options.interpolation.format,i||(i=O),!this.options.isClone){this.modules.logger?g.init(o(this.modules.logger),this.options):g.init(null,this.options);var a=new w(this.options);this.store=new M(this.options.resources,this.options);var s=this.services;s.logger=g,s.resourceStore=this.store,s.languageUtils=a,s.pluralResolver=new R(a,{prepend:this.options.pluralSeparator,compatibilityJSON:this.options.compatibilityJSON,simplifyPluralSuffix:this.options.simplifyPluralSuffix}),s.interpolator=new P(this.options),s.backendConnector=new I(o(this.modules.backend),s.resourceStore,s,this.options),s.backendConnector.on("*",function(e){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];t.emit.apply(t,[e].concat(i))}),this.modules.languageDetector&&(s.languageDetector=o(this.modules.languageDetector),s.languageDetector.init(s,this.options.detection,this.options)),this.modules.i18nFormat&&(s.i18nFormat=o(this.modules.i18nFormat),s.i18nFormat.init&&s.i18nFormat.init(this)),this.translator=new E(this.services,this.options),this.translator.on("*",function(e){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];t.emit.apply(t,[e].concat(i))}),this.modules.external.forEach(function(e){e.init&&e.init(t)})}["getResource","addResource","addResources","addResourceBundle","removeResourceBundle","hasResourceBundle","getResourceBundle","getDataByLanguage"].forEach(function(e){t[e]=function(){var r;return(r=t.store)[e].apply(r,arguments)}});var l=m(),u=function(){t.changeLanguage(t.options.lng,function(e,r){t.isInitialized=!0,t.logger.log("initialized",t.options),t.emit("initialized",t.options),l.resolve(r),i(e,r)})};return this.options.resources||!this.options.initImmediate?u():setTimeout(u,0),l}},{key:"loadResources",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:O;if(!this.options.resources||this.options.partialBundledLanguages){if(this.language&&"cimode"===this.language.toLowerCase())return t();var r=[],i=function(t){t&&e.services.languageUtils.toResolveHierarchy(t).forEach(function(e){r.indexOf(e)<0&&r.push(e)})};if(this.language)i(this.language);else this.services.languageUtils.getFallbackCodes(this.options.fallbackLng).forEach(function(e){return i(e)});this.options.preload&&this.options.preload.forEach(function(e){return i(e)}),this.services.backendConnector.load(r,this.options.ns,t)}else t(null)}},{key:"reloadResources",value:function(e,t,r){var i=m();return e||(e=this.languages),t||(t=this.options.ns),r||(r=O),this.services.backendConnector.reload(e,t,function(e){i.resolve(),r(e)}),i}},{key:"use",value:function(e){return"backend"===e.type&&(this.modules.backend=e),("logger"===e.type||e.log&&e.warn&&e.error)&&(this.modules.logger=e),"languageDetector"===e.type&&(this.modules.languageDetector=e),"i18nFormat"===e.type&&(this.modules.i18nFormat=e),"postProcessor"===e.type&&A.addPostProcessor(e),"3rdParty"===e.type&&this.modules.external.push(e),this}},{key:"changeLanguage",value:function(e,t){var r=this,i=m();this.emit("languageChanging",e);var o=function(e){e&&(r.language=e,r.languages=r.services.languageUtils.toResolveHierarchy(e),r.translator.language||r.translator.changeLanguage(e),r.services.languageDetector&&r.services.languageDetector.cacheUserLanguage(e)),r.loadResources(function(o){!function(e,o){r.translator.changeLanguage(o),o&&(r.emit("languageChanged",o),r.logger.log("languageChanged",o)),i.resolve(function(){return r.t.apply(r,arguments)}),t&&t(e,function(){return r.t.apply(r,arguments)})}(o,e)})};return e||!this.services.languageDetector||this.services.languageDetector.async?!e&&this.services.languageDetector&&this.services.languageDetector.async?this.services.languageDetector.detect(o):o(e):o(this.services.languageDetector.detect()),i}},{key:"getFixedT",value:function(t,r){var i=this,o=function t(r,o){var a=n({},o);if("object"!==e(o)){for(var s=arguments.length,l=new Array(s>2?s-2:0),u=2;u<s;u++)l[u-2]=arguments[u];a=i.options.overloadTranslationOptionHandler([r,o].concat(l))}return a.lng=a.lng||t.lng,a.lngs=a.lngs||t.lngs,a.ns=a.ns||t.ns,i.t(r,a)};return"string"==typeof t?o.lng=t:o.lngs=t,o.ns=r,o}},{key:"t",value:function(){var e;return this.translator&&(e=this.translator).translate.apply(e,arguments)}},{key:"exists",value:function(){var e;return this.translator&&(e=this.translator).exists.apply(e,arguments)}},{key:"setDefaultNamespace",value:function(e){this.options.defaultNS=e}},{key:"loadNamespaces",value:function(e,t){var r=this,i=m();return this.options.ns?("string"==typeof e&&(e=[e]),e.forEach(function(e){r.options.ns.indexOf(e)<0&&r.options.ns.push(e)}),this.loadResources(function(e){i.resolve(),t&&t(e)}),i):(t&&t(),Promise.resolve())}},{key:"loadLanguages",value:function(e,t){var r=m();"string"==typeof e&&(e=[e]);var i=this.options.preload||[],o=e.filter(function(e){return i.indexOf(e)<0});return o.length?(this.options.preload=i.concat(o),this.loadResources(function(e){r.resolve(),t&&t(e)}),r):(t&&t(),Promise.resolve())}},{key:"dir",value:function(e){if(e||(e=this.languages&&this.languages.length>0?this.languages[0]:this.language),!e)return"rtl";return["ar","shu","sqr","ssh","xaa","yhd","yud","aao","abh","abv","acm","acq","acw","acx","acy","adf","ads","aeb","aec","afb","ajp","apc","apd","arb","arq","ars","ary","arz","auz","avl","ayh","ayl","ayn","ayp","bbz","pga","he","iw","ps","pbt","pbu","pst","prp","prd","ur","ydd","yds","yih","ji","yi","hbo","men","xmn","fa","jpr","peo","pes","prs","dv","sam"].indexOf(this.services.languageUtils.getLanguagePartFromCode(e))>=0?"rtl":"ltr"}},{key:"createInstance",value:function(){return new o(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},arguments.length>1?arguments[1]:void 0)}},{key:"cloneInstance",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:O,i=n({},this.options,t,{isClone:!0}),a=new o(i);return["store","services","language"].forEach(function(t){a[t]=e[t]}),a.translator=new E(a.services,a.options),a.translator.on("*",function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];a.emit.apply(a,[e].concat(r))}),a.init(i,r),a.translator.options=a.options,a}}]),o}())}),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.i18nextBrowserLanguageDetector=t()}(this,function(){var e=[],t=e.forEach,r=e.slice;var i=function(e,t,r,i){var o=void 0;if(r){var n=new Date;n.setTime(n.getTime()+60*r*1e3),o="; expires="+n.toGMTString()}else o="";i=i?"domain="+i+";":"",document.cookie=e+"="+t+o+";"+i+"path=/"},o=function(e){for(var t=e+"=",r=document.cookie.split(";"),i=0;i<r.length;i++){for(var o=r[i];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(t))return o.substring(t.length,o.length)}return null},n={name:"cookie",lookup:function(e){var t=void 0;if(e.lookupCookie&&"undefined"!=typeof document){var r=o(e.lookupCookie);r&&(t=r)}return t},cacheUserLanguage:function(e,t){t.lookupCookie&&"undefined"!=typeof document&&i(t.lookupCookie,e,t.cookieMinutes,t.cookieDomain)}},a={name:"querystring",lookup:function(e){var t=void 0;if("undefined"!=typeof window)for(var r=window.location.search.substring(1).split("&"),i=0;i<r.length;i++){var o=r[i].indexOf("=");if(o>0)r[i].substring(0,o)===e.lookupQuerystring&&(t=r[i].substring(o+1))}return t}},s=void 0;try{s="undefined"!==window&&null!==window.localStorage;window.localStorage.setItem("i18next.translate.boo","foo"),window.localStorage.removeItem("i18next.translate.boo")}catch(e){s=!1}var l={name:"localStorage",lookup:function(e){var t=void 0;if(e.lookupLocalStorage&&s){var r=window.localStorage.getItem(e.lookupLocalStorage);r&&(t=r)}return t},cacheUserLanguage:function(e,t){t.lookupLocalStorage&&s&&window.localStorage.setItem(t.lookupLocalStorage,e)}},u={name:"navigator",lookup:function(e){var t=[];if("undefined"!=typeof navigator){if(navigator.languages)for(var r=0;r<navigator.languages.length;r++)t.push(navigator.languages[r]);navigator.userLanguage&&t.push(navigator.userLanguage),navigator.language&&t.push(navigator.language)}return t.length>0?t:void 0}},c={name:"htmlTag",lookup:function(e){var t=void 0,r=e.htmlTag||("undefined"!=typeof document?document.documentElement:null);return r&&"function"==typeof r.getAttribute&&(t=r.getAttribute("lang")),t}},d={name:"path",lookup:function(e){var t=void 0;if("undefined"!=typeof window){var r=window.location.pathname.match(/\/([a-zA-Z-]*)/g);if(r instanceof Array)if("number"==typeof e.lookupFromPathIndex){if("string"!=typeof r[e.lookupFromPathIndex])return;t=r[e.lookupFromPathIndex].replace("/","")}else t=r[0].replace("/","")}return t}},h={name:"subdomain",lookup:function(e){var t=void 0;if("undefined"!=typeof window){var r=window.location.href.match(/(?:http[s]*\:\/\/)*(.*?)\.(?=[^\/]*\..{2,5})/gi);r instanceof Array&&(t="number"==typeof e.lookupFromSubdomainIndex?r[e.lookupFromSubdomainIndex].replace("http://","").replace("https://","").replace(".",""):r[0].replace("http://","").replace("https://","").replace(".",""))}return t}},f=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();var g=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.type="languageDetector",this.detectors={},this.init(t,r)}return f(e,[{key:"init",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.services=e,this.options=function(e){return t.call(r.call(arguments,1),function(t){if(t)for(var r in t)void 0===e[r]&&(e[r]=t[r])}),e}(i,this.options||{},{order:["querystring","cookie","localStorage","navigator","htmlTag"],lookupQuerystring:"lng",lookupCookie:"i18next",lookupLocalStorage:"i18nextLng",caches:["localStorage"],excludeCacheFor:["cimode"]}),this.options.lookupFromUrlIndex&&(this.options.lookupFromPathIndex=this.options.lookupFromUrlIndex),this.i18nOptions=o,this.addDetector(n),this.addDetector(a),this.addDetector(l),this.addDetector(u),this.addDetector(c),this.addDetector(d),this.addDetector(h)}},{key:"addDetector",value:function(e){this.detectors[e.name]=e}},{key:"detect",value:function(e){var t=this;e||(e=this.options.order);var r=[];e.forEach(function(e){if(t.detectors[e]){var i=t.detectors[e].lookup(t.options);i&&"string"==typeof i&&(i=[i]),i&&(r=r.concat(i))}});var i=void 0;if(r.forEach(function(e){if(!i){var r=t.services.languageUtils.formatLanguageCode(e);t.services.languageUtils.isWhitelisted(r)&&(i=r)}}),!i){var o=this.i18nOptions.fallbackLng;"string"==typeof o&&(o=[o]),o||(o=[]),i="[object Array]"===Object.prototype.toString.apply(o)?o[0]:o[0]||o.default&&o.default[0]}return i}},{key:"cacheUserLanguage",value:function(e,t){var r=this;t||(t=this.options.caches),t&&(this.options.excludeCacheFor&&this.options.excludeCacheFor.indexOf(e)>-1||t.forEach(function(t){r.detectors[t]&&r.detectors[t].cacheUserLanguage(e,r.options)}))}}]),e}();return g.type="languageDetector",g}),function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.i18nextXHRBackend=t()}(this,function(){var e=[],t=e.forEach,r=e.slice;var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function o(e,t){if(t&&"object"===(void 0===t?"undefined":i(t))){var r="",o=encodeURIComponent;for(var n in t)r+="&"+o(n)+"="+o(t[n]);if(!r)return e;e=e+(-1!==e.indexOf("?")?"&":"?")+r.slice(1)}return e}function n(e,t,r,n,a){n&&"object"===(void 0===n?"undefined":i(n))&&(a||(n._t=new Date),n=o("",n).slice(1)),t.queryStringParams&&(e=o(e,t.queryStringParams));try{var s;(s=XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0")).open(n?"POST":"GET",e,1),t.crossDomain||s.setRequestHeader("X-Requested-With","XMLHttpRequest"),s.withCredentials=!!t.withCredentials,n&&s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.overrideMimeType&&s.overrideMimeType("application/json");var l=t.customHeaders;if(l)for(var u in l)s.setRequestHeader(u,l[u]);s.onreadystatechange=function(){s.readyState>3&&r&&r(s.responseText,s)},s.send(n)}catch(e){console&&console.log(e)}}var a=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();var s=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.init(t,r),this.type="backend"}return a(e,[{key:"init",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.services=e,this.options=function(e){return t.call(r.call(arguments,1),function(t){if(t)for(var r in t)void 0===e[r]&&(e[r]=t[r])}),e}(i,this.options||{},{loadPath:"/locales/{{lng}}/{{ns}}.json",addPath:"/locales/add/{{lng}}/{{ns}}",allowMultiLoading:!1,parse:JSON.parse,crossDomain:!1,ajax:n})}},{key:"readMulti",value:function(e,t,r){var i=this.options.loadPath;"function"==typeof this.options.loadPath&&(i=this.options.loadPath(e,t));var o=this.services.interpolator.interpolate(i,{lng:e.join("+"),ns:t.join("+")});this.loadUrl(o,r)}},{key:"read",value:function(e,t,r){var i=this.options.loadPath;"function"==typeof this.options.loadPath&&(i=this.options.loadPath([e],[t]));var o=this.services.interpolator.interpolate(i,{lng:e,ns:t});this.loadUrl(o,r)}},{key:"loadUrl",value:function(e,t){var r=this;this.options.ajax(e,this.options,function(i,o){if(o.status>=500&&o.status<600)return t("failed loading "+e,!0);if(o.status>=400&&o.status<500)return t("failed loading "+e,!1);var n=void 0,a=void 0;try{n=r.options.parse(i,e)}catch(t){a="failed parsing "+e+" to json"}if(a)return t(a,!1);t(null,n)})}},{key:"create",value:function(e,t,r,i){var o=this;"string"==typeof e&&(e=[e]);var n={};n[r]=i||"",e.forEach(function(e){var r=o.services.interpolator.interpolate(o.options.addPath,{lng:e,ns:t});o.options.ajax(r,o.options,function(e,t){},n)})}}]),e}();return s.type="backend",s}),(()=>{var e={645:(e,t)=>{t.read=function(e,t,r,i,o){var n,a,s=8*o-i-1,l=(1<<s)-1,u=l>>1,c=-7,d=r?o-1:0,h=r?-1:1,f=e[t+d];for(d+=h,n=f&(1<<-c)-1,f>>=-c,c+=s;c>0;n=256*n+e[t+d],d+=h,c-=8);for(a=n&(1<<-c)-1,n>>=-c,c+=i;c>0;a=256*a+e[t+d],d+=h,c-=8);if(0===n)n=1-u;else{if(n===l)return a?NaN:1/0*(f?-1:1);a+=Math.pow(2,i),n-=u}return(f?-1:1)*a*Math.pow(2,n-i)},t.write=function(e,t,r,i,o,n){var a,s,l,u=8*n-o-1,c=(1<<u)-1,d=c>>1,h=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,f=i?0:n-1,g=i?1:-1,p=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,a=c):(a=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-a))<1&&(a--,l*=2),(t+=a+d>=1?h/l:h*Math.pow(2,1-d))*l>=2&&(a++,l/=2),a+d>=c?(s=0,a=c):a+d>=1?(s=(t*l-1)*Math.pow(2,o),a+=d):(s=t*Math.pow(2,d-1)*Math.pow(2,o),a=0));o>=8;e[r+f]=255&s,f+=g,s/=256,o-=8);for(a=a<<o|s,u+=o;u>0;e[r+f]=255&a,f+=g,a/=256,u-=8);e[r+f-g]|=128*p}},901:(e,t,r)=>{e.exports=o;var i=r(645);function o(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}o.Varint=0,o.Fixed64=1,o.Bytes=2,o.Fixed32=5;var n=4294967296,a=1/n,s="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function l(e){return e.type===o.Bytes?e.readVarint()+e.pos:e.pos+1}function u(e,t,r){return r?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function c(e,t,r){var i=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));r.realloc(i);for(var o=r.pos-1;o>=e;o--)r.buf[o+i]=r.buf[o]}function d(e,t){for(var r=0;r<e.length;r++)t.writeVarint(e[r])}function h(e,t){for(var r=0;r<e.length;r++)t.writeSVarint(e[r])}function f(e,t){for(var r=0;r<e.length;r++)t.writeFloat(e[r])}function g(e,t){for(var r=0;r<e.length;r++)t.writeDouble(e[r])}function p(e,t){for(var r=0;r<e.length;r++)t.writeBoolean(e[r])}function m(e,t){for(var r=0;r<e.length;r++)t.writeFixed32(e[r])}function v(e,t){for(var r=0;r<e.length;r++)t.writeSFixed32(e[r])}function x(e,t){for(var r=0;r<e.length;r++)t.writeFixed64(e[r])}function _(e,t){for(var r=0;r<e.length;r++)t.writeSFixed64(e[r])}function y(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function T(e,t,r){e[r]=t,e[r+1]=t>>>8,e[r+2]=t>>>16,e[r+3]=t>>>24}function C(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}o.prototype={destroy:function(){this.buf=null},readFields:function(e,t,r){for(r=r||this.length;this.pos<r;){var i=this.readVarint(),o=i>>3,n=this.pos;this.type=7&i,e(o,t,this),this.pos===n&&this.skip(i)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=y(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=C(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=y(this.buf,this.pos)+y(this.buf,this.pos+4)*n;return this.pos+=8,e},readSFixed64:function(){var e=y(this.buf,this.pos)+C(this.buf,this.pos+4)*n;return this.pos+=8,e},readFloat:function(){var e=i.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=i.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,r,i=this.buf;return t=127&(r=i[this.pos++]),r<128?t:(t|=(127&(r=i[this.pos++]))<<7,r<128?t:(t|=(127&(r=i[this.pos++]))<<14,r<128?t:(t|=(127&(r=i[this.pos++]))<<21,r<128?t:function(e,t,r){var i,o,n=r.buf;if(i=(112&(o=n[r.pos++]))>>4,o<128)return u(e,i,t);if(i|=(127&(o=n[r.pos++]))<<3,o<128)return u(e,i,t);if(i|=(127&(o=n[r.pos++]))<<10,o<128)return u(e,i,t);if(i|=(127&(o=n[r.pos++]))<<17,o<128)return u(e,i,t);if(i|=(127&(o=n[r.pos++]))<<24,o<128)return u(e,i,t);if(i|=(1&(o=n[r.pos++]))<<31,o<128)return u(e,i,t);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(r=i[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&s?function(e,t,r){return s.decode(e.subarray(t,r))}(this.buf,t,e):function(e,t,r){for(var i="",o=t;o<r;){var n,a,s,l=e[o],u=null,c=l>239?4:l>223?3:l>191?2:1;if(o+c>r)break;1===c?l<128&&(u=l):2===c?128==(192&(n=e[o+1]))&&(u=(31&l)<<6|63&n)<=127&&(u=null):3===c?(n=e[o+1],a=e[o+2],128==(192&n)&&128==(192&a)&&((u=(15&l)<<12|(63&n)<<6|63&a)<=2047||u>=55296&&u<=57343)&&(u=null)):4===c&&(n=e[o+1],a=e[o+2],s=e[o+3],128==(192&n)&&128==(192&a)&&128==(192&s)&&((u=(15&l)<<18|(63&n)<<12|(63&a)<<6|63&s)<=65535||u>=1114112)&&(u=null)),null===u?(u=65533,c=1):u>65535&&(u-=65536,i+=String.fromCharCode(u>>>10&1023|55296),u=56320|1023&u),i+=String.fromCharCode(u),o+=c}return i}(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==o.Bytes)return e.push(this.readVarint(t));var r=l(this);for(e=e||[];this.pos<r;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==o.Bytes)return e.push(this.readSVarint());var t=l(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==o.Bytes)return e.push(this.readBoolean());var t=l(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==o.Bytes)return e.push(this.readFloat());var t=l(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==o.Bytes)return e.push(this.readDouble());var t=l(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==o.Bytes)return e.push(this.readFixed32());var t=l(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==o.Bytes)return e.push(this.readSFixed32());var t=l(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==o.Bytes)return e.push(this.readFixed64());var t=l(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==o.Bytes)return e.push(this.readSFixed64());var t=l(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===o.Varint)for(;this.buf[this.pos++]>127;);else if(t===o.Bytes)this.pos=this.readVarint()+this.pos;else if(t===o.Fixed32)this.pos+=4;else{if(t!==o.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var r=new Uint8Array(t);r.set(this.buf),this.buf=r,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),T(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),T(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),T(this.buf,-1&e,this.pos),T(this.buf,Math.floor(e*a),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),T(this.buf,-1&e,this.pos),T(this.buf,Math.floor(e*a),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(e,t){var r,i;if(e>=0?(r=e%4294967296|0,i=e/4294967296|0):(i=~(-e/4294967296),4294967295^(r=~(-e%4294967296))?r=r+1|0:(r=0,i=i+1|0)),e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,r){r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos++]=127&e|128,e>>>=7,r.buf[r.pos]=127&e}(r,0,t),function(e,t){var r=(7&e)<<4;t.buf[t.pos++]|=r|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e)))))}(i,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(Boolean(e))},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(e,t,r){for(var i,o,n=0;n<t.length;n++){if((i=t.charCodeAt(n))>55295&&i<57344){if(!o){i>56319||n+1===t.length?(e[r++]=239,e[r++]=191,e[r++]=189):o=i;continue}if(i<56320){e[r++]=239,e[r++]=191,e[r++]=189,o=i;continue}i=o-55296<<10|i-56320|65536,o=null}else o&&(e[r++]=239,e[r++]=191,e[r++]=189,o=null);i<128?e[r++]=i:(i<2048?e[r++]=i>>6|192:(i<65536?e[r++]=i>>12|224:(e[r++]=i>>18|240,e[r++]=i>>12&63|128),e[r++]=i>>6&63|128),e[r++]=63&i|128)}return r}(this.buf,e,this.pos);var r=this.pos-t;r>=128&&c(t,r,this),this.pos=t-1,this.writeVarint(r),this.pos+=r},writeFloat:function(e){this.realloc(4),i.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),i.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var r=0;r<t;r++)this.buf[this.pos++]=e[r]},writeRawMessage:function(e,t){this.pos++;var r=this.pos;e(t,this);var i=this.pos-r;i>=128&&c(r,i,this),this.pos=r-1,this.writeVarint(i),this.pos+=i},writeMessage:function(e,t,r){this.writeTag(e,o.Bytes),this.writeRawMessage(t,r)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,d,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,h,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,p,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,f,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,g,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,m,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,v,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,x,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,_,t)},writeBytesField:function(e,t){this.writeTag(e,o.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,o.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,o.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,o.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,o.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,o.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,o.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,o.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,o.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,o.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,Boolean(t))}}}},t={},r=function r(i){var o=t[i];if(void 0!==o)return o.exports;var n=t[i]={exports:{}};return e[i](n,n.exports,r),n.exports}(901);Pbf=r})(),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).PromiseWorker=e()}}(function(){return function(){return function e(t,r,i){function o(a,s){if(!r[a]){if(!t[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var c=r[a]={exports:{}};t[a][0].call(c.exports,function(e){return o(t[a][1][e]||e)},c,c.exports,e,t,r,i)}return r[a].exports}for(var n="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}}()({1:[function(e,t,r){var i=0;function o(e,t){var r=t.data;if(Array.isArray(r)&&!(r.length<2)){var i=r[0],o=r[1],n=r[2],a=e._callbacks[i];a&&(delete e._callbacks[i],a(o,n))}}function n(e){var t=this;t._worker=e,t._callbacks={},e.addEventListener("message",function(e){o(t,e)})}n.prototype.postMessage=function(e){var t=this,r=i++,n=[r,e];return new Promise(function(e,i){if(t._callbacks[r]=function(t,r){if(t)return i(new Error(t.message));e(r)},void 0!==t._worker.controller){var a=new MessageChannel;a.port1.onmessage=function(e){o(t,e)},t._worker.controller.postMessage(n,[a.port2])}else t._worker.postMessage(n)})},t.exports=n},{}]},{},[1])(1)}),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).rbush=e()}}(function(){return function e(t,r,i){function o(a,s){if(!r[a]){if(!t[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(n)return n(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var c=r[a]={exports:{}};t[a][0].call(c.exports,function(e){var r=t[a][1][e];return o(r||e)},c,c.exports,e,t,r,i)}return r[a].exports}for(var n="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}({1:[function(e,t,r){t.exports=o;var i=e("quickselect");function o(e,t){if(!(this instanceof o))return new o(e,t);this._maxEntries=Math.max(4,e||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),t&&this._initFormat(t),this.clear()}function n(e,t,r){if(!r)return t.indexOf(e);for(var i=0;i<t.length;i++)if(r(e,t[i]))return i;return-1}function a(e,t){s(e,0,e.children.length,t,e)}function s(e,t,r,i,o){o||(o=p(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var n,a=t;a<r;a++)n=e.children[a],l(o,e.leaf?i(n):n);return o}function l(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function u(e,t){return e.minX-t.minX}function c(e,t){return e.minY-t.minY}function d(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function h(e){return e.maxX-e.minX+(e.maxY-e.minY)}function f(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function g(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function p(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function m(e,t,r,o,n){for(var a,s=[t,r];s.length;)(r=s.pop())-(t=s.pop())<=o||(a=t+Math.ceil((r-t)/o/2)*o,i(e,a,t,r,n),s.push(t,a,a,r))}o.prototype={all:function(){return this._all(this.data,[])},search:function(e){var t=this.data,r=[],i=this.toBBox;if(!g(e,t))return r;for(var o,n,a,s,l=[];t;){for(o=0,n=t.children.length;o<n;o++)a=t.children[o],g(e,s=t.leaf?i(a):a)&&(t.leaf?r.push(a):f(e,s)?this._all(a,r):l.push(a));t=l.pop()}return r},collides:function(e){var t=this.data,r=this.toBBox;if(!g(e,t))return!1;for(var i,o,n,a,s=[];t;){for(i=0,o=t.children.length;i<o;i++)if(n=t.children[i],g(e,a=t.leaf?r(n):n)){if(t.leaf||f(e,a))return!0;s.push(n)}t=s.pop()}return!1},load:function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0,r=e.length;t<r;t++)this.insert(e[t]);return this}var i=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===i.height)this._splitRoot(this.data,i);else{if(this.data.height<i.height){var o=this.data;this.data=i,i=o}this._insert(i,this.data.height-i.height-1,!0)}else this.data=i;return this},insert:function(e){return e&&this._insert(e,this.data.height-1),this},clear:function(){return this.data=p([]),this},remove:function(e,t){if(!e)return this;for(var r,i,o,a,s=this.data,l=this.toBBox(e),u=[],c=[];s||u.length;){if(s||(s=u.pop(),i=u[u.length-1],r=c.pop(),a=!0),s.leaf&&-1!==(o=n(e,s.children,t)))return s.children.splice(o,1),u.push(s),this._condense(u),this;a||s.leaf||!f(s,l)?i?(r++,s=i.children[r],a=!1):s=null:(u.push(s),c.push(r),r=0,i=s,s=s.children[0])}return this},toBBox:function(e){return e},compareMinX:u,compareMinY:c,toJSON:function(){return this.data},fromJSON:function(e){return this.data=e,this},_all:function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},_build:function(e,t,r,i){var o,n=r-t+1,s=this._maxEntries;if(n<=s)return a(o=p(e.slice(t,r+1)),this.toBBox),o;i||(i=Math.ceil(Math.log(n)/Math.log(s)),s=Math.ceil(n/Math.pow(s,i-1))),(o=p([])).leaf=!1,o.height=i;var l,u,c,d,h=Math.ceil(n/s),f=h*Math.ceil(Math.sqrt(s));for(m(e,t,r,f,this.compareMinX),l=t;l<=r;l+=f)for(m(e,l,c=Math.min(l+f-1,r),h,this.compareMinY),u=l;u<=c;u+=h)d=Math.min(u+h-1,c),o.children.push(this._build(e,u,d,i-1));return a(o,this.toBBox),o},_chooseSubtree:function(e,t,r,i){for(var o,n,a,s,l,u,c,h,f,g;i.push(t),!t.leaf&&i.length-1!==r;){for(c=h=1/0,o=0,n=t.children.length;o<n;o++)l=d(a=t.children[o]),f=e,g=a,(u=(Math.max(g.maxX,f.maxX)-Math.min(g.minX,f.minX))*(Math.max(g.maxY,f.maxY)-Math.min(g.minY,f.minY))-l)<h?(h=u,c=l<c?l:c,s=a):u===h&&l<c&&(c=l,s=a);t=s||t.children[0]}return t},_insert:function(e,t,r){var i=this.toBBox,o=r?e:i(e),n=[],a=this._chooseSubtree(o,this.data,t,n);for(a.children.push(e),l(a,o);t>=0&&n[t].children.length>this._maxEntries;)this._split(n,t),t--;this._adjustParentBBoxes(o,n,t)},_split:function(e,t){var r=e[t],i=r.children.length,o=this._minEntries;this._chooseSplitAxis(r,o,i);var n=this._chooseSplitIndex(r,o,i),s=p(r.children.splice(n,r.children.length-n));s.height=r.height,s.leaf=r.leaf,a(r,this.toBBox),a(s,this.toBBox),t?e[t-1].children.push(s):this._splitRoot(r,s)},_splitRoot:function(e,t){this.data=p([e,t]),this.data.height=e.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},_chooseSplitIndex:function(e,t,r){var i,o,n,a,l,u,c,h,f,g,p,m,v,x;for(u=c=1/0,i=t;i<=r-t;i++)o=s(e,0,i,this.toBBox),n=s(e,i,r,this.toBBox),f=o,g=n,void 0,void 0,void 0,void 0,p=Math.max(f.minX,g.minX),m=Math.max(f.minY,g.minY),v=Math.min(f.maxX,g.maxX),x=Math.min(f.maxY,g.maxY),a=Math.max(0,v-p)*Math.max(0,x-m),l=d(o)+d(n),a<u?(u=a,h=i,c=l<c?l:c):a===u&&l<c&&(c=l,h=i);return h},_chooseSplitAxis:function(e,t,r){var i=e.leaf?this.compareMinX:u,o=e.leaf?this.compareMinY:c;this._allDistMargin(e,t,r,i)<this._allDistMargin(e,t,r,o)&&e.children.sort(i)},_allDistMargin:function(e,t,r,i){e.children.sort(i);var o,n,a=this.toBBox,u=s(e,0,t,a),c=s(e,r-t,r,a),d=h(u)+h(c);for(o=t;o<r-t;o++)n=e.children[o],l(u,e.leaf?a(n):n),d+=h(u);for(o=r-t-1;o>=t;o--)n=e.children[o],l(c,e.leaf?a(n):n),d+=h(c);return d},_adjustParentBBoxes:function(e,t,r){for(var i=r;i>=0;i--)l(t[i],e)},_condense:function(e){for(var t,r=e.length-1;r>=0;r--)0===e[r].children.length?r>0?(t=e[r-1].children).splice(t.indexOf(e[r]),1):this.clear():a(e[r],this.toBBox)},_initFormat:function(e){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(e[0])),this.compareMinY=new Function("a","b",t.join(e[1])),this.toBBox=new Function("a","return {minX: a"+e[0]+", minY: a"+e[1]+", maxX: a"+e[2]+", maxY: a"+e[3]+"};")}}},{quickselect:2}],2:[function(e,t,r){function i(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}t.exports=function e(t,r,o,n,a){for(;n>o;){if(n-o>600){var s=n-o+1,l=r-o+1,u=Math.log(s),c=.5*Math.exp(2*u/3),d=.5*Math.sqrt(u*c*(s-c)/s)*(l-s/2<0?-1:1),h=Math.max(o,Math.floor(r-l*c/s+d)),f=Math.min(n,Math.floor(r+(s-l)*c/s+d));e(t,r,h,f,a)}var g=t[r],p=o,m=n;for(i(t,o,r),a(t[n],g)>0&&i(t,o,n);p<m;){for(i(t,p,m),p++,m--;a(t[p],g)<0;)p++;for(;a(t[m],g)>0;)m--}0===a(t[o],g)?i(t,o,m):i(t,++m,n),m<=r&&(o=m+1),r<=m&&(n=m-1)}}},{}]},{},[1])(1)}),function(e){function t(){if(1==arguments.length){var e=arguments[0];this.header={idLength:r((n=e).idLength,0),colorMapType:r(n.colorMapType,0),imageType:r(n.imageType,t.Type.RGB),colorMapIndex:r(n.colorMapIndex,0),colorMapLength:r(n.colorMapLength,0),colorMapDepth:r(n.colorMapDepth,0),offsetX:r(n.offsetX,0),offsetY:r(n.offsetY,0),width:r(n.width,0),height:r(n.height,0),pixelDepth:r(n.pixelDepth,32),flags:r(n.flags,8)},i(this.header),o(this.header)}var n}function r(e,t){return void 0!==e?e:t}function i(e){e.hasEncoding=e.imageType===t.Type.RLE_INDEXED||e.imageType===t.Type.RLE_RGB||e.imageType===t.Type.RLE_GREY,e.hasColorMap=e.imageType===t.Type.RLE_INDEXED||e.imageType===t.Type.INDEXED,e.isGreyColor=e.imageType===t.Type.RLE_GREY||e.imageType===t.Type.GREY,e.bytePerPixel=e.pixelDepth>>3,e.origin=(e.flags&t.Origin.MASK)>>t.Origin.SHIFT,e.alphaBits=e.flags&t.Origin.ALPHA}function o(e){if(e.imageType===t.Type.NO_DATA)throw new Error("Targa::checkHeader() - No data");if(e.hasColorMap){if(e.colorMapLength>256||1!==e.colorMapType)throw new Error("Targa::checkHeader() - Unsupported colormap for indexed type");if(16!==e.colorMapDepth&&24!==e.colorMapDepth&&32!==e.colorMapDepth)throw new Error("Targa::checkHeader() - Unsupported colormap depth")}else if(e.colorMapType)throw new Error("Targa::checkHeader() - Why does the image contain a palette ?");if(e.width<=0||e.height<=0)throw new Error("Targa::checkHeader() - Invalid image size");if(8!==e.pixelDepth&&16!==e.pixelDepth&&24!==e.pixelDepth&&32!==e.pixelDepth)throw new Error('Targa::checkHeader() - Invalid pixel size "'+e.pixelDepth+'"');if(0!==e.alphaBits&&1!==e.alphaBits&&8!==e.alphaBits)throw new Error("Targa::checkHeader() - Unsuppported alpha size")}function n(e,t,r,i,o,n,a,s,l,u){var c,d,h,f,g,p,m=this.header.colorMapDepth>>3;for(f=0,p=o;p!==a;p+=n)for(g=s;g!==u;g+=l,f++)h=4*(g+i*p),d=t[f]*m,4===m?(e[h]=r[d+2],e[h+1]=r[d+1],e[h+2]=r[d],e[h+3]=r[d+3]):3===m?(e[h]=r[d+2],e[h+1]=r[d+1],e[h+2]=r[d],e[h+3]=255):2===m&&(c=r[d]|r[d+1]<<8,e[h]=(31744&c)>>7,e[h+1]=(992&c)>>2,e[h+2]=(31&c)<<3,e[h+3]=32768&c?0:255);return e}function a(e,t,r,i,o,n,a,s,l,u){var c,d,h,f,g;for(h=0,g=o;g!==a;g+=n)for(f=s;f!==u;f+=l,h+=2)c=t[h]|t[h+1]<<8,e[d=4*(f+i*g)]=(31744&c)>>7,e[d+1]=(992&c)>>2,e[d+2]=(31&c)<<3,e[d+3]=32768&c?0:255;return e}function s(e,t,r,i,o,n,a,s,l,u){var c,d,h,f,g=this.header.pixelDepth>>3;for(d=0,f=o;f!==a;f+=n)for(h=s;h!==u;h+=l,d+=g)e[(c=4*(h+i*f))+3]=255,e[c+2]=t[d],e[c+1]=t[d+1],e[c]=t[d+2];return e}function l(e,t,r,i,o,n,a,s,l,u){var c,d,h,f;for(c=0,h=o;h!==a;h+=n)for(d=s;d!==u;d+=l,c+=4)e[(f=4*(d+i*h))+2]=t[c],e[f+1]=t[c+1],e[f]=t[c+2],e[f+3]=t[c+3];return e}function u(e,t,r,i,o,n,a,s,l,u){var c,d,h,f,g;for(c=0,h=o;h!==a;h+=n)for(d=s;d!==u;d+=l,c+=4)f=4*(d+i*h),g=255*t[c+3],e[f+2]=t[c]/g,e[f+1]=t[c+1]/g,e[f]=t[c+2]/g,e[f+3]=t[c+3];return e}function c(e,t,r,i,o,n,a,s,l,u){var c,d,h,f,g;for(h=0,g=o;g!==a;g+=n)for(f=s;f!==u;f+=l,h++)c=t[h],e[d=4*(f+i*g)]=c,e[d+1]=c,e[d+2]=c,e[d+3]=255;return e}function d(e,t,r,i,o,n,a,s,l,u){var c,d,h,f,g;for(h=0,g=o;g!==a;g+=n)for(f=s;f!==u;f+=l,h+=2)c=t[h],e[d=4*(f+i*g)]=c,e[d+1]=c,e[d+2]=c,e[d+3]=t[h+1];return e}function h(e){var r=e.byteLength-t.FOOTER_SIZE,i=t.SIGNATURE,o={},n=new Uint8Array(e.buffer,r+8,i.length);return function(e){for(var r=t.SIGNATURE,i=0;i<r.length;i++)if(e.charCodeAt(i)!==r.charCodeAt(i))return!1;return!0}(String.fromCharCode.apply(null,n))?(o.hasFooter=!0,o.extensionOffset=e.getUint32(r,t.LITTLE_ENDIAN),o.developerOffset=e.getUint32(r+4,t.LITTLE_ENDIAN),o.hasExtensionArea=0!==o.extensionOffset,o.hasDeveloperArea=0!==o.developerOffset,o.extensionOffset&&(o.attributeType=e.getUint8(o.extensionOffset+494)),o):(o.hasFooter=!1,o)}t.Type={NO_DATA:0,INDEXED:1,RGB:2,GREY:3,RLE_INDEXED:9,RLE_RGB:10,RLE_GREY:11},t.Origin={BOTTOM_LEFT:0,BOTTOM_RIGHT:1,TOP_LEFT:2,TOP_RIGHT:3,SHIFT:4,MASK:48,ALPHA:8},t.HEADER_SIZE=18,t.FOOTER_SIZE=26,t.LITTLE_ENDIAN=!0,t.RLE_BIT=128,t.RLE_MASK=127,t.RLE_PACKET=1,t.RAW_PACKET=2,t.SIGNATURE="TRUEVISION-XFILE.\0",t.prototype.open=function(e,t){var r,i=this;(r=new XMLHttpRequest).open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===this.status&&(i.arrayBuffer=r.response,i.load(i.arrayBuffer),t&&t.call(i))},r.send(null)},t.prototype.load=function(e){var r=new DataView(e);this.headerData=new Uint8Array(e,0,t.HEADER_SIZE),this.header=function(e){var r=t.LITTLE_ENDIAN;if(e.byteLength<18)throw new Error("Targa::load() - Not enough data to contain header");var i={};return i.idLength=e.getUint8(0),i.colorMapType=e.getUint8(1),i.imageType=e.getUint8(2),i.colorMapIndex=e.getUint16(3,r),i.colorMapLength=e.getUint16(5,r),i.colorMapDepth=e.getUint8(7),i.offsetX=e.getUint16(8,r),i.offsetY=e.getUint16(10,r),i.width=e.getUint16(12,r),i.height=e.getUint16(14,r),i.pixelDepth=e.getUint8(16),i.flags=e.getUint8(17),i}(r),i(this.header),o(this.header);var n=t.HEADER_SIZE;if((n+=this.header.idLength)>=e.byteLength)throw new Error("Targa::load() - No data");if(this.header.hasColorMap){var a=this.header.colorMapLength*(this.header.colorMapDepth>>3);this.palette=new Uint8Array(e,n,a),n+=a}var s=this.header.pixelDepth>>3,l=this.header.width*this.header.height,u=l*s;if(this.header.hasEncoding){var c=e.byteLength-n-t.FOOTER_SIZE,d=new Uint8Array(e,n,c);this.imageData=function(e,r,i){var o,n,a,s,l,u,c;for(c=new Uint8Array(i),u=new Uint8Array(r),l=0,o=0;o<i;)if(a=1+((n=e[l++])&t.RLE_MASK),n&t.RLE_BIT){for(s=0;s<r;++s)u[s]=e[l++];for(s=0;s<a;++s)c.set(u,o),o+=r}else for(a*=r,s=0;s<a;++s)c[o++]=e[l++];if(o>i)throw new Error("Targa::decodeRLE() - Read bytes: "+o+" Expected bytes: "+i);return c}(d,s,u)}else this.imageData=new Uint8Array(e,n,this.header.hasColorMap?l:u);this.footer=h(r),(0!==this.header.alphaBits||this.footer.hasExtensionArea&&(3===this.footer.attributeType||4===this.footer.attributeType))&&(this.footer.usesAlpha=!0)},t.prototype.getImageData=function(e){var r,i,o,h,f,g,p,m=this.header.width,v=this.header.height,x=(this.header.flags&t.Origin.MASK)>>t.Origin.SHIFT;switch(e||(e=document?document.createElement("canvas").getContext("2d").createImageData(m,v):{width:m,height:v,data:new Uint8ClampedArray(m*v*4)}),x===t.Origin.TOP_LEFT||x===t.Origin.TOP_RIGHT?(h=0,f=1,g=v):(h=v-1,f=-1,g=-1),x===t.Origin.TOP_LEFT||x===t.Origin.BOTTOM_LEFT?(r=0,i=1,o=m):(r=m-1,i=-1,o=-1),this.header.pixelDepth){case 8:p=this.header.isGreyColor?c:n;break;case 16:p=this.header.isGreyColor?d:a;break;case 24:p=s;break;case 32:p=this.footer.hasExtensionArea?3===this.footer.attributeType?l:4===this.footer.attributeType?u:s:0!==this.header.alphaBits?l:s}return p.call(this,e.data,this.imageData,this.palette,m,h,f,g,r,i,o),e},t.prototype.setImageData=function(e){if(!e)throw new Error("Targa::setImageData() - imageData argument missing");var r,i,o,n,a,s,u=this.header.width,c=this.header.height,d=u*c*(this.header.pixelDepth>>3),h=(this.header.flags&t.Origin.MASK)>>t.Origin.SHIFT;h===t.Origin.TOP_LEFT||h===t.Origin.TOP_RIGHT?(n=0,a=1,s=c):(n=c-1,a=-1,s=-1),h===t.Origin.TOP_LEFT||h===t.Origin.BOTTOM_LEFT?(r=0,i=1,o=u):(r=u-1,i=-1,o=-1),this.imageData||(this.imageData=new Uint8Array(d)),l(this.imageData,e.data,this.palette,u,n,a,s,r,i,o);var f=this.imageData;this.header.hasEncoding&&(f=function(e,r){for(var i,o,n,a,s=r,l=[],u=0,c=e.pixelDepth>>3,d=0,h=e.width*e.height*c,f=function(e,t){for(var r=0;r<c;r++)if(s[e*c+r]!==s[t*c+r])return!1;return!0},g=function(e){return f(e,e+1)?t.RLE_PACKET:t.RAW_PACKET};u*c<s.length&&u*c<h;){if(n=0,(o=g(u))===t.RLE_PACKET)for(;u+n<s.length&&n<128&&f(u,u+n);)n++;else for(;u+n<s.length&&n<128&&g(u+n)===t.RAW_PACKET;)n++;if(a=n-1,o===t.RLE_PACKET&&(a|=t.RLE_BIT),l[d++]=a,o===t.RLE_PACKET){for(i=0;i<c;i++)l[i+d]=s[i+u*c];d+=c}else{for(i=0;i<c*n;i++)l[i+d]=s[i+u*c];d+=c*n}u+=n}return new Uint8Array(l)}(this.header,f));var g=t.HEADER_SIZE+f.length+t.FOOTER_SIZE,p=new ArrayBuffer(g);this.arrayBuffer=p,this.headerData=new Uint8Array(p,0,t.HEADER_SIZE),this.RLEData=new Uint8Array(p,t.HEADER_SIZE,f.length),this.footerData=new Uint8Array(p,t.HEADER_SIZE+f.length,t.FOOTER_SIZE);var m,v,x,_=new DataView(this.headerData.buffer);m=this.header,v=_,x=t.LITTLE_ENDIAN,v.setUint8(0,m.idLength),v.setUint8(1,m.colorMapType),v.setUint8(2,m.imageType),v.setUint16(3,m.colorMapIndex,x),v.setUint16(5,m.colorMapLength,x),v.setUint8(7,m.colorMapDepth),v.setUint16(8,m.offsetX,x),v.setUint16(10,m.offsetY,x),v.setUint16(12,m.width,x),v.setUint16(14,m.height,x),v.setUint8(16,m.pixelDepth),v.setUint8(17,m.flags),this.RLEData.set(f),function(e){for(var r=t.SIGNATURE,i=e.byteLength-r.length,o=0;o<r.length;o++)e[i+o]=r.charCodeAt(o)}(this.footerData)},t.prototype.getCanvas=function(){var e,t,r;return r=(t=(e=document.createElement("canvas")).getContext("2d")).createImageData(this.header.width,this.header.height),e.width=this.header.width,e.height=this.header.height,t.putImageData(this.getImageData(r),0,0),e},t.prototype.getDataURL=function(e){return this.getCanvas().toDataURL(e||"image/png")},t.prototype.getBlobURL=function(){if(!this.arrayBuffer)throw new Error("Targa::getBlobURL() - No data available for blob");var e=new Blob([this.arrayBuffer],{type:"image/x-tga"});return URL.createObjectURL(e)};var f={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?define(function(){return t}):f.exports="undefined"!=typeof window?window:e:f.exports=exports,f.exports&&(f.exports.TGA=t)}(this);var Mago3D=function(){var e=function(){this._events={}};e.prototype.on=function(e,t,r){return this._events[e]||(this._events[e]=[]),this._events[e].push({fn:t,once:r}),this},e.prototype.once=function(e,t){return this.on(e,t,!0)},e.prototype.emit=function(e){var t=this._events[e],r=[];if(t){for(var i=arguments.length,o=Array(i>1?i-1:0),n=1;n<i;n++)o[n-1]=arguments[n];for(var a=0,s=s=t;;){if(a>=s.length)break;var l=s[a++];l.fn&&"function"==typeof l.fn&&l.fn.apply(this,o),l.once&&r.push(a-1)}}if(r.length>0&&Array.isArray(t))for(var u=r.length-1;u>=0;u--)t.splice(r[u],1);return this},e.prototype.off=function(e,t){if(!this._events||0===arguments.length)return this._events={},this;var r=this._events[e];if(!r)return this;if(1===arguments.length)return delete this._events[e],this;for(var i=0;i<r.length;i++){if(r[i].fn===t){r.splice(i,1);break}}return this};var t=function t(){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);e.call(this),this.manager,this.active=!1,this.stop=!1};(t.prototype=Object.create(e.prototype)).constructor=t,t.prototype.setActive=function(e){return ln()},t.prototype.getActive=function(){return this.active},t.prototype.setStop=function(e){this.stop=e},t.prototype.getStop=function(){return this.stop},t.prototype.start=function(){return ln()},t.prototype.init=function(){return ln()},t.prototype.clear=function(){return ln()},t.prototype.handle=function(e){return ln()};var r=function e(t){this.objectsArray=[],this._guid=qo(),this.id,this.name,this.owner,this.attributes={isVisible:!0,isDeletableByFrustumCulling:!1},this.tMat,this.tMatOriginal,this.geoLocDataManager,this.dirty=!0,this.color4=new J(1,1,1,1),this.orgColor4=new J(1,1,1,1),this.wireframeColor4,this.selectedColor4,this.objectType=e.OBJECT_TYPE.MESH,this.terrainHeight=0,this.eventObject={},this.fromDate=new Date,this.toDate=new Date,this.options=t,void 0!==t&&(t.color&&t.color instanceof J&&(this.color4=Zo(t.color,new J(1,1,1,1)),this.orgColor4=new J(this.color4.r,this.color4.g,this.color4.b,this.color4.a),this.color4.a<1?this.setOpaque(!1):this.setOpaque(!0)),t.wireframeColor4&&t.wireframeColor4 instanceof J&&(this.wireframeColor4=t.wireframeColor4))};r.EVENT_TYPE={RENDER_END:"renderEnd",RENDER_START:"renderStart",MOVE_END:"moveEnd",MOVE_START:"moveStart"},r.OBJECT_TYPE={MESH:0,VECTORMESH:1,POINTMESH:2,LIGHTSOURCE:3},Object.defineProperties(r.prototype,{guid:{get:function(){return this._guid}}}),r.prototype.addEventListener=function(e){if(!e instanceof Re)throw new Error("args event must MagoEvent!");var t=e.getType();if(!r.EVENT_TYPE[t])throw new Error("this type is not support.");this.eventObject[t]||(this.eventObject[t]=[]),this.eventObject[t].push(e)},r.prototype.dispatchEvent=function(e,t){if(!r.EVENT_TYPE[e])throw new Error("this type is not support.");var i=this.eventObject[e];if(i&&Array.isArray(i))for(var o=0,n=i.length;o<n;o++){var a=i[o].getListener();"function"==typeof a&&a.apply(this,[this,t])}},r.prototype.init=function(e){var t=e.vboMemoryManager;this.deleteObjects(t),this instanceof Br&&(this.knotGeoCoordsArray.length=0),this.setDirty(!0)},r.prototype.deleteObjects=function(e){if(this.texture&&this.texture.deleteObjects(e.gl),this.objectsArray){for(var t=this.objectsArray.length,r=0;r<t;r++)this.objectsArray[r].deleteObjects(e),this.objectsArray[r]=void 0;delete this.objectsArray}delete this._guid,delete this.id,delete this.name,this.owner=void 0,delete this.attributes,this.tMat&&(this.tMat.deleteObjects(),this.tMat=void 0),this.tMatOriginal&&(this.tMatOriginal.deleteObjects(),this.tMatOriginal=void 0),this.geoLocDataManager&&(this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0),delete this.dirty,this.color4&&(this.color4.deleteObjects(),this.color4=void 0),this.orgColor4&&(this.orgColor4.deleteObjects(),this.orgColor4=void 0),this.wireframeColor4&&(this.wireframeColor4.deleteObjects(),delete this.wireframeColor4),this.selectedColor4&&(this.selectedColor4.deleteObjects(),this.selectedColor4=void 0),delete this.objectType,delete this.terrainHeight,delete this.eventObject,delete this.fromDate,delete this.toDate,delete this.options},r.prototype.getRootOwner=function(){return void 0===this.owner?this:this.owner.getRootOwner()},r.prototype.getObject=function(e){if(e>this.objectsArray.length-1)throw new Error("out of bound range.");return this.objectsArray[e]},r.prototype.render=function(e,t,r,i,o){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(e),!this.objectsArray||0===this.objectsArray.length)return!1;var n=e.getGl();void 0!==this.attributes.opacity&&n.uniform1f(t.externalAlpha_loc,this.attributes.opacity),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,t),this.attributes.doubleFace?n.disable(n.CULL_FACE):n.enable(n.CULL_FACE);var a,s=!1;if(2!==r&&e.currentProcess!==I.magoCurrentProcess.StencilSilhouetteRendering&&(s=e.effectsManager.executeEffects(this.guid,e)),1===r)if(this.options&&this.options.limitationGeographicCoords)this.options.limitationHeights?(n.uniform2fv(t.limitationHeights_loc,this.options.limitationHeights),n.uniform1i(t.clippingType_loc,4)):n.uniform1i(t.clippingType_loc,2),n.uniform2fv(t.clippingPolygon2dPoints_loc,this.uniformPoints2dArray),n.uniform1iv(t.clippingConvexPolygon2dPointsIndices_loc,this.uniformPolygonPointsIdx),(a=this.options.limitationInfringingDynamicColor4)?(a instanceof re&&a.updateColorAlarm(e.getCurrentTime()),n.uniform4fv(t.limitationInfringedColor4_loc,new Float32Array([a.r,a.g,a.b,a.a]))):n.uniform4fv(t.limitationInfringedColor4_loc,new Float32Array([1,.5,.2,1]));else if(this.options&&this.options.limitationHeights)n.uniform2fv(t.limitationHeights_loc,this.options.limitationHeights),n.uniform1i(t.clippingType_loc,3),(a=this.options.limitationInfringingDynamicColor4)?(a instanceof re&&a.updateColorAlarm(e.getCurrentTime()),n.uniform4fv(t.limitationInfringedColor4_loc,new Float32Array([a.r,a.g,a.b,a.a]))):n.uniform4fv(t.limitationInfringedColor4_loc,new Float32Array([1,.5,.2,1]));else n.uniform1i(t.clippingType_loc,0);var l=!0;if(this.options&&!1===this.options.renderShaded&&(l=!1),n.uniform1i(t.bApplySpecularLighting_loc,!1),l&&this.renderAsChild(e,t,r,i,o,this.options),n.uniform1f(t.externalAlpha_loc,1),n.uniform1i(t.bApplySpecularLighting_loc,!1),n.uniform1i(t.clippingType_loc,0),s&&(n.uniform3fv(t.aditionalOffset_loc,[0,0,0]),n.uniform3fv(t.scaleLC_loc,[1,1,1]),1===r&&n.uniform4fv(t.colorMultiplier_loc,[1,1,1,1])),this.options){o=!1;if(e.selectionManager.isObjectSelected(this)&&(o=!0),o||this.options.renderWireframe){var u=e.postFxShadersManager.getShader("thickLine");e.postFxShadersManager.useProgram(u),u.bindUniformGenerals(),(n=e.getGl()).uniform1i(u.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),n.uniform1i(u.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),n.uniform1i(u.uFrustumIdx_loc,e.currentFrustumIdx),n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA),n.disable(n.CULL_FACE),n.enableVertexAttribArray(u.prev_loc),n.enableVertexAttribArray(u.current_loc),n.enableVertexAttribArray(u.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,u);var c=e.sceneState,d=new Float32Array([c.drawingBufferWidth[0]]),h=new Float32Array([c.drawingBufferHeight[0]]);this.wireframeColor4?n.uniform4fv(u.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):n.uniform4fv(u.oneColor4_loc,[.6,.8,.9,1]),n.uniform2fv(u.viewport_loc,new Float32Array([d[0],h[0]]));this.renderAsChild(e,u,r,i,o,this.options,!0),n.enable(n.CULL_FACE),e.postFxShadersManager.useProgram(t)}}n.enable(n.CULL_FACE)}},r.prototype.renderAsChild=function(e,t,r,i,o,n,a){if(this.dirty)return this.makeMesh(e),!1;var s=e.getGl();if(0===r);else if(1===r){if(s.uniform1i(t.colorType_loc,0),e.selectionManager.isObjectSelected(this)&&(o=!0),o){var l=[.9,.1,.1,1];if(a)l=[.6,.6,.99,1];else if(this.attributes.selectedColor4){var u=this.attributes.selectedColor4;l=[u.r,u.g,u.b,u.a]}s.uniform4fv(t.oneColor4_loc,l)}else a?this.wireframeColor4&&s.uniform4fv(t.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):this.color4&&s.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]);if(e.isCameraMoved&&!this.mouseLeftDown&&!this.mouseMiddleDown){var c=!1;if(void 0===this.attributes.isSelectable&&(c=!0),this.attributes.isSelectable&&!0===this.attributes.isSelectable&&(c=!0),c){var d=e.selectionColor,h=d.getAvailableColor(void 0),f=d.decodeColor3(h.r,h.g,h.b);e.selectionManager.setCandidateGeneral(f,this),s.uniform4fv(t.uSelColor4_loc,[h.r/255,h.g/255,h.b/255,1])}}}this.tMat&&s.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,this.tMat._floatArrays);for(var g=!0,p=this.objectsArray.length,m=0;m<p;m++){var v=this.objectsArray[m];if(v instanceof _o||v instanceof xo){var x;if(0===r)continue;if(1===r){var _="thickLine";v instanceof xo&&(_="thickLineExtruded"),x=e.postFxShadersManager.getShader(_)}e.postFxShadersManager.useProgram(x),x.bindUniformGenerals(),(s=e.getGl()).uniform1i(x.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),s.uniform1i(x.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),s.uniform1i(x.uFrustumIdx_loc,e.currentFrustumIdx),s.blendEquationSeparate(s.FUNC_ADD,s.FUNC_ADD),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),s.disable(s.CULL_FACE),s.enableVertexAttribArray(x.prev_loc),s.enableVertexAttribArray(x.current_loc),s.enableVertexAttribArray(x.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(s,x);var y=e.sceneState,T=y.drawingBufferWidth,C=y.drawingBufferHeight;this.wireframeColor4?s.uniform4fv(x.oneColor4_loc,[this.wireframeColor4.r,this.wireframeColor4.g,this.wireframeColor4.b,this.wireframeColor4.a]):s.uniform4fv(x.oneColor4_loc,[.2,.4,.9,1]),s.uniform2fv(x.viewport_loc,[T[0],C[0]]),v.renderAsChild(e,x,r,i,o,n,a)||(g=!1),e.postFxShadersManager.useProgram(t)}else if(v instanceof co){var b;0===r?b=e.postFxShadersManager.getShader("pointsCloudSsao"):1===r&&(b=e.postFxShadersManager.getShader("pointsCloudSsao")),e.postFxShadersManager.useProgram(b),b.disableVertexAttribArrayAll(),b.resetLastBuffersBinded(),b.enableVertexAttribArray(b.position3_loc),b.bindUniformGenerals(),this.geoLocDataManager.getCurrentGeoLocationData().bindSplitedPositionUniforms(s,b),s.uniform1i(b.bPositionCompressed_loc,!1),s.uniform1i(b.bUse1Color_loc,!0),s.uniform1i(b.bUseFixPointSize_loc,1),s.uniform1i(b.uStrokeSize_loc,this.style.strokeSize),s.uniform1i(b.uFrustumIdx_loc,e.currentFrustumIdx),s.depthRange(0,0),v.renderAsChild(e,b,r,i,o,n,a)||(g=!1),s.depthRange(0,1),e.postFxShadersManager.useProgram(t)}else v.renderAsChild(e,t,r,i,o,n,a)||(g=!1)}return s.depthRange(0,1),s.enable(s.CULL_FACE),this.dispatchEvent("RENDER_END",e),g},r.prototype.makeMesh=function(e){return ln()},r.prototype.moved=function(){this.boundingSphereWC=void 0},r.prototype.updateMatrix=function(e){if(e)this.tMat=this.tMatOriginal.getMultipliedByMatrix(e,this.tMat);else{if(void 0===this.geoLocDataManager||null===this.geoLocDataManager)return;var t=this.geoLocDataManager.getCurrentGeoLocationData();this.tMat=t.rotMatrix}if(void 0!==this.objectsArray)for(var i=0,o=this.objectsArray.length;i<o;++i){this.objectsArray[i]instanceof r&&this.objectsArray[i].updateMatrix(this.tMat)}},r.prototype.setDeleted=function(e){this.attributes._deleted=e},r.prototype.setDirty=function(e){this.dirty=e,this.dirty&&(this.vboFromWorker=!1)},r.prototype.setOneColor=function(e,t,r,i){void 0===this.color4&&(this.color4=new J),this.color4.setRGBA(e,t,r,i),i<1?this.setOpaque(!1):this.setOpaque(!0)},r.prototype.setSelectedColor4=function(e,t,r,i){void 0===this.attributes.selectedColor4&&(this.attributes.selectedColor4=new J),this.attributes.selectedColor4.setRGBA(e,t,r,i)},r.prototype.restoreColor=function(){this.setOneColor(this.orgColor4.r,this.orgColor4.g,this.orgColor4.b,this.orgColor4.a),this.orgColor4.a<1?this.setOpaque(!1):this.setOpaque(!0)},r.prototype.setWireframeColor=function(e,t,r,i){void 0===this.wireframeColor4&&(this.wireframeColor4=new J),this.wireframeColor4.setRGBA(e,t,r,i)},r.prototype.setOpaque=function(e){this.attributes.opaque=e},r.prototype.isOpaque=function(){return void 0===this.attributes.opaque||this.attributes.opaque},r.prototype.setObjectType=function(e){this.objectType=e},r.prototype.getGeoLocDataManager=function(){return this.geoLocDataManager},r.prototype.getCurrentGeoLocationData=function(){if(!this.geoLocDataManager)throw new Error("this data is not ready to use.");return this.getGeoLocDataManager().getCurrentGeoLocationData()},r.prototype.getBoundingBoxLC=function(){if(!this.bboxLC){var e=this.objectsArray.length;this.bboxLC=new G;for(var t=!1,r=0;r<e;r++){var i=this.objectsArray[r].bbox;i&&(t?this.bboxLC.addBox(i):(this.bboxLC.copyFrom(i),t=!0))}}return this.bboxLC},r.prototype.getBoundingSphereWC=function(e){if(!this.boundingSphereWC){var t=this.objectsArray.length;this.boundingSphereWC=new z;for(var r=!1,i=0;i<t;i++){var o=this.objectsArray[i].boundingSphereWC;o&&(r?this.boundingSphereWC.addBSphere(o):(this.boundingSphereWC.copyFrom(o),r=!0))}if(0===this.boundingSphereWC.r){var n=this.getCurrentGeoLocationData().position;this.boundingSphereWC.setCenterPoint(n.x,n.y,n.z),this.boundingSphereWC.setRadius(2e3)}}e||(e=new z);var a=this.boundingSphereWC.centerPoint;return e.setCenterPoint(a.x,a.y,a.z),e.setRadius(this.boundingSphereWC.r),e},r.prototype.changeLocationAndRotation=function(e,t,r,i,o,n,a){var s=this.getCurrentGeoLocationData();on.calculateGeoLocationData(t,e,r,i,o,n,s,a),this.moved()},r.prototype.setGeographicPosition=function(e,t,r,i){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var o=this.geoLocDataManager.getCurrentGeoLocationData();void 0===o&&(o=this.geoLocDataManager.newGeoLocationData("default")),t=void 0===t||null===t?0:t,r=void 0===r||null===r?0:r,i=void 0===i||null===i?0:i,o=on.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,t,r,i,o)},r.prototype.intersectionWithPolygon2D=function(e){var t=!1;if(this.geographicCoordList)t=o(e,this.geographicCoordList.geographicCoordsArray);else if(this.geographicCoordListsArray)for(var r=0,i=this.geographicCoordListsArray.length;r<i;r++)if(o(e,this.geographicCoordListsArray[r].geographicCoordsArray)){t=!0;break}return t;function o(e,t){return e.intersectionWithPolygon2D($r.makePolygonByGeographicCoordArray(t))}},r.prototype.setTerrainHeight=function(e){void 0!==e&&null!==e||(e=0),this.terrainHeight=e,this.validTerrainHeight()},r.prototype.validTerrainHeight=function(){var e=this.geoLocDataManager.getCurrentGeoLocationData(),t=this.terrainHeight;this.relativeHeight&&!isNaN(this.relativeHeight)&&(t+=this.relativeHeight),e=on.calculateGeoLocationData(void 0,void 0,t,void 0,void 0,void 0,e)},r.prototype.isNeedValidHeight=function(e){return!!(e.isCesiumGlobe()&&this.attributes&&this.attributes.heightReference&&this.attributes.heightReference!==Ce.NONE)},r.prototype.setFromDate=function(e){if(!(e&&e instanceof Date))throw new Error("fromDate is required(Date Type).");this.fromDate=e},r.prototype.getFromDate=function(){return this.fromDate},r.prototype.setToDate=function(e){if(!(e&&e instanceof Date))throw new Error("toDate is required(Date Type).");this.toDate=e},r.prototype.getToDate=function(){return this.toDate},r.newCylinder=function(e){if(void 0!==e){var t=50,r=120;void 0!==e.radius&&(t=e.radius),void 0!==e.height&&(r=e.height);var i=e.geographicCoord.longitude,o=e.geographicCoord.latitude,n=e.geographicCoord.altitude,a=0,s=0,l=0;void 0!==e.heading&&(a=e.heading),void 0!==e.pitch&&(s=e.pitch),void 0!==e.roll&&(l=e.roll);var u=new Mago3D.Cylinder(t,r,{});u.geoLocDataManager=new ye;var c=u.geoLocDataManager.newGeoLocationData();on.calculateGeoLocationData(i,o,n,a,s,l,c),u.boundingSphereWC=new z;var d=c.position,h=r;return u.boundingSphereWC.setCenterPoint(d.x,d.y,d.z),u.boundingSphereWC.setRadius(h),e.color4&&u.setOneColor(e.color4.r,e.color4.g,e.color4.b,e.color4.a),u}};var i=function(e,t){if(!e||!document.getElementById(e))throw console.error("[MagoJs] containerId is required."),new Error("[MagoJs] containerId is required.");var r=new O;r.init(t,null,null),this.config=r,this.targetId=e,this.magoManager=void 0,this.viewer=void 0,this.policy=r.getPolicy(),r.setContainerId(this.targetId),this.init()};i.prototype.init=function(){return ln()},i.prototype.initMagoManager=function(){return ln()},i.prototype.setEventHandler=function(){return ln()},i.prototype.initPosition=function(){if(this.policy.initCameraEnable){var e=parseFloat(this.policy.initLongitude),t=parseFloat(this.policy.initLatitude),r=parseFloat(this.policy.initAltitude),i=parseInt(this.policy.initDuration);if(isNaN(e)||isNaN(t)||isNaN(r))throw new Error("Longitude, Latitude, Height must number type.");isNaN(i)&&(i=0),this.magoManager.flyTo(e,t,r,i)}};var o={changeColor:function(e,t){var r=e.getProjectId(),i=e.getDataKey(),o=e.getObjectIds(),n=e.getProperty(),a=null,s=null;if(null!==n&&""!==n){var l=n.split("=");a=l[0],s=l[1]}var u=e.getColor();if(void 0!==u&&0!==u){var c=e.getColor().split(","),d=1;4===c.length&&(d=c[3]/255);var h=[c[0]/255,c[1]/255,c[2]/255,d],f=!1;null!==o&&0!==o.length&&(f=!0);var g=[];if(f)for(var p=0,m=o.length;p<m;p++){var v;(v=new P).setProjectId(r),v.setDataKey(i),v.setObjectId(o[p]),v.setProperty(n),v.setPropertyKey(a),v.setPropertyValue(s),v.setColor(h),g.push(v)}else(v=new P).setProjectId(r),v.setDataKey(i),v.setObjectId(null),v.setProperty(n),v.setPropertyKey(a),v.setPropertyValue(s),v.setColor(h),g.push(v);var x=g.length;for(p=0;p<x;p++)v=g[p],t.config.saveColorHistory(r,i,v.getObjectId(),v)}}},n={drawAppendData:function(e,t){t.getObjectIndexFile(e.getProjectId(),e.getProjectDataFolder())},drawInsertIssueImage:function(e,t){void 0!==t.objMarkerSC&&0!==e.getDrawType()||(t.objMarkerSC=new He,t.objMarkerSC.geoLocationData.geographicCoord=new pe,on.calculateGeoLocationData(parseFloat(e.getLongitude()),parseFloat(e.getLatitude()),parseFloat(e.getElevation()),void 0,void 0,void 0,t.objMarkerSC.geoLocationData,t));var r=t.objMarkerManager.newObjectMarker({imageFilePath:"defaultRed",sizeX:64,sizeY:64});t.objMarkerSC.issue_id=e.getIssueId(),t.objMarkerSC.issue_type=e.getIssueType(),t.objMarkerSC.geoLocationData.geographicCoord.setLonLatAlt(parseFloat(e.getLongitude()),parseFloat(e.getLatitude()),parseFloat(e.getElevation())),r.copyFrom(t.objMarkerSC),t.objMarkerSC=void 0}},a={changeLocationAndRotation:function(e,t){var r=new P;r.setProjectId(e.getProjectId()),r.setDataKey(e.getDataKey()),r.setLatitude(parseFloat(e.getLatitude())),r.setLongitude(parseFloat(e.getLongitude())),r.setElevation(parseFloat(e.getElevation())),r.setHeading(parseFloat(e.getHeading())),r.setPitch(parseFloat(e.getPitch())),r.setRoll(parseFloat(e.getRoll()));var i=e.getLatitude(),o=e.getLongitude(),n=e.getElevation(),a=e.getHeading(),s=e.getPitch(),l=e.getRoll();t.changeLocationAndRotation(e.getProjectId(),e.getDataKey(),i,o,n,a,s,l,e.getAnimationOption())}},s={changeLod:function(e,t){null!==e.getLod0DistInMeters()&&""!==e.getLod0DistInMeters()&&t.magoPolicy.setLod0DistInMeters(e.getLod0DistInMeters()),null!==e.getLod1DistInMeters()&&""!==e.getLod1DistInMeters()&&t.magoPolicy.setLod1DistInMeters(e.getLod1DistInMeters()),null!==e.getLod2DistInMeters()&&""!==e.getLod2DistInMeters()&&t.magoPolicy.setLod2DistInMeters(e.getLod2DistInMeters()),null!==e.getLod3DistInMeters()&&""!==e.getLod3DistInMeters()&&t.magoPolicy.setLod3DistInMeters(e.getLod3DistInMeters()),null!==e.getLod4DistInMeters()&&""!==e.getLod4DistInMeters()&&t.magoPolicy.setLod4DistInMeters(e.getLod4DistInMeters()),null!==e.getLod5DistInMeters()&&""!==e.getLod5DistInMeters()&&t.magoPolicy.setLod5DistInMeters(e.getLod5DistInMeters())}},l=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._fileLoadState=I.fileLoadState.READY,this._filePath,this._jsonFile,this._isPrepared=!1,this._texture=void 0,this._glTexture,this.owner=void 0,this._texture3dCreated=!1,this._texture3d,this._mosaicTexture,this._mosaicTexFilePath,this._startUnixTimeMiliseconds,this._endUnixTimeMiliseconds,void 0!==t&&(t.filePath&&(this._filePath=t.filePath),t.owner&&(this.owner=t.owner),t.mosaicTexFilePath&&(this._mosaicTexFilePath=t.mosaicTexFilePath),void 0!==t.startUnixTimeMiliseconds&&(this._startUnixTimeMiliseconds=t.startUnixTimeMiliseconds),void 0!==t.endUnixTimeMiliseconds&&(this._endUnixTimeMiliseconds=t.endUnixTimeMiliseconds))};l.prototype._prepare=function(){if(this._isPrepared)return!0;if(void 0===this._texture&&(this._texture=new it,this._texture.fileLoadState=I.fileLoadState.READY),this._texture.fileLoadState===I.fileLoadState.READY){this._texture.fileLoadState=I.fileLoadState.LOADING_STARTED;at.loadTexture(this._mosaicTexFilePath,this._texture,this.owner.airPollutionManager.magoManager,!1)}return this._texture.fileLoadState===I.fileLoadState.BINDING_FINISHED&&(void 0===this.uMinMaxAltitudeSlices&&(this.uMinMaxAltitudeSlices=new Float32Array(64),this.uMinMaxAltitudeSlices[0]=0,this.uMinMaxAltitudeSlices[1]=10,this.uMinMaxAltitudeSlices[2]=10,this.uMinMaxAltitudeSlices[3]=20,this.uMinMaxAltitudeSlices[4]=20,this.uMinMaxAltitudeSlices[5]=30,this.uMinMaxAltitudeSlices[6]=30,this.uMinMaxAltitudeSlices[7]=60,this.uMinMaxAltitudeSlices[8]=60,this.uMinMaxAltitudeSlices[9]=100,this.uMinMaxAltitudeSlices[10]=100,this.uMinMaxAltitudeSlices[11]=200,this.uMinMaxAltitudeSlices[12]=200,this.uMinMaxAltitudeSlices[13]=400),this._isPrepared=!0,this._isPrepared)},l.prototype._makeTextures=function(e,t){if(!this._texture3dCreated){this._texture3d=new Do,this._mosaicTexture=new Do,this._mosaicTexture.texturesArray.push(this._texture.texId),this._texture.texId=void 0,this._mosaicTexture.fileLoadState=I.fileLoadState.BINDING_FINISHED;var r=this.owner.airPollutionManager._geoJsonIndexFile,i=r.layers[0].textureWidth,o=r.layers[0].textureHeight,n=r.mosaicColumnsCount,a=r.mosaicRowsCount;this._texture3d.texture3DXSize=i,this._texture3d.texture3DYSize=o,this._texture3d.texture3DZSize=7,this._mosaicTexture.mosaicXCount=n,this._mosaicTexture.mosaicYCount=a,this._mosaicTexture.texture3DXSize=i,this._mosaicTexture.texture3DYSize=o,this._mosaicTexture.texture3DZSize=7,this._mosaicTexture.finalTextureXSize=this._mosaicTexture.mosaicXCount*this._texture3d.texture3DXSize,this._mosaicTexture.finalTextureYSize=this._mosaicTexture.mosaicYCount*this._texture3d.texture3DYSize,this._texture3dCreated=!0}return this._texture3dCreated};var u=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.airPollutionManager=void 0,this.geographicExtent,this._geoJsonIndexFileLoadState=I.fileLoadState.READY,this._geoJsonIndexFile,this._geoJsonIndexFilePath,this._geoJsonIndexFileFolderPath,this._allLayersArePrepared=!1,this._animationState=I.processState.NO_STARTED,this._animationStartTime=0,this._totalAnimTime,this._increTime,this.timeSeries,this._timeSlicesArray,this._isPrepared=!1,this.simulationBox=void 0,this.vboKeysContainer,this.volumeDepthFBO=void 0,this.screenFBO=void 0,t&&(t.airPollutionManager&&(this.airPollutionManager=t.airPollutionManager),t.timeSeries&&(this.timeSeries=t.timeSeries),void 0!==t.altitude&&(this.altitude=t.altitude),void 0!==t.timeInterval_min&&(this.timeInterval_min=t.timeInterval_min),void 0!==t.timeSlicesCount&&(this.timeSlicesCount=t.timeSlicesCount),void 0!==t.timeSliceFileNames&&(this.timeSliceFileNames=t.timeSliceFileNames),void 0!==t.timeSliceFileFolderPath&&(this.timeSliceFileFolderPath=t.timeSliceFileFolderPath))};u.prototype._makeTextures=function(e,t){for(var r=!0,i=this._timeSlicesArray.length,o=0;o<i;o++){this._timeSlicesArray[o]._makeTextures(e,t)||(r=!1)}return r},u.prototype._makeSimulationBox=function(){this.airPollutionManager.magoManager;var e=this.airPollutionManager._geoJsonIndexFile,t=(e.centerGeographicCoord,1e3*e.width_km/2),r=1e3*e.height_km/2,i=[],o=new Kr(-t,-r);i.push(o),o=new Kr(t,-r),i.push(o),o=new Kr(t,r),i.push(o),o=new Kr(-t,r),i.push(o);var n=ii.fromPoint2DArray(i),a=this._timeSlicesArray[0];this.oneVoxelSizeInMeters[2],a._texture3d.texture3DZSize;var s=jr.getExtrudedMesh(n,200,1,void 0,void 0,void 0,void 0);this.simulationBox||(this.simulationBox=new ho),this.simulationBox.geoLocDataManager=new ye;var l=this.simulationBox.geoLocDataManager.newGeoLocationData(),u=this.geoLocDataManager.getCurrentGeoLocationData();l.copyFrom(u),this.simulationBox.objectsArray.push(s)},u.prototype._getScreenFBO=function(e){if(!this.screenFBO){var t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.screenFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.screenFBO},u.prototype._getVolumeDepthFBO=function(){if(!this.volumeDepthFBO){var e=this.airPollutionManager.magoManager,t=e.getGl(),r=e.sceneState,i=2*r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.volumeDepthFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeDepthFBO},u.prototype._renderDepthVolume=function(){var e=this.airPollutionManager.magoManager,t=(e.sceneState,e.getGl()),r=e.extbuffers;this.visibleObjControler||(this.visibleObjControler=new _t),this.simulationBox&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.simulationBox);var i=this._getVolumeDepthFBO(e);this.simulBoxdoubleDepthTex=i.colorBuffersArray[1],this.simulBoxDoubleNormalTex=i.colorBuffersArray[2],i.bind(),t.viewport(0,0,i.width[0]/2,i.height[0]),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,0),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT),t.clearColor(0,0,0,1)),t.clear(t.DEPTH_BUFFER_BIT);var o=1;t.frontFace(t.CCW),e.renderer.renderGeometryBuffer(t,o,this.visibleObjControler),t.viewport(i.width[0]/2,0,i.width[0]/2,i.height[0]);o=1;t.frontFace(t.CW),e.renderer.renderGeometryBuffer(t,o,this.visibleObjControler),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,null,0),i.unbind(),t.frontFace(t.CCW)},u.prototype.getTimeSliceIdxByCurrentUnixTimeMiliseconds=function(e){for(var t=this._timeSlicesArray.length,r=-1,i=0;i<t;i++){var o=this._timeSlicesArray[i];if(e>=o._startUnixTimeMiliseconds&&e<=o._endUnixTimeMiliseconds){r=i;break}}return r},u.prototype.render=function(){void 0===this.simulationBox&&this._makeSimulationBox();var e=this.airPollutionManager.magoManager,t=e.animationTimeController,r=e.getGl(),i=this.getTimeSliceIdxByCurrentUnixTimeMiliseconds(t._currentUnixTimeMilisec),o=i+1;o>=this._timeSlicesArray.length&&(o=i),i>this._timeSlicesArray.length-1?i=this._timeSlicesArray.length-1:i<0&&(i=0),this.testCurrIdx=i,this._renderDepthVolume();var n=this.airPollutionManager,a=e.sceneState,s=(r=e.getGl(),this._getScreenFBO(e)),l=s.extbuffers;this.volumRenderTex=s.colorBuffersArray[0],s.bind(),r.viewport(0,0,s.width[0],s.height[0]);var u=n.getQuadBuffer(),c=e.postFxShadersManager.getShader("volumetricAirPollution");e.postFxShadersManager.useProgram(c),r.framebufferTexture2D(r.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,s.colorBuffersArray[0],0),r.framebufferTexture2D(r.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,s.colorBuffersArray[1],0),r.framebufferTexture2D(r.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,s.colorBuffersArray[2],0),r.framebufferTexture2D(r.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,s.colorBuffersArray[3],0),this.volumRenderTex=s.colorBuffersArray[0],l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.COLOR_ATTACHMENT1_WEBGL,l.COLOR_ATTACHMENT2_WEBGL,l.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(r.clearColor(0,0,0,0),r.clearDepth(1),r.clear(r.COLOR_BUFFER_BIT),r.clearColor(0,0,0,1)),r.clear(r.DEPTH_BUFFER_BIT),ae.bindAttribute(r,u.posBuffer,c.a_pos_loc,2),r.disable(r.BLEND),r.enable(r.DEPTH_TEST);var d=(v=this._timeSlicesArray[this.testCurrIdx])._mosaicTexture;c.bindUniformGenerals();u=n.getQuadBuffer();ae.bindAttribute(r,u.posBuffer,c.a_pos_loc,2),r.uniform1iv(c.u_texSize_loc,[d.texture3DXSize,d.texture3DYSize,d.texture3DZSize]),r.uniform1iv(c.u_mosaicSize_loc,[d.mosaicXCount,d.mosaicYCount,d.finalSlicesCount]);var h=a.getModelViewRelToEyeMatrixInv();r.uniformMatrix4fv(c.modelViewMatrixRelToEyeInv_loc,!1,h._floatArrays);var f=this.getMinMaxPollutionValues();r.uniform2fv(c.u_minMaxPollutionValues_loc,[f[0],f[1]]),r.uniform1f(c.u_airEnvirontmentPressure_loc,0),r.uniform2fv(c.u_screenSize_loc,[a.drawingBufferWidth[0],a.drawingBufferHeight[0]]),r.uniform2fv(c.uNearFarArray_loc,e.frustumVolumeControl.nearFarArray),r.uniform3fv(c.u_voxelSizeMeters_loc,[this.oneVoxelSizeInMeters[0],this.oneVoxelSizeInMeters[1],this.oneVoxelSizeInMeters[2]]);var g=this.simulationBox.geoLocDataManager.getCurrentGeoLocationData(),p=g.getRotMatrixInv();r.uniformMatrix4fv(c.u_simulBoxTMat_loc,!1,g.rotMatrix._floatArrays),r.uniformMatrix4fv(c.u_simulBoxTMatInv_loc,!1,p._floatArrays),r.uniform3fv(c.u_simulBoxPosHigh_loc,g.positionHIGH),r.uniform3fv(c.u_simulBoxPosLow_loc,g.positionLOW);var m=this.simulationBox.getBoundingBoxLC();r.uniform3fv(c.u_simulBoxMinPosLC_loc,[m.minX,m.minY,m.minZ]),r.uniform3fv(c.u_simulBoxMaxPosLC_loc,[m.maxX,m.maxY,m.maxZ]),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.simulBoxdoubleDepthTex),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.simulBoxDoubleNormalTex);var v=this._timeSlicesArray[this.testCurrIdx],x=this._timeSlicesArray[o];r.uniform2fv(c.uMinMaxAltitudeSlices_loc,v.uMinMaxAltitudeSlices),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,v._mosaicTexture.getTexture(0)),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,e.depthTex),r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,e.normalTex),r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,x._mosaicTexture.getTexture(0)),r.drawArrays(r.TRIANGLES,0,6),r.framebufferTexture2D(r.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0);for(var _=0;_<8;_++)r.activeTexture(r.TEXTURE0+_),r.bindTexture(r.TEXTURE_2D,null);s.unbind()},u.prototype.getMinMaxPollutionValues=function(){return[0,this.airPollutionManager._geoJsonIndexFile.pollutionMaxValue]},u.prototype._prepareLayer=function(){if(this._isPrepared)return!0;if(void 0===this._timeSlicesArray&&(this._timeSlicesArray=[]),0===this._timeSlicesArray.length)for(var e=(E=this.airPollutionManager._geoJsonIndexFile).year,t=E.month-1,r=E.day,i=E.hour,o=E.minute,n=E.second,a=new Date(e,t,r,i,o,n,0).getTime(),s=this.timeSeries.length,u=0;u<s;u++){var c=a+864e5*u,d=c+864e5,h=this.timeSeries[u],f=this.timeSliceFileFolderPath+"\\"+h.mosaicTexFileName,g=new l(v={mosaicTexFilePath:f,owner:this,startUnixTimeMiliseconds:c,endUnixTimeMiliseconds:d});this._timeSlicesArray.push(g)}var p=!0,m=this._timeSlicesArray.length;for(u=0;u<m;u++){(g=this._timeSlicesArray[u])._prepare()||(p=!1)}if(!p)return!1;if(!this.voxelizer){var v={};this.voxelizer=new Pi(v)}if(!this.oneVoxelSizeInMeters){this.oneVoxelSizeInMeters=new Float32Array([1,1,1]);var x=1e3*(E=this.airPollutionManager._geoJsonIndexFile).height_km,_=1e3*E.width_km,y=this.airPollutionManager._geoJsonIndexFile.layers[0].textureWidth,T=this.airPollutionManager._geoJsonIndexFile.layers[0].textureHeight,C=(g=this._timeSlicesArray[0],y),b=T;this.oneVoxelSizeInMeters[0]=x/C,this.oneVoxelSizeInMeters[1]=_/b,this.oneVoxelSizeInMeters[2]=this.oneVoxelSizeInMeters[0]}if(!this._allTimeSlicesTextures3DReady){var M=this.airPollutionManager.magoManager.sceneState.gl,A=this.getMinMaxPollutionValues();this._makeTextures(M,A)}if(0===this._timeSlicesArray.length)return!1;if(void 0===this._terrainSampled&&(this._terrainSampled=!1),void 0===this.geoLocDataManager){var E,L=(E=this.airPollutionManager._geoJsonIndexFile).centerGeographicCoord;this.geoLocDataManager=new ye;var w=this.geoLocDataManager.getCurrentGeoLocationData();void 0===w&&(w=this.geoLocDataManager.newGeoLocationData("default"));w=on.calculateGeoLocationData(L.longitude,L.latitude,L.altitude,0,0,0,w)}return this.simulationBox||this._makeSimulationBox(),this._isPrepared=!0,this._isPrepared};var c=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager,this.airPollutionLayersArray,this._geoJsonIndexFileLoadState=I.fileLoadState.READY,this._geoJsonIndexFile,this._geoJsonIndexFilePath=void 0,this._geoJsonIndexFileFolderPath,this._allLayersArePrepared=!1,this._animationState=I.processState.NO_STARTED,this._animationStartTime=0,this._totalAnimTime,this._increTime,t&&(t.magoManager&&(this.magoManager=t.magoManager),t.geoJsonIndexFilePath&&(this._geoJsonIndexFilePath=t.geoJsonIndexFilePath),t.geoJsonIndexFileFolderPath&&(this._geoJsonIndexFileFolderPath=t.geoJsonIndexFileFolderPath),void 0!==t.animationSpeed&&(this._animationSpeed=t.animationSpeed)),this.test_started=!1,this.init()};c.prototype.init=function(){this.test_started=!1},c.prototype.createDefaultShaders=function(){var e=this.magoManager,t=e.getGl(),r="USE_LINEAR_DEPTH",i="NO_USE_MULTI_RENDER_TARGET";t.getParameter(t.VERSION);e.isCesiumGlobe()||(t.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&t.getExtension("EXT_frag_depth"),e.EXTENSIONS_init=!0,r="USE_LOGARITHMIC_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!0);if(e.postFxShadersManager.bUseMultiRenderTarget=!1,t.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){t.getExtension("WEBGL_draw_buffers");e.postFxShadersManager.bUseMultiRenderTarget=!0,i="USE_MULTI_RENDER_TARGET"}window.navigator.userAgent.indexOf("Trident")>-1&&(r="USE_LINEAR_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!1);var o="copyTextureIntoMosaic",n=Bo.quadVertTexCoordVS,a=Bo.soundCopyFS;a=(a=a.replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i);var s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager);s.a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.a_texcoord_loc=t.getAttribLocation(s.program,"a_texcoord"),s.texToCopy_loc=t.getUniformLocation(s.program,"texToCopy"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.texToCopy_loc,0),o="volumetricAirPollution",n=Bo.waterQuadVertVS,a=(a=(a=Bo.airPollutionVolumRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).simulationBoxDoubleDepthTex_loc=t.getUniformLocation(s.program,"simulationBoxDoubleDepthTex"),s.simulationBoxDoubleNormalTex_loc=t.getUniformLocation(s.program,"simulationBoxDoubleNormalTex"),s.pollutionMosaicTex_loc=t.getUniformLocation(s.program,"pollutionMosaicTex"),s.sceneDepthTex_loc=t.getUniformLocation(s.program,"sceneDepthTex"),s.sceneNormalTex_loc=t.getUniformLocation(s.program,"sceneNormalTex"),s.a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.uNearFarArray_loc=t.getUniformLocation(s.program,"uNearFarArray"),s.tangentOfHalfFovy_loc=t.getUniformLocation(s.program,"tangentOfHalfFovy"),s.aspectRatio_loc=t.getUniformLocation(s.program,"aspectRatio"),s.modelViewMatrixRelToEyeInv_loc=t.getUniformLocation(s.program,"modelViewMatrixRelToEyeInv"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_mosaicTexSize_loc=t.getUniformLocation(s.program,"u_mosaicTexSize"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_minMaxPollutionValues_loc=t.getUniformLocation(s.program,"u_minMaxPollutionValues"),s.u_airEnvirontmentPressure_loc=t.getUniformLocation(s.program,"u_airEnvirontmentPressure"),s.u_maxVelocity_loc=t.getUniformLocation(s.program,"u_maxVelocity"),s.u_voxelSizeMeters_loc=t.getUniformLocation(s.program,"u_voxelSizeMeters"),s.u_simulBoxTMat_loc=t.getUniformLocation(s.program,"u_simulBoxTMat"),s.u_simulBoxTMatInv_loc=t.getUniformLocation(s.program,"u_simulBoxTMatInv"),s.u_simulBoxPosHigh_loc=t.getUniformLocation(s.program,"u_simulBoxPosHigh"),s.u_simulBoxPosLow_loc=t.getUniformLocation(s.program,"u_simulBoxPosLow"),s.u_simulBoxMinPosLC_loc=t.getUniformLocation(s.program,"u_simulBoxMinPosLC"),s.u_simulBoxMaxPosLC_loc=t.getUniformLocation(s.program,"u_simulBoxMaxPosLC"),s.uMinMaxAltitudeSlices_loc=t.getUniformLocation(s.program,"uMinMaxAltitudeSlices"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.simulationBoxDoubleDepthTex_loc,0),t.uniform1i(s.simulationBoxDoubleNormalTex_loc,1),t.uniform1i(s.pollutionMosaicTex_loc,2),t.uniform1i(s.sceneDepthTex_loc,3),t.uniform1i(s.sceneNormalTex_loc,4),t.uniform1i(s.pollutionMosaicTex_next_loc,5),e.postFxShadersManager.useProgram(null)},c.prototype.load_airPollutionIndexFile=function(e){this.test_started||(this._geoJsonIndexFilePath=e)},c.prototype._loadGeoJsonIndexFile=function(){if(this._geoJsonIndexFileLoadState===I.fileLoadState.READY){this._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._geoJsonIndexFilePath,void 0,void 0,"json","GET").done(function(t){e._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,e._geoJsonIndexFile=t})}},c.prototype._preparePollutionGeoJsonIndexFile=function(){return this._geoJsonIndexFileLoadState===I.fileLoadState.READY?(this._loadGeoJsonIndexFile(),!1):this._geoJsonIndexFileLoadState===I.fileLoadState.LOADING_FINISHED},c.prototype.newAirPollutionLayer=function(e){if(this.airPollutionLayersArray||(this.airPollutionLayersArray=[]),void 0===e)return!1;e.airPollutionManager=this;var t=new u(e);return this.airPollutionLayersArray.push(t),t},c.prototype.prepareVolume=function(e){return!!this._preparePollutionGeoJsonIndexFile()&&(this._createdShaders?!!this._preparePollutionLayers():(this.createDefaultShaders(),this._createdShaders=!0,!1))},c.prototype._preparePollutionLayers=function(e){if(!0===this._allLayersArePrepared)return!0;if(void 0===this.airPollutionLayersArray&&(this.airPollutionLayersArray=[]),0===(h=this.airPollutionLayersArray.length))for(var t=this._geoJsonIndexFile.layersCount,r=this._geoJsonIndexFileFolderPath,i=0;i<t;i++){var o=this._geoJsonIndexFile.layers[i],n=(o.timeSeries.length,{pollutionVolumeOwner:this,timeSeries:o.timeSeries,timeSliceFileFolderPath:r}),a=this.newAirPollutionLayer(n),s=this._geoJsonIndexFile.layers[i].timeSliceFiles;if(void 0!==s){void 0===a._timeSlicesArray&&(a._timeSlicesArray=[]);for(var l=s.length,u=0;u<l;u++){var c=new yn(n={});c._jsonFile=s[u],c._fileileLoadState=I.fileLoadState.LOADING_FINISHED,c._isPrepared=!0,pollutionLayer._timeSlicesArray.push(c)}}}var d=!0,h=this.airPollutionLayersArray.length;for(i=0;i<h;i++){this.airPollutionLayersArray[i]._prepareLayer()||(d=!1)}return this._allLayersArePrepared=d,!1},c.prototype.getQuadBuffer=function(){if(!this.screenQuad){var e=this.magoManager.getGl(),t=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r=ae.createBuffer(e,t);this.screenQuad={posBuffer:r}}return this.screenQuad},c.prototype.render=function(){if(!this._geoJsonIndexFilePath)return!1;if(this._animationState===I.processState.FINISHED)return!0;var e=this.magoManager;if(!this.prepareVolume(e))return!1;if(this._animationState===I.processState.NO_STARTED&&(this._animationState=I.processState.STARTED),void 0===this._totalAnimTime&&(this._totalAnimTime=3e4),void 0===this._timeScale&&(this._timeScale=1),void 0===e.animationTimeController){e.animationTimeController=new fn({incrementalAddingTimeMilisec:50})}for(var t=this.airPollutionLayersArray.length,r=0;r<t;r++){this.airPollutionLayersArray[r].render(e)}var i=e.getGl(),o=e.sceneState;e.bindMainFramebuffer(),i.viewport(0,0,o.drawingBufferWidth[0],o.drawingBufferHeight[0])};var d=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.uri=void 0,this.dataLength=void 0,this.name=void 0,this.glType=void 0,this.dataDimensions,this.dataTarget,this.mgOwner,t&&(t.name&&(this.name=t.name),t.mgOwner&&(this.mgOwner=t.mgOwner)),this.bufferData=void 0,this.glBuffer};d.getGlTypeOfArray=function(e){var t=-1;return e.constructor===Float32Array?t=5126:e.constructor===Int16Array?t=5122:e.constructor===Uint16Array?t=5123:e.constructor===Int8Array?t=5120:e.constructor===Uint8Array&&(t=5121),t},d.newTypedArray=function(e,t){var r;return 5126===t?r=new Float32Array(e):5122===t?r=new Int16Array(e):5123===t?r=new Uint16Array(e):5120===t?r=new Int8Array(e):5121===t&&(r=new Uint8Array(e)),r},d.getByteSizeByGlType=function(e){return 5126===e?4:5122===e?2:5123===e?2:5120===e?1:5121===e?1:void 0},d.getCopyTypedArray=function(e){return e.slice()},d._newTypedArray=function(e,t){var r;return 5126===t?r=new Float32Array(e):5122===t?r=new Int16Array(e):5123===t?r=new Uint16Array(e):5120===t?r=new Int8Array(e):5121===t&&(r=new Uint8Array(e)),r},d.prototype.setBufferData=function(e){this.glType=d.getGlTypeOfArray(e),this.bufferData=e,this.dataLength=e.length},d.prototype.getElementsCount=function(){return void 0===this.dataLength&&(this.dataLength=this.bufferData.length),this.dataLength/this.dataDimensions},d.makeMgBufferFromMgBufferViewsArray=function(e,t,r){var i=e.length;if(0!==i){t||(t=new d),t.bufferData||(t.bufferData=[]);for(var o=0,n=e[0].aux_auxMgBuffer,a=d.getGlTypeOfArray(n.bufferData),s=d.getByteSizeByGlType(a),l=n.dataTarget,u=0;u<i;u++){o+=(n=e[u].aux_auxMgBuffer).bufferData.length}var c=d._newTypedArray(o,a),h=0,f=0;for(u=0;u<i;u++){var g=e[u],p=(n=g.aux_auxMgBuffer).name;if(g.setMgBuffer(t),g.setByteOffset(h*s),g.setByteLength(n.bufferData.length*s),"INDICE"===p){var m=n.bufferData,v=m.length,x=(a=d.getGlTypeOfArray(m),d.newTypedArray(v,a));u>0&&(f+=r[u-1]);for(var _=0;_<v;_++)x[_]=m[_]+f;c.set(x,h)}else c.set(n.bufferData,h);h+=n.bufferData.length,delete n.bufferData}return t.bufferData=c,t.dataLength=o,t.glType=a,t.dataTarget=l,t}},d.bindBuffer=function(e,t,r,i,o,n,a,s,l){return i<0?(e.disableVertexAttribArray(i),!1):(void 0===s&&(s=0),void 0===l&&(l=0),e.enableVertexAttribArray(i),e.bindBuffer(t,r),e.vertexAttribPointer(i,o,n,a,s,l),!0)};var h=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.buffersMap={},this.materialId=-1,this.bHasIndices,this.mgOwner,this.mgBufferViewSet,t&&t.mgOwner&&(this.mgOwner=t.mgOwner)};h.prototype.setMaterialId=function(e){this.materialId=e},h.prototype.getOrNewMgBuffer=function(e){return this.buffersMap[e]||(this.buffersMap[e]=new d({mgOwner:this})),this.buffersMap[e]},h.prototype.setBufferData=function(e,t){this.getOrNewMgBuffer(t).setBufferData(e)},h.prototype.getMgBuffer=function(e){return this.buffersMap[e]},h.makeMgBufferDataSetFromMgBufferViewSetArray=function(e,t){for(var r={},i=e.length,o=0;o<i;o++){var n=e[o],a=n.bufferViewsMap;for(var s in a)if(a.hasOwnProperty(s)){var l=n.getMgBufferView(s);r[s]||(r[s]=[]),r[s].push(l)}}var u=r.POSITION3,c=u.length,f=[];for(o=0;o<c;o++){var p=u[o].aux_auxMgBuffer.getElementsCount();f.push(p)}t||(t=new h),t.mgBufferViewSet=new g;var m=t.mgBufferViewSet;p=0;for(var s in r)if(r.hasOwnProperty(s)){var v=r[s],x=t.getOrNewMgBuffer(s);x=d.makeMgBufferFromMgBufferViewsArray(v,x,f);var _=m.getOrNewMgBufferView(s),y=x.glType,T=d.getByteSizeByGlType(y),C=x.dataLength;_.setMgBuffer(x),_.setByteOffset(0),_.setByteLength(C*T)}return t},h.prototype.bindBuffers=function(e,t){var r=this.mgBufferViewSet,i=r.bufferViewsMap;for(var o in i)if(i.hasOwnProperty(o)){var n=r.getMgBufferView(o).mgBuffer;n.glBuffer||(n.glBuffer=ae.createBuffer(e,n.bufferData,n.dataTarget));var a=0;if("INDICE"===o)e.bindBuffer(n.dataTarget,n.glBuffer),a=n.dataLength;else{var s=t.getAttribLocation(o),l=n.dataTarget,u=n.glType;d.bindBuffer(e,l,n.glBuffer,s,3,u,!1,void 0,void 0)}}e.uniform1i(t.colorType_loc,0),e.uniform4fv(t.oneColor4_loc,[.25,.5,.95,1]),e.drawElements(e.TRIANGLES,a,e.UNSIGNED_SHORT,0)};var f=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.mgBuffer,this.byteOffset=0,this.byteLength=void 0,this.byteStride=0,this.target=void 0,this.name=void 0,this.aux_auxMgBuffer};f.prototype.setMgBuffer=function(e){this.mgBuffer=e},f.prototype.setByteOffset=function(e){this.byteOffset=e},f.prototype.setByteLength=function(e){this.byteLength=e},f.prototype.setAuxMgBuffer=function(e){this.aux_auxMgBuffer=e};var g=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.mgOwner,this.bufferViewsMap={},this.materialId,t&&t.mgOwner&&(this.mgOwner=t.mgOwner)};g.prototype.getMgBufferView=function(e){return this.bufferViewsMap[e]},g.prototype.getOrNewMgBufferView=function(e){return this.bufferViewsMap[e]||(this.bufferViewsMap[e]=new f({mgOwner:this})),this.bufferViewsMap[e]};var p=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.mgOwner,this.primitives=[],this.name=void 0,t&&t.mgOwner&&(this.mgOwner=t.mgOwner)},m=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.children=[],this.geoLocDataManager,this.name=void 0,this.mgMeshArray=[],this._map_matId_mgPrimitivesArray,this._map_matId_mgBufferDataSetArray};m._makeMap_matId_mgPrimitivesArray=function(e){for(var t={},r=e.length,i=0;i<r;i++)for(var o=e[i].primitives,n=o.length,a=0;a<n;a++){var s=o[a],l=s.materialId;t[l]||(t[l]=[]),t[l].push(s)}return t},m._makeMap_matId_mgBufferDataSetArray=function(e){var t={},r=0;for(var i in e)if(e.hasOwnProperty(i)){var o=[];t[i]||(t[i]=[]);for(var n=e[i],a=n.length,s=0;s<a;s++){var l,u=n[s],c=(u.materialId,u.mgBufferViewSet),d=c.getMgBufferView("POSITION3").aux_auxMgBuffer.getElementsCount();if(r+d>=65535)(l=h.makeMgBufferDataSetFromMgBufferViewSetArray(o,void 0)).setMaterialId(i),t[i].push(l),o.length=0,r=0,r+=d,o.push(c);else r+=d,o.push(c)}if(o.length>0)(l=h.makeMgBufferDataSetFromMgBufferViewSetArray(o,void 0)).setMaterialId(i),t[i].push(l),o.length=0,r=0}return t};var v=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.mgOwner,this.mgBufferViewSet,this.materialId=-1,t&&t.mgOwner&&(this.mgOwner=t.mgOwner)},x=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager,this.mgNodesArray=[],this.materials=[],this.mgBufferDataSetArray=[],this.geoLocDataManager,t&&t.magoManager&&(this.magoManager=t.magoManager)};x.makeMgSetFromMgNodesArray=function(e,t){t||(t=new x);for(var r=e.length,i=0;i<r;i++){var o=e[i];o._map_matId_mgPrimitivesArray=m._makeMap_matId_mgPrimitivesArray(o.mgMeshArray),o._map_matId_mgBufferDataSetArray=m._makeMap_matId_mgBufferDataSetArray(o._map_matId_mgPrimitivesArray);var n=o._map_matId_mgBufferDataSetArray;for(var a in n)if(n.hasOwnProperty(a))for(var s=n[a],l=s.length,u=0;u<l;u++)t.mgBufferDataSetArray.push(s[u]);t.mgNodesArray.push(o)}return t},x.prototype.render=function(e,t){this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(e,t);for(var r=this.mgBufferDataSetArray.length,i=0;i<r;i++){this.mgBufferDataSetArray[i].bindBuffers(e,t)}};var _=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=t.element;!r||t.target||r.style.pointerEvents||(r.style.pointerEvents="auto"),this.element=r||void 0,this.target=t.target?t.target:void 0,this.magoManager};_.prototype.setControl=function(e){this.magoManager=e;var t=this.target?this.target:this.magoManager.defaultControlContainer;t.appendChild(this.element),this.target=t},_.prototype.setBtnStyle=function(e){e.style.display="block",e.style.margin="1px",e.style.padding=0,e.style.color="white",e.style.fontSize="1.14em",e.style.fontWeight="bold",e.style.textDecoration="none",e.style.textAlign="center",e.style.height="42px",e.style.width="42px",e.style.lineHeight=".4em",e.style.border="none",e.style.backgroundColor="rgba(148,216,246, 0.8)",e.addEventListener("mouseenter",function(){e.style.filter="invert(30%)"},!1),e.addEventListener("mouseleave",function(){e.style.filter="none"},!1)},_.prototype.setTextBtn=function(e){e.style.display="inline-block",e.style.margin="1px",e.style.padding=0,e.style.color="white",e.style.fontSize=".84em",e.style.fontWeight="bold",e.style.textDecoration="none",e.style.textAlign="center",e.style.height="1.75em",e.style.width="4.575em",e.style.lineHeight=".4em",e.style.border="none",e.style.backgroundColor="rgba(148,216,246, 0.8)"};var y=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=document.createElement("div");(t=t||{}).element=r,_.call(this,t)};(y.prototype=Object.create(_.prototype)).constructor=y,y.prototype.setControl=function(e){(this.magoManager=e,this.magoManager.isCesiumGlobe())||(this.target?this.target:this.magoManager.overlayContainer).appendChild(this.element)};var T=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=document.createElement("div");(t=t||{}).element=r,_.call(this,t),r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.top="24.0em",r.style.right=".5em";var i=document.createElement("button");i.setAttribute("type","button"),i.title="init position",i.appendChild(document.createTextNode("🧭")),this.setBtnStyle(i),i.style.backgroundColor="rgba(217, 217, 217, 0.8)",this.element.appendChild(i)};(T.prototype=Object.create(_.prototype)).constructor=T;var C=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=document.createElement("div");(t=t||{}).element=r,_.call(this,t);this.full=!1,r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.top="4.5em",r.style.right=".5em";var i=document.createElement("button");i.setAttribute("type","button"),i.title="Full Screen";var o=document.createElement("span");o.appendChild(document.createTextNode("⇅")),o.style.transform="rotate(0.1turn)",o.style.display="inline-block",o.style.verticalAlign="super",o.style.lineHeight="0.6em",i.appendChild(o),i.appendChild(document.createElement("br"));var n=document.createElement("span");n.appendChild(document.createTextNode("전체화면")),n.style.fontSize="10px",n.style.verticalAlign="baseline",n.style.lineHeight="0.6em",i.appendChild(n),this.setBtnStyle(i),i.addEventListener("click",this.handleClick.bind(this),!1),this.fullButtonElement=i;var a=document.createElement("button");a.setAttribute("type","button"),a.title="Cancle Full Screen";var s=document.createElement("span");s.appendChild(document.createTextNode("✖")),s.style.verticalAlign="super",s.style.lineHeight="0.6em",a.appendChild(s),a.appendChild(document.createElement("br"));var l=document.createElement("span");l.appendChild(document.createTextNode("취소")),l.style.fontSize="10px",l.style.verticalAlign="baseline",l.style.lineHeight="0.6em",a.appendChild(l),this.setBtnStyle(a),a.style.display="none",a.addEventListener("click",this.handleClick.bind(this),!1),this.cancleButtonElement=a,this.element.appendChild(i),this.element.appendChild(a)};(C.prototype=Object.create(_.prototype)).constructor=C,C.prototype.handleClick=function(){var e,t,r=document.getElementById(this.magoManager.config.getContainerId());this.full?(document.webkitIsFullScreen||document.msFullscreenElement||document.fullscreenElement)&&(this.fullButtonElement.style.display="block",this.cancleButtonElement.style.display="none",document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen(),this.full=!1):((t=document.body).webkitRequestFullscreen||t.msRequestFullscreen&&document.msFullscreenEnabled||t.requestFullscreen&&document.fullscreenEnabled)&&(this.fullButtonElement.style.display="none",this.cancleButtonElement.style.display="block",(e=r).requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(),this.full=!0)};var b=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=document.createElement("div");(t=t||{}).element=r,_.call(this,t),r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.top="1.0em",r.style.right=".5em";var i=document.createElement("button");i.setAttribute("type","button"),i.title="init position";var o=document.createElement("span");o.appendChild(document.createTextNode("🏠")),o.style.verticalAlign="text-top",o.style.lineHeight="0.6em",i.appendChild(o),i.appendChild(document.createElement("br"));var n=document.createElement("span");n.appendChild(document.createTextNode("처음으로")),n.style.fontSize="10px",n.style.verticalAlign="baseline",n.style.lineHeight="0.6em",i.appendChild(n),this.setBtnStyle(i),i.style.backgroundColor="rgba(217, 217, 217, 0.8)",i.addEventListener("click",this.handleClick.bind(this),!1),this.element.appendChild(i)};(b.prototype=Object.create(_.prototype)).constructor=b,b.prototype.handleClick=function(){if(this.magoManager.isCesiumGlobe()){var e=this.magoManager.configInformation;if(e.initCameraEnable){var t=parseFloat(e.initLongitude),r=parseFloat(e.initLatitude),i=parseFloat(e.initAltitude),o=parseInt(e.initDuration);if(isNaN(t)||isNaN(r)||isNaN(i))throw new Error("Longitude, Latitude, Height must number type.");isNaN(o)&&(o=3),this.magoManager.flyTo(t,r,i,o)}}};var M=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=document.createElement("div");function i(e,t,r,i,o){var n=document.createElement("button");n.setAttribute("type","button"),n.title=i;var a=document.createElement("span");a.appendChild(document.createTextNode(r)),a.style.verticalAlign="super",a.style.lineHeight="0.6em",n.appendChild(a),n.appendChild(document.createElement("br"));var s=document.createElement("span");s.appendChild(document.createTextNode(o)),s.style.fontSize="10px",s.style.verticalAlign="baseline",s.style.lineHeight="0.6em",n.appendChild(s),e.setBtnStyle(n),n.style.backgroundColor="rgba(230, 230, 230, 0.8)",n.style.display="inline-block",e.buttons[t]={status:!1,element:n},e.element.appendChild(n),n.addEventListener("click",e.handleClick.bind(e,t),!1)}(t=t||{}).element=r,_.call(this,t),this.buttons={},r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.bottom="9.5em",r.style.right=".5em",i(this,"length","📏","Measure Length","거리측정"),i(this,"area","⛶","Measure Area","면적측정"),i(this,"height","⮸","Measure Height","높이측정")};(M.prototype=Object.create(_.prototype)).constructor=M,M.prototype.handleClick=function(e){if(this.buttons[e].status){(r=this.buttons[e]).status=!1,r.element.style.backgroundColor="rgba(230, 230, 230, 0.8)"}else{for(var t in this.buttons)if(this.buttons.hasOwnProperty(t)){var r=this.buttons[t];t===e?(r.element.style.backgroundColor="rgba(148,216,246, 0.8)",r.status=!0):(r.element.style.backgroundColor="rgba(230, 230, 230, 0.8)",r.status=!1)}alert("기능 준비중")}};var A=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=document.createElement("div");(t=t||{}).element=r,_.call(this,t);r.id="mago3dOlMap",r.style.position="absolute",r.style.pointerEvents="auto",r.style.borderRadius="4px",r.style.padding="2px",r.style.bottom=".5em",r.style.right=".5em",r.style.width="135px",r.style.height="135px",r.style.borderRadius="4px",r.style.border="2px solid #CCE5EC"};(A.prototype=Object.create(_.prototype)).constructor=A,A.prototype.setControl=function(e){if(this.magoManager=e,this.magoManager.scene){(this.target?this.target:this.magoManager.defaultControlContainer).appendChild(this.element);var t,r=new OlMago3d.layer.VectorLayer({source:new OlMago3d.source.VectorSource}),i=this.magoManager.scene.globe.imageryLayers,o=i._layers.findIndex(function(e){return e.isBaseLayer()}),n=i.get(o).imageryProvider,a=0;if(n instanceof Cesium.WebMapServiceImageryProvider){var s=n._resource,l={TILED:!0};for(var u in s.queryParameters)"bbox"!==u&&"height"!==u&&"width"!==u&&(l[u.toUpperCase()]=s.queryParameters[u]);t=new OlMago3d.source.TileWMS({url:n.url,serverType:"geoserver",params:l}),a=1}else n instanceof Cesium.ArcGisMapServerImageryProvider?t=new OlMago3d.source.XYZ({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"}):n instanceof Cesium.UrlTemplateImageryProvider&&(t=new OlMago3d.source.XYZ({url:n.url}));var c=new OlMago3d.layer.TileLayer({source:t,minZoom:a});if(this.overviewMap=new OlMago3d.Map({target:"mago3dOlMap",view:new OlMago3d.View({zoom:3,center:[0,0],projection:"EPSG:4326"}),layers:[c,r],controls:OlMago3d.control.defaults({attribution:!0,zoom:!1,rotate:!1}),interactions:OlMago3d.interaction.defaults({altShiftDragRotate:!1,onFocusOnly:!1,doubleClickZoom:!1,keyboard:!1,mouseWheelZoom:!1,shiftDragZoom:!1,dragPan:!1,pinchRotate:!1,pinchZoom:!1})}),this.overviewMap.overlayContainerStopEvent_.style.pointerEvents="none",this.magoManager.isCesiumGlobe()){var d=function(){var e=f.camera.computeViewRectangle(f.globe.ellipsoid),t=e.west<e.east?e.west:e.east,i=e.south<e.north?e.south:e.north,o=e.west>e.east?e.west:e.east,n=e.south>e.north?e.south:e.north,a=[Cesium.Math.toDegrees(t),Cesium.Math.toDegrees(i),Cesium.Math.toDegrees(o),Cesium.Math.toDegrees(n)],s=OlMago3d.geom.Polygon.fromExtent(a);g?g.setGeometry(s):(g=new OlMago3d.Feature({geometry:s}),r.getSource().addFeature(g));Cesium.Ellipsoid.WGS84;var l=f.canvas,u=new Cesium.Cartesian2(l.clientWidth/2,l.clientHeight/2),c=f.camera.getPickRay(u);if(!(x=f.globe.pick(c,f)||f.camera.pickEllipsoid(u))){var d=f.globe,m=f.camera.positionCartographic.clone(),v=d.getHeight(m);m.height=v||0,x=Cesium.Ellipsoid.WGS84.cartographicToCartesian(m)}var x,_=Cesium.Cartesian3.distance(x,f.camera.position);return void p.fit(a,{size:h(_)})},h=function(e){var t=0;return[t=e<5e3?90:e<2e4?70:e<7e4?50:30,t]},f=this.magoManager.scene,g=null,p=this.overviewMap.getView();OlMago3d.proj.getTransform(p.getProjection(),"EPSG:4326"),OlMago3d.proj.getTransform("EPSG:4326",p.getProjection());d(),p.on("change:resolution",function(){}),p.on("change:center",function(){}),p.on("change:rotation",function(){}),this.magoManager.on("isCameraMoved",function(){d()})}}};var E=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=document.createElement("div");(t=t||{}).element=r,_.call(this,t),this.tools={},r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.top="7.5em",r.style.right=".5em",r.addEventListener("mouseover",this.handleMouseOver.bind(this),!1),r.addEventListener("mouseout",this.handleMouseOut.bind(this),!1);var i=this;r.addEventListener("click",function(){var e=document.getElementById(i.magoManager.config.getContainerId()).getElementsByClassName("mago3d-overlayContainer-defaultContent").item(0),t=e.getElementsByClassName("mago3d-tools-advance").item(0);if(r.className.indexOf("on")>=0)t.style.display="none",i.target.style.right="0px",e.style.display="none",e.style.right="0px",r.className="",r.getElementsByTagName("button")[0].style.backgroundColor="rgba(70, 70, 70, 0.8)";else{i.target.style.right="320px",e.style.display="block",e.style.right="0px";for(var o=e.getElementsByClassName("mago3d-tools-div"),n=0,a=o.length;n<a;n++){o.item(n).style.display="none"}t.style.display="block",r.className="on",r.getElementsByTagName("button")[0].style.backgroundColor="rgba(148,216,246, 0.8)"}},!1);var o=document.createElement("button");o.setAttribute("type","button"),o.title="Tool Box";var n=document.createElement("span");n.appendChild(document.createTextNode("⚙")),n.style.verticalAlign="super",n.style.lineHeight="0.6em",o.appendChild(n),o.appendChild(document.createElement("br"));var a=document.createElement("span");a.appendChild(document.createTextNode("설정")),a.style.fontSize="10px",a.style.verticalAlign="baseline",a.style.lineHeight="0.6em",o.appendChild(a),this.setBtnStyle(o),o.style.backgroundColor="rgba(217, 217, 217, 0.8)",r.appendChild(o)};(E.prototype=Object.create(_.prototype)).constructor=E,E.prototype.setControl=function(e){this.magoManager=e;var t=this.target?this.target:e.defaultControlContainer;t.appendChild(this.element),this.target=t;var r=document.createElement("div");r.style.position="absolute",r.style.float="right",r.style.width="100%",r.style.backgroundColor="#FFFFFF",r.style.pointerEvents="auto",r.style.display="none",r.className="mago3d-tools-div mago3d-tools-advance",e.defaultContentContainer.appendChild(r);var i=X("기본 설정");r.appendChild(i);var o=document.createElement("div");o.style.marginTop="5px",i.appendChild(o);var n=this,a=[],s=W("bbox","BoundingBox Toggle","BBOX","toggle",function(e){n.magoManager.magoPolicy.setShowBoundingBox(e)}),l=W("label","Label Toggle","LABEL","toggle",function(e){n.magoManager.magoPolicy.setShowLabelInfo(e);var t=n.magoManager.getObjectLabel().getContext("2d");t.clearRect(0,0,t.canvas.width,t.canvas.height)}),u=W("orgin","Origin Toggle","ORIGIN","toggle",function(e){n.magoManager.magoPolicy.setShowOrigin(e)}),c=W("shadow","Shadow Toggle","SHADOW","toggle",function(e){n.magoManager.sceneState.setApplySunShadows(e)});a.push(s),a.push(l),a.push(u),a.push(c);for(var d=0,h=a.length;d<h;d++){var f=a[d],g=f.element;o.appendChild(g),g.addEventListener("click",n.handleToolClick.bind(this,f),!1)}var p=document.createElement("div");p.style.padding="0 5px 0 0",p.style.margin="5px 5px 0 5px",i.appendChild(p);var m=document.createElement("div");m.style.padding="4px",m.style.margin="10px 0px 4px",m.style.outline="0px 0px 4px",m.style.verticalAlign="top",m.style.backgroundColor="rgb(243,243,243)",m.style.borderRadius="12px",m.style.borderStyle="none",m.className="mago3d-tools-ssao-div",p.appendChild(m);var v=document.createElement("label");v.style.width="25%",v.style.padding="2px",v.style.verticalAlign="middle",v.style.display="inline-block",v.style.textAlign="justify",v.style.fontSize="13.33333px",v.setAttribute("for","ssaoRadius"),v.appendChild(document.createTextNode("SSAO")),m.appendChild(v);var x=document.createElement("input");x.style.width="45%",x.style.marginRight="5px",x.style.padding="5px",x.style.fontSize="small",x.style.verticalAlign="middle",x.style.lineHeight="1.5em",x.style.color="#444",x.setAttribute("id","ssaoRadius"),x.setAttribute("name","ssaoRadius"),x.setAttribute("type","text"),x.setAttribute("value",e.configInformation.ssaoRadius),m.appendChild(x);var _=document.createElement("button");_.setAttribute("type","button"),_.style.display="inline-block",_.style.verticalAlign="middle",_.style.padding="2px 10px",_.style.fontSize="12px",_.style.color="#FFFFFF",_.style.borderRadius="12px",_.style.borderStyle="none",_.style.backgroundColor="#636363",_.appendChild(document.createTextNode("적용")),_.addEventListener("click",function(){var t=x.value;isNaN(t)?alert("숫자만 입력 가능합니다."):(e.magoPolicy.setSsaoRadius(t),e.sceneState.ssaoRadius[0]=Number(t))},!1),m.appendChild(_);var y=document.createElement("div");y.style.padding="4px",y.style.margin="10px 0px 4px",y.style.outline="0px 0px 4px",y.style.verticalAlign="top",y.style.backgroundColor="rgb(243,243,243)",y.style.borderRadius="12px",y.style.borderStyle="none",y.className="mago3d-tools-lod-div",p.appendChild(y);var T=document.createElement("h3");T.style.fontSize="15px",T.appendChild(document.createTextNode("Level of Detail")),y.appendChild(T);for(d=0;d<6;d++){var C="geoLod"+d,b="lod"+d,M=document.createElement("label");M.style.width="25%",M.style.padding="2px",M.style.verticalAlign="middle",M.style.display="inline-block",M.style.textAlign="justify",M.style.fontSize="13.33333px",M.setAttribute("for",C),M.appendChild(document.createTextNode(b.toUpperCase())),y.appendChild(M);var A=document.createElement("input");A.style.width="45%",A.style.marginRight="5px",A.style.padding="5px",A.style.fontSize="small",A.style.verticalAlign="middle",A.style.lineHeight="1.5em",A.style.color="#444",A.setAttribute("id",C),A.setAttribute("name",b),A.setAttribute("type","text"),A.setAttribute("value",e.configInformation[b]),y.appendChild(A)}var E=document.createElement("button");E.setAttribute("type","button"),E.style.display="inline-block",E.style.verticalAlign="middle",E.style.padding="2px 10px",E.style.fontSize="12px",E.style.color="#FFFFFF",E.style.borderRadius="12px",E.style.borderStyle="none",E.style.backgroundColor="#636363",E.appendChild(document.createTextNode("적용")),E.addEventListener("click",function(){var t=document.getElementById("geoLod0").value,r=document.getElementById("geoLod1").value,i=document.getElementById("geoLod2").value,o=document.getElementById("geoLod3").value,n=document.getElementById("geoLod4").value,a=document.getElementById("geoLod5").value;isNaN(t)||isNaN(r)||isNaN(i)||isNaN(o)||isNaN(n)||isNaN(a)?alert("숫자만 입력 가능합니다."):(null!==t&&""!==t&&e.magoPolicy.setLod0DistInMeters(t),null!==r&&""!==r&&e.magoPolicy.setLod1DistInMeters(r),null!==i&&""!==i&&e.magoPolicy.setLod2DistInMeters(i),null!==o&&""!==o&&e.magoPolicy.setLod3DistInMeters(o),null!==n&&""!==n&&e.magoPolicy.setLod4DistInMeters(n),null!==a&&""!==a&&e.magoPolicy.setLod5DistInMeters(a))},!1),y.appendChild(E);var L=X("데이터 선택");r.appendChild(L);var w=document.createElement("div");w.style.padding="4px",w.style.margin="10px 0px 4px",w.style.outline="0px 0px 4px",w.style.verticalAlign="top",w.style.backgroundColor="rgb(243,243,243)",w.style.borderRadius="12px",w.style.borderStyle="none",w.className="mago3d-tools-data-div",L.appendChild(w);var S=document.createElement("strong");S.style.width="35%",S.style.padding="2px",S.style.verticalAlign="middle",S.style.display="inline-block",S.style.textAlign="justify",S.style.fontSize="13.33333px",S.appendChild(document.createTextNode("F4D 모델")),w.appendChild(S);var D=document.createElement("button");D.setAttribute("type","button"),D.dataset.type=te.F4D,D.dataset.function="select",D.dataset.active="off",D.className="mago3d-tools-select",D.name="btn-"+te.F4D,D.style.display="inline-block",D.style.verticalAlign="middle",D.style.padding="2px 10px",D.style.fontSize="12px",D.style.color="rgb(20, 20, 20)",D.style.borderRadius="12px",D.style.borderStyle="none",D.style.backgroundColor="rgb(255, 255, 255)",D.appendChild(document.createTextNode("선택")),w.appendChild(D);var R=document.createElement("button");R.setAttribute("type","button"),R.dataset.type=te.F4D,R.dataset.function="translate",R.dataset.active="off",R.className="mago3d-tools-translate",R.name="btn-"+te.F4D,R.style.display="inline-block",R.style.verticalAlign="middle",R.style.marginLeft="5px",R.style.padding="2px 10px",R.style.fontSize="12px",R.style.color="rgb(20, 20, 20)",R.style.borderRadius="12px",R.style.borderStyle="none",R.style.backgroundColor="rgb(255, 255, 255)",R.appendChild(document.createTextNode("이동")),w.appendChild(R),w.appendChild(document.createElement("br"));var P=document.createElement("strong");P.style.width="35%",P.style.padding="2px",P.style.verticalAlign="middle",P.style.display="inline-block",P.style.textAlign="justify",P.style.fontSize="13.33333px",P.appendChild(document.createTextNode("F4D 모델 부분")),w.appendChild(P);var I=document.createElement("button");I.setAttribute("type","button"),I.dataset.type=te.OBJECT,I.dataset.function="select",I.dataset.active="off",I.className="mago3d-tools-select",I.name="btn-"+te.OBJECT,I.style.display="inline-block",I.style.verticalAlign="middle",I.style.padding="2px 10px",I.style.fontSize="12px",I.style.color="rgb(20, 20, 20)",I.style.borderRadius="12px",I.style.borderStyle="none",I.style.backgroundColor="rgb(255, 255, 255)",I.appendChild(document.createTextNode("선택")),w.appendChild(I);var F=document.createElement("button");F.setAttribute("type","button"),F.dataset.type=te.OBJECT,F.dataset.function="translate",F.dataset.active="off",F.className="mago3d-tools-translate",F.name="btn-"+te.OBJECT,F.style.display="inline-block",F.style.verticalAlign="middle",F.style.marginLeft="5px",F.style.padding="2px 10px",F.style.fontSize="12px",F.style.color="rgb(20, 20, 20)",F.style.borderRadius="12px",F.style.borderStyle="none",F.style.backgroundColor="rgb(255, 255, 255)",F.appendChild(document.createTextNode("이동")),w.appendChild(F),w.appendChild(document.createElement("br"));var O=document.createElement("strong");O.style.width="35%",O.style.padding="2px",O.style.verticalAlign="middle",O.style.display="inline-block",O.style.textAlign="justify",O.style.fontSize="13.33333px",O.appendChild(document.createTextNode("원시 모델 부분")),w.appendChild(O);var B=document.createElement("button");B.setAttribute("type","button"),B.dataset.type=te.NATIVE,B.dataset.function="select",B.dataset.active="off",B.className="mago3d-tools-select",B.name="btn-"+te.NATIVE,B.style.display="inline-block",B.style.verticalAlign="middle",B.style.padding="2px 10px",B.style.fontSize="12px",B.style.color="rgb(20, 20, 20)",B.style.borderRadius="12px",B.style.borderStyle="none",B.style.backgroundColor="rgb(255, 255, 255)",B.appendChild(document.createTextNode("선택")),w.appendChild(B);var N=document.createElement("button");N.setAttribute("type","button"),N.dataset.type=te.NATIVE,N.dataset.function="translate",N.dataset.active="off",N.className="mago3d-tools-translate",N.name="btn-"+te.NATIVE,N.style.display="inline-block",N.style.verticalAlign="middle",N.style.marginLeft="5px",N.style.padding="2px 10px",N.style.fontSize="12px",N.style.color="rgb(20, 20, 20)",N.style.borderRadius="12px",N.style.borderStyle="none",N.style.backgroundColor="rgb(255, 255, 255)",N.appendChild(document.createTextNode("이동")),w.appendChild(N);for(var U=e.defaultContentContainer.getElementsByClassName("mago3d-tools-select"),G=e.defaultSelectInteraction,z=e.defaultContentContainer.getElementsByClassName("mago3d-tools-translate"),H=e.defaultTranslateInteraction,V=(te.NATIVE,te.OBJECT,te.F4D,d=0,U.length);d<V;d++)!function(e){var t=U.item(e);t.addEventListener("click",function(){var e=t.dataset.type;if(G.getActive()){var r=G.getTargetType();if(e===r)G.setActive(!1),t.dataset.active="off";else{var i=U.namedItem("btn-"+r);i.dataset.active="off",j(i),G.setTargetType(e),t.dataset.active="on"}}else G.setTargetType(e),G.setActive(!0),t.dataset.active="on";j(t)},!1)}(d);d=0;for(var k=z.length;d<k;d++)!function(e){var t=z.item(e);t.addEventListener("click",function(){var e=t.dataset.type;if(H.getActive()){var r=H.getTargetType();if(e===r)H.setActive(!1),t.dataset.active="off";else{var i=z.namedItem("btn-"+r);i.dataset.active="off",j(i),H.setTargetType(e),t.dataset.active="on"}}else H.setTargetType(e),H.setActive(!0),t.dataset.active="on";j(t)},!1)}(d);function j(e){"on"===e.dataset.active?(e.style.backgroundColor="rgb(160, 160, 160)",e.style.color="rgb(230, 230, 230)"):(e.style.backgroundColor="rgb(255, 255, 255)",e.style.color="rgb(20, 20, 20)")}function W(e,t,r,i,o){var n=document.createElement("button");return n.setAttribute("type","button"),n.dataset.type=e,n.dataset.status="off",n.title=t,n.appendChild(document.createTextNode(r)),n.style.display="inline-block",n.style.margin="1px 1px 1px 5px",n.style.padding="0",n.style.color="rgb(136, 136, 136)",n.style.fontWeight="bold",n.style.height="33px",n.style.width="66px",n.style.backgroundColor="#f3f3f3",n.style.borderRadius="12px",n.style.borderStyle="none",{runType:i,element:n,action:o}}function X(e){var t=document.createElement("div");t.style.padding="5px 10px",t.style.margin="0 0 20px 0",t.style.outline="0px",t.style.verticalAlign="top",t.style.fontSize="16PX",t.style.fontWeight="bold",t.style.color="#888";var r=document.createElement("strong");return r.style.display="block",r.style.padding="10px 6px",r.style.borderBottom="1px solid #e2e2e2",r.appendChild(document.createTextNode(e)),t.appendChild(r),t}},E.prototype.handleMouseOver=function(){this.element.getElementsByTagName("button")[0].style.backgroundColor="rgba(148,216,246, 0.8)"},E.prototype.handleMouseOut=function(){"on"!==this.element.className&&(this.element.getElementsByTagName("button")[0].style.backgroundColor="rgba(217, 217, 217, 0.8)")},E.prototype.handleToolClick=function(e){if("toggle"===e.runType){var t=e.element;t.dataset.status="on"===t.dataset.status?"off":"on";var r="on"===t.dataset.status;e.action.call(this,r),e.element.style.backgroundColor=r?"rgba(148,216,246, 0.8)":"rgba(230, 230, 230, 0.8)"}};var L=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=document.createElement("div");(t=t||{}).element=r,_.call(this,t),r.style.position="absolute",r.style.pointerEvents="auto",r.style.backgroundColor="rgba(255,255,255,0.4)",r.style.borderRadius="4px",r.style.padding="2px",r.style.bottom="0.5em",r.style.right="9.5em";var i=document.createElement("button");i.setAttribute("type","button"),i.title="zoom in";var o=document.createElement("span");o.appendChild(document.createTextNode("+")),o.style.verticalAlign="super",o.style.lineHeight="0.6em",i.appendChild(o),this.setBtnStyle(i),i.style.width="25px",i.style.height="25px",i.style.display="inline-block",i.addEventListener("click",this.handleClick.bind(this,1),!1);var n=document.createElement("button");n.setAttribute("type","button"),n.title="zoom out";var a=document.createElement("span");a.appendChild(document.createTextNode("−")),a.style.verticalAlign="super",a.style.lineHeight="0.6em",n.appendChild(a),this.setBtnStyle(n),n.style.width="25px",n.style.height="25px",n.style.display="inline-block",n.addEventListener("click",this.handleClick.bind(this,0),!1),this.element.appendChild(i),this.element.appendChild(n)};(L.prototype=Object.create(_.prototype)).constructor=L,L.prototype.handleClick=function(e){if(this.magoManager.isCesiumGlobe()){var t=this.magoManager.scene,r=t.camera,i=Cesium.Cartographic.fromCartesian(r.position).height;e?t.camera.zoomIn(.1*i):t.camera.zoomOut(.1*i)}};var w=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._fileLoadState=I.fileLoadState.READY,this._filePath,this._jsonFile,this._isPrepared=!1,this._glTexture,this.owner=void 0,this._texture3dCreated=!1,this._texture3d,this._mosaicTexture,this._texture2dAux,this._startUnixTimeMiliseconds,this._endUnixTimeMiliseconds,this.uMinMaxAltitudeSlices=void 0,void 0!==t&&(t.filePath&&(this._filePath=t.filePath),t.owner&&(this.owner=t.owner),void 0!==t.startUnixTimeMiliseconds&&(this._startUnixTimeMiliseconds=t.startUnixTimeMiliseconds),void 0!==t.endUnixTimeMiliseconds&&(this._endUnixTimeMiliseconds=t.endUnixTimeMiliseconds))};w.prototype.getTotalMinMaxAltitudes=function(){var e=this._jsonFile.dataSlices,t=e.length,r=new Float32Array(2);return r[0]=e[0].minAltitude,r[1]=e[t-1].maxAltitude,r},w.loadTexture=function(e,t,r,i){var o=new Image;t.fileLoadState=I.fileLoadState.LOADING_STARTED,o.onload=function(){var e=r.getGl();void 0!==t.texId&&null!==t.texId&&e.deleteTexture(t.texId),void 0===i&&(i=!1),t.imageWidth=o.width,t.imageHeight=o.height;var n=e.CLAMP_TO_EDGE,a=e.NEAREST;t.texId=it.createTexture(e,a,o,t.imageWidth,t.imageHeight,n,!1),t.fileLoadState=I.fileLoadState.BINDING_FINISHED},o.onerror=function(){t.fileLoadState=I.fileLoadState.LOAD_FAILED},o.crossOrigin="Anonymous",o.src=e},w.prototype._prepare=function(e){if(this._isPrepared)return!0;if(this._fileLoadState===I.fileLoadState.READY){this._fileLoadState=I.fileLoadState.LOADING_STARTED;var t=this;rn(this._filePath,void 0,void 0,"json","GET").done(function(e){t._fileLoadState=I.fileLoadState.LOADING_FINISHED,t._jsonFile=e})}if(this._fileLoadState!==I.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this.uMinMaxAltitudeSlices){this.uMinMaxAltitudeSlices=new Float32Array(64);for(var r=this._jsonFile.dataSlices,i=r.length,o=0;o<i;o++){var n=r[o];this.uMinMaxAltitudeSlices[2*o]=n.minAltitude,this.uMinMaxAltitudeSlices[2*o+1]=n.maxAltitude}}if(void 0===this._mosaicTexture&&(this._mosaicTexture=new Do),void 0===this._texture2dAux&&(this._texture2dAux=new it),this._texture2dAux.fileLoadState===I.fileLoadState.READY){this._texture2dAux.fileLoadState=I.fileLoadState.LOADING_STARTED;t=this;var a=this.owner.chemicalAccidentManager._geoJsonIndexFileFolderPath,s=this._jsonFile.mosaicTextureFileName,l=a+"\\"+s,u=!1,c=this._jsonFile.byteData,d=this._jsonFile.width,h=this._jsonFile.height,f=e.chemicalAccidentManager,g=f.getBlobArrayBuffer(s),p=new Blob([g],{type:"image/png"});if(void 0!==p){var m=new Image;m.src=URL.createObjectURL(p);var v=this._texture2dAux;m.onload=function(){var e=f.magoManager.getGl();void 0!==v.texId&&null!==v.texId&&e.deleteTexture(v.texId),void 0===u&&(u=!1),v.imageWidth=m.width,v.imageHeight=m.height;var t=e.CLAMP_TO_EDGE,r=e.NEAREST;v.texId=it.createTexture(e,r,m,v.imageWidth,v.imageHeight,t,!1),v.fileLoadState=I.fileLoadState.BINDING_FINISHED},m.onerror=function(){this._texture2dAux.fileLoadState=I.fileLoadState.LOAD_FAILED}}else{if(void 0===c)return w.loadTexture(l,this._texture2dAux,this.owner.chemicalAccidentManager.magoManager,u),!1;var x=c.length,_=new Uint8Array(x);for(o=0;o<x;o++)_[o]=c[o];var y=this.owner.chemicalAccidentManager.magoManager.getGl(),T=y.CLAMP_TO_EDGE,C=y.NEAREST;this._texture2dAux.texId=it.createTexture(y,C,_,d,h,T,!1),this._texture2dAux.fileLoadState=I.fileLoadState.BINDING_FINISHED,this._jsonFile.byteData=void 0,this._mosaicTexture.texturesArray.push(this._texture2dAux.texId),this._mosaicTexture.finalTextureXSize=d,this._mosaicTexture.finalTextureYSize=h,this._mosaicTexture.fileLoadState=I.fileLoadState.BINDING_FINISHED,this._isPrepared=!0}return!1}return this._texture2dAux.fileLoadState!==I.fileLoadState.LOAD_FAILED&&(this._texture2dAux.fileLoadState===I.fileLoadState.BINDING_FINISHED&&(this._texture2dAux.fileLoadState===I.fileLoadState.BINDING_FINISHED&&this._mosaicTexture.fileLoadState!==I.fileLoadState.BINDING_FINISHED&&(this._mosaicTexture.texturesArray.push(this._texture2dAux.texId),this._texture2dAux.texId=void 0,this._mosaicTexture.finalTextureXSize=this._mosaicTexture.mosaicXCount*this._texture2dAux.imageWidth,this._mosaicTexture.finalTextureYSize=this._mosaicTexture.mosaicYCount*this._texture2dAux.imageHeight,this._mosaicTexture.fileLoadState=I.fileLoadState.BINDING_FINISHED,this._isPrepared=!0),!1))},w.getUint8ArrayRGBAFromArrayBuffer=function(e){for(var t=new Uint8Array(4*e.length),r=e.length,i=0;i<r;i++){var o=e[i],n=on.packDepth(o);t[4*i]=255*n[0],t[4*i+1]=255*n[1],t[4*i+2]=255*n[2],t[4*i+3]=255*n[3]}return t},w.prototype.getMinMaxPollutionValues=function(){return void 0===this.minMaxPollutionValues&&(this.minMaxPollutionValues=new Float32Array(2),this.minMaxPollutionValues[0]=this._jsonFile.minValue,this.minMaxPollutionValues[1]=this._jsonFile.maxValue),this.minMaxPollutionValues},w.prototype._getSliceIdx=function(e){var t=this._jsonFile.dataSlices,r=t.length;if(0===r)return-1;if(e<t[0].minAltitude)return-1;for(var i=-1,o=0;o<r;o++){var n=t[o];if(e>=n.minAltitude&&e<n.maxAltitude){i=o;break}}return i},w.prototype.getContaminationValue=function(e,t,r,i){var o=this._mosaicTexture,n=o.mosaicXCount,a=o.mosaicYCount,s=(o.finalSlicesCount,o.texture3DXSize,o.texture3DYSize,o.texture3DZSize,o.finalTextureXSize),l=o.finalTextureYSize,u=t/2,c=r/2,d=(e.x+u)/t,h=(e.y+c)/r,f=this._getSliceIdx(e.z);if(-1===f)return 0;var g=f%n,p=Math.floor(f/n),m=new Kr(d,h),v=1/n,x=1/a,_=g*v+m.x*v,y=p*x+m.y*x,T=new Kr(_,y),C=this._mosaicTexture.getTexture(0);if(!this.fboValuesTex){this.fboValuesTex=new ae(i,s,l,{matchCanvasSize:!1,multiRenderTarget:!1,numColorBuffers:1})}var b=Math.floor(T.x*s),M=Math.floor(T.y*l),A=new Uint8Array(4);this.fboValuesTex.bind(),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,C,0),i.readPixels(b,M,1,1,i.RGBA,i.UNSIGNED_BYTE,A),this.fboValuesTex.unbind();var E=this._jsonFile.minValue,L=this._jsonFile.maxValue,w=[A[0]/255,A[1]/255,A[2]/255,A[3]/255];return on.unpackDepth(w)*(L-E)+E},w.prototype._makeTextures=function(e,t){if(!this._texture3dCreated){var r=this._jsonFile.dataSlices.length,i=this._jsonFile.dataSlices[0];this._mosaicTexture.mosaicXCount=this._jsonFile.mosaicColumnsCount,this._mosaicTexture.mosaicYCount=this._jsonFile.mosaicRowsCount,this._mosaicTexture.texture3DXSize=i.width,this._mosaicTexture.texture3DYSize=i.height,this._mosaicTexture.texture3DZSize=r,this._texture3dCreated=!0}return this._texture3dCreated};var S=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.chemicalAccidentManager=void 0,this.geographicExtent,this._geoJsonIndexFileLoadState=I.fileLoadState.READY,this._geoJsonIndexFile,this._geoJsonIndexFilePath,this._geoJsonIndexFileFolderPath,this._allLayersArePrepared=!1,this._animationState=I.processState.NO_STARTED,this._animationStartTime=0,this._totalAnimTime,this._increTime,this._timeSlicesArray,this._isPrepared=!1,this._mosaicTexMetaDataFileNamesArray,this._metadataFolderPath,this.simulationBox=void 0,this.vboKeysContainer,this.volumeDepthFBO=void 0,this.screenFBO=void 0,this.useMinMaxValuesToRender=0,this.minMaxPollutionValuesToRender=new Float32Array([0,.0097]),this.cuttingPlanesArray=[],this.currentActiveCuttingPlaneIdx=-1,t&&(t.mosaicTexMetaDataFileNames&&(this._mosaicTexMetaDataFileNamesArray=t.mosaicTexMetaDataFileNames),t.chemicalAccidentManager&&(this.chemicalAccidentManager=t.chemicalAccidentManager),void 0!==t.timeInterval_min&&(this.timeInterval_min=t.timeInterval_min),void 0!==t.timeSlicesCount&&(this.timeSlicesCount=t.timeSlicesCount),void 0!==t.timeSliceFileNames&&(this.timeSliceFileNames=t.timeSliceFileNames),void 0!==t.metadataFolderPath&&(this._metadataFolderPath=t.metadataFolderPath))};S.prototype.getTotalAnimationTimeMinutes=function(){return this.timeInterval_min*this._timeSlicesArray.length},S.prototype._load_indexFile=function(e){if(this._geoJsonIndexFileLoadState===I.fileLoadState.READY){this._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_STARTED;var t=this;rn(this._geoJsonIndexFilePath,void 0,void 0,"json","GET").done(function(e){t._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,t._geoJsonIndexFile=e})}},S.prototype._makeSimulationBox=function(){this.chemicalAccidentManager.magoManager;var e=this.chemicalAccidentManager._geoJsonIndexFile,t=(e.centerGeographicCoord,1e3*e.width_km/2),r=1e3*e.height_km/2,i=[],o=new Kr(-t,-r);i.push(o),o=new Kr(t,-r),i.push(o),o=new Kr(t,r),i.push(o),o=new Kr(-t,r),i.push(o);var n=ii.fromPoint2DArray(i),a=this._timeSlicesArray[0].getTotalMinMaxAltitudes(),s=a[1]-a[0],l=jr.getExtrudedMesh(n,s,1,void 0,void 0,void 0,void 0);this.simulationBox||(this.simulationBox=new ho),this.simulationBox.geoLocDataManager=new ye;var u=this.simulationBox.geoLocDataManager.newGeoLocationData(),c=this.geoLocDataManager.getCurrentGeoLocationData();u.copyFrom(c),this.simulationBox.objectsArray.push(l)},S.prototype._getCuttingPlaneDepthFBO=function(){if(!this.cuttingPlaneDepthFBO){var e=this.chemicalAccidentManager.magoManager,t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.cuttingPlaneDepthFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.cuttingPlaneDepthFBO},S.prototype._getVolumeDepthFBO=function(){if(!this.volumeDepthFBO){var e=this.chemicalAccidentManager.magoManager,t=e.getGl(),r=e.sceneState,i=2*r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.volumeDepthFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeDepthFBO},S.prototype._getScreenFBO=function(e){if(!this.screenFBO){var t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.screenFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.screenFBO},S.prototype._renderDepthCuttingPlane=function(){if(0!==this.cuttingPlanesArray.length){var e=this.chemicalAccidentManager.magoManager,t=(e.sceneState,e.getGl()),r=e.extbuffers;this.visibleObjControler||(this.visibleObjControler=new _t);var i=this.currentActiveCuttingPlaneIdx;if(!(i<0)){var o=this.cuttingPlanesArray[i];o&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=o);var n=this._getCuttingPlaneDepthFBO(e);this.cuttingPlaneDepthTex=n.colorBuffersArray[1],this.cuttingPlaneNormalTex=n.colorBuffersArray[2],n.bind(),t.viewport(0,0,n.width[0],n.height[0]),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,n.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,n.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,n.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,n.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,0),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT),t.clearColor(0,0,0,1)),t.clear(t.DEPTH_BUFFER_BIT);t.frontFace(t.CCW),e.renderer.renderGeometryBuffer(t,1,this.visibleObjControler),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,null,0),n.unbind(),t.frontFace(t.CCW)}}},S.prototype._renderDepthVolume=function(){var e=this.chemicalAccidentManager.magoManager,t=(e.sceneState,e.getGl()),r=e.extbuffers;this.visibleObjControler||(this.visibleObjControler=new _t),this.simulationBox&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.simulationBox);var i=this._getVolumeDepthFBO(e);this.simulBoxdoubleDepthTex=i.colorBuffersArray[1],this.simulBoxDoubleNormalTex=i.colorBuffersArray[2],i.bind(),t.viewport(0,0,i.width[0]/2,i.height[0]),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,0),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT),t.clearColor(0,0,0,1)),t.clear(t.DEPTH_BUFFER_BIT);var o=1;t.frontFace(t.CCW),e.renderer.renderGeometryBuffer(t,o,this.visibleObjControler),t.viewport(i.width[0]/2,0,i.width[0]/2,i.height[0]);o=1;t.frontFace(t.CW),e.renderer.renderGeometryBuffer(t,o,this.visibleObjControler),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,null,0),i.unbind(),t.frontFace(t.CCW)},S.prototype._makeTextures=function(e,t){for(var r=!0,i=this._timeSlicesArray.length,o=0;o<i;o++){this._timeSlicesArray[o]._makeTextures(e,t)||(r=!1)}return r},S.prototype.getTimeSliceIdxByCurrentUnixTimeMiliseconds=function(e){for(var t=this._timeSlicesArray.length,r=-1,i=0;i<t;i++){var o=this._timeSlicesArray[i];if(e>=o._startUnixTimeMiliseconds&&e<=o._endUnixTimeMiliseconds){r=i;break}}return r},S.prototype.getCuttingPlanesCount=function(){return this.cuttingPlanesArray.length},S.prototype.setUseMinMaxValuesToRender=function(e){this.useMinMaxValuesToRender=e},S.prototype.getCurrentCuttingPlaneIdx=function(){return this.currentActiveCuttingPlaneIdx},S.prototype.setCurrentCuttingPlaneIdx=function(e){this.currentActiveCuttingPlaneIdx=e},S.prototype.setMinMaxValuesToRender=function(e,t){this.minMaxPollutionValuesToRender[0]=e,this.minMaxPollutionValuesToRender[1]=t},S.prototype.createCuttingPlaneXZ=function(){var e=this.chemicalAccidentManager._geoJsonIndexFile,t=(e.centerGeographicCoord,1e3*e.width_km/2),r=(e.height_km,[]),i=new Kr(-t,0);r.push(i),i=new Kr(t,0),r.push(i);var o=ii.fromPoint2DArray(r),n=this._timeSlicesArray[0].getTotalMinMaxAltitudes(),a=n[1]-n[0],s=jr.getExtrudedPlane(o,a,1,void 0,!1,!1,void 0),l=this.geoLocDataManager.getCurrentGeoLocationData(),u=new ho;u.attributes.isMovable=!0,u.attributes.isSelectable=!0,u.attributes.movementInAxisY=!0,u.setOneColor(.2,.2,.7,.1),u.setSelectedColor4(.2,.2,.7,.1),u.geoLocDataManager=new ye,u.geoLocDataManager.newGeoLocationData().copyFrom(l),u.objectsArray.push(s);this.chemicalAccidentManager.magoManager.modeler.addObject(u,5),this.cuttingPlanesArray.push(u)},S.prototype.createCuttingPlaneYZ=function(){var e=this.chemicalAccidentManager._geoJsonIndexFile,t=(e.centerGeographicCoord,e.width_km,1e3*e.height_km/2),r=[],i=new Kr(0,-t);r.push(i),i=new Kr(0,t),r.push(i);var o=ii.fromPoint2DArray(r),n=this._timeSlicesArray[0].getTotalMinMaxAltitudes(),a=n[1]-n[0],s=jr.getExtrudedPlane(o,a,1,void 0,!1,!1,void 0),l=this.geoLocDataManager.getCurrentGeoLocationData(),u=new ho;u.attributes.isMovable=!0,u.attributes.isSelectable=!0,u.attributes.movementInAxisX=!0,u.setOneColor(.2,.2,.7,.1),u.setSelectedColor4(.2,.2,.7,.1),u.geoLocDataManager=new ye,u.geoLocDataManager.newGeoLocationData().copyFrom(l),u.objectsArray.push(s);this.chemicalAccidentManager.magoManager.modeler.addObject(u,5),this.cuttingPlanesArray.push(u)},S.prototype.createCuttingPlaneXY=function(){var e=this.chemicalAccidentManager._geoJsonIndexFile,t=(e.centerGeographicCoord,1e3*e.width_km/2),r=1e3*e.height_km/2,i=[],o=new Kr(-t,-r);i.push(o),o=new Kr(t,-r),i.push(o),o=new Kr(t,r),i.push(o),o=new Kr(-t,r),i.push(o);var n=ii.fromPoint2DArray(i),a=this._timeSlicesArray[0].getTotalMinMaxAltitudes(),s=jr.getExtrudedMesh(n,1,1,void 0,!0,!0,void 0),l=this.geoLocDataManager.getCurrentGeoLocationData(),u=new ho;u.attributes.isMovable=!0,u.attributes.isSelectable=!0,u.attributes.movementInAxisZ=!0,u.setOneColor(.2,.2,.7,.1),u.setSelectedColor4(.2,.2,.7,.1),u.attributes.minAltitude=20,u.attributes.maxAltitude=a[1],u.geoLocDataManager=new ye,u.geoLocDataManager.newGeoLocationData().copyFrom(l);var c=this.chemicalAccidentManager.magoManager;u.changeLocationAndRotation(void 0,void 0,2e3,void 0,void 0,void 0,c),u.objectsArray.push(s);c.modeler.addObject(u,5),this.cuttingPlanesArray.push(u)},S.prototype.render=function(){void 0===this.simulationBox&&this._makeSimulationBox(),0===this.cuttingPlanesArray.length&&(this.createCuttingPlaneYZ(),this.createCuttingPlaneXZ(),this.createCuttingPlaneXY()),void 0===this.renderCounter&&(this.renderCounter=0),this.renderCounter+=1;var e=this.chemicalAccidentManager.magoManager,t=e.animationTimeController,r=e.getGl(),i=this.getTimeSliceIdxByCurrentUnixTimeMiliseconds(t._currentUnixTimeMilisec);i>this._timeSlicesArray.length-1?i=this._timeSlicesArray.length-1:i<0&&(i=0),this.chemicalAccidentManager.counterAux,0===this.chemicalAccidentManager.counterAux?this.testCurrIdx=i:void 0===this.counterTest&&(this.counterTest=this.renderCounter),this._renderDepthVolume(),this.cuttingPlanesArray.length>0&&this._renderDepthCuttingPlane();var o=this.chemicalAccidentManager,n=e.sceneState,a=this._getScreenFBO(e),s=a.extbuffers;this.volumRenderTex=a.colorBuffersArray[0],a.bind(),r.viewport(0,0,a.width[0],a.height[0]);var l=o.getQuadBuffer(),u=e.postFxShadersManager.getShader("volumetric");e.postFxShadersManager.useProgram(u),r.framebufferTexture2D(r.FRAMEBUFFER,s.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,a.colorBuffersArray[0],0),r.framebufferTexture2D(r.FRAMEBUFFER,s.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,a.colorBuffersArray[1],0),r.framebufferTexture2D(r.FRAMEBUFFER,s.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,a.colorBuffersArray[2],0),r.framebufferTexture2D(r.FRAMEBUFFER,s.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,a.colorBuffersArray[3],0),this.volumRenderTex=a.colorBuffersArray[0],s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.COLOR_ATTACHMENT1_WEBGL,s.COLOR_ATTACHMENT2_WEBGL,s.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(r.clearColor(0,0,0,0),r.clearDepth(1),r.clear(r.COLOR_BUFFER_BIT),r.clearColor(0,0,0,1)),r.clear(r.DEPTH_BUFFER_BIT),ae.bindAttribute(r,l.posBuffer,u.a_pos_loc,2),r.disable(r.BLEND),r.enable(r.DEPTH_TEST);var c=(b=this._timeSlicesArray[this.testCurrIdx])._mosaicTexture;u.bindUniformGenerals();l=o.getQuadBuffer();ae.bindAttribute(r,l.posBuffer,u.a_pos_loc,2),r.uniform1iv(u.u_texSize_loc,[c.texture3DXSize,c.texture3DYSize,c.texture3DZSize]),r.uniform1iv(u.u_mosaicSize_loc,[c.mosaicXCount,c.mosaicYCount,c.finalSlicesCount]);var d=n.getModelViewRelToEyeMatrixInv();r.uniformMatrix4fv(u.modelViewMatrixRelToEyeInv_loc,!1,d._floatArrays);var h=this.getMinMaxPollutionValues();r.uniform2fv(u.u_minMaxPollutionValues_loc,[h[0],h[1]]),r.uniform2fv(u.u_minMaxPollutionValuesToRender_loc,this.minMaxPollutionValuesToRender),r.uniform1f(u.u_airEnvirontmentPressure_loc,0),r.uniform2fv(u.u_screenSize_loc,[n.drawingBufferWidth[0],n.drawingBufferHeight[0]]),r.uniform2fv(u.uNearFarArray_loc,e.frustumVolumeControl.nearFarArray),r.uniform3fv(u.u_voxelSizeMeters_loc,[this.oneVoxelSizeInMeters[0],this.oneVoxelSizeInMeters[1],this.oneVoxelSizeInMeters[2]]);var f=(m=this.simulationBox.geoLocDataManager.getCurrentGeoLocationData()).getRotMatrixInv();r.uniformMatrix4fv(u.u_simulBoxTMat_loc,!1,m.rotMatrix._floatArrays),r.uniformMatrix4fv(u.u_simulBoxTMatInv_loc,!1,f._floatArrays),r.uniform3fv(u.u_simulBoxPosHigh_loc,m.positionHIGH),r.uniform3fv(u.u_simulBoxPosLow_loc,m.positionLOW);var g=this.simulationBox.getBoundingBoxLC();r.uniform3fv(u.u_simulBoxMinPosLC_loc,[g.minX,g.minY,g.minZ]),r.uniform3fv(u.u_simulBoxMaxPosLC_loc,[g.maxX,g.maxY,g.maxZ]),r.uniform2fv(u.uMinMaxAltitudeSlices_loc,b.uMinMaxAltitudeSlices),r.uniform1i(u.u_useMinMaxValuesToRender_loc,this.useMinMaxValuesToRender);var p=!1;if(this.currentActiveCuttingPlaneIdx>=0&&this.currentActiveCuttingPlaneIdx<this.cuttingPlanesArray.length){p=!0;for(var m,v=(m=(C=this.cuttingPlanesArray[this.currentActiveCuttingPlaneIdx]).geoLocDataManager.getCurrentGeoLocationData()).position,x=this.simulationBox.geoLocDataManager.getCurrentGeoLocationData().worldCoordToLocalCoord(v,void 0),_=this.cuttingPlanesArray.length,y=0;y<_;y++){void 0!==(C=this.cuttingPlanesArray[y])&&(C.attributes.isVisible=!1)}this.cuttingPlanesArray[this.currentActiveCuttingPlaneIdx].attributes.isVisible=!0;var T=0;0===this.currentActiveCuttingPlaneIdx?T=.1:1===this.currentActiveCuttingPlaneIdx?T=.2:2===this.currentActiveCuttingPlaneIdx&&(T=.3),r.uniform4fv(u.u_cuttingPlanePosLC_loc,[x.x,x.y,x.z,T])}else for(_=this.cuttingPlanesArray.length,y=0;y<_;y++){var C;void 0!==(C=this.cuttingPlanesArray[y])&&(C.attributes.isVisible=!1)}r.uniform1i(u.u_cuttingPlaneIdx_loc,this.currentActiveCuttingPlaneIdx),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.simulBoxdoubleDepthTex),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.simulBoxDoubleNormalTex);var b=this._timeSlicesArray[this.testCurrIdx];r.activeTexture(r.TEXTURE2);var M=b._mosaicTexture.getTexture(0);r.bindTexture(r.TEXTURE_2D,M),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,e.depthTex),r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,e.normalTex),p&&(r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,this.cuttingPlaneDepthTex),r.activeTexture(r.TEXTURE6),r.bindTexture(r.TEXTURE_2D,this.cuttingPlaneNormalTex)),r.drawArrays(r.TRIANGLES,0,6),r.framebufferTexture2D(r.FRAMEBUFFER,s.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,s.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,s.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,s.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0);for(y=0;y<8;y++)r.activeTexture(r.TEXTURE0+y),r.bindTexture(r.TEXTURE_2D,null);a.unbind()},S.prototype.getContaminationValue=function(e,t){if(this._prepareLayer()){var r=this.simulationBox.geoLocDataManager.getCurrentGeoLocationData().worldCoordToLocalCoord(e,void 0);r.z<0&&(r.z=0);var i=this.getTimeSliceIdxByCurrentUnixTimeMiliseconds(t);if(!(i<0)){var o=this.chemicalAccidentManager.magoManager.getGl(),n=this._timeSlicesArray[i],a=1e3*this.chemicalAccidentManager._geoJsonIndexFile.width_km,s=1e3*this.chemicalAccidentManager._geoJsonIndexFile.height_km;return n.getContaminationValue(r,a,s,o)}}},S.prototype.getMinMaxPollutionValues=function(){if(void 0===this.minMaxPollutionValues){this.minMaxPollutionValues=new Float32Array(2);for(var e=this._timeSlicesArray.length,t=0;t<e;t++){var r=this._timeSlicesArray[t].getMinMaxPollutionValues();0===t?(this.minMaxPollutionValues[0]=r[0],this.minMaxPollutionValues[1]=r[1]):(r[0]<this.minMaxPollutionValues[0]&&(this.minMaxPollutionValues[0]=r[0]),r[1]>this.minMaxPollutionValues[1]&&(this.minMaxPollutionValues[1]=r[1]))}}return this.minMaxPollutionValues},S.prototype._prepareLayer=function(){if(this._isPrepared)return!0;if(void 0===this._timeSlicesArray&&(this._timeSlicesArray=[]),0===this._timeSlicesArray.length){var e=(E=this.chemicalAccidentManager._geoJsonIndexFile).year,t=E.month-1,r=E.day,i=E.hour,o=E.minute,n=E.second,a=E.millisecond,s=0,l=E.timeInterval,u=E.timeIntervalUnits;"minutes"!==u&&"minute"!==u||(s=60*l*1e3);for(var c=new Date(e,t,r,i,o,n,a).getTime(),d=E.mosaicTexMetaDataJsonArray.length,h=0;h<d;h++){var f=c+h*s;(v=new w(x={owner:this,startUnixTimeMiliseconds:f,endUnixTimeMiliseconds:f+s}))._jsonFile=E.mosaicTexMetaDataJsonArray[h],v._fileLoadState=I.fileLoadState.LOADING_FINISHED,this._timeSlicesArray.push(v)}return!1}var g=!0,p=this._timeSlicesArray.length,m=0;for(h=0;h<p;h++){var v;if((v=this._timeSlicesArray[h])._prepare(this)||(g=!1,m++),m>2)break}if(!g)return!1;if(!this.voxelizer){var x={};this.voxelizer=new Pi(x)}if(!this.oneVoxelSizeInMeters){this.oneVoxelSizeInMeters=new Float32Array([1,1,1]);var _=this._timeSlicesArray[0],y=1e3*(E=this.chemicalAccidentManager._geoJsonIndexFile).height_km,T=1e3*E.width_km,C=_._jsonFile.dataSlices[0],b=C.width,M=C.height;this.oneVoxelSizeInMeters[0]=y/b,this.oneVoxelSizeInMeters[1]=T/M,this.oneVoxelSizeInMeters[2]=this.oneVoxelSizeInMeters[0]}if(!this._allTimeSlicesTextures3DReady){void 0===this.minMaxPollutionValues&&(this.minMaxPollutionValues=new Float32Array(2));_=this._timeSlicesArray[0];this.minMaxPollutionValues[0]=_._jsonFile.minValue,this.minMaxPollutionValues[1]=_._jsonFile.maxValue;var A=this.chemicalAccidentManager.magoManager.sceneState.gl;this._makeTextures(A,this.minMaxPollutionValues)}if(0===this._timeSlicesArray.length)return!1;if(void 0===this._terrainSampled&&(this._terrainSampled=!1),void 0===this.geoLocDataManager){var E,L=(E=this.chemicalAccidentManager._geoJsonIndexFile).centerGeographicCoord;this.geoLocDataManager=new ye;var S=this.geoLocDataManager.getCurrentGeoLocationData();void 0===S&&(S=this.geoLocDataManager.newGeoLocationData("default"));S=on.calculateGeoLocationData(L.longitude,L.latitude,L.altitude,0,0,0,S)}return this.simulationBox||this._makeSimulationBox(),this._isPrepared=!0,this._isPrepared};var D=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager,this.chemAccidentLayersArray,this._geoJsonIndexFileLoadState=I.fileLoadState.READY,this._geoJsonIndexFile,this._geoJsonIndexFilePath=void 0,this._geoJsonIndexFileFolderPath,this._allLayersArePrepared=!1,this._animationState=I.processState.NO_STARTED,this._animationStartTime=0,this._totalAnimTime,this._increTime,this.volumePrepared=!1,this.counterAux=0,t&&(t.magoManager&&(this.magoManager=t.magoManager),t.geoJsonIndexFilePath&&(this._geoJsonIndexFilePath=t.geoJsonIndexFilePath),t.geoJsonIndexFileFolderPath&&(this._geoJsonIndexFileFolderPath=t.geoJsonIndexFileFolderPath),void 0!==t.animationSpeed&&(this._animationSpeed=t.animationSpeed)),this.test_started=!1,this.init()};function R(e){if(!(this instanceof R))throw new Error(Ue.CONSTRUCT_ERROR);this.magoEnable=!0,this.returnable=!1,this.apiName=e,this.projectId=null,this.projectDataFolder=null,this.objectIds=null,this.dataKey=null,this.issueId=null,this.issueType=null,this.drawType=0,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.property=null,this.color=0,this.blockType=null,this.showOutFitting=!1,this.showLabelInfo=!0,this.showOrigin=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarDistance=0,this.objectMoveMode=I.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.insertIssueState=0,this.lod0DistInMeters=null,this.lod1DistInMeters=null,this.lod2DistInMeters=null,this.lod3DistInMeters=null,this.lod4DistInMeters=null,this.lod5DistInMeters=null,this.ambientReflectionCoef=null,this.diffuseReflectionCoef=null,this.specularReflectionCoef=null,this.ambientColor=null,this.specularColor=null,this.ssaoRadius=null,this.FPVMode=!1,this.inputPoint=null,this.resultPoint=null,this.magoMode=I.magoMode.NORMAL,this.unit=I.units.DEGREE,this.instantiateObj=null,this.staticModelAttributeObj=null,this.animationOption=null,this.trackOption=null,this.nodeAttribute=null}D.prototype.init=function(){this.test_started=!1},D.prototype.getChemicalAccidentLayersCount=function(){return void 0===this.chemAccidentLayersArray?0:this.chemAccidentLayersArray.length},D.prototype.getChemicalAccidentLayer=function(e){if(void 0!==this.chemAccidentLayersArray&&!(e<0||e>=this.chemAccidentLayersArray.length))return this.chemAccidentLayersArray[e]},D.prototype.newChemAccidentLayer=function(e){if(this.chemAccidentLayersArray||(this.chemAccidentLayersArray=[]),void 0===e)return!1;e.chemicalAccidentManager=this;var t=new S(e);return this.chemAccidentLayersArray.push(t),t},D.prototype._loadGeoJsonIndexFile=function(){if(this._geoJsonIndexFileLoadState===I.fileLoadState.READY){this._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._geoJsonIndexFilePath,void 0,void 0,"json","GET").done(function(t){e._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,e._geoJsonIndexFile=t})}},D.prototype._loadPngsBinaryBlockData=function(e,t){if(e.fileLoadState===I.fileLoadState.READY){e.fileLoadState=I.fileLoadState.LOADING_STARTED;var r=e,i=t+"\\"+e.fileName;rn(i).done(function(e){r.fileLoadState=I.fileLoadState.LOADING_FINISHED,r.dataArraybuffer=e})}},D.prototype._preparePollutionGeoJsonIndexFile=function(){return this._geoJsonIndexFileLoadState===I.fileLoadState.READY?(this._loadGeoJsonIndexFile(),!1):this._geoJsonIndexFileLoadState===I.fileLoadState.LOADING_FINISHED},D.prototype.getBlobArrayBuffer=function(e){if(void 0!==this.map_pngOriginalFileName_pngsBinData){var t=this.map_pngOriginalFileName_pngsBinData[e];if(void 0!==t)for(var r=this.pngsBinBlocksArray.length,i=0;i<r;i++){var o=this.pngsBinBlocksArray[i];if(o.fileName===t.pngsBinaryBlockDataFileName){var n=t.startByteIndex,a=t.endByteIndex;return o.dataArraybuffer.slice(n,a)}}}},D.prototype._preparePollutionLayers=function(e){if(!0===this._allLayersArePrepared)return!0;if(void 0===this._geoJsonIndexFile)return!1;if(void 0!==this._geoJsonIndexFile.pngsBinBlockFileNames){var t=this._geoJsonIndexFile.pngsBinBlockFileNames,r=t.length;if(void 0===this.pngsBinBlocksArray){this.pngsBinBlocksArray=[];for(var i=0;i<r;i++){var o={fileName:t[i].fileName,dataArraybuffer:void 0,fileLoadState:I.fileLoadState.READY};this.pngsBinBlocksArray.push(o)}}var n=!0,a=0;for(i=0;i<r;i++){if((o=this.pngsBinBlocksArray[i]).fileLoadState===I.fileLoadState.READY?(this._loadPngsBinaryBlockData(o,this._geoJsonIndexFileFolderPath),a+=1):o.fileLoadState!==I.fileLoadState.LOADING_FINISHED&&(a+=1,n=!1),a>0)return!1}if(!n)return!1;if(void 0===this.map_pngOriginalFileName_pngsBinData){this.map_pngOriginalFileName_pngsBinData={};var s=this._geoJsonIndexFile.pngsBinDataArray.length;for(i=0;i<s;i++){var l=this._geoJsonIndexFile.pngsBinDataArray[i];this.map_pngOriginalFileName_pngsBinData[l.originalPngFileName]=l}}}if(void 0===this.chemAccidentLayersArray&&(this.chemAccidentLayersArray=[]),0===(h=this.chemAccidentLayersArray.length)){var u=this._geoJsonIndexFileFolderPath;for(i=0;i<1;i++){var c={pollutionVolumeOwner:this,mosaicTexMetaDataJsonsArray:this._geoJsonIndexFile.mosaicTexMetaDataJsonArray,metadataFolderPath:u};this.newChemAccidentLayer(c)}}var d=!0,h=this.chemAccidentLayersArray.length;for(i=0;i<h;i++){this.chemAccidentLayersArray[i]._prepareLayer()||(d=!1)}return this._allLayersArePrepared=d,!1},D.prototype.prepareVolume=function(e){return!!this.volumePrepared||!!this._preparePollutionGeoJsonIndexFile()&&(this._createdShaders?!!this._preparePollutionLayers()&&(this.volumePrepared=!0,this.pngsBinBlocksArray=void 0,!1):(this.createDefaultShaders(),this._createdShaders=!0,!1))},D.prototype.render=function(){if(!this._geoJsonIndexFilePath)return!1;var e=this.magoManager;if(!this.prepareVolume(e))return!1;if(this._animationState===I.processState.FINISHED||this._animationState===I.processState.NO_STARTED)return!0;e.animationTimeController._animationState===I.processState.NO_STARTED&&e.animationTimeController.startAnimation();for(var t=this.chemAccidentLayersArray.length,r=0;r<t;r++){this.chemAccidentLayersArray[r].render(e)}var i=e.getGl(),o=e.sceneState;e.bindMainFramebuffer(),i.viewport(0,0,o.drawingBufferWidth[0],o.drawingBufferHeight[0])},D.prototype._newTexture=function(e,t,r){var i=new Uint8Array(t*r*4),o=e.NEAREST,n=it.createTexture(e,o,i,t,r),a=new it;return a.texId=n,a.fileLoadState=I.fileLoadState.BINDING_FINISHED,a.imageWidth=t,a.imageHeight=r,a},D.prototype.getQuadBuffer=function(){if(!this.screenQuad){var e=this.magoManager.getGl(),t=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r=ae.createBuffer(e,t);this.screenQuad={posBuffer:r}}return this.screenQuad},D.prototype.load_chemicalAccidentIndexFile=function(e){if(!this.test_started){this._geoJsonIndexFilePath=e}},D.prototype.createDefaultShaders=function(){var e=this.magoManager,t=e.getGl(),r="USE_LINEAR_DEPTH",i="NO_USE_MULTI_RENDER_TARGET";t.getParameter(t.VERSION);e.isCesiumGlobe()||(t.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&t.getExtension("EXT_frag_depth"),e.EXTENSIONS_init=!0,r="USE_LOGARITHMIC_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!0);if(e.postFxShadersManager.bUseMultiRenderTarget=!1,t.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){t.getExtension("WEBGL_draw_buffers");e.postFxShadersManager.bUseMultiRenderTarget=!0,i="USE_MULTI_RENDER_TARGET"}window.navigator.userAgent.indexOf("Trident")>-1&&(r="USE_LINEAR_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!1);var o="copyTextureIntoMosaic",n=Bo.quadVertTexCoordVS,a=Bo.soundCopyFS;a=(a=a.replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i);var s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager);s.a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.a_texcoord_loc=t.getAttribLocation(s.program,"a_texcoord"),s.texToCopy_loc=t.getUniformLocation(s.program,"texToCopy"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.texToCopy_loc,0),o="volumetric",n=Bo.waterQuadVertVS,a=(a=(a=Bo.chemicalAccidentVolumRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).simulationBoxDoubleDepthTex_loc=t.getUniformLocation(s.program,"simulationBoxDoubleDepthTex"),s.simulationBoxDoubleNormalTex_loc=t.getUniformLocation(s.program,"simulationBoxDoubleNormalTex"),s.pollutionMosaicTex_loc=t.getUniformLocation(s.program,"pollutionMosaicTex"),s.sceneDepthTex_loc=t.getUniformLocation(s.program,"sceneDepthTex"),s.sceneNormalTex_loc=t.getUniformLocation(s.program,"sceneNormalTex"),s.cuttingPlaneDepthTex_loc=t.getUniformLocation(s.program,"cuttingPlaneDepthTex"),s.cuttingPlaneNormalTex_loc=t.getUniformLocation(s.program,"cuttingPlaneNormalTex"),s.a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.uNearFarArray_loc=t.getUniformLocation(s.program,"uNearFarArray"),s.tangentOfHalfFovy_loc=t.getUniformLocation(s.program,"tangentOfHalfFovy"),s.aspectRatio_loc=t.getUniformLocation(s.program,"aspectRatio"),s.modelViewMatrixRelToEyeInv_loc=t.getUniformLocation(s.program,"modelViewMatrixRelToEyeInv"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_mosaicTexSize_loc=t.getUniformLocation(s.program,"u_mosaicTexSize"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_minMaxPollutionValues_loc=t.getUniformLocation(s.program,"u_minMaxPollutionValues"),s.u_airEnvirontmentPressure_loc=t.getUniformLocation(s.program,"u_airEnvirontmentPressure"),s.u_maxVelocity_loc=t.getUniformLocation(s.program,"u_maxVelocity"),s.u_voxelSizeMeters_loc=t.getUniformLocation(s.program,"u_voxelSizeMeters"),s.u_minMaxPollutionValuesToRender_loc=t.getUniformLocation(s.program,"u_minMaxPollutionValuesToRender"),s.u_cuttingPlaneIdx_loc=t.getUniformLocation(s.program,"u_cuttingPlaneIdx"),s.u_useMinMaxValuesToRender_loc=t.getUniformLocation(s.program,"u_useMinMaxValuesToRender"),s.u_cuttingPlanePosLC_loc=t.getUniformLocation(s.program,"u_cuttingPlanePosLC"),s.u_simulBoxTMat_loc=t.getUniformLocation(s.program,"u_simulBoxTMat"),s.u_simulBoxTMatInv_loc=t.getUniformLocation(s.program,"u_simulBoxTMatInv"),s.u_simulBoxPosHigh_loc=t.getUniformLocation(s.program,"u_simulBoxPosHigh"),s.u_simulBoxPosLow_loc=t.getUniformLocation(s.program,"u_simulBoxPosLow"),s.u_simulBoxMinPosLC_loc=t.getUniformLocation(s.program,"u_simulBoxMinPosLC"),s.u_simulBoxMaxPosLC_loc=t.getUniformLocation(s.program,"u_simulBoxMaxPosLC"),s.uMinMaxAltitudeSlices_loc=t.getUniformLocation(s.program,"uMinMaxAltitudeSlices"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.simulationBoxDoubleDepthTex_loc,0),t.uniform1i(s.simulationBoxDoubleNormalTex_loc,1),t.uniform1i(s.pollutionMosaicTex_loc,2),t.uniform1i(s.sceneDepthTex_loc,3),t.uniform1i(s.sceneNormalTex_loc,4),t.uniform1i(s.cuttingPlaneDepthTex_loc,5),t.uniform1i(s.cuttingPlaneNormalTex_loc,6),e.postFxShadersManager.useProgram(null)},R.prototype.getMagoEnable=function(){return this.magoEnable},R.prototype.setMagoEnable=function(e){this.magoEnable=e},R.prototype.getReturnable=function(){return this.returnable},R.prototype.setReturnable=function(e){this.returnable=e},R.prototype.getAPIName=function(){return this.apiName},R.prototype.getProjectId=function(){return this.projectId},R.prototype.setProjectId=function(e){this.projectId=e},R.prototype.getProjectDataFolder=function(){return this.projectDataFolder},R.prototype.setProjectDataFolder=function(e){this.projectDataFolder=e},R.prototype.getObjectIds=function(){return this.objectIds},R.prototype.setObjectIds=function(e){this.objectIds=e},R.prototype.getIssueId=function(){return this.issueId},R.prototype.setIssueId=function(e){this.issueId=e},R.prototype.getIssueType=function(){return this.issueType},R.prototype.setIssueType=function(e){this.issueId=e},R.prototype.getDataKey=function(){return this.dataKey},R.prototype.setDataKey=function(e){this.dataKey=e},R.prototype.getLatitude=function(){return this.latitude},R.prototype.setLatitude=function(e){this.latitude=e},R.prototype.getLongitude=function(){return this.longitude},R.prototype.setLongitude=function(e){this.longitude=e},R.prototype.getElevation=function(){return this.elevation},R.prototype.setElevation=function(e){this.elevation=e},R.prototype.getHeading=function(){return this.heading},R.prototype.setHeading=function(e){this.heading=e},R.prototype.getPitch=function(){return this.pitch},R.prototype.setPitch=function(e){this.pitch=e},R.prototype.getRoll=function(){return this.roll},R.prototype.setRoll=function(e){this.roll=e},R.prototype.getProperty=function(){return this.property},R.prototype.setProperty=function(e){this.property=e},R.prototype.getColor=function(){return this.color},R.prototype.setColor=function(e){this.color=e},R.prototype.getBlockType=function(){return this.blockType},R.prototype.setBlockType=function(e){this.blockType=e},R.prototype.getShowOutFitting=function(){return this.showOutFitting},R.prototype.setShowOutFitting=function(e){this.showOutFitting=e},R.prototype.getShowLabelInfo=function(){return this.showLabelInfo},R.prototype.setShowLabelInfo=function(e){this.showLabelInfo=e},R.prototype.getShowOrigin=function(){return this.showOrigin},R.prototype.setShowOrigin=function(e){this.showOrigin=e},R.prototype.getShowBoundingBox=function(){return this.showBoundingBox},R.prototype.setShowBoundingBox=function(e){this.showBoundingBox=e},R.prototype.getShowShadow=function(){return this.showShadow},R.prototype.setShowShadow=function(e){this.showShadow=e},R.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},R.prototype.setFrustumFarDistance=function(e){this.frustumFarDistance=e},R.prototype.getObjectMoveMode=function(){return this.objectMoveMode},R.prototype.setObjectMoveMode=function(e){this.objectMoveMode=e},R.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},R.prototype.setIssueInsertEnable=function(e){this.issueInsertEnable=e},R.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},R.prototype.setObjectInfoViewEnable=function(e){this.objectInfoViewEnable=e},R.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},R.prototype.setOcclusionCullingEnable=function(e){this.occlusionCullingEnable=e},R.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},R.prototype.setNearGeoIssueListEnable=function(e){this.nearGeoIssueListEnable=e},R.prototype.getInsertIssueState=function(){return this.insertIssueState},R.prototype.setInsertIssueState=function(e){this.insertIssueState=e},R.prototype.getDrawType=function(){return this.drawType},R.prototype.setDrawType=function(e){this.drawType=e},R.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},R.prototype.setLod0DistInMeters=function(e){this.lod0DistInMeters=e},R.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},R.prototype.setLod1DistInMeters=function(e){this.lod1DistInMeters=e},R.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},R.prototype.setLod2DistInMeters=function(e){this.lod2DistInMeters=e},R.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},R.prototype.setLod3DistInMeters=function(e){this.lod3DistInMeters=e},R.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},R.prototype.setLod4DistInMeters=function(e){this.lod4DistInMeters=e},R.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},R.prototype.setLod5DistInMeters=function(e){this.lod5DistInMeters=e},R.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},R.prototype.setAmbientReflectionCoef=function(e){this.ambientReflectionCoef=e},R.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},R.prototype.setDiffuseReflectionCoef=function(e){this.diffuseReflectionCoef=e},R.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},R.prototype.setSpecularReflectionCoef=function(e){this.specularReflectionCoef=e},R.prototype.getAmbientColor=function(){return this.ambientColor},R.prototype.setAmbientColor=function(e){this.ambientColor=e},R.prototype.getSpecularColor=function(){return this.specularColor},R.prototype.setSpecularColor=function(e){this.specularColor=e},R.prototype.getSsaoRadius=function(){return this.ssaoRadius},R.prototype.setSsaoRadius=function(e){this.ssaoRadius=e},R.prototype.getFPVMode=function(){return this.FPVMode},R.prototype.setFPVMode=function(e){this.FPVMode=e},R.prototype.getMagoMode=function(){return this.magoMode},R.prototype.setMagoMode=function(e){this.magoMode=e},R.prototype.getDuration=function(){return this.duration},R.prototype.setDuration=function(e){this.duration=e},R.prototype.getInputPoint=function(){return this.inputPoint},R.prototype.setInputPoint=function(e){this.inputPoint=e},R.prototype.getResultPoint=function(){return this.resultPoint},R.prototype.setResultPoint=function(e){this.resultPoint=e},R.prototype.getUnit=function(){return this.unit},R.prototype.setUnit=function(e){if(void 0!==e){if(isNaN(e)||e>I.units.RADIAN)throw new Error("unit parameter needs CODE.units");this.unit=e}},R.prototype.getInstantiateObj=function(){return this.instantiateObj},R.prototype.setInstantiateObj=function(e){this.instantiateObj=e},R.prototype.getStaticModelAttributeObj=function(){return this.staticModelAttributeObj},R.prototype.setStaticModelAttributeObj=function(e){this.staticModelAttributeObj=e},R.prototype.getAnimationOption=function(){return this.animationOption},R.prototype.setAnimationOption=function(e){this.animationOption=e},R.prototype.getTrackOption=function(){return this.trackOption},R.prototype.setTrackOption=function(e){this.trackOption=e},R.prototype.getNodeAttribute=function(){return this.nodeAttribute},R.prototype.setNodeAttribute=function(e){this.nodeAttribute=e};var P=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.moveHistory=!1,this.colorHistory=!1,this.rotationHistory=!1,this.objectMoveMode=null,this.projectId=null,this.projectDataFolder=null,this.dataKey=null,this.objectId=null,this.objectIndexOrder=0,this.refObjectAditionalMove,this.refObjectAditionalMoveRelToBuilding,this.latitude=0,this.longitude=0,this.elevation=0,this.heading=0,this.pitch=0,this.roll=0,this.duration=0,this.color=0,this.rgbColor=[],this.property=null,this.propertyKey=null,this.propertyValue=null};P.prototype.getReferenceObjectAditionalMovement=function(){return void 0===this.refObjectAditionalMove&&(this.refObjectAditionalMove=new Jr),this.refObjectAditionalMove},P.prototype.getReferenceObjectAditionalMovementRelToBuilding=function(){return void 0===this.refObjectAditionalMoveRelToBuilding&&(this.refObjectAditionalMoveRelToBuilding=new Jr),this.refObjectAditionalMoveRelToBuilding},P.prototype.getProjectId=function(){return this.projectId},P.prototype.setProjectId=function(e){this.projectId=e},P.prototype.getProjectDataFolder=function(){return this.projectDataFolder},P.prototype.setProjectDataFolder=function(e){this.projectDataFolder=e},P.prototype.getDataKey=function(){return this.dataKey},P.prototype.setDataKey=function(e){this.dataKey=e},P.prototype.getObjectId=function(){return this.objectId},P.prototype.setObjectId=function(e){this.objectId=e},P.prototype.getObjectIndexOrder=function(){return this.objectIndexOrder},P.prototype.setObjectIndexOrder=function(e){this.objectIndexOrder=e},P.prototype.getLatitude=function(){return this.latitude},P.prototype.setLatitude=function(e){this.latitude=e},P.prototype.getLongitude=function(){return this.longitude},P.prototype.setLongitude=function(e){this.longitude=e},P.prototype.getElevation=function(){return this.elevation},P.prototype.setElevation=function(e){this.elevation=e},P.prototype.getHeading=function(){return this.heading},P.prototype.setHeading=function(e){this.heading=e},P.prototype.getPitch=function(){return this.pitch},P.prototype.setPitch=function(e){this.pitch=e},P.prototype.getRoll=function(){return this.roll},P.prototype.setRoll=function(e){this.roll=e},P.prototype.getColor=function(){return this.color},P.prototype.setColor=function(e){this.color=e},P.prototype.getRgbColor=function(){return this.rgbColor},P.prototype.setRgbColor=function(e){this.rgbColor=e},P.prototype.getProperty=function(){return this.property},P.prototype.setProperty=function(e){this.property=e},P.prototype.getPropertyKey=function(){return this.propertyKey},P.prototype.setPropertyKey=function(e){this.propertyKey=e},P.prototype.getPropertyValue=function(){return this.propertyValue},P.prototype.setPropertyValue=function(e){this.propertyValue=e},P.prototype.getDuration=function(){return this.duration},P.prototype.setDuration=function(e){this.duration=e},P.prototype.getObjectMoveMode=function(){return this.objectMoveMode},P.prototype.setObjectMoveMode=function(e){this.objectMoveMode=e};var I={magoManagerState:{INIT:0,STARTED:1,READY:2},fileLoadState:{READY:0,LOADING_STARTED:1,LOADING_FINISHED:2,PARSE_STARTED:3,PARSE_FINISHED:4,IN_QUEUE:5,IN_PARSE_QUEUE:6,BINDING_STARTED:7,BINDING_FINISHED:8,LOAD_FAILED:9},moveMode:{ALL:"0",OBJECT:"1",GEOGRAPHICPOINTS:"2",NONE:"3"},magoMode:{NORMAL:0,DRAWING:1},magoCurrentProcess:{Unknown:0,DepthRendering:1,ColorRendering:2,ColorCodeRendering:3,DepthShadowRendering:4,SilhouetteDepthRendering:5,StencilSilhouetteRendering:6},modelerMode:{INACTIVE:0,DRAWING_POLYLINE:1,DRAWING_PLANEGRID:2,DRAWING_GEOGRAPHICPOINTS:3,DRAWING_EXCAVATIONPOINTS:4,DRAWING_TUNNELPOINTS:5,DRAWING_BSPLINE:6,DRAWING_BASICFACTORY:7,DRAWING_STATICGEOMETRY:8,DRAWING_PIPE:9,DRAWING_SPHERE:10,DRAWING_BOX:11,DRAWING_CUTTINGPLANE:12,DRAWING_CLIPPINGBOX:13,DRAWING_CONCENTRICTUBES:14,DRAWING_TUBE:15,DRAWING_FREECONTOURWALL:16,DRAWING_CYLYNDER:17},boxFace:{UNKNOWN:0,LEFT:1,RIGHT:2,FRONT:3,REAR:4,TOP:5,BOTTOM:6},modelerDrawingState:{NO_STARTED:0,STARTED:1},processState:{NO_STARTED:0,STARTED:1,FINISHED:2,PAUSED:3},modelerDrawingElement:{NOTHING:0,POINTS:1,LINES:2,POLYLINES:3,GEOGRAPHICPOINTS:4},units:{METRE:0,DEGREE:1,RADIAN:2},trackMode:{TRACKING:0,DRIVER:1},movementType:{NO_MOVEMENT:0,TRANSLATION:1,ROTATION:2,ROTATION_ZX:3},imageryType:{UNKNOWN:0,CRS84:1,WEB_MERCATOR:2},animationType:{UNKNOWN:0,REALTIME_POINTS:1,PATH:2},relativePosition2D:{UNKNOWN:0,LEFT:1,RIGHT:2,COINCIDENT:3},imageFilter:{UNKNOWN:0,BATHYMETRY:1,OCEANCOLOR_WATERMARKBYALPHA:2},cesiumTerrainType:{GEOSERVER:"geoserver",CESIUM_DEFAULT:"cesium-default",CESIUM_ION_DEFAULT:"cesium-ion-default",CESIUM_ION_CDN:"cesium-ion-cdn",CESIUM_CUSTOMER:"cesium-customer"},magoEarthTerrainType:{PLAIN:"plain",ELEVATION:"elevation",REALTIME:"realtime"},drawGeometryType:{POINT:"point",LINE:"line",POLYGON:"polygon",RECTANGLE:"rectangle"},PROJECT_ID_PREFIX:"projectId_",PROJECT_DATA_FOLDER_PREFIX:"projectDataFolder_",parametricCurveState:{NORMAL:0,EDITED:1},curveRenderingState:{NORMAL:0,EDITED:1},relativePositionPoint2DWithTriangle2D:{UNKNOWN:0,OUTSIDE:1,INSIDE:2,COINCIDENT_WITH_TRIANGLE_POINT:3,COINCIDENT_WITH_TRIANGLE_EDGE:4},relativePositionPoint2DWithSegment2D:{UNKNOWN:0,OUTSIDE:1,INSIDE:2,COINCIDENT_WITH_START_POINT:3,COINCIDENT_WITH_END_POINT:4},relativePositionSegment2DWithSegment2D:{UNKNOWN:0,NO_INTERSECTION:1,INTERSECTION:2},relativePositionSegment3DWithPlane2D:{UNKNOWN:0,NO_INTERSECTION:1,INTERSECTION:2,START_POINT_COINCIDENT:3,END_POINT_COINCIDENT:4,TWO_POINTS_COINCIDENT:5},status:{UNKNOWN:0,NORMAL:1,DELETED:2,HIGHLIGHTED:3},cardinal:{UNKNOWN:0,SOUTH:1,EAST:2,NORTH:3,WEST:4}},F={CESIUM:"cesium",WORLDWIND:"worldwind",MAGOWORLD:"magoworld",OBJECT_INDEX_FILE:"/objectIndexFile.ihe",TILE_INDEX_FILE:"/smartTile_f4d_indexFile.sii",CACHE_VERSION:"?cache_version=",SIMPLE_BUILDING_TEXTURE3x3_BMP:"/SimpleBuildingTexture3x3.bmp",RESULT_XDO2F4D:"/Result_xdo2f4d/Images/",RESULT_XDO2F4D_TERRAINTILES:"/Result_xdo2f4d/F4D_TerrainTiles/",RESULT_XDO2F4D_TERRAINTILEFILE_TXT:"/Result_xdo2f4d/f4dTerranTileFile.txt",INTERSECTION_OUTSIDE:0,INTERSECTION_INTERSECT:1,INTERSECTION_INSIDE:2,INTERSECTION_POINT_A:3,INTERSECTION_POINT_B:4,INTERSECTION_A_CONTAINS_B:5,INTERSECTION_B_CONTAINS_A:6},O=function(){this.containerId=void 0,this.serverPolicy=void 0,this.geoserver=void 0,this.dataObject={},this.selectHistoryObject={},this.movingHistoryObject={},this.colorHistoryObject={},this.locationAndRotationHistoryObject={},this.scriptRootPath=void 0,this.twoDimension=!1};O.prototype.setContainerId=function(e){this.containerId=e},O.prototype.getContainerId=function(){return this.containerId},O.prototype.getPolicy=function(){return this.serverPolicy},O.prototype.getGeoserver=function(){return this.geoserver},O.prototype.getData=function(e){return this.dataObject[e]},O.prototype.isDataExist=function(e){return this.dataObject.hasOwnProperty(e)},O.prototype.deleteData=function(e){return delete this.dataObject[e]},O.prototype.setData=function(e,t){this.isDataExist(e)||(this.dataObject[e]=t)},O.prototype.getProjectDataFolder=function(e){var t=I.PROJECT_DATA_FOLDER_PREFIX+e;return this.dataObject[t]},O.prototype.isProjectDataFolderExist=function(e){var t=I.PROJECT_DATA_FOLDER_PREFIX+e;return this.dataObject.hasOwnProperty(t)},O.prototype.deleteProjectDataFolder=function(e){var t=I.PROJECT_DATA_FOLDER_PREFIX+e;return delete this.dataObject[t]},O.prototype.setProjectDataFolder=function(e,t){var r=I.PROJECT_DATA_FOLDER_PREFIX+e;this.isProjectDataFolderExist(r)||(this.dataObject[r]=t)},O.prototype.init=function(e,t,r){if(!e||!e instanceof Object)throw new Error("geopolicy is required object.");if(this.dataObject={},this.selectHistoryObject={},this.movingHistoryObject={},this.colorHistoryObject={},this.locationAndRotationHistoryObject={},this.serverPolicy=e,this.scriptRootPath=function(){for(var e,t=/((?:.*\/)|^)(mago3d|mago3d.min)\.js\?(?:&?[^=&]*=[^=&]*)*/,r=/((?:.*\/)|^)(mago3d|mago3d.min)\.js$/,i=document.getElementsByTagName("script"),o=0,n=i.length;o<n;++o){var a=i[o].getAttribute("src"),s=r.exec(a),l=t.exec(a),u=s||l;null!==u&&(e=u[1])}var c=document.getElementsByTagName("base");if(1===c.length){var d=c[0].getAttribute("href");"/"!==d&&"./"!==d&&(e=d+e)}return e}(),this.twoDimension=!1,this.serverPolicy.geoserverEnable){this.geoserver=new zi;var i={wmsVersion:this.serverPolicy.geoserverWmsVersion,dataUrl:this.serverPolicy.geoserverDataUrl,dataWorkspace:this.serverPolicy.geoserverDataWorkspace,dataStore:this.serverPolicy.geoserverDataStore,user:this.serverPolicy.geoserverUser,password:this.serverPolicy.geoserverPassword};this.geoserver.setServerInfo(i)}if(t&&t.length>0)for(var o=0;o<t.length;o++)this.isDataExist(I.PROJECT_ID_PREFIX+t[o])||(this.setData(I.PROJECT_ID_PREFIX+t[o],r[o]),this.setProjectDataFolder(I.PROJECT_DATA_FOLDER_PREFIX+r[o].data_key,r[o].data_key))},O.prototype.clearAllData=function(){this.dataObject={}},O.prototype.clearSelectHistory=function(){this.selectHistoryObject={}},O.prototype.getAllSelectHistory=function(){return this.selectHistoryObject},O.prototype.getSelectHistoryObjects=function(e,t){var r=this.selectHistoryObject[e];if(void 0!==r)return r[t]},O.prototype.getSelectHistoryObject=function(e,t,r){var i=this.selectHistoryObject[e];if(void 0!==i){var o=i[t];if(void 0!==o)return o[r]}},O.prototype.saveSelectHistory=function(e,t,r,i){var o=this.selectHistoryObject.get(e);void 0===o&&(o={},this.selectHistoryObject[e]=o);var n=o[t];void 0===n&&(n={},o[t]=n),n[r]=i},O.prototype.deleteSelectHistoryObject=function(e,t,r){var i=this.selectHistoryObject[e];if(void 0!==i){var o=i[t];if(void 0!==o)return delete o[r]}},O.prototype.clearMovingHistory=function(){this.movingHistoryObject={}},O.prototype.getAllMovingHistory=function(){return this.movingHistoryObject},O.prototype.getMovingHistoryObjects=function(e,t){var r=this.movingHistoryObject[e];if(void 0!==r)return r[t]},O.prototype.getMovingHistoryObject=function(e,t,r){var i=this.movingHistoryObject[e];if(void 0!==i){var o=i[t];if(void 0!==o)return o[r]}},O.prototype.saveMovingHistory=function(e,t,r,i){var o=this.movingHistoryObject[e];void 0===o&&(o={},this.movingHistoryObject[e]=o);var n=o[t];void 0===n&&(n={},o[t]=n),n[r]=i},O.prototype.deleteMovingHistoryObject=function(e,t,r){var i=this.movingHistoryObject[e];if(void 0!==i){var o=i[t];if(void 0!==o)return delete o[r]}},O.prototype.getAllColorHistory=function(){return this.colorHistoryObject},O.prototype.clearColorHistory=function(){this.colorHistoryObject={}},O.prototype.getColorHistorys=function(e,t){var r=this.colorHistoryObject[e];if(void 0!==r)return r[t]},O.prototype.getColorHistory=function(e,t,r){var i=this.colorHistoryObject[e];if(void 0!==i){var o=i[t];if(void 0!==o)return o[r]}},O.prototype.saveColorHistory=function(e,t,r,i){var o=this.colorHistoryObject[e];void 0===o&&(o={},this.colorHistoryObject[e]=o);var n=o[t];void 0===n&&(n={},o[t]=n),null===r||""===r?n[t]=i:n[r]=i},O.prototype.deleteColorHistory=function(e,t,r){var i=this.colorHistoryObject[e];if(void 0!==i){var o=i[t];if(void 0!==o)return delete o[r]}},O.prototype.deleteF4dColorHistory=function(e,t){var r=this.colorHistoryObject[e];if(void 0!==r&&void 0!==r[t])return delete r[t]},O.prototype.clearColorHistory=function(){this.colorHistoryObject={}},O.prototype.getAllLocationAndRotationHistory=function(){return this.locationAndRotationHistoryObject},O.prototype.getLocationAndRotationHistorys=function(e,t){var r=this.locationAndRotationHistoryObject[e];if(void 0!==r)return r[t]},O.prototype.getLocationAndRotationHistory=function(e,t){var r=this.locationAndRotationHistoryObject[e];if(void 0!==r)return r[t]},O.prototype.saveLocationAndRotationHistory=function(e,t,r){var i=this.locationAndRotationHistoryObject[e];void 0===i&&(i={},this.locationAndRotationHistoryObject[e]=i);var o=i[t];void 0===o&&(o={}),o[t]=r},O.prototype.deleteLocationAndRotationHistory=function(e,t){var r=this.locationAndRotationHistoryObject[e];if(void 0!==r)delete r[t]},O.prototype.clearLocationAndRotationHistory=function(){this.locationAndRotationHistoryObject={}},O.prototype.setTwoDimension=function(e){this.twoDimension=e},O.prototype.isTwoDimension=function(){return this.twoDimension};var B=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoEnable=!0,this.showOutFitting=!1,this.showLabelInfo=!1,this.showBoundingBox=!1,this.showShadow=!1,this.frustumFarSquaredDistance=5e6,this.frustumFarDistance=2e4,this.highLightedBuildings=[],this.colorBuildings=[],this.color=[],this.hideBuildings=[],this.objectMoveMode=I.moveMode.NONE,this.issueInsertEnable=!1,this.objectInfoViewEnable=!1,this.nearGeoIssueListEnable=!1,this.occlusionCullingEnable=!1,this.showOrigin=!1,this.magoMode=I.magoMode.NORMAL,this.imagePath="",this.colorChangedObjectId,this.lod0DistInMeters=50,this.lod1DistInMeters=200,this.lod2DistInMeters=600,this.lod3DistInMeters=1200,this.lod4DistInMeters=3e3,this.lod5DistInMeters=5e4,this.ambientReflectionCoef=.45,this.diffuseReflectionCoef=.75,this.specularReflectionCoef=.6,this.ambientColor=null,this.specularColor=new Float32Array([.6,.6,.6]),this.ssaoRadius=.15,this.modelMovable=!0,this.pointsCloudSettings={},Qo(t)?(this.pointsCloudSettings.maxPartitionsLod0=Jo(t.maxPartitionsLod0,4),this.pointsCloudSettings.maxPartitionsLod1=Jo(t.maxPartitionsLod1,2),this.pointsCloudSettings.maxPartitionsLod2orLess=Jo(t.maxPartitionsLod2OrLess,1),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam0m=1/Jo(t.maxRatioPointsDist0m,1),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam100m=1/Jo(t.maxRatioPointsDist100m,3),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam200m=1/Jo(t.maxRatioPointsDist200m,10),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam400m=1/Jo(t.maxRatioPointsDist400m,20),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam800m=1/Jo(t.maxRatioPointsDist800m,40),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam1600m=1/Jo(t.maxRatioPointsDist1600m,80),this.pointsCloudSettings.maxPerUnitPointsRenderDistToCamMoreThan1600m=1/Jo(t.maxRatioPointsDistOver1600m,160),this.pointsCloudSettings.maxPointSize=Jo(t.maxPointSizeForPc,40),this.pointsCloudSettings.minPointSize=Jo(t.minPointSizeForPc,3),this.pointsCloudSettings.pendentPointSize=Jo(t.pendentPointSizeForPc,60),this.pointsCloudSettings.minHeightRainbow=Jo(t.minHeight_rainbow_loc,0),this.pointsCloudSettings.maxHeightRainbow=Jo(t.maxHeight_rainbow_loc,100)):(this.pointsCloudSettings.maxPartitionsLod0=4,this.pointsCloudSettings.maxPartitionsLod1=2,this.pointsCloudSettings.maxPartitionsLod2orLess=1,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam0m=1,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam100m=1/3,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam200m=.1,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam400m=.05,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam800m=.025,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCam1600m=1/80,this.pointsCloudSettings.maxPerUnitPointsRenderDistToCamMoreThan1600m=1/160,this.pointsCloudSettings.maxPointSize=40,this.pointsCloudSettings.minPointSize=3,this.pointsCloudSettings.pendentPointSize=60,this.pointsCloudSettings.minHeightRainbow=0,this.pointsCloudSettings.maxHeightRainbow=100)};B.prototype.getPointsCloudSettings=function(){return this.pointsCloudSettings},B.prototype.getShowOrigin=function(){return this.showOrigin},B.prototype.setShowOrigin=function(e){this.showOrigin=e},B.prototype.getMagoEnable=function(){return this.magoEnable},B.prototype.setMagoEnable=function(e){this.magoEnable=e},B.prototype.getShowOutFitting=function(){return this.showOutFitting},B.prototype.setShowOutFitting=function(e){this.showOutFitting=e},B.prototype.getShowLabelInfo=function(){return this.showLabelInfo},B.prototype.setShowLabelInfo=function(e){this.showLabelInfo=e},B.prototype.getShowBoundingBox=function(){return this.showBoundingBox},B.prototype.setShowBoundingBox=function(e){this.showBoundingBox=e},B.prototype.getShowShadow=function(){return this.showShadow},B.prototype.setShowShadow=function(e){this.showShadow=e},B.prototype.getFrustumFarSquaredDistance=function(){return this.frustumFarSquaredDistance},B.prototype.setFrustumFarSquaredDistance=function(e){this.frustumFarSquaredDistance=e},B.prototype.getFrustumFarDistance=function(){return this.frustumFarDistance},B.prototype.setFrustumFarDistance=function(e){this.frustumFarDistance=e},B.prototype.getHighLightedBuildings=function(){return this.highLightedBuildings},B.prototype.setHighLightedBuildings=function(e){this.highLightedBuildings=e},B.prototype.getColorBuildings=function(){return this.colorBuildings},B.prototype.setColorBuildings=function(e){this.colorBuildings=e},B.prototype.getColor=function(){return this.color},B.prototype.setColor=function(e){this.color=e},B.prototype.getHideBuildings=function(){return this.hideBuildings},B.prototype.setHideBuildings=function(e){this.hideBuildings=e},B.prototype.getObjectMoveMode=function(){return this.objectMoveMode},B.prototype.setObjectMoveMode=function(e){this.objectMoveMode=e},B.prototype.getMagoMode=function(){return this.magoMode},B.prototype.setMagoMode=function(e){this.magoMode=e},B.prototype.getIssueInsertEnable=function(){return this.issueInsertEnable},B.prototype.setIssueInsertEnable=function(e){this.issueInsertEnable=e},B.prototype.getObjectInfoViewEnable=function(){return this.objectInfoViewEnable},B.prototype.setObjectInfoViewEnable=function(e){this.objectInfoViewEnable=e},B.prototype.getOcclusionCullingEnable=function(){return this.occlusionCullingEnable},B.prototype.setOcclusionCullingEnable=function(e){this.occlusionCullingEnable=e},B.prototype.getNearGeoIssueListEnable=function(){return this.nearGeoIssueListEnable},B.prototype.setNearGeoIssueListEnable=function(e){this.nearGeoIssueListEnable=e},B.prototype.getImagePath=function(){return this.imagePath},B.prototype.setImagePath=function(e){this.imagePath=e},B.prototype.getLod=function(e){return e<this.lod0DistInMeters?0:e<this.lod1DistInMeters?1:e<this.lod2DistInMeters?2:e<this.lod3DistInMeters?3:e<this.lod4DistInMeters?4:5},B.prototype.getLod0DistInMeters=function(){return this.lod0DistInMeters},B.prototype.setLod0DistInMeters=function(e){this.lod0DistInMeters=e},B.prototype.getLod1DistInMeters=function(){return this.lod1DistInMeters},B.prototype.setLod1DistInMeters=function(e){this.lod1DistInMeters=e},B.prototype.getLod2DistInMeters=function(){return this.lod2DistInMeters},B.prototype.setLod2DistInMeters=function(e){this.lod2DistInMeters=e},B.prototype.getLod3DistInMeters=function(){return this.lod3DistInMeters},B.prototype.setLod3DistInMeters=function(e){this.lod3DistInMeters=e},B.prototype.getLod4DistInMeters=function(){return this.lod4DistInMeters},B.prototype.setLod4DistInMeters=function(e){this.lod4DistInMeters=e},B.prototype.getLod5DistInMeters=function(){return this.lod5DistInMeters},B.prototype.setLod5DistInMeters=function(e){this.lod5DistInMeters=e},B.prototype.getAmbientReflectionCoef=function(){return this.ambientReflectionCoef},B.prototype.setAmbientReflectionCoef=function(e){this.ambientReflectionCoef=e},B.prototype.getDiffuseReflectionCoef=function(){return this.diffuseReflectionCoef},B.prototype.setDiffuseReflectionCoef=function(e){this.diffuseReflectionCoef=e},B.prototype.getSpecularReflectionCoef=function(){return this.specularReflectionCoef},B.prototype.setSpecularReflectionCoef=function(e){this.specularReflectionCoef=e},B.prototype.getAmbientColor=function(){return this.ambientColor},B.prototype.setAmbientColor=function(e){this.ambientColor=e},B.prototype.getSpecularColor=function(){return this.specularColor},B.prototype.setSpecularColor=function(e){this.specularColor=e},B.prototype.getSsaoRadius=function(){return this.ssaoRadius},B.prototype.setSsaoRadius=function(e){this.ssaoRadius=e},B.prototype.setModelMovable=function(e){this.modelMovable=e},B.prototype.isModelMovable=function(){return this.modelMovable};var N=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.animationType=I.animationType.UNKNOWN,this.birthTime,this.lastTime,this.durationInSeconds,this.path,this.startLongitude,this.startLatitude,this.startAltitude,this.targetLongitude,this.targetLatitude,this.targetAltitude,this.targetHeading,this.targetPitch,this.targetRoll,this.linearVelocityInMetersSecond,this.headingAngDegSecondVelocity,this.pitchAngDegSecondVelocity,this.rollAngDegSecondVelocity},U=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.nodesMap,this.objectsMap};U.prototype.putNode=function(e){void 0===this.nodesMap&&(this.nodesMap={});var t=e.data.nodeId;this.nodesMap[t]=e},U.prototype.putObject=function(e){void 0===this.objectsMap&&(this.objectsMap={});var t=e.id;this.objectsMap[t]=e},U.prototype.checkAnimation=function(e){var t;if(void 0!==this.nodesMap)for(var r in this.nodesMap)Object.prototype.hasOwnProperty.call(this.nodesMap,r)&&((t=this.nodesMap[r]).finishedAnimation(e)?(delete this.nodesMap[r],e.emit(Fe.EVENT_TYPE.ANIMATIONEND,{type:Fe.EVENT_TYPE.ANIMATIONEND,f4d:t,timestamp:new Date})):e.emit(Fe.EVENT_TYPE.ANIMATIONING,{type:Fe.EVENT_TYPE.ANIMATIONING,f4d:t,timestamp:new Date}));if(void 0!==this.objectsMap)for(var r in this.objectsMap)Object.prototype.hasOwnProperty.call(this.objectsMap,r)&&this.objectsMap[r].finishedAnimation(e)&&delete this.objectsMap[r]},U.getNextPosition=function(e,t,r){return void 0===e||(e.animationType===I.animationType.PATH?U.getNextPositionByPath(e,t,r):void 0)},U.getNextPositionByPath=function(e,t,r){if(void 0===e)return!0;var i=e.path;if(void 0===i)return!0;void 0===e.linearVelocityInMetersSecond&&(e.linearVelocityInMetersSecond=20);var o=e.linearVelocityInMetersSecond,n=(t-e.birthTime)/1e3,a=o*n;if(Xr.prototype.isPrototypeOf(i))return i.getTangent(a,void 0,r);if(Tr.prototype.isPrototypeOf(i)){if(void 0===e.totalLinearLength){if(void 0===i.knotPoints3dList){i.makeControlPoints(.3,r)}e.totalLinearLength=Tr.getLength(i,s)}if(void 0!==e.linearVelocityInMetersSecond&&(e.durationInSeconds=e.totalLinearLength/e.linearVelocityInMetersSecond),e.durationInSeconds){if(e.currentLinearPos&&e.currentLinearPos>=e.totalLinearLength)return;var s=20,l=e.totalLinearLength;a=l*(n/e.durationInSeconds),e.currentLinearPos=a,a>l&&(a=l)}return Tr.getTangent(i,a,void 0,r)}},U.prototype._TEST_SAMPLECODE_nodeAnimation=function(e){var t=e.selectionManager.getSelectedF4dNode();if(void 0!==t){var r=t.data.projectId,i=t.data.nodeId;t.data.isTrailRender=!0;var o=t.getNodeGeoLocDataManager().getCurrentGeoLocationData().getGeographicCoords(),n=(o.longitude,o.latitude,o.altitude,e.modeler.bSplineCubic3d),a=n.geoCoordsList.geographicCoordsArray,s=new Xr(a);if(void 0!==n){var l={animationType:I.animationType.PATH,path:s,linearVelocityInMetersSecond:50,autoChangeRotation:!0};e.changeLocationAndRotation(r,i,void 0,void 0,void 0,45,45,void 0,l)}}};var G=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.minX=1e6,this.minY=1e6,this.minZ=1e6,this.maxX=-1e6,this.maxY=-1e6,this.maxZ=-1e6};G.prototype.init=function(e){e=e||new Jr,this.minX=e.x,this.minY=e.y,this.minZ=e.z,this.maxX=e.x,this.maxY=e.y,this.maxZ=e.z},G.prototype.initXYZData=function(e,t,r){this.minX=e,this.minY=t,this.minZ=r,this.maxX=e,this.maxY=t,this.maxZ=r},G.prototype.readData=function(e,t){return this.minX=new Float32Array(e.slice(t,t+4))[0],t+=4,this.minY=new Float32Array(e.slice(t,t+4))[0],t+=4,this.minZ=new Float32Array(e.slice(t,t+4))[0],t+=4,this.maxX=new Float32Array(e.slice(t,t+4))[0],t+=4,this.maxY=new Float32Array(e.slice(t,t+4))[0],t+=4,this.maxZ=new Float32Array(e.slice(t,t+4))[0],t+=4},G.prototype.set=function(e,t,r,i,o,n){this.minX=e,this.minY=t,this.minZ=r,this.maxX=i,this.maxY=o,this.maxZ=n},G.prototype.deleteObjects=function(){this.minX=void 0,this.minY=void 0,this.minZ=void 0,this.maxX=void 0,this.maxY=void 0,this.maxZ=void 0},G.prototype.copyFrom=function(e){this.minX=e.minX,this.minY=e.minY,this.minZ=e.minZ,this.maxX=e.maxX,this.maxY=e.maxY,this.maxZ=e.maxZ},G.prototype.translateToOrigin=function(){var e=this.getXLength()/2,t=this.getYLength()/2,r=this.getZLength()/2;this.minX=-e,this.minY=-t,this.minZ=-r,this.maxX=e,this.maxY=t,this.maxZ=r},G.prototype.expand=function(e){e=e||0,e=Math.abs(e),this.minX-=e,this.minY-=e,this.minZ-=e,this.maxX+=e,this.maxY+=e,this.maxZ+=e},G.getBBoxByPonintAndSize=function(e,t){if(!e||!e instanceof Jr)throw new Error("point is required");if(isNaN(t))throw new Error("size must number.");var r=new G,i=e.x+t,o=e.x-t,n=e.y+t,a=e.y-t,s=e.z-t,l=e.z+t;return r.set(o,a,s,i,n,l),r},G.getBBoxByXYZDataArray=function(e,t){if(void 0!==e){var r=e.length/3;if(0!==r){void 0===t&&(t=new G),t.init(new Jr(e[0],e[1],e[2]));for(var i=0;i<r;i++)t.addXYZData(e[3*i],e[3*i+1],e[3*i+2]);return t}}},G.prototype.addXYZData=function(e,t,r){void 0!==e&&void 0!==t&&void 0!==r&&(e<this.minX?this.minX=e:e>this.maxX&&(this.maxX=e),t<this.minY?this.minY=t:t>this.maxY&&(this.maxY=t),r<this.minZ?this.minZ=r:r>this.maxZ&&(this.maxZ=r))},G.prototype.addPointsArray=function(e){if(void 0!==e&&0!==e.length){this.init(e[0]);for(var t=e.length,r=0;r<t;++r)this.addPoint(e[r])}},G.prototype.addPoint=function(e){void 0!==e&&(e.x<this.minX?this.minX=e.x:e.x>this.maxX&&(this.maxX=e.x),e.y<this.minY?this.minY=e.y:e.y>this.maxY&&(this.maxY=e.y),e.z<this.minZ?this.minZ=e.z:e.z>this.maxZ&&(this.maxZ=e.z))},G.prototype.addBox=function(e){void 0!==e&&(e.minX<this.minX&&(this.minX=e.minX),e.maxX>this.maxX&&(this.maxX=e.maxX),e.minY<this.minY&&(this.minY=e.minY),e.maxY>this.maxY&&(this.maxY=e.maxY),e.minZ<this.minZ&&(this.minZ=e.minZ),e.maxZ>this.maxZ&&(this.maxZ=e.maxZ))},G.prototype.getMinLength=function(){return Math.min(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},G.prototype.getMaxLength=function(){return Math.max(this.maxX-this.minX,this.maxY-this.minY,this.maxZ-this.minZ)},G.prototype.getXLength=function(){return this.maxX-this.minX},G.prototype.getYLength=function(){return this.maxY-this.minY},G.prototype.getZLength=function(){return this.maxZ-this.minZ},G.prototype.getCenterPoint=function(e){return void 0===e&&(e=new Jr),e.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,(this.maxZ+this.minZ)/2),e},G.prototype.getMinPoint=function(e){return void 0===e&&(e=new Jr),e.set(this.minX,this.minY,this.minZ),e},G.prototype.getMaxPoint=function(e){return void 0===e&&(e=new Jr),e.set(this.maxX,this.maxY,this.maxZ),e},G.prototype.getBottomCenterPoint=function(e){return void 0===e&&(e=new Jr),e.set((this.maxX+this.minX)/2,(this.maxY+this.minY)/2,0),e},G.prototype.getRadiusAprox=function(){return this.getMaxLength()/1.5},G.prototype.getRadius=function(){var e=this.getCenterPoint(),t=this.getMinPoint();return e.distToPoint(t)},G.prototype.getBoundingSphere=function(e){void 0===e&&(e=new Je);var t=this.getCenterPoint();return e.setCenterPoint(t.x,t.y,t.z),e.setRadius(this.getRadiusAprox()),e},G.prototype.intersectWithPoint=function(e){return void 0!==e&&!(e.x<this.minX||e.x>this.maxX||e.y<this.minY||e.y>this.maxY||e.z<this.minZ||e.z>this.maxZ)},G.prototype.isPoint3dInside=function(e,t,r){return!(e<this.minX||e>this.maxX)&&(!(t<this.minY||t>this.maxY)&&!(r<this.minZ||r>this.maxZ))},G.prototype.intersectWithBox=function(e){return void 0!==e&&!(e.minX>this.maxX||e.maxX<this.minX||e.minY>this.maxY||e.maxY<this.minY||e.minZ>this.maxZ||e.maxZ<this.minZ)},G.prototype.getPlaneTop=function(e){void 0===e&&(e=new We);var t=this.getMaxPoint();return e.setPointAndNormal(t.x,t.y,t.z,0,0,1),e},G.prototype.getPlaneBottom=function(e){void 0===e&&(e=new We);var t=this.getMinPoint();return e.setPointAndNormal(t.x,t.y,t.z,0,0,-1),e},G.prototype.getPlaneFront=function(e){void 0===e&&(e=new We);var t=this.getMinPoint();return e.setPointAndNormal(t.x,t.y,t.z,0,-1,0),e},G.prototype.getPlaneRear=function(e){void 0===e&&(e=new We);var t=this.getMaxPoint();return e.setPointAndNormal(t.x,t.y,t.z,0,1,0),e},G.prototype.getPlaneLeft=function(e){void 0===e&&(e=new We);var t=this.getMinPoint();return e.setPointAndNormal(t.x,t.y,t.z,-1,0,0),e},G.prototype.getPlaneRight=function(e){void 0===e&&(e=new We);var t=this.getMaxPoint();return e.setPointAndNormal(t.x,t.y,t.z,1,0,0),e},G.prototype.isPoint3dInsideXYPrism=function(e){return void 0!==e&&!(e.x<this.minX||e.x>this.maxX||e.y<this.minY||e.y>this.maxY)},G.prototype.isPoint3dInsideXZPrism=function(e){return void 0!==e&&!(e.x<this.minX||e.x>this.maxX||e.z<this.minZ||e.z>this.maxZ)},G.prototype.isPoint3dInsideYZPrism=function(e){return void 0!==e&&!(e.y<this.minY||e.y>this.maxY||e.z<this.minZ||e.z>this.maxZ)},G.prototype.intersectsWithSegment3D=function(e){if(void 0===e)return!1;var t,r=e.getLine();return!(void 0===(t=this.getPlaneTop().intersectionLine(r,t))||!this.isPoint3dInsideXYPrism(t)||!e.intersectionWithPoint(t))||(!(void 0===(t=this.getPlaneBottom().intersectionLine(r,t))||!this.isPoint3dInsideXYPrism(t)||!e.intersectionWithPoint(t))||(!(void 0===(t=this.getPlaneFront().intersectionLine(r,t))||!this.isPoint3dInsideXZPrism(t)||!e.intersectionWithPoint(t))||(!(void 0===(t=this.getPlaneRear().intersectionLine(r,t))||!this.isPoint3dInsideXZPrism(t)||!e.intersectionWithPoint(t))||(!(void 0===(t=this.getPlaneLeft().intersectionLine(r,t))||!this.isPoint3dInsideYZPrism(t)||!e.intersectionWithPoint(t))||!(void 0===(t=this.getPlaneRight().intersectionLine(r,t))||!this.isPoint3dInsideYZPrism(t)||!e.intersectionWithPoint(t))))))},G.prototype.intersectsWithTriangle=function(e){if(void 0===e)return!1;var t=e.getPlaneNormal();if(t.isNAN())return!1;var r=e.getBoundingBox();if(!this.intersectsWithBBox(r))return!1;if(this.intersectWithPoint(e.vertex0.getPosition())||this.intersectWithPoint(e.vertex1.getPosition())||this.intersectWithPoint(e.vertex2.getPosition()))return!0;var i=e.getPlane(),o=this.getCenterPoint(),n=i.getProjectedPoint(o);if(o.distToPoint(n)>this.getRadius())return!1;for(var a=0;a<3;a++){var s=e.getSegment(a,s);if(this.intersectsWithSegment3D(s))return!0}var l=Er.getBestFacePlaneToProject(t),u=en.projectTriangle3DInToBestPlaneToProject(e,l,void 0),c=en.projectPoint3DInToBestPlaneToProject(o,l,void 0);return!!u.isPoint2dInside(c)},G.prototype.intersectsWithBBox=function(e){var t=!0;return this.maxX<e.minX?t=!1:this.minX>e.maxX?t=!1:this.maxY<e.minY?t=!1:this.minY>e.maxY?t=!1:this.maxZ<e.minZ?t=!1:this.minZ>e.maxZ&&(t=!1),t},G.prototype.getGeographicCoordPolygon2D=function(e){var t=new Jr(this.minX,this.minY,this.minZ),r=new Jr(this.maxX,this.minY,this.minZ),i=new Jr(this.maxX,this.maxY,this.minZ),o=new Jr(this.minX,this.maxY,this.minZ),n=e.transformPoint3D(t),a=e.transformPoint3D(r),s=e.transformPoint3D(i),l=e.transformPoint3D(o),u=[];return u.push(on.pointToGeographicCoord(n)),u.push(on.pointToGeographicCoord(a)),u.push(on.pointToGeographicCoord(s)),u.push(on.pointToGeographicCoord(l)),$r.makePolygonByGeographicCoordArray(u)};var z=function e(t,r,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.centerPoint=new Jr,void 0!==t&&void 0!==r&&void 0!==i&&this.centerPoint.set(t,r,i),this.r=0,void 0!==o&&(this.r=o)};function H(e){"@babel/helpers - typeof";return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}z.prototype.getCenterPoint=function(){return this.centerPoint},z.prototype.setCenterPoint=function(e,t,r){this.centerPoint.set(e,t,r)},z.prototype.getRadius=function(){return this.r},z.prototype.setRadius=function(e){this.r=e},z.prototype.intersectsWithBSphere=function(e){if(void 0===e)return F.INTERSECTION_OUTSIDE;var t=this.centerPoint.distToPoint(e.centerPoint);return t<this.r?F.INTERSECTION_INSIDE:t<e.r?F.INTERSECTION_INSIDE:t<this.r+e.r?F.INTERSECTION_INTERSECT:F.INTERSECTION_OUTSIDE},z.prototype.copyFrom=function(e){this.centerPoint.copyFrom(e.centerPoint),this.r=e.r},z.prototype.addBSphere=function(e){if(this.intersectsWithBSphere(e)===F.INTERSECTION_INSIDE)this.r<e.r&&this.copyFrom(e);else{var t=this.centerPoint.getVectorToPoint(e.centerPoint,void 0);t.unitary();var r=new Jr(this.centerPoint.x-t.x*this.r,this.centerPoint.y-t.y*this.r,this.centerPoint.z-t.z*this.r),i=new Jr(e.centerPoint.x+t.x*e.r,e.centerPoint.y+t.y*e.r,e.centerPoint.z+t.z*e.r),o=(r.x+i.x)/2,n=(r.y+i.y)/2,a=(r.z+i.z)/2;this.centerPoint.set(o,n,a),this.r=.5*r.distToPoint(i)}};var V=function e(t,r,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(tn(t))throw new Error(Ue.REQUIRED_EMPTY_ERROR("type"));if(this.type=t,this.modifier=i,this.timestamp=new Date,r&&"object"===H(r))if(r.hasOwnProperty("x")&&r.hasOwnProperty("y")){var n=on.screenCoordToWorldCoordUseDepthCheck(r.x,r.y,o),a={};a.screenCoordinate=new Kr(r.x,r.y),n&&(a.worldCoordinate=n,a.geographicCoordinate=on.pointToGeographicCoord(n)),this.point=a}else if(r.hasOwnProperty("startPosition")&&r.hasOwnProperty("endPosition")){var s=on.getComplexCoordinateByScreenCoord(o.getGl(),r.startPosition.x,r.startPosition.y,void 0,void 0,void 0,o);s||(s={screenCoordinate:new Kr(r.startPosition.x,r.startPosition.y)});var l=on.getComplexCoordinateByScreenCoord(o.getGl(),r.endPosition.x,r.endPosition.y,void 0,void 0,void 0,o);l||(l={screenCoordinate:new Kr(r.endPosition.x,r.endPosition.y)}),this.startEvent=s,this.endEvent=l}else this.position=r},k=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.fisrtName,this.name="",this.buildingId,this.buildingFileName,this.geographicCoord,this.rotationsDegree,this.bBox,this.geographicCoordOfBBox,this.smartTileOwner,this.dataType="F4D"};k.prototype.deleteObjects=function(){this.fisrtName=void 0,this.name=void 0,this.buildingId=void 0,this.buildingFileName=void 0,this.geographicCoord.deleteObjects(),this.rotationsDegree.deleteObjects(),this.bBox.deleteObjects(),this.geographicCoordOfBBox.deleteObjects(),this.geographicCoord=void 0,this.rotationsDegree=void 0,this.bBox=void 0,this.geographicCoordOfBBox=void 0,this.dataType=void 0};var j=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.buildingSeedArray=[],this.minGeographicCoord,this.maxGeographicCoord,this.dataArrayBuffer};j.prototype.deleteObjects=function(){if(this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.buildingSeedArray){for(var e=this.buildingSeedArray.length,t=0;t<e;t++)this.buildingSeedArray[t].deleteObjects(),this.buildingSeedArray[t]=void 0;this.buildingSeedArray=void 0}this.dataArrayBuffer=void 0},j.prototype.newBuildingSeed=function(){var e=new k;return this.buildingSeedArray.push(e),e},j.prototype.parseBuildingSeedArrayBuffer=function(){if(void 0===this.dataArrayBuffer)return!1;var e,t,r,i,o=this.dataArrayBuffer,n=0,a=new Int32Array(o.slice(n,n+4))[0];n+=4;for(var s=0;s<a;s++){var l=this.newBuildingSeed();void 0===l.geographicCoord&&(l.geographicCoord=new pe),void 0===l.bBox&&(l.bBox=new G),e=new Int32Array(o.slice(n,n+4))[0],n+=4;var u=new TextDecoder("utf-8").decode(new Uint8Array(o.slice(n,n+e)));n+=e,t=new Float64Array(o.slice(n,n+8))[0],n+=8,r=new Float64Array(o.slice(n,n+8))[0],n+=8,i=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,l.bBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4,l.buildingId=u.substr(4,e-4),l.buildingFileName=u,l.geographicCoord.setLonLatAlt(t,r,i)}return!0},j.prototype.getBuildingSeedLength=function(){return this.buildingSeedArray.length},j.prototype.getBuildingSeed=function(e){if("string"!=typeof e&&"number"!=typeof e)throw new Error("idx is required to be a string or number.");if(!this.buildingSeedArray[e])throw new Error("range over.");return this.buildingSeedArray[e]};var W=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.map=new Map,this.dataArrayBuffer};W.prototype.deleteObjects=function(){if(this.buildingSeedArray){for(var e=this.buildingSeedArray.length,t=0;t<e;t++)this.buildingSeedArray[t].deleteObjects(),this.buildingSeedArray[t]=void 0;this.buildingSeedArray=void 0}this.dataArrayBuffer=void 0},W.prototype.parseBuildingSeedArrayBuffer=function(){if(void 0===this.dataArrayBuffer)return!1;var e,t,r,i,o=this.dataArrayBuffer,n=0,a=new TextDecoder("utf-8"),s=new Int32Array(o.slice(n,n+4))[0];if(n+=4,-10===s){var l=new Int32Array(o.slice(n,n+4))[0];n+=4;for(var u=0;u<l;u++){(h=new k).dataType="MGSET",void 0===h.geographicCoord&&(h.geographicCoord=new pe),void 0===h.bBox&&(h.bBox=new G),e=new Int32Array(o.slice(n,n+4))[0],n+=4;var c=a.decode(new Uint8Array(o.slice(n,n+e)));n+=e,t=new Float64Array(o.slice(n,n+8))[0],n+=8,r=new Float64Array(o.slice(n,n+8))[0],n+=8,i=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4,h.buildingId=c.substr(4,e-4),h.buildingFileName=c,h.geographicCoord.setLonLatAlt(t,r,i),this.map.set(h.buildingId,h)}s=new Int32Array(o.slice(n,n+4))[0],n+=4}for(var d=0;d<s;d++){var h;(h=new k).dataType="F4D",void 0===h.geographicCoord&&(h.geographicCoord=new pe),void 0===h.bBox&&(h.bBox=new G),e=new Int32Array(o.slice(n,n+4))[0],n+=4;c=a.decode(new Uint8Array(o.slice(n,n+e)));n+=e,t=new Float64Array(o.slice(n,n+8))[0],n+=8,r=new Float64Array(o.slice(n,n+8))[0],n+=8,i=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,h.bBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4,h.buildingId=c.substr(4,e-4),h.buildingFileName=c,h.geographicCoord.setLonLatAlt(t,r,i),this.map.set(h.buildingId,h)}return!0},W.prototype.getBuildingSeedLength=function(){return this.map.size},W.prototype.getBuildingSeed=function(e){if("string"!=typeof e&&"number"!=typeof e)throw new Error("buildingId is required to be a string or number.");return this.map.get(e)};var X=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.id="camera",this.name="noName",this.position=new Jr,this.encodedCamPosHigh,this.encodedCamPosLow,this.direction=new Jr,this.up=new Jr,this.right=new Jr,this.speed3d=new Jr,this.updatedTime,this.frustum=new fe,this.bigFrustum=new fe,this.dirty=!0,this.frustumsArray=[],this.frustumsArray.push(this.frustum),this.nearCenterPoint=new Jr,this.farCenterPoint=new Jr,this.farLeftBottomPoint=new Jr,this.farRightTopPoint=new Jr,this.leftBottomDir=new Jr,this.rightTopDir=new Jr,this.leftNormal=new Jr,this.rightNormal=new Jr,this.bottomNormal=new Jr,this.topNormal=new Jr,this.depthBufferFBO,this._normalAtCartesianPointWgsb4,this.lastMovement={currLinearVelocity:0,currAngularVelocity:0,movementType:I.movementType.NO_MOVEMENT},this.tracked,this.trackType=I.trackMode.TRACKING,this.targetOffset=10,this.trackCameraOffsetY=-1,this.trackCameraOffsetZ=12,t&&(void 0!==t.name&&(this.name=t.name),void 0!==t.id&&(this.id=t.id))};X.prototype.copyPosDirUpFrom=function(e){this.position.copyFrom(e.position),this.direction.copyFrom(e.direction),this.up.copyFrom(e.up)},X.prototype.translate=function(e){this.position.add(e.x,e.y,e.z)},X.prototype.doInertialMovement=function(e){if(void 0===this.lastMovement)return!1;if(this.lastMovement.movementType===I.movementType.NO_MOVEMENT)return!1;var t=this.lastMovement,r=t.deltaTime,i=e.magoWorld,o=t.movementType;if(o===I.movementType.TRANSLATION){var n=t.currLinearVelocity,a=t.translationDir,s=n*r;Math.abs(s)<1e-4&&(t.movementType=I.movementType.NO_MOVEMENT),this.position.add(-a.x*s,-a.y*s,-a.z*s),i.updateModelViewMatrixByCamera(this),t.currLinearVelocity*=.9,Math.abs(t.currLinearVelocity)<1e-4&&(t.movementType=I.movementType.NO_MOVEMENT)}else if(o===I.movementType.ROTATION){var l=t.currAngularVelocity;t.angRad=l*r,Math.abs(t.angRad)<1e-11&&(t.movementType=I.movementType.NO_MOVEMENT);var u=t.angRad,c=t.rotationAxis;if(f=t.rotationPoint){(C=new Ne).rotationAxisAngRad(u,c.x,c.y,c.z);var d=new Jr(-f.x,-f.y,-f.z),h=new Jr(f.x,f.y,f.z);this.translate(d),this.transformByMatrix4(C),this.translate(h)}else{(C=new Ne).rotationAxisAngRad(-u,c.x,c.y,c.z),this.transformByMatrix4(C)}i.updateModelViewMatrixByCamera(this),t.currAngularVelocity*=.9,Math.abs(t.currAngularVelocity)<1e-11&&(t.movementType=I.movementType.NO_MOVEMENT)}else if(o===I.movementType.ROTATION_ZX){l=t.currAngularVelocity;t.angRad=l*r;var f;u=t.angRad,c=t.rotationAxis;if(f=t.rotationPoint){var g;g=Te.normalAtCartesianPointWgs84(f.x,f.y,f.z,g);var p=this.getCameraRight(),m=t.zAngVelocity*r,v=t.xAngVelocity*r,x=-this.getOrientation().pitchRad;v+x>-.1&&(v=x<0?-x-.01:x-.01),Math.abs(m)<1e-11&&Math.abs(v)<1e-11&&(t.movementType=I.movementType.NO_MOVEMENT);var _=glMatrix.quat.create();_=glMatrix.quat.setAxisAngle(_,g,m);var y=glMatrix.quat.create();y=glMatrix.quat.setAxisAngle(y,[p.x,p.y,p.z],v);var T=glMatrix.quat.create();T=glMatrix.quat.multiply(T,_,y),(C=new Ne)._floatArrays=glMatrix.mat4.fromQuat(C._floatArrays,T);d=new Jr(-f.x,-f.y,-f.z),h=new Jr(f.x,f.y,f.z);this.translate(d),this.transformByMatrix4(C),this.translate(h)}else{var C;(C=new Ne).rotationAxisAngRad(-u,c.x,c.y,c.z),this.transformByMatrix4(C)}i.updateModelViewMatrixByCamera(this),t.zAngVelocity*=.9,t.xAngVelocity*=.9,Math.abs(t.zAngVelocity)<1e-11&&Math.abs(t.xAngVelocity)<1e-11&&(t.movementType=I.movementType.NO_MOVEMENT)}return!0},X.prototype.transformByMatrix4=function(e){this.position=e.transformPoint3D(this.position,this.position),this.direction=e.rotatePoint3D(this.direction,this.direction),this.up=e.rotatePoint3D(this.up,this.up)},X.prototype.getCameraDirectionLine=function(e){return void 0===e&&(e=new Rr),e.point.set(this.position.x,this.position.y,this.position.z),e.direction.set(this.direction.x,this.direction.y,this.direction.z),e},X.prototype.getCameraElevation=function(){var e,t=(e=Te.CartesianToGeographicWgs84(this.position.x,this.position.y,this.position.z,e)).latitude;return this.position.getModul()-Te.radiusAtLatitudeDeg(t)},X.prototype.getCameraRight=function(){return void 0===this.right&&(this.right=new Jr),this.right=this.direction.crossProduct(this.up,this.right),this.right},X.prototype.setDirty=function(e){this.dirty=e},X.prototype.getDirty=function(){return this.dirty},X.prototype.isCameraMoved=function(e,t,r,i,o,n,a,s,l){var u=this.position;if(Math.abs(u.x-e)>.001||Math.abs(u.y-t)>.001||Math.abs(u.z-r)>.001)return!0;var c=this.direction;if(Math.abs(c.x-i)>.001||Math.abs(c.y-o)>.001||Math.abs(c.z-n)>1e-5)return!0;var d=this.up;return Math.abs(d.x-a)>.001||Math.abs(d.y-s)>.001||Math.abs(d.z-l)>1e-5},X.prototype.calculateSpeed=function(e,t,r,i){var o=(i-this.updatedTime)/1e3;if(!(o<1e-12)){var n=this.position;this.speed3d.set((e-n.x)/o,(t-n.y)/o,(r-n.z)/o),this.updatedTime=i,this.lastMovement||(this.lastMovement={}),this.lastMovement.currLinearVelocity=this.speed3d.getModul(),this.lastMovement.currLinearVelocity<1e-4?this.lastMovement.movementType=I.movementType.NO_MOVEMENT:this.lastMovement.movementType=I.movementType.TRANSLATION}},X.prototype.getBigFrustum=function(){return this.bigFrustum},X.prototype.getFrustum=function(e){return void 0===this.frustumsArray[e]&&(this.frustumsArray[e]=new fe,this.frustumsArray[e].fovRad[0]=this.frustumsArray[0].fovRad[0],this.frustumsArray[e].fovyRad[0]=this.frustumsArray[0].fovyRad[0],this.frustumsArray[e].aspectRatio[0]=this.frustumsArray[0].aspectRatio[0],this.frustumsArray[e].tangentOfHalfFovy[0]=this.frustumsArray[0].tangentOfHalfFovy[0]),this.frustumsArray[e]},X.prototype.getLastFrustum=function(){return this.getFrustum(this.frustumsArray.length-1)},X.prototype.setFrustumsDistances=function(e,t){for(var r,i=0;i<e;i++)t[i],(r=this.getFrustum(i)).near[0]=t[2*i],r.far[0]=t[2*i+1],0===i&&(this.bigFrustum.near[0]=t[2*i]),i===e-1&&(this.bigFrustum.far[0]=t[2*i+1])},X.prototype.setAspectRatioAndFovyRad=function(e,t){var r,i;(i=this.getFrustum(0)).aspectRatio[0]=e,i.fovyRad[0]=t,i.fovRad[0]=t*e,i.tangentOfHalfFovy[0]=Math.tan(t/2);for(var o=this.frustumsArray.length,n=1;n<o;n++)(r=this.getFrustum(n)).aspectRatio[0]=i.aspectRatio[0],r.fovyRad[0]=i.fovyRad[0],r.fovRad[0]=i.fovRad[0],r.tangentOfHalfFovy[0]=i.tangentOfHalfFovy[0];this.bigFrustum.aspectRatio[0]=i.aspectRatio[0],this.bigFrustum.fovyRad[0]=i.fovyRad[0],this.bigFrustum.fovRad[0]=i.fovRad[0],this.bigFrustum.tangentOfHalfFovy[0]=i.tangentOfHalfFovy[0]},X.prototype.setCurrentFrustum=function(e){this.frustum=this.getFrustum(e)},X.prototype.bindUniforms=function(e,t){var r=this.frustum;e.uniform1f(t.frustumNear_loc,r.near[0]),e.uniform1f(t.frustumFar_loc,r.far[0])},X.prototype.calculateFrustumsPlanes=function(){var e,t,r=(e=this.getFrustum(0)).tangentOfHalfFovy[0]*e.near[0]*2,i=e.tangentOfHalfFovy[0]*e.far[0]*2,o=(e.aspectRatio[0],i*e.aspectRatio[0]),n=this.position.x,a=this.position.y,s=this.position.z,l=this.direction.x,u=this.direction.y,c=this.direction.z;this.right=this.direction.crossProduct(this.up,this.right),this.nearCenterPoint.set(n+l*e.near[0],a+u*e.near[0],s+c*e.near[0]),this.farCenterPoint.set(n+l*e.far[0],a+u*e.far[0],s+c*e.far[0]),this.farLeftBottomPoint.set(this.farCenterPoint.x-this.right.x*o*.5-this.up.x*i*.5,this.farCenterPoint.y-this.right.y*o*.5-this.up.y*i*.5,this.farCenterPoint.z-this.right.z*o*.5-this.up.z*i*.5),this.farRightTopPoint.set(this.farLeftBottomPoint.x+this.right.x*o+this.up.x*i,this.farLeftBottomPoint.y+this.right.y*o+this.up.y*i,this.farLeftBottomPoint.z+this.right.z*o+this.up.z*i),this.leftBottomDir.set(this.farLeftBottomPoint.x-n,this.farLeftBottomPoint.y-a,this.farLeftBottomPoint.z-s),this.leftBottomDir.unitary(),this.rightTopDir.set(this.farRightTopPoint.x-n,this.farRightTopPoint.y-a,this.farRightTopPoint.z-s),this.rightTopDir.unitary(),e.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,u,c),e.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-u,-c),this.leftNormal=this.leftBottomDir.crossProduct(this.up,this.leftNormal),this.leftNormal.unitary(),e.planesArray[2].setPointAndNormal(n,a,s,this.leftNormal.x,this.leftNormal.y,this.leftNormal.z),this.bottomNormal=this.right.crossProduct(this.leftBottomDir,this.bottomNormal),this.bottomNormal.unitary(),e.planesArray[3].setPointAndNormal(n,a,s,this.bottomNormal.x,this.bottomNormal.y,this.bottomNormal.z),this.rightNormal=this.up.crossProduct(this.rightTopDir,this.rightNormal),this.rightNormal.unitary(),e.planesArray[4].setPointAndNormal(n,a,s,this.rightNormal.x,this.rightNormal.y,this.rightNormal.z),this.topNormal=this.rightTopDir.crossProduct(this.right,this.topNormal),this.topNormal.unitary(),e.planesArray[5].setPointAndNormal(n,a,s,this.topNormal.x,this.topNormal.y,this.topNormal.z);for(var d=this.frustumsArray.length,h=1;h<d;h++){t=this.getFrustum(h),this.nearCenterPoint.set(n+l*t.near[0],a+u*t.near[0],s+c*t.near[0]),this.farCenterPoint.set(n+l*t.far[0],a+u*t.far[0],s+c*t.far[0]),t.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,u,c),t.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-u,-c);for(var f=2;f<6;f++)t.planesArray[f]=e.planesArray[f]}this.nearCenterPoint.set(n+l*this.bigFrustum.near[0],a+u*this.bigFrustum.near[0],s+c*this.bigFrustum.near[0]),this.farCenterPoint.set(n+l*this.bigFrustum.far[0],a+u*this.bigFrustum.far[0],s+c*this.bigFrustum.far[0]),this.bigFrustum.planesArray[0].setPointAndNormal(this.nearCenterPoint.x,this.nearCenterPoint.y,this.nearCenterPoint.z,l,u,c),this.bigFrustum.planesArray[1].setPointAndNormal(this.farCenterPoint.x,this.farCenterPoint.y,this.farCenterPoint.z,-l,-u,-c);for(this.getLastFrustum(),f=2;f<6;f++)this.bigFrustum.planesArray[f]=e.planesArray[f]},X.prototype.doTrack=function(e){if(this.tracked){var t=this.tracked;if(e.isCesiumGlobe()){var i,o,n=e.scene.camera,a=n.positionWC;if(t instanceof lr?o=t.getNodeGeoLocDataManager():t instanceof r&&(o=t.geoLocDataManager),void 0===o)return;var s=o.getCurrentGeoLocationData();if(void 0===s)return;var l=o.getGeoLocationData(1);if(Qo(l)){var u=s.positionLOW,c=l.positionLOW,d=new Float32Array([0,0,0]),h=new Float32Array([0,0,0]);on.calculateSplited3fv([a.x,a.y,a.z],d,h);var f=u[0]-c[0],g=u[1]-c[1],p=u[2]-c[2];(i=new Cesium.Cartesian3).x=d[0]+h[0]+f,i.y=d[1]+h[1]+g,i.z=d[2]+h[2]+p}var m=s.getGeographicCoords();if(void 0===m)return;var v=Cesium.Cartesian3.fromDegrees(m.longitude,m.latitude,m.altitude);if(this.trackType===I.trackMode.TRACKING){var x=Cesium.Cartesian3.distance(i||a,v),_=new Cesium.HeadingPitchRange(n.heading,n.pitch,x);n.lookAt(v,_)}else{var y=s.rotMatrix,T=y.rotatePoint3D(new Jr(0,this.targetOffset,0)),C=y.rotatePoint3D(new Jr(0,this.trackCameraOffsetY,this.trackCameraOffsetZ));C.x=v.x+C.x,C.y=v.y+C.y,C.z=v.z+C.z,T.x=v.x+T.x,T.y=v.y+T.y,T.z=v.z+T.z;var b=s.geoLocMatrix._floatArrays,M=new Jr(b[8],b[9],b[10]);X.setByPositionAndTargetCesiumCamera(n,T,C,M)}}}else this.gotoAnimation},X.prototype.stopTrack=function(e){this.tracked=void 0,e.isCesiumGlobe()&&e.scene.camera.lookAtTransform(Cesium.Matrix4.IDENTITY)},X.prototype.setTrack=function(e,t){this.initTrackOption(),this.tracked=e,t&&(this.trackType=Zo(t.type,this.trackType),this.targetOffset=Zo(t.targetOffset,this.targetOffset),t.trackCameraOffset&&(this.trackCameraOffsetY=Jo(t.trackCameraOffset.y,this.trackCameraOffsetY),this.trackCameraOffsetZ=Jo(t.trackCameraOffset.z,this.trackCameraOffsetZ)))},X.prototype.initTrackOption=function(){this.trackType=I.trackMode.TRACKING,this.targetOffset=10,this.trackCameraOffsetY=-1,this.trackCameraOffsetZ=12},X.prototype.getPosition=function(){return this.position},X.prototype.getEncodedCameraPosition=function(){return this._lastPosition||(this._lastPosition=new Jr(0,0,0)),this.encodedCamPosHigh&&this.encodedCamPosLow||(this.encodedCamPosHigh=new Float32Array(3),this.encodedCamPosLow=new Float32Array(3)),this.position.x===this._lastPosition.x&&this.position.y===this._lastPosition.y&&this.position.z===this._lastPosition.z||(on.calculateSplited3fv([this.position.x,this.position.y,this.position.z],this.encodedCamPosHigh,this.encodedCamPosLow),this._lastPosition.set(this.position.x,this.position.y,this.position.z)),{high:this.encodedCamPosHigh,low:this.encodedCamPosLow}},X.prototype.getDirection=function(){return this.direction},X.prototype.getUp=function(){return this.up},X.prototype.getTargetPositionAtDistance=function(e,t){void 0===t&&(t=new Jr);var r=this.direction,i=this.position;return t.set(i.x+r.x*e,i.y+r.y*e,i.z+r.z*e),t},X.prototype.getTargetOnTerrain=function(e,t){void 0===t&&(t=new Jr);var r=e.sceneState.getScreenCenterPositionPixels(void 0),i=e.getGl();return t=on.calculatePixelPositionWorldCoord(i,r.x,r.y,t,void 0,void 0,void 0,e)},X.setByPositionAndTarget=function(e,t,r,i){e.getPosition().set(r.x,r.y,r.z);var o=e.getDirection();if(o.set(t.x-r.x,t.y-r.y,t.z-r.z),o.unitary(),!i){var n=Te.normalAtCartesianPointWgs84(r.x,r.y,r.z,void 0);i=new Jr(n[0],n[1],n[2])}var a=e.getRight();a=o.crossProduct(i,a);var s=e.getUp();(s=a.crossProduct(o,s)).unitary()},X.setByPositionAndTargetCesiumCamera=function(e,t,r,i,o){var n=new Jr;if(n.set(t.x-r.x,t.y-r.y,t.z-r.z),n.unitary(),!i){var a=Te.normalAtCartesianPointWgs84(r.x,r.y,r.z,void 0);i=new Jr(a[0],a[1],a[2])}var s=n.crossProduct(i).crossProduct(n);s.unitary(),e.setView({destination:r,orientation:{direction:new Cesium.Cartesian3(n.x,n.y,n.z),up:new Cesium.Cartesian3(s.x,s.y,s.z)}})},X.setOrientation=function(e,t,r,i){var o=e.position,n=new Ne,a=on.calculateTransformMatrixAtWorldPosition(o,t,r,i,n,void 0),s=a.getZAxis(void 0);s.scale(-1);var l=a.getYAxis(void 0);e.direction.set(s.x,s.y,s.z),e.up.set(l.x,l.y,l.z)},X.prototype.getDepthBufferFBO=function(e,t){if(!this.depthBufferFBO){var r=e.getGl(),i=e.sceneState.drawingBufferWidth[0],o=e.sceneState.drawingBufferHeight[0];t&&(t.bufferWidth&&(i=t.bufferWidth),t.bufferHeight&&(o=t.bufferHeight));this.depthBufferFBO=new ae(r,i,o,{matchCanvasSize:!1,multiRenderTarget:!1})}return this.depthBufferFBO},X.prototype.getModelViewMatrix=function(){var e=new Ne,t=this.getPosition(),r=this.getTargetPositionAtDistance(1e4),i=this.getUp();return e._floatArrays=Ne.lookAt(e._floatArrays,[t.x,t.y,t.z],[r.x,r.y,r.z],[i.x,i.y,i.z]),e},X.prototype.getModelViewMatrixRelToEye=function(){var e=this.getModelViewMatrix();return e._floatArrays[12]=0,e._floatArrays[13]=0,e._floatArrays[14]=0,e._floatArrays[15]=1,e},X.prototype.getOrientation=function(e){var t,r,i,o=this.position,n=this.direction,a=this.up,s=this.getRight(),l=on.calculateGeoLocationMatrixAtWorldPosition(o,void 0).getInverse(),u=l.rotatePoint3D(n,void 0),c=l.rotatePoint3D(a,void 0),d=l.rotatePoint3D(s,void 0),h=Math.abs(u.z);return t=Math.abs(h-1)>1e-5?Math.atan2(u.y,u.x)+Math.PI+Math.PI/2:Math.atan2(c.y,c.x)+Math.PI+Math.PI/2,r=Math.PI-Math.acos(u.z),Math.abs(h-1)>1e-5&&(i=Math.atan2(-d.z,c.z)),void 0===e&&(e={}),e.headingRad=t,e.pitchRad=r,e.rollRad=i,e},X.prototype.getRight=function(){return this.right=this.direction.crossProduct(this.up,this.right),this.right},X.prototype.calculateUp=function(e){this.right=this.direction.crossProduct(e,this.right),this.right.unitary(),this.up=this.right.crossProduct(this.direction,this.up),this.up.unitary()},X.prototype.finishedAnimation=function(e){var t=this.animationData;if(void 0===t)return!0;var r=e.getCurrentTime();if(t.animationType===I.animationType.PATH){var i=U.getNextPosition(t,r,e);if(void 0===i)return t.finished=!0,!0;var o,n=this.position,a=this.direction,s=this.up,l=t.path.getGeoLocationDataManager().getCurrentGeoLocationData(),u=i.point,c=l.tMatrix.transformPoint3D(u,void 0),d=new Jr(n.x,n.y,n.z),h=new Jr(c.x,c.y,c.z);if(n.set(h.x,h.y,h.z),(o=d.crossProduct(h,o)).unitary(),o.isNAN())return!1;var f=d.angleRadToVector(h);if(0===f||isNaN(f))return!1;var g=new Ne;return g.rotationAxisAngRad(f,o.x,o.y,o.z),a=g.transformPoint3D(a,a),s=g.transformPoint3D(s,s),e.magoWorld.updateModelViewMatrixByCamera(this),t.lastTime=r,!1}return!1},X.prototype.finishedAnimation__original=function(e){var t=this.animationData;if(void 0===t)return!0;var r=e.getCurrentTime();if(t.animationType===I.animationType.PATH){var i=U.getNextPosition(t,r,e);if(void 0===i)return t.finished=!0,!0;var o=t.path.getGeoLocationDataManager().getCurrentGeoLocationData(),n=i.point,a=(i.direction,o.tMatrix.transformPoint3D(n,void 0));this.position.copyFrom(a);var s=Te.normalAtCartesianPointWgs84(a.x,a.y,a.z,void 0);return this.calculateUp(new Jr(s[0],s[1],s[2])),e.magoWorld.updateModelViewMatrixByCamera(this),t.lastTime=r,!1}return!1},X.intersectPointByLaser=function(e,t,r,i,o,n){r||(r=new X),i||(i=new Jr);var a=Zo((n=n||{}).error,.1),s=on.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,void 0),l=on.geographicCoordToWorldPoint(t.longitude,t.latitude,t.altitude,void 0),u=s.distToPoint(l),c=1.2*u;X.setByPositionAndTarget(r,l,s,void 0);var d=r.getDepthBufferFBO(o,{bufferWidth:64,bufferHeight:64}),h=r.getBigFrustum();if(h.setFar(c),h.setAspectRatio(d.getAspectRatio()),h.setFovyRad(Math.PI/32),i=X.shootLaser(r,i,o,n),!(s.distToPoint(i)>u)){if(s.distToPoint(i)<a||l.distToPoint(i)<a);return i}},X.shootLaser=function(e,t,r,i){i=i||{};var o=e.getDepthBufferFBO(r,{bufferWidth:64,bufferHeight:64}),n=r.frustumVolumeControl.getAllVisiblesObjectArrays(),a=Zo(i.nodesArray,n.nodeArray),s=Zo(i.nativesArray,n.nativeArray),l=new _t;l.currentVisibles0=a,l.currentVisibleNativeObjects.opaquesArray=s;var u=r.getGl(),c=u.getParameter(u.VIEWPORT),d=o.getWidth(),h=o.getHeight();o.bind(),u.viewport(0,0,d,h),u.clearColor(1,1,1,1),u.clearDepth(1),u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT),r.renderer.renderDepthCameraPointOfView(e,l);var f=new Uint8Array(4),g=Math.floor(d/2),p=Math.floor(h/2);u.readPixels(g,p,1,1,u.RGBA,u.UNSIGNED_BYTE,f);var m=new Float32Array([f[0]/255,f[1]/255,f[2]/255,f[3]/255]),v=on.unpackDepth(m);v>1&&(v=1);var x=v*e.getBigFrustum().far[0];return t||(t=new Jr),t=e.getTargetPositionAtDistance(x,t),o.unbind(),u.viewport(c[0],c[1],c[2],c[3]),t};var Y,q=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.name="noName",void 0!==t&&(this.name=t),this.geoLocationData=new _e,this.minHeading=0,this.maxHeading=90,this.heading=0,this.pitch=0,this.roll=0,this.targetHeading,this.targetPitch,this.targetRoll,this.rotMat=new Ne,this.camera=new X,this.vboKeyContainer,this.vboKeyContainerEdges,this.color=new J,this.color.setRGBA(0,.5,.9,.3),this.greenFactorSpeed=1,this.blueFactorSpeed=2,this.alphaFactorSpeed=2,this.headingAngularSpeed=25,this.pitchAngularSpeed,this.rollAngularSpeed,this.lastTime,this.greenFactor=1,this.blueFactor=1,this.alphaFactor=1};q.prototype.updateTime=function(e){this.lastTime=e},q.prototype.setOrientation=function(e,t,r,i){if(this.targetHeading=e,this.targetPitch=t,this.targetRoll=r,void 0!==this.targetHeading){var o=this.targetHeading-this.heading;this.headingAngularSpeed=o/i,0===this.headingAngularSpeed&&(this.targetHeading=void 0,this.headingAngularSpeed=void 0)}if(void 0!==this.targetPitch){var n=this.targetPitch-this.pitch;this.pitchAngularSpeed=n/i,0===this.pitchAngularSpeed&&(this.targetPitch=void 0,this.pitchAngularSpeed=void 0)}if(void 0!==this.targetRoll){var a=this.targetRoll-this.roll;this.rollAngularSpeed=a/i,0===this.rollAngularSpeed&&(this.targetRoll=void 0,this.rollAngularSpeed=void 0)}},q.prototype.updateOrientation=function(e){if(void 0!==this.targetHeading||void 0!==this.targetPitch||void 0!==this.targetRoll){void 0===this.lastTime&&(this.lastTime=e);var t=(e-this.lastTime)/1e3;void 0!==this.headingAngularSpeed&&(this.heading+=t*this.headingAngularSpeed,this.headingAngularSpeed>0?this.heading>=this.targetHeading&&(this.heading=this.targetHeading,this.targetHeading=void 0):this.heading<=this.targetHeading&&(this.heading=this.targetHeading,this.targetHeading=void 0),0===this.headingAngularSpeed&&(this.targetHeading=void 0,this.headingAngularSpeed=void 0)),void 0!==this.pitchAngularSpeed&&(this.pitch+=t*this.pitchAngularSpeed,this.pitchAngularSpeed>0?this.pitch>=this.targetPitch&&(this.pitch=this.targetPitch,this.targetPitch=void 0):this.pitch<=this.targetPitch&&(this.pitch=this.targetPitch,this.targetPitch=void 0),0===this.pitchAngularSpeed&&(this.targetPitch=void 0,this.pitchAngularSpeed=0)),void 0!==this.rollAngularSpeed&&(this.roll+=t*this.rollAngularSpeed,this.rollAngularSpeed>0?this.roll>=this.targetRoll&&(this.roll=this.targetRoll,this.targetRoll=void 0):this.roll<=this.targetRoll&&(this.roll=this.targetRoll,this.targetRoll=void 0),0===this.rollAngularSpeed&&(this.targetRoll=void 0,this.rollAngularSpeed=void 0)),this.calculateRotationMatrix()}},q.prototype.updateHeading=function(e){void 0===this.lastTime&&(this.lastTime=e);var t=(e-this.lastTime)/1e3;this.heading+=t*this.headingAngularSpeed,this.heading>this.maxHeading?(this.heading=this.maxHeading,this.headingAngularSpeed*=-1):this.heading<this.minHeading&&(this.heading=this.minHeading,this.headingAngularSpeed*=-1),this.calculateRotationMatrix()},q.prototype.updateColor=function(e){void 0===this.lastTime&&(this.lastTime=e);var t=(e-this.lastTime)/1e3;void 0===this.greenFactor&&(this.greenFactor=1),void 0===this.blueFactor&&(this.blueFactor=1),void 0===this.alphaFactor&&(this.alphaFactor=1),this.greenFactor+=this.greenFactorSpeed*t,this.blueFactor+=this.blueFactorSpeed*t,this.greenFactor>.5&&(this.greenFactor=.5,this.greenFactorSpeed*=-1),this.greenFactor<0&&(this.greenFactor=0,this.greenFactorSpeed*=-1),this.blueFactor>.9&&(this.blueFactor=.9,this.blueFactorSpeed*=-1),this.blueFactor<0&&(this.blueFactor=0,this.blueFactorSpeed*=-1),this.alphaFactor>.6&&(this.alphaFactor=.6,this.alphaFactorSpeed*=-1),this.alphaFactor<0&&(this.alphaFactor=0,this.alphaFactorSpeed*=-1),this.color.setRGBA(0,this.greenFactor,this.blueFactor,this.alphaFactor)},q.prototype.calculateRotationMatrix=function(){var e;e=Ne.getRotationDegZXYMatrix(this.heading,this.pitch,this.roll,e),this.rotMat=e.getMultipliedByMatrix(this.geoLocationData.rotMatrix,this.rotMat)},q.prototype.getVbo=function(e,t,r){var i;void 0===e&&(e=new xt),void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new xt),i=this.makeFrustumGeometry_2(i);var o=new Ne,n=this.camera.bigFrustum.fovyRad[0]/2;o.rotationAxisAngDeg(180*-n/Math.PI,1,0,0);var a=i.getSurfaceIndependentMesh(void 0,!0,!0);return a.transformByMatrix4(o),a.setColor(0,.5,.9,.3),a.getVbo(e,r),a.getVboEdges(this.vboKeyContainerEdges,r),e},q.prototype.render=function(e,t,r){if(void 0!==this.vboKeyContainer){var i;this.vboKeyContainer.vboCacheKeysArray.length;e.uniformMatrix4fv(r.buildingRotMatrix_loc,!1,this.geoLocationData.rotMatrix._floatArrays),e.uniform3fv(r.buildingPosHIGH_loc,this.geoLocationData.positionHIGH),e.uniform3fv(r.buildingPosLOW_loc,this.geoLocationData.positionLOW),e.uniform1i(r.hasTexture_loc,!1),e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(1,3);e.uniform1i(r.refMatrixType_loc,2),e.uniformMatrix4fv(r.refMatrix_loc,!1,this.rotMat._floatArrays);var o=t.renderer;i=!0,o.renderNormals=!1,e.uniform4fv(r.oneColor4_loc,[0,0,0,1]),o.renderVboContainer(e,this.vboKeyContainerEdges,t,r,i),e.enable(e.BLEND),i=!1,o.renderNormals=!0,e.uniform4fv(r.oneColor4_loc,[this.blueFactor,0,0,this.alphaFactor]),o.renderVboContainer(e,this.vboKeyContainer,t,r,i),e.disable(e.BLEND),e.disable(e.POLYGON_OFFSET_FILL)}},q.prototype.makeFrustumGeometry_2=function(e){void 0===e&&(e=new Wr),e.profile=new ii;var t,r,i=e.profile,o=this.camera.bigFrustum,n=o.far[0],a=o.fovyRad[0]/2,s=o.fovRad[0]/2,l=(Math.tan(s),Math.tan(a),i.newOuterRing());(t=l.newElement("POLYLINE")).newPoint2d(-n*Math.sin(s),n*Math.cos(s)),t.newPoint2d(0,0),t.newPoint2d(n*Math.sin(s),n*Math.cos(s));var u,c,d=90-180*s/Math.PI,h=90+180*s/Math.PI;r=l.newElement("ARC"),this.sweepSense=1,r.setCenterPosition(0,0),r.setRadius(n),r.setStartAngleDegree(d),r.setSweepAngleDegree(h-d),r.numPointsFor360Deg=36,u=2*a*180/Math.PI,c=new mi;var f=new Kr(-1,0),g=new Kr(1,0);return c.setPoints(f,g),6,e.revolve(i,u,6,c),e},q.prototype.makeFrustumGeometry=function(e){void 0===e&&(e=new kr),void 0===e.hedgesList&&(e.hedgesList=new wr);var t,r,i,o,n,a,s=new Jr(0,0,0),l=this.camera.bigFrustum,u=l.far[0],c=l.fovyRad[0]/2,d=l.fovRad[0]/2,h=-u*Math.tan(d),f=-h,g=u*Math.tan(c),p=-g,m=new Jr(h,p,-u),v=new Jr(f,p,-u),x=new Jr(f,g,-u),_=new Jr(h,g,-u),y=new wi(s),T=new wi(m),C=new wi(v),b=new wi(x),M=new wi(_);void 0===this.vboKeyContainerEdges&&(this.vboKeyContainerEdges=new xt),(t=e.newSurface().newFace()).addVertex(T),t.addVertex(M),t.addVertex(b),t.addVertex(C);for(var A=0,E=[],L=[],w=t.vertexArray.length,S=0;S<w;S++)r=t.vertexArray[S],a=Si.getNextIdx(S,t.vertexArray),i=t.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),L.push(A),A++,L.push(A),A++;(t=e.newSurface().newFace()).addVertex(y),t.addVertex(b),t.addVertex(M),w=t.vertexArray.length;for(S=0;S<w;S++)r=t.vertexArray[S],a=Si.getNextIdx(S,t.vertexArray),i=t.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),L.push(A),A++,L.push(A),A++;(t=e.newSurface().newFace()).addVertex(y),t.addVertex(M),t.addVertex(T),w=t.vertexArray.length;for(S=0;S<w;S++)r=t.vertexArray[S],a=Si.getNextIdx(S,t.vertexArray),i=t.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),L.push(A),A++,L.push(A),A++;(t=e.newSurface().newFace()).addVertex(y),t.addVertex(T),t.addVertex(C),w=t.vertexArray.length;for(S=0;S<w;S++)r=t.vertexArray[S],a=Si.getNextIdx(S,t.vertexArray),i=t.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),L.push(A),A++,L.push(A),A++;(t=e.newSurface().newFace()).addVertex(y),t.addVertex(C),t.addVertex(b),w=t.vertexArray.length;for(S=0;S<w;S++)r=t.vertexArray[S],a=Si.getNextIdx(S,t.vertexArray),i=t.vertexArray[a],o=r.point3d,n=i.point3d,E.push(o.x),E.push(o.y),E.push(o.z),E.push(n.x),E.push(n.y),E.push(n.z),L.push(A),A++,L.push(A),A++;var D=this.vboKeyContainerEdges.newVBOVertexIdxCacheKey();return D.posVboDataArray=Float32Array.from(E),D.idxVboDataArray=Int16Array.from(L),D.indicesCount=D.idxVboDataArray.length,e.calculateVerticesNormals(),e},(Y=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.camerasList=[],this.bDrawCCTVNames=!0}).prototype.new_CCTV=function(e){var t=new q;return void 0!==e&&(t.name=e),this.camerasList.push(t),t},Y.prototype.getCCTV=function(e){return this.camerasList[e]},Y.prototype.getCCTVByName=function(e){for(var t,r,i=!1,o=this.getCCTVCount(),n=0;!i&&n<o;)(t=this.getCCTV(n)).name===e&&(r=t,i=!0),n++;return r},Y.prototype.getCCTVCount=function(){return this.camerasList.length},Y.prototype.render=function(e,t){var r=this.getCCTVCount();if(0!==r){var i=e.sceneState.gl;t.resetLastBuffersBinded();var o=t.program;i.useProgram(o),i.uniform1i(t.bApplySpecularLighting_loc,!1),i.disableVertexAttribArray(t.texCoord2_loc),i.enableVertexAttribArray(t.position3_loc),i.enableVertexAttribArray(t.normal3_loc),t.bindUniformGenerals(),i.uniform1i(t.textureFlipYAxis_loc,e.sceneState.textureFlipYAxis),i.uniform1i(t.colorType_loc,0),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e.depthFboNeo.colorBuffer),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,e.noiseTexture),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,e.textureAux_1x1),t.last_tex_id=e.textureAux_1x1,e.renderer.renderTexture=!1;for(var n=(new Date).getTime(),a=0;a<r;a++){var s=this.getCCTV(a);s.updateColor(n),s.updateOrientation(n),s.render(i,e,t),s.updateTime(n)}void 0!==this.bDrawCCTVNames&&!0===this.bDrawCCTVNames&&e.drawCCTVNames(this.camerasList),t.disableVertexAttribArrayAll()}},(Y=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.camerasList=[],this.bDrawCCTVNames=!0}).prototype.new_CCTV=function(e){var t=new q;return void 0!==e&&(t.name=e),this.camerasList.push(t),t},Y.prototype.getCCTV=function(e){return this.camerasList[e]},Y.prototype.getCCTVByName=function(e){for(var t,r,i=!1,o=this.getCCTVCount(),n=0;!i&&n<o;)(t=this.getCCTV(n)).name===e&&(r=t,i=!0),n++;return r},Y.prototype.getCCTVCount=function(){return this.camerasList.length},Y.prototype.render=function(e,t){var r=this.getCCTVCount();if(0!==r){var i=e.sceneState.gl;t.resetLastBuffersBinded();var o=t.program;i.useProgram(o),i.uniform1i(t.bApplySpecularLighting_loc,!1),i.disableVertexAttribArray(t.texCoord2_loc),i.enableVertexAttribArray(t.position3_loc),i.enableVertexAttribArray(t.normal3_loc),t.bindUniformGenerals(),i.uniform1i(t.textureFlipYAxis_loc,e.sceneState.textureFlipYAxis),i.uniform1i(t.colorType_loc,0),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e.depthFboNeo.colorBuffer),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,e.noiseTexture),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,e.textureAux_1x1),t.last_tex_id=e.textureAux_1x1,e.renderer.renderTexture=!1;for(var n=(new Date).getTime(),a=0;a<r;a++){var s=this.getCCTV(a);s.updateColor(n),s.updateOrientation(n),s.render(i,e,t),s.updateTime(n)}void 0!==this.bDrawCCTVNames&&!0===this.bDrawCCTVNames&&e.drawCCTVNames(this.camerasList),t.disableVertexAttribArrayAll()}};var K=function(e,t,r,o){if(!window.Cesium)throw new Error("if basicGlobe is Cesium, add Cesium Library");this.options=r||{},this.DEFALUT_IMAGE="ESRI World Imagery",this.DEFALUT_TERRAIN="WGS84 Ellipsoid",i.call(this,e,t)};(K.prototype=Object.create(i.prototype)).constructor=K,K.prototype.init=function(){this.setCanvasEventHandler(),this.options.animation=this.options.animation||!1,this.options.timeline=this.options.timeline||!1,this.providerBuild(),this.options.shouldAnimate=!1,this.options.baseLayerPicker=!1,this.viewer=new Cesium.Viewer(this.targetId,this.options),this.postProcessDataProvider(),this.initMagoManager()},K.prototype.setCanvasEventHandler=function(){var e=document.getElementById(this.targetId);e.addEventListener("webglcontextlost",function(e){console.log(e)},!1),e.addEventListener("webglcontextrestored",function(e){console.log(e)},!1)},K.prototype.providerBuild=function(){var e=this.policy,t=e.online,r=e.geoserverEnable,i=e.terrainType;if(!t&&!r)throw new Error("If your env is offline, must use geoserver.");r&&e.geoserverImageproviderEnable&&this.geoserverImageProviderBuild(),r&&i===I.cesiumTerrainType.GEOSERVER&&this.geoserverTerrainProviderBuild(),e.cesiumIonToken&&e.cesiumIonToken.length>0&&(Cesium.Ion.defaultAccessToken=e.cesiumIonToken);i=e.terrainType;var o=e.terrainValue;this.options.terrainProvider||(this.options.terrainProvider=K.makeTerrainProvider(i,o,e,e.geoserverTerrainproviderLayerName,e.geoserverTerrainproviderStyleName)),this.options.imageryProvider||(this.options.imageryProvider=new Cesium.ArcGisMapServerImageryProvider({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}))},K.makeTerrainProvider=function(e,t,r,i,o){var n=new Cesium.EllipsoidTerrainProvider;switch(e){case I.cesiumTerrainType.CESIUM_ION_DEFAULT:r.cesiumIonToken&&r.cesiumIonToken.length>0&&(n=new Cesium.CesiumTerrainProvider({url:Cesium.IonResource.fromAssetId(1)}));break;case I.cesiumTerrainType.CESIUM_ION_CDN:r.cesiumIonToken&&r.cesiumIonToken.length>0&&(n=new Cesium.CesiumTerrainProvider({url:Cesium.IonResource.fromAssetId(parseInt(t))}));break;case I.cesiumTerrainType.CESIUM_CUSTOMER:n=new(0,Cesium.CesiumTerrainProvider)({url:t});break;case I.cesiumTerrainType.GEOSERVER:if(!Cesium.GeoserverTerrainProvider)throw new Error("If you want use GeoserverTerrainProvider, GeoserverTerrainProvider plugin required.");var a={service:"WMTS"},s=t;if(!s)throw new Error("If use geoserverTerrainproviderEnable, geoserverTerrainproviderUrl is required.");a.url=s,a.layerName=i,o&&(a.styleName=o),a.maxLevel=13,n=new Cesium.GeoserverTerrainProvider(a)}return n},K.prototype.geoserverImageProviderBuild=function(){var e,t=this.policy,r=this.config.getGeoserver();if(t.geoserverImageproviderEnable||(t.geoserverImageproviderEnable=!0),!t.geoserverImageproviderUrl&&r&&(e=r.getDataRequestUrl()),!(e=t.geoserverImageproviderUrl))throw new Error("If use geoserverImageprovider, geoserverImageproviderUrl is required or input geoserverDataUrl and geoserverDataWorkspace.");var i=t.geoserverImageproviderLayerName;if(!i)throw new Error("If use geoserverImageprovider, geoserverImageproviderLayerName is required.");var o=r&&r.getWmsVersion()?r.getWmsVersion():"1.1.1",n=t.geoserverImageproviderStyleName?t.geoserverImageproviderStyleName:"",a=t.geoserverImageproviderParametersFormat?t.geoserverImageproviderParametersFormat:"image/jpeg",s=t.geoserverImageproviderParametersWidth?t.geoserverImageproviderParametersWidth:256,l=t.geoserverImageproviderParametersHeight?t.geoserverImageproviderParametersHeight:256,u={service:"WMS",version:o,request:"GetMap",styles:n,format:a},c=new Cesium.WebMapServiceImageryProvider({url:e,layers:i,parameters:u,tileWidth:s,tileHeight:l,enablePickFeatures:!1,minimumLevel:1});this.options.imageryProvider=c,this.options.baseLayerPicker=!1},K.prototype.geoserverTerrainProviderBuild=function(){if(!Cesium.GeoserverTerrainProvider)throw new Error("If you want use GeoserverTerrainProvider, GeoserverTerrainProvider plugin required.");var e=this.policy,t={service:"WMTS"},r=e.terrainValue;if(!r)throw new Error("If use geoserverTerrainproviderEnable, geoserverTerrainproviderUrl is required.");var i=e.geoserverTerrainproviderLayerName,o=e.geoserverTerrainproviderStyleName;t.url=r,t.layerName=i,t.styleName=o,t.maxLevel=13,this.options.terrainProvider=new Cesium.GeoserverTerrainProvider(t)},K.prototype.postProcessDataProvider=function(){var e=this.viewer;function t(e){e.entities.add({name:"mago3D",position:Cesium.Cartesian3.fromDegrees(37.521168,126.924185,3e3),box:{dimensions:new Cesium.Cartesian3(3e8,3e8,3e8),fill:!0,material:Cesium.Color.BLUE,outline:!1}})}if(t(e),e.entities.collectionChanged.addEventListener(function(r,i,o,n){0===r.values.length&&t(e)}),!this.options.imageryProvider){var r=null;if(this.viewer.baseLayerPicker){var i=this.viewer.baseLayerPicker.viewModel.imageryProviderViewModels;for(var o in i){if(i.hasOwnProperty(o))if((s=i[o]).name===this.DEFALUT_IMAGE){r=s;break}}r&&(this.viewer.baseLayerPicker.viewModel.selectedImagery=r)}else this.viewer.imageryLayers.removeAll(),this.viewer.imageryLayers.addImageryProvider(new Cesium.ArcGisMapServerImageryProvider({url:"https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"}),0)}if(!this.options.terrainProvider){null!==this.policy.initDefaultTerrain&&""!==this.policy.initDefaultTerrain&&(this.DEFALUT_TERRAIN=this.policy.initDefaultTerrain);var n=null,a=this.viewer.baseLayerPicker.viewModel.terrainProviderViewModels;for(var o in a){var s;if(a.hasOwnProperty(o))if((s=a[o]).name===this.DEFALUT_TERRAIN){n=s;break}}n&&(this.viewer.baseLayerPicker.viewModel.selectedTerrain=n)}},K.prototype.initMagoManager=function(){var e,t=this.policy,r=this.viewer;this.viewer.camera.frustum.fov=Cesium.Math.PI_OVER_THREE,t.initDefaultFov>0&&(this.viewer.camera.frustum.fov=Cesium.Math.PI_OVER_THREE*t.initDefaultFov);var i=this.viewer.scene.context._gl,o=new Fe(this.config);o.sceneState.textureFlipYAxis=!1,o.postFxShadersManager.gl=i,o.scene=this.viewer.scene,o.postFxShadersManager.createDefaultShaders(i),o.createDefaultShaders(i),this.viewer.scene.magoManager=o,this.magoManager=o,e=this.viewer.scene,this.viewer.scene.globe.depthTestAgainstTerrain=!1,this.viewer.scene.logarithmicDepthBuffer=!1,this.viewer.scene.highDynamicRange=!1,e.globe.terrainProviderChanged.addEventListener(function(e){var t=o.hierarchyManager.projectsMap;for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];for(var n in i)if(i.hasOwnProperty(n)){var a=i[n];a instanceof Mago3D.Node&&!0===a.data.attributes.isPhysical&&a.isNeedValidHeight(o)&&o._needValidHeightNodeArray.push(a)}}r=0;for(var s=o.modeler.objectsArray.length;r<s;r++){var l=o.modeler.objectsArray[r];l.isNeedValidHeight(o)&&o._needValidHeightNativeArray.push(l)}}),r.camera.changed.addEventListener(function(e){o.cameraChanged(e)}),r.camera.moveEnd.addEventListener(function(){o.cameraMoveEnd()}),r.camera.moveStart.addEventListener(function(){o.cameraMoveStart()})},K.prototype.setEventHandler=function(){var e=this.magoManager,t=e.scene;this.viewer.scene.magoManager.handler=new Cesium.ScreenSpaceEventHandler(t.canvas),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.LEFTDOWN,t.position,!1,e))},Cesium.ScreenSpaceEventType.LEFT_DOWN),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.LEFTDOWN,t.position,!0,e))},Cesium.ScreenSpaceEventType.LEFT_DOWN,Cesium.KeyboardEventModifier.SHIFT),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.MIDDLEDOWN,t.position,!1,e))},Cesium.ScreenSpaceEventType.MIDDLE_DOWN),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.RIGHTDOWN,t.position,!1,e))},Cesium.ScreenSpaceEventType.RIGHT_DOWN),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.MOUSEMOVE,t,!1,e))},Cesium.ScreenSpaceEventType.MOUSE_MOVE),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.MOUSEMOVE,t,!0,e))},Cesium.ScreenSpaceEventType.MOUSE_MOVE,Cesium.KeyboardEventModifier.SHIFT),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.LEFTUP,t.position,!1,e))},Cesium.ScreenSpaceEventType.LEFT_UP),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.LEFTUP,t.position,!0,e))},Cesium.ScreenSpaceEventType.LEFT_UP,Cesium.KeyboardEventModifier.SHIFT),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.MIDDLEUP,t.position,!1,e))},Cesium.ScreenSpaceEventType.MIDDLE_UP),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.RIGHTUP,t.position,!1,e))},Cesium.ScreenSpaceEventType.RIGHT_UP),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.CLICK,t.position,!1,e))},Cesium.ScreenSpaceEventType.LEFT_CLICK),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.CLICK,t.position,!0,e))},Cesium.ScreenSpaceEventType.LEFT_CLICK,Cesium.KeyboardEventModifier.SHIFT),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.DBCLICK,t.position,!1,e))},Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.RIGHTCLICK,t.position,!1,e))},Cesium.ScreenSpaceEventType.RIGHT_CLICK),e.handler.setInputAction(function(t){e.handleBrowserEvent(new V(Fe.EVENT_TYPE.WHEEL,{delta:t},!1,e))},Cesium.ScreenSpaceEventType.WHEEL),window.addEventListener("resize",function(t){e.isCameraMoved=!0},!1),this.viewer.clock.onTick.addEventListener(function(t){e.cameraFPV.update(e)})};var Z=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.hero,this.extrasArray};Z.prototype.doCheck=function(e){if(void 0===this.hero)return!1;if(void 0===this.extrasArray||0===this.extrasArray.length)return!1;var t=this.hero.data.neoBuilding;if(void 0===t)return!1;var r=t.getCollisionCheckOctree();if(void 0===r)return!1;void 0===e&&(e=[]);for(var i=this.extrasArray.length,o=0;o<i;o++){var n=this.extrasArray[o].data.neoBuilding;if(void 0!==n){var a=n.getCollisionCheckOctree();void 0!==a&&r.checkCollision(a,e)}}};var J=function e(t,r,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.r=0,this.g=0,this.b=0,this.a=1,void 0!==t&&(this.r=t),void 0!==r&&(this.g=r),void 0!==i&&(this.b=i),void 0!==o&&(this.a=o)};J.prototype.copyFrom=function(e){this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a},J.prototype.deleteObjects=function(){this.r=void 0,this.g=void 0,this.b=void 0,this.a=void 0},J.toArray=function(e){return[e.r,e.g,e.b,e.a]},J.getInterpolatedColorsArray=function(e,t,r,i){i||(i=[]);for(var o=1/(r-1),n=0,a=0;a<r;a++){var s=J.mix(e,t,n,void 0);i.push(s),n+=o}return i},J.mix=function(e,t,r,i){void 0===i&&(i=new J);var o=r,n=e.r*o+t.r*(1-o),a=e.g*o+t.g*(1-o),s=e.b*o+t.b*(1-o),l=e.a*o+t.a*(1-o);return i.setRGBA(n,a,s,l),i},J.prototype.set=function(e,t,r,i){this.r=e,this.g=t,this.b=r,this.a=i},J.prototype.setRGB=function(e,t,r){this.r=e,this.g=t,this.b=r},J.prototype.setRGBA=function(e,t,r,i){this.r=e,this.g=t,this.b=r,this.a=i},J.prototype.getHexCode=function(){var e=this.r,t=this.g,r=this.b;return J.getHexCode(e,t,r)},J.prototype.getRGB=function(){var e="rgb(";return e+=255*this.r+", ",e+=255*this.g+", ",e+=255*this.b,e+=")"},J.prototype.getRGBA=function(){var e="rgba(";return e+=255*this.r+", ",e+=255*this.g+", ",e+=255*this.b+", ",e+=this.a,e+=")"},J.getHexCode=function(e,t,r){var i=parseInt(255*e),o=parseInt(255*t),n=parseInt(255*r);return"#"+i.toString(16).padStart(2,"0")+o.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")},J.fromHexCode=function(e,t){var r=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),o=parseInt(e.slice(5,7),16);return void 0===t&&(t=new J),t.setRGB(r/256,i/256,o/256),t},J.getColorRGBRandom=function(e){return void 0===e&&(e=new J),e.setRGB(Math.random(),Math.random(),Math.random()),e},J.getColorPastelRGBRandom=function(e){return void 0===e&&(e=new J),e.setRGB(.5*Math.random()+.5,.5*Math.random()+.5,.5*Math.random()+.5),e},J.grayToRGB_MagoStyle=function(e,t){var r,i,o;return void 0===t&&(t=new J),e>1?e=1:e<0&&(e=0),r=1-e,i=e>.5?2*-e+2:2*e,o=e,t.setRGB(r,i,o),t},J.getRainbowColor_byHeight=function(e,t,r,i){var o=(e-t)/(r-t);o>1?o=.999999:o<0&&(o=0);var n=4*o,a=Math.floor(n),s=n%1,l=new J(0,0,0,o),u=new Jr(1,0,0),c=new Jr(1,1,0),d=new Jr(0,1,0),h=new Jr(0,1,1),f=new Jr(0,0,1);l.setRGB(1,0,0);var g=new Jr;return i?a>=0&&a<1?g=Jr.mix(u,c,s,g):a>=1&&a<2?g=Jr.mix(c,d,s,g):a>=2&&a<3?g=Jr.mix(d,h,s,g):a>=3&&(g=Jr.mix(h,f,s,g)):a>=0&&a<1?g=Jr.mix(f,h,s,g):a>=1&&a<2?g=Jr.mix(h,d,s,g):a>=2&&a<3?g=Jr.mix(d,c,s,g):a>=3&&(g=Jr.mix(c,u,s,g)),l.setRGB(g.x,g.y,g.z),l},J.grayToRGBYCM_MagoStyle=function(e,t){var r,i,o;return void 0===t&&(t=new J),e>1?e=1:e<0&&(e=0),e<.16666?(o=0,i=6*e,r=1):e>=.16666&&e<.33333?(o=0,i=1,r=2-6*e):e>=.33333&&e<.5?(o=6*e-2,i=1,r=0):e>=.5&&e<.66666?(o=1,i=4-6*e,r=0):e>=.66666&&e<.83333?(o=1,i=0,r=6*e-4):e>=.83333&&(o=6-6*e,i=0,r=1),t.setRGB(r,i,o),t},J.getWhiteToBlueColor_byHeight=function(e,t,r,i){var o,n,a,s=(e-r)/(t-r);if(s>=0&&s<.15625)o=(l=1)-(s-(u=0))/(.15625-u)*(l-.3515625);else if(s>=.15625&&s<.40625){var l;o=(l=.3515625)-(s-(u=.15625))/(.40625-u)*(l-0)}else o=0;if(s>=0&&s<.15625)n=1;else if(s>=.15625&&s<.5625){n=1-1*((s-(u=.15625))/(.5625-u))}else n=0;if(s<.5625)a=1;else{var u;a=1-1*((s-(u=.5625))/(1-u))}return void 0===i&&(i=new J),i.setRGB(o,n,a),i},J.getWhiteToBlueColor_byHeight2=function(e,t,r){for(var i,o,n,a=1,s=0;s<t.length-1;s++){var l=t[s],u=t[s+1];if(e>=t[0]){a=0;break}if(e<=l&&e>u){a=(s+(l-e)/(l-u))/(t.length-1);break}}if(a>=0&&a<.15625)i=(c=1)-(a-(d=0))/(.15625-d)*(c-.3515625);else if(a>=.15625&&a<.40625){var c;i=(c=.3515625)-(a-(d=.15625))/(.40625-d)*(c-0)}else i=0;if(a>=0&&a<.15625)o=1;else if(a>=.15625&&a<.5625){o=1-1*((a-(d=.15625))/(.5625-d))}else o=0;if(a<.5625)n=1;else{var d;n=1-1*((a-(d=.5625))/(1-d))}return void 0===r&&(r=new J),r.setRGB(i,o,n),r};var Q=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);t&&(this.elementsArray=t)};Q.prototype._getColorRGBA=function(e){var t=this.elementsArray;return t[e].colorRGBA||(t[e].colorRGBA=J.fromHexCode(t[e].color)),t[e].colorRGBA},Q.prototype.getInterpolatedColor=function(e){var t=this.getIdx(e),r=this.elementsArray,i=r.length;if(t<0)return this._getColorRGBA(0);if(t===i-1)return this._getColorRGBA(i-1);var o=t+1,n=this._getColorRGBA(t),a=this._getColorRGBA(o),s=r[t].value,l=(e-s)/(r[o].value-s);return J.mix(n,a,l,void 0)},Q.prototype.getIdx=function(e){var t=this.elementsArray.length;if(e<this.elementsArray[0].value)return 0;if(e>this.elementsArray[t-1].value)return t-1;for(var r=0;r<t;r++)if(e<this.elementsArray[r].value)return r-1;return-1};var $=function t(r){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);if(!(r&&r instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));e.call(this),this.manager=r,this.array=[],this.on(t.EVENT_TYPE.ADD,function(e){e.setControl(r)})};($.prototype=Object.create(e.prototype)).constructor=$,$.EVENT_TYPE={ADD:"add"},$.prototype.add=function(e){this.array.push(e),this.emit($.EVENT_TYPE.ADD,e)};var ee=function e(t,r,i){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(i=i||{},this.options=i,this.gl=t,this.width=new Int32Array(1),this.framebuffer=void 0,this.depthBuffer=void 0,this.colorBuffer=void 0,this.dirty=!0,this.numColorBuffers=1,this.colorBuffersArray=[],this.width[0]=r,i.multiRenderTarget&&(this.multiRenderTarget=!0),i.numColorBuffers&&(this.numColorBuffers=i.numColorBuffers),i.matchCanvasSize){var o=this;window.addEventListener("changeCanvasSize",function(){var e=o.gl.canvas;o.width[0]=e.offsetWidth,o.height[0]=e.offsetHeight,o.deleteObjects(o.gl),o.multiRenderTarget?o.initMRT():o.init()},!1)}this.multiRenderTarget?this.initMRT():this.init()};ee.prototype.init=function(){var e=this.gl;if(this.depthBuffer=e.createRenderbuffer(),this.options.colorBuffer?this.colorBuffer=this.options.colorBuffer:this.colorBuffer=e.createTexture(),!this.colorBuffer);e.bindTexture(e.TEXTURE_CUBE_MAP,this.colorBuffer),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_CUBE_MAP,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);for(var t=0;t<6;t++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,e.RGBA,this.width[0],this.width[0],0,e.RGBA,e.UNSIGNED_BYTE,null);this.framebuffer=[];for(t=0;t<6;t++){this.framebuffer[t]=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer[t]),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+t,this.colorBuffer,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthbuffer);var r=e.checkFramebufferStatus(e.FRAMEBUFFER);if(r!==e.FRAMEBUFFER_COMPLETE)throw"Cubemap framebuffer object is incomplete: "+r.toString()}e.bindFramebuffer(e.FRAMEBUFFER,null)},ee.prototype.initMRT=function(){var e=this.gl;this.fbo=e.createFramebuffer(),this.depthBuffer=e.createRenderbuffer(),this.extbuffers=e.getExtension("WEBGL_draw_buffers"),this.colorBuffersArray.length=0;for(var t=0;t<this.numColorBuffers;t++){var r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.width[0],this.height[0],0,e.RGBA,e.UNSIGNED_BYTE,null),this.colorBuffersArray.push(r)}this.colorBuffer=this.colorBuffersArray[0],this.colorBuffer1=this.colorBuffersArray[1],e.bindFramebuffer(e.FRAMEBUFFER,this.fbo),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.width[0],this.height[0]),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer);for(t=0;t<this.numColorBuffers;t++){r=this.colorBuffersArray[t];e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT0_WEBGL+t,e.TEXTURE_2D,r,0)}if(e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";e.bindFramebuffer(e.FRAMEBUFFER,null)},ee.prototype.getModelViewProjectionMatrix=function(e,t){if(!this.mvpMatrixArray)Math.PI;return this.mvpMatrixArray[e]};var te={F4D:"f4d",OBJECT:"object",NATIVE:"native",ALL:"all",getKey:function(e){switch(e){case"f4d":return"F4D";case"object":return"OBJECT";case"native":return"NATIVE";case"all":return"ALL";default:return"F4D"}},getValueByOrdinal:function(e){switch(e){case 0:return Mago3D.DataType.F4D;case 1:return Mago3D.DataType.OBJECT;case 2:return Mago3D.DataType.NATIVE;case 2:return Mago3D.DataType.ALL}}},re=function(e){J.call(this),this.redFactorSpeed=2,this.greenFactorSpeed=2,this.blueFactorSpeed=2,this.alphaFactorSpeed=2,this.redFactor=1,this.greenFactor=1,this.blueFactor=1,this.alphaFactor=1,e&&(this.redFactorSpeed=Jo(e.redFactorSpeed,1),this.greenFactorSpeed=Jo(e.greenFactorSpeed,1),this.blueFactorSpeed=Jo(e.blueFactorSpeed,2),this.alphaFactorSpeed=Jo(e.alphaFactorSpeed,2),this.redFactor=Jo(e.redFactor,1),this.greenFactor=Jo(e.greenFactor,1),this.blueFactor=Jo(e.blueFactor,1),this.alphaFactor=Jo(e.alphaFactor,1))};re.prototype=Object.create(J.prototype),re.prototype.constructor=re,re.prototype.updateColorAlarm=function(e){void 0===this.lastTime&&(this.lastTime=e);var t=(e-this.lastTime)/1e3;void 0===this.redFactor&&(this.redFactor=1),void 0===this.greenFactor&&(this.greenFactor=1),void 0===this.blueFactor&&(this.blueFactor=1),void 0===this.alphaFactor&&(this.alphaFactor=1),this.redFactor+=this.redFactorSpeed*t,this.greenFactor+=this.greenFactorSpeed*t,this.blueFactor+=this.blueFactorSpeed*t;this.redFactor>1&&(this.redFactor=1,this.redFactorSpeed*=-1);this.redFactor<.5&&(this.redFactor=.5,this.redFactorSpeed*=-1);this.greenFactor>.5&&(this.greenFactor=.5,this.greenFactorSpeed*=-1);this.greenFactor<.1&&(this.greenFactor=.1,this.greenFactorSpeed*=-1);this.blueFactor>.3&&(this.blueFactor=.3,this.blueFactorSpeed*=-1);this.blueFactor<.1&&(this.blueFactor=.1,this.blueFactorSpeed*=-1);this.alphaFactor>.6&&(this.alphaFactor=.6,this.alphaFactorSpeed*=-1);this.alphaFactor<0&&(this.alphaFactor=0,this.alphaFactorSpeed*=-1),this.greenFactor>this.redFactor&&(this.greenFactor=this.redFactor),this.setRGBA(this.redFactor,this.greenFactor,this.blueFactor,this.alphaFactor),this.updateTime(e)},re.prototype.updateTime=function(e){this.lastTime=e};var ie=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.workersManager=t,this.finishedMap={},this.maxWorkers=2,this.storeType=0};ie.prototype.isBusy=function(){return void 0===this.workersCount&&(this.workersCount=0),this.workersCount>this.maxWorkers},ie.prototype.doExtrude=function(e){void 0===this.workersCount&&(this.workersCount=0);var t=e.objectsToExtrudeArray,r=e.guid,i=e.color;i||(i=[241/255,231/255,200/255,1]);for(var o=t.length,n=new Array(o),a=0;a<o;a++){for(var s=t[a],l=s.geographicCoordsListsArray,u=l.length,c=new Array(u),d=0;d<u;d++){var h=l[d],f=ve.getNumbersArrayOfGeoCoordsList(h);c[d]=f}var g={geoCoordsNumbersArrayArray:c,height:s.height,color:i};n[a]=g}var p=this.workersManager.magoManager;if(!this.workerExtrudeObjects){var m=this;this.workerExtrudeObjects=Ko(p.config.scriptRootPath+"Worker/workerExtrudeObjects.js"),this.workerExtrudeObjects.onmessage=function(e){var t=e.data.result,r=t.info.guid;m.finishedMap||(m.finishedMap={}),m.finishedMap[r]=t,m.workersCount-=1}}var v={info:{guid:r},objectsToExtrudeArrayWorker:n,geoLocation:e.geoLocation,rotation:e.rotation};this.workerExtrudeObjects.postMessage(v),this.workersCount++;this.requestdedMap||(this.requestdedMap={}),this.requestdedMap[r]=!0},ie.prototype.getResult=function(e){if(this.finishedMap&&this.finishedMap[e]){var t=this.finishedMap[e];return 0===this.storeType&&delete this.finishedMap[e],t}};var oe=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.workersManager=t,this.finishedMap={},this.maxWorkers=20,this.storeType=0};oe.prototype.isBusy=function(){return void 0===this.workersCount&&(this.workersCount=0),this.workersCount>this.maxWorkers},oe.prototype.doExtrude=function(e){void 0===this.workersCount&&(this.workersCount=0);var t=e.objectsToExtrudeArray,r=e.guid,i=e.color;i||(i=[241/255,231/255,200/255,1]);for(var o=t.length,n=new Array(o),a=0;a<o;a++){for(var s,l=t[a],u=l.geographicCoordsListsArray,c=u.length,d=new Array(c),h=0;h<c;h++){var f=u[h],g=ve.getNumbersArrayOfGeoCoordsList(f);d[h]=g}if(l.divideLevel){var p=document.createElement("canvas"),m=p.getContext("2d");p.width=8,p.height=32,m.beginPath(),m.fillStyle="#262626",m.rect(0,0,8,1),m.fill(),m.closePath(),m.beginPath(),m.fillStyle=J.getHexCode(i[0],i[1],i[2]),m.rect(0,1,8,31),m.fill(),m.closePath(),s=p.toDataURL()}var v={geoCoordsNumbersArrayArray:d,height:l.height,floorHeight:l.floorHeight,divideLevel:l.divideLevel,imageUrl:s,color:i};n[a]=v}var x=this.workersManager.magoManager;if(!this.workerExtrudeObjects){var _=this;this.workerExtrudeObjects=Ko(x.config.scriptRootPath+"Worker/workerExtrusionObjects.js"),this.workerExtrudeObjects.onmessage=function(e){var t=e.data.result,r=t.info.guid;_.finishedMap||(_.finishedMap={}),_.finishedMap[r]=t,_.workersCount-=1}}var y={info:{guid:r},objectsToExtrudeArrayWorker:n,geoLocation:e.geoLocation,rotation:e.rotation};this.workerExtrudeObjects.postMessage(y),this.workersCount++;this.requestdedMap||(this.requestdedMap={}),this.requestdedMap[r]=!0},oe.prototype.getResult=function(e){if(this.finishedMap&&this.finishedMap[e]){var t=this.finishedMap[e];return 0===this.storeType&&delete this.finishedMap[e],t}};var ne=function t(r){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);if(!r||!r instanceof Fe)throw new Error("magoManager is required.");e.call(this),this.magoManager=r,this.smartTilePathInfo={}};(ne.prototype=Object.create(e.prototype)).constructor=ne,ne.prototype.showSmartTileGroup=function(e,t){if(void 0!==e&&null!==e){e=parseInt(e);var r=this.magoManager.hierarchyManager.getNodesMap(e),i=this.magoManager.f4dController.smartTilePathInfo;for(var o in i)if(i.hasOwnProperty(o)){var n=i[o];if(n.projectId===e){n.attributes.isVisible=t;break}}for(var a=Object.keys(r),s=0;s<a.length;s++){var l=a[s],u=r[l];if("attributes"!==l){var c=u.data;c&&c.attributes&&!0===c.attributes.isPhysical&&(c.attributes.isVisible=t)}else u.isVisible=t}}},ne.prototype.addSmartTileGroup=function(e){var t=[];if(Array.isArray(e))for(var r=0,i=e.length;r<i;r++){var o=e[r];o.tiling&&o.tilePath&&(r===i-1&&(o.smartTileIndexPath=o.tilePath),t.push(o))}else{if(!e.tiling||!e.tilePath)return;e.smartTileIndexPath=e.tilePath,t.push(e)}!function e(t,r){if(Array.isArray(r))for(var i=0,o=r.length;i<o;i++){var n=r[i];n.tiling&&n.tilePath&&(i===o-1&&(n.smartTileIndexPath=n.tilePath),e(t,n))}else{if(!r.tiling||!r.tilePath)return;var a,s,l=t.magoManager,u=r.data_key||r.dataGroupId,c=r.metainfo;c&&"string"==typeof c&&(c=JSON.parse(c)),r.data_key?(a=u,s=u):(a=(a=r.dataGroupPath).replace(/\/+$/,""),s=r.dataGroupKey),t.smartTilePathInfo[s]||(t.smartTilePathInfo[s]={}),t.smartTilePathInfo[s].attributes=r.attributes||c,t.smartTilePathInfo[s].projectId=u,t.smartTilePathInfo[s].projectFolderPath=a,r.smartTileIndexPath&&l.getObjectIndexFileSmartTileF4d(r.smartTileIndexPath)}}(this,t)},ne.prototype.deleteSmartTileGroup=function(e){var t=[];if(Array.isArray(e))for(var r=0,i=e.length;r<i;r++){var o=e[r];o.tiling&&o.tilePath&&(r===i-1&&(o.smartTileIndexPath=o.tilePath),t.push(o))}else{if(!e.tiling||!e.tilePath)return;e.smartTileIndexPath=e.tilePath,t.push(e)}!function e(t,r){if(Array.isArray(r))for(var i=0,o=r.length;i<o;i++){var n=r[i];n.tiling&&n.tilePath&&(i===o-1&&(n.smartTileIndexPath=n.tilePath),e(t,n))}else{if(!r.tiling||!r.tilePath)return;var a=t.magoManager,s=r.data_key?r.data_key||r.dataGroupId:r.dataGroupKey;r.smartTileIndexPath&&(a.getObjectIndexFileSmartTileF4dAndDeleteTile(r.smartTileIndexPath),t.smartTilePathInfo[s]&&delete t.smartTilePathInfo[s])}}(this,t)},ne.prototype.addF4dGroup=function(e){var t=this.magoManager;if(Array.isArray(e))for(var r=0,i=e.length;r<i;r++)this.addF4dGroup(e[r]);else{var o,n=e.data_key||e.dataKey||e.dataGroupId;o=e.data_key?n:(o=e.dataGroupPath).replace(/\/+$/,""),this.magoManager.config.setData(I.PROJECT_ID_PREFIX+n,e),this.magoManager.config.setProjectDataFolder(I.PROJECT_DATA_FOLDER_PREFIX+o,o),t.getObjectIndexFile(n,o)}},ne.prototype.addF4dMember=function(e,t){if(!e)throw new Error("groupId is required.");this.magoManager.getObjectIndexFileForData(e,t)},ne.prototype.deleteF4dGroup=function(e){if(!e)throw new Error("groupId is required.");var t=this.magoManager.hierarchyManager.getNodesMap(e);if(!t)throw new Error(e+" group is no exists.");for(var r=Object.keys(t),i=0,o=r.length;i<o;i++){var n=r[i];if("attributes"!==n)t[r[i]].data.attributes.isPhysical&&this.deleteF4dMember(e,n)}delete this.magoManager.hierarchyManager.projectsMap[e]},ne.prototype.deleteF4dMember=function(e,t,r){if(!e)throw new Error("groupId is required.");if(void 0===t||null===t)throw new Error("memberId is required.");var i=this.magoManager.hierarchyManager.getNodeByDataKey(e,t);if(!i)throw new Error("node is no exists.");var o=i.data.smartTileOwner;o&&o.eraseNode(i),this.magoManager.defaultSelectInteraction.selected===i&&this.magoManager.defaultSelectInteraction.clear(r),this.magoManager.selectionManager.removeF4d(i),i.deleteObjects(this.magoManager.sceneState.gl,this.magoManager.vboMemoryManager),delete this.magoManager.hierarchyManager.projectsMap[e][t]},ne.prototype.getF4d=function(e,t){if(!e)throw new Error("groupId is required.");if(void 0===t||null===t)throw new Error("memberId is required.");return this.magoManager.hierarchyManager.getNodeByDataKey(e,t)},ne.prototype.getF4dGroup=function(e){if(!e)throw new Error("groupId is required.");return this.magoManager.hierarchyManager.projectsMap[e]},ne.prototype.getStaticModelGroupKeys=function(){var e=[],t=this.magoManager.hierarchyManager.staticModelsManager;return t&&t.staticModelsMap&&(e=Object.keys(t.staticModelsMap)),e},ne.prototype.getStaticModelObject=function(){for(var e,t=this.getStaticModelGroupKeys(),r=0,i=t.length;r<i;r++){var o=t[r],n=this.getF4dGroup(o);e||(e={}),e[o]=n}return e},ne.f4dObjectValidate=function(e){console.info(e)};var ae=function e(t,r,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(o=o||{},this.options=o,this.gl=t,this.width=new Int32Array(1),this.height=new Int32Array(1),this.widthScale=1,this.heightScale=1,this.fbo=void 0,this.depthBuffer=void 0,this.colorBuffer=void 0,this.colorBuffer2=void 0,this.textureMagFilter=t.NEAREST,this.textureMinFilter=t.NEAREST,this.dirty=!0,this.numColorBuffers=1,this.colorBuffersArray=[],this.width[0]=r,this.height[0]=i,o.multiRenderTarget&&(this.multiRenderTarget=!0),o.numColorBuffers&&(this.numColorBuffers=o.numColorBuffers),o.matchCanvasSize){var n=this;window.addEventListener("changeCanvasSize",function(){var e=n.gl.canvas;n.width[0]=e.offsetWidth,n.height[0]=e.offsetHeight,n.deleteObjects(n.gl),n.multiRenderTarget?n.initMRT():n.init()},!1)}void 0!==o.widthScale&&(this.widthScale=o.widthScale),void 0!==o.heightScale&&(this.heightScale=o.heightScale),void 0!==o.textureMagFilter&&(this.textureMagFilter=o.textureMagFilter),void 0!==o.textureMinFilter&&(this.textureMinFilter=o.textureMinFilter),this.multiRenderTarget?this.initMRT():this.init()};ae.prototype.getWidth=function(){return Math.floor(this.width[0]*this.widthScale)},ae.prototype.getHeight=function(){return Math.floor(this.height[0]*this.heightScale)},ae.prototype.init=function(){var e=this.gl;this.fbo=e.createFramebuffer(),this.depthBuffer=e.createRenderbuffer();for(var t=0;t<this.numColorBuffers;t++){var r=e.createTexture();this.colorBuffersArray[t]=r,e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this.textureMagFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.textureMinFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.getWidth(),this.getHeight(),0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,this.fbo),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.getWidth(),this.getHeight()),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}this.colorBuffer=this.colorBuffersArray[0],e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.colorBuffer,0),e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE&&e.bindFramebuffer(e.FRAMEBUFFER,null)},ae.prototype.init_original=function(){var e=this.gl;this.fbo=e.createFramebuffer(),this.depthBuffer=e.createRenderbuffer();for(var t=0;t<this.numColorBuffers;t++){this.options.colorBuffer?this.colorBuffer=this.options.colorBuffer:this.colorBuffer=e.createTexture();e.createTexture();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.colorBuffer),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this.textureMagFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.textureMinFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.getWidth(),this.getHeight(),0,e.RGBA,e.UNSIGNED_BYTE,null),e.bindFramebuffer(e.FRAMEBUFFER,this.fbo),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.getWidth(),this.getHeight()),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer);this.colorBuffersArray[t];e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,this.colorBuffer,0)}if(this.colorBuffersArray[0]=this.colorBuffer,e.checkFramebufferStatus(e.FRAMEBUFFER)!==e.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";e.bindFramebuffer(e.FRAMEBUFFER,null)},ae.prototype.initMRT=function(){var e=this.gl;this.fbo=e.createFramebuffer(),this.depthBuffer=e.createRenderbuffer(),this.extbuffers=e.getExtension("WEBGL_draw_buffers"),this.colorBuffersArray.length=0;for(var t=0;t<this.numColorBuffers;t++){var r=e.createTexture();e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,this.textureMagFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.textureMinFilter),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.getWidth(),this.getHeight(),0,e.RGBA,e.UNSIGNED_BYTE,null),this.colorBuffersArray.push(r)}this.colorBuffer=this.colorBuffersArray[0],this.colorBuffer1=this.colorBuffersArray[1],e.bindFramebuffer(e.FRAMEBUFFER,this.fbo),e.bindRenderbuffer(e.RENDERBUFFER,this.depthBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.getWidth(),this.getHeight()),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.depthBuffer);for(t=0;t<this.numColorBuffers;t++){r=this.colorBuffersArray[t];e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT0_WEBGL+t,e.TEXTURE_2D,r,0)}e.checkFramebufferStatus(e.FRAMEBUFFER)===e.FRAMEBUFFER_COMPLETE&&e.bindFramebuffer(e.FRAMEBUFFER,null)},ae.prototype.setColorBuffer=function(e){this.colorBuffer=e;var t=this.gl;if(t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,this.textureMagFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,this.textureMinFilter),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.getWidth(),this.getHeight(),0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindFramebuffer(t.FRAMEBUFFER,this.fbo),t.bindRenderbuffer(t.RENDERBUFFER,this.depthBuffer),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,this.getWidth(),this.getHeight()),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE)throw"Incomplete frame buffer object.";t.bindFramebuffer(t.FRAMEBUFFER,null)},ae.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo)},ae.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)},ae.prototype.deleteObjects=function(e){if(this.depthBuffer&&e.deleteRenderbuffer(this.depthBuffer),this.depthBuffer=void 0,this.colorBuffersArray){for(var t=this.colorBuffersArray.length,r=0;r<t;r++)e.deleteTexture(this.colorBuffersArray[r]);this.colorBuffersArray.length=0}this.colorBuffer&&e.deleteTexture(this.colorBuffer),this.colorBuffer=void 0,this.fbo&&e.deleteFramebuffer(this.fbo),this.fbo=void 0},ae.createBuffer=function(e,t,r){void 0===r&&(r=e.ARRAY_BUFFER);var i=e.createBuffer();return e.bindBuffer(r,i),e.bufferData(r,t,e.STATIC_DRAW),i},ae.bindFramebuffer=function(e,t,r){e.bindFramebuffer(e.FRAMEBUFFER,t),r&&e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)},ae.bindFramebufferMRT=function(e,t,r,i,o){e.bindFramebuffer(e.FRAMEBUFFER,t),r&&e.framebufferTexture2D(e.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,r,0),i&&e.framebufferTexture2D(e.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,i,0)},ae.bindAttribute=function(e,t,r,i){e.bindBuffer(e.ARRAY_BUFFER,t),e.enableVertexAttribArray(r),e.vertexAttribPointer(r,i,e.FLOAT,!1,0,0)},ae.bindTexture=function(e,t,r){e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,t)},ae.prototype.getAspectRatio=function(){return this.getWidth()/this.getHeight()};var se=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.maxFilesRequestedCount=1,this.filesRequestedCount=0,this.headerFilesRequestedCount=0,this.modelRefFilesRequestedCount=0,this.lowLodDataRequestedCount=0,this.lowLodImagesRequestedCount=0,this.multiBuildingsDataRequestedCount=0,this.tinTerrainFilesRequested=0,this.tinTerrainTexturesRequested=0};se.prototype.isFull=function(){return this.filesRequestedCount>=this.maxFilesRequestedCount},se.prototype.isFullHeaders=function(){return this.headerFilesRequestedCount>=1},se.prototype.isFullPlus=function(e){return void 0===e&&(e=0),this.filesRequestedCount>=this.maxFilesRequestedCount+e},se.prototype.isFullPlusModelReferences=function(e){return void 0===e&&(e=0),this.modelRefFilesRequestedCount>=this.maxFilesRequestedCount+e},se.prototype.isFullPlusLowLodData=function(e){return void 0===e&&(e=0),this.lowLodDataRequestedCount>=this.maxFilesRequestedCount+e},se.prototype.isFullPlusLowLodImages=function(e){return void 0===e&&(e=0),this.lowLodImagesRequestedCount>=this.maxFilesRequestedCount+e};var le={moveForward:!1,moveBackward:!1,moveLeft:!1,moveRight:!1};function ue(e){switch(e){case 37:return"moveLeft";case 38:return"moveForward";case 39:return"moveRight";case 40:return"moveBackward";default:return}}function ce(e){var t=ue(e.keyCode);void 0!==t&&(le[t]=!0)}function de(e){var t=ue(e.keyCode);void 0!==t&&(le[t]=!1)}function he(){this._camera=void 0,this._cameraBAK=void 0,this._position=new Jr,this._rotation=new Jr,this._positionSpeed=1,this._ratationSpeed=1}Object.defineProperties(he.prototype,{camera:{get:function(){return this._camera},set:function(e){this._camera=e}},position:{get:function(){return this._position},set:function(e){this._position=e}},rotation:{get:function(){return this._rotation},set:function(e){this._rotation=e}},positionSpeed:{get:function(){return this._positionSpeed},set:function(e){this._positionSpeed=e}},rotationSpeed:{get:function(){return this._ratationSpeed},set:function(e){this._ratationSpeed=e}}}),he.prototype.init=function(){this._position.set(0,0,0),this._rotation.set(0,0,0),document.addEventListener("keydown",ce,!1),document.addEventListener("keyup",de,!1)},he.prototype.release=function(){this._camera=void 0,this._cameraBAK=void 0,document.removeEventListener("keydown",ce,!1),document.removeEventListener("keyup",de,!1)},he.prototype.move=function(e){var t=glMatrix.vec3.fromValues(this._position.x,this._position.y,this.position.z),r=glMatrix.mat4.create();glMatrix.mat4.rotateY(r,r,this._rotation.y),glMatrix.vec3.transformMat4(e,e,r),glMatrix.vec3.add(t,t,e),this._position.set(t[0],t[1],t[2])},he.prototype.update=function(e){void 0!==this._camera&&(le.moveForward&&(this._camera.moveForward(.5),this.move(vec3.fromValues(0,1,0))),le.moveBackward&&(this._camera.moveBackward(.5),this.move(vec3.fromValues(0,-1,0))),le.moveLeft&&(this._camera.lookLeft(.1),this.move(vec3.fromValues(-1,0,0))),le.moveRight&&(this._camera.lookRight(.1),this.move(vec3.fromValues(1,0,0))))};var fe=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.near=new Float32Array([.1]),this.far=new Float32Array([1e3]),this.fovyRad=new Float32Array([.8037]),this.tangentOfHalfFovy=new Float32Array([0]),this.fovRad=new Float32Array([1.047]),this.aspectRatio=new Float32Array([1.3584]),this.planesArray=[],this.dirty=!0;for(var t=0;t<6;t++){var r=new We;this.planesArray.push(r)}};fe.prototype.copyParametersFrom=function(e){this.near[0]=e.near[0],this.far[0]=e.far[0],this.fovyRad[0]=e.fovyRad[0],this.tangentOfHalfFovy[0]=e.tangentOfHalfFovy[0],this.fovRad[0]=e.fovRad[0],this.aspectRatio[0]=e.aspectRatio[0]},fe.getProjectionMatrix=function(e,t){return t||(t=new Ne),t._floatArrays=glMatrix.mat4.perspective(t._floatArrays,e.fovyRad[0],e.aspectRatio[0],e.near[0],e.far[0]),t},fe.prototype.setNear=function(e){this.near[0]=e},fe.prototype.setFar=function(e){this.far[0]=e},fe.prototype.setAspectRatio=function(e){this.aspectRatio[0]=e,this.fovRad[0]=e*this.fovyRad[0]},fe.prototype.setFovyRad=function(e){this.fovyRad[0]=e,this.tangentOfHalfFovy=Math.tan(e/2)},fe.prototype.intersectionNearFarSphere=function(e){for(var t=!1,r=0;r<2;r++){var i=this.planesArray[r].intersectionSphere(e);if(i===F.INTERSECTION_OUTSIDE)return F.INTERSECTION_OUTSIDE;i===F.INTERSECTION_INTERSECT&&(t=!0)}return t?F.INTERSECTION_INTERSECT:F.INTERSECTION_INSIDE},fe.prototype.intersectionSphere=function(e){for(var t=!1,r=0;r<6;r++){var i=this.planesArray[r].intersectionSphere(e);if(i===F.INTERSECTION_OUTSIDE)return F.INTERSECTION_OUTSIDE;i===F.INTERSECTION_INTERSECT&&(t=!0)}return t?F.INTERSECTION_INTERSECT:F.INTERSECTION_INSIDE};var ge=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.frustumVolumensMap={};this.nearFarArray=new Float32Array(8)};ge.prototype.getFrustumVolumeCulling=function(e){return this.frustumVolumensMap.hasOwnProperty(e)||(this.frustumVolumensMap[e]={},this.frustumVolumensMap[e].intersectedTilesArray=[],this.frustumVolumensMap[e].visibleNodes=new _t),this.frustumVolumensMap[e]},ge.prototype.initArrays=function(){var e;for(var t in this.frustumVolumensMap)Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,t)&&((e=this.frustumVolumensMap[t]).intersectedTilesArray.length=0,e.visibleNodes.initArrays())},ge.prototype.getTotalBoundingFrustum=function(e){var t;for(var r in e={},this.frustumVolumensMap)if(Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,r)&&(t=this.frustumVolumensMap[r]).intersectedTilesArray.length>0){var i=t.visibleNodes.bFrustumNear,o=t.visibleNodes.bFrustumFar;void 0!==i&&void 0!==o&&(void 0===e.bFrustumNear?e.bFrustumNear=i:i<e.bFrustumNear&&(e.bFrustumNear=i),void 0===e.bFrustumFar?e.bFrustumFar=o:o>e.bFrustumFar&&(e.bFrustumFar=o))}return e},ge.prototype.calculateBoundingFrustums=function(e){var t;for(var r in this.frustumVolumensMap)Object.prototype.hasOwnProperty.call(this.frustumVolumensMap,r)&&(t=this.frustumVolumensMap[r]).intersectedTilesArray.length>0&&t.visibleNodes.calculateBoundingFrustum(e)},ge.prototype.getAllVisiblesObject=function(){var e={},t={};for(var r in this.frustumVolumensMap)if(this.frustumVolumensMap.hasOwnProperty(r)){for(var i=this.frustumVolumensMap[r].visibleNodes,o=i.getAllNatives(),n=0,a=o.length;n<a;n++){var s=o[n];t[s._guid]||(t[s._guid]=s)}var l=i.getAllVisibles();for(n=0,a=l.length;n<a;n++){var u=l[n],c=u.getId();e[c]||(e[c]=u)}}return{nodeMap:e,nativeMap:t}},ge.prototype.getAllVisiblesObjectArrays=function(){var e=[],t=[];for(var r in this.frustumVolumensMap)if(this.frustumVolumensMap.hasOwnProperty(r)){var i=this.frustumVolumensMap[r].visibleNodes,o=i.getAllNatives();t=t.concat(o);var n=i.getAllVisibles();e=e.concat(n)}return{nodeArray:e,nativeArray:t}},ge.prototype.selectionByPolygon2D=function(e,t,r){var i=this.getAllVisiblesObject(),o=[],n=t===te.F4D?i.nodeMap:i.nativeMap;for(var a in n)if(n.hasOwnProperty(a)){var s=n[a];if(r&&"function"==typeof r&&r.call(this,s))continue;s.intersectionWithPolygon2D(e)&&o.push(s)}return o};var pe=function e(t,r,i){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.longitude,this.latitude,this.altitude,void 0!==t&&(this.longitude=t),void 0!==r&&(this.latitude=r),void 0!==i&&(this.altitude=i),this.absolutePoint,this.vboKeysContainer,this.geoLocDataManager,this.owner};pe.fromCartesian=function(e){return on.pointToGeographicCoord(e)},pe.prototype.deleteObjects=function(e){this.longitude=void 0,this.latitude=void 0,this.altitude=void 0,void 0!==this.absolutePoint&&(this.absolutePoint.deleteObjects(),this.absolutePoint=void 0),void 0!==this.vboKeysContainer&&this.vboKeysContainer.deleteGlObjects(e.gl,e),void 0!==this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.owner=void 0},pe.prototype.getWgs84Point3D=function(e){var t=Te.geographicToCartesianWgs84(this.longitude,this.latitude,this.altitude,void 0);return void 0===e&&(e=new Jr),e.set(t[0],t[1],t[2]),e},pe.prototype.getMercatorProjection=function(e){return Te.geographicToMercatorProjection(this.longitude,this.latitude,e)},pe.prototype.makeDefaultGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var e=this.geoLocDataManager.getCurrentGeoLocationData();void 0===e&&(e=this.geoLocDataManager.newGeoLocationData("default"),e=on.calculateGeoLocationData(this.longitude,this.latitude,this.altitude,void 0,void 0,void 0,e))},pe.prototype.getGeoLocationDataManager=function(){return void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye),this.geoLocDataManager},pe.prototype.copyFrom=function(e){this.longitude=e.longitude,this.latitude=e.latitude,this.altitude=e.altitude},pe.prototype.setLonLatAlt=function(e,t,r){void 0!==e&&(this.longitude=e),void 0!==t&&(this.latitude=t),void 0!==r&&(this.altitude=r)},pe.prototype.setLongitude=function(e){this.longitude=e},pe.prototype.setLatitude=function(e){this.latitude=e},pe.prototype.setAltitude=function(e){this.altitude=e},pe.prototype.getLatitudeRad=function(){if(void 0!==this.latitude)return this.latitude*Math.PI/180},pe.prototype.getLongitudeRad=function(){if(void 0!==this.longitude)return this.longitude*Math.PI/180},pe.prototype.getAltitude=function(){if(void 0!==this.altitude)return this.altitude},pe.getMidPoint=function(e,t,r){var i=(e.latitude+t.latitude)/2,o=(e.longitude+t.longitude)/2,n=(e.altitude+t.altitude)/2;return void 0===r?r=new pe(o,i,n):r.setLonLatAlt(o,i,n),r},pe.prototype.isCoincidentToGeoCoord=function(e,t,r){return t||(t=1e-8),r||(r=1e-6),!(Math.abs(this.longitude-e.longitude)>t)&&(!(Math.abs(this.latitude-e.latitude)>t)&&!(this.altitude&&e.altitude&&Math.abs(this.altitude-e.altitude)>r))},pe.getAngleBetweenCoords=function(e,t){var r=t.longitude-e.longitude,i=t.latitude-e.latitude;return Math.sqrt(r*r+i*i)},pe.prototype.prepareData=function(e){if(void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt),0===this.vboKeysContainer.getVbosCount()){var t=this.vboKeysContainer.newVBOVertexIdxCacheKey(),r=new Float32Array([0,0,0]);t.setDataArrayPos(r,e)}return!0},pe.prototype.readDataFromBuffer=function(e,t){return this.longitude=new Float64Array(e.slice(t,t+8))[0],t+=8,this.latitude=new Float64Array(e.slice(t,t+8))[0],t+=8,this.altitude=new Float32Array(e.slice(t,t+4))[0],t+=4},pe.prototype.renderPoint=function(e,t,r,i){if(!this.prepareData(e.vboMemoryManager))return!1;this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,t);var o=this.vboKeysContainer.vboCacheKeysArray[0];if(!o.bindDataPosition(t,e.vboMemoryManager))return!1;r.drawArrays(r.POINTS,0,o.vertexCount)};var me=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.strGeoCoord=t,this.endGeoCoord=r};me.calculateHeadingAngRadToNorthOfSegment=function(e,t){var r=e.strGeoCoord,i=e.endGeoCoord,o=on.geographicCoordToWorldPoint(r.longitude,r.latitude,r.altitude,void 0,t),n=on.geographicCoordToWorldPoint(i.longitude,i.latitude,i.altitude,void 0,t),a=on.calculateGeoLocationMatrixAtWorldPosition(o,void 0),s=glMatrix.mat4.create();s=glMatrix.mat4.invert(s,a._floatArrays);var l=new Ne;l.setByFloat32Array(s);var u=l.transformPoint3D(n,void 0),c=new Kr(0,1),d=new Kr(u.x,u.y);d.unitary();var h=c.angleRadToVector(d);return d.x>0&&(h*=-1),h},me.getLengthInMeters=function(e,t){var r=e.strGeoCoord,i=e.endGeoCoord,o=on.geographicCoordToWorldPoint(r.longitude,r.latitude,r.altitude,void 0,t),n=on.geographicCoordToWorldPoint(i.longitude,i.latitude,i.altitude,void 0,t);return o.distToPoint(n)},me.getDirection=function(e,t){if(void 0===e)return t;var r=e.endGeoCoord.longitude-e.strGeoCoord.longitude,i=e.endGeoCoord.latitude-e.strGeoCoord.latitude,o=e.endGeoCoord.altitude-e.strGeoCoord.altitude;return void 0===t&&(t=new Jr),t.set(r,i,o),t.unitary(),t},me.getLine=function(e,t){void 0===t&&(t=new Rr);var r=me.getDirection(e,void 0),i=e.strGeoCoord;return t.setPointAndDir(i.longitude,i.latitude,i.altitude,r.x,r.y,r.z),t},me.getProjectedCoordToLine=function(e,t,r){var i=me.getLine(e,void 0),o=new Jr(t.longitude,t.latitude,t.altitude),n=i.getProjectedPoint(o,void 0);return void 0===r&&(r=new pe),r.setLonLatAlt(n.x,n.y,n.z),r},me.intersectionWithGeoCoord=function(e,t){var r=e.strGeoCoord,i=e.endGeoCoord,o=new Jr(t.longitude,t.latitude,t.altitude),n=new Jr(r.longitude,r.latitude,r.altitude),a=new Jr(i.longitude,i.latitude,i.altitude),s=new vi(n,a).getLength(),l=n.distToPoint(o)+a.distToPoint(o);return Math.abs(s-l)<1e-7},me.getNearestGeoCoord=function(e,t){var r=e.strGeoCoord,i=e.endGeoCoord,o=new Jr(t.longitude,t.latitude,t.altitude),n=new Jr(r.longitude,r.latitude,r.altitude),a=new Jr(i.longitude,i.latitude,i.altitude);return n.distToPoint(o)<a.distToPoint(o)?r:i},me.getArcInterpolatedGeoCoords=function(e,t,r,i){void 0===r&&(r=2e3);var o=Te.getArcDistanceBetweenGeographicCoords(e,t),n=Math.ceil(o/r),a=e.longitude,s=e.latitude,l=e.altitude,u=(t.longitude-a)/n,c=(t.latitude-s)/n,d=(t.altitude-l)/n;void 0===i&&(i=[]);for(var h=0;h<n+1;h++){var f=new pe(a+u*h,s+c*h,l+d*h);i.push(f)}return i};var ve=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.geographicCoordsArray=void 0!==t?t:[],this.vboKeysContainer,this.owner,this.id,this.points3dList};ve.fromCartesians=function(e){for(var t=[],r=0,i=e.length;r<i;r++)t.push(pe.fromCartesian(e[r]));return new ve(t)},ve.prototype.newGeoCoord=function(e,t,r){var i=new pe(e,t,r);return this.addGeoCoord(i),i},ve.prototype.addGeoCoord=function(e){this.geographicCoordsArray.push(e),e.owner=this},ve.prototype.addGeoCoordsArray=function(e){for(var t=e.length,r=0;r<t;r++)this.geographicCoordsArray.push(e[r]),e[r].owner=this},ve.prototype.getGeoCoord=function(e){if(void 0!==this.geographicCoordsArray)return this.geographicCoordsArray[e]},ve.prototype.getGeoCoordsCount=function(){return void 0===this.geographicCoordsArray?0:this.geographicCoordsArray.length},ve.prototype.getGeoCoordSegment=function(e,t){if(void 0===this.geographicCoordsArray)return t;var r,i=this.geographicCoordsArray.length;if(i<=1)return t;if(e>i-1)return t;r=e===i-1?0:e+1;var o=this.getGeoCoord(e),n=this.getGeoCoord(r);return void 0===t&&(t=new me),t.strGeoCoord=o,t.endGeoCoord=n,t},ve.getCrossProduct2D=function(e,t){var r,i=e.length;r=t===i-1?0:t+1;var o=e[0===t?i-1:t-1],n=e[t],a=e[r],s=new Kr(n.longitude-o.longitude,n.latitude-o.latitude),l=new Kr(a.longitude-n.longitude,a.latitude-n.latitude);return s.unitary(),l.unitary(),s.crossProduct(l)},ve.prototype.getCopy=function(e){void 0===e&&(e=new ve);for(var t=this.getGeoCoordsCount(),r=0;r<t;r++){var i=this.getGeoCoord(r),o=new pe(i.longitude,i.latitude,i.altitude);e.addGeoCoord(o)}return e},ve.getPointsRelativeToGeoLocation=function(e,t,r,i){void 0===r&&(r=[]);for(var o=t.length,n=0;n<o;n++){var a=t[n],s=on.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude);r[n]=e.getTransformedRelativePosition(s,r[n])}return r},ve.getVBOThickLines=function(e,t,r,i){if(void 0===t||t.length<2)return r;void 0===r&&(r=new xt);for(var o,n=t.length,a=new Float32Array(4*n*4),s=0;s<n;s++)o=t[s],a[16*s]=o.longitude,a[16*s+1]=o.latitude,a[16*s+2]=o.altitude,a[16*s+3]=1,a[16*s+4]=o.longitude,a[16*s+5]=o.latitude,a[16*s+6]=o.altitude,a[16*s+7]=-1,a[16*s+8]=o.longitude,a[16*s+9]=o.latitude,a[16*s+10]=o.altitude,a[16*s+11]=2,a[16*s+12]=o.longitude,a[16*s+13]=o.latitude,a[16*s+14]=o.altitude,a[16*s+15]=-2;var l,u=new J(.6,.9,.99,1),c=new J(.6,.9,.99,1),d=!1;if(i&&(i.color&&(u.setRGBA(i.color.r,i.color.g,i.color.b,i.color.a),c.setRGBA(i.color.r,i.color.g,i.color.b,i.color.a)),i.startColor&&(u.setRGBA(i.startColor.r,i.startColor.g,i.startColor.b,i.startColor.a),d=!0),i.endColor&&(c.setRGBA(i.endColor.r,i.endColor.g,i.endColor.b,i.endColor.a),d=!0)),d){l=new Uint8Array(4*n*4);var h=new J(.6,.9,.99,1);h.copyFrom(u);var f=1;for(s=0;s<n;s++)f=1-s/(n-1),h=J.mix(u,c,f),l[16*s]=Math.floor(255*h.r),l[16*s+1]=Math.floor(255*h.g),l[16*s+2]=Math.floor(255*h.b),l[16*s+3]=Math.floor(255*h.a),l[16*s+4]=Math.floor(255*h.r),l[16*s+5]=Math.floor(255*h.g),l[16*s+6]=Math.floor(255*h.b),l[16*s+7]=Math.floor(255*h.a),l[16*s+8]=Math.floor(255*h.r),l[16*s+9]=Math.floor(255*h.g),l[16*s+10]=Math.floor(255*h.b),l[16*s+11]=Math.floor(255*h.a),l[16*s+12]=Math.floor(255*h.r),l[16*s+13]=Math.floor(255*h.g),l[16*s+14]=Math.floor(255*h.b),l[16*s+15]=Math.floor(255*h.a)}var g=r.newVBOVertexIdxCacheKey();return g.setDataArrayPos(a,e.vboMemoryManager,4),l&&g.setDataArrayCol(l,e.vboMemoryManager),r},ve.getRenderableExpandedAndExtrudedObjectOfGeoCoordsArray=function(e,t,i){if(void 0!==e&&0!==e.length){for(var o=e.length,n=e[0],a=on.calculateGeoLocationData(n.longitude,n.latitude,n.altitude,0,0,0,void 0),s=[],l=[],u=0;u<o;u++){var c=e[u],d=new pe(c.longitude,c.latitude,500);s.push(d);var h=new pe(c.longitude,c.latitude,1e3);l.push(h)}var f=ve.getPointsRelativeToGeoLocation(a,s,void 0),g=ve.getPointsRelativeToGeoLocation(a,l,void 0);void 0===i?i={thickness:2}:void 0===i.thickness&&(i.thickness=2);var p=new xo(i);p.vboKeysContainer=Qr.getVboThickLinesExtruded(t,f,g,p.vboKeysContainer,i);var m=new ho;return m.geoLocDataManager=new ye,m.geoLocDataManager.addGeoLocationData(a),m.objectType=r.OBJECT_TYPE.VECTORMESH,m.objectsArray.push(p),m}},ve.getRenderableObjectOfGeoCoordsArray=function(e,t,i){if(void 0!==e&&0!==e.length){var o=ve.getGeographicExtent(e,void 0).getMidPoint(void 0),n=on.calculateGeoLocationData(o.longitude,o.latitude,o.altitude,0,0,0,void 0),a=ve.getPointsRelativeToGeoLocation(n,e,void 0);void 0===i&&(i={}),void 0===i.thickness&&(i.thickness=2),void 0===i.color&&(i.color=new J(1,.3,.3,1));var s=new _o(i);s.vboKeysContainer=Qr.getVboThickLines(t,a,s.vboKeysContainer,i);var l=new ho;l.geoLocDataManager=new ye,l.geoLocDataManager.addGeoLocationData(n),l.objectType=r.OBJECT_TYPE.VECTORMESH,l.boundingSphereWC=new z;var u=n.position,c=Qr.getBoundingBoxOfPoints3DArray(a,void 0).getRadiusAprox();return l.boundingSphereWC.setCenterPoint(u.x,u.y,u.z),l.boundingSphereWC.setRadius(c),l.objectsArray.push(s),l}},ve.prototype.getPointsWorldCoord=function(e){void 0===e&&(e=[]);for(var t=this.getGeoCoordsCount(),r=0;r<t;r++){var i=this.getGeoCoord(r),o=i.getGeoLocationDataManager(),n=o.getCurrentGeoLocationData();void 0===n&&(i.makeDefaultGeoLocationData(),n=o.getCurrentGeoLocationData());var a=n.position;e[r]=a}return e},ve.prototype.deleteObjects=function(e){if(void 0!==this.geographicCoordsArray){for(var t=this.getGeoCoordsCount(),r=0;r<t;r++)this.geographicCoordsArray[r].deleteObjects(e),this.geographicCoordsArray[r]=void 0;this.geographicCoordsArray=void 0}void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(e),this.vboKeysContainer=void 0),this.owner=void 0},ve.prototype.test__makeThickLines=function(e){if(this.makeLines(e),void 0!==this.points3dList){var t=Qr.getVboThickLines(e,this.points3dList.pointsArray,void 0);this.points3dList.vboKeysContainer=t}},ve.prototype.getGeographicExtent=function(e){return ve.getGeographicExtent(this.geographicCoordsArray,e)},ve.getNumbersArrayOfGeoCoordsArray=function(e){for(var t=e.length,r=new Array(3*t),i=0;i<t;i++){var o=e[i];r[3*i]=o.longitude,r[3*i+1]=o.latitude,r[3*i+2]=o.altitude}return r},ve.getNumbersArrayOfGeoCoordsList=function(e){return ve.getNumbersArrayOfGeoCoordsArray(e.geographicCoordsArray)},ve.getGeographicExtent=function(e,t){var r;t||(t=new xe);for(var i=e.length,o=0;o<i;o++)r=e[o],0===o?t.setInitExtent(r.longitude,r.latitude,r.altitude):t.addGeographicCoord(r);return t},ve.prototype.getMiddleGeographicCoords=function(e){return this.getGeographicExtent().getMidPoint(e)},ve.getMiddleGeographicCoords=function(e,t){return ve.getGeographicExtent(e,void 0).getMidPoint(t)},ve.prototype.addAltitude=function(e){for(var t=this.geographicCoordsArray.length,r=0;r<t;r++)this.geographicCoordsArray[r].altitude+=e},ve.prototype.setAltitude=function(e){for(var t=this.geographicCoordsArray.length,r=0;r<t;r++)this.geographicCoordsArray[r].altitude=e},ve.solveUroborus=function(e,t){if(!e)return!1;t||(t=1e-8);var r=e.length;if(r<3)return!1;var i=e[0],o=e[r-1],n=t;return!!i.isCoincidentToGeoCoord(o,t,n)&&(e.pop(),!0)},ve.solveDegeneratedPoints=function(e,t){if(e){t||(t=1e-8),ve.solveUroborus(e,t);for(var r=e.length,i=0;i<r-1;i++){var o=e[i],n=e[i+1];n||(n=e[0]),o.isCoincidentToGeoCoord(n,t)&&(e.splice(i+1,1),i--,r--)}}},ve.isClockwise=function(e){if(e||!(e.length<3)){for(var t=e.length,r=0,i=t-1,o=0;o<t;i=o++){var n=e[i],a=e[o];r+=n.longitude*a.latitude-a.longitude*n.latitude}return(r*=.5)<0}},ve.prototype.getExtrudedMeshRenderableObject=function(e,t,r,i,o,n){if(!this.geographicCoordsArray||0===this.geographicCoordsArray.length)return r;r||(r=new ho),r.geoLocDataManager=new ye;var a=r.geoLocDataManager.newGeoLocationData();r.geographicCoordList=this;var s=this.getMiddleGeographicCoords(),l=this.getCopy();l.addAltitude(e),on.calculateGeoLocationData(s.longitude,s.latitude,s.altitude,0,0,0,a);var u=ve.getPointsRelativeToGeoLocation(a,this.geographicCoordsArray,void 0),c=ve.getPointsRelativeToGeoLocation(a,l.geographicCoordsArray,void 0),d=new Fi;d.newVtxProfile().makeByPoints3DArray(u,void 0),d.newVtxProfile().makeByPoints3DArray(c,void 0);var h=d.getMesh(void 0,!0,!0,t),f=h.getCopySurfaceIndependentMesh(),g=h.getBoundingBox();if(f.calculateVerticesNormals(),f.bbox=g,!f.boundingSphereWC){f.boundingSphereWC=new z;var p=a.position,m=g.getRadiusAprox();f.boundingSphereWC.setCenterPoint(p.x,p.y,p.z),f.boundingSphereWC.setRadius(m)}if(n){var v=document.createElement("canvas"),x=v.getContext("2d");v.width=8,v.height=32,x.beginPath(),x.fillStyle="#262626",x.rect(0,0,8,1),x.fill(),x.closePath(),x.beginPath(),x.fillStyle=n.color,x.rect(0,1,8,31),x.fill(),x.closePath(),x.beginPath(),x.fillStyle="#0000ff",x.rect(2,8,4,8),x.fill(),x.stroke(),x.closePath(),f.material=new Hr("test"),f.material.setDiffuseTextureUrl(v.toDataURL()),f.calculateTexCoordsByHeight(n.height)}return r.objectsArray.push(f),r},ve.prototype.getExtrudedPlaneRenderableObject=function(e,t,r,i,o,n){if(!this.geographicCoordsArray||0===this.geographicCoordsArray.length)return r;r||(r=new ho),r.geoLocDataManager=new ye;var a=r.geoLocDataManager.newGeoLocationData();r.geographicCoordList=this;var s=this.getMiddleGeographicCoords(),l=this.getCopy();l.addAltitude(e),on.calculateGeoLocationData(s.longitude,s.latitude,s.altitude,0,0,0,a);var u=ve.getPointsRelativeToGeoLocation(a,this.geographicCoordsArray,void 0),c=ve.getPointsRelativeToGeoLocation(a,l.geographicCoordsArray,void 0),d=new Fi;d.newVtxProfile().makeByPoints3DArray(u,void 0),d.newVtxProfile().makeByPoints3DArray(c,void 0);var h=d.getMesh(void 0,!1,!1,t),f=h.getCopySurfaceIndependentMesh(),g=h.getBoundingBox();if(f.calculateVerticesNormals(),f.bbox=g,!f.boundingSphereWC){f.boundingSphereWC=new z;var p=a.position,m=g.getRadiusAprox();f.boundingSphereWC.setCenterPoint(p.x,p.y,p.z),f.boundingSphereWC.setRadius(m)}if(n){var v=document.createElement("canvas"),x=v.getContext("2d");v.width=8,v.height=32,x.beginPath(),x.fillStyle="#262626",x.rect(0,0,8,1),x.fill(),x.closePath(),x.beginPath(),x.fillStyle=n.color,x.rect(0,1,8,31),x.fill(),x.closePath(),x.beginPath(),x.fillStyle="#0000ff",x.rect(2,8,4,8),x.fill(),x.stroke(),x.closePath(),f.material=new Hr("test"),f.material.setDiffuseTextureUrl(v.toDataURL()),f.calculateTexCoordsByHeight(n.height)}return r.objectsArray.push(f),r},ve.prototype.getRenderableObjectPolygon=function(e,t){if(!this.geographicCoordsArray||0===this.geographicCoordsArray.length)return t;t||(t=new ho),t.geoLocDataManager=new ye;var r=t.geoLocDataManager.newGeoLocationData();t.geographicCoordList=this;var i=this.getMiddleGeographicCoords();on.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,0,0,0,r);var o=ve.getPointsRelativeToGeoLocation(r,this.geographicCoordsArray,void 0),n=new Fi;n.newVtxProfile().makeByPoints3DArray(o,void 0);var a,s=n.getMesh(void 0,!0,!0).getCopySurfaceIndependentMesh();if(s.calculateVerticesNormals(),e&&e.textureInfo&&(a=e.textureInfo),a){var l=document.createElement("canvas"),u=l.getContext("2d");l.width=8,l.height=32,u.beginPath(),u.fillStyle="#262626",u.rect(0,0,8,1),u.fill(),u.closePath(),u.beginPath(),u.fillStyle=a.color,u.rect(0,1,8,31),u.fill(),u.closePath(),u.beginPath(),u.fillStyle="#0000ff",u.rect(2,8,4,8),u.fill(),u.stroke(),u.closePath(),s.material=new Hr("test"),s.material.setDiffuseTextureUrl(l.toDataURL()),s.calculateTexCoordsByHeight(a.height)}return t.objectsArray.push(s),t},ve.prototype._getExtrudedWallRenderableObject_byNumSegments=function(e,t,r,i,o,n){var a=void 0,s=void 0,l=!1,u=void 0,c=void 0;o&&(o.doubleFace&&(!0,t.attributes.doubleFace=!0),o.colorTop&&(a=o.colorTop),o.colorBottom&&(s=o.colorBottom),o.polyLineLoop&&(l=o.polyLineLoop),o.colorsArray&&(u=o.colorsArray),o.numSegments&&(c=o.numSegments));var d=t.geoLocDataManager.getCurrentGeoLocationData(),h={outerVtxRingOptions:{isOpen:!l}};if(!u&&(u=[],s&&a)){var f=c+1;u=J.getInterpolatedColorsArray(s,a,f,u)}for(var g=new Fi,p=e/c,m=0;m<c+1;m++){var v=this.getCopy();v.addAltitude(p*m);var x=ve.getPointsRelativeToGeoLocation(d,v.geographicCoordsArray,void 0),_=g.newVtxProfile();if(_.makeByPoints3DArray(x,void 0,h),u){var y=u[m];_.setColorRGBAVertices(y.r,y.g,y.b,y.a)}}var T=g.getMesh(void 0,!1,!1,!1).getCopySurfaceIndependentMesh();return T.calculateVerticesNormals(),t.objectsArray.push(T),t},ve.prototype.getExtrudedWallRenderableObject=function(e,t,r,i,o,n){if(!this.geographicCoordsArray||0===this.geographicCoordsArray.length)return t;t||(t=new ho),t.geoLocDataManager=new ye;var a=t.geoLocDataManager.newGeoLocationData();t.geographicCoordList=this;var s=void 0,l=void 0,u=!1,c=void 0,d=void 0;o&&(o.doubleFace&&(!0,t.attributes.doubleFace=!0),o.colorTop&&(s=o.colorTop),o.colorBottom&&(l=o.colorBottom),o.polyLineLoop&&(u=o.polyLineLoop),o.colorsArray&&(c=o.colorsArray),o.numSegments&&(d=o.numSegments));var h=this.getMiddleGeographicCoords();on.calculateGeoLocationData(h.longitude,h.latitude,h.altitude,0,0,0,a);var f=this.getCopy();if(f.addAltitude(e),d||c)return this._getExtrudedWallRenderableObject_byNumSegments(e,t,r,i,o,n);var g=ve.getPointsRelativeToGeoLocation(a,this.geographicCoordsArray,void 0),p=ve.getPointsRelativeToGeoLocation(a,f.geographicCoordsArray,void 0),m={outerVtxRingOptions:{isOpen:!u}},v=new Fi,x=v.newVtxProfile();x.makeByPoints3DArray(g,void 0,m),l&&s&&x.setColorRGBAVertices(l.r,l.g,l.b,l.a);var _=v.newVtxProfile();_.makeByPoints3DArray(p,void 0,m),l&&s&&_.setColorRGBAVertices(s.r,s.g,s.b,s.a);var y=v.getMesh(void 0,!1,!1,!1).getCopySurfaceIndependentMesh();return y.calculateVerticesNormals(),t.objectsArray.push(y),t},ve.prototype.makeLines=function(e){if(void 0===this.geographicCoordsArray||0===this.geographicCoordsArray.length)return!1;void 0===this.points3dList&&(this.points3dList=new Qr);var t=this.points3dList.getGeographicLocation(),r=this.getGeoCoord(0),i=r.getGeoLocationDataManager().getCurrentGeoLocationData();void 0===i&&(i=on.calculateGeoLocationData(r.longitude,r.latitude,r.altitude,void 0,void 0,void 0,i,e)),t.copyFrom(i);var o=ve.getPointsRelativeToGeoLocation(t,this.geographicCoordsArray,void 0);this.points3dList.deleteVboKeysContainer(e),this.points3dList.deletePoints3d(),this.points3dList.addPoint3dArray(o)},ve.prototype.renderLines=function(e,t,r,i,o){if(void 0===this.geographicCoordsArray)return!1;if(void 0===this.points3dList)return this.makeLines(e),!1;t=e.postFxShadersManager.getShader("pointsCloud");e.postFxShadersManager.useProgram(t),t.disableVertexAttribArrayAll(),t.resetLastBuffersBinded(),t.enableVertexAttribArray(t.position3_loc),t.bindUniformGenerals();var n=e.sceneState.gl;n.uniform1i(t.bPositionCompressed_loc,!1),n.uniform1i(t.bUse1Color_loc,!0),n.uniform4fv(t.oneColor4_loc,[1,1,.1,1]),n.uniform1f(t.fixPointSize_loc,5),n.uniform1i(t.bUseFixPointSize_loc,!0),this.points3dList.renderLines(e,t,r,i,o),t.disableVertexAttribArrayAll()},ve.prototype.renderPoints=function(e,t,r,i,o){if(void 0===this.geographicCoordsArray)return!1;var n=e.sceneState.gl,a=e.sceneState,s=e.postFxShadersManager.getShader("pointsCloudSsao");e.postFxShadersManager.useProgram(s),s.disableVertexAttribArrayAll(),s.resetLastBuffersBinded(),s.enableVertexAttribArray(s.position3_loc),s.bindUniformGenerals(),n.uniform1i(s.bPositionCompressed_loc,!1),n.uniform1i(s.bUse1Color_loc,!0),n.uniform4fv(s.oneColor4_loc,[1,.1,.1,1]),n.uniform1f(s.fixPointSize_loc,5),n.uniform1i(s.bUseFixPointSize_loc,1),n.uniform1f(s.externalAlpha_loc,1);var l,u=e.magoPolicy.getPointsCloudSettings();n.uniform1f(s.maxPointSize_loc,parseInt(u.maxPointSize)),n.uniform1f(s.minPointSize_loc,parseInt(u.minPointSize)),n.uniform1f(s.pendentPointSize_loc,parseInt(u.pendentPointSize)),n.uniform1i(s.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),n.uniform1i(s.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),n.uniform1f(s.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),n.uniform2fv(s.uNearFarArray_loc,e.frustumVolumeControl.nearFarArray),n.uniform1i(s.uFrustumIdx_loc,e.currentFrustumIdx),void 0===i&&(i=!0),i?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST);for(var c=this.geographicCoordsArray.length,d=0;d<c;d++)(l=this.geographicCoordsArray[d]).renderPoint(e,s,n,r);var h=e.selectionManager.getSelectedGeneral();void 0!==h&&"GeographicCoord"===h.constructor.name&&(n.uniform4fv(s.oneColor4_loc,[1,.1,.1,1]),n.uniform1f(s.fixPointSize_loc,10),h.renderPoint(e,s,n,r)),s.disableVertexAttribArrayAll(),n.enable(n.DEPTH_TEST);var f=!1;if(void 0!==o&&void 0!==o.writeGeographicCoords&&(f=o.writeGeographicCoords),f){var g=e.getObjectLabel().getContext("2d");g.clearRect(0,0,g.canvas.width,g.canvas.height),g.font="bold 13px Arial",g.fillStyle="black",g.strokeStyle="white";var p,m;for(n=e.sceneState.gl,d=0;d<c;d++){if(p=(l=this.geographicCoordsArray[d]).getGeoLocationDataManager().getCurrentGeoLocationData().position,(m=on.calculateWorldPositionToScreenCoord(n,p.x,p.y,p.z,m,e)).x+=15,m.y-=15,m.x>=0&&m.y>=0){var v="lon: "+l.longitude.toFixed(6);g.strokeText(v,m.x,m.y),g.fillText(v,m.x,m.y),v="lat: "+l.latitude.toFixed(6),g.strokeText(v,m.x,m.y+15),g.fillText(v,m.x,m.y+15),v="alt: "+l.altitude.toFixed(6),g.strokeText(v,m.x,m.y+30),g.fillText(v,m.x,m.y+30)}}g.restore()}e.postFxShadersManager.useProgram(t)},ve.prototype.getWgs84Points3D=function(e){return ve.getGeoCoordsToWgs84Points3D(this.geographicCoordsArray,e)},ve.getGeoCoordsToWgs84Points3D=function(e,t){void 0===t&&(t=[]);for(var r=e.length,i=0;i<r;i++){var o=e[i].getWgs84Point3D(void 0);t.push(o)}return t};var xe=function e(t,r,i,o,n,a){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.minGeographicCoord,this.maxGeographicCoord,void 0!==t&&void 0!==r&&void 0!==i&&(void 0===this.minGeographicCoord&&(this.minGeographicCoord=new pe),this.minGeographicCoord.setLonLatAlt(t,r,i)),void 0!==o&&void 0!==n&&void 0!==a&&(void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new pe),this.maxGeographicCoord.setLonLatAlt(o,n,a))};xe.prototype.deleteObjects=function(){void 0!==this.minGeographicCoord&&(this.minGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0),void 0!==this.maxGeographicCoord&&(this.maxGeographicCoord.deleteObjects(),this.maxGeographicCoord=void 0)},xe.prototype.setExtent=function(e,t,r,i,o,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new pe),this.minGeographicCoord.setLonLatAlt(e,t,r),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new pe),this.maxGeographicCoord.setLonLatAlt(i,o,n)},xe.prototype.setExtentAltitudes=function(e,t){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new pe),this.minGeographicCoord.setAltitude(e),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new pe),this.maxGeographicCoord.setAltitude(t)},xe.prototype.setInitExtent=function(e,t,r){this.setExtent(e,t,r,e,t,r)},xe.prototype.addGeographicCoord=function(e){var t=e.longitude,r=e.latitude,i=e.altitude;void 0===this.minGeographicCoord?(this.minGeographicCoord=new pe,this.minGeographicCoord.setLonLatAlt(t,r,i)):(t<this.minGeographicCoord.longitude&&this.minGeographicCoord.setLongitude(t),r<this.minGeographicCoord.latitude&&this.minGeographicCoord.setLatitude(r),i<this.minGeographicCoord.altitude&&this.minGeographicCoord.setAltitude(i)),void 0===this.maxGeographicCoord?(this.maxGeographicCoord=new pe,this.maxGeographicCoord.setLonLatAlt(t,r,i)):(t>this.maxGeographicCoord.longitude&&this.maxGeographicCoord.setLongitude(t),r>this.maxGeographicCoord.latitude&&this.maxGeographicCoord.setLatitude(r),i>this.maxGeographicCoord.altitude&&this.maxGeographicCoord.setAltitude(i))},xe.prototype.getCenterLongitude=function(){var e=this.minGeographicCoord.longitude;return(this.maxGeographicCoord.longitude+e)/2},xe.prototype.getCenterLatitude=function(){var e=this.minGeographicCoord.latitude;return(this.maxGeographicCoord.latitude+e)/2},xe.prototype.getCenterAltitude=function(){var e=this.minGeographicCoord.altitude;return(this.maxGeographicCoord.altitude+e)/2},xe.prototype.getMidPoint=function(e){return pe.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,e)},xe.prototype.getExtentVec4=function(){if(void 0!==this.minGeographicCoord&&void 0!==this.maxGeographicCoord)return[this.minGeographicCoord.longitude,this.minGeographicCoord.latitude,this.maxGeographicCoord.longitude,this.maxGeographicCoord.latitude]},xe.prototype.getMinLatitudeRad=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.getLatitudeRad()},xe.prototype.getMinAltitude=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.altitude},xe.prototype.getMaxAltitude=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.altitude},xe.prototype.getLongitudeRange=function(){return this.maxGeographicCoord.longitude-this.minGeographicCoord.longitude},xe.prototype.getLatitudeRange=function(){return this.maxGeographicCoord.latitude-this.minGeographicCoord.latitude},xe.prototype.getAltitudeRange=function(){return this.maxGeographicCoord.altitude-this.minGeographicCoord.altitude},xe.prototype.getLongitudeArcDistance=function(){var e=this.getMidPoint(),t=new pe(this.minGeographicCoord.longitude,e.latitude,e.altitude),r=new pe(this.maxGeographicCoord.longitude,e.latitude,e.altitude);return Te.getArcDistanceBetweenGeographicCoords(t,r)},xe.prototype.getLatitudeArcDistance=function(){var e=this.getMidPoint(),t=new pe(e.longitude,this.minGeographicCoord.latitude,e.altitude),r=new pe(e.longitude,this.maxGeographicCoord.latitude,e.altitude);return Te.getArcDistanceBetweenGeographicCoords(t,r)},xe.prototype.getMinLongitudeRad=function(){if(void 0!==this.minGeographicCoord)return this.minGeographicCoord.getLongitudeRad()},xe.prototype.getMaxLatitudeRad=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.getLatitudeRad()},xe.prototype.getMaxLongitudeRad=function(){if(void 0!==this.maxGeographicCoord)return this.maxGeographicCoord.getLongitudeRad()},xe.prototype.intersects2dWithGeoCoord=function(e){var t=e.longitude,r=e.latitude;return t>this.minGeographicCoord.longitude&&t<this.maxGeographicCoord.longitude&&r>this.minGeographicCoord.latitude&&r<this.maxGeographicCoord.latitude},xe.prototype.containsEntirelyGeoExtent2d=function(e){var t=e.minGeographicCoord,r=e.maxGeographicCoord;return!(!this.intersects2dWithGeoCoord(t)||!this.intersects2dWithGeoCoord(r))},xe.prototype.getIntersectionTypeWithGeoExtent2d=function(e){return this.intersects2dWithGeoExtent(e)?this.containsEntirelyGeoExtent2d(e)?F.INTERSECTION_A_CONTAINS_B:e.containsEntirelyGeoExtent2d(this)?F.INTERSECTION_B_CONTAINS_A:F.INTERSECTION_INTERSECT:F.INTERSECTION_OUTSIDE},xe.prototype.intersects2dWithGeoExtent=function(e){var t=this.minGeographicCoord,r=this.maxGeographicCoord,i=e.minGeographicCoord,o=e.maxGeographicCoord;return!(t.longitude>o.longitude||r.longitude<i.longitude)&&!(t.latitude>o.latitude||r.latitude<i.latitude)},xe.prototype.getQuantizedPoints=function(e,t){t||(t=[]);for(var r,i,o,n=this.minGeographicCoord,a=this.maxGeographicCoord,s=n.longitude,l=a.longitude,u=n.latitude,c=a.latitude,d=n.altitude,h=l-s,f=c-u,g=a.altitude-d,p=e.length,m=0;m<p;m++){var v=e[m];r=(v.longitude-s)/h,i=(v.latitude-u)/f,o=(v.altitude-d)/g;var x=new Jr(32767*r,32767*i,32767*o);t.push(x)}return t},xe.prototype.getRenderableObject=function(e){var t=this.minGeographicCoord,r=this.maxGeographicCoord,i=t.longitude,o=r.longitude,n=t.latitude,a=r.latitude,s=t.altitude,l=r.altitude,u=new ve;u.newGeoCoord(i,n,s),u.newGeoCoord(o,n,s),u.newGeoCoord(o,a,s),u.newGeoCoord(i,a,s);var c=l-s;return u.getExtrudedMeshRenderableObject(c,!0,void 0,e,void 0)};var _e=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.name,this.name=void 0===t?"noName":t,this.geographicCoord,this.heading,this.pitch,this.roll,this.date,this.position,this.positionHIGH,this.positionLOW,this.positionSplitted,this.pivotPoint,this.geoLocMatrix,this.geoLocMatrixInv,this.tMatrix,this.tMatrixInv,this.rotMatrix,this.rotMatrixInv,this.pivotPointTraslationLC,this.rotMatrixLC};_e.prototype.setRotationHeadingPitchRoll=function(e,t,r){void 0!==e&&(this.heading=e),void 0!==t&&(this.pitch=t),void 0!==r&&(this.roll=r)},_e.prototype.getGeographicCoords=function(){return this.geographicCoord},_e.prototype.setGeographicCoordsLonLatAlt=function(e,t,r){void 0===this.geographicCoord&&(this.geographicCoord=new pe),this.geographicCoord.setLonLatAlt(e,t,r)},_e.prototype.deleteObjects=function(e){this.name=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(e),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.date=void 0,this.position&&this.position.deleteObjects(),this.position=void 0,this.positionHIGH=void 0,this.positionLOW=void 0,this.pivotPoint&&this.pivotPoint.deleteObjects(),this.pivotPoint=void 0,this.geoLocMatrix&&this.geoLocMatrix.deleteObjects(),this.geoLocMatrixInv&&this.geoLocMatrixInv.deleteObjects(),this.tMatrix&&this.tMatrix.deleteObjects(),this.tMatrixInv&&this.tMatrixInv.deleteObjects(),this.rotMatrix&&this.rotMatrix.deleteObjects(),this.rotMatrixInv&&this.rotMatrixInv.deleteObjects(),this.geoLocMatrix=void 0,this.geoLocMatrixInv=void 0,this.tMatrix=void 0,this.tMatrixInv=void 0,this.rotMatrix=void 0,this.rotMatrixInv=void 0,this.pivotPointTraslationLC&&this.pivotPointTraslationLC.deleteObjects(),this.pivotPointTraslationLC=void 0},_e.prototype.doEffectivePivotPointTranslation=function(){var e;e=void 0===this.pivotPointTraslationLC?new Jr(0,0,0):this.tMatrix.rotatePoint3D(this.pivotPointTraslationLC,e);var t=this.geographicCoord;this.position=on.geographicCoordToWorldPoint(t.longitude,t.latitude,t.altitude,this.position),void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array([0,0,0])),void 0===this.positionLOW&&(this.positionLOW=new Float32Array([0,0,0])),on.calculateSplited3fv([this.position.x,this.position.y,this.position.z],this.positionHIGH,this.positionLOW),this.position.x+=e.x,this.position.y+=e.y,this.position.z+=e.z,this.positionLOW[0]+=e.x,this.positionLOW[1]+=e.y,this.positionLOW[2]+=e.z,void 0===this.pivotPoint&&(this.pivotPoint=new Jr),this.pivotPoint.set(this.position.x,this.position.y,this.position.z)},_e.prototype.copyFrom=function(e){void 0!==e&&(this.name=e.name,e.geographicCoord&&(void 0===this.geographicCoord&&(this.geographicCoord=new pe),this.geographicCoord.copyFrom(e.geographicCoord)),this.heading=e.heading,this.pitch=e.pitch,this.roll=e.roll,this.date=e.date,e.position&&(void 0===this.position&&(this.position=new Jr),this.position.copyFrom(e.position)),e.positionHIGH&&(void 0===this.positionHIGH&&(this.positionHIGH=new Float32Array(3)),this.positionHIGH[0]=e.positionHIGH[0],this.positionHIGH[1]=e.positionHIGH[1],this.positionHIGH[2]=e.positionHIGH[2]),e.positionLOW&&(void 0===this.positionLOW&&(this.positionLOW=new Float32Array(3)),this.positionLOW[0]=e.positionLOW[0],this.positionLOW[1]=e.positionLOW[1],this.positionLOW[2]=e.positionLOW[2]),e.pivotPoint&&(void 0===this.pivotPoint&&(this.pivotPoint=new Jr),this.pivotPoint.copyFrom(e.pivotPoint)),e.geoLocMatrix&&(void 0===this.geoLocMatrix&&(this.geoLocMatrix=new Ne),this.geoLocMatrix.copyFromMatrix4(e.geoLocMatrix)),e.geoLocMatrixInv&&(void 0===this.geoLocMatrixInv&&(this.geoLocMatrixInv=new Ne),this.geoLocMatrixInv.copyFromMatrix4(e.geoLocMatrixInv)),e.tMatrix&&(void 0===this.tMatrix&&(this.tMatrix=new Ne),this.tMatrix.copyFromMatrix4(e.tMatrix)),e.tMatrixInv&&(void 0===this.tMatrixInv&&(this.tMatrixInv=new Ne),this.tMatrixInv.copyFromMatrix4(e.tMatrixInv)),e.rotMatrix&&(void 0===this.rotMatrix&&(this.rotMatrix=new Ne),this.rotMatrix.copyFromMatrix4(e.rotMatrix)),e.rotMatrixInv&&(void 0===this.rotMatrixInv&&(this.rotMatrixInv=new Ne),this.rotMatrixInv.copyFromMatrix4(e.rotMatrixInv)),e.aditionalTraslation&&(void 0===this.aditionalTraslation&&(this.aditionalTraslation=new Jr),this.aditionalTraslation.copyFrom(e.aditionalTraslation)))},_e.prototype.localCoordToWorldCoord=function(e,t){if(void 0!==e&&void 0!==this.tMatrix){void 0===t&&(t=new Jr);var r=this.rotMatrix.rotatePoint3D(e,void 0);return t.set(this.positionHIGH[0]+(r.x+this.positionLOW[0]),this.positionHIGH[1]+(r.y+this.positionLOW[1]),this.positionHIGH[2]+(r.z+this.positionLOW[2])),t}},_e.prototype.localCoordToGeographicCoord=function(e,t){var r=this.localCoordToWorldCoord(e);return on.pointToGeographicCoord(r,t)},_e.prototype.worldCoordToLocalCoord=function(e,t){var r=this.getTMatrixInv();if(void 0!==e&&void 0!==r){if(e instanceof Jr)return void 0===t&&(t=new Jr),t=r.transformPoint3D(e,t);if(e instanceof Array){t||(t=[]);for(var i=e.length,o=0;o<i;o++){var n=e[o],a=r.transformPoint3D(n,void 0);t.push(a)}return t}}},_e.prototype.getLocMatrixInv=function(){if(void 0===this.geoLocMatrixInv){var e=glMatrix.mat4.create();e=glMatrix.mat4.invert(e,this.geoLocMatrix._floatArrays),this.geoLocMatrixInv=new Ne,this.geoLocMatrixInv.setByFloat32Array(e)}return this.geoLocMatrixInv},_e.prototype.getRotMatrixInv=function(){if(void 0===this.rotMatrixInv){var e=glMatrix.mat4.create();e=glMatrix.mat4.invert(e,this.rotMatrix._floatArrays),this.rotMatrixInv=new Ne,this.rotMatrixInv.setByFloat32Array(e)}return this.rotMatrixInv},_e.prototype.getTMatrixInv=function(){if(void 0===this.tMatrixInv){var e=glMatrix.mat4.create();e=glMatrix.mat4.invert(e,this.tMatrix._floatArrays),this.tMatrixInv=new Ne,this.tMatrixInv.setByFloat32Array(e)}return this.tMatrixInv},_e.prototype.getRotMatrixLC=function(){if(void 0===this.rotMatrixLC){var e=new Ne,t=new Ne,r=new Ne,i=this.heading,o=this.pitch,n=this.roll;void 0!==i&&0!==i&&r.rotationAxisAngDeg(i,0,0,1),void 0!==o&&0!==o&&e.rotationAxisAngDeg(o,1,0,0),void 0!==n&&0!==n&&t.rotationAxisAngDeg(n,0,1,0);var a,s,l,u=new Ne;a=r.getMultipliedByMatrix(u,a),s=e.getMultipliedByMatrix(a,s),l=t.getMultipliedByMatrix(s,l),this.rotMatrixLC=l}return this.rotMatrixLC},_e.prototype.getGeoLocationMatrixInv=function(){if(void 0===this.geoLocMatrixInv){var e=glMatrix.mat4.create();e=glMatrix.mat4.invert(e,this.geoLocMatrix._floatArrays),this.geoLocMatrixInv=new Ne,this.geoLocMatrixInv.setByFloat32Array(e)}return this.geoLocMatrixInv},_e.prototype.getTransformedRelativeCamera=function(e,t){void 0===t&&(t=new X);var r=new Jr;r.set(e.position.x-this.position.x,e.position.y-this.position.y,e.position.z-this.position.z);var i=this.getRotMatrixInv();return t.position=i.transformPoint3D(r,t.position),r.set(e.direction.x,e.direction.y,e.direction.z),t.direction=i.transformPoint3D(r,t.direction),r.set(e.up.x,e.up.y,e.up.z),t.up=i.transformPoint3D(r,t.up),r.x=void 0,r.y=void 0,r.z=void 0,r=void 0,t},_e.prototype.getTransformedRelativePositionNoApplyHeadingPitchRoll=function(e,t){void 0===t&&(t=new Jr);var r=new Jr;return r.set(e.x,e.y,e.z),t=this.getLocMatrixInv().transformPoint3D(r,t)},_e.prototype.getTransformedRelativePosition=function(e,t){void 0===t&&(t=new Jr);var r=new Jr,i=new Float32Array(3),o=new Float32Array(3);return on.calculateSplited3fv([e.x,e.y,e.z],i,o),r.set(i[0]-this.positionHIGH[0]+(o[0]-this.positionLOW[0]),i[1]-this.positionHIGH[1]+(o[1]-this.positionLOW[1]),i[2]-this.positionHIGH[2]+(o[2]-this.positionLOW[2])),t=this.getRotMatrixInv().transformPoint3D(r,t)},_e.prototype.getRotatedRelativeVector=function(e,t){void 0===t&&(t=new Jr);var r=new Jr(e[0],e[1],e[2]);return t=this.getRotMatrixInv().transformPoint3D(r,t)},_e.prototype.getTransformedRelativePositionsArray=function(e,t){if(void 0===e)return t;void 0===t&&(t=[]);for(var r=e.length,i=0;i<r;i++){var o=this.getTransformedRelativePosition(e[i],void 0);t.push(o)}return t},_e.prototype.bindGeoLocationUniforms=function(e,t){e.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,this.rotMatrix._floatArrays),this.bindSplitedPositionUniforms(e,t)},_e.prototype.bindSplitedPositionUniforms=function(e,t){e.uniform3fv(t.buildingPosHIGH_loc,[this.positionHIGH[0],this.positionHIGH[1],this.positionHIGH[2]]),e.uniform3fv(t.buildingPosLOW_loc,[this.positionLOW[0],this.positionLOW[1],this.positionLOW[2]])};var ye=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.geoLocationDataArray=[],this.geoLocationDataArrayMaxLengthAllowed=15};ye.prototype.deleteObjects=function(){if(this.geoLocationDataArray){for(var e=0;e<this.geoLocationDataArray.length;e++)this.geoLocationDataArray[e].deleteObjects(),this.geoLocationDataArray[e]=void 0;this.geoLocationDataArray=[]}},ye.prototype.popGeoLocationData=function(){this.geoLocationDataArray.pop()},ye.prototype.newGeoLocationData=function(e){var t=this.getCurrentGeoLocationData();void 0===e&&(e="noName"+this.geoLocationDataArray.length.toString());var r=new _e(e);return this.geoLocationDataArray.unshift(r),this.geoLocationDataArray.length>this.geoLocationDataArrayMaxLengthAllowed&&this.geoLocationDataArray.pop(),t&&r.copyFrom(t),r},ye.prototype.addGeoLocationData=function(e){this.geoLocationDataArray.unshift(e),this.geoLocationDataArray.length>this.geoLocationDataArrayMaxLengthAllowed&&this.geoLocationDataArray.pop()},ye.prototype.getGeoLocationDatasCount=function(){return this.geoLocationDataArray.length},ye.prototype.getGeoLocationData=function(e){if(!(e>this.geoLocationDataArray.length-1))return this.geoLocationDataArray[e]},ye.prototype.getCurrentGeoLocationData=function(){if(0!==this.geoLocationDataArray.length)return this.geoLocationDataArray[0]};var Te=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.equatorialRadius=6378137,this.polarRadius=6356752.3142,this.firstEccentricitySquared=.00669437999014,this.secondEccentricitySquared=.00673949674228,this.degToRadFactor=Math.PI/180};Te.prototype.intersectionLineWgs84=function(e,t,r){var i=e.point,o=e.direction,n=new Jr(i.x+1e3*o.x,i.y+1e3*o.y,i.z+1e3*o.z),a=i.x,s=i.y,l=i.z,u=n.x,c=n.y,d=n.z,h=this.equatorialRadius;void 0!==r&&(h=r);var f=u-a,g=c-s,p=d-l,m=f*f+g*g+p*p,v=2*(f*(a-0)+g*(s-0)+p*(l-0)),x=v*v-4*m*(0+a*a+s*s+l*l-2*(0*a+0*s+0*l)-h*h);if(!(x<0)){if(0===x){void 0===t&&(t=[]);var _=new Jr(a+(u-a)*(y=-v/(2*m)),s+(c-s)*y,l+(d-l)*y);t[0]=_.x,t[1]=_.y,t[2]=_.z}else{var y,T=Math.sqrt(x),C=(-v-T)/(2*m),b=(_=new Jr(a+(u-a)*(y=(-v+T)/(2*m)),s+(c-s)*y,l+(d-l)*y),new Jr(a+(u-a)*C,s+(c-s)*C,l+(d-l)*C)),M=i.squareDistToPoint(_),A=i.squareDistToPoint(b);void 0===t&&(t=[]),M<A?(t[0]=_.x,t[1]=_.y,t[2]=_.z):(t[0]=b.x,t[1]=b.y,t[2]=b.z)}return t}},Te.equatorialRadius=function(){return 6378137},Te.equatorialRadiusSquared=function(){return 40680631590769},Te.polarRadius=function(){return 6356752.3142},Te.polarRadiusSquared=function(){return 40408299984087.055},Te.radiusAtLatitudeDeg=function(e){var t=e*Math.PI/180,r=Te.equatorialRadius(),i=Te.polarRadius(),o=Te.equatorialRadiusSquared(),n=Te.polarRadiusSquared(),a=Math.sin(t),s=Math.cos(t),l=a*a,u=s*s;return r*i/Math.sqrt(o*l+n*u)},Te.normalizeCartesian=function(e){if(void 0!==e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return e[0]/=t,e[1]/=t,e[2]/=t,e}},Te.normalAtCartesianPointWgs84=function(e,t,r,i){void 0===i&&(i=new Float32Array(3));var o=Te.equatorialRadius(),n=Te.polarRadius(),a=o*o,s=n*n;return i[0]=e/a,i[1]=t/a,i[2]=r/s,i=Te.normalizeCartesian(i)},Te.planeAtCartesianPointWgs84=function(e,t,r,i){void 0===i&&(i=new We);var o=Te.normalAtCartesianPointWgs84(e,t,r,void 0);return i.setPointAndNormal(e,t,r,o[0],o[1],o[2]),i},Te.transformMatrixAtGeographicCoord=function(e,t){if(void 0===e)return t;var r=Te.geographicToCartesianWgs84(e.longitude,e.latitude,e.altitude,void 0);return Te.transformMatrixAtCartesianPointWgs84(r[0],r[1],r[2],t)},Te.transformMatrixAtCartesianPointWgs84=function(e,t,r,i){var o,n;n=Te.normalAtCartesianPointWgs84(e,t,r,n),(o=new Float32Array(3))[0]=-t,o[1]=e,o[2]=0,o=Te.normalizeCartesian(o);var a=new Jr(o[0],o[1],o[2]),s=new Jr,l=new Jr(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===i&&(i=new Float32Array(16)),i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=0,i[4]=s.x,i[5]=s.y,i[6]=s.z,i[7]=0,i[8]=l.x,i[9]=l.y,i[10]=l.z,i[11]=0,i[12]=e,i[13]=t,i[14]=r,i[15]=1,i},Te.prototype.normalizeCartesian=function(e){return Te.normalizeCartesian(e)},Te.prototype.transformMatrixAtCartesianPointWgs84=function(e,t,r,i){var o,n;n=this.normalAtCartesianPointWgs84(e,t,r,n),(o=new Float32Array(3))[0]=-t,o[1]=e,o[2]=0,o=this.normalizeCartesian(o);var a=new Jr(o[0],o[1],o[2]),s=new Jr,l=new Jr(n[0],n[1],n[2]);return s=l.crossProduct(a,s),void 0===i&&(i=new Float32Array(16)),i[0]=a.x,i[1]=a.y,i[2]=a.z,i[3]=0,i[4]=s.x,i[5]=s.y,i[6]=s.z,i[7]=0,i[8]=l.x,i[9]=l.y,i[10]=l.z,i[11]=0,i[12]=e,i[13]=t,i[14]=r,i[15]=1,i},Te.prototype.normalAtCartesianPointWgs84=function(e,t,r,i){void 0===i&&(i=new Float32Array(3));var o=this.equatorialRadius*this.equatorialRadius,n=this.polarRadius*this.polarRadius;return i[0]=e/o,i[1]=t/o,i[2]=r/n,i=this.normalizeCartesian(i)},Te.atan2Test=function(e,t){var r=Math.PI;return t>0?Math.atan(e/t):t<0?e>=0?Math.atan(e/t)+r:Math.atan(e/t)-r:0===t?e>0?r/2:e<0?-r/2:0:void 0},Te.Point3DToGeographicWgs84Array=function(e,t){for(var r=[],i=e.length,o=0;o<i;o++){var n=e[o],a=Te.CartesianToGeographicWgs84(n.x,n.y,n.z,void 0,t);r.push(a)}return{geoCoordsArray:r}},Te.CartesianToGeographicWgs84=function(e,t,r,i,o){var n,a,s,l,u,c,d,h,f,g,p,m,v,x,_,y=e,T=t,C=r,b=y*y+T*T,M=Math.sqrt(b),A=6378137,E=1/(A*A),L=.00669437999014,w=L*L,S=b*E,D=C*C*(1-L)*E,R=(S+D-w)/6,P=8*R*R*R+w*S*D;P>0||0!==D?(P>0?(l=Math.sqrt(P),u=Math.sqrt(w*S*D),s=P>10*L?R+.5*(c=Math.cbrt((l+u)*(l+u)))+2*R*R/c:R+.5*Math.cbrt((l+u)*(l+u))+.5*Math.cbrt((l-u)*(l-u))):(l=Math.sqrt(-P),u=Math.sqrt(-8*R*R*R),c=Math.sqrt(w*S*D),d=2*Te.atan2Test(c,l+u)/3,s=-4*R*Math.sin(d)*Math.cos(Math.PI/6+d)),f=L*(s+(h=Math.sqrt(s*s+w*D))-D)/(2*h),p=(g=(s+h)/(Math.sqrt(f*f+s+h)+f))*M/(g+L),n=(g+L-1)*(m=Math.sqrt(p*p+C*C))/g,a=2*Te.atan2Test(C,m+p)):(n=-A*(l=Math.sqrt(1-L))*(u=Math.sqrt(L-S))/(v=Math.sqrt(L)),a=u/(v*u+l*Math.sqrt(S))),x=((_=Math.sqrt(2))-1)*T<M+y?2*Te.atan2Test(T,M+y):M+T<(_+1)*y?.5*-Math.PI+2*Te.atan2Test(y,M-T):.5*Math.PI-2*Te.atan2Test(y,M+T),void 0===i&&(i=new pe);var I=180/Math.PI;return i.latitude=I*a,i.longitude=I*x,i.altitude=n,void 0!==o&&!0===o&&(void 0===i.absolutePoint?i.absolutePoint=new Jr(e,t,r):i.absolutePoint.set(e,t,r)),i},Te.geographicToMercatorProjection=function(e,t,r){var i=Math.PI/180,o=e*i,n=t*i;return Te.geographicRadianToMercatorProjection(o,n,r)},Te.geographicRadianToMercatorProjection=function(e,t,r){var i=Te.equatorialRadius();void 0===r&&(r=new Kr);var o=Math.PI,n=i*e,a=0;0!==n&&(a=n/(180*e/o));var s=180/o*Math.log(Math.tan(o/4+t/2))*a;return r.set(n,s),r},Te.geographicToCartesianWgs84=function(e,t,r,i){var o=Math.PI/180,n=Te.equatorialRadius(),a=e*o,s=t*o,l=Math.cos(a),u=Math.cos(s),c=Math.sin(a),d=Math.sin(s),h=.00669437999014,f=n/Math.sqrt(1-h*d*d),g=r;return void 0===i&&(i=[]),i[0]=(f+g)*u*l,i[1]=(f+g)*u*c,i[2]=(f*(1-h)+g)*d,i},Te.geographicRadianArrayToFloat32ArrayWgs84=function(e,t,r,i){var o,n,a,s,l,u,c,d,h=.00669437999014,f=e.length;void 0===i&&(i=new Float32Array(3*f));for(var g=0;g<f;g++)o=e[g],n=t[g],a=Math.cos(o),s=Math.cos(n),l=Math.sin(o),u=Math.sin(n),c=6378137/Math.sqrt(1-h*u*u),d=r[g],i[3*g]=(c+d)*s*a,i[3*g+1]=(c+d)*s*l,i[3*g+2]=(.99330562000986*c+d)*u;return i},Te.getArcDistanceBetweenGeographicCoords=function(e,t){var r=Math.PI/180,i=(e.latitude+t.latitude)/2,o=Te.radiusAtLatitudeDeg(i),n=(t.longitude-e.longitude)*r,a=(t.latitude-e.latitude)*r,s=e.latitude*r,l=t.latitude*r,u=Math.sin(n/2),c=Math.sin(a/2),d=c*c+u*u*Math.cos(s)*Math.cos(l);return o*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))},Te.getRectangleMeshOnEllisoideCenteredAtGeographicCoord=function(e,t,r,i,o){var n=Te.geographicToCartesianWgs84(e.longitude,e.latitude,e.altitude,void 0),a=new Jr(0,0,1),s=new Jr(n[0],n[1],n[2]),l=s.getModul(),u=new Jr(n[0],n[1],n[2]);u.unitary();var c=a.crossProduct(u,void 0);c.unitary();var d=u.crossProduct(c,void 0);d.unitary();var h=t/2/l,f=r/2/l,g=-2*h/(o-1),p=2*f/(i-1),m=new Ne;m.rotationAxisAngRad(h,c.x,c.y,c.z);var v=new Ne;v.rotationAxisAngRad(f,d.x,d.y,d.z);for(var x=v.getMultipliedByMatrix(m,void 0).rotatePoint3D(s,void 0),_=[],y=[],T=0;T<o;T++){var C=g*T;m.rotationAxisAngRad(C,c.x,c.y,c.z);for(var b=m.rotatePoint3D(x,void 0),M=0;M<i;M++){var A=p*M;v.rotationAxisAngRad(A,d.x,d.y,d.z);var E=v.rotatePoint3D(b,void 0);_.push(E);var L=new Kr(M/(i-1),T/(o-1));y.push(L)}}var w={bCalculateBorderIndices:!1,indicesByteSize:2};return i*o>=65535&&(w.indicesByteSize=4),{pointsArray:_,texCoordsArray:y,indices:en.getIndicesTrianglesRegularNet(i,o,void 0,void 0,void 0,void 0,void 0,w).indicesArray,numCols:i,numRows:o}};var Ce={NONE:"none",CLAMP_TO_GROUND:"clampToGround",RELATIVE_TO_GROUND:"relativeToGround",getKey:function(e){switch(e){case"clampToGround":return"CLAMP_TO_GROUND";case"relativeToGround":return"RELATIVE_TO_GROUND";default:return"NONE"}},getValueByOrdinal:function(e){switch(e){case 0:return Mago3D.HeightReference.NONE;case 1:return Mago3D.HeightReference.CLAMP_TO_GROUND;case 2:return Mago3D.HeightReference.RELATIVE_TO_GROUND}}},be=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.identifierMap={},this.identifiersCount=0};be.prototype.newId=function(){this.identifiersCount++;var e=this.identifiersCount.toString();return this.identifierMap[e]=1,e};var Me=function t(r){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);if(!(r&&r instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));e.call(this),this.manager=r,this.array=[];var i=this;this.on(Pt.ADD,function(e){e.manager=r}),this.on(Pt.DEACTIVE,function(){for(var e=0,t=i.array.length;e<t;e++)i.array[e].clear(),i.array[e].active=!1})};(Me.prototype=Object.create(e.prototype)).constructor=Me,Me.EVENT_TYPE={ADD:"add",REMOVE:"remove"},Me.prototype.add=function(e){this.array.push(e),this.emit(Pt.ADD,e)},Me.prototype.remove=function(e){if(this.manager.defaultSelectInteraction===e||this.manager.defaultTranslateInteraction===e)throw new Error("Not allow delete default interaction.");this.array=this.array.filter(function(t){return t!==e}),this.emit(Pt.REMOVE,e)},Me.prototype.getSelectType=function(){return this.array.filter(function(e){if(e instanceof Mago3D.PointSelectInteraction)return e})[0].targetType};var Ae=function t(r,i,o,n){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);if(!(n&&n instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));e.call(this),this.guid=qo(),this.magoManager=n,this.depth=15,this.format=i,this.url=r,this.available,this._show=!1,this.show=o.show,this._color=Zo(o.color,new J(.35294,.43921,.47843,1)),this.masks=Zo(o.masks,void 0)};(Ae.prototype=Object.create(e.prototype)).constructor=Ae,Object.defineProperties(Ae.prototype,{show:{get:function(){return this._show},set:function(e){var t=this;e&&!this.available&&rn(this.url+"layer.json",void 0,void 0,"json","GET").then(function(e){if(!e||!e.available)throw Error("layer.json has not contain avaible property.");for(var r in t.available=e.available,t.available)if(t.available.hasOwnProperty(r))for(var i=t.available[r],o=i.length,n=0;n<o;n++)for(var a=i[n],s=a.n;s<=a.x;s++){var l=t.url+r+"/"+s+"."+t.format;t.magoManager.smartTileManager.putObject(t.depth,new Ee({url:l,format:t.format,x:parseInt(r),y:s,z:t.depth,magoManager:t.magoManager,masterId:t.guid}),t.magoManager)}},function(){throw Error("Can not find layer.json.")}),this._show=e}},color:{get:function(){return this._color},set:function(e){this._color=e}},masks:{get:function(){return this._masks},set:function(e){e&&e.features&&(this._masks=e.features.map(function(e){return e.geometry.coordinates}))}}});var Ee=function e(t){this.status=e.STATUS.UNLOAD,this._scheme={type:function(e){return"FeatureCollection"===e},features:function(e){return Array.isArray(e)}},this.url=t.url,this.format=t.format,this.x=t.x,this.y=t.y,this.z=t.z,this.magoManager=t.magoManager,this.masterId=t.masterId;var r=Ke.getGeographicExtentOfTileLXY(this.z,this.x,this.y,void 0,I.imageryType.CRS84);this.geographicCoord=r.getMidPoint(),this.geographicCoord.latitude=-this.geographicCoord.latitude};Ee.STATUS={UNLOAD:0,LOADING:1,LOADEND:2},Ee.prototype.load=function(){var e=this;e.status=Ee.STATUS.LOADING;var t="pbf"===e.format?"arraybuffer":"json";rn(e.url,void 0,void 0,t).then(function(t){var r=t;"pbf"===e.format&&(r=$o(t)),e.mergeFeatureCollection(r)},function(e){})},Ee.prototype.deleteObjects=function(){delete this.status,delete this._scheme,delete this.url,delete this.format,delete this.x,delete this.y,delete this.z,this.magoManager=void 0,delete this.masterId,this.geographicCoord.deleteObjects(),delete this.geographicCoord},Ee.getDividedFeaturesArray=function(e,t){for(var r=e.length,i=[],o=[],n=0,a=0;a<r;a++)o.push(e[a]),n>=t&&(i.push(o),o=[],n=0,!0),n++;return o.length>0&&i.push(o),i},Ee.prototype.mergeFeatureCollection=function(e){if(!cn(e,this._scheme))throw Error("Invalid data.");for(var t=e.features,r=this,i=Ee.getDividedFeaturesArray(t,200),o=i.length,n=0;n<o;n++){for(var a=i[n],s=new Array,l=0,u=a.length;l<u;l++){var c=new no(a[l]),d=this.magoManager.koreaBuildingMaster[this.masterId],h=!0;if(d.masks)for(var f=d.masks.length,g=0;g<f;g++){var p=d.masks[g],m=[c.centerGeographicCoords.longitude,c.centerGeographicCoords.latitude];if(nn(m,p)){h=!1;break}}h&&s.push(c)}var v=new lo(this.magoManager);v.attributes.isDeletableByFrustumCulling=!0,v.initialize(s).then(function(e){e.masterId=r.masterId,r.magoManager.modeler.addObject(e,15),r.status=Ee.STATUS.LOADEND})}};var Le=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.name,this.id,this.lightType=t,this.geoCoord,this.position,this.positionHIGH,this.positionLOW,this.tMatrix,this.tMatrixInv,this.depthFbo,this.bSphere,this.minDistToCam,this.maxDistToCam,this.targetTextureWidth=new Int32Array([2048]),this.targetTextureHeight=new Int32Array([2048])};function we(){return(we=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}var Se=function t(r,i,o,n,a){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);if(!r||!document.getElementById(r))throw new Error("containerId is required.");e.call(this);var s,l=null;o&&(o.loadstart&&"function"==typeof o.loadstart&&this.on("loadstart",o.loadstart),o.loadend&&"function"==typeof o.loadend&&this.on("loadend",o.loadend));var u,c,d=I.magoManagerState.INIT;u=i,(c={}).basicGlobe=F.CESIUM,c.online=!0,c.lod0=30,c.lod1=60,c.lod2=90,c.lod3=200,c.lod4=1e3,c.lod5=5e4,c.ssaoRadius=.15,c.initDefaultFov=1,c.maxPartitionsLod0=4,c.maxPartitionsLod1=2,c.maxPartitionsLod2OrLess=1,c.maxRatioPointsDist0m=1,c.maxRatioPointsDist100m=3,c.maxRatioPointsDist200m=10,c.maxRatioPointsDist400m=20,c.maxRatioPointsDist800m=40,c.maxRatioPointsDist1600m=80,c.maxRatioPointsDistOver1600m=160,c.maxPointSizeForPc=40,c.minPointSizeForPc=3,c.pendentPointSizeForPc=60,c.minHeight_rainbow_loc=0,c.maxHeight_rainbow_loc=100,n=function(e,t){e=e||{};var r={};t===F.CESIUM&&(r.infoBox=!1,r.navigationHelpButton=!1,r.selectionIndicator=!1,r.homeButton=!1,r.fullscreenButton=!1,r.geocoder=!1,r.baseLayerPicker=!1,r.sceneModePicker=!1,r.animation=!1,r.timeline=!1,r.baseLayerPicker=!1,r.geocoder=!1,r.geocoder=Cesium.SceneMode.SCENE3D);return we({},r,e||{})}(n,(i=we({},c,u||{})).basicGlobe);var h=new K(r,i,n,a);s=h.viewer,l=h.magoManager;var f={callAPI:function(e){if(e.getReturnable())return l.callAPI(e);l.callAPI(e)},getViewer:function(){return s},getMagoManagerState:function(){return d},getMagoManager:function(){return l},setBaseUrl:function(e){if(!l)throw new Error("Mago3d is no ready");l.readerWriter.geometryDataPath=e},getF4dController:function(){return l.f4dController}};return d=I.magoManagerState.READY,h.initPosition(),h.setEventHandler(),this.emit("loadend",f),f};(Se.prototype=Object.create(e.prototype)).constructor=Se;var De=function(e,t,r){this.options=r||{},i.call(this,e,t)};(De.prototype=Object.create(i.prototype)).constructor=De,De.prototype.init=function(){this.magoManager=new Fe(this.config),this.viewer=new zr(this.magoManager),this.magoManager.magoWorld=this.viewer,this.magoManager.globe=new Te,this.magoManager.tinTerrainManager=new gr(this.magoManager,this.options),this.viewer.updateModelViewMatrixByCamera(this.magoManager.sceneState.camera);var e=this.magoManager.sceneState.gl;this.magoManager.vboMemoryManager.gl=e,this.magoManager.postFxShadersManager.gl=e,this.magoManager.postFxShadersManager.createDefaultShaders(e),this.magoManager.createDefaultShaders(e);var t=this.viewer,r=this.magoManager;!function(){window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)},function e(){var i=requestAnimFrame(e);r.reqFrameId=i;t.renderScene()}()}()},De.prototype.setEventHandler=function(){var e=this.magoManager.sceneState.canvas,t=this.viewer;e.addEventListener("mousedown",function(e){t.mousedown(e)},!1),e.addEventListener("mouseup",function(e){t.mouseup(e)},!1),e.addEventListener("wheel",function(e){t.mousewheel(e)},!1),e.addEventListener("mousemove",function(e){t.mousemove(e)},!1),e.addEventListener("click",function(e){t.mouseclick(e)},!1),e.addEventListener("contextmenu",function(e){e.preventDefault(),t.mouseRightClick(e)},!1),e.addEventListener("dblclick",function(e){t.mouseDblClick(e)},!1),window.addEventListener("resize",function(r){e.width=e.offsetWidth,e.height=e.offsetHeight;var i=t.magoManager;i.sceneState.setDrawingBufferSize(e.offsetWidth,e.offsetHeight),i.isCameraMoved=!0},!1);document.addEventListener("keydown",function(e){t.keydown(e)},!1)};var Re=function(e,t){this.type=e,this.listener=t};function we(){return(we=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}Re.prototype.getType=function(){return this.type},Re.prototype.getListener=function(){return this.listener};var Pe=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(tn(t.dataGroupId))throw new Error(Ue.REQUIRED_EMPTY_ERROR("dataGroupId"));if(tn(t.dataGroupKey))throw new Error(Ue.REQUIRED_EMPTY_ERROR("dataGroupKey"));if(tn(t.dataGroupName))throw new Error(Ue.REQUIRED_EMPTY_ERROR("dataGroupName"));if(tn(t.dataGroupPath))throw new Error(Ue.REQUIRED_EMPTY_ERROR("dataGroupPath"));this.ready=!1,this.buildingSeedMap,this.id=t.dataGroupId,this.key=t.dataGroupKey,this.name=t.dataGroupName,this.path=t.dataGroupPath.replace(/\/+$/,""),this.tiling=Zo(t.tiling,!1),this.style=we({},t.style||{});var r=t.longitude,i=t.latitude,o=t.altitude;if(!isNaN(r)&&!isNaN(i)&&isNaN(o),this.datas=[],t.datas&&Array.isArray(t.datas))for(var n=0,a=t.datas.length;n<a;n++){var s=t.datas[n];this.addData(s)}};Pe.prototype.getObjectIndexFile=function(){var e=this,t="/f4d/"+this.path+F.OBJECT_INDEX_FILE+F.CACHE_VERSION+(new Date).getTime();rn(t).then(function(t){var r=t;if(r){var i=new W;i.dataArrayBuffer=r,i.parseBuildingSeedArrayBuffer(),e.ready=!0,e.buildingSeedMap=i;var o=e.datas.length;if(o>0)for(var n=0;n<o;n++)e.readyData(e.datas[n])}},function(e){console.log("xhr status = "+e)})},Pe.prototype.addData=function(e){e instanceof Be||(e=new Be(e)),this.datas.push(e),this.ready&&that.buildingSeedMap&&this.readyData(e)},Pe.prototype.readyData=function(e){try{var t=this.buildingSeedMap.map.get(e.key);if(!t)throw new Error("This data("+e.key+") is seedless!");e.buildingSeed=t}catch(e){console.warn(e)}};var Ie=function t(){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);e.call(this),this.layers=[]};function H(e){"@babel/helpers - typeof";return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}(Ie.prototype=Object.create(e.prototype)).constructor=Ie,Ie.EVENT_TYPE={ADD:"add",REMOVE:"remove"},Ie.prototype.add=function(e){if(!Qo(e))throw new Error(Ue.REQUIRED_EMPTY_ERROR("layer"));e instanceof Pe||(e=new Pe(e)),e.tiling||e.getObjectIndexFile(),this.layers.push(e),this.emit(Ie.EVENT_TYPE.ADD,{type:Ie.EVENT_TYPE.ADD,layer:e,timestamp:new Date})},Ie.prototype.removeById=function(e){if(!Qo(e))throw new Error(Ue.REQUIRED_EMPTY_ERROR("id"));for(var t=this.layers,r={id:e},i=t.length-1;i>=0;i--){if(t[i].id===e){t.slice(i,1),r.index=i;break}}if(!r.hasOwnProperty("index"))throw new Error("this id is not exist");this.emit(Ie.EVENT_TYPE.REMOVE,{type:Ie.EVENT_TYPE.REMOVE,layer:r,timestamp:new Date})};var Fe=function t(r){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);e.call(this),this.config=r,this.renderer=new bo(this),this.selectionManager=void 0,this.postFxShadersManager=new Oo(this),this.configInformation=this.config.getPolicy(),this.readerWriter=new hr(this.configInformation),this.magoPolicy=new B(this.configInformation),this.animationManager=void 0,this.texturesStore=new st(this),this.smartTileManager=new Ze({magoManager:this}),this.processQueue=new dr,this.parseQueue=new cr,this.hierarchyManager=new Wt,this.depthFboNeo=void 0,this.depthFboAux=void 0,this.selectionFbo=void 0,this.mouse_x=0,this.mouse_y=0,this.mouseLeftDown=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.objectSelected=void 0,this.buildingSelected=void 0,this.octreeSelected=void 0,this.nodeSelected=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.startMovPoint=new Jr,this.cameraFPV=new he,this.myCameraSCX,this.loadQueue=new qt(this),this.sceneState=new Ao(this.config),this.sceneState.setApplySunShadows(!1),this.magoPolicy.objectMoveMode=I.moveMode.NONE,this.selectionColor=new Ye,this.vboMemoryManager=new mt(this.configInformation),void 0!==this.configInformation&&(this.magoPolicy.setLod0DistInMeters(this.configInformation.lod0),this.magoPolicy.setLod1DistInMeters(this.configInformation.lod1),this.magoPolicy.setLod2DistInMeters(this.configInformation.lod2),this.magoPolicy.setLod3DistInMeters(this.configInformation.lod3),this.magoPolicy.setLod4DistInMeters(this.configInformation.lod4),this.magoPolicy.setLod5DistInMeters(this.configInformation.lod5),this.configInformation.ssaoRadius&&(this.sceneState.ssaoRadius[0]=Number(this.configInformation.ssaoRadius))),this.fileRequestControler=new se,this.visibleObjControlerOctrees=new _t,this.visibleObjControlerNodes=new _t,this.visibleObjControlerTerrain=new _t,this.frustumVolumeControl=new ge,this.boundingSphere_Aux=void 0,this.radiusAprox_aux=void 0,this.backGround_fileReadings_count=0,this.backGround_imageReadings_count=0,this.isCameraMoving=!1,this.renderingFase=0,this.bPicking=!1,this.scene=void 0,this.numFrustums,this.isLastFrustum=!1,this.currentFrustumIdx=0,this.highLightColor4=new Float32Array([.2,1,.2,1]),this.thereAreUrgentOctrees=!1,this.hierarchyManager=new Wt,this.smallObjectSize=.153,this.sqrtTable=new Float32Array(11);for(var i=0;i<11;i++)this.sqrtTable[i]=Math.sqrt(1+.1*i*(.1*i));this.managerUtil=new on,this.frustumVolumeControl=new ge,this.pointSC=new Jr,this.arrayAuxSC=[],this.currentTimeSC,this.dateSC=new Date,this.startTimeSC,this.resultRaySC=new Float32Array(3),this.matrix4SC=new Ne,this.axisXYZ=new xr,this.objMarkerManager=new Ve(this),this.tempSettings={},this.tempSettings.renderWithTopology=1,this.tempSettings.renderSpaces=!0,this.tempSettings.spacesAlpha=.6,this._settings=new qe,this.tinTerrainManager=void 0,this.modeler=new jr(this),this.materialsManager=new Vr(this),this.processCounterManager=new ri,this.f4dController=new ne(this),this.effectsManager=new Mt,this.currentProcess=I.magoCurrentProcess.Unknown,this.interactionCollection=new Me(this),this.defaultSelectInteraction=new Bt,this.defaultTranslateInteraction=new Gt,this.interactionCollection.add(this.defaultTranslateInteraction),this.interactionCollection.add(this.defaultSelectInteraction),this.controls=new $(this),this.magoLayerCollection=new Ie,this._needValidHeightNodeArray=[],this._needValidHeightNativeArray=[],this._changeCanvasSizeEvent=new CustomEvent("changeCanvasSize"),this.koreaBuildingMaster={},window.Mago3D&&Mago3D.WeatherStation&&void 0===this.weatherStation&&(this.weatherStation=new Mago3D.WeatherStation(this)),this.quantizedMeshManager=new ai(this),this.workersManager=new Tt(this)};Fe.prototype=Object.create(e.prototype),Fe.prototype.constructor=Fe,Fe.EVENT_TYPE={CLICK:"click",DBCLICK:"dbclick",RIGHTCLICK:"rightclick",MOUSEMOVE:"mousemove",LEFTDOWN:"leftdown",LEFTUP:"leftup",MIDDLEDOWN:"middledown",MIDDLEUP:"middleup",RIGHTDOWN:"rightdown",RIGHTUP:"rightup",WHEEL:"wheel",SMARTTILELOADSTART:"smarttileloadstart",SMARTTILELOADEND:"smarttileloadend",F4DLOADSTART:"f4dloadstart",F4DLOADEND:"f4dloadend",F4DRENDERREADY:"f4drenderready",SELECTEDF4D:"selectedf4d",SELECTEDF4DMOVED:"selectedf4dmoved",SELECTEDF4DOBJECT:"selectedf4dobject",SELECTEDGENERALOBJECT:"selectedgeneralobject",DESELECTEDF4D:"deselectedf4d",DESELECTEDF4DOBJECT:"deselectedf4dobject",DESELECTEDGENERALOBJECT:"deselectedgeneralobject",CAMERACHANGED:"camerachanged",CAMERAMOVEEND:"cameramoveend",CAMERAMOVESTART:"cameramovestart",ANIMATIONEND:"animationEnd",ANIMATIONING:"animationing",VALIDHEIGHTEND:"validHeightEnd"},Fe.prototype.init=function(e){console.debug("[MagoJs] Initialize MagoJs"),this.bInit=!0,void 0===this.sceneState.gl&&(this.sceneState.gl=e),void 0===this.vboMemoryManager.gl&&(this.vboMemoryManager.gl=e),void 0===this.effectsManager.gl&&(this.effectsManager.gl=e),this.selectionManager=new wo(this)},Fe.prototype.start=function(e,t,r,i){if(this.magoPolicy.getMagoEnable())if(void 0!==e)if(void 0!==r)if(void 0!==i){if(this.numFrustums=i,this.currentFrustumIdx=this.numFrustums-r-1,this.currentFrustumIdx===i-1&&(this.isLastFrustum=!0),void 0===this.configInformation&&(this.configInformation=this.config.getPolicy()),!this.bInit){var o=e?e.context._gl:this.sceneState.gl;if(o.getExtension("EXT_frag_depth"),this.init(o),o.isContextLost())return}this.startRender(this.isLastFrustum,this.currentFrustumIdx,i)}else console.debug("[MagoJs] numFrustums is undefined.");else console.debug("[MagoJs] frustumIdx is undefined.");else console.debug("[MagoJs] scene is undefined.")},Fe.prototype.updateSize=function(){var e=this.sceneState,t=e.canvas;t.width=t.offsetWidth,t.height=t.offsetHeight,e.setDrawingBufferSize(t.offsetWidth,t.offsetHeight)},Fe.prototype.isCesiumGlobe=function(){return this.configInformation.basicGlobe===F.CESIUM},Fe.prototype.handleBrowserEvent=function(e){this.emit(e.type,e);for(var t=this.interactionCollection.array,r=t.length-1;r>=0;r--){var i=t[r];i.getActive()&&i.handle(e)}this.setMouseStatus(e.type)},Fe.prototype.setMouseStatus=function(e){if(this.magoPolicy.getMagoEnable())switch(e){case"leftdown":this.mouseLeftDown=!0,this.isCameraMoving=!0;break;case"leftup":this.isCameraMoving=!1,this.mouseLeftDown=!1;break;case"middledown":this.mouseMiddleDown=!0,this.isCameraMoving=!0;break;case"middleup":this.isCameraMoving=!1,this.mouseMiddleDown=!1;break;case"rightdown":this.mouseRightDown=!0,this.isCameraMoving=!0;break;case"rightup":this.mouseRightDown=!1,this.isCameraMoving=!1;break;case"mousemove":(this.mouseMiddleDown||this.mouseLeftDown)&&(this.isCameraMoving=!0)}},Fe.prototype.swapRenderingFase=function(){this.renderingFase+=1,this.renderingFase>100&&(this.renderingFase=1)},Fe.prototype.prepareNeoBuildingsAsimetricVersion=function(e,t){var r,i,o,n=this.readerWriter.geometryDataPath;void 0===this.headersRequestedCounter&&(this.headersRequestedCounter=0);for(var a=0,s=[].concat(t.currentVisibles0,t.currentVisibles2,t.currentVisibles3,t.currentVisibles0Transparents,t.currentVisibles2Transparents,t.currentVisibles3Transparents,t.currentVisiblesAux,t.currentVisiblesToPrepare),l=0,u=s.length;l<u;l++){var c=(i=s[l]).data.attributes;if(void 0!==c){r=i.data.neoBuilding,void 0!==c.projectId&&void 0!==c.isReference&&!0===c.isReference&&Ti.manageStaticModel(i,this);var d=i.data.attributes.fromSmartTile;if(void 0===d&&(d=!1),r){var h=r.metaData;if(h.fileLoadState===I.fileLoadState.READY){if(!d){if(o=r.projectFolderName,this.fileRequestControler.isFullHeaders())return;var f=n+"/"+o+"/"+r.buildingFileName+"/HeaderAsimetric.hed";this.readerWriter.getNeoHeaderAsimetricVersion(e,f,r,this.readerWriter,this)}}else if(h.fileLoadState===I.fileLoadState.LOADING_FINISHED){if(r.parseHeader(r.headerDataArrayBuffer,0),i.isNeedValidHeight(this)&&this._needValidHeightNodeArray.push(i),++a>60)break}}}}s.length=0},Fe.prototype.upDateSceneStateMatrices=function(e){if(void 0===this.myCameraSCX&&(this.myCameraSCX=new X({name:"cameraSCX"})),void 0!==this.configInformation){if(this.isCesiumGlobe()){var t=this.scene,r=t._context.uniformState;if(this.isFarestFrustum()){var i=(E=t.camera).positionWC.x,o=E.positionWC.y,n=E.positionWC.z,a=E.directionWC.x,s=E.directionWC.y,l=E.directionWC.z,u=E.upWC.x,c=E.upWC.y,d=E.upWC.z,h=i+1e3*a,f=o+1e3*s,g=n+1e3*l;(U=this.sceneState.modelViewMatrix)._floatArrays=Ne.lookAt(U._floatArrays,[i,o,n],[h,f,g],[u,c,d])}if(Cesium.Matrix4.toArray(r._projection,e.projectionMatrix._floatArrays),e.projectionMatrixInv=void 0,(N=e.getModelViewMatrixInv())._floatArrays=glMatrix.mat4.invert(N._floatArrays,e.modelViewMatrix._floatArrays),e.normalMatrix4._floatArrays=glMatrix.mat4.transpose(e.normalMatrix4._floatArrays,N._floatArrays),e.modelViewRelToEyeMatrix._floatArrays=glMatrix.mat4.copy(e.modelViewRelToEyeMatrix._floatArrays,e.modelViewMatrix._floatArrays),e.modelViewRelToEyeMatrix._floatArrays[12]=0,e.modelViewRelToEyeMatrix._floatArrays[13]=0,e.modelViewRelToEyeMatrix._floatArrays[14]=0,e.modelViewRelToEyeMatrix._floatArrays[15]=1,e.modelViewRelToEyeMatrixInv._floatArrays=glMatrix.mat4.invert(e.modelViewRelToEyeMatrixInv._floatArrays,e.modelViewRelToEyeMatrix._floatArrays),e.modelViewProjMatrix._floatArrays=glMatrix.mat4.multiply(e.modelViewProjMatrix._floatArrays,e.projectionMatrix._floatArrays,e.modelViewMatrix._floatArrays),e.modelViewProjRelToEyeMatrix._floatArrays=glMatrix.mat4.multiply(e.modelViewProjRelToEyeMatrix._floatArrays,e.projectionMatrix._floatArrays,e.modelViewRelToEyeMatrix._floatArrays),e.applyLightsShadows){var p=2e4,m=.1,v=e.camera.frustum.fovyRad[0],x=e.camera.frustum.aspectRatio[0];(k=e.projectionMatrixLighting)._floatArrays=glMatrix.mat4.perspective(k._floatArrays,v,x,m,p),(j=e.modelViewProjRelToEyeMatrixLighting)._floatArrays=glMatrix.mat4.multiply(j._floatArrays,k._floatArrays,e.modelViewRelToEyeMatrix._floatArrays)}var _=t.context._us._cameraPosition;on.calculateSplited3fv([_.x,_.y,_.z],e.encodedCamPosHigh,e.encodedCamPosLow);var y=this.scene._frustumCommandsList;if(void 0===y&&(y=this.scene.frustumCommandsList),!this.isCameraMoved){i=this.scene.camera.positionWC.x,o=this.scene.camera.positionWC.y,n=this.scene.camera.positionWC.z,a=this.scene.camera.direction.x,s=this.scene.camera.direction.y,l=this.scene.camera.direction.z,u=this.scene.camera.up.x,c=this.scene.camera.up.y,d=this.scene.camera.up.z;e.camera.isCameraMoved(i,o,n,a,s,l,u,c,d)&&(this.isCameraMoved=!0)}if(this.isCameraMoved&&this.isFarestFrustum()&&(e.camera.calculateSpeed(i,o,n,this.getCurrentTime()),this.emit("isCameraMoved")),this.upDateCamera(e.camera),e.drawingBufferWidth[0]!==t.drawingBufferWidth||e.drawingBufferHeight[0]!==t.drawingBufferHeight){e.drawingBufferWidth[0]=t.drawingBufferWidth,e.drawingBufferHeight[0]=t.drawingBufferHeight;var T=this.getObjectLabel();T.width=t.drawingBufferWidth,T.height=t.drawingBufferHeight,window.dispatchEvent(this._changeCanvasSizeEvent)}var C=this.currentFrustumIdx,b=this.sceneState.projectionMatrix,M=Ne.getNearFromPerspectiveMatrix(b),A=Ne.getFarFromPerspectiveMatrix(b);this.frustumVolumeControl.nearFarArray[2*C]=M,this.frustumVolumeControl.nearFarArray[2*C+1]=A}else{var E,L=(E=e.camera).position,w=E.getFrustum(0),S=E.getCameraElevation(),D=Te.equatorialRadius();S<0&&(S*=-1);Math.PI;var R=D+S,P=Math.acos(D/R),I=R*Math.sin(P)*.8;S>5e4&&(I*=1.5),I<1e5&&(I=1e5),w.near[0]=1e-4,w.near[0]=S>1e4?.1+.8*S:.1,w.far[0]=I,this.postFxShadersManager.bUseLogarithmicDepth&&(w.near[0]=1e-6),on.calculateSplited3fv([L.x,L.y,L.z],e.encodedCamPosHigh,e.encodedCamPosLow);var F=e.projectionMatrix;F=fe.getProjectionMatrix(w,F);var O=D+1.5*S,B=e.projectionMatrixSky;B._floatArrays=glMatrix.mat4.perspective(B._floatArrays,w.fovyRad[0],w.aspectRatio[0],w.near[0],O);var N,U=e.modelViewMatrix;(N=e.getModelViewMatrixInv())._floatArrays=glMatrix.mat4.invert(N._floatArrays,U._floatArrays),(K=e.normalMatrix4)._floatArrays=glMatrix.mat4.transpose(K._floatArrays,N._floatArrays);var G=e.modelViewRelToEyeMatrix;G._floatArrays=glMatrix.mat4.copy(G._floatArrays,U._floatArrays),G._floatArrays[12]=0,G._floatArrays[13]=0,G._floatArrays[14]=0,G._floatArrays[15]=1;var z=e.modelViewRelToEyeMatrixInv;z._floatArrays=glMatrix.mat4.invert(z._floatArrays,G._floatArrays);var H=e.modelViewProjMatrix;H._floatArrays=glMatrix.mat4.multiply(H._floatArrays,F._floatArrays,U._floatArrays);var V=e.modelViewProjRelToEyeMatrix;if(V._floatArrays=glMatrix.mat4.multiply(V._floatArrays,F._floatArrays,G._floatArrays),e.applyLightsShadows){var k,j;p=2e4,m=.1,v=e.camera.frustum.fovyRad[0],x=e.camera.frustum.aspectRatio[0];(k=e.projectionMatrixLighting)._floatArrays=glMatrix.mat4.perspective(k._floatArrays,v,x,m,p),(j=e.modelViewProjRelToEyeMatrixLighting)._floatArrays=glMatrix.mat4.multiply(j._floatArrays,k._floatArrays,e.modelViewRelToEyeMatrix._floatArrays)}var W=e.modelViewProjRelToEyeMatrixSky;W._floatArrays=glMatrix.mat4.multiply(W._floatArrays,B._floatArrays,G._floatArrays),e.fCoef_logDepth[0]=2/Math.log2(w.far[0]+1);C=this.currentFrustumIdx;this.frustumVolumeControl.nearFarArray[2*C]=w.near[0],this.frustumVolumeControl.nearFarArray[2*C+1]=w.far[0]}if(e.modelViewProjMatrixInv=void 0,e.projectionMatrixInv=void 0,void 0!==this.depthFboNeo){var Y=this.texturesStore.getNoiseTexture4x4();e.ssaoNoiseScale2[0]=this.depthFboNeo.width[0]/Y.width,e.ssaoNoiseScale2[1]=this.depthFboNeo.height[0]/Y.height}this.myCameraSCX.direction.set(e.camera.direction.x,e.camera.direction.y,e.camera.direction.z),this.myCameraSCX.up.set(e.camera.up.x,e.camera.up.y,e.camera.up.z);w=this.myCameraSCX.getFrustum(0);var q=e.camera.getFrustum(0);w.near[0]=q.near[0],w.far[0]=q.far[0],w.fovyRad[0]=q.fovyRad[0],w.tangentOfHalfFovy[0]=q.tangentOfHalfFovy[0],w.fovRad[0]=q.fovRad[0],w.aspectRatio[0]=q.aspectRatio[0],this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||e.sunSystem&&e.applySunShadows&&this.isFarestFrustum()&&e.sunSystem.updateSun(this);var K=e.normalMatrix4,Z=new Jr(e.sunSystem.sunDirWC[0],e.sunSystem.sunDirWC[1],e.sunSystem.sunDirWC[2]),J=K.rotatePoint3D(Z,void 0);e.sunSystem.sunDirCC[0]=J.x,e.sunSystem.sunDirCC[1]=J.y,e.sunSystem.sunDirCC[2]=J.z}},Fe.prototype.upDateCamera=function(e){if(this.isCesiumGlobe()){for(var t=this.scene,r=t.frustumCommandsList,i=this.currentFrustumIdx,o=this.sceneState.camera,n=this.sceneState.projectionMatrix,a=Ne.getNearFromPerspectiveMatrix(n),s=Ne.getFarFromPerspectiveMatrix(n),l=a,u=t.opaqueFrustumNearOffset,c=r.length,d=[],h=void 0,f=0;f<c;f++){d[2*f]=r[f].near,d[2*f+1]=r[f].far,0!==f&&(d[2*f]*=u),(E=o.getFrustum(f)).far[0]=r[f].far,E.near[0]=r[f].near,E.fovRad[0]=t.camera.frustum._fov,E.fovyRad[0]=t.camera.frustum._fovy,E.aspectRatio[0]=t.camera.frustum._aspectRatio,void 0===h&&(h=Math.tan(E.fovyRad/2)),E.tangentOfHalfFovy[0]=h}var g=this.sceneState.getModelViewMatrixInv(),p=t.camera.positionWC.x,m=t.camera.positionWC.y,v=t.camera.positionWC.z,x=-g._floatArrays[8],_=-g._floatArrays[9],y=-g._floatArrays[10],T=g._floatArrays[4],C=g._floatArrays[5],b=g._floatArrays[6];e.position.set(p,m,v),e.direction.set(x,_,y),e.up.set(T,C,b);var M=1,A=1;E&&(M=E.aspectRatio[0],A=E.fovyRad[0]),E=e.getFrustum(i),e.frustum.near[0]=l,e.frustum.far[0]=s,e.setFrustumsDistances(c,d),e.setAspectRatioAndFovyRad(M,A),e.calculateFrustumsPlanes()}else{(o=this.sceneState.camera).doInertialMovement(this);var E;i=0,M=(E=(o=this.sceneState.camera).getFrustum(i)).aspectRatio[0],A=E.fovyRad[0],s=E.far[0],l=E.near[0];this.sceneState.camera.frustum.near[0]=l,this.sceneState.camera.frustum.far[0]=s,this.sceneState.camera.frustum.aspectRatio[0]=M;for(c=1,d=[],f=0;f<c;f++)d[2*f]=E.near[0],d[2*f+1]=E.far[0];e.position.set(o.position.x,o.position.y,o.position.z),e.direction.set(o.direction.x,o.direction.y,o.direction.z),e.up.set(o.up.x,o.up.y,o.up.z),(E=e.getFrustum(i)).near[0]=l,E.far[0]=s,e.setFrustumsDistances(c,d),e.setAspectRatioAndFovyRad(M,A),e.calculateFrustumsPlanes()}},Fe.prototype.getCurrentTime=function(){return void 0===this.currTime&&(this.dateSC=new Date,this.currTime=this.dateSC.getTime()),this.currTime},Fe.prototype.getSecondsPerFrame=function(){return(this.getCurrentTime()-this.prevTime)/1e3},Fe.prototype.getGl=function(){if(void 0!==this.sceneState)return this.sceneState.gl},Fe.prototype.loadAndPrepareData=function(){var e,t=this.getGl();this.visibleObjControlerOctrees.initArrays();var r=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(0),i=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(2),o=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(3);this.checkPropertyFilters(r),this.checkPropertyFilters(i),this.checkPropertyFilters(o);for(var n=this.visibleObjControlerNodes.currentVisibles0.length,a=0;a<n;a++){"basicF4d"===(e=this.visibleObjControlerNodes.currentVisibles0[a]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(t,e,this.visibleObjControlerOctrees,0)||(this.visibleObjControlerNodes.currentVisibles0.splice(a,1),a--,n=this.visibleObjControlerNodes.currentVisibles0.length))}n=this.visibleObjControlerNodes.currentVisibles0Transparents.length;for(a=0;a<n;a++){"basicF4d"===(e=this.visibleObjControlerNodes.currentVisibles0Transparents[a]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(t,e,this.visibleObjControlerOctrees,0)||(this.visibleObjControlerNodes.currentVisibles0Transparents.splice(a,1),a--,n=this.visibleObjControlerNodes.currentVisibles0Transparents.length))}if(this.prepareVisibleOctreesSortedByDistance(t,this.visibleObjControlerOctrees),this.prepareVisibleOctreesSortedByDistanceLOD2(t,this.visibleObjControlerOctrees.currentVisibles0),this.prepareVisibleOctreesSortedByDistanceLOD2(t,this.visibleObjControlerOctrees.currentVisibles1),this.prepareVisibleOctreesSortedByDistanceLOD2(t,this.visibleObjControlerOctrees.currentVisibles2),this.readerWriter.referencesList_requested<5){n=this.visibleObjControlerNodes.currentVisibles2.length;for(a=0;a<n;a++){"basicF4d"===(e=this.visibleObjControlerNodes.currentVisibles2[a]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(t,e,this.visibleObjControlerOctrees,2)||(this.visibleObjControlerNodes.currentVisibles2.splice(a,1),a--,n=this.visibleObjControlerNodes.currentVisibles2.length))}n=this.visibleObjControlerNodes.currentVisibles2Transparents.length;for(a=0;a<n;a++){"basicF4d"===(e=this.visibleObjControlerNodes.currentVisibles2Transparents[a]).data.attributes.objectType&&(this.getRenderablesDetailedNeoBuildingAsimetricVersion(t,e,this.visibleObjControlerOctrees,2)||(this.visibleObjControlerNodes.currentVisibles2Transparents.splice(a,1),a--,n=this.visibleObjControlerNodes.currentVisibles2Transparents.length))}this.prepareVisibleOctreesSortedByDistanceLOD2(t,this.visibleObjControlerOctrees.currentVisibles2)}this.readerWriter.skinLegos_requested=0,this.prepareVisibleLowLodNodes(r),this.prepareVisibleLowLodNodes(i),this.prepareVisibleLowLodNodes(o),this.readerWriter.pCloudPartitionsMother_requested=0;var s=this.visibleObjControlerNodes.currentVisiblesPT10;if(s.length>0){for(var l=[],u=(a=0,s.length);a<u;a++){var c=s[a];l.push(c.data.neoBuilding.octree)}this.visibleObjControlerOctrees.currentVisibles0=l,this.prepareVisibleOctreesSortedByDistance(t,this.visibleObjControlerOctrees)}if(this.isFarestFrustum()){var d=this.sceneState.camera;if(void 0===this.cameraLastPosition&&(this.cameraLastPosition=new Jr(0,0,0)),void 0===this.cameraLastTime&&(this.cameraLastTime=this.getCurrentTime()),void 0===this.cameraLastTimeForMesh&&(this.cameraLastTimeForMesh=this.getCurrentTime()),void 0===this.cameraStopped&&(this.cameraStopped=!0),void 0===this.cameraStoppedForMesh&&(this.cameraStoppedForMesh=!0),void 0!==this.tinTerrainManager&&this.tinTerrainManager.ready)if(d.position.distToPoint(this.cameraLastPosition)<4){var h=this.getCurrentTime()-this.cameraLastTimeForMesh;!this.cameraStoppedForMesh&&h>500&&(this.cameraStoppedForMesh=!0),this.cameraStoppedForMesh&&(this.tinTerrainManager.prepareVisibleTinTerrains(this),this.cameraLastTimeForMesh=this.getCurrentTime())}else this.cameraStoppedForMesh=!1;if(this.fileRequestControler.tinTerrainTexturesRequested<6)if(d.position.distToPoint(this.cameraLastPosition)<4){h=this.getCurrentTime()-this.cameraLastTime;!this.cameraStopped&&h>500&&(this.cameraStopped=!0),this.cameraStopped&&void 0!==this.tinTerrainManager&&this.tinTerrainManager.ready&&(this.tinTerrainManager.prepareVisibleTinTerrainsTextures(this),this.cameraLastTime=this.getCurrentTime())}else this.cameraStopped=!1;this.cameraLastPosition.set(d.position.x,d.position.y,d.position.z)}this.manageQueue()},Fe.prototype.getSelectionFBO=function(){if(void 0===this.selectionFbo){var e=this.getTexturesManager(),t=this.getGl();this.selectionFbo=new ae(t,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0}),this.selectionFbo.colorBuffer=e.texturesMergerFbo.colorBuffersArray[3]}return this.selectionFbo},Fe.prototype.managePickingProcess=function(){var e=this.getGl(),t=this.getSelectionFBO();if(0===this.currentFrustumIdx){if(!0===this.bPicking){var r=this.selectionManager,i=!!r.currentGeneralObjectSelected;this.bPicking=!1,this.arrayAuxSC.length=0,r.clearCurrents();this.objectSelected=this.getSelectedObjects(e,this.mouse_x,this.mouse_y,this.arrayAuxSC,!0);var o=this.arrayAuxSC[0],n=this.arrayAuxSC[1],a=this.arrayAuxSC[3],s=this.magoPolicy.getObjectMoveMode();s===I.moveMode.ALL?o&&a?this.emit(Fe.EVENT_TYPE.SELECTEDF4D,{type:Fe.EVENT_TYPE.SELECTEDF4D,f4d:a,timestamp:new Date}):this.buildingSelected&&!o&&this.nodeSelected&&!a&&this.emit(Fe.EVENT_TYPE.DESELECTEDF4D,{type:Fe.EVENT_TYPE.DESELECTEDF4D}):s===I.moveMode.OBJECT&&(n&&this.objectSelected?this.emit(Fe.EVENT_TYPE.SELECTEDF4DOBJECT,{type:Fe.EVENT_TYPE.SELECTEDF4DOBJECT,octree:o,object:this.objectSelected,timestamp:new Date}):this.octreeSelected&&!n&&this.emit(Fe.EVENT_TYPE.DESELECTEDF4DOBJECT,{type:Fe.EVENT_TYPE.DESELECTEDF4DOBJECT})),this.buildingSelected=o,this.octreeSelected=n,this.nodeSelected=a,this.nodeSelected?this.rootNodeSelected=this.nodeSelected.getRoot():this.rootNodeSelected=void 0,this.arrayAuxSC.length=0,void 0!==this.buildingSelected&&(this.displayLocationAndRotation(this.buildingSelected),this.selectedObjectNotice(this.buildingSelected)),r.currentGeneralObjectSelected?this.emit(Fe.EVENT_TYPE.SELECTEDGENERALOBJECT,{type:Fe.EVENT_TYPE.SELECTEDGENERALOBJECT,generalObject:r.currentGeneralObjectSelected,timestamp:new Date}):i&&!r.currentGeneralObjectSelected&&this.emit(Fe.EVENT_TYPE.DESELECTEDGENERALOBJECT,{type:Fe.EVENT_TYPE.DESELECTEDGENERALOBJECT})}this.selectionColor.init()}t.unbind(),e.enable(e.CULL_FACE)},Fe.prototype.getSilhouetteDepthFbo=function(){var e=this.getGl();return void 0===this.silhouetteDepthFboNeo&&(this.silhouetteDepthFboNeo=new ae(e,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})),this.silhouetteDepthFboNeo},Fe.prototype.bindMainFramebuffer=function(){this.scene.view.globeDepth.framebuffer._bind()},Fe.prototype.getTexturesManager=function(){if(!this.texturesManager){var e=this.getGl(),t=this.sceneState.drawingBufferWidth[0],r=this.sceneState.drawingBufferHeight[0];void 0===this.framebufferAux&&(this.framebufferAux=new ae(e,t,r,{matchCanvasSize:!0})),this.texturesManager=new at(this);var i=this.postFxShadersManager.bUseMultiRenderTarget;this.texturesManager.texturesMergerFbo=new ae(e,t,r,{matchCanvasSize:!0,multiRenderTarget:i,numColorBuffers:7}),this.depthTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[0],this.normalTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[1],this.albedoTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[2],this.selColorTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[3],this.brightColorTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[5],this.debugTex=this.texturesManager.texturesMergerFbo.colorBuffersArray[6]}return this.texturesManager},Fe.prototype.renderManagersTransparentPass=function(){if(void 0!==this.otherManagers)for(var e in this.otherManagers)if(Object.prototype.hasOwnProperty.call(this.otherManagers,e)){var t=this.otherManagers[e];void 0!==t&&t.render()}if(this.waterManager){var r=this.visibleObjControlerNodes.getAllVisibles(),i=this.visibleObjControlerNodes.getAllNatives();this.waterManager.doIntersectedObjectsCulling(r,i),this.waterManager.render()}if(this.soundManager){r=this.visibleObjControlerNodes.getAllVisibles(),i=this.visibleObjControlerNodes.getAllNatives();this.soundManager.doIntersectedObjectsCulling(r,i),this.soundManager.render()}if(this.chemicalAccidentManager&&this.chemicalAccidentManager.render(),this.airPollutionManager&&this.airPollutionManager.render(),void 0!==this.itineraryManager&&(void 0===this.animationTimeController&&(this.animationTimeController=new fn),this.itineraryManager.render(),this.isFarestFrustum())){if(void 0!==this.weatherStation){var o=this.weatherStation;if(void 0!==o.pollutionVolumesArray&&o.pollutionVolumesArray.length>0){var n=o.pollutionVolumesArray[0];if(n.getPollutionLayersCount()>0){var a=this.animationTimeController.getCurrentTimeMilisec(),s=n._pollutionLayersArray[0];this.itineraryManager.sampleWeatherPollution(a,s)}}}if(void 0!==this.chemicalAccidentManager){var l=this.chemicalAccidentManager;if(void 0!==l.chemAccidentLayersArray&&l.chemAccidentLayersArray.length>0){var u=l.chemAccidentLayersArray[0],c=this.animationTimeController.getCurrentUnixTimeMilisec();this.itineraryManager.sampleChemicalContamination(c,u)}}}},Fe.prototype.doRender=function(e){var t=this.getGl();if(void 0!==t)if(this.postFxShadersManager.bUseMultiRenderTarget)if(this.isCesiumGlobe()){var r=this.scene._context._clearColor,i=0;this.renderType=0;var o=this.sceneState;!o.applySunShadows||this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.renderer.renderDepthSunSystem(this.visibleObjControlerNodes),this.swapRenderingFase());var n=this.visibleObjControlerNodes.currentVisibleNativeObjects.lightSourcesArray,a=n.length,s=this.getCurrentTime();if(a>0&&o.applyLightsShadows&&!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown)for(var l=this.visibleObjControlerNodes.getAllVisibles(),u=this.visibleObjControlerNodes.getAllNatives(),c=0;c<a;c++){if((T=n[c]).cullingUpdatedTime||(T.cullingUpdatedTime=0),s!==T.cullingUpdatedTime){if((s-T.cullingUpdatedTime)/1e3<3)continue;T.clearIntersectedObjects()}T.doIntersectedObjectsCulling(l,u)&&(T.cullingUpdatedTime=s,0)}this.selectionManager.existSelectedObjects()&&this.renderer.renderSilhouetteDepth(),void 0===this.framebufferAux&&(this.framebufferAux=new ae(t,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})),void 0===this.ssaoFromDepthFbo&&(this.ssaoFromDepthFbo=new ae(t,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0,numColorBuffers:2,widthScale:1,heightScale:1})),void 0===this.shadedColorFbo&&(this.shadedColorFbo=new ae(t,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0}));var d=this.getTexturesManager();if(this.depthFboNeo=d.texturesMergerFbo,this.depthTex=this.depthFboNeo.colorBuffersArray[0],this.normalTex=this.depthFboNeo.colorBuffersArray[1],this.albedoTex=this.depthFboNeo.colorBuffersArray[2],this.selColorTex=this.depthFboNeo.colorBuffersArray[3],this.brightColorTex=this.depthFboNeo.colorBuffersArray[5],!d.bloomBufferFBO){var h=this.sceneState.drawingBufferWidth[0],f=this.sceneState.drawingBufferHeight[0],g=this.postFxShadersManager.bUseMultiRenderTarget;d.bloomBufferFBO=new ae(t,h,f,{matchCanvasSize:!0,multiRenderTarget:g,numColorBuffers:2,widthScale:.25,heightScale:.25,textureMagFilter:t.LINEAR,textureMinFilter:t.LINEAR}),this.brightColorTex_A=d.bloomBufferFBO.colorBuffersArray[1],this.brightColorTex_B=d.bloomBufferFBO.colorBuffersArray[0]}this.postFxShadersManager.useProgram(null);if(void 0!==this.sceneState.sunSystem&&this.sceneState.applySunShadows&&!0,this.isCesiumGlobe()){var p=this.scene;if(this.extbuffers||(this.extbuffers=t.getExtension("WEBGL_draw_buffers")),p.view.globeDepth.framebuffer._bind(),this.cesiumColorBuffer=t.getFramebufferAttachmentParameter(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME),this.renderer.renderTerrainCopy(),t.bindFramebuffer(t.FRAMEBUFFER,null),p&&p._context&&p.view.globeDepth.framebuffer){this.bindMainFramebuffer(),this.extbuffers||(this.extbuffers=t.getExtension("WEBGL_draw_buffers"));var m=this.extbuffers;t.framebufferTexture2D(t.FRAMEBUFFER,m.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,this.depthTex,0),t.framebufferTexture2D(t.FRAMEBUFFER,m.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,this.normalTex,0),t.framebufferTexture2D(t.FRAMEBUFFER,m.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,this.albedoTex,0),t.framebufferTexture2D(t.FRAMEBUFFER,m.COLOR_ATTACHMENT4_WEBGL,t.TEXTURE_2D,this.selColorTex,0),this.isCameraMoved?m.drawBuffersWEBGL([m.COLOR_ATTACHMENT0_WEBGL,m.COLOR_ATTACHMENT1_WEBGL,m.COLOR_ATTACHMENT2_WEBGL,m.COLOR_ATTACHMENT3_WEBGL,m.COLOR_ATTACHMENT4_WEBGL]):m.drawBuffersWEBGL([m.COLOR_ATTACHMENT0_WEBGL,m.COLOR_ATTACHMENT1_WEBGL,m.COLOR_ATTACHMENT2_WEBGL,m.COLOR_ATTACHMENT3_WEBGL,m.NONE])}}if(i=1,this.renderType=1,t.frontFace(t.CCW),this.renderer.renderGeometryBuffer(t,i,this.visibleObjControlerNodes),this.weatherStation&&this.weatherStation.renderWeather(this),this.isCesiumGlobe()&&(this.bindMainFramebuffer(),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT5_WEBGL,t.TEXTURE_2D,null,0),this.extbuffers.drawBuffersWEBGL([this.extbuffers.COLOR_ATTACHMENT0_WEBGL,this.extbuffers.NONE,this.extbuffers.NONE,this.extbuffers.COLOR_ATTACHMENT3_WEBGL,this.extbuffers.COLOR_ATTACHMENT4_WEBGL,this.extbuffers.NONE])),i=1,this.renderType=1,this.renderer.renderGeometryBufferTransparents(t,i,this.visibleObjControlerNodes),this.renderManagersTransparentPass(),this.magoPolicy.getShowBoundingBox()){var v=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(0),x=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(2),_=this.visibleObjControlerNodes.getOpaquesTransparentsByLod(3);this.renderer.renderBoundingBoxesNodes(v,void 0,!0),this.renderer.renderBoundingBoxesNodes(x,void 0,!0),this.renderer.renderBoundingBoxesNodes(_,void 0,!0),this.renderer.renderBoundingBoxesNodes(this.visibleObjControlerNodes.currentVisiblesAux,void 0,!0)}if(0===this.currentFrustumIdx&&(this.isCameraMoved=!1),this.renderer.renderScreenSpaceObjects(t),this.isCesiumGlobe()&&(this.bindMainFramebuffer(),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT4_WEBGL,t.TEXTURE_2D,null,0),this.extbuffers.drawBuffersWEBGL([this.extbuffers.COLOR_ATTACHMENT0_WEBGL,this.extbuffers.NONE,this.extbuffers.NONE,this.extbuffers.NONE,this.extbuffers.NONE])),o.applyLightsShadows){var y=this.visibleObjControlerNodes.currentVisibleNativeObjects.lightSourcesArray;this.lightSourcesMap||(this.lightSourcesMap={});for(a=y.length,c=0;c<a;c++){var T,C=(T=y[c])._guid;this.lightSourcesMap[C]=T}if(0===this.currentFrustumIdx){for(var b in this.lightSourcesArray||(this.lightSourcesArray=[]),this.lightSourcesArray.length=0,this.lightSourcesMap)this.lightSourcesMap.hasOwnProperty(b)&&this.lightSourcesArray.push(this.lightSourcesMap[b]);this.lightSourcesMap={}}}if(0===this.currentFrustumIdx){if(this.renderer.copyTexture(this.cesiumColorBuffer,this.albedoTex,!0,!0),o.applyLightsShadows){if(!this.texturesManager.lBuffer){h=this.sceneState.drawingBufferWidth[0],f=this.sceneState.drawingBufferHeight[0],g=this.postFxShadersManager.bUseMultiRenderTarget;this.texturesManager.lBuffer=new ae(t,h,f,{matchCanvasSize:!0,multiRenderTarget:g,numColorBuffers:3})}this.lBuffer=this.texturesManager.lBuffer,this.diffuseLightTex=this.lBuffer.colorBuffersArray[0],this.specularLightTex=this.lBuffer.colorBuffersArray[1],this.LightFogTex=this.lBuffer.colorBuffersArray[2],this.renderer.renderLightDepthCubeMaps(this.lightSourcesArray),this.renderer.renderLightBuffer(this.lightSourcesArray)}this.renderer.renderSsaoFromDepth(t),this.renderer.renderScreenQuad(t),o.applyBloomEffect&&this.renderer.renderScreenQuadGaussianBlur(t),this.isCesiumGlobe()&&this.bindMainFramebuffer(),this.renderer.renderScreenQuad2(t),this.renderCluster(),this.selectionManager&&this.selectionManager.existSelectedObjects()&&this.renderer.renderSilhouette()}t.viewport(0,0,this.sceneState.drawingBufferWidth[0],this.sceneState.drawingBufferHeight[0]),this.swapRenderingFase(),t.clearColor(r.red,r.green,r.blue,r.alpha)}else console.error("[MagoJs] Can't found Cesium Globe.");else console.error("[MagoJs] This render mode does not support ORT(One Rendering Target) render mode.");else console.error("[MagoJs] gl is undefined.")},Fe.prototype.bindMagoFbo=function(){var e=this.getGl(),t=this.getTexturesManager();this.depthFboNeo=t.texturesMergerFbo,this.depthTex=this.depthFboNeo.colorBuffersArray[0],this.normalTex=this.depthFboNeo.colorBuffersArray[1],this.albedoTex=this.depthFboNeo.colorBuffersArray[2],this.selColorTex=this.depthFboNeo.colorBuffersArray[3];this.getSelectionFBO();t.texturesMergerFbo.bind(),this.extbuffers||(this.extbuffers=e.getExtension("WEBGL_draw_buffers")),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,this.depthFboNeo.colorBuffersArray[4],0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,this.depthTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,this.normalTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT3_WEBGL,e.TEXTURE_2D,this.albedoTex,0),e.framebufferTexture2D(e.FRAMEBUFFER,this.extbuffers.COLOR_ATTACHMENT4_WEBGL,e.TEXTURE_2D,this.selColorTex,0),this.extbuffers.drawBuffersWEBGL([this.extbuffers.COLOR_ATTACHMENT0_WEBGL,this.extbuffers.COLOR_ATTACHMENT1_WEBGL,this.extbuffers.COLOR_ATTACHMENT2_WEBGL,this.extbuffers.COLOR_ATTACHMENT3_WEBGL,this.extbuffers.COLOR_ATTACHMENT4_WEBGL])},Fe.prototype.addCluster=function(e){if(!e||!e instanceof br)throw new Error("cluster is required.");this.cluster=e},Fe.prototype.clearCluster=function(){this.objMarkerManager&&this.objMarkerManager.setMarkerByCondition(function(e){return!e.tree}),this.cluster=void 0},Fe.prototype.renderCluster=function(){if(this.cluster&&this.cluster.quatTree){var e=this.cluster.quatTree,t=this.sceneState.camera.getPosition(),r=(e.getDisplayPoints(),e.getQuatTreeByCamDistance(void 0,t));r&&r.length>0&&this.cluster.renderFunction.call(this.cluster,r,this)}},Fe.prototype.initCounters=function(){this.processCounterManager.reset()},Fe.prototype.startRender=function(e,t,r){this.numFrustums=r,this.isLastFrustum=e;var i=this.sceneState.camera,o=this.getGl();if(this.upDateSceneStateMatrices(this.sceneState),this.isFarestFrustum()){this.dateSC=new Date,this.prevTime=this.currTime,this.currTime=this.dateSC.getTime();var n=this.currTime-this.prevTime;this.animationTimeController&&this.animationTimeController.incrementCurrentTime(n),this.initCounters(),void 0!==this.animationManager&&this.animationManager.checkAnimation(this),void 0===this.myCameraSCX&&(this.myCameraSCX=new X({name:"cameraSCX"})),this.isCameraMoving||this.mouseLeftDown||this.mouseMiddleDown||(this.upDateCamera(this.myCameraSCX),this.doMultiFrustumCullingSmartTiles(this.myCameraSCX),this.smartTileManager.doPendentProcess(this)),o.clearStencil(0),o.clear(o.STENCIL_BUFFER_BIT),i.doTrack(this),this.sceneState.resetStadistics(),this.clearCanvas2D()}var a=i.position,s=this.frustumVolumeControl.getFrustumVolumeCulling(t);this.myCameraSCX.setCurrentFrustum(t),i.setCurrentFrustum(t);var l=s.visibleNodes;if(!this.isCameraMoving&&!this.mouseLeftDown&&!this.mouseMiddleDown){if(void 0===this.frustumVolumeControl)return;var u=this.myCameraSCX.bigFrustum;this.tilesMultiFrustumCullingFinished(s.intersectedTilesArray,l,a,u),this.prepareNeoBuildingsAsimetricVersion(o,l)}this.visibleObjControlerNodes=l,this.isCameraMoving||this.mouseMiddleDown||this.loadAndPrepareData(),this.doRender(s),0===t&&(this.selectionColor.init(),this.emit("lastFrustum")),this.validateHeight(s),this.drawSelectedExtruionBuildingLabel(),this.magoPolicy.getShowLabelInfo()&&(0===this.currentFrustumIdx&&this.clearCanvas2D(),this.drawBuildingNames(this.visibleObjControlerNodes),this.canvasDirty=!0);this.currentFrustumIdx,this.quantizedMeshManager.status&&this.quantizedMeshManager.excavate()},Fe.getMaximumLevelOfTerrainProvider=function(e){var t=20;if(!(e instanceof Cesium.EllipsoidTerrainProvider)){if(!e._layers||!e._layers[0])return;t=e._layers[0].availability._maximumLevel-1}return t},Fe.prototype.validateHeight=function(e){var t=e.visibleNodes.getAllVisibles();if(this._needValidHeightNodeArray.length>0&&t.length>0){for(var r=this.scene.globe.terrainProvider,i=Fe.getMaximumLevelOfTerrainProvider(r),o=[],n=[],a=this._needValidHeightNodeArray.length-1;a>=0;a--){var s=this._needValidHeightNodeArray[a];t.indexOf(s)>-1&&o.length<10?(this._needValidHeightNodeArray[a].data.validHeightReference=!0,o.push(s)):n.push(s)}if(o.length>0){var l=this;new Promise(function(e){e({mm:l,nArray:o})}).then(function(e){for(var t=[],o=e.nArray,n=o.length,a=0;a<n;a++){var s,l=o[a];s="origin"===l.data.mapping_type?on.pointToGeographicCoord(l.bboxAbsoluteCenterPos):l.getCurrentGeoLocationData().geographicCoord,t.push(Cesium.Cartographic.fromDegrees(s.longitude,s.latitude))}Cesium.sampleTerrain(r,i,t).then(function(t){if(t.length===n){for(var r=0,i=t.length;r<i;r++){var a=o[r],s=a.getCurrentGeoLocationData(),l=s.geographicCoord;a.changeLocationAndRotation(l.latitude,l.longitude,a.caculateHeightByReference(t[r].height),s.heading,s.pitch,s.roll,e.mm)}e.mm.emit(Fe.EVENT_TYPE.VALIDHEIGHTEND,{type:Fe.EVENT_TYPE.VALIDHEIGHTEND,validDataArray:o,timestamp:new Date})}})})}this._needValidHeightNodeArray=n}var u=e.visibleNodes.getAllNatives();if(this._needValidHeightNativeArray.length>0&&u.length>0){for(r=this.scene.globe.terrainProvider,i=Fe.getMaximumLevelOfTerrainProvider(r),o=[],n=[],a=this._needValidHeightNativeArray.length-1;a>=0;a--){var c=this._needValidHeightNativeArray[a];u.indexOf(c)>-1&&o.length<10?o.push(c):n.push(c)}if(o.length>0){l=this;new Promise(function(e){e({mm:l,nArray:o})}).then(function(e){for(var t=[],o=e.nArray,n=o.length,a=0;a<n;a++){var s=o[a].getCurrentGeoLocationData().geographicCoord;t.push(Cesium.Cartographic.fromDegrees(s.longitude,s.latitude))}Cesium.sampleTerrain(r,i,t).then(function(t){if(t.length===n){for(var r=0,i=t.length;r<i;r++){var a=o[r],s=t[r].height;a.setTerrainHeight(s)}e.mm.emit(Fe.EVENT_TYPE.VALIDHEIGHTEND,{type:Fe.EVENT_TYPE.VALIDHEIGHTEND,validDataArray:o,timestamp:new Date})}})})}this._needValidHeightNativeArray=n}},Fe.prototype.clearCanvas2D=function(){if(void 0===this.canvasDirty&&(this.canvasDirty=!0),this.canvasDirty){var e=this.getObjectLabel().getContext("2d");e.clearRect(0,0,e.canvas.width,e.canvas.height),this.canvasDirty=!1}},Fe.prototype.prepareVisibleLowLodNodes=function(e){var t=300,r=!1;if(this.sceneState.camera.lastMovement.movementType!==I.movementType.NO_MOVEMENT&&(r=!0,t=200),!(this.readerWriter.skinLegos_requested>t))for(var i,o,n=e.length,a=0;a<n;a++){var s=(i=e[a]).data.attributes;if("basicF4d"===s.objectType){(o=i.data.neoBuilding).currentLod||(o.currentLod=o.nodeOwner.data.currentLod);var l=o.getLodBuildingData(o.currentLod);if(void 0===l)return!1;l.isModelRef?o.octree&&o.octree.prepareSkinData(this):o.metaData&&o.metaData.fileLoadState===I.fileLoadState.PARSE_FINISHED&&o.prepareSkin(this)}else if("multiBuildingsTile"===s.objectType){var u=i.data.multiBuildings;u&&u.prepareData(this)}if(this.readerWriter.skinLegos_requested>t)return;if(r&&a>t)return}},Fe.prototype.drawStadistics=function(){var e=this.getObjectLabel().getContext("2d");this.isFarestFrustum()&&this.clearCanvas2D();var t=new Kr(130,60),r=this.sceneState;e.font="13px Arial",e.strokeText("Triangles : "+r.trianglesRenderedCount,t.x,t.y),e.fillText("Triangles : "+r.trianglesRenderedCount,t.x,t.y),e.strokeText("Points : "+r.pointsRenderedCount,t.x,t.y+30),e.fillText("Points : "+r.pointsRenderedCount,t.x,t.y+30),e.strokeText("FPS : "+r.fps,t.x,t.y+60),e.fillText("FPS : "+r.fps,t.x,t.y+60),e.restore()},Fe.prototype.drawBuildingNames=function(e){for(var t,r,i,o,n,a=this.getObjectLabel().getContext("2d"),s=this.getGl(),l={},u=e.currentVisibles1.concat(e.currentVisibles2,e.currentVisibles3),c=u.length,d=0;d<c;d++){if(r=(t=u[d]).getRoot(),void 0!==t.data&&void 0!==t.data.neoBuilding)if(!(t.data.distToCam>3e3))l[h=t.data.neoBuilding.buildingId]=r}for(var h in l)if(Object.prototype.hasOwnProperty.call(l,h)){var f=(r=l[h]).data.attributes.label;if(!1===r.data.attributes.isVisible)continue;if(i=r.data.geoLocDataManager.getCurrentGeoLocationData(),o=r.getBBoxCenterPositionWorldCoord(i),n=on.calculateWorldPositionToScreenCoord(s,o.x,o.y,o.z,n,this),isNaN(n.x)||isNaN(n.y))continue;if(f)if(f instanceof Array)for(var g=0,p=f.length;g<p;g++){var m=f[g];a.fillStyle=m.backgroundFillColor,a.strokeStyle=m.backgroundStrokeColor;var v=m.backgroundOffset,x=m.backgroundSize;S(a,n.x+v[0],n.y+v[1],x[0],x[1],10,!0,!0),a.font="13px Arial",a.fillStyle="white",a.strokeStyle="white",a.textAlign="center";var _=m.textOffset;a.fillText(m.text,n.x+_[0],n.y+_[1])}else{a.fillStyle=f.backgroundFillColor,a.strokeStyle=f.backgroundStrokeColor;v=f.backgroundOffset,x=f.backgroundSize;S(a,n.x+v[0],n.y+v[1],x[0],x[1],10,!0,!0),a.font=f.font?f.font:"13px Arial",a.fillStyle="white",a.strokeStyle="white",a.textAlign="center";_=f.textOffset;var y=f.text;if(y.indexOf("\n")>-1)for(var T=y.split("\n"),C=_[1],b=n.y+C,M=0,A=T.length;M<A;M++){var E=T[M];b+=-2*M*C,M>0&&(b+=3),a.fillText(E,n.x+_[0],b)}else a.fillText(y,n.x+_[0],n.y+_[1])}else{var L=r.data.data_name;if(!L||0===L.length)continue;var w=document.elementsFromPoint(n.x,n.y);w.length>0&&"CANVAS"===w[0].nodeName&&n.x>=0&&n.y>=0&&(a.font="13px Arial",a.strokeStyle="MidnightBlue",a.fillStyle="PapayaWhip",a.fillText(L,n.x,n.y),a.strokeText(L,n.x,n.y))}}function S(e,t,r,i,o,n,a,s){if(void 0===s&&(s=!0),void 0===n&&(n=5),"number"==typeof n)n={tl:n,tr:n,br:n,bl:n};else{var l={tl:0,tr:0,br:0,bl:0};for(var u in l)l.hasOwnProperty(u)&&(n[u]=n[u]||l[u])}e.beginPath(),e.moveTo(t+n.tl,r),e.lineTo(t+i-n.tr,r),e.quadraticCurveTo(t+i,r,t+i,r+n.tr),e.lineTo(t+i,r+o-n.br),e.quadraticCurveTo(t+i,r+o,t+i-n.br,r+o),e.lineTo(t+n.bl,r+o),e.quadraticCurveTo(t,r+o,t,r+o-n.bl),e.lineTo(t,r+n.tl),e.quadraticCurveTo(t,r,t+n.tl,r),e.closePath(),a&&e.fill(),s&&e.stroke()}l={},a.restore()},Fe.prototype.drawSelectedExtruionBuildingLabel=function(){var e=this.selectionManager.getSelectedGeneralArray(),t=e.length;if(0!==t){for(var r,i=this.getObjectLabel().getContext("2d"),o=this.getGl(),n=0;n<t;n++){var a=e[n];if(a instanceof to&&!(this.modeler.objectsArray.indexOf(a)<0)){for(var s,l=a.getCenter(),u=!1,c=a.geographicCoordListsArray.length,d=0;d<c;d++){if((h=a.geographicCoordListsArray[d].getGeographicExtent()).intersects2dWithGeoCoord(l)){u=!0;break}}if(u)s=l;else{var h=a.geographicCoordListsArray[Math.floor(c/2)].getGeographicExtent();s=new pe(h.getCenterLongitude(),h.getCenterLatitude(),h.getCenterAltitude())}s.altitude=a.getRealHeight()+2;var f=on.geographicCoordToWorldPoint(s.longitude,s.latitude,s.altitude);if(r=on.calculateWorldPositionToScreenCoord(o,f.x,f.y,f.z,r,this),!isNaN(r.x)&&!isNaN(r.y)&&a.attributes.drawFloorText){i.fillStyle="#FFFFFF",i.strokeStyle="#333333",i.font="normal normal bolder 17px Helvetica";var g=a.getLevel();i.strokeText(g,r.x,r.y),i.fillText(g,r.x,r.y)}}}i.restore(),this.canvasDirty=!0}},Fe.prototype.cameraMoved=function(){this.sceneState.camera.setDirty(!0);var e=this.getSelectionFBO();e&&(e.dirty=!0)},Fe.prototype.TEST__RenderGeoCoords=function(){if(void 0===this.test_geoCoords){this.test_geoCoords=!0;var e=this.modeler.getGeographicCoordsList(),t=e.geographicCoordsArray,r=ve.getRenderableObjectOfGeoCoordsArray(t,this,void 0);this.modeler.addObject(r,12),e.geographicCoordsArray.length=0}},Fe.prototype.TEST__shader=function(){var e=this.sceneState.drawingBufferWidth[0],t=this.sceneState.drawingBufferHeight[0];var r=.0024,i=e/2,o=Math.floor(t/2),n=this.currentFrustumIdx,a=this.getGl();if(this.czm_globeDepthText){if(this.auxFbo||(this.auxFbo=new ae(a,e,t,{matchCanvasSize:!0}),this.auxFbo.setColorBuffer(this.czm_globeDepthText)),this.auxFbo.colorBuffer){this.auxFbo.bind(),a.viewport(0,0,e,t);var s=new Uint8Array(4);a.readPixels(i,t-o,1,1,a.RGBA,a.UNSIGNED_BYTE,s);var l=new Float32Array([s[0]/256,s[1]/256,s[2]/256,s[3]/256]);r=l[0]+l[1]/255+l[2]/65025+l[3]/16581375,this.auxFbo.unbind()}var u=(2*r-0-1)/1,c=this.sceneState.projectionMatrix,d=(Ne.getNearFromPerspectiveMatrix(c),Ne.getFarFromPerspectiveMatrix(c),this.sceneState.getProjectionMatrixInv().transformPoint4D([0,0,u,1],void 0)),h=(new Jr(d[0],d[1],d[2]),new Jr(d[0]/d[3],d[1]/d[3],d[2]/d[3])),f=this.sceneState.camera,g=f.frustumsArray[n],p=f.frustum.tangentOfHalfFovy[0],m=g.far[0],v=f.frustum.aspectRatio[0],x=2*p*m,_=new Jr(0*(x*v),0*x,-m),y=new Jr(_.x,_.y,_.z);y.scale(r);h.x,y.x,h.y,y.y,h.z,y.z;if(this.isCesiumGlobe()){var T=this.scene,C=T.globe,b=T.camera,M=b.frustum._fovy,A=(Math.tan(M/2),new Cesium.Cartesian2(i,o)),E=b.getPickRay(A);return C.pick(E,T)}}},Fe.prototype.TEST__splittedExtrudedBuilding=function(){this.sceneState.sunSystem.setDate(new Date("2020-09-21 03:00"));for(var e=[],t=[[127.00712426088562,37.45156946435559,30.834664859310234],[127.00709259309828,37.45155769732531,30.834664859310234],[127.00667759315165,37.451403491647234,30.834664859310234],[127.0066721789368,37.45139163906972,30.834664859310234],[127.00678678766829,37.451195599739265,30.834664859310234],[127.00687897950189,37.451229856553624,30.834664859310234],[127.00680261381964,37.45136048118296,30.834664859310234],[127.00709721779768,37.45146995002743,30.834664859310234],[127.00731029535426,37.451105474010745,30.834664859310234],[127.007263482357,37.451088079341126,30.834664859310234],[127.00728902455552,37.451044388370505,30.834664859310234],[127.00703247597968,37.45094906015843,30.834664859310234],[127.0069984831344,37.45100720595332,30.834664859310234],[127.00695991629873,37.45099287523322,30.834664859310234],[127.00692076665378,37.4510598417075,30.834664859310234],[127.00682857501259,37.45102558492573,30.834664859310234],[127.00693425300804,37.45084482006482,30.834664859310234],[127.00696707112338,37.450835291596256,30.834664859310234],[127.00741694547875,37.45100245575113,30.834664859310234],[127.00744861308276,37.4510142226956,30.834664859310234],[127.00746056473766,37.45104038622685,30.834664859310234],[127.00715677893419,37.45156002304188,30.834664859310234]],r=t.length,i=0;i<r;i++){var o=t[i],n=new pe(o[0],o[1],0);e.push(n)}var a=[],s=[{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00680258194113,37.45136128526973],[127.00676102778556,37.45143565926792]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00709663714392,37.45147033184358],[127.00705614169294,37.451548940660174]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00731023079707,37.45110560810871],[127.00740630823958,37.45114372147433]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.0072893213812,37.45104420324188],[127.0073323312556,37.4509698292437]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.0070324531775,37.45094918450396],[127.0070754630519,37.45087375180118]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00703205616328,37.45094971385628],[127.00690236484971,37.450898896035454]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[127.00696006425044,37.450993120744904],[127.0068684863025,37.450955536731584]]}}],l=s.length;for(i=0;i<l;i++){var u=s[i].geometry.coordinates,c=new Kr(u[0][0],u[0][1]),d=new Kr(u[1][0],u[1][1]),h=new mi(c,d);a.push(h)}(v=$r.makePolygonByGeographicCoordArray(e)).calculateNormal(void 0);v.normal<0&&v.reverseSense();var f=$r.splitPolygonByMultipleSegments(v,a,f,1e-5),g=f.length,p={},m=[];for(i=0;i<g;i++){for(var v,x=[],_=(r=(v=f[i]).point2dList.getPointsCount(),0);_<r;_++){var y=v.point2dList.getPoint(_);n=new pe(y.x,y.y,0);x.push(n)}var T=new ve(x);m.push(T)}new pe(127.00677393677276,37.4515568669093,0),new pe(127.00670285098234,37.451149160635964,0),new pe(127.00701725187915,37.45116161039015,0),new pe(127.00699905445235,37.4510234587059,0),new pe(127.00676113458148,37.45101249247572,0),new pe(127.0068275878695,37.4507608835301,0),new pe(127.00753105267508,37.45075685056917,0),new pe(127.00746746612433,37.45159376615369,0),new pe(127.00707561793477,37.45181817281961,0),new pe(127.00711848788578,37.45045648607603,0),new pe(127.00838475802502,37.45048859811164,0),new pe(127.00826935498984,37.45181503770476,0),new pe(127.00705650749205,37.451801378084006,0),new pe(127.00704836209083,37.45114871921257,0),new pe(127.00791679734688,37.451123869212154,0),new pe(127.00790742409,37.451849349156944,0);p.color=new J(Math.random(),Math.random(),Math.random(),1),p.renderWireframe=!0,p.wireframeColor4=new J(1,.5,0,1),p.limitationInfringingDynamicColor4=new re(1,.5,1,1);p={doubleFace:!0};var C=(T=m[0]).getExtrudedWallRenderableObject(200,void 0,this,void 0,p,void 0);this.modeler.addObject(C,5)},Fe.prototype.TEST__SelectionBuffer=function(){if(void 0!==this.selectionFbo){var e=this.getGl();this.selectionFbo.bind();var t=new Uint8Array(324),r=500-Math.floor(4.5),i=this.sceneState.drawingBufferHeight[0]-500-Math.floor(4.5);r<0&&(r=0),i<0&&(i=0),e.readPixels(r,i,9,9,e.RGBA,e.UNSIGNED_BYTE,t),e.bindFramebuffer(e.FRAMEBUFFER,null);var o=Math.floor(40.5);this.selectionColor.decodeColor3(t[3*o],t[3*o+1],t[3*o+2]);this.selectionFbo.unbind()}},Fe.prototype.getSelectedObjects=function(e,t,r,i,o){var n=this.selectionManager;if(!n)return i;void 0===o&&(o=!1),this.selectionFbo.bind(),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthRange(0,1),e.disable(e.CULL_FACE);var a=new Uint8Array(4),s=t-Math.floor(.5),l=this.sceneState.drawingBufferHeight[0]-r-Math.floor(.5);s<0&&(s=0),l<0&&(l=0),e.readPixels(s,l,1,1,e.RGBA,e.UNSIGNED_BYTE,a),e.bindFramebuffer(e.FRAMEBUFFER,null);var u=Math.floor(.5),c=this.selectionColor.decodeColor3(a[3*u],a[3*u+1],a[3*u+2]);o?n.selectObjects(c):(n.currentReferenceSelected=n.referencesMap[c],n.currentOctreeSelected=n.octreesMap[c],n.currentBuildingSelected=n.buildingsMap[c],n.currentNodeSelected=n.nodesMap[c]);var d=n.currentReferenceSelected;i[0]=n.currentBuildingSelected,i[1]=n.currentOctreeSelected,i[2]=n.currentReferenceSelected,i[3]=n.currentNodeSelected;var h=n.getSelectionCandidatesFamily("networkEdges");if(h)for(var f=h.currentSelected,g=0;void 0===f&&g<1;){c=this.selectionColor.decodeColor3(a[3*g],a[3*g+1],a[3*g+2]);f=h.selectObject(c),g++}var p=n.getSelectionCandidatesFamily("general");if(p){var m=p.currentSelected;for(g=0;void 0===m&&g<1;){c=this.selectionColor.decodeColor3(a[3*g],a[3*g+1],a[3*g+2]);m=p.selectObject(c),g++}}return void 0===d&&(d=n.selCandidatesMap[c]),n.setSelectedGeneral(n.selCandidatesMap[c]),d},Fe.prototype.calculateSelObjMovePlaneAsimetricMode=function(e,t,r,i){void 0===this.pointSC&&(this.pointSC=new Jr),void 0===this.pointSC2&&(this.pointSC2=new Jr);var o=this.selectionManager.getSelectedF4dNode().getNodeGeoLocDataManager();on.calculatePixelPositionWorldCoord(e,t,r,this.pointSC2,void 0,void 0,void 0,this);var n=o.getCurrentGeoLocationData().getTMatrixInv();return this.pointSC=n.transformPoint3D(this.pointSC2,this.pointSC),void 0===i&&(i=new We),i.setPointAndNormal(this.pointSC.x,this.pointSC.y,this.pointSC.z,0,0,1),i},Fe.prototype.isDragging=function(){if(!this.selectionFbo)return!1;var e=!1,t=this.sceneState.gl;if(this.arrayAuxSC.length=0,!this.selectionFbo)return!1;if(!this.selectionManager)return!1;this.selectionFbo.bind();var i=this.getSelectedObjects(t,this.mouse_x,this.mouse_y,this.arrayAuxSC);if(this.magoPolicy.objectMoveMode===I.moveMode.ALL){this.selectionManager.getSelectedF4dBuilding();var o,n=this.selectionManager.getSelectedF4dNode();n&&(o=n.getRoot()),this.arrayAuxSC.length=0,e=void 0!==o&&o===this.rootNodeSelected}else if(this.magoPolicy.objectMoveMode===I.moveMode.OBJECT)e=void 0!==i&&i===this.selectionManager.getSelectedF4dObject();else if(this.weatherStation){var a=this.selectionManager.getSelectionCandidatesFamily("general");if(a){var s=a.currentSelected;s?s instanceof Mr&&(e=!0):e=!1}else e=!1}return e||(i instanceof r&&(i=i.getRootOwner()),void 0!==i&&i===this.selectionManager.getSelectedGeneral()&&(e=!0)),e||this.selectionManager.clearCandidates(),this.selectionFbo.unbind(),e},Fe.prototype.setCameraMotion=function(e){this.config.isTwoDimension()||this.isCesiumGlobe()&&(this.scene.screenSpaceCameraController.enableRotate=e,this.scene.screenSpaceCameraController.enableZoom=e,this.scene.screenSpaceCameraController.enableLook=e,this.scene.screenSpaceCameraController.enableTilt=e,this.scene.screenSpaceCameraController.enableTranslate=e)},Fe.prototype.mouseActionLeftUp=function(e,t){if(this.magoPolicy.getMagoEnable()){if(this.objectMoved){this.objectMoved=!1;var r=this.selectionManager.currentNodeSelected;if(void 0===r)return;this.saveHistoryObjectMovement(this.selectionManager.getSelectedF4dObject(),r)}var i=on.getComplexCoordinateByScreenCoord(this.getGl(),e,t,void 0,void 0,void 0,this);i&&this.emit(Fe.EVENT_TYPE.LEFTUP,{type:Fe.EVENT_TYPE.LEFTUP,point:i,timestamp:new Date}),this.isCameraMoving=!1,this.mouseLeftDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.selObjMovePlaneCC=void 0,this.startGeoCoordDif=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.setCameraMotion(!0),this.sceneState.mouseAction.clearStartPositionsAux(),this.sceneState.sunSystem&&this.sceneState.applySunShadows&&0===this.currentFrustumIdx&&this.sceneState.sunSystem.updateSun(this)}},Fe.prototype.setBPicking=function(e,t){this.bPicking=!1,this.dateSC=new Date,this.currentTimeSC=this.dateSC.getTime(),this.currentTimeSC-this.startTimeSC<1500&&this.mouse_x===e&&this.mouse_y===t&&(this.bPicking=!0)},Fe.prototype.keyDown=function(e){if(this.magoPolicy.getMagoEnable())if(void 0===this.modeler&&(this.modeler=new jr(this)),32===e){var t=this._settings.getRenderingSettings(),r=t.getPointsCloudInColorRamp();t.setPointsCloudInColorRamp(!r)}else if(37===e)void 0===this.counterAux&&(this.counterAux=-1),-1===this.counterAux?(this.modeler.mode=I.modelerMode.DRAWING_GEOGRAPHICPOINTS,this.counterAux++):0===this.counterAux?(this.modeler.mode=I.modelerMode.DRAWING_BOX,this.counterAux++):1===this.counterAux?(this.modeler.mode=I.modelerMode.DRAWING_TUBE,this.counterAux++):2===this.counterAux?(this.modeler.mode=I.modelerMode.DRAWING_CONCENTRICTUBES,this.counterAux++):3===this.counterAux?(this.modeler.mode=I.modelerMode.DRAWING_BASICFACTORY,this.counterAux++):4===this.counterAux?(this.modeler.mode=I.modelerMode.DRAWING_SPHERE,this.counterAux++):5===this.counterAux?(this.modeler.mode=I.modelerMode.DRAWING_CLIPPINGBOX,this.counterAux++):6===this.counterAux&&(this.modeler.mode=I.modelerMode.DRAWING_FREECONTOURWALL,this.counterAux=0);else if(38===e)this.modeler.mode=I.modelerMode.DRAWING_STATICGEOMETRY;else if(39===e)this.modeler.mode=I.modelerMode.DRAWING_BSPLINE;else if(40===e)this.modeler.mode=I.modelerMode.DRAWING_BASICFACTORY;else if(49===e)void 0===this.pointsCloudWhite&&(this.pointsCloudWhite=!0),this.pointsCloudWhite?this.pointsCloudWhite=!1:this.pointsCloudWhite=!0;else if(80===e){var i=this.hierarchyManager.getNodeByDataKey("AutonomousBus","AutonomousBus_0");i.data.isTrailRender=!0;var o=i.getNodeGeoLocDataManager().getCurrentGeoLocationData().getGeographicCoords(),n=(o.longitude,o.latitude,o.altitude,this.modeler.bSplineCubic3d),a=n.geoCoordsList.geographicCoordsArray,s=new Xr(a);if(void 0!==n){var l={animationType:I.animationType.PATH,path:s,linearVelocityInMetersSecond:30,autoChangeRotation:!0};this.changeLocationAndRotation("AutonomousBus","AutonomousBus_0",void 0,void 0,void 0,45,45,void 0,l)}}else if(83===e)this.sceneState.applySunShadows?this.sceneState.setApplySunShadows(!1):this.sceneState.setApplySunShadows(!0);else if(84===e){if(void 0!==this.modeler){var u=this.modeler.getGeographicCoordsList();if(void 0!==u&&u.getGeoCoordsCount()>0){var c=ve.getRenderableObjectOfGeoCoordsArray(u.geographicCoordsArray,this);this.modeler.addObject(c,15),u.geographicCoordsArray.length=0}}if(void 0===this.smartTile_f4d_tested){this.smartTile_f4d_tested=1;var d=this.readerWriter.geometryDataPath+"/SmartTilesF4D_WorkFolder/smartTile_f4d_indexFile.sii";this.readerWriter.getObjectIndexFileSmartTileF4d(d,"SmartTilesF4D_WorkFolder",this)}}else 87===e||89===e&&(void 0===this.magoMode&&(this.magoMode=I.magoMode.NORMAL),this.magoMode===I.magoMode.NORMAL?this.magoMode=I.magoMode.DRAWING:this.magoMode===I.magoMode.DRAWING&&(this.magoMode=I.magoMode.NORMAL,this.modeler.mode=I.modelerMode.INACTIVE))},Fe.prototype.TEST__golfPark=function(){var e=(r=(t=new pe(126.40310387701689,33.34144078912163,34)).getGeoLocationDataManager()).newGeoLocationData("noName");e=on.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,void 0,void 0,void 0,e,this),(i=new io(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=r,void 0===i.attributes&&(i.attributes={}),i.attributes.isMovable=!0,this.modeler.addObject(i,15);e=(r=(t=new pe(126.39837002777193,33.341987673830694,23.8)).getGeoLocationDataManager()).newGeoLocationData("noName");e=on.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,void 0,void 0,void 0,e,this),(i=new io(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=r,void 0===i.attributes&&(i.attributes={}),i.attributes.isMovable=!0,this.modeler.addObject(i,15);var t,r,i;e=(r=(t=new pe(126.39794580151037,33.341476458307255,18.5)).getGeoLocationDataManager()).newGeoLocationData("noName");e=on.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,void 0,void 0,void 0,e,this),(i=new io(.3,20,{color:{r:.2,g:.5,b:.9,a:.5}})).geoLocDataManager=r,void 0===i.attributes&&(i.attributes={}),i.attributes.isMovable=!0,this.modeler.addObject(i,15)},Fe.prototype.mouseActionLeftClick=function(e,t){if(this.magoPolicy.getMagoEnable()){var r=on.getComplexCoordinateByScreenCoord(this.getGl(),e,t,void 0,void 0,void 0,this);if(r&&this.emit(Fe.EVENT_TYPE.CLICK,{type:Fe.EVENT_TYPE.CLICK,clickCoordinate:r,timestamp:this.getCurrentTime()}),this.selectionManager.getSelectedGeneral()instanceof fr);if(this.magoMode===I.magoMode.DRAWING){var i,o;if(void 0===this.modeler&&(this.modeler=new jr(this)),this.modeler.mode=I.modelerMode.DRAWING_GEOGRAPHICPOINTS,this.configInformation.geo_view_library===F.CESIUM){var n=this.scene.frameState.camera,a=this.scene,s=n.getPickRay(new Cesium.Cartesian2(e,t));o=a.globe.pick(s,a)}else{o=this.sceneState.mouseAction.strWorldPoint}if(void 0===o)return;if((i=Te.CartesianToGeographicWgs84(o.x,o.y,o.z,void 0,!0)).absolutePoint=o,this.modeler.mode===I.modelerMode.DRAWING_GEOGRAPHICPOINTS)i.makeDefaultGeoLocationData(),this.modeler.getGeographicCoordsList().addGeoCoord(i)}}},Fe.prototype.mouseActionLeftDoubleClick=function(e,t){if(this.magoPolicy.getMagoEnable()&&!this.isDragging()){var r=on.getComplexCoordinateByScreenCoord(this.getGl(),e,t,void 0,void 0,void 0,this);r&&this.emit(Fe.EVENT_TYPE.DBCLICK,{type:Fe.EVENT_TYPE.DBCLICK,clickCoordinate:r,timestamp:this.getCurrentTime()})}},Fe.prototype.mouseActionRightClick=function(e,t){if(this.magoPolicy.getMagoEnable()&&!this.isDragging()){var r=on.getComplexCoordinateByScreenCoord(this.getGl(),e,t,void 0,void 0,void 0,this);r&&this.emit(Fe.EVENT_TYPE.RIGHTCLICK,{type:Fe.EVENT_TYPE.RIGHTCLICK,clickCoordinate:r,timestamp:this.getCurrentTime()})}},Fe.prototype.cameraChanged=function(e){this.emit(Fe.EVENT_TYPE.CAMERACHANGED,{type:Fe.EVENT_TYPE.CAMERACHANGED,timestamp:new Date})},Fe.prototype.cameraMoveStart=function(){this.emit(Fe.EVENT_TYPE.CAMERAMOVESTART,{type:Fe.EVENT_TYPE.CAMERAMOVESTART,timestamp:new Date})},Fe.prototype.cameraMoveEnd=function(){this.emit(Fe.EVENT_TYPE.CAMERAMOVEEND,{type:Fe.EVENT_TYPE.CAMERAMOVEEND,timestamp:new Date})},Fe.prototype.mouseActionLeftDown=function(e,t){if(this.magoPolicy.getMagoEnable()){this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=e,this.mouse_y=t,this.mouseLeftDown=!0,zr.updateMouseStartClick(e,t,this);var r=on.getComplexCoordinateByScreenCoord(this.getGl(),e,t,void 0,void 0,void 0,this);r&&this.emit(Fe.EVENT_TYPE.LEFTDOWN,{type:Fe.EVENT_TYPE.LEFTDOWN,point:r,timestamp:new Date}),this.setBPicking(e,t)}},Fe.prototype.saveHistoryObjectMovement=function(e,t){var r=new P,i=r.getReferenceObjectAditionalMovement(),o=r.getReferenceObjectAditionalMovementRelToBuilding();if(void 0===e.moveVector&&(e.moveVector=new Jr),void 0===e.moveVectorRelToBuilding&&(e.moveVectorRelToBuilding=new Jr),i.set(e.moveVector.x,e.moveVector.y,e.moveVector.z),o.set(e.moveVectorRelToBuilding.x,e.moveVectorRelToBuilding.y,e.moveVectorRelToBuilding.z),void 0!==t){var n=t.data.projectId,a=t.data.nodeId,s=e._id;r.setProjectId(n),r.setDataKey(a),r.setObjectIndexOrder(s),this.config.saveMovingHistory(n,a,s,r)}},Fe.prototype.mouseActionMiddleDown=function(e,t){this.magoPolicy.getMagoEnable()&&(this.dateSC=new Date,this.startTimeSC=this.dateSC.getTime(),this.mouse_x=e,this.mouse_y=t,this.mouseMiddleDown=!0,this.isCameraMoving=!0)},Fe.prototype.mouseActionMiddleUp=function(e,t){this.magoPolicy.getMagoEnable()&&(this.isCameraMoving=!1,this.mouseMiddleDown=!1,this.mouseDragging=!1,this.selObjMovePlane=void 0,this.mustCheckIfDragging=!0,this.thereAreStartMovePoint=!1,this.setCameraMotion(!1))},Fe.prototype.mouseActionRightDown=function(e,t){},Fe.prototype.mouseActionRightUp=function(e,t){},Fe.prototype.mouseActionMove=function(e,t){this.mouseLeftDown?e.x===t.x&&e.y===t.y||(this.manageMouseDragging(e.x,e.y),this.cameraMoved()):(this.mouseDragging=!1,this.isCesiumGlobe()&&this.setCameraMotion(!0),(this.mouseMiddleDown||this.mouseRightDown)&&(this.isCameraMoving=!0,this.cameraMoved()));var r=this.getGl(),i=on.getComplexCoordinateByScreenCoord(r,t.x,t.y,void 0,void 0,void 0,this),o=on.getComplexCoordinateByScreenCoord(r,e.x,e.y,void 0,void 0,void 0,this);i&&o&&this.emit(Fe.EVENT_TYPE.MOUSEMOVE,{type:Fe.EVENT_TYPE.MOUSEMOVE,startEvent:i,endEvent:o,timestamp:this.getCurrentTime()})},Fe.prototype.manageMouseDragging=function(e,t){if(this.sceneState.camera.setDirty(!0),this.mouse_x=e,this.mouse_y=t,this.magoPolicy.objectMoveMode===I.moveMode.ALL)if(void 0!==this.selectionManager.getSelectedF4dBuilding()&&this.selectionManager.getSelectedF4dNode()){this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1);var r=this.buildingSelected.nodeOwner;if(void 0===r)return;var i=r.data.geoLocDataManager;if(void 0===i)return;var o=i.getGeoLocationData(0);if(void 0===o)return;var n=o.geographicCoord;if(void 0===n)return;this.emit(Fe.EVENT_TYPE.SELECTEDF4DMOVED,{type:Fe.EVENT_TYPE.SELECTEDF4DMOVED,result:{projectId:r.data.projectId,dataKey:r.data.nodeId,latitude:n.latitude,longitude:n.longitude,altitude:n.altitude,heading:o.heading,pitch:o.pitch,roll:o.roll},timestamp:new Date})}else this.isCameraMoving=!0;else if(this.magoPolicy.objectMoveMode===I.moveMode.OBJECT)void 0!==this.selectionManager.getSelectedF4dObject()&&this.selectionManager.currentOctreeSelected?this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1):this.isCameraMoving=!0;else if(this.magoPolicy.objectMoveMode===I.moveMode.GEOGRAPHICPOINTS){var a=this.selectionManager.getSelectedGeneral();if(a)"GeographicCoord"===a.constructor.name&&this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1)}this.mouseDragging||this.mustCheckIfDragging&&(this.isDragging()&&(this.mouseDragging=!0,this.setCameraMotion(!1)),this.mustCheckIfDragging=!1),this.isCameraMoving=!0,this.mouseDragging&&this.moveSelectedObjectAsimetricMode(this.sceneState.gl)},Fe.prototype.moveSelectedObjectGeneral=function(e,t){if(void 0!==t&&(!(t instanceof He)&&void 0!==(v=(t=t.getRootOwner()).attributes))){var r=v.isMovable;if(void 0!==r&&!1!==r){var i=t.getGeoLocDataManager();if(void 0!==i){var o=i.getCurrentGeoLocationData(),n=this.sceneState.mouseAction;if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new We;var a=o.geoLocMatrix,s=this.sceneState.modelViewMatrix,l=this.sceneState.modelViewRelToEyeMatrix,u=s.transformPoint3D(n.strWorldPoint,void 0);if(v.movementInAxisZ){var c=new Jr(a._floatArrays[4],a._floatArrays[5],a._floatArrays[6]),d=l.transformPoint3D(c,void 0);this.selObjMovePlaneCC.setPointAndNormal(u.x,u.y,u.z,d.x,d.y,d.z)}else{var h=new Jr(a._floatArrays[8],a._floatArrays[9],a._floatArrays[10]),f=l.transformPoint3D(h,void 0);this.selObjMovePlaneCC.setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z)}}void 0===this.lineCC&&(this.lineCC=new Rr);var g=on.getRayCamSpace(this.mouse_x,this.mouse_y,g,this);this.lineCC.setPointAndDir(0,0,0,g[0],g[1],g[2]);var p=new Jr;p=this.selObjMovePlaneCC.intersectionLine(this.lineCC,p);var m=(s=this.sceneState.getModelViewMatrixInv()).transformPoint3D(p,m);if(this.thereAreStartMovePoint){var v,x=(D=on.pointToGeographicCoord(m,D,this)).longitude-this.startGeoCoordDif.longitude,_=D.latitude-this.startGeoCoordDif.latitude,y=D.altitude-this.startGeoCoordDif.altitude;if(void 0!==(v=t.attributes).minAltitude&&y<v.minAltitude&&(y=v.minAltitude),void 0!==v.maxAltitude&&y>v.maxAltitude&&(y=v.maxAltitude),v&&v.movementRestriction){var T=v.movementRestriction;if(T){T.restrictionType;var C=T.element;if(C&&"GeographicCoordSegment"===C.constructor.name){var b=C,M=new pe(x,_,0),A=me.getProjectedCoordToLine(b,M,void 0);if(me.intersectionWithGeoCoord(b,A))x=A.longitude,_=A.latitude;else{var E=me.getNearestGeoCoord(b,A);x=E.longitude,_=E.latitude}}}}if(v&&v.hasStaticModel){var L=v.projectId,w=v.instanceId;if(!Qo(L))return!1;if(!Qo(w))return!1;var S=this.hierarchyManager.getNodeByDataKey(L,w);void 0!==S&&S.changeLocationAndRotation(_,x,0,v.f4dHeading,0,0,this)}o=v.movementInAxisZ?on.calculateGeoLocationData(void 0,void 0,y,void 0,void 0,void 0,o,this):on.calculateGeoLocationData(x,_,void 0,void 0,void 0,void 0,o,this)}else{var D=on.pointToGeographicCoord(m,D,this);this.thereAreStartMovePoint=!0;var R=o.geographicCoord;this.startGeoCoordDif=new pe(D.longitude-R.longitude,D.latitude-R.latitude,D.altitude-R.altitude)}t.moved()}}}},Fe.prototype.moveSelectedObjectAsimetricMode=function(e){if(this.magoPolicy.isModelMovable()){var t=this.selectionManager.getSelectedGeneral(),r="";if(t&&(r=t.constructor.name),this.magoPolicy.objectMoveMode===I.moveMode.ALL){if(void 0===this.selectionManager.getSelectedF4dNode())return;var i=(b=this.selectionManager.getSelectedF4dNode().getNodeGeoLocDataManager()).getCurrentGeoLocationData(),o=this.sceneState.mouseAction,n={};if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new We;var a=i.geoLocMatrix,s=this.sceneState.modelViewMatrix,l=this.sceneState.modelViewRelToEyeMatrix,u=s.transformPoint3D(o.strWorldPoint,void 0);if(n.movementInAxisZ){var c=new Jr(a._floatArrays[4],a._floatArrays[5],a._floatArrays[6]),d=l.transformPoint3D(c,void 0);this.selObjMovePlaneCC.setPointAndNormal(u.x,u.y,u.z,d.x,d.y,d.z)}else{var h=new Jr(a._floatArrays[8],a._floatArrays[9],a._floatArrays[10]),f=l.transformPoint3D(h,void 0);this.selObjMovePlaneCC.setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z)}}void 0===this.lineCC&&(this.lineCC=new Rr);var g=on.getRayCamSpace(this.mouse_x,this.mouse_y,g,this);this.lineCC.setPointAndDir(0,0,0,g[0],g[1],g[2]);var p=new Jr;p=this.selObjMovePlaneCC.intersectionLine(this.lineCC,p);var m=(s=this.sceneState.getModelViewMatrixInv()).transformPoint3D(p,m);if(this.thereAreStartMovePoint){var v=D=(y=on.pointToGeographicCoord(m,y,this)).longitude-this.startGeoCoordDif.longitude,x=R=y.latitude-this.startGeoCoordDif.latitude,_=P=y.altitude-this.startGeoCoordDif.altitude;n.movementInAxisZ?this.changeLocationAndRotationNode(this.selectionManager.getSelectedF4dNode(),void 0,void 0,_,void 0,void 0,void 0):this.changeLocationAndRotationNode(this.selectionManager.getSelectedF4dNode(),x,v,void 0,void 0,void 0,void 0),this.displayLocationAndRotation(this.buildingSelected)}else{var y=on.pointToGeographicCoord(m,y,this);this.thereAreStartMovePoint=!0;var T=i.geographicCoord;this.startGeoCoordDif=new pe(y.longitude-T.longitude,y.latitude-T.latitude,y.altitude-T.altitude)}}else if(this.magoPolicy.objectMoveMode===I.moveMode.OBJECT){var C=this.selectionManager.getSelectedF4dObject();if(void 0===C)return;if("NeoReference"!==C.constructor.name)return;void 0===this.selObjMovePlane&&(this.selObjMovePlane=this.calculateSelObjMovePlaneAsimetricMode(e,this.mouse_x,this.mouse_y,this.selObjMovePlane));var b=this.selectionManager.getSelectedF4dNode().getNodeGeoLocDataManager();void 0===this.lineSC&&(this.lineSC=new Rr),this.lineSC=on.getRayWorldSpace(e,this.mouse_x,this.mouse_y,this.lineSC,this);var M=b.getCurrentGeoLocationData(),A=new Jr,E=new Jr,L=M.getTMatrixInv();A=L.transformPoint3D(this.lineSC.point,A),E=L.rotatePoint3D(this.lineSC.direction,E);var w=new Rr;w.setPointAndDir(A.x,A.y,A.z,E.x,E.y,E.z);var S=new Jr;if(S=this.selObjMovePlane.intersectionLine(w,S),void 0===C.moveVectorRelToBuilding&&(C.moveVectorRelToBuilding=new Jr),this.thereAreStartMovePoint){var D=S.x-this.startMovPoint.x,R=S.y-this.startMovPoint.y,P=S.z-this.startMovPoint.z;C.moveVectorRelToBuilding.set(D,R,P),C.moveVector=M.tMatrix.rotatePoint3D(C.moveVectorRelToBuilding,C.moveVector)}else this.startMovPoint=S,this.startMovPoint.add(-C.moveVectorRelToBuilding.x,-C.moveVectorRelToBuilding.y,-C.moveVectorRelToBuilding.z),this.thereAreStartMovePoint=!0;var F=this.selectionManager.getSelectedF4dNode().data.projectId,O=this.selectionManager.getSelectedF4dNode().data.nodeId,B=C._id;this.config.deleteMovingHistoryObject(F,O,B),this.objectMoved=!0}else if(this.magoPolicy.objectMoveMode===I.moveMode.GEOGRAPHICPOINTS&&"GeographicCoord"===r){if(t){var N;i=(b=t.getGeoLocationDataManager()).getCurrentGeoLocationData();if(this.isCesiumGlobe()){var U=this.scene.frameState.camera,G=this.scene,z=U.getPickRay(new Cesium.Cartesian2(this.mouse_x,this.mouse_y));X=G.globe.pick(z,G),N=Te.CartesianToGeographicWgs84(X.x,X.y,X.z,void 0,!0)}else{X=(o=this.sceneState.mouseAction).strWorldPoint,N=Te.CartesianToGeographicWgs84(X.x,X.y,X.z,void 0,!0)}t.setLonLatAlt(N.longitude,N.latitude,void 0);var H=(b=t.getGeoLocationDataManager()).getCurrentGeoLocationData();H=on.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,void 0,void 0,void 0,H,this);var V=t.owner;if(V){"GeographicCoordsList"===V.constructor.name&&V.makeLines(this);var k=V.owner;k&&("Excavation"===k.constructor.name?k.remakeExtrudeObject(this):"Tunnel"===k.constructor.name&&k.remakeMesh(this))}}}else{if(this.weatherStation){var j=this.selectionManager.getSelectionCandidatesFamily("general");if(j){var W=j.currentSelected;if(W&&W instanceof Mr){var X;i=(b=W.geoLocDataManager).getCurrentGeoLocationData(),o=this.sceneState.mouseAction,g=on.getRayWorldSpace(e,this.mouse_x,this.mouse_y,void 0,this);if(X=o.strWorldPointAux){var Y,q=X.getModul();if(Y=this.globe.intersectionLineWgs84(g,Y,q)){var K=new Jr(Y[0],Y[1],Y[2]),Z=on.pointToGeographicCoord(K,void 0,this),J=o.strLocationAux,Q=i.geographicCoord,$=new pe;$.setLonLatAlt(Z.longitude-J.longitude,Z.latitude-J.latitude,Z.altitude-J.altitude);v=Q.longitude+$.longitude,x=Q.latitude+$.latitude;i=on.calculateGeoLocationData(v,x,void 0,void 0,void 0,void 0,i,this),o.strLocationAux.setLonLatAlt(Z.longitude,Z.latitude,Z.altitude)}}}}}var ee=this.selectionManager.getSelectedGeneral();ee&&this.moveSelectedObjectGeneral(e,ee)}}},Fe.prototype.getRenderablesDetailedNeoBuildingAsimetricVersion=function(e,t,r,i){var o=t.data,n=o.neoBuilding;o.currentLod;if(void 0===n||void 0===n.octree)return!1;var a=n.getLodBuildingData(o.currentLod);if(void 0===a)return!1;if(!a.isModelRef)return!0;var s=t.getNodeGeoLocDataManager(),l=(s.getCurrentGeoLocationData(),s.getCurrentGeoLocationData());if(void 0===l)return!1;void 0===o.currentVisibleOctreesControler&&(o.currentVisibleOctreesControler=new _t);var u=this.magoPolicy.getLod0DistInMeters(),c=this.magoPolicy.getLod1DistInMeters(),d=this.magoPolicy.getLod2DistInMeters(),h=(this.magoPolicy.getLod3DistInMeters(),this.magoPolicy.getLod4DistInMeters(),this.magoPolicy.getLod5DistInMeters()),f=!1;if(void 0===o.myCameraRelative&&(o.myCameraRelative=new X),o.myCameraRelative.frustum.copyParametersFrom(this.myCameraSCX.bigFrustum),o.myCameraRelative=l.getTransformedRelativeCamera(this.sceneState.camera,o.myCameraRelative),o.currentVisibleOctreesControler.clear(),2===i)n.octree.extractLowestOctreesByLOD(o.currentVisibleOctreesControler,r,this.boundingSphere_Aux,o.myCameraRelative.position,u,c,h),f=!0;else{o.myCameraRelative.calculateFrustumsPlanes();var g=o.myCameraRelative.frustum;f=n.octree.getFrustumVisibleLowestOctreesByLOD(g,o.currentVisibleOctreesControler,r,this.boundingSphere_Aux,o.myCameraRelative.position,u,c,100*d)}return f?(this.processQueue.eraseNodeToDeleteModelReferences(t),!0):(o.distToCam>100&&this.processQueue.putNodeToDeleteModelReferences(t,1),!1)},Fe.prototype.manageQueue=function(){var e=this.sceneState.gl;this.processQueue.manageDeleteQueue(this),this.parseQueue.initCounters(),this.parseQueue.parseArrayOctreesLod0References(this.visibleObjControlerOctrees.currentVisibles0,this),this.parseQueue.parseArrayOctreesLod0References(this.visibleObjControlerOctrees.currentVisibles1,this),this.parseQueue.parseArrayOctreesLod0Models(this.visibleObjControlerOctrees.currentVisibles0,this),this.parseQueue.parseArrayOctreesLod0Models(this.visibleObjControlerOctrees.currentVisibles1,this),this.parseQueue.parseArrayOctreesLod2Legos(this.visibleObjControlerOctrees.currentVisibles2,this),this.parseQueue.parseArrayOctreesPCloud(e,this.visibleObjControlerOctrees.currentVisiblesAux,this),this.parseQueue.parseArrayOctreesPCloudPartition(e,this.visibleObjControlerOctrees.currentVisiblesAux,this),this.parseQueue.parseArraySkins(e,this.visibleObjControlerNodes.currentVisibles0,this),this.parseQueue.parseArraySkins(e,this.visibleObjControlerNodes.currentVisibles2,this),this.parseQueue.parseArraySkins(e,this.visibleObjControlerNodes.currentVisibles3,this),this.parseQueue.parseMultiBuildings(e,this.visibleObjControlerNodes.currentVisibles0,this),this.parseQueue.parseMultiBuildings(e,this.visibleObjControlerNodes.currentVisibles2,this),this.parseQueue.parseMultiBuildings(e,this.visibleObjControlerNodes.currentVisibles3,this);var t=0;for(var r in this.parseQueue.tinTerrainsToParseMap){var i;if(Object.prototype.hasOwnProperty.call(this.parseQueue.tinTerrainsToParseMap,r))if(void 0!==(i=this.parseQueue.tinTerrainsToParseMap[r])&&this.parseQueue.eraseTinTerrainToParse(i)&&(i.parseData(i.dataArrayBuffer),t++),t>1)break}},Fe.prototype.prepareVisibleOctreesSortedByDistancePointsCloudType=function(e,t,r){if(!(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)){var i=r,o=t.getAllVisibles();if(void 0!==o)for(var n,a,s,l,u=this.readerWriter.geometryDataPath,c=0,d=o.length;c<d;c++){if(this.fileRequestControler.isFullPlus(i))return;if(void 0!==(l=o[c]).octree_number_name&&(void 0===l.lego&&(l.lego=new Xt,l.lego.fileLoadState=I.fileLoadState.READY,l.lego.legoKey=l.octreeKey+"_lego"),void 0!==(a=l.neoBuildingOwner))){var h=a.metaData.projectDataType;if(void 0!==h&&4===h){if(n=a.projectFolderName,s=a.buildingFileName,l.lego.fileLoadState===I.fileLoadState.READY){var f=u+"/"+n+"/"+s+"/References"+"/"+l.octree_number_name.toString()+"_Ref";this.loadQueue.putLod2PCloudData(l,f,void 0,void 0,0)}if(Object.keys(this.loadQueue.lod2PCloudDataMap).length>5)return}}}}},Fe.prototype.prepareVisibleOctreesSortedByDistance=function(e,t){if(!(this.readerWriter.referencesList_requested>5)){var r,i=[].concat(t.currentVisibles0,t.currentVisibles1);this.thereAreUrgentOctrees=!1;for(var o=0,n=i.length;o<n;o++){var a=(r=i[o]).neoBuildingOwner,s=a.getHeaderVersion();if(!0===a.getLodBuildingData(2).isModelRef&&this.readerWriter.octreesSkinLegos_requested<5&&(void 0!==r.lego&&r.lego.isReadyToRender()||r.prepareSkinData(this)),this.readerWriter.referencesList_requested<5)if(void 0!==r.neoReferencesMotherAndIndices&&r.neoReferencesMotherAndIndices.isReadyToRender()){if("0.0.2"===s){var l=r.neoReferencesMotherAndIndices.blocksList;l&&l.prepareData(this,r)}}else r.prepareModelReferencesListData(this);if(this.readerWriter.referencesList_requested>5)return;0}}},Fe.prototype.prepareVisibleOctreesSortedByDistanceLOD2=function(e,t){if(!(this.readerWriter.octreesSkinLegos_requested>5)&&void 0!==t)for(var r,i=0,o=t.length;i<o;i++){if((r=t[i]).neoBuildingOwner.getLodBuildingData(2).isModelRef&&(r.prepareSkinData(this),this.readerWriter.octreesSkinLegos_requested>5))return}};var Oe=["currentVisibles0","currentVisibles2","currentVisibles3","currentVisibles0Transparents","currentVisibles1Transparents","currentVisibles2Transparents","currentVisibles3Transparents"];function we(){return(we=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}Fe.prototype.checkChangesHistoryMovements=function(e){for(var t=0;t<Oe.length;t++)for(var r,i,o,n,a,s=e[Oe[t]],l=s.length,u=0;u<l;u++)void 0!==(i=(r=s[u]).getRoot())&&(i.getNodeGeoLocDataManager().getCurrentGeoLocationData(),o=r.data.projectId,n=r.data.nodeId,(a=this.config.getMovingHistoryObjects(o,n))&&(r.data.moveHistoryMap=a))},Fe.prototype.checkChangesHistoryColors=function(e){for(var t=0;t<Oe.length;t++){for(var r,i,o=(p=e[s=Oe[t]]).length,n=0;n<o;n++){if(void 0!==(r=p[n]).getRoot())if(f=r.data.projectId,i=r.data.nodeId,l=this.config.getColorHistorys(f,i))(_=r.data).colorChangedHistoryMap=l}var a=this.config.getAllColorHistory();if(a)for(var s in a)if(Object.prototype.hasOwnProperty.call(a,s)){var l=a[s];for(var u in l)if(Object.prototype.hasOwnProperty.call(l,u)){var c=l[u];for(var d in c)if(Object.prototype.hasOwnProperty.call(c,d)){var h=c[d],f=h.projectId,g=this.hierarchyManager.getNodesMap(f)[h.dataKey];if(g&&void 0!==g.data.attributes.isPhysical&&!1===g.data.attributes.isPhysical)if(null===h.property||void 0===h.property||""===h.property){var p=[];g.extractNodes(p);for(o=p.length,n=0;n<o;n++){(_=(x=p[n]).data)&&(_.isColorChanged=!0,void 0===_.aditionalColor&&(_.aditionalColor=new J),_.aditionalColor.setRGBA(h.color[0],h.color[1],h.color[2],h.color[3]))}}else{var m=h.propertyKey,v=h.propertyValue;p=[];g.extractNodes(p);for(o=p.length,n=0;n<o;n++){var x,_;(_=(x=p[n]).data)&&void 0!==x.data.attributes[m]&&x.data.attributes[m].toString()===v&&(_.isColorChanged=!0,void 0===_.aditionalColor&&(_.aditionalColor=new J),_.aditionalColor.setRGBA(h.color[0],h.color[1],h.color[2],h.color[3]))}}}}}}},Fe.prototype.checkPropertyFilters=function(e){if(void 0!==this.propertyFilterSC){var t=e.length;if(0!==t)for(var r,i=this.propertyFilterSC.propertyKey,o=this.propertyFilterSC.propertyValue,n=this.propertyFilterSC.visible,a=0;a<t;a++)(r=e[a]).data.projectId===this.propertyFilterSC.projectId&&r.data.attributes&&(void 0!==r.data.attributes[i]&&r.data.attributes[i].toString()===o?!0===n||(e.splice(a,1),a--,t=e.length):!0===n&&(e.splice(a,1),a--,t=e.length))}},Fe.prototype.getObjectLabel=function(){if(void 0===this.canvasObjectLabel){this.canvasObjectLabel=document.createElement("canvas");var e=document.getElementById(this.config.getContainerId()),t=e.offsetLeft,r=e.offsetTop;t.toString(),r.toString(),e.offsetWidth,e.offsetHeight;this.canvasObjectLabel.className="mago3d-object-label",this.canvasObjectLabel.width=this.sceneState.drawingBufferWidth,this.canvasObjectLabel.height=this.sceneState.drawingBufferHeight,this.canvasObjectLabel.style.left="0",this.canvasObjectLabel.style.top="0",this.canvasObjectLabel.style.width="100%",this.canvasObjectLabel.style.height="100%",this.canvasObjectLabel.style.position="absolute",this.canvasObjectLabel.style.opacity=1,this.canvasObjectLabel.style.backgroundColor="transparent",this.canvasObjectLabel.style.pointerEvents="none";var i=this.canvasObjectLabel.getContext("2d");i.strokeStyle="DarkSlateGray",i.fillStyle="PapayaWhip",i.lineWidth=4,i.font="20px Arial",i.textAlign="center",i.fillRect(0,0,i.canvas.width,i.canvas.height),i.save(),i.clearRect(0,0,i.canvas.width,i.canvas.height);i.measureText("M").width;(this.isCesiumGlobe()?e.getElementsByClassName("cesium-viewer")[0]:e).appendChild(this.canvasObjectLabel)}return this.canvasObjectLabel},Fe.prototype.drawCCTVNames=function(e){var t=this.getObjectLabel().getContext("2d");t.clearRect(0,0,t.canvas.width,t.canvas.height);for(var r,i,o,n=this.sceneState.gl,a=e.length,s=0;s<a;s++)r=(o=e[s]).geoLocationData.position,(i=on.calculateWorldPositionToScreenCoord(n,r.x,r.y,r.z,i,this)).x>=0&&i.y>=0&&(t.font="13px Arial",t.strokeText(o.name,i.x,i.y),t.fillText(o.name,i.x,i.y));t.restore()},Fe.prototype.setRenderCondition=function(e,t,r){if(!r||"function"!=typeof r)throw new Error("renderCondition is required.");if(!e)throw new Error("projectId is required.");if(!this.hierarchyManager.existProject(e))throw new Error(e+" project is not exist.");var i=this.hierarchyManager.getNodesMap(e);if(t)n(i[t],r);else for(var o in i)i.hasOwnProperty(o)&&n(i[o],r);function n(e,t){e instanceof lr&&e.data.attributes.isPhysical&&e.setRenderCondition(t)}},Fe.prototype.createDefaultShaders=function(e){e.getParameter(e.VERSION);this.isCesiumGlobe()||(e.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&e.getExtension("EXT_frag_depth"),this.EXTENSIONS_init=!0,this.postFxShadersManager.bUseLogarithmicDepth=!0);this.postFxShadersManager.bUseMultiRenderTarget=!1,e.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1&&(this.extbuffers=e.getExtension("WEBGL_draw_buffers"),this.postFxShadersManager.bUseMultiRenderTarget=!0),window.navigator.userAgent.indexOf("Trident")>-1&&(this.postFxShadersManager.bUseLogarithmicDepth=!1),this.postFxShadersManager.bUseUint32ForIndices=!1,e.getExtension("OES_element_index_uint")&&(this.postFxShadersManager.bUseUint32ForIndices=!0)},Fe.prototype.isFarestFrustum=function(){return this.numFrustums-this.currentFrustumIdx-1==0},Fe.prototype.doMultiFrustumCullingSmartTiles=function(e){var t=this.myCameraSCX.bigFrustum,r=this.smartTileManager.tilesArray[0],i=this.smartTileManager.tilesArray[1];void 0===this.intersectedTilesArray&&(this.intersectedTilesArray=[]),void 0===this.lastIntersectedLowestTilesArray&&(this.lastIntersectedLowestTilesArray=[]),this.lastIntersectedLowestTilesArray=this.intersectedTilesArray,this.intersectedTilesArray=[];for(var o=this.lastIntersectedLowestTilesArray.length,n=0;n<o;n++)(u=this.lastIntersectedLowestTilesArray[n]).isVisible=!1;r.getFrustumIntersectedLowestTiles(e,t,this.intersectedTilesArray,5e3),i.getFrustumIntersectedLowestTiles(e,t,this.intersectedTilesArray,5e3),this.frustumVolumeControl.initArrays();var a=this.myCameraSCX.frustumsArray.length,s=this.intersectedTilesArray.length;for(n=0;n<s;n++)if(void 0!==(u=this.intersectedTilesArray[n]).sphereExtent){this.processQueue.eraseSmartTileToDelete(u),u.isVisible=!0;for(var l=a-1;l>=0;l--){if(this.myCameraSCX.frustumsArray[l].intersectionNearFarSphere(u.sphereExtent)!==F.INTERSECTION_OUTSIDE)this.frustumVolumeControl.getFrustumVolumeCulling(l).intersectedTilesArray.push(u)}}var u;for(o=this.lastIntersectedLowestTilesArray.length,n=0;n<o;n++)(u=this.lastIntersectedLowestTilesArray[n]).isVisible||this.processQueue.putSmartTileToDelete(u,0);this.lastIntersectedLowestTilesArray.length=0,void 0!==this.tinTerrainManager&&this.tinTerrainManager.ready&&this.tinTerrainManager.doFrustumCulling(t,e,this)},Fe.prototype.tilesMultiFrustumCullingFinished=function(e,t,r,i){var o=e.length;if(0!==o){var n,a,s,l,u,c=this.magoPolicy;void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new Je);for(var d=c.getFrustumFarDistance(),h=!1,f=0;f<o;f++)if(void 0!==(a=e[f]).sphereExtent){if(n=r.distToSphere(a.sphereExtent),h=a.intersectionType!==F.INTERSECTION_INSIDE,a.nodesArray&&a.nodesArray.length>0)for(var g=a.nodesArray.length,p=0;p<g;p++){u=(l=a.nodesArray[p]).getRoot();var m=l.data;if(m&&(!m.attributes||void 0===m.attributes.isVisible||!1!==m.attributes.isVisible))if(void 0!==(s=l.data.neoBuilding))if(s.headerDataArrayBuffer&&void 0!==s.metaData&&s.metaData.fileLoadState!==I.fileLoadState.PARSE_FINISHED&&s.metaData.parseFileHeaderAsimetricVersion(s.headerDataArrayBuffer,0),void 0===s.metaData||s.metaData.fileLoadState===I.fileLoadState.PARSE_FINISHED)if(void 0!==u.data.geoLocDataManager){n=l.getDistToCamera(r,this.boundingSphere_Aux);var v=c.getLod(n);if(m.distToCam=n,m.currentLod=c.getLod(m.distToCam),!(n>d)){if(h)if(i.intersectionSphere(this.boundingSphere_Aux)===F.INTERSECTION_OUTSIDE)continue;var x=s.getHeaderVersion();if(void 0!==x)if("v"===x[0])t.putNodeByLod(l,v);else{var _=s.metaData.projectDataType;!_||4!==_&&5!==_?(10===_&&n<1500&&t.putNodeByProjectType(l),t.putNodeByLod(l,v)):t.putNodeToArraySortedByDist(t.currentVisiblesAux,l)}}}else l.calculateGeoLocData(this);else t.currentVisiblesToPrepare.push(l);else t.currentVisiblesToPrepare.push(l)}var y=t.currentVisibleNativeObjects,T=a.nativeObjects,C=T.generalObjectsArray.length;for(p=0;p<C;p++){if((b=T.generalObjectsArray[p]).attributes._deleted)a.deleteNativeObjectByGuid(b._guid,this);else this.boundingSphere_Aux=b.getBoundingSphereWC(this.boundingSphere_Aux),i.intersectionSphere(this.boundingSphere_Aux)!==F.INTERSECTION_OUTSIDE&&(b.isOpaque()?y.opaquesArray.push(b):y.transparentsArray.push(b))}C=T.excavationsArray.length;for(p=0;p<C;p++){var b=T.excavationsArray[p];this.boundingSphere_Aux=b.getBoundingSphereWC(this.boundingSphere_Aux),i.intersectionSphere(this.boundingSphere_Aux)!==F.INTERSECTION_OUTSIDE&&y.excavationsArray.push(b)}C=T.vectorTypeArray.length;for(p=0;p<C;p++){b=T.vectorTypeArray[p];this.boundingSphere_Aux=b.getBoundingSphereWC(this.boundingSphere_Aux),i.intersectionSphere(this.boundingSphere_Aux)!==F.INTERSECTION_OUTSIDE&&y.vectorTypeArray.push(b)}C=T.lightSourcesArray.length;for(p=0;p<C;p++){b=T.lightSourcesArray[p];this.boundingSphere_Aux=b.getBoundingSphereWC(this.boundingSphere_Aux),i.intersectionSphere(this.boundingSphere_Aux)!==F.INTERSECTION_OUTSIDE&&y.lightSourcesArray.push(b)}var M=a.mgSetArray;if(M){var A=M.length;for(p=0;p<A;p++)t.mgSetsArray.push(M[p])}T.pointTypeArray&&Array.prototype.push.apply(y.pointTypeArray,T.pointTypeArray),C=T.nativeSeedArray.length;for(p=0;p<C;p++){var E=T.nativeSeedArray[p];this.koreaBuildingMaster[E.masterId].show&&E.status===Ee.STATUS.UNLOAD&&E.load()}a.isNeededToCreateGeometriesFromSeeds()&&a.createGeometriesFromSeeds(this)}}},Fe.prototype.flyToTopology=function(e,t){this.isCesiumGlobe()&&this.scene.camera.flyTo({destination:Cesium.Cartesian3.clone(e),orientation:{direction:new Cesium.Cartesian3(this.scene.camera.direction.x,this.scene.camera.direction.y,this.scene.camera.direction.z),up:new Cesium.Cartesian3(this.scene.camera.up.x,this.scene.camera.up.y,this.scene.camera.up.z)},duration:parseInt(t)})},Fe.prototype.flyTo=function(e,t,r,i){this.isCesiumGlobe()&&this.scene.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(e),parseFloat(t),parseFloat(r)),duration:parseInt(i)})},Fe.prototype.flyToBox=function(e){var t=new G;if(t.init(e[0]),t.addPoint(e[1]),this.boundingSphere_Aux=new Je,this.boundingSphere_Aux.radius=t.getRadiusAprox(),this.isCesiumGlobe()){var r=t.getCenterPoint();this.boundingSphere_Aux.center=Cesium.Cartesian3.clone({x:r.x,y:r.y,z:r.z});this.scene.camera.flyToBoundingSphere(this.boundingSphere_Aux,{duration:3})}},Fe.prototype.flyToBuilding=function(e,t,r){var i=this.hierarchyManager.getNodeByDataName(t,"nodeId",r);if(void 0!==i){var o,n=i.getRoot(),a=n.data.geoLocDataManager;if(void 0!==a||void 0!==(o=i.calculateGeoLocData(this))){o=(a=n.data.geoLocDataManager).getCurrentGeoLocationData();var s=i.getBBoxCenterPositionWorldCoord(o);if(void 0!==s&&n.data.bbox&&(this.radiusAprox_aux=n.data.bbox.getRadiusAprox(),void 0===this.boundingSphere_Aux&&(this.boundingSphere_Aux=new Je),this.boundingSphere_Aux.radius=this.radiusAprox_aux,this.isCesiumGlobe())){this.boundingSphere_Aux.center=Cesium.Cartesian3.clone(s);this.scene.camera.flyToBoundingSphere(this.boundingSphere_Aux,3)}}else apiResultCallback(this.config.getPolicy().geo_callback_apiresult,e,"-1")}else apiResultCallback(this.config.getPolicy().geo_callback_apiresult,e,"-1")},Fe.prototype.displayLocationAndRotation=function(e){var t=e.nodeOwner.getNodeGeoLocDataManager();if(void 0!==t){var r=t.getCurrentGeoLocationData();r.geographicCoord.latitude,r.geographicCoord.longitude,r.geographicCoord.altitude,r.heading,r.pitch,r.roll,e.buildingId.split("_")}},Fe.prototype.selectedObjectNotice=function(e){if(void 0!==e){var t=e.nodeOwner,r=t.getNodeGeoLocDataManager();if(void 0!==r){var i=r.getCurrentGeoLocationData(),o=t.data.nodeId,n=t.data.projectId;if("true"===this.config.getPolicy().geo_callback_enable){var a=null,s=this.selectionManager.getSelectedF4dObject();void 0!==s&&(a=s.objectId),this.magoPolicy.getObjectInfoViewEnable()&&selectedObjectCallback(this.config.getPolicy().geo_callback_selectedobject,n,o,a,i.geographicCoord.latitude,i.geographicCoord.longitude,i.geographicCoord.altitude,i.heading,i.pitch,i.roll),this.magoPolicy.getIssueInsertEnable()&&insertIssueCallback(this.config.getPolicy().geo_callback_insertissue,n,o,a,i.geographicCoord.latitude,i.geographicCoord.longitude,parseFloat(i.geographicCoord.altitude))}}}},Fe.prototype.changeLocationAndRotation=function(e,t,r,i,o,n,a,s,l){var u=this.hierarchyManager.getNodeByDataKey(e,t);void 0!==u&&this.changeLocationAndRotationNode(u,r,i,o,n,a,s,l)},Fe.prototype.changeLocationAndRotationNode=function(e,t,r,i,o,n,a,s){if(void 0!==e){void 0!==s?(void 0===this.animationManager&&(this.animationManager=new U),this.animationManager.putNode(e),e.changeLocationAndRotationAnimated(t,r,i,o,n,a,this,s)):e.changeLocationAndRotation(t,r,i,o,n,a,this);e.data.neoBuilding}},Fe.prototype.getObjectIndexFile=function(e,t){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var r=t,i=this.readerWriter.geometryDataPath+"/"+r+F.OBJECT_INDEX_FILE+F.CACHE_VERSION+(new Date).getTime();this.readerWriter.getObjectIndexFileForSmartTile(i,this,void 0,e)},Fe.prototype.getObjectIndexFileForData=function(e,t){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var r=this.config.getData(I.PROJECT_ID_PREFIX+e),i=this.hierarchyManager.getNodeByDataKey(e,r.dataGroupKey).data.projectFolderName;i=i.replace(/\/+$/,"");var o=[],n=r.children;if(Array.isArray(t))for(var a=0,s=t.length;a<s;a++)c(n,o,t[a]);else c(n,o,t);var l=i,u=this.readerWriter.geometryDataPath+"/"+l+F.OBJECT_INDEX_FILE+F.CACHE_VERSION+this.config.getPolicy().content_cache_version;function c(e,r,o){var n=o.metainfo;if(n&&"object"!==H(n)&&(n=JSON.parse(n)),!(o.attributes||n).isPhysical)throw new Error("f4d member must isPhysical true.");o.groupDataFolder=i;var a=o.data_key||o.dataKey;r.push(a),e.push(t)}this.readerWriter.getObjectIndexFileForData(u,this,e,o,t)},Fe.prototype.getObjectIndexFileSmartTileF4d=function(e){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var t=e,r=this.readerWriter.geometryDataPath+"/"+t+F.TILE_INDEX_FILE;this.readerWriter.getObjectIndexFileSmartTileF4d(r,t,this)},Fe.prototype.getObjectIndexFileSmartTileF4dAndDeleteTile=function(e){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var t=e,r=this.readerWriter.geometryDataPath+"/"+t+F.TILE_INDEX_FILE;this.readerWriter.getObjectIndexFileSmartTileF4dAndDeleteTile(r,t,this)},Fe.prototype.getObjectIndexFileSmartTileF4d=function(e){void 0===this.configInformation&&(this.configInformation=this.config.getPolicy());var t=e,r=this.readerWriter.geometryDataPath+"/"+t+F.TILE_INDEX_FILE;this.readerWriter.getObjectIndexFileSmartTileF4d(r,t,this)},Fe.prototype.makeNode=function(e,t,r,i,o){var n,a,s,l,u,c,d=void 0,h=void 0,f=void 0,g=void 0,p=void 0,m=void 0,v=void 0,x=void 0,_=void 0,y=void 0,T=void 0,C=void 0,b=void 0,M=void 0;if(void 0!==e){if(e.data_key)f=e.data_group_id,e.data_group_name,g=e.data_id,p=e.data_key,m=e.data_name,v=e.heading,x=e.height,_=e.latitude,y=e.longitude,T=e.pitch,C=e.roll,b=e.mapping_type,M=e.label;else{e.childrenCnt=e.children;var A=e.metainfo;A&&"string"==typeof A&&(A=JSON.parse(A)),e.attributes=e.attributes||A,e.attributes||(e.attributes={isPhysical:!1}),e.children=e.datas,delete e.datas,f=e.dataGroupId,e.dataGroupName,g=e.dataId,p=e.dataKey||e.dataGroupKey,m=e.dataName||e.dataGroupName,v=e.heading,x=e.altitude,_=e.latitude,y=e.longitude,T=e.pitch,C=e.roll,b=e.mappingType||"origin",M=e.label}d=e.attributes,h=e.children}if(void 0===v&&(v=0),void 0===T&&(T=0),void 0===C&&(C=0),void 0!==d&&!d.isReference){d.objectType="basicF4d",n=p;var E,L=(s=this.hierarchyManager.newNode(n,o,d)).data,w=d.relativePath;if(i=w&&w.length>0?i+w:i,L.projectFolderName=i,L.projectId=o,L.data_name=m,L.attributes=d,L.mapping_type=b,L.dataId=g,L.dataGroupId=f,d.isPhysical&&((a=r instanceof W?r.getBuildingSeed(n):r[n])&&(L.buildingSeed=a,t.push(s)),d.hasOwnProperty("heightReference")&&d.heightReference||(d.heightReference=Ce.NONE),M&&(d.label=M),d.fromDate=new Date,d.toDate=new Date),y&&_&&(void 0!==x&&null!==x||(x=0),d.heightReference===Ce.RELATIVE_TO_GROUND?L.relativeHeight=x:L.relativeHeight=0,L.geographicCoord=new pe,L.geographicCoord.setLonLatAlt(y,_,x),void 0===L.rotationsDegree&&(L.rotationsDegree=new Jr),L.rotationsDegree.set(T,C,v),void 0!==a)){void 0===a.geographicCoord&&(a.geographicCoord=new pe),void 0===a.rotationsDegree&&(a.rotationsDegree=new Jr),a.geographicCoord.setLonLatAlt(y,_,x),a.rotationsDegree.set(T,C,v),void 0===a.geographicCoordOfBBox&&(a.geographicCoordOfBBox=new pe);var S,D=on.geographicCoordToWorldPoint(y,_,x,D,this);E=on.calculateTransformMatrixAtWorldPosition(D,v,T,C,void 0,E,this),S=a.bBox.getCenterPoint(S);var R=E.transformPoint3D(S,R);a.geographicCoordOfBBox=on.pointToGeographicCoord(R,a.geographicCoordOfBBox,this),a.geographicCoordOfBBox.altitude=a.geographicCoord.altitude}if(L.bbox=new G,L.buildingSeed&&L.buildingSeed.bBox&&L.bbox.copyFrom(a.bBox),void 0!==E)if("origin"===L.mapping_type.toLowerCase()){S=L.bbox.getCenterPoint(S);R=E.transformPoint3D(S,R);L.bbox.geographicCoord=on.pointToGeographicCoord(R,L.bbox.geographicCoord,this)}else"boundingboxcenter"===L.mapping_type.toLowerCase()&&(L.bbox.geographicCoord=new pe,L.bbox.geographicCoord.setLonLatAlt(y,_,x));if(void 0!==h){c=h.length;for(var P=0;P<c;P++)l=h[P],void 0===(u=this.makeNode(l,t,r,i,o)).data.geographicCoord&&s.addChildren(u)}}return s},Fe.prototype.calculateBoundingBoxesNodes=function(e){var t,r,i,o,n,a,s,l,u,c=this.hierarchyManager.getNodesMap(e);for(var d in c)if(Object.prototype.hasOwnProperty.call(c,d)){if(void 0===(t=c[d]).data)continue;if(i=t.data.buildingSeed){o=(r=t.getClosestParentWithData("geographicCoord")).data.geographicCoord.longitude,n=r.data.geographicCoord.latitude,a=r.data.geographicCoord.altitude,s=r.data.rotationsDegree.z,l=r.data.rotationsDegree.x,u=r.data.rotationsDegree.y,void 0===i.geographicCoord&&(i.geographicCoord=new pe),void 0===i.rotationsDegree&&(i.rotationsDegree=new Jr),i.geographicCoord.setLonLatAlt(o,n,a),i.rotationsDegree.set(l,u,s),void 0===i.geographicCoordOfBBox&&(i.geographicCoordOfBBox=new pe);var h=on.geographicCoordToWorldPoint(o,n,a,h,this),f=on.calculateTransformMatrixAtWorldPosition(h,s,l,u,void 0,f,this);i.geographicCoordOfBBox.setLonLatAlt(o,n,a)}}var g=[],p=[];this.hierarchyManager.getRootNodes(e,g);for(var m=!1,v=g.length,x=0;x<v;x++){r=g[x],p.length=0,r.extractNodesByDataName(p,"buildingSeed"),m=!1;for(var _=p.length,y=0;y<_;y++){var T=(t=p[y]).data.bbox;T&&(t.data.attributes?(t.data.attributes.isMain,!1===m?(r.data.bbox.copyFrom(T),m=!0):r.data.bbox.addBox(T)):!1===m?(r.data.bbox.copyFrom(T),m=!0):r.data.bbox.addBox(T))}}},Fe.prototype.makeSmartTile=function(e,t,r,i){if(!e&&!i)throw new Error("buildingSeedMap or seedMap is required");var o=r||this.config.getData(I.PROJECT_ID_PREFIX+t),n=[],a=function(e){var t,r=Array.isArray(e)?e[0]:e;t=r.data_key?r.groupDataFolder||r.data_key:r.dataGroupPath?(t=r.dataGroupPath).replace(/\/+$/,""):r.groupDataFolder;return t}(o);if(Array.isArray(o))for(var s=0,l=o.length;s<l;s++){var u=o[s];this.makeNode(u,n,e,a,t)}else this.makeNode(o,n,e,a,t);this.calculateBoundingBoxesNodes(t);var c=JSON.parse(JSON.stringify(n)),d=[],h=n.length;for(s=0;s<h;s++){var f=n[s],g=f.data.bbox.getMaxLength(),p=Ze.getDepthByBoundingBoxMaxSize(g);void 0===d[p]&&(d[p]=[]),d[p].push(f)}for(s=0;s<22;s++)if(d[s]&&d[s].length>0){var m=s;this.smartTileManager.makeTreeByDepth(m,d[s],this)}this.emit(Fe.EVENT_TYPE.F4DLOADEND,{type:Fe.EVENT_TYPE.F4DLOADEND,f4d:c,timestamp:new Date})},Fe.prototype.instantiateStaticModel=function(e){if(!Qo(e.projectId))throw new Error("projectId is required.");if(!this.isExistStaticModel(e.projectId))throw new Error("static model is not exist.");if(!Qo(e.instanceId))throw new Error("instanceId is required.");if(!Qo(e.longitude))throw new Error("longitude is required.");if(!Qo(e.latitude))throw new Error("latitude is required.");e.isReference||(e.isReference=!0),e.isPhysical||(e.isPhysical=!0),e.nodeType||(e.nodeType="TEST"),e.heightReference||(e.heightReference=Ce.NONE),e.objectType="basicF4d";var t=e.projectId,r=e.instanceId,i=e.longitude,o=e.latitude,n=parseFloat(Jo(e.height,0)),a=parseFloat(Jo(e.heading,0)),s=parseFloat(Jo(e.pitch,0)),l=parseFloat(Jo(e.roll,0)),u=this.hierarchyManager.getNodeByDataKey(t,r);if(void 0===u){u=this.hierarchyManager.newNode(r,t,void 0);var c=new pe;c.latitude=parseFloat(o),c.longitude=parseFloat(i),c.altitude=parseFloat(n);var d=c.getGeoLocationDataManager(),h=d.newGeoLocationData("noName");h=on.calculateGeoLocationData(c.longitude,c.latitude,c.altitude,a,s,l,h,this),u.data.projectId=t,u.data.attributes=e,u.data.geographicCoord=c,u.data.rotationsDegree=new Jr(s,l,a),u.data.geoLocDataManager=d,e.heightReference===Ce.RELATIVE_TO_GROUND?u.data.relativeHeight=c.altitude:u.data.relativeHeight=0,u.data.attributes.fromDate=new Date,u.data.attributes.toDate=new Date;this.smartTileManager.putNode(12,u,this)}else this.changeLocationAndRotation(t,r,o,i,n,a,s,l)},Fe.prototype.addStaticModel=function(e){if(!Qo(e.projectId))throw new Error("projectId is required.");if(!Qo(e.projectFolderName))throw new Error("projectFolderName is required.");if(!Qo(e.buildingFolderName))throw new Error("buildingFolderName is required.");var t=e.projectId,r=this.hierarchyManager.getStaticModelsManager(),i=new yi;i.guid=t,i.projectFolderName=e.projectFolderName,i.buildingFolderName=e.buildingFolderName,i.neoBuilding=new rr,r.addStaticModel(t,i)},Fe.prototype.isExistStaticModel=function(e){var t=!1;return this.hierarchyManager.staticModelsManager&&this.hierarchyManager.staticModelsManager.staticModelsMap?(this.hierarchyManager.staticModelsManager.staticModelsMap.hasOwnProperty(e)&&(t=!0),t):t},Fe.prototype.addLayer=function(e){if(!e)throw new Error("layer is empty");var t;e instanceof ot?this.tinTerrainManager.addImageryLayer(e):((t=e)instanceof Pe||t.hasOwnProperty(dataGroupId)&&t.hasOwnProperty(dataGroupKey)&&t.hasOwnProperty(dataGroupPath))&&(this.magoLayerCollection||(this.magoLayerCollection=new Ie),this.magoLayerCollection.add(e))},Fe.prototype.getLayerById=function(e){},Fe.prototype.removeLayerById=function(e){this.tinTerrainManager.imagerys=this.tinTerrainManager.imagerys.filter(function(t,r){return t._id!==e}),this.tinTerrainManager.addDeleteTextureId(e)},Fe.prototype.removeLayer=function(e){var t;this.tinTerrainManager.imagerys=this.tinTerrainManager.imagerys.filter(function(r,i){return r===e&&(t=r._id),r!==e}),this.tinTerrainManager.addDeleteTextureId(t)},Fe.prototype.callAPI=function(e){var t=e.getAPIName();if("changeMagoState"===t)this.magoPolicy.setMagoEnable(e.getMagoEnable());else{if("searchData"===t)return this.flyToBuilding(t,e.getProjectId(),e.getDataKey());if("changeColor"===t)o.changeColor(e,this);else if("show"===t)this.magoPolicy.setHideBuildings.length=0;else if("hide"===t)this.magoPolicy.setHideBuildings(e.gethideBuilds());else if("changeOutFitting"===t)this.magoPolicy.setShowOutFitting(e.getShowOutFitting());else if("changeLabel"===t){this.magoPolicy.setShowLabelInfo(e.getShowLabelInfo());var r=this.getObjectLabel().getContext("2d");r.clearRect(0,0,r.canvas.width,r.canvas.height)}else if("changeOrigin"===t)this.magoPolicy.setShowOrigin(e.getShowOrigin());else if("changeBoundingBox"===t)this.magoPolicy.setShowBoundingBox(e.getShowBoundingBox());else if("changeShadow"===t)this.sceneState.setApplySunShadows(e.getShowShadow());else if("changefrustumFarDistance"===t)this.magoPolicy.setFrustumFarSquaredDistance(e.getFrustumFarDistance()*e.getFrustumFarDistance());else if("changeLocationAndRotation"===t)a.changeLocationAndRotation(e,this);else if("changeObjectMove"===t){var i=e.getObjectMoveMode();i!==I.moveMode.GEOGRAPHICPOINTS&&i!==I.moveMode.NONE||(this.emit(Fe.EVENT_TYPE.DESELECTEDF4D,{type:Fe.EVENT_TYPE.DESELECTEDF4D}),this.emit(Fe.EVENT_TYPE.DESELECTEDF4DOBJECT,{type:Fe.EVENT_TYPE.DESELECTEDF4DOBJECT})),this.magoPolicy.setObjectMoveMode(i)}else if("deleteAllObjectMove"===t){var l=this.config.getAllMovingHistory();if(void 0===l)return void this.config.clearMovingHistory();for(var u in l)if(Object.prototype.hasOwnProperty.call(l,u)){if(void 0===(p=l[k=u]))continue;for(var c in p)if(Object.prototype.hasOwnProperty.call(p,c)){var d=c;if(void 0===(m=p[c]))continue;for(var h in m)if(Object.prototype.hasOwnProperty.call(m,h)){if(void 0===(ue=this.hierarchyManager.getNodeByDataKey(k,d))||void 0===ue.data)continue;if(void 0===(x=ue.data.neoBuilding))continue;var f=x.getReferenceObject(h);delete ue.data.moveHistoryMap[h],f&&(f.moveVector=void 0,f.moveVectorRelToBuilding=void 0)}}}this.config.clearMovingHistory()}else if("deleteAllChangeColor"===t){var g=this.config.getAllColorHistory();if(void 0===g)return void this.config.clearColorHistory();for(var u in g)if(Object.prototype.hasOwnProperty.call(g,u)){var p;if(void 0===(p=g[k=u]))continue;for(var c in p)if(Object.prototype.hasOwnProperty.call(p,c)){var m;d=c;if(void 0===(m=p[c]))continue;for(var v in m)if(Object.prototype.hasOwnProperty.call(m,v)){if(void 0===(ue=this.hierarchyManager.getNodeByDataKey(k,d))||void 0===ue.data)continue;if(ue.deleteChangeColor(this),void 0===(x=ue.data.neoBuilding))continue;x.deleteChangeColor(this,v)}}}this.config.clearColorHistory()}else if("changeInsertIssueMode"===t)this.magoPolicy.setIssueInsertEnable(e.getIssueInsertEnable());else if("changeObjectInfoViewMode"===t)this.magoPolicy.setObjectInfoViewEnable(e.getObjectInfoViewEnable());else if("changeNearGeoIssueListViewMode"===t)this.magoPolicy.setNearGeoIssueListEnable(e.getNearGeoIssueListEnable()),e.getNearGeoIssueListEnable()||(this.objMarkerManager.objectMarkerArray=[]);else if("changeOcclusionCulling"===t){var x;this.magoPolicy.setOcclusionCullingEnable(e.getOcclusionCullingEnable()),(x=this.selectionManager.currentBuildingSelected)&&x.setRenderSettingApplyOcclusionCulling(this.magoPolicy.getOcclusionCullingEnable())}else if("drawInsertIssueImage"===t)n.drawInsertIssueImage(e,this);else if("changeInsertIssueState"===t)this.sceneState.insertIssueState=0;else if("changeLod"===t)s.changeLod(e,this);else if("changeLighting"===t){var _=e.getAmbientReflectionCoef(),y=e.getDiffuseReflectionCoef(),T=e.getSpecularReflectionCoef(),C=e.getSpecularColor(),b=e.getAmbientColor();if(isNaN(_)||(this.sceneState.ambientReflectionCoef[0]=Number(_)),isNaN(y)||(this.sceneState.diffuseReflectionCoef[0]=Number(y)),isNaN(T)||(this.sceneState.specularReflectionCoef[0]=Number(T)),C){var M=C.split(",");if(3===M.length){var A=parseInt(M[0])/255,E=parseInt(M[1])/255,L=parseInt(M[2])/255;this.sceneState.specularColor[0]=A,this.sceneState.specularColor[1]=E,this.sceneState.specularColor[2]=L}}if(b){var w=b.split(",");if(3===w.length){var S=parseInt(w[0])/255,D=parseInt(w[1])/255,R=parseInt(w[2])/255;this.sceneState.ambientColor[0]=S,this.sceneState.ambientColor[1]=D,this.sceneState.ambientColor[2]=R}}}else if("changeSsaoRadius"===t){var P=e.getSsaoRadius();this.magoPolicy.setSsaoRadius(P),this.sceneState.ssaoRadius[0]=Number(P)}else if("changeFPVMode"===t)if(e.getFPVMode()){if(void 0!==this.cameraFPV._camera)return;if(this.cameraFPV.init(),this.isCesiumGlobe()){var F=new Cesium.Matrix4,O=new Cesium.Cartesian4,B=this.scene.camera;this.cameraFPV._camera=B,this.cameraFPV._cameraBAK=Cesium.Camera.clone(B,this.cameraFPV._cameraBAK);var N=new Cesium.Cartesian3,U=new Cesium.Cartesian3,G=new Cesium.Cartesian3,z=this.scene.globe.ellipsoid.cartesianToCartographic(B.position);z.height=this.scene.globe.getHeight(z)+1.5,this.scene.globe.ellipsoid.cartographicToCartesian(z,N);var H=Cesium.Transforms.eastNorthUpToFixedFrame(N,Cesium.Ellipsoid.WGS84,F);Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(H,1,O),U),Cesium.Cartesian3.fromCartesian4(Cesium.Matrix4.getColumn(H,2,O),G),B.flyTo({destination:N,orientation:{direction:U,up:G},duration:1})}}else{if(void 0===this.cameraFPV._cameraBAK)return;this.isCesiumGlobe()&&(this.scene.camera=Cesium.Camera.clone(this.cameraFPV._cameraBAK,this.scene.camera)),this.cameraFPV.release()}else if("changePropertyRendering"===t){var V=e.getShowShadow(),k=e.getProjectId(),j=e.getProperty().split("="),W=j[0],X=j[1];void 0===this.propertyFilterSC&&(this.propertyFilterSC={}),this.propertyFilterSC.visible=V,this.propertyFilterSC.projectId=k,this.propertyFilterSC.propertyKey=W,this.propertyFilterSC.propertyValue=X}else if("drawAppendData"===t)n.drawAppendData(e,this);else if("drawDeleteData"===t)this.deleteAll();else if("clearAllData"===t)this.deleteAll();else{if("getDataInfoByDataKey"===t){k=e.getProjectId(),d=e.getDataKey();if(void 0===(ue=this.hierarchyManager.getNodeByDataKey(k,d)))return void apiResultCallback(this.config.getPolicy().geo_callback_apiresult,t,"-1");var Y=ue.data.data_name,q=ue.data.geoLocDataManager;return void 0===Y||void 0===q?void apiResultCallback(this.config.getPolicy().geo_callback_apiresult,t,"-1"):void 0===($=q.getCurrentGeoLocationData())||void 0===$.geographicCoord?void apiResultCallback(this.config.getPolicy().geo_callback_apiresult,t,"-1"):{projectId:k=ue.data.projectId,dataKey:d,dataName:Y,latitude:$.geographicCoord.latitude,longitude:$.geographicCoord.longitude,altitude:$.geographicCoord.altitude,heading:ie=$.heading,pitch:oe=$.pitch,roll:ne=$.roll}}if("gotoProject"===t){k=e.getProjectId();var K=this.hierarchyManager.getNodesMap(k);if(0===Object.keys(K).length){var Z=e.getProjectDataFolder();this.getObjectIndexFile(k,Z)}this.flyTo(e.getLongitude(),e.getLatitude(),e.getElevation(),e.getDuration())}else if("gotoIssue"===t){k=e.getProjectId();if(!this.hierarchyManager.existProject(k)){Z=e.getProjectDataFolder();this.getObjectIndexFile(k,Z)}this.flyTo(e.getLongitude(),e.getLatitude(),e.getElevation(),e.getDuration()),null!==e.getIssueId()&&void 0!==e.getIssueType()&&n.drawInsertIssueImage(e,this)}else if("gotoFly"===t)this.flyTo(e.getLongitude(),e.getLatitude(),e.getElevation(),e.getDuration());else{if("getCoordinateRelativeToBuilding"===t){k=e.getProjectId(),d=e.getDataKey();var J=e.getInputPoint(),Q=e.getResultPoint();if(void 0===k||void 0===d||void 0===J)return;if(void 0===Q&&(Q=new Jr),void 0===(ue=this.hierarchyManager.getNodeByDataKey(k,d)))return;if(void 0===(q=ue.data.geoLocDataManager))return;return Q=($=q.getCurrentGeoLocationData()).worldCoordToLocalCoord(J,Q)}if("getAbsoluteCoodinateOfBuildingPoint"===t){k=e.getProjectId(),d=e.getDataKey();var $,ee=e.getInputPoint();Q=e.getResultPoint();if(void 0===k||void 0===d||void 0===ee)return;if(void 0===Q&&(Q=new Jr),void 0===(ue=this.hierarchyManager.getNodeByDataKey(k,d)))return;if(void 0===(q=ue.data.geoLocDataManager))return;return Q=($=q.getCurrentGeoLocationData()).localCoordToWorldCoord(ee,Q)}if("changeMagoMode"===t)console.log("changeMagoMode");else if("getCameraCurrentPosition"===t){var te=e.getUnit();if(this.isCesiumGlobe()){N=this.scene.camera.position;switch(te){case I.units.METRE:return N;case I.units.RADIAN:return Cesium.Cartographic.fromCartesian(N);case I.units.DEGREE:var re=Cesium.Cartographic.fromCartesian(N);return{lat:Cesium.Math.toDegrees(re.latitude),lon:Cesium.Math.toDegrees(re.longitude),alt:re.height}}}}else if("getCameraCurrentOrientaion"===t){if(this.isCesiumGlobe()){if(!(B=this.scene.camera))throw new Error("Camera is broken.");return{heading:Cesium.Math.toDegrees(B.heading),pitch:Cesium.Math.toDegrees(B.pitch),roll:Cesium.Math.toDegrees(B.roll)}}}else if("changeCameraOrientation"===t){B=this.scene.camera;var ie=Jo(e.getHeading(),Cesium.Math.toDegrees(B.heading)),oe=Jo(e.getPitch(),Cesium.Math.toDegrees(B.pitch)),ne=Jo(e.getRoll(),Cesium.Math.toDegrees(B.roll)),ae=Jo(e.getDuration(),0);if(this.isCesiumGlobe()){if(!(B=this.scene.camera))throw new Error("Camera is broken.");B.flyTo({destination:B.positionWC,orientation:{heading:Cesium.Math.toRadians(ie),pitch:Cesium.Math.toRadians(oe),roll:Cesium.Math.toRadians(ne)},duration:parseInt(ae)})}}else if("instantiateStaticModel"===t){var se=e.getInstantiateObj();this.instantiateStaticModel(se)}else if("addStaticModel"===t){var le=e.getStaticModelAttributeObj();this.addStaticModel(le)}else if("setTrackNode"===t){var ue=this.hierarchyManager.getNodeByDataKey(e.getProjectId(),e.getDataKey());if(!Qo(ue))throw new Error("This node is not exist.");if(ue.isReadyToRender()){var ce=(q=ue.getNodeGeoLocDataManager()).getCurrentGeoLocationData().getGeographicCoords(),de=ce.longitude,he=ce.latitude;this.flyTo(de,he,400,0),(B=this.sceneState.camera).stopTrack(this),B.setTrack(ue,e.getTrackOption())}}else if("stopTrack"===t)this.sceneState.camera.stopTrack(this);else{if("isExistStaticModel"===t)return this.isExistStaticModel(e.getProjectId());if("isExistData"===t){k=e.getProjectId(),d=e.getDataKey();if(!Qo(k))throw new Error("projectId is required.");if(!Qo(d))throw new Error("dataKey is required.");return void 0!==(ue=this.hierarchyManager.getNodeByDataKey(k,d))}if("isDataReadyToRender"===t){k=e.getProjectId(),d=e.getDataKey();if(!Qo(k))throw new Error("projectId is required.");if(!Qo(d))throw new Error("dataKey is required.");return!(void 0===(ue=this.hierarchyManager.getNodeByDataKey(k,d))||!ue.isReadyToRender())}if("setNodeAttribute"===t){k=e.getProjectId(),d=e.getDataKey(),le=e.getNodeAttribute();if(!Qo(k))throw new Error("projectId is required.");if(!Qo(d))throw new Error("dataKey is required.");if(void 0!==(ue=this.hierarchyManager.getNodeByDataKey(k,d))&&ue.data){var fe=ue.data;fe.attributes||(fe.attributes={});var ge=fe.attributes;for(var pe in le)le.hasOwnProperty(pe)&&(ge[pe]=le[pe])}return!1}if("togglePointCloudColor"===t){var me=this._settings.getRenderingSettings(),ve=me.getPointsCloudInColorRamp();me.setPointsCloudInColorRamp(!ve)}else if("selectF4d"===t){k=e.getProjectId(),d=e.getDataKey();if(!Qo(k))throw new Error("projectId is required.");if(!Qo(d))throw new Error("dataKey is required.");if(!(ue=this.hierarchyManager.getNodeByDataKey(k,d)))throw new Error("f4d is not exist.");this.magoPolicy.setObjectMoveMode(I.moveMode.ALL),this.selectionManager.selectF4d(ue)}}}}}},Fe.prototype.getSelectionManager=function(){return this.selectionManager||(this.selectionManager=new wo(this)),this.selectionManager},Fe.prototype.deleteAll=function(){var e=this.getSelectionManager();e.clearCandidates(),e.clearCurrents(),this.objectSelected=void 0,this.octreeSelected=void 0,this.buildingSelected=void 0,this.nodeSelected=void 0,this.parseQueue.clearAll(),this.processQueue.clearAll(),this.visibleObjControlerBuildings&&this.visibleObjControlerBuildings.clear(),this.visibleObjControlerNodes&&this.visibleObjControlerNodes.clear(),this.visibleObjControlerOctrees&&this.visibleObjControlerOctrees.clear(),this.smartTileManager.resetTiles(),this.hierarchyManager.deleteNodes(this.sceneState.gl,this.vboMemoryManager),this.tinTerrainManager&&(this.tinTerrainManager.deleteAll(),this.tinTerrainManager=void 0),this.isCesiumGlobe()||cancelAnimationFrame(magoManager.reqFrameId)},Fe.prototype.checkCollision=function(e,t){var r=this.sceneState.gl,i=.5*this.sceneState.drawingBufferWidth,o=.5*this.sceneState.drawingBufferHeight;if(this.selectionManager.selectObjectByPixel(r,i,o),void 0!==objects){var n=new Jr,a=new Jr;on.calculatePixelPositionWorldCoord(r,i,o,n,void 0,void 0,void 0,this),this.swapRenderingFase(),on.calculatePixelPositionWorldCoord(r,i,this.sceneState.drawingBufferHeight,void 0,void 0,void 0,this);var s=n.squareDistTo(e.x,e.y,e.z);if(this.swapRenderingFase(),s>3.5){var l=this.scene.globe.ellipsoid.cartesianToCartographic(a),u=this.scene.globe.ellipsoid.cartesianToCartographic(e),c=u.height,d=l.height+1.5;d<c&&(c-=.2),(d>c||d<c&&c-d>1.5)&&(c=d);var h=Cesium.Math.toDegrees(u.latitude),f=Cesium.Math.toDegrees(u.longitude);return this.cameraFPV.camera.position=Cesium.Cartesian3.fromDegrees(f,h,c),!1}return!0}};var Be=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(tn(t.dataId))throw new Error(Ue.REQUIRED_EMPTY_ERROR("dataId"));if(tn(t.dataKey))throw new Error(Ue.REQUIRED_EMPTY_ERROR("dataKey"));if(tn(t.dataGroupId))throw new Error(Ue.REQUIRED_EMPTY_ERROR("dataGroupId"));if(tn(t.longitude)||tn(t.latitude))throw new Error(Ue.REQUIRED_EMPTY_ERROR("longitude","latitude"));this.ready=!1,this.id=t.dataId,this.layerId=t.dataGroupId,this.layerKey=t.dataGroupKey,this.key=t.dataKey,this.name=t.dataName,this.dataType=t.dataType,this.mappingType=Zo(t.mappingType,e.MAPPING_TYPE.ORIGIN),this.reference=Zo(t.reference,!1),this.geographicCoord=new pe(t.longitude,t.latitude,Zo(t.altitude,0)),this.rotationsDegree=new Jr(Zo(t.pitch,0),Zo(t.roll,0),Zo(t.heading,0)),this.bbox=new G,this.style=we({},e.DEFAULT_STYLE,t.style||{}),this._buildingSeed};Object.defineProperties(Be.prototype,{buildingSeed:{get:function(){return this._buildingSeed},set:function(e){e instanceof k&&(this._buildingSeed=e,void 0===this._buildingSeed.geographicCoord&&(this._buildingSeed.geographicCoord=new pe),void 0===this._buildingSeed.rotationsDegree&&(this._buildingSeed.rotationsDegree=new Jr),void 0===this._buildingSeed.geographicCoordOfBBox&&(this._buildingSeed.geographicCoordOfBBox=new pe),this._calculate(),this.ready=!0)}}}),Be.prototype._calculate=function(){var e=this.geographicCoord.longitude,t=this.geographicCoord.latitude,r=this.geographicCoord.altitude;this.buildingSeed.geographicCoord.setLonLatAlt(e,t,r),this.buildingSeed.rotationsDegree.set(this.rotationsDegree.x,this.rotationsDegree.y,this.rotationsDegree.z);var i=this.getTmatrix(),o=this.buildingSeed.bBox.getCenterPoint(o),n=i.transformPoint3D(o,n);if(this.buildingSeed.geographicCoordOfBBox=on.pointToGeographicCoord(n,this.buildingSeed.geographicCoordOfBBox),this.buildingSeed.geographicCoordOfBBox.altitude=this.buildingSeed.geographicCoord.altitude,this.bbox.copyFrom(this.buildingSeed.bBox),void 0!==i)switch(this.mappingType.toLowerCase()){case Be.MAPPING_TYPE.BOUNDINGBOXCENTER:this.bbox.geographicCoord=new pe,this.bbox.geographicCoord.setLonLatAlt(e,t,height);break;case Be.MAPPING_TYPE.ORIGIN:default:o=this.bbox.getCenterPoint(o);n=i.transformPoint3D(o,n);this.bbox.geographicCoord=on.pointToGeographicCoord(n,this.bbox.geographicCoord)}},Be.prototype.getTmatrix=function(){var e=this.geographicCoord,t=this.rotationsDegree,r=on.geographicCoordToWorldPoint(e.longitude,e.latitude,e.altitude,r);return on.calculateTransformMatrixAtWorldPosition(r,t.heading,t.pitch,t.roll,void 0)},Be.DEFAULT_STYLE={visible:!0},Be.MAPPING_TYPE={ORIGIN:"origin",BOUNDINGBOXCENTER:"boundingboxcenter"};var Ne=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._floatArrays=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.dirty=!0};Ne.prototype.Identity=function(){this._floatArrays[0]=1,this._floatArrays[1]=0,this._floatArrays[2]=0,this._floatArrays[3]=0,this._floatArrays[4]=0,this._floatArrays[5]=1,this._floatArrays[6]=0,this._floatArrays[7]=0,this._floatArrays[8]=0,this._floatArrays[9]=0,this._floatArrays[10]=1,this._floatArrays[11]=0,this._floatArrays[12]=0,this._floatArrays[13]=0,this._floatArrays[14]=0,this._floatArrays[15]=1},Ne.prototype.deleteObjects=function(){this._floatArrays=void 0},Ne.prototype.getRowMajorMatrix=function(){var e=new Float32Array(16);return e[0]=this.get(0,0),e[1]=this.get(1,0),e[2]=this.get(2,0),e[3]=this.get(3,0),e[4]=this.get(0,1),e[5]=this.get(1,1),e[6]=this.get(2,1),e[7]=this.get(3,1),e[8]=this.get(0,2),e[9]=this.get(1,2),e[10]=this.get(2,2),e[11]=this.get(3,2),e[12]=this.get(0,3),e[13]=this.get(1,3),e[14]=this.get(2,3),e[15]=this.get(3,3),e},Ne.prototype.getXAxis=function(e){return void 0===e&&(e=new Jr),e.set(this._floatArrays[0],this._floatArrays[1],this._floatArrays[2]),e},Ne.prototype.getYAxis=function(e){return void 0===e&&(e=new Jr),e.set(this._floatArrays[4],this._floatArrays[5],this._floatArrays[6]),e},Ne.prototype.getZAxis=function(e){return void 0===e&&(e=new Jr),e.set(this._floatArrays[8],this._floatArrays[9],this._floatArrays[10]),e},Ne.getRotationDegZXYMatrix=function(e,t,r,i){void 0===i&&(i=new Ne);var o,n,a,s=new Ne,l=new Ne,u=new Ne;return void 0!==t&&0!==t&&s.rotationAxisAngDeg(t,1,0,0),void 0!==r&&0!==r&&l.rotationAxisAngDeg(r,0,1,0),void 0!==e&&0!==e&&u.rotationAxisAngDeg(e,0,0,1),o=u,n=s.getMultipliedByMatrix(o,n),i=a=l.getMultipliedByMatrix(n,a)},Ne.prototype.rotationAxisAngDeg=function(e,t,r,i){var o=new Xe;o.rotationAngDeg(e,t,r,i),this.rotationByQuaternion(o),o=void 0},Ne.prototype.rotationAxisAngRad=function(e,t,r,i){var o=new Xe;o.rotationAngRad(e,t,r,i),this.rotationByQuaternion(o),o=void 0},Ne.prototype.rotationByQuaternion=function(e){var t=e.x,r=e.y,i=e.z,o=e.w;this._floatArrays[this.getIndexOfArray(0,0)]=1-2*r*r-2*i*i,this._floatArrays[this.getIndexOfArray(0,1)]=2*t*r+2*i*o,this._floatArrays[this.getIndexOfArray(0,2)]=2*t*i-2*r*o,this._floatArrays[this.getIndexOfArray(0,3)]=0,this._floatArrays[this.getIndexOfArray(1,0)]=2*t*r-2*i*o,this._floatArrays[this.getIndexOfArray(1,1)]=1-2*t*t-2*i*i,this._floatArrays[this.getIndexOfArray(1,2)]=2*r*i+2*t*o,this._floatArrays[this.getIndexOfArray(1,3)]=0,this._floatArrays[this.getIndexOfArray(2,0)]=2*t*i+2*r*o,this._floatArrays[this.getIndexOfArray(2,1)]=2*r*i-2*t*o,this._floatArrays[this.getIndexOfArray(2,2)]=1-2*t*t-2*r*r,this._floatArrays[this.getIndexOfArray(2,3)]=0,this._floatArrays[this.getIndexOfArray(3,0)]=0,this._floatArrays[this.getIndexOfArray(3,1)]=0,this._floatArrays[this.getIndexOfArray(3,2)]=0,this._floatArrays[this.getIndexOfArray(3,3)]=1},Ne.prototype.setByFloat32Array=function(e){for(var t=0;t<16;t++)this._floatArrays[t]=e[t]},Ne.prototype.getIndexOfArray=function(e,t){return 4*(e||0)+(t||0)},Ne.prototype.get=function(e,t){return this._floatArrays[this.getIndexOfArray(e,t)]},Ne.prototype.setTranslation=function(e,t,r){this.set(3,0,e),this.set(3,1,t),this.set(3,2,r)},Ne.prototype.set=function(e,t,r){this._floatArrays[this.getIndexOfArray(e,t)]=r},Ne.prototype.getInverse=function(e){return void 0===e&&(e=new Ne),e._floatArrays=glMatrix.mat4.invert(e._floatArrays,this._floatArrays),e},Ne.prototype.transformDataArray3D=function(e,t){var r=e.length/3;if(!t){var i=d.getGlTypeOfArray(e);t=d.newTypedArray(e.length,i)}for(var o=this.get(0,0),n=this.get(0,1),a=this.get(0,2),s=this.get(1,0),l=this.get(1,1),u=this.get(1,2),c=this.get(2,0),h=this.get(2,1),f=this.get(2,2),g=this.get(3,0),p=this.get(3,1),m=this.get(3,2),v=0;v<r;v++){var x=e[3*v],_=e[3*v+1],y=e[3*v+2];t[3*v]=x*o+_*s+y*c+g,t[3*v+1]=x*n+_*l+y*h+p,t[3*v+2]=x*a+_*u+y*f+m}return t},Ne.prototype.rotateDataArray3D=function(e,t){var r=e.length/3;if(!t){var i=d.getGlTypeOfArray(e);t=d.newTypedArray(e.length,i)}for(var o=this.get(0,0),n=this.get(0,1),a=this.get(0,2),s=this.get(1,0),l=this.get(1,1),u=this.get(1,2),c=this.get(2,0),h=this.get(2,1),f=this.get(2,2),g=0;g<r;g++){var p=e[3*g],m=e[3*g+1],v=e[3*g+2];t[3*g]=p*o+m*s+v*c,t[3*g+1]=p*n+m*l+v*h,t[3*g+2]=p*a+m*u+v*f}return t},Ne.prototype.transformPoint3D=function(e,t){if(!e)return t;void 0===t&&(t=new Jr);var r=e.x,i=e.y,o=e.z;return t.x=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0)+this.get(3,0),t.y=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1)+this.get(3,1),t.z=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2)+this.get(3,2),t},Ne.prototype.transformPoint4D=function(e,t){void 0===t&&(t=[0,0,0,0]);var r=e[0],i=e[1],o=e[2],n=e[3];return t[0]=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0)+n*this.get(3,0),t[1]=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1)+n*this.get(3,1),t[2]=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2)+n*this.get(3,2),t[3]=r*this.get(0,3)+i*this.get(1,3)+o*this.get(2,3)+n*this.get(3,3),t},Ne.prototype.rotateXYZDataArray=function(e,t){if(void 0===e)return t;var r,i,o;void 0===t&&(t=[]);for(var n=e.length/3,a=0;a<n;a++)r=e[3*a],i=e[3*a+1],o=e[3*a+2],t[3*a]=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0),t[3*a+1]=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1),t[3*a+2]=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2);return t},Ne.prototype.rotatePoint3D=function(e,t){void 0===t&&(t=new Jr);var r=e.x,i=e.y,o=e.z;return t.x=r*this.get(0,0)+i*this.get(1,0)+o*this.get(2,0),t.y=r*this.get(0,1)+i*this.get(1,1)+o*this.get(2,1),t.z=r*this.get(0,2)+i*this.get(1,2)+o*this.get(2,2),t},Ne.lookAt=function(e,t,r,i){var o=void 0,n=void 0,a=void 0,s=void 0,l=void 0,u=void 0,c=void 0,d=void 0,h=void 0,f=void 0,g=t[0],p=t[1],m=t[2],v=i[0],x=i[1],_=i[2],y=r[0],T=r[1],C=r[2];return Math.abs(g-y)<glMatrix.EPSILON&&Math.abs(p-T)<glMatrix.EPSILON&&Math.abs(m-C)<glMatrix.EPSILON?glMatrix.mat4.identity(e):(c=g-y,d=p-T,h=m-C,o=x*(h*=f=1/Math.sqrt(c*c+d*d+h*h))-_*(d*=f),n=_*(c*=f)-v*h,a=v*d-x*c,(f=Math.sqrt(o*o+n*n+a*a))?(o*=f=1/f,n*=f,a*=f):(o=0,n=0,a=0),s=d*a-h*n,l=h*o-c*a,u=c*n-d*o,(f=Math.sqrt(s*s+l*l+u*u))?(s*=f=1/f,l*=f,u*=f):(s=0,l=0,u=0),e[0]=o,e[1]=s,e[2]=c,e[3]=0,e[4]=n,e[5]=l,e[6]=d,e[7]=0,e[8]=a,e[9]=u,e[10]=h,e[11]=0,e[12]=-(o*g+n*p+a*m),e[13]=-(s*g+l*p+u*m),e[14]=-(c*g+d*p+h*m),e[15]=1,e)},Ne.prototype.getMultipliedByMatrix=function(e,t){void 0===t&&(t=new Ne);for(var r=0;r<4;r++)for(var i=0;i<4;i++){var o=this.getIndexOfArray(r,i);t._floatArrays[o]=0;for(var n=0;n<4;n++)t._floatArrays[o]+=e.get(n,i)*this.get(r,n)}return t},Ne.prototype.setToPerspectiveProjection=function(e,t,r,i){var o=1/Math.tan(e/2),n=o/t,a=r-i;this.setByFloat32Array([n,0,0,0,0,o,0,0,0,0,(i+r)/a,-1,0,0,2*i*r/a,0])},Ne.prototype.copyFromMatrix4=function(e){for(var t=0;t<16;t++)this._floatArrays[t]=e._floatArrays[t]},Ne.prototype.copyFromFloatArray=function(e){for(var t=0;t<16;t++)this._floatArrays[t]=e[t]},Ne.prototype.computeMatrixType=function(){return this.isRotationIdentity()?this.aproxEqual(this._floatArrays[3],0,1e-7)&&this.aproxEqual(this._floatArrays[7],0,1e-7)&&this.aproxEqual(this._floatArrays[11],0,1e-7)&&this.aproxEqual(this._floatArrays[12],0,1e-7)&&this.aproxEqual(this._floatArrays[13],0,1e-7)&&this.aproxEqual(this._floatArrays[14],0,1e-7)&&this.aproxEqual(this._floatArrays[15],1,1e-7)?0:1:2},Ne.prototype.aproxEqual=function(e,t,r){return void 0===r&&(r=1e-7),e===t||e>t-r&&e<t+r},Ne.perspective=function(e,t,r,i){var o=Math.tan(.5*Math.PI-.5*e),n=1/(r-i);return[o/t,0,0,0,0,o,0,0,0,0,(r+i)*n,-1,0,0,r*i*n*2,0]},Ne.getNearFromPerspectiveMatrix=function(e){var t=e.get(2,2);return e.get(3,2)/(t-1)},Ne.getFarFromPerspectiveMatrix=function(e){var t=e.get(2,2);return e.get(3,2)/(t+1)},Ne.areEqualArrays=function(e,t){for(var r=!0,i=0;r&&i<16;)e[i]!==t[i]&&(r=!1),i++;return r},Ne.copyArray=function(e,t){for(var r=0;r<16;r++)t[r]=e[r]},Ne.prototype.isNAN=function(){for(var e=0;e<16;e++)if(isNaN(this._floatArrays[e]))return!0;return!1},Ne.prototype.isRotationIdentity=function(e){return!!this.aproxEqual(this._floatArrays[0],1,e)&&(!!this.aproxEqual(this._floatArrays[1],0,e)&&(!!this.aproxEqual(this._floatArrays[2],0,e)&&(!!this.aproxEqual(this._floatArrays[4],0,e)&&(!!this.aproxEqual(this._floatArrays[5],1,e)&&(!!this.aproxEqual(this._floatArrays[6],0,e)&&(!!this.aproxEqual(this._floatArrays[8],0,e)&&(!!this.aproxEqual(this._floatArrays[9],0,e)&&!!this.aproxEqual(this._floatArrays[10],1,e))))))))};var Ue={CONSTRUCT_ERROR:"이 객체는 new를 사용하여 생성해야 합니다.",REQUIRED_EMPTY_ERROR:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.join(",")+" 항목은 필수요소 입니다."}},Ge=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.strX,this.strY,this.strLinealDepth,this.strCamCoordPoint,this.strWorldPoint,this.strModelViewMatrix=new Ne,this.strModelViewMatrixInv=new Ne,this.strCamera=new X,this.strCameraTarget=new Float32Array([0,0,0]),this.curX,this.curY,this.camRotPoint=new Jr,this.camRotAxis=new Jr,this.strTime,this.strWorldPointAux,this.strLocationAux};Ge.prototype.clearStartPositionsAux=function(){this.strWorldPointAux&&this.strWorldPointAux.deleteObjects(),this.strWorldPointAux=void 0,this.strLocationAux&&this.strLocationAux.deleteObjects(),this.strLocationAux=void 0},Ge.prototype.claculateStartPositionsAux=function(e){var t=1e8*this.strLinealDepth;e.resultRaySC=e.getRayCamSpace(this.strX,this.strY,e.resultRaySC);var r=new Jr;r.set(e.resultRaySC[0]*t,e.resultRaySC[1]*t,e.resultRaySC[2]*t),this.strWorldPointAux=e.cameraCoordPositionToWorldCoord(r,this.strWorldPointAux),this.strLocationAux=on.pointToGeographicCoord(this.strWorldPointAux,void 0,e)},Ge.prototype.saveCurrentToStart=function(){this.strX=this.curX,this.strY=this.curY,void 0===this.strWorldPoint&&(this.strWorldPoint=new Jr),this.curWorldPoint&&this.strWorldPoint.copyFrom(this.curWorldPoint),void 0===this.strCamCoordPoint&&(this.strCamCoordPoint=new Jr),this.curCamCoordPoint&&this.strCamCoordPoint.copyFrom(this.curCamCoordPoint)},Ge.prototype.getStartWorldPoint=function(){return this.strWorldPoint};var ze=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.movementType=I.movementType.NO_MOVEMENT,this.deltaTime,this.currLinearVelocity,this.translationDir,this.currAngularVelocity,this.rotationAxis,this.xAngVelocity,this.zAngVelocity,this.rotationPoint,t&&(void 0!==t.movementType&&(this.movementType=t.movementType),void 0!==t.linearVelocity&&(this.currLinearVelocity=t.linearVelocity),void 0!==t.translationDir&&(this.translationDir=t.translationDirection),void 0!==t.angularVelocity&&(this.currAngularVelocity=t.angularVelocity),void 0!==t.rotationAxis&&(this.rotationAxis=t.rotationAxis),void 0!==t.rotationPoint&&(this.rotationPoint=t.rotationPoint))},He=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.id,this.geoLocationData=new _e,this.issue_id=null,this.issue_type=null,this.target,this.imageFilePath,this.size2d=new Float32Array([25,25]),this.bUseOriginalImageSize=!0};He.prototype.deleteObjects=function(){this.geoLocationData&&this.geoLocationData.deleteObjects()},He.prototype.setImageFilePath=function(e){this.imageFilePath=e},He.prototype.copyFrom=function(e){void 0!==e&&(e.geoLocationData&&this.geoLocationData.copyFrom(e.geoLocationData),this.issue_id=e.issue_id,this.issue_type=e.issue_type)},He.prototype.render=function(e,t,r,i){},He.prototype.getGeoLocationData=function(e){var t,r=this.target;if(r){if(void 0!==r.buildingId&&void 0!==r.projectId){var i=r.projectId,o=r.buildingId,n=e.hierarchyManager.getNodeByDataKey(i,o);if(n){var a=n.data.neoBuilding;if(c=n.data.geoLocDataManager){var s=c.getCurrentGeoLocationData();if(void 0!==r.objectId&&a){var l=a.getReferenceObjectsArrayByObjectId(r.objectId);if(l&&l.length>0){var u=l[0].getCenterPositionWC(a,void 0);u&&(void 0===t&&(t=new _e),void 0===t.positionHIGH&&(t.positionHIGH=new Float32Array([0,0,0])),void 0===t.positionLOW&&(t.positionLOW=new Float32Array([0,0,0])),on.calculateSplited3fv([u.x,u.y,u.z],t.positionHIGH,t.positionLOW))}}else t=s}}}else if(r.nativeObject){var c;t=(c=r.nativeObject.getGeoLocDataManager()).getCurrentGeoLocationData()}}else t=this.geoLocationData;return t};var Ve=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t,this.objectMarkerArray=[],this.objectMarkerMap={},this.pin=new je};Ve.prototype.deleteObjects=function(){for(var e=this.objectMarkerArray.length,t=0;t<e;t++)this.objectMarkerArray[t].deleteObjects(),this.objectMarkerArray[t]=void 0;this.objectMarkerArray.length=0,this.objectMarkerMap={}},Ve.prototype.deleteObject=function(e){for(var t=this.objectMarkerArray.length,r=0;r<t;r++)if(this.objectMarkerArray[r].id===e){this.objectMarkerArray[r].deleteObjects(),delete this.objectMarkerMap.objMarkerId,this.objectMarkerArray.splice(r,1);break}},Ve.prototype.setMarkerByCondition=function(e){var t=this,r=t.objectMarkerArray.filter(function(r){return e.call(t,r)});t.objectMarkerArray=r},Ve.prototype.loadDefaultImages=function(e){if(!1===this.pin.defaultImagesLoaded){e.getGl();var t=e.magoPolicy,r=this.pin,i=t.imagePath+"/defaultRed.png",o=r.loadImage(i,e);r.imageFileMap.defaultRed=o,i=t.imagePath+"/defaultBlue.png";o=r.loadImage(i,e);r.imageFileMap.defaultBlue=o,i=t.imagePath+"/defaultOrange.png";o=r.loadImage(i,e);r.imageFileMap.defaultOrange=o,i=t.imagePath+"/defaultCian.png";o=r.loadImage(i,e);r.imageFileMap.defaultCian=o,this.pin.defaultImagesLoaded=!0}},Ve.prototype.newObjectMarker=function(e,t){var r=new He;if(this.objectMarkerArray.push(r),e){if(void 0!==e.id&&(r.id=e.id,this.objectMarkerMap[r.id]=r),e.positionWC){var i=e.positionWC;void 0===r.geoLocationData&&(r.geoLocationData=new _e),on.calculateGeoLocationDataByAbsolutePoint(i.x,i.y,i.z,r.geoLocationData,t)}e.imageFilePath&&(r.imageFilePath=e.imageFilePath),e.imageFilePathSelected&&(r.imageFilePathSelected=e.imageFilePathSelected),e.sizeX&&e.sizeY?(void 0===r.size2d&&(r.size2d=new Float32Array([25,25])),r.size2d[0]=e.sizeX,void 0===r.size2d&&(r.size2d=new Float32Array([25,25])),r.size2d[1]=e.sizeY,r.bUseOriginalImageSize=!1):r.bUseOriginalImageSize=!0,e.target&&(r.target=e.target)}return r},Ve.prototype.getObjectMarkerById=function(e){if(void 0===this.objectMarkerMap[e])for(var t=this.objectMarkerArray.length,r=!1,i=0;!r&&i<t;)this.objectMarkerArray[i].id===e&&(r=!0,this.objectMarkerMap[e]=this.objectMarkerArray[i]),i++;return this.objectMarkerMap[e]},Ve.prototype.newObjectMarkerSpeechBubble=function(e,t){if(e){t.speechBubble||(t.speechBubble=new Mago3D.SpeechBubble);var r=t.speechBubble,i=e.speechBubbleOptions;if(i){var o=i.width,n=i.height,a=i.commentTextOption,s=i.bubbleColor,l=J.getHexCode(s.r,s.g,s.b),u=r.getPng([o,n],l,a),c=e.target;if(c){var d={target:c,imageFilePath:u,id:e.id};this.newObjectMarker(d,t)}else{var h=e.longitude,f=e.latitude,g=e.altitude;d={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(h,f,g),imageFilePath:u,id:e.id};this.newObjectMarker(d,t)}}}},Ve.prototype.doTest__ObjectMarker=function(e){var t=e.modeler.getGeographicCoordsList();if(t)for(var r=t.getGeoCoordsCount(),i=r-1;i<r;i++){e.speechBubble||(e.speechBubble=new Mago3D.SpeechBubble);var o=e.speechBubble,n=J.getHexCode(1,1,1),a=o.getPng([256,256],n,{pixel:12,color:"blue",borderColor:"white",text:"blabla"}),s=t.getGeoCoord(i),l=s.longitude,u=s.latitude,c=s.altitude,d={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(l,u,c),imageFilePath:a};e.objMarkerManager.newObjectMarker(d,e)}},Ve.prototype.TEST__ObjectMarker_toNeoReference=function(){var e={speechBubbleOptions:{width:1,height:1,commentTextOption:{pixel:26,color:"blue",borderColor:"blue",text:"11011 hasta luegor\n babo"},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"11011"}};this.newObjectMarkerSpeechBubble(e,this);e={speechBubbleOptions:{width:1,height:1,commentTextOption:{pixel:26,color:"blue",borderColor:"blue",text:"2953\n hola Ricardo Granados"},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"2953"}};this.newObjectMarkerSpeechBubble(e,this);e={speechBubbleOptions:{width:1,height:1,commentTextOption:{pixel:26,color:"blue",borderColor:"blue",text:"2837\n tururu piripi\n gaia3d en Korea pa to el mundo del espectaculo \n hello world\n holas Ricardi!\n 삼일차 뉴비인데 다이아 어따써야댐?\n クソじじ・クソババ"},bubbleColor:{r:1,g:1,b:1}},target:{projectId:"3ds",buildingId:"SD_COUNCIL_del",objectId:"2837"}};this.newObjectMarkerSpeechBubble(e,this)},Ve.prototype.render=function(e,t){var r=this.objectMarkerArray.length;if(r>0){var i=e.getGl();void 0===this.pin.positionBuffer&&this.pin.createPinCenterBottom(i);var o=e.postFxShadersManager.getShader("pin");o.resetLastBuffersBinded();var n=o.program;i.useProgram(n),o.bindUniformGenerals(),e.effectsManager.setCurrentShader(o),i.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,e.sceneState.modelViewProjRelToEyeMatrix._floatArrays),i.uniform3fv(o.cameraPosHIGH_loc,e.sceneState.encodedCamPosHigh),i.uniform3fv(o.cameraPosLOW_loc,e.sceneState.encodedCamPosLow),i.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,e.sceneState.modelViewRelToEyeMatrixInv._floatArrays),i.uniform1f(o.screenWidth_loc,parseFloat(e.sceneState.drawingBufferWidth[0])),i.uniform1f(o.screenHeight_loc,parseFloat(e.sceneState.drawingBufferHeight[0])),i.uniform1i(o.textureFlipYAxis_loc,e.sceneState.textureFlipYAxis),i.uniform1i(o.texture_loc,0),i.enableVertexAttribArray(o.texCoord2_loc),i.enableVertexAttribArray(o.position4_loc),i.activeTexture(i.TEXTURE0),i.bindBuffer(i.ARRAY_BUFFER,this.pin.positionBuffer),i.vertexAttribPointer(o.position4_loc,4,i.FLOAT,!1,0,0),i.bindBuffer(i.ARRAY_BUFFER,this.pin.texcoordBuffer),i.vertexAttribPointer(o.texCoord2_loc,2,i.FLOAT,!1,0,0),i.activeTexture(i.TEXTURE0),i.uniform1i(o.colorType_loc,2),i.uniform4fv(o.oneColor4_loc,[.2,.7,.9,1]),i.uniform2fv(o.scale2d_loc,[1,1]),i.uniform2fv(o.size2d_loc,[25,25]),i.uniform1i(o.bUseOriginalImageSize_loc,!0),i.uniform3fv(o.aditionalOffset_loc,[0,0,0]);var a=e.selectionManager,s=void 0;if(1===t){i.enable(i.BLEND);for(var l=!1,u=0;u<r;u++){var c=e.objMarkerManager.objectMarkerArray[u],d=this.pin.getTexture(c.imageFilePath);if(d){if(a.isObjectSelected(c)){if(i.uniform2fv(o.scale2d_loc,new Float32Array([1.5,1.5])),c.imageFilePathSelected){var h=this.pin.getTexture(c.imageFilePathSelected);if(!h){this.pin.loadImage(c.imageFilePathSelected,e);continue}d=h}}else i.uniform2fv(o.scale2d_loc,new Float32Array([1,1]));i.uniform1i(o.bUseOriginalImageSize_loc,c.bUseOriginalImageSize),c.bUseOriginalImageSize||i.uniform2fv(o.size2d_loc,c.size2d),2!==t&&e.currentProcess!==I.magoCurrentProcess.StencilSilhouetteRendering&&(l=e.effectsManager.executeEffects(c.id,e)),i.uniform2fv(o.imageSize_loc,[d.texId.imageWidth,d.texId.imageHeight]);var f=c.getGeoLocationData(e);void 0!==f&&(d.texId!==s&&(i.bindTexture(i.TEXTURE_2D,d.texId),s=d.texId),i.uniform3fv(o.buildingPosHIGH_loc,f.positionHIGH),i.uniform3fv(o.buildingPosLOW_loc,f.positionLOW),i.drawArrays(i.TRIANGLE_STRIP,0,4))}else this.pin.loadImage(c.imageFilePath,e)}l&&i.uniform3fv(o.aditionalOffset_loc,[0,0,0])}i.disable(i.BLEND),i.depthRange(0,1),i.depthMask(!0),i.useProgram(null)}};var ke=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._ocCulling_Cell_owner=t,this.minX=0,this.maxX=0,this.minY=0,this.maxY=0,this.minZ=0,this.maxZ=0,this._indicesArray=[],this._subBoxesArray=[],this.modelReferencedGroupsList};ke.prototype.createModelReferencedGroups=function(e){var t=this._subBoxesArray.length;if(0===t){if(0===this._indicesArray.length)return;void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new $t),this.modelReferencedGroupsList.createModelReferencedGroups(this._indicesArray,e)}else for(var r=0;r<t;r++)this._subBoxesArray[r].createModelReferencedGroups(e)},ke.prototype.newSubBox=function(){var e=new ke(this);return this._subBoxesArray.push(e),e},ke.prototype.create8SubBoxes=function(){this._subBoxesArray.length=0;for(var e=0;e<8;e++)this.newSubBox()},ke.prototype.setDimensions=function(e,t,r,i,o,n){this.minX=e,this.maxX=t,this.minY=r,this.maxY=i,this.minZ=o,this.maxZ=n},ke.prototype.setSizesSubBoxes=function(){if(this._subBoxesArray.length>0){var e=(this.maxX+this.minX)/2,t=(this.maxY+this.minY)/2,r=(this.maxZ+this.minZ)/2;this._subBoxesArray[0].setDimensions(this.minX,e,this.minY,t,this.minZ,r),this._subBoxesArray[1].setDimensions(e,this.maxX,this.minY,t,this.minZ,r),this._subBoxesArray[2].setDimensions(e,this.maxX,t,this.maxY,this.minZ,r),this._subBoxesArray[3].setDimensions(this.minX,e,t,this.maxY,this.minZ,r),this._subBoxesArray[4].setDimensions(this.minX,e,this.minY,t,r,this.maxZ),this._subBoxesArray[5].setDimensions(e,this.maxX,this.minY,t,r,this.maxZ),this._subBoxesArray[6].setDimensions(e,this.maxX,t,this.maxY,r,this.maxZ),this._subBoxesArray[7].setDimensions(this.minX,e,t,this.maxY,r,this.maxZ);for(var i=0;i<this._subBoxesArray.length;i++)this._subBoxesArray[i].setSizesSubBoxes()}},ke.prototype.intersectsWithPoint3D=function(e,t,r){var i=!1;return e>this.minX&&e<this.maxX&&t>this.minY&&t<this.maxY&&r>this.minZ&&r<this.maxZ&&(i=!0),i},ke.prototype.getIntersectedSubBoxByPoint3D=function(e,t,r){if(void 0!==this._ocCulling_Cell_owner||this.intersectsWithPoint3D(e,t,r)){var i=void 0;if(this._subBoxesArray.length>0){var o,n=(this.minX+this.maxX)/2,a=(this.minY+this.maxY)/2,s=(this.minZ+this.maxZ)/2;o=e<n?t<a?r<s?0:4:r<s?3:7:t<a?r<s?1:5:r<s?2:6,i=this._subBoxesArray[o].getIntersectedSubBoxByPoint3D(e,t,r)}else i=this;return i}},ke.prototype.getIndicesVisiblesForEye=function(e,t,r,i,o){var n=this.getIntersectedSubBoxByPoint3D(e,t,r);return void 0!==n&&n._indicesArray.length>0&&(i=n._indicesArray,o&&(o=this.modelReferencedGroupsList)),i},ke.prototype.expandBox=function(e){this.minX-=e,this.maxX+=e,this.minY-=e,this.maxY+=e,this.minZ-=e,this.maxZ+=e},ke.prototype.parseArrayBuffer=function(e,t,r){var i=r.readInt8(e,t,t+1);if(t+=1,i){var o=r.readFloat32(e,t,t+4);t+=4;var n=r.readFloat32(e,t,t+4);t+=4;var a=r.readFloat32(e,t,t+4);t+=4;var s=r.readFloat32(e,t,t+4);t+=4;var l=r.readFloat32(e,t,t+4);t+=4;var u=r.readFloat32(e,t,t+4);t+=4,this.setDimensions(o,n,a,s,l,u)}var c=r.readUInt32(e,t,t+4);if(t+=4,0===c){var d=r.readUInt32(e,t,t+4);t+=4;for(var h=0;h<d;h++){var f=r.readUInt32(e,t,t+4);t+=4,this._indicesArray.push(f)}}else for(h=0;h<c;h++){t=this.newSubBox().parseArrayBuffer(e,t,r)}return t};var je=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.texture,this.texturesArray=[],this.positionBuffer,this.texcoordBuffer,this.imageFileMap={},this.defaultImagesLoaded=!1};je.prototype.createPin=function(e){this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,0,1,0,0,0,1,0,0,1,0,1,0,0,1,1,0]),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),e.STATIC_DRAW)},je.prototype.loadImage=function(e,t){var r=new it,i=t.getGl();return r.texId=i.createTexture(),t.readerWriter.readNeoReferenceTexture(i,e,r,void 0,t),this.texturesArray.push(r),this.imageFileMap[e]=r,r},je.prototype.getTexture=function(e){return this.imageFileMap[e]},je.prototype.createPinCenterBottom=function(e){this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);var t=new Float32Array(16),r=new Jr(0,0,0);t[0]=r.x,t[1]=r.y,t[2]=r.z,t[3]=1,t[4]=r.x,t[5]=r.y,t[6]=r.z,t[7]=-1,t[8]=r.x,t[9]=r.y,t[10]=r.z,t[11]=2,t[12]=r.x,t[13]=r.y,t[14]=r.z,t[15]=-2,e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),e.STATIC_DRAW)};var We=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.a=0,this.b=0,this.c=0,this.d=0};We.prototype.setPointAndNormal=function(e,t,r,i,o,n){this.a=i,this.b=o,this.c=n,this.d=-this.a*e-this.b*t-this.c*r},We.prototype.setPoint=function(e,t,r){this.d=-this.a*e-this.b*t-this.c*r},We.prototype.setNormalAndDistance=function(e,t,r,i){this.a=e,this.b=t,this.c=r,this.d=i},We.prototype.set3Points=function(e,t,r,i,o,n,a,s,l){var u=new Jr(e,t,r),c=new Jr(i,o,n),d=new Jr(a,s,l),h=bi.calculateNormal(u,c,d,void 0);this.setPointAndNormal(e,t,r,h.x,h.y,h.z)},We.prototype.getNormal=function(e){return void 0===e&&(e=new Jr),e.set(this.a,this.b,this.c),e},We.prototype.getRotationMatrix=function(e){var t=new Jr(0,0,1),r=this.getNormal(void 0),i=t.getRelativeOrientationToVector(r,1e-9),o=glMatrix.mat4.create();if(0===i);else if(1===i){var n=glMatrix.mat4.create();o=glMatrix.mat4.rotateX(o,n,Math.PI)}else if(2===i){var a=t.crossProduct(r,void 0);a.unitary();var s=t.angleRadToVector(r),l=glMatrix.vec3.fromValues(a.x,a.y,a.z),u=glMatrix.quat.create();u=glMatrix.quat.setAxisAngle(u,l,s);n=glMatrix.mat4.create();o=glMatrix.mat4.fromQuat(n,u)}return void 0===e&&(e=new Ne),e._floatArrays=o,e},We.prototype.getProjectedPoint=function(e,t){if(void 0!==e){void 0===t&&(t=new Jr);var r=this.getNormal(),i=new Rr;return i.setPointAndDir(e.x,e.y,e.z,r.x,r.y,r.z),t=this.intersectionLine(i,t)}},We.prototype.isCoincidentLine=function(e,t){void 0===t&&(t=1e-8);var r=e.point;if(this.isCoincidentPoint(r,t)){var i=e.direction,o=new Kr(r.x+1e3*i.x,r.y+1e3*i.y,r.z+1e3*i.z);if(this.isCoincidentPoint(o,t))return!0}return!1},We.prototype.isCoincidentPoint=function(e,t){var r=this.a*e.x+this.b*e.y+this.c*e.z+this.d;return void 0===t&&(t=1e-8),Math.abs(r)<t},We.prototype.intersectionLine=function(e,t){var r=e.point.x,i=e.point.y,o=e.point.z,n=e.direction.x,a=e.direction.y,s=e.direction.z,l=this.a*n+this.b*a+this.c*s;if(Math.abs(l)>1e-7){var u=-(this.a*r+this.b*i+this.c*o+this.d)/l;return void 0===t&&(t=new Jr),t.set(r+u*n,i+u*a,o+u*s),t}},We.prototype.getRelativePositionOfTheSegment=function(e,t){void 0===t&&(t=1e-8);var r=e.startPoint3d,i=e.endPoint3d,o=this.getRelativePositionOfThePoint(r,t),n=this.getRelativePositionOfThePoint(i,t),a=I.relativePositionSegment3DWithPlane2D.UNKNOWN;return o===F.INTERSECTION_INSIDE?n===F.INTERSECTION_INSIDE?a=I.relativePositionSegment3DWithPlane2D.NO_INTERSECTION:n===F.INTERSECTION_OUTSIDE?a=I.relativePositionSegment3DWithPlane2D.INTERSECTION:n===F.INTERSECTION_INTERSECT&&(a=I.relativePositionSegment3DWithPlane2D.END_POINT_COINCIDENT):o===F.INTERSECTION_OUTSIDE?n===F.INTERSECTION_INSIDE?a=I.relativePositionSegment3DWithPlane2D.INTERSECTION:n===F.INTERSECTION_OUTSIDE?a=I.relativePositionSegment3DWithPlane2D.NO_INTERSECTION:n===F.INTERSECTION_INTERSECT&&(a=I.relativePositionSegment3DWithPlane2D.END_POINT_COINCIDENT):o===F.INTERSECTION_INTERSECT&&(n===F.INTERSECTION_INSIDE?a=I.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT:n===F.INTERSECTION_OUTSIDE?a=I.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT:n===F.INTERSECTION_INTERSECT&&(a=I.relativePositionSegment3DWithPlane2D.TWO_POINTS_COINCIDENT)),a},We.prototype.getRelativePositionOfThePoint=function(e,t){void 0===t&&(t=1e-8);var r=e.x*this.a+e.y*this.b+e.z*this.c+this.d;return r<-t?F.INTERSECTION_OUTSIDE:r>t?F.INTERSECTION_INSIDE:F.INTERSECTION_INTERSECT},We.prototype.intersectionSphere=function(e){if(void 0===e||void 0===e.centerPoint)return F.INTERSECTION_OUTSIDE;var t=e.centerPoint,r=t.x*this.a+t.y*this.b+t.z*this.c+this.d;return r<-e.r?F.INTERSECTION_OUTSIDE:r<e.r?F.INTERSECTION_INTERSECT:F.INTERSECTION_INSIDE};var Xe=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.x=0,this.y=0,this.z=0,this.w=1};Xe.prototype.Modul=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},Xe.prototype.Unitary=function(){var e=this.Modul();this.x/=e,this.y/=e,this.z/=e,this.w/=e},Xe.prototype.rotationAngDeg=function(e,t,r,i){var o=e*Math.PI/180;this.rotationAngRad(o,t,r,i)},Xe.prototype.rotationAngRad=function(e,t,r,i){var o=Math.sqrt(t*t+r*r+i*i);if(!o<1e-12){var n=1/o,a=.5*e;o=Math.sin(a),this.x=t*n*o,this.y=r*n*o,this.z=i*n*o,this.w=Math.cos(a),this.Unitary()}else this.x=0,this.y=0,this.z=0,this.w=1};var Ye=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.color=new J};Ye.prototype.init=function(){this.color.r=0,this.color.g=0,this.color.b=1,this.cycle=0},Ye.prototype.getAvailableColor=function(e){return void 0===e&&(e=new J),e.setRGB(this.color.r,this.color.g,this.color.b),this.color.b+=1,this.color.b>=254&&(this.color.b=0,this.color.g+=1,this.color.g>=254&&(this.color.g=0,this.color.r+=1,this.color.r>=254&&(this.color.r=0,this.cycle+=1))),e},Ye.prototype.decodeColor3=function(e,t,r){return 64516*e+254*t+r};var qe=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._renderingSettings=new Mo,this.keepVboPositionDataArrayBuffers=!0};qe.prototype.getRenderingSettings=function(){return this._renderingSettings};var Ke=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.name,t&&(this.name=t),this.depth,this.X,this.Y,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent,this.subTiles,this.smartTileManager,this.nodeSeedsArray,this.smartTileF4dSeedArray,this.nodesFromSmartTileF4dArray,this.nodesArray,this.objectsArray,this.vectorTypeObjectsArray,this.nativeObjects={generalObjectsArray:[],excavationsArray:[],vectorTypeArray:[],lightSourcesArray:[],nativeSeedArray:[]},this.isVisible,this.distToCamera,this.mgSetArray,r&&r.smartTileManager&&(this.smartTileManager=r.smartTileManager)};Ke.prototype.deleteObjects=function(){if(this.name=void 0,this.depth=void 0,this.minGeographicCoord&&this.minGeographicCoord.deleteObjects(),this.maxGeographicCoord&&this.maxGeographicCoord.deleteObjects(),this.minGeographicCoord=void 0,this.maxGeographicCoord=void 0,this.sphereExtent&&this.sphereExtent.deleteObjects(),this.sphereExtent=void 0,this.nodeSeedsArray){for(var e=this.nodeSeedsArray.length,t=0;t<e;t++)this.nodeSeedsArray[t]=void 0;this.nodeSeedsArray=void 0}if(this.nodesArray){var r=this.nodesArray.length;for(t=0;t<r;t++)this.nodesArray[t]=void 0;this.nodesArray=void 0}if(this.isVisible=void 0,this.subTiles){var i=this.subTiles.length;for(t=0;t<i;t++)this.subTiles[t].deleteObjects(),this.subTiles[t]=void 0;this.subTiles=void 0}},Ke.prototype.newSubTile=function(e){if(e instanceof Ke){void 0===this.subTiles&&(this.subTiles=[]);var t=new Ke;return t.depth=e.depth+1,t.targetDepth=e.targetDepth,this.smartTileManager&&(t.smartTileManager=this.smartTileManager),this.subTiles.push(t),t}},Ke.prototype.clearNodesArray=function(){if(void 0!==this.nodesArray){for(var e=0;e<this.nodesArray.length;e++)this.nodesArray[e]=void 0;this.nodesArray=void 0}},Ke.prototype.getNeoBuildingById=function(e,t){var r,i=this.getNodeByBuildingId(e,t);return void 0!==i&&(r=i.data.neoBuilding),r},Ke.prototype.getBuildingSeedById=function(e,t){var r,i=!0;if(void 0===this.subTiles&&(i=!1),this.subTiles&&0===this.subTiles.length&&(i=!1),i){for(s=0;s<this.subTiles.length;s++)if(r=this.subTiles[s].getBuildingSeedById(e,t))return r}else if(this.nodeSeedsArray)for(var o,n=this.nodeSeedsArray.length,a=!1,s=0;!a&&s<n;){if(o=this.nodeSeedsArray[s].data.buildingSeed,e){if(o.buildingId===t&&o.buildingType===e)return a=!0,r=o}else if(o.buildingId===t)return a=!0,r=o;s++}return r},Ke.prototype.TEST__hasLowestTiles_nodesArray=function(){var e=[];this.extractLowestTiles(e);for(var t=e.length,r=0;r<t;){if(e[r].nodesArray&&e[r].nodesArray.length>0)return!0;r++}return!1},Ke.prototype.makeSphereExtent=function(e){this.sphereExtent=Ke.computeSphereExtent(e,this.minGeographicCoord,this.maxGeographicCoord,this.sphereExtent)},Ke.computeSphereExtent=function(e,t,r,i){if(void 0!==t&&void 0!==r){void 0===i&&(i=new Je);var o,n=(r.longitude+t.longitude)/2,a=(r.latitude+t.latitude)/2,s=(r.altitude+t.altitude)/2;return i.centerPoint=on.geographicCoordToWorldPoint(n,a,s,i.centerPoint,e),o=on.geographicCoordToWorldPoint(t.longitude,t.latitude,t.altitude,o,e),i.r=1.1*i.centerPoint.distTo(o.x,o.y,o.z),i}},Ke.prototype.calculateRectangleSize=function(e,t){var r=this.maxGeographicCoord,i=this.minGeographicCoord,o=(r.longitude+i.longitude)/2,n=(r.latitude+i.latitude)/2,a=on.geographicCoordToWorldPoint(i.longitude,n,0,a,e),s=on.geographicCoordToWorldPoint(r.longitude,n,0,s,e),l=on.geographicCoordToWorldPoint(o,i.latitude,0,l,e),u=on.geographicCoordToWorldPoint(o,r.latitude,0,u,e),c=a.distToPoint(s),d=l.distToPoint(u);return void 0===t&&(t=new Kr),t.set(c,d),t},Ke.prototype.putSmartTileF4dSeed=function(e,t,r){if(void 0===this.sphereExtent&&this.makeSphereExtent(r),this.depth<e){if(void 0===this.subTiles||0===this.subTiles.length)for(var i=0;i<4;i++)this.newSubTile(this);this.setSizesToSubTiles();var o,n=t.geographicCoord,a=!1;for(i=0;!a&&i<4;)(o=this.subTiles[i]).intersectPoint(n.longitude,n.latitude)&&(o.putSmartTileF4dSeed(e,t,r),a=!0),i++}else if(this.depth===e){void 0===this.smartTileF4dSeedArray&&(this.smartTileF4dSeedArray=[]),this.smartTileF4dSeedArray.push(t);var s=t.tileName.split(".")[0],l={};l.L=t.L,l.X=t.X,l.Y=t.Y,l.geographicCoord=t.geographicCoord,l.objectType=t.objectType,l.id=t.id,l.smartTileType=t.smartTileType,l.tileName=s+"_4.sti",l.projectFolderName=t.projectFolderName,l.fileLoadState=I.fileLoadState.READY,this.smartTileF4dSeedArray.push(l);var u={};return u.L=t.L,u.X=t.X,u.Y=t.Y,u.geographicCoord=t.geographicCoord,u.objectType=t.objectType,u.id=t.id,u.smartTileType=t.smartTileType,u.tileName=s+"_3.sti",u.projectFolderName=t.projectFolderName,u.fileLoadState=I.fileLoadState.READY,this.smartTileF4dSeedArray.push(u),!0}},Ke.prototype.putNode=function(e,t,r){if(void 0===this.sphereExtent&&this.makeSphereExtent(r),this.depth<e){if(void 0===this.subTiles||0===this.subTiles.length)for(var i=0;i<4;i++)this.newSubTile(this);var o;this.setSizesToSubTiles();var n=!1;for(i=0;!n&&i<4;)(o=this.subTiles[i]).intersectsNode(t)&&(o.putNode(e,t,r),n=!0),i++}else if(this.depth===e)return void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),void 0===this.nodesArray&&(this.nodesArray=[]),t.data.smartTileOwner=this,this.nodeSeedsArray.push(t),this.nodesArray.push(t),!0},Ke._deleteObjectFromArrayByGuid=function(e,t,r){for(var i,o=t.length,n=0;n<o;n++)if((i=t[n])._guid===e)return i.deleteObjects(r.vboMemoryManager),delete t[n],t.splice(n,1),!0;return!1},Ke.prototype.deleteNativeObjectByGuid=function(e,t){var r=this.nativeObjects;return Ke._deleteObjectFromArrayByGuid(e,r.generalObjectsArray,t)&&!0,Ke._deleteObjectFromArrayByGuid(e,r.excavationsArray,t)&&!0,Ke._deleteObjectFromArrayByGuid(e,r.vectorTypeArray,t)&&!0,Ke._deleteObjectFromArrayByGuid(e,r.lightSourcesArray,t)&&!0,!1},Ke.prototype.putObject=function(e,t,i){if(void 0===this.sphereExtent&&this.makeSphereExtent(i),this.depth<e){if(void 0===this.subTiles||0===this.subTiles.length)for(var o=0;o<4;o++)this.newSubTile(this);var n,a;if(this.setSizesToSubTiles(),t.geoLocDataManager)n=t.geoLocDataManager.getCurrentGeoLocationData().getGeographicCoords();else t.geographicCoord&&(n=t.geographicCoord);var s=!1;for(o=0;!s&&o<4;)(a=this.subTiles[o]).intersectPoint(n.longitude,n.latitude)&&(a.putObject(e,t,i),s=!0),o++}else if(this.depth===e)return t.smartTileOwner=this,t instanceof r?t.objectType===r.OBJECT_TYPE.MESH?this.nativeObjects.generalObjectsArray.push(t):t.objectType===r.OBJECT_TYPE.VECTORMESH?this.nativeObjects.vectorTypeArray.push(t):t.objectType===r.OBJECT_TYPE.LIGHTSOURCE&&this.nativeObjects.lightSourcesArray.push(t):t instanceof pe?(void 0===this.nativeObjects.pointTypeArray&&(this.nativeObjects.pointTypeArray=[]),this.nativeObjects.pointTypeArray.push(t)):t instanceof Ar?this.nativeObjects.excavationsArray.push(t):t instanceof Ee&&this.nativeObjects.nativeSeedArray.push(t),!0},Ke.prototype.makeTreeByDepth=function(e,t){if(void 0!==this.nodeSeedsArray&&0!==this.nodeSeedsArray.length&&(this.targetDepth=e,this.makeSphereExtent(t),this.depth<e)){if(void 0===this.subTiles||0===this.subTiles.length)for(var r=0;r<4;r++)this.newSubTile(this);this.setSizesToSubTiles();for(r=0;r<4;r++)this.subTiles[r].takeIntersectedBuildingSeeds(this.nodeSeedsArray);for(r=0;r<4;r++)this.subTiles[r].makeTreeByDepth(e,t)}},Ke.prototype.intersectsNode=function(e){var t,r,i=!1,o=e.data.buildingSeed,n=e.getRoot();return void 0!==n.data.bbox&&void 0!==n.data.bbox.geographicCoord?(t=n.data.bbox.geographicCoord.longitude,r=n.data.bbox.geographicCoord.latitude):void 0!==o?(t=o.geographicCoordOfBBox.longitude,r=o.geographicCoordOfBBox.latitude):(t=e.data.geographicCoord.longitude,r=e.data.geographicCoord.latitude),this.intersectPoint(t,r)&&(i=!0),i},Ke.prototype.takeIntersectedBuildingSeeds=function(e){for(var t,r=e.length,i=0;i<r;i++){var o;if(t=e[i],this.intersectsNode(t))if(e.splice(i,1),i--,r=e.length,void 0===this.nodeSeedsArray&&(this.nodeSeedsArray=[]),t.data.smartTileOwner=this,this.nodeSeedsArray.push(t),void 0!==(o=t.data.buildingSeed)){var n=o.geographicCoordOfBBox.altitude,a=o.bBox.getRadiusAprox();n-a<this.minGeographicCoord.altitude&&(this.minGeographicCoord.altitude=n-a),n+a>this.maxGeographicCoord.altitude&&(this.maxGeographicCoord.altitude=n+a)}}},Ke.prototype.intersectPoint=function(e,t){return!(e<this.minGeographicCoord.longitude||e>this.maxGeographicCoord.longitude)&&!(t<this.minGeographicCoord.latitude||t>this.maxGeographicCoord.latitude)},Ke.prototype.eraseNode=function(e){if(void 0!==this.nodeSeedsArray)for(var t=this.nodeSeedsArray.length,r=!1,i=0;!r&&i<t;)this.nodeSeedsArray[i]===e&&(this.nodeSeedsArray.splice(i,1),r=!0),i++;if(void 0!==this.nodesArray){var o=this.nodesArray.length;for(r=!1,i=0;!r&&i<o;)this.nodesArray[i]===e&&(this.nodesArray.splice(i,1),r=!0),i++}},Ke.prototype.calculateDistToCamera=function(e){var t=this.getSphereExtent();return this.distToCamera=t.distToPoint3D(e.position),this.distToCamera},Ke.prototype.extractLowestTiles=function(e,t,r){this.hasRenderables()&&(this.calculateDistToCamera(e)<Ze.maxDistToCameraByDepth(this.depth)&&(this.intersectionType=F.INTERSECTION_INSIDE,this.putSmartTileInEyeDistanceSortedArray(t,this)));if(void 0!==this.subTiles&&0!==this.subTiles.length)for(var i=this.subTiles.length,o=0;o<i;o++)this.subTiles[o].extractLowestTiles(e,t,r)},Ke.prototype.getGeographicExtent=function(e){var t=this.minGeographicCoord.longitude,r=this.minGeographicCoord.latitude,i=this.minGeographicCoord.altitude,o=this.maxGeographicCoord.longitude,n=this.maxGeographicCoord.latitude,a=this.maxGeographicCoord.altitude;return void 0===e&&(e=new xe(t,r,i,o,n,a)),e.setExtent(t,r,i,o,n,a),e},Ke.prototype.getRenderableObjects=function(e){this.nodesArray&&Array.prototype.push.apply(e.currentVisibles0,this.nodesArray),this.nativeObjects&&Array.prototype.push.apply(e.currentVisibleNativeObjects.opaquesArray,this.nativeObjects.generalObjectsArray)},Ke.prototype.extractRenderableObjects=function(e,t){if(this.hasRenderables()&&this.getRenderableObjects(t),e){if(void 0===this.subTiles||0===this.subTiles.length)return;for(var r=this.subTiles.length,i=0;i<r;i++)this.subTiles[i].extractRenderableObjects(e,t)}},Ke.prototype.getIntersectedRenderableObjectsByGeographicExtent=function(e,t){var r=[],i=[];this.getIntersectedTilesByGeographicExtent(e,r,i);for(var o=r.length,n=!0,a=0;a<o;a++){r[a].extractRenderableObjects(n,t)}var s=i.length;n=!1;for(a=0;a<s;a++){i[a].extractRenderableObjects(n,t)}},Ke.prototype.getIntersectedTilesByGeographicExtent=function(e,t,r){var i=this.getGeographicExtent().getIntersectionTypeWithGeoExtent2d(e);if(i===F.INTERSECTION_B_CONTAINS_A)t.push(this);else if(i!==F.INTERSECTION_OUTSIDE){this.hasRenderables()&&r.push(this);var o=30;if(this.smartTileManager&&(o=this.smartTileManager.maxDepth),this.subTiles&&this.subTiles.length>0&&this.depth<o)for(var n=0;n<this.subTiles.length;n++)this.subTiles[n].sphereExtent&&this.subTiles[n].getIntersectedTilesByGeographicExtent(e,t,r)}},Ke.prototype.getFrustumIntersectedLowestTiles=function(e,t,r,i){var o=[],n=[];this.getFrustumIntersectedTiles(e,t,o,n,i),r.push.apply(r,n);for(var a=o.length,s=0;s<a;s++)o[s].extractLowestTiles(e,r,i)},Ke.prototype.getFrustumIntersectedTiles=function(e,t,r,i,o){if(void 0===this.sphereExtent)return F.INTERSECTION_OUTSIDE;if(this.intersectionType=t.intersectionSphere(this.sphereExtent),this.intersectionType!==F.INTERSECTION_OUTSIDE)if(this.intersectionType!==F.INTERSECTION_INSIDE){if(this.intersectionType===F.INTERSECTION_INTERSECT){if(this.hasRenderables())this.calculateDistToCamera(e)<Ze.maxDistToCameraByDepth(this.depth)&&this.putSmartTileInEyeDistanceSortedArray(i,this);var n=30;if(this.smartTileManager&&(n=this.smartTileManager.maxDepth),this.subTiles&&this.subTiles.length>0&&this.depth<n)for(var a=0;a<this.subTiles.length;a++)this.subTiles[a].sphereExtent&&this.subTiles[a].getFrustumIntersectedTiles(e,t,r,i,o)}}else r.push(this)},Ke.prototype.getSphereIntersectedTiles=function(e,t,r){if(this.depth>r)return F.INTERSECTION_OUTSIDE;if(void 0===this.sphereExtent)return F.INTERSECTION_OUTSIDE;if(e.intersectionSphere(this.sphereExtent)===F.INTERSECTION_OUTSIDE)return F.INTERSECTION_OUTSIDE;if(this.hasRenderables()&&t.push(this),this.subTiles&&this.subTiles.length>0)for(var i=0;i<this.subTiles.length;i++)this.subTiles[i].sphereExtent&&this.subTiles[i].getSphereIntersectedTiles(e,t,r)},Ke.prototype.putSmartTileInEyeDistanceSortedArray=function(e,t){if(e.length>0){var r=e.length-1,i=on.getIndexToInsertBySquaredDistToEye(e,t,0,r);e.splice(i,0,t)}else e.push(t)},Ke.prototype.hasRenderables=function(){if(void 0!==this.nodeSeedsArray&&this.nodeSeedsArray.length>0)return!0;if(void 0!==this.nodesArray&&this.nodesArray.length>0)return!0;if(void 0!==this.smartTileF4dSeedArray&&this.smartTileF4dSeedArray.length>0)return!0;var e=this.nativeObjects;return e.generalObjectsArray.length>0||e.excavationsArray.length>0||e.vectorTypeArray.length>0||(!!(e.pointTypeArray&&e.pointTypeArray.length>0)||(!!(e.lightSourcesArray&&e.lightSourcesArray.length>0)||!!(e.nativeSeedArray&&e.nativeSeedArray.length>0)))},Ke.prototype.isNeededToCreateGeometriesFromSeeds=function(){if(void 0!==this.nodeSeedsArray){if(void 0===this.nodesArray)return!0;if(this.nodesArray.length!==this.nodeSeedsArray.length)return!0}if(void 0!==this.smartTileF4dSeedArray&&this.smartTileF4dSeedArray.length>0)for(var e=this.smartTileF4dSeedArray.length,t=0;t<e;t++)if(this.smartTileF4dSeedArray[t].fileLoadState!==I.fileLoadState.PARSE_FINISHED)return!0;return!1},Ke.prototype.setNodesAttribute=function(e,t,r){if(void 0!==e)for(var i=e.length,o=0;o<i;o++){var n=e[o];n.data&&(void 0===n.data.attributes&&(n.data.attributes={}),n.data.attributes[t]=r)}},Ke.prototype.createGeometriesFromSeeds=function(e){var t,r,i,o,n=!1;if(void 0!==this.nodeSeedsArray){void 0===this.nodesArray&&(this.nodesArray=[]);var a=this.nodeSeedsArray.length;if(a!==this.nodesArray.length){this.setNodesAttribute(this.nodeSeedsArray,"needCreated",1),this.setNodesAttribute(this.nodesArray,"needCreated",0);for(var s=0;s<a;s++)if(1===(t=this.nodeSeedsArray[s]).data.attributes.needCreated){var l=t.data.attributes;if("basicF4d"===l.objectType&&!l.fromSmartTile){if(void 0!==l.projectId&&void 0!==l.isReference&&!0===l.isReference&&Ti.manageStaticModel(t,e),void 0!==t.data.neoBuilding){this.nodesArray.push(t);continue}(r=new rr).setAttribute("keepDataArrayBuffers",!0),r.nodeOwner=t,t.data.neoBuilding=r,void 0===t.data.bbox&&(t.data.bbox=new G),i=t.data.bbox,o=t.data.buildingSeed,this.nodesArray.push(t),void 0===r.metaData&&(r.metaData=new Jt),void 0===r.metaData.geographicCoord&&(r.metaData.geographicCoord=new pe),void 0===r.metaData.bbox&&(r.metaData.bbox=new G),r.name=o.name,r.buildingId=o.buildingId,r.buildingType="basicBuilding",r.buildingFileName=o.buildingFileName,r.metaData.geographicCoord.setLonLatAlt(o.geographicCoord.longitude,o.geographicCoord.latitude,o.geographicCoord.altitude),r.metaData.bbox.copyFrom(o.bBox),i.copyFrom(o.bBox),void 0===r.bbox&&(r.bbox=new G),r.bbox.copyFrom(o.bBox),r.metaData.heading=o.rotationsDegree.z,r.metaData.pitch=o.rotationsDegree.x,r.metaData.roll=o.rotationsDegree.y,r.projectFolderName=t.data.projectFolderName,n=!0,e.emit(Fe.EVENT_TYPE.F4DRENDERREADY,{type:Fe.EVENT_TYPE.F4DRENDERREADY,f4d:t,timestamp:new Date})}}}}var u=this.distToCamera;if(void 0!==this.smartTileF4dSeedArray)for(var c=this.smartTileF4dSeedArray.length,d=0;d<c;d++){var h=this.smartTileF4dSeedArray[d];if(void 0===h.fileLoadState&&(h.fileLoadState=I.fileLoadState.READY),d>0){if(this.smartTileF4dSeedArray[d-1].fileLoadState!==I.fileLoadState.PARSE_FINISHED)break;if(u>e.magoPolicy.getLod4DistInMeters())break}if(h.fileLoadState===I.fileLoadState.READY){if(h.smartTile_parsedFromWorker);if(e.readerWriter.smartTileF4d_requested<3){var f=e.readerWriter,g=h.projectFolderName,p=h.L.toString(),m=h.X.toString(),v=h.tileName,x=f.geometryDataPath+"/"+g+"/"+p+"/"+m+"/"+v;f.getSmartTileF4d(x,h,this,e)}break}if(h.fileLoadState===I.fileLoadState.LOADING_FINISHED){var _=30;d>0&&(_=5);var y=e.parseQueue;if(y.smartTileF4dParsesCount<_){if(h.smartTile_parsedFromWorker);this._workerParseSmartTile(h,e),y.smartTileF4dParsesCount++,h.fileLoadState=I.fileLoadState.PARSE_STARTED,n=!0;break}}else if(h.fileLoadState===I.fileLoadState.PARSE_STARTED){if(h.smartTile_parsedFromWorker);var T=this.smartTileManager.parsedSmartTileMap,C=this.depth,b=this.X,M=this.Y;if(!T[C])return;if(!T[C][b])return;if(!T[C][b][M])return;if(!T[C][b][M][h.tileName])return;var A=T[C][b][M][h.tileName];this._parseSmartTileF4d(A,e),delete T[C][b][M][h.tileName],h.fileLoadState=I.fileLoadState.PARSE_FINISHED,h.smartTile_parsedFromWorker=!0}}return n},Ke.prototype.createGeometriesFromSeeds__original=function(e){var t,r,i,o,n=!1;if(void 0!==this.nodeSeedsArray){void 0===this.nodesArray&&(this.nodesArray=[]);var a=this.nodeSeedsArray.length;if(a!==this.nodesArray.length){this.setNodesAttribute(this.nodeSeedsArray,"needCreated",1),this.setNodesAttribute(this.nodesArray,"needCreated",0);for(var s=0;s<a;s++)if(1===(t=this.nodeSeedsArray[s]).data.attributes.needCreated){var l=t.data.attributes;if("basicF4d"===l.objectType&&!l.fromSmartTile){if(void 0!==l.projectId&&void 0!==l.isReference&&!0===l.isReference&&Ti.manageStaticModel(t,e),void 0!==t.data.neoBuilding){this.nodesArray.push(t);continue}(r=new rr).setAttribute("keepDataArrayBuffers",!0),r.nodeOwner=t,t.data.neoBuilding=r,void 0===t.data.bbox&&(t.data.bbox=new G),i=t.data.bbox,o=t.data.buildingSeed,this.nodesArray.push(t),void 0===r.metaData&&(r.metaData=new Jt),void 0===r.metaData.geographicCoord&&(r.metaData.geographicCoord=new pe),void 0===r.metaData.bbox&&(r.metaData.bbox=new G),r.name=o.name,r.buildingId=o.buildingId,r.buildingType="basicBuilding",r.buildingFileName=o.buildingFileName,r.metaData.geographicCoord.setLonLatAlt(o.geographicCoord.longitude,o.geographicCoord.latitude,o.geographicCoord.altitude),r.metaData.bbox.copyFrom(o.bBox),i.copyFrom(o.bBox),void 0===r.bbox&&(r.bbox=new G),r.bbox.copyFrom(o.bBox),r.metaData.heading=o.rotationsDegree.z,r.metaData.pitch=o.rotationsDegree.x,r.metaData.roll=o.rotationsDegree.y,r.projectFolderName=t.data.projectFolderName,n=!0,e.emit(Fe.EVENT_TYPE.F4DRENDERREADY,{type:Fe.EVENT_TYPE.F4DRENDERREADY,f4d:t,timestamp:new Date})}}}}var u=this.distToCamera;if(void 0!==this.smartTileF4dSeedArray)for(var c=this.smartTileF4dSeedArray.length,d=0;d<c;d++){var h=this.smartTileF4dSeedArray[d];if(void 0===h.fileLoadState&&(h.fileLoadState=I.fileLoadState.READY),d>0){if(this.smartTileF4dSeedArray[d-1].fileLoadState!==I.fileLoadState.PARSE_FINISHED)break;if(u>e.magoPolicy.getLod4DistInMeters())break}if(h.fileLoadState===I.fileLoadState.READY){if(e.readerWriter.smartTileF4d_requested<3){var f=e.readerWriter,g=h.projectFolderName,p=h.L.toString(),m=h.X.toString(),v=h.tileName,x=f.geometryDataPath+"/"+g+"/"+p+"/"+m+"/"+v;f.getSmartTileF4d(x,h,this,e)}break}if(h.fileLoadState===I.fileLoadState.LOADING_FINISHED){var _=30;d>0&&(_=5);var y=e.parseQueue;if(y.smartTileF4dParsesCount<_){this.parseSmartTileF4d(h.dataArrayBuffer,e),y.smartTileF4dParsesCount++,h.fileLoadState=I.fileLoadState.PARSE_FINISHED,n=!0;break}}}return n},Ke.prototype._workerParseSmartTile=function(e,t){var r=e.dataArrayBuffer,i=this.smartTileManager;i.workerParseSmartTile||(i.workerParseSmartTile=Ko(this.smartTileManager.magoManager.config.scriptRootPath+"Worker/workerParseSmartTile.js"),i.workerParseSmartTile.onmessage=function(e){var t=e.data.info,r=e.data.parsedSmartTile,o=i.parsedSmartTileMap;o[t.z]||(o[t.z]={}),o[t.z][t.x]||(o[t.z][t.x]={}),o[t.z][t.x][t.y]||(o[t.z][t.x][t.y]={}),o[t.z][t.x][t.y][t.tileName]||(o[t.z][t.x][t.y][t.tileName]=r)});var o={info:{x:this.X,y:this.Y,z:this.depth,tileName:e.tileName},dataArrayBuffer:r};i.workerParseSmartTile.postMessage(o,[o.dataArrayBuffer])},Ke.prototype._parseSmartTileF4d=function(e,t){var r=t.hierarchyManager;void 0===this.nodesArray&&(this.nodesArray=[]),void 0===this.sphereExtent&&this.makeSphereExtent(t);e.smartTileType;var i=e.buildingsArray,o=i.length;t.emit(Fe.EVENT_TYPE.SMARTTILELOADSTART,{tile:this,timestamp:new Date});for(var n=t.f4dController.smartTilePathInfo,a=0;a<o;a++){var s=i[a],l=s.projectId;s.projectId=void 0;var u=s.buildingId;if(s.buildingId=void 0,n[l]){var c=n[l].projectFolderPath,d=n[l].projectId,h={isPhysical:!0,objectType:"basicF4d"};c.indexOf("-tree")>0&&(h.isReference=!0,t.isExistStaticModel(d)||t.addStaticModel({projectId:d,projectFolderName:c,buildingFolderName:u}));var f=r.getNodeByDataKey(d,u);f&&(h=f.data.attributes);var g,p,m=n[l].attributes;m&&(h.isVisible=m.isVisible);var v=s.neoBuildingHeaderData;s.neoBuildingHeaderData=void 0;var x=u.startsWith("F4D_")?u.replace("F4D_",""):u;if(f){if(!h.isReference){void 0===(g=(p=f.data).neoBuilding)&&(g=new rr,p.neoBuilding=g,g.buildingFileName="F4D_"+u,g.buildingId=u,g.projectFolderName=c,g.nodeOwner=f);var _=v;void 0===g.metaData&&(g.metaData=new Jt,g.headerDataArrayBuffer=_,g.metaData.fileLoadState=I.fileLoadState.LOADING_FINISHED)}}else h.isReference||((p=(f=r.newNode(u,d,h)).data).projectFolderName=c,p.projectId=d,p.data_name=x,p.attributes=h,p.attributes.fromSmartTile=!0,p.attributes.fromDate=new Date,p.attributes.toDate=new Date,p.mapping_type="origin",g=new rr,p.neoBuilding=g,g.buildingFileName="F4D_"+u,g.buildingId=u,g.projectFolderName=c,g.nodeOwner=f,g.headerDataArrayBuffer=v,void 0===g.metaData&&(g.metaData=new Jt),g.metaData.fileLoadState=I.fileLoadState.LOADING_FINISHED);var y=s.lodString;s.lodString=void 0;var T=s.lodName;s.lodName=void 0;var C=s.lowLodMeshDataArray;s.lowLodMeshDataArray=void 0;var b=s.lodBuildingTextureData;s.lodBuildingTextureData=void 0;var M=new pe(s.longitude,s.latitude,s.altitude);s.longitude=void 0,s.latitude=void 0,s.altitude=void 0;var A=new Jr(s.rotX,s.rotY,s.rotZ);s.rotX=void 0,s.rotY=void 0,s.rotZ=void 0;var E=s.dataId;s.dataId=void 0;s.dataGroupId;s.dataGroupId=void 0;var L=s.externInfo;if(s.externInfo=void 0,s=void 0,L.heightReference){var w=L.heightReference;w=Ce.getValueByOrdinal(w),L.heightReference=w}if(h.isReference){var S=M.longitude,D=M.latitude,R=M.altitude;t.instantiateStaticModel({projectId:d,instanceId:u,longitude:S,latitude:D,height:R,heading:A.z,pitch:A.x,roll:A.y,heightReference:Ce.CLAMP_TO_GROUND});var P=r.getNodeByDataKey(d,u);for(var F in P.data.dataId=E,P.data.dataGroupId=d,P.data.projectFolderName=c,L)L.hasOwnProperty(F)&&(P.attributes.data[F]=L[F]);this.nodesArray.push(P)}else{var O=g.getOrNewLodBuilding(y),B=g.getOrNewLodMesh(T);for(var F in B.fileLoadState===I.fileLoadState.READY&&(B.fileLoadState=I.fileLoadState.LOADING_FINISHED,B.dataArrayBuffer=C),void 0===O.texture&&(O.texture=new it),O.texture.imageBinaryData=b,O.texture.fileLoadState=I.fileLoadState.LOADING_FINISHED,f.data.geographicCoord=M,f.data.rotationsDegree=A,f.data.dataId=E,f.data.dataGroupId=d,f.data.smartTileOwner=this,L)L.hasOwnProperty(F)&&(f.data.attributes[F]=L[F]);h.heightReference===Ce.RELATIVE_TO_GROUND?f.data.relativeHeight=M.altitude:f.data.relativeHeight=0,this.nodesArray.push(f)}e.buildingsArray=void 0}}t.emit(Fe.EVENT_TYPE.SMARTTILELOADEND,{tile:this,timestamp:new Date}),this.smartTile_parsedFromWorker=!0},Ke.prototype.parseSmartTileF4d=function(e,t){var r=t.hierarchyManager;void 0===this.nodesArray&&(this.nodesArray=[]),void 0===this.sphereExtent&&this.makeSphereExtent(t);var i=new TextDecoder("utf-8"),o=0,n=new Int32Array(e.slice(o,o+4))[0];o+=4;var a=new Int32Array(e.slice(o,o+4))[0];o+=4,t.emit(Fe.EVENT_TYPE.SMARTTILELOADSTART,{tile:this,timestamp:new Date});for(var s=t.f4dController.smartTilePathInfo,l=0;l<a;l++){var u,c=new Uint16Array(e.slice(o,o+2))[0];o+=2,u=i.decode(new Int8Array(e.slice(o,o+c))),o+=c;var d="";if(c=new Uint16Array(e.slice(o,o+2))[0],o+=2,d=i.decode(new Int8Array(e.slice(o,o+c))),o+=c,d=d.startsWith("F4D_")?d.substr(4,d.length-4):d,s[u]){var h=s[u].projectFolderPath,f=s[u].projectId,g={isPhysical:!0,objectType:"basicF4d"};h.indexOf("-tree")>0&&(g.isReference=!0,t.isExistStaticModel(f)||t.addStaticModel({projectId:f,projectFolderName:h,buildingFolderName:d}));var p=s[u].attributes;p&&(g.isVisible=p.isVisible);var m,v,x=r.getNodeByDataKey(f,d);x&&(g=x.data.attributes);var _=new Int32Array(e.slice(o,o+4))[0],y=o+=4,T=o+_,C=e.slice(y,T);o+=_;var b=d.startsWith("F4D_")?d.replace("F4D_",""):d;if(x){if(!g.isReference){void 0===(m=(v=x.data).neoBuilding)&&(m=new rr,v.neoBuilding=m,m.buildingFileName="F4D_"+d,m.buildingId=d,m.projectFolderName=h,m.nodeOwner=x);var M=C;void 0===m.metaData&&(m.metaData=new Jt,m.headerDataArrayBuffer=M,m.metaData.fileLoadState=I.fileLoadState.LOADING_FINISHED)}}else g.isReference||((v=(x=r.newNode(d,f,g)).data).projectFolderName=h,v.projectId=f,v.data_name=b,v.attributes=g,v.attributes.fromSmartTile=!0,v.attributes.fromDate=new Date,v.attributes.toDate=new Date,v.mapping_type="boundingboxcenter",m=new rr,v.neoBuilding=m,m.buildingFileName="F4D_"+d,m.buildingId=d,m.projectFolderName=h,m.nodeOwner=x,m.headerDataArrayBuffer=C,void 0===m.metaData&&(m.metaData=new Jt),m.metaData.fileLoadState=I.fileLoadState.LOADING_FINISHED);var A="lod5";if(2===n){var E=new Int8Array(e.slice(o,o+1))[0];o+=1,A="lod"+E.toString()}var L=new Uint16Array(e.slice(o,o+2))[0];o+=2;var w=i.decode(new Int8Array(e.slice(o,o+L)));o+=L;var S=new Int32Array(e.slice(o,o+4))[0],D=(y=o+=4,T=o+S,e.slice(y,T));o+=S;var R=new Int32Array(e.slice(o,o+4))[0],P=(y=o+=4,T=o+1*R,e.slice(y,T));o+=1*R;var F=new pe;o=F.readDataFromBuffer(e,o);var O=new Jr;o=O.readDataFromBuffer(e,o);var B=new Int32Array(e.slice(o,o+4))[0];o+=4;new Int32Array(e.slice(o,o+4))[0];o+=4;var N=new Int8Array(e.slice(o,o+1))[0];if(o+=1,N>0){var U=new Uint16Array(e.slice(o,o+2))[0];o+=2;var G=i.decode(new Int8Array(e.slice(o,o+U)));o+=U;var z=new Uint16Array(e.slice(o,o+2))[0];o+=2;i.decode(new Int8Array(e.slice(o,o+z)));o+=z,N=new Int8Array(e.slice(o,o+1))[0],o+=1}for(var H={};N>0;){U=new Uint16Array(e.slice(o,o+2))[0];o+=2;G=i.decode(new Int8Array(e.slice(o,o+U)));if(o+=U,1===N){var V=new Uint8Array(e.slice(o,o+1))[0];o+=1,H[G]=!!V}else if(2===N){var k=new Uint8Array(e.slice(o,o+1))[0];o+=1,H[G]=k}else if(3===N){var j=new Uint16Array(e.slice(o,o+2))[0];o+=2,H[G]=j}else if(4===N){var W=new Uint32Array(e.slice(o,o+4))[0];o+=4,H[G]=W}else if(5===N){var X=new Uint16Array(e.slice(o,o+2))[0];o+=2;var Y=new Uint8Array(e.slice(o,o+X));o+=X;var q=new TextDecoder("utf-8").decode(Y);H[G]=q}else if(6===N){var K=new Float32Array(e.slice(o,o+4))[0];o+=4,H[G]=K}N=new Int8Array(e.slice(o,o+1))[0],o+=1}if(H.heightReference){k=H.heightReference;k=Ce.getValueByOrdinal(k),H.heightReference=k}if(g.isReference){var Z=F.longitude,J=F.latitude,Q=F.altitude;t.instantiateStaticModel({projectId:f,instanceId:d,longitude:Z,latitude:J,height:Q,heading:O.z,pitch:O.x,roll:O.y,heightReference:Ce.CLAMP_TO_GROUND});var $=r.getNodeByDataKey(f,d);for(var ee in $.data.dataId=B,$.data.dataGroupId=f,$.data.projectFolderName=h,H)H.hasOwnProperty(ee)&&($.attributes.data[ee]=H[ee]);this.nodesArray.push($)}else{var te=m.getOrNewLodBuilding(A),re=m.getOrNewLodMesh(w);for(var ee in re.fileLoadState=I.fileLoadState.LOADING_FINISHED,re.dataArrayBuffer=D,void 0===te.texture&&(te.texture=new it),te.texture.imageBinaryData=P,te.texture.fileLoadState=I.fileLoadState.LOADING_FINISHED,x.data.geographicCoord=F,x.data.rotationsDegree=O,x.data.dataId=B,x.data.dataGroupId=f,x.data.smartTileOwner=this,H)H.hasOwnProperty(ee)&&(x.data.attributes[ee]=H[ee]);g.heightReference===Ce.RELATIVE_TO_GROUND?x.data.relativeHeight=F.altitude:x.data.relativeHeight=0,this.nodesArray.push(x)}}}t.emit(Fe.EVENT_TYPE.SMARTTILELOADEND,{tile:this,timestamp:new Date})},Ke.selectTileAngleRangeByDepth=function(e){if(!(void 0===e||e<0||e>21))return 0===e?180:1===e?90:2===e?45:3===e?22.5:4===e?11.25:5===e?5.625:6===e?2.8125:7===e?1.40625:8===e?.703125:9===e?.3515625:10===e?.17578125:11===e?.087890625:12===e?.043945313:13===e?.021972656:14===e?.010986328:15===e?.005493164:16===e?.002746582:17===e?.001373291:18===e?.0006866455:19===e?.00034332275:20===e?.000171661375:21===e?858306875e-13:void 0},Ke.selectTileName=function(e,t,r,i){var o=Ke.selectTileAngleRangeByDepth(e),n=Math.floor((t- -180)/o),a=Math.floor((90-r)/o);return e.toString()+"\\"+n.toString()+"\\"+a.toString()},Ke.selectTileIndices=function(e,t,r,i){var o=Ke.selectTileAngleRangeByDepth(e),n=Math.floor((t- -180)/o),a=Math.floor((90-r)/o);return void 0===i&&(i={}),i.L=e,i.X=n,i.Y=a,i},Ke.selectTileIndicesArray=function(e,t,r,i,o,n){var a=Ke.selectTileIndices(e,t,r,void 0),s=Ke.selectTileIndices(e,i,r,void 0),l=Ke.selectTileIndices(e,i,o,void 0),u=a.X,c=s.X,d=a.Y,h=l.Y;n||(n=[]);for(var f=u;f<=c;f++)for(var g=h;g<=d;g++){var p={L:e,X:f,Y:g};n.push(p)}return n},Ke.getParentTileOfTileLXY=function(e,t,r,i,o){return i||(i={L:0,X:0,Y:0}),o===I.imageryType.CRS84&&(i.L=e-1,i.X=Math.floor(t/2),i.Y=Math.floor(r/2)),i},Ke.getGeographicExtentOfTileLXY=function(e,t,r,i,o){if(void 0===i&&(i=new xe),o===I.imageryType.CRS84){var n=Ke.selectTileAngleRangeByDepth(e),a=n*t-180,s=n*(t+1)-180,l=90-n*(r+1),u=90-n*r;return i.setExtent(a,l,0,s,u,0),i}if(o===I.imageryType.WEB_MERCATOR){for(var c,d=Math.pow(2,e),h=d,f=360/d,g=Math.PI,p=Math.E,m=g,v=-g,x=1.4844222297453324,_=-1.4844222297453324,y=(r+5e-4)/h,T=0,C=!1;!C&&T<=22;){if(T===e){var b=f*t-180,M=b+f,A=180*_/g,E=180*x/g;i.setExtent(b,A,0,M,E,0),C=!0}else{var L=(m+v)/2;c=2*Math.atan(Math.pow(p,L))-g/2,(g-L)/(g- -g)>y?(_=c,v=L):(x=c,m=L)}T++}return i}},Ke.getFrustumIntersectedTilesNames=function(e,t,r,i,o){var n=new pe,a=new pe,s=0;return void 0===o&&(o=[]),n.setLonLatAlt(-180,-90,0),a.setLonLatAlt(0,90,0),s=0,Ke.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,s,r,n,a,i,i.boundingSphere_Aux,o),n.setLonLatAlt(0,-90,0),a.setLonLatAlt(180,90,0),s=0,Ke.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,s,r,n,a,i,i.boundingSphere_Aux,o),o},Ke.getFrustumIntersectedTilesNamesForGeographicExtent=function(e,t,r,i,o,n,a,s,l){s=Ke.computeSphereExtent(a,o,n,s);var u=e.intersectionSphere(s);if(u!==F.INTERSECTION_OUTSIDE){if(u===F.INTERSECTION_INSIDE){var c=(o.longitude+n.longitude)/2,d=(o.latitude+n.latitude)/2,h=Ke.selectTileName(r,c,d,void 0);return(f=new xe).minGeographicCoord=new pe(o.longitude,o.latitude,o.altitude),f.maxGeographicCoord=new pe(n.longitude,n.latitude,n.altitude),void(l[h]=f)}if(u===F.INTERSECTION_INTERSECT){if(i.distToSphere(s)>2e3){c=(o.longitude+n.longitude)/2,d=(o.latitude+n.latitude)/2,h=Ke.selectTileName(r,c,d,void 0);return(f=new xe).minGeographicCoord=new pe(o.longitude,o.latitude,o.altitude),f.maxGeographicCoord=new pe(n.longitude,n.latitude,n.altitude),void(l[h]=f)}if(!(r<t)){var f;c=(o.longitude+n.longitude)/2,d=(o.latitude+n.latitude)/2,h=Ke.selectTileName(r,c,d,void 0);return(f=new xe).minGeographicCoord=new pe(o.longitude,o.latitude,o.altitude),f.maxGeographicCoord=new pe(n.longitude,n.latitude,n.altitude),void(l[h]=f)}r+=1;var g=o.longitude,p=o.latitude,m=o.altitude,v=n.longitude,x=n.latitude,_=n.altitude,c=(g+v)/2,d=(p+x)/2;n.setLonLatAlt(c,d,_),this.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,r,i,o,n,a,s,l),o.setLonLatAlt(c,p,m),n.setLonLatAlt(v,d,_),this.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,r,i,o,n,a,s,l),o.setLonLatAlt(c,d,m),n.setLonLatAlt(v,x,_),this.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,r,i,o,n,a,s,l),o.setLonLatAlt(g,d,m),n.setLonLatAlt(c,x,_),this.getFrustumIntersectedTilesNamesForGeographicExtent(e,t,r,i,o,n,a,s,l)}}},Ke.prototype.getTileByTileFullPath=function(e){var t=this.depth;if(void 0===e[t+1])return this;for(var r=e[t+1].X,i=e[t+1].Y,o=void 0,n=0;n<4;n++){var a=this.subTiles[n];if(a.X===r&&a.Y===i){o=a;break}}return o?o.getTileByTileFullPath(e):void 0},Ke.getTileFullPath_fromLXY=function(e,t,r,i){if(0===e)return i;void 0===i&&(i=[]);var o=e-1,n=Math.floor(t/2),a=Math.floor(r/2);return i[o]={X:n,Y:a},Ke.getTileFullPath_fromLXY(o,n,a,i)},Ke.getTilesNamesByTargetDepth=function(e,t,r,i,o){if(!(t<e)){f=(r.longitude+i.longitude)/2,g=(r.latitude+i.latitude)/2;var n=Ke.selectTileName(t,f,g,void 0),a=new xe;return a.minGeographicCoord=new pe(r.longitude,r.latitude,r.altitude),a.maxGeographicCoord=new pe(i.longitude,i.latitude,i.altitude),void(o[n]=a)}t+=1;var s=r.longitude,l=r.latitude,u=r.altitude,c=i.longitude,d=i.latitude,h=i.altitude,f=(s+c)/2,g=(l+d)/2;i.setLonLatAlt(f,g,h),this.getTilesNamesByTargetDepth(e,t,r,i,o),r.setLonLatAlt(f,l,u),i.setLonLatAlt(c,g,h),this.getTilesNamesByTargetDepth(e,t,r,i,o),r.setLonLatAlt(f,g,u),i.setLonLatAlt(c,d,h),this.getTilesNamesByTargetDepth(e,t,r,i,o),r.setLonLatAlt(s,g,u),i.setLonLatAlt(f,d,h),this.getTilesNamesByTargetDepth(e,t,r,i,o)},Ke.prototype.getSphereExtent=function(){return this.sphereExtent},Ke.prototype.setSize=function(e,t,r,i,o,n){void 0===this.minGeographicCoord&&(this.minGeographicCoord=new pe),void 0===this.maxGeographicCoord&&(this.maxGeographicCoord=new pe),this.minGeographicCoord.setLonLatAlt(e,t,r),this.maxGeographicCoord.setLonLatAlt(i,o,n)},Ke.prototype.setSizesToSubTiles=function(){if(this.subTiles.length<4)throw new Error("When subTiles length is 4, setSizesToSubTiles is ok.");var e=this.minGeographicCoord.longitude,t=this.maxGeographicCoord.longitude,r=this.minGeographicCoord.latitude,i=this.maxGeographicCoord.latitude,o=this.minGeographicCoord.altitude,n=this.maxGeographicCoord.altitude,a=(t+e)/2,s=(i+r)/2,l=this.subTiles[0];l.setSize(e,r,o,a,s,n),l.X=2*this.X,l.Y=2*this.Y+1,(l=this.subTiles[1]).setSize(a,r,o,t,s,n),l.X=2*this.X+1,l.Y=2*this.Y+1,(l=this.subTiles[2]).setSize(a,s,o,t,i,n),l.X=2*this.X+1,l.Y=2*this.Y,(l=this.subTiles[3]).setSize(e,s,o,a,i,n),l.X=2*this.X,l.Y=2*this.Y},Ke.prototype.getId=function(){return void 0===this.id&&(this.id=this.depth.toString()+"_"+this.X.toString()+"_"+this.Y.toString()),this.id},Ke.prototype.getLongitudeRangeDegree=function(){return this.maxGeographicCoord.longitude-this.minGeographicCoord.longitude},Ke.prototype.getLatitudeRangeDegree=function(){return this.maxGeographicCoord.latitude-this.minGeographicCoord.latitude},Ke.prototype.eraseObjectByComparision=function(e,t){if(!e[t])return!1;var r=e[t];if(this.objectsArray&&Array.isArray(this.objectsArray))for(var i=0,o=this.objectsArray.length;i<o;++i)if(this.objectsArray[i][t]&&this.objectsArray[i][t]===r){this.objectsArray.splice(i,1);break}},Ke.prototype.getTileByTileFullPath=function(e){var t=this.depth;if(void 0===e[t+1])return this;for(var r=e[t+1].X,i=e[t+1].Y,o=void 0,n=0;n<4;n++){var a=this.subTiles[n];if(a.X===r&&a.Y===i){o=a;break}}return o?o.getTileByTileFullPath(e):void 0},Ke.getTileFullPath_fromLXY=function(e,t,r,i){if(0===e)return i;void 0===i&&(i=[]);var o=e-1,n=Math.floor(t/2),a=Math.floor(r/2);return i[o]={X:n,Y:a},Ke.getTileFullPath_fromLXY(o,n,a,i)};var Ze=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.tilesArray=[],this.magoManager=void 0,this.createMainTiles(),this.objectSeedsMap,this.maxDepth=17,this.parsedSmartTileMap={},t&&t.magoManager&&(this.magoManager=t.magoManager)};Ze.getDepthByBoundingBoxMaxSize=function(e){var t;if(void 0!==e)return e<5?t=18:e>=5&&e<10?t=17:e>=10&&e<30?t=16:e>=30&&e<50?t=15:e>=50&&e<100?t=14:e>=100&&e<200?t=13:e>=200&&e<400?t=12:e>=400&&e<800?t=11:e>=800&&e<1600?t=10:e>=1600&&e<3200?t=9:e>=3200&&e<6400?t=8:e>=6400&&e<12800?t=7:e>=12800&&(t=6),t>10&&(t=10),t},Ze.maxDistToCameraByDepth=function(e){return e<13?1e4:13===e?9e3:14===e?4e3:15===e?2e3:16===e?1e3:17===e?500:18===e?150:e>18?100:10},Ze.prototype.removeSmartTileF4dSeed=function(e,t,r,i){var o=[];if(o[t]={X:r,Y:i},o=Ke.getTileFullPath_fromLXY(t,r,i,o),this.tilesArray)for(var n=this.tilesArray.length,a=0;a<n;a++){var s=this.tilesArray[a].getTileByTileFullPath(o);if(s){var l=s.smartTileF4dSeedArray;if(!l)continue;for(var u=l.length,c=0;c<u;c++){if(l[c].projectFolderName===e){l.splice(c,1);break}}break}}},Ze.prototype.createMainTiles=function(){var e=this.newSmartTile("AmericaSide");void 0===e.minGeographicCoord&&(e.minGeographicCoord=new pe),void 0===e.maxGeographicCoord&&(e.maxGeographicCoord=new pe),e.depth=0,e.X=0,e.Y=0,e.minGeographicCoord.setLonLatAlt(-180,-90,0),e.maxGeographicCoord.setLonLatAlt(0,90,0);var t=this.newSmartTile("AsiaSide");void 0===t.minGeographicCoord&&(t.minGeographicCoord=new pe),void 0===t.maxGeographicCoord&&(t.maxGeographicCoord=new pe),t.depth=0,t.X=1,t.Y=0,t.minGeographicCoord.setLonLatAlt(0,-90,0),t.maxGeographicCoord.setLonLatAlt(180,90,0)},Ze.prototype.removeSmartTileF4dSeed=function(e,t,r,i){var o=[];if(o[t]={X:r,Y:i},o=Ke.getTileFullPath_fromLXY(t,r,i,o),this.tilesArray)for(var n=this.tilesArray.length,a=0;a<n;a++){var s=this.tilesArray[a].getTileByTileFullPath(o);if(s){for(var l=s.smartTileF4dSeedArray,u=l.length,c=0;c<u;c++){if(l[c].projectFolderName===e){l.splice(c,1);break}}break}}},Ze.prototype.parseSmartTilesF4dIndexFile=function(e,t,r){var i=0,o=r.readerWriter;void 0===this.smartTileF4dSeedMap&&(this.smartTileF4dSeedMap={});var n=o.readInt32(e,i,i+4);i+=4;for(var a=0;a<n;a++){var s=o.readInt16(e,i,i+2);i+=2;for(var l="",u=0;u<s;u++)l+=String.fromCharCode(new Int8Array(e.slice(i,i+1))[0]),i+=1;var c=t+"::"+l,d=o.readUInt8(e,i,i+1);i+=1;var h=o.readInt32(e,i,i+4);i+=4;var f=o.readInt32(e,i,i+4);i+=4;var g=o.readUInt8(e,i,i+1);i+=1;var p=Ke.getGeographicExtentOfTileLXY(d,h,f,void 0,I.imageryType.CRS84).getMidPoint();this.smartTileF4dSeedMap[c]={L:d,X:h,Y:f,geographicCoord:p,objectType:"F4dTile",id:"",smartTileType:g,tileName:l,projectFolderName:t,fileLoadState:I.fileLoadState.READY}}return this.smartTileF4dSeedMap},Ze.prototype.parseSmartTilesF4dIndexFileAndDeleteSmartTileF4dSeed=function(e,t,r){var i=0,o=r.readerWriter,n=o.readInt32(e,i,i+4);i+=4;for(var a=0;a<n;a++){var s=o.readInt16(e,i,i+2);i+=2;for(var l=0;l<s;l++)String.fromCharCode(new Int8Array(e.slice(i,i+1))[0]),i+=1;var u=o.readUInt8(e,i,i+1);i+=1;var c=o.readInt32(e,i,i+4);i+=4;var d=o.readInt32(e,i,i+4);i+=4;o.readUInt8(e,i,i+1);i+=1,this.removeSmartTileF4dSeed(t,u,c,d)}},Ze.prototype.makeTreeByDepth=function(e,t,r){void 0===e&&(e=17),this.targetDepth=e;for(var i=this.tilesArray.length,o=0;o<i;o++){var n=this.tilesArray[o];void 0===n.nodeSeedsArray&&(n.nodeSeedsArray=[]),n.nodeSeedsArray=t,n.makeTreeByDepth(e,r)}},Ze.prototype.putNode=function(e,t,r){if(e=Zo(e,this.maxDepth),void 0!==this.tilesArray)for(var i=this.tilesArray.length,o=0;o<i;o++)this.tilesArray[o].putNode(e,t,r)},Ze.prototype.putObject=function(e,t,r){if(e=Zo(e,this.maxDepth),void 0!==this.tilesArray)for(var i=this.tilesArray.length,o=0;o<i;o++)this.tilesArray[o].putObject(e,t,r)},Ze.prototype.getSphereIntersectedTiles=function(e,t,r){if(void 0===r&&(r=this.maxDepth),void 0!==this.tilesArray)for(var i=this.tilesArray.length,o=0;o<i;o++)this.tilesArray[o].getSphereIntersectedTiles(e,t,r)},Ze.prototype.deleteTiles=function(){if(this.tilesArray){for(var e=this.tilesArray.length,t=0;t<e;t++)this.tilesArray[t].deleteObjects(),this.tilesArray[t]=void 0;this.tilesArray.length=0}},Ze.prototype.resetTiles=function(){this.deleteTiles(),this.createMainTiles()},Ze.prototype.newSmartTile=function(e){void 0===this.tilesArray&&(this.tilesArray=[]);var t=new Ke(e,{smartTileManager:this});return this.tilesArray.push(t),t},Ze.prototype.getNeoBuildingById=function(e,t){for(var r,i=0,o=this.tilesArray.length;void 0===r&&i<o;)r=this.tilesArray[i].getNeoBuildingById(e,t),i++;return r},Ze.prototype.getBuildingSeedById=function(e,t){for(var r,i=0,o=this.tilesArray.length;void 0===r&&i<o;)r=this.tilesArray[i].getBuildingSeedById(e,t),i++;return r},Ze.prototype.getRenderableObjectsInGeographicExtent=function(e,t){var r=this.tilesArray[0],i=this.tilesArray[1];r.getIntersectedRenderableObjectsByGeographicExtent(e,t),i.getIntersectedRenderableObjectsByGeographicExtent(e,t)},Ze.prototype.doPendentProcess=function(e){if(void 0!==this.objectSeedsMap){var t=e.hierarchyManager,r=this.tilesArray.length;for(var i in this.objectSeedsMap)if(Object.prototype.hasOwnProperty.call(this.objectSeedsMap,i)){var o=this.objectSeedsMap[i],n=o.L,a=o.objectType,s=t.getNodesMap(a,void 0),l=o.id;if(""===l){var u=Object.keys(s).length;l=o.objectType+"_"+u}var c=e.hierarchyManager.newNode(l,a,void 0);c.data.attributes={objectType:"multiBuildingsTile"},c.data.geographicCoord=o.geographicCoord,c.data.bbox=o.boundingBox,c.data.projectFolderName=o.projectFolderName,c.data.multiBuildingsFolderName=o.multiBuildingsFolderName;for(var d=0;d<r;d++)this.tilesArray[d].putNode(n,c,e)}this.objectSeedsMap=void 0}if(void 0!==this.smartTileF4dSeedMap){r=this.tilesArray.length;for(var i in this.smartTileF4dSeedMap)if(Object.prototype.hasOwnProperty.call(this.smartTileF4dSeedMap,i)){var h=this.smartTileF4dSeedMap[i];for(n=h.L,d=0;d<r;d++)this.tilesArray[d].putSmartTileF4dSeed(n,h,e)}this.smartTileF4dSeedMap=void 0}};var Je=function e(t){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.r=0,this.centerPoint=new Jr,this.geoLocDataManager,this.color4,this.vboKeyContainer,this.dirty=!0,void 0!==t){var i=t.color;if(i){this.color4=new re,this.color4.setRGBA(i.r,i.g,i.b,i.a);var o=new Re("RENDER_END",function(e,t){e.color4.updateColorAlarm(t.getCurrentTime())});this.addEventListener(o)}}};Je.prototype=Object.create(r.prototype),Je.prototype.constructor=Je,Je.prototype.setCenterPoint=function(e,t,r){this.centerPoint.set(e,t,r)},Je.prototype.setRadius=function(e){this.r=e},Je.prototype.deleteObjects=function(){this.r=void 0,this.centerPoint.deleteObjects(),this.centerPoint=void 0},Je.prototype.distToPoint3D=function(e){return this.centerPoint.distToPoint(e)-this.r},Je.prototype.distToSphere=function(e){var t=e.centerPoint;return this.centerPoint.distToPoint(t)-this.r-e.r},Je.prototype.getVbo=function(e,t){var r;void 0===e&&(e=new xt);var i=(r=this.makePMesh(r)).getSurfaceIndependentMesh(void 0,!1,!1),o=new Ne;return o.rotationAxisAngDeg(90,1,0,0),i.transformByMatrix4(o),i.setColor(0,.5,.9,.3),i.calculateVerticesNormals(),void 0!==t&&!0===t&&i.calculateTexCoordsSpherical(),i.getVbo(e),e},Je.prototype.makeMesh=function(){var e=new ii,t=e.newOuterRing().newElement("ARC");this.sweepSense=1,t.setCenterPosition(0,0),t.setRadius(this.r),t.setStartAngleDegree(91),t.setSweepAngleDegree(179),t.numPointsFor360Deg=8;var r=new mi,i=new Kr(0,-1),o=new Kr(0,1);r.setPoints(i,o);var n=jr.getRevolvedSolidMesh(e,360,8,r,!1,!1,void 0);this.objectsArray.push(n),this.dirty=!1},Je.prototype.makePMesh=function(e){void 0===e&&(e=new Wr),e.profile=new Profile;var t,r,i=e.profile,o=i.newOuterRing();(t=o.newElement("POLYLINE")).newPoint2d(.01*-this.r,-this.r),t.newPoint2d(.01*-this.r,this.r);var n;r=o.newElement("ARC"),this.sweepSense=1,r.setCenterPosition(0,0),r.setRadius(this.r),r.setStartAngleDegree(95),r.setSweepAngleDegree(170),r.numPointsFor360Deg=48,n=new mi;var a=new Kr(0,-1),s=new Kr(0,1);return n.setPoints(a,s),48,e.revolve(i,360,48,n),e},Je.prototype.intersectionSphere=function(e){if(void 0===e)return F.INTERSECTION_OUTSIDE;var t=this.centerPoint.distToPoint(e.centerPoint);return t<this.r?F.INTERSECTION_INSIDE:t<e.r?F.INTERSECTION_INSIDE:t<this.r+e.r?F.INTERSECTION_INTERSECT:F.INTERSECTION_OUTSIDE};var Qe=function(){this.high=void 0,this.low=void 0},$e=function e(t){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.hotspotDeg=43,this.falloffDeg=45,this.hotDistance=30,this.falloffDistance=40,this.color=new J(1,1,1,1),this.intensity=1,void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye),this.directionLC=new Jr(0,0,-1),this.directionWC,this.localWC,this.cubeMapFBO=void 0,this._maxSpotDot,this.cullingUpdatedTime,this.options=t||{},this.options.localWC&&(this.localWC=this.options.localWC),this.options.hotspotDeg&&(this.hotspotDeg=this.options.hotspotDeg),this.options.falloffDeg&&(this.falloffDeg=this.options.falloffDeg),this.options.hotDistance&&(this.hotDistance=this.options.hotDistance),this.options.falloffDistance&&(this.falloffDistance=this.options.falloffDistance),this.setObjectType(r.OBJECT_TYPE.LIGHTSOURCE)};($e.prototype=Object.create(r.prototype)).constructor=$e,$e.prototype.setColorRGB=function(e,t,r){this.color||(this.color=new J(1,1,1,1)),this.color.setRGB(e,t,r)},$e.prototype.setLightIntensity=function(e){this.intensity=e},$e.prototype.makeMesh=function(){var e=this.falloffDeg*Math.PI/180,t=this.falloffDistance*Math.sin(e)*.98,r=this.falloffDistance*Math.cos(e)*.98,i=new Mago3D.Color(.95,.95,.95,.4),o=new Qi(t,r,{baseType:2,color:i,originType:1});this.objectsArray.push(o),this.setDirty(!1)},$e.prototype.setCullingUpdatedTime=function(e){this.cullingUpdatedTime=e},$e.prototype.getLightDirectionWC=function(){if(!this.directionWC){var e=this.getGeoLocDataManager().getCurrentGeoLocationData();this.directionWC=e.tMatrix.rotatePoint3D(this.directionLC,this.directionWC)}return this.directionWC},$e.prototype.getLightParameters=function(){return this.lightParameters||this.setLightParameters(),this.lightParameters},$e.prototype.setLightParameters=function(){this.lightParameters=new Float32Array(4),this.lightParameters[0]=this.getLightHotDistance(),this.lightParameters[1]=this.getLightFallOffDistance(),this.lightParameters[2]=this.getMaxSpotDot(),this.lightParameters[3]=this.getFalloffSpotDot()},$e.prototype.getLightHotDistance=function(){return this.hotDistance},$e.prototype.getLightFallOffDistance=function(){return this.falloffDistance},$e.prototype.getMaxSpotDot=function(){return this._maxSpotDot||this._setMaxSpotDot(),this._maxSpotDot},$e.prototype._setMaxSpotDot=function(){this._maxSpotDot=Math.cos(this.hotspotDeg*Math.PI/180)},$e.prototype.getFalloffSpotDot=function(){return this._falloffSpotDot||this._setFalloffSpotDot(),this._falloffSpotDot},$e.prototype._setFalloffSpotDot=function(){this._falloffSpotDot=Math.cos(this.falloffDeg*Math.PI/180)},$e.prototype.setHotDistance=function(e){this.hotDistance=e,this.setLightParameters()},$e.prototype.setFalloffDistance=function(e){this.falloffDistance=e,this.setDirty(!0),this.setLightParameters()},$e.prototype.setHotspotDeg=function(e){this.hotspotDeg=e,this._setMaxSpotDot(),this.setLightParameters()},$e.prototype.setFalloffDeg=function(e){this.falloffDeg=e,this._setFalloffSpotDot(),this.setDirty(!0),this.setLightParameters()},$e.prototype.clearIntersectedObjects=function(){this.visibleObjectsControler&&this.visibleObjectsControler.clear()},$e.prototype.doIntersectedObjectsCulling=function(e,t){this.cullingUpdatedTime||(this.cullingUpdatedTime=0);var r=0,i=0;e&&(r=e.length),t&&(i=t.length);var o,n,a,s=this.getBoundingSphereWC(void 0);this.visibleObjectsControler||(this.visibleObjectsControler=new _t);for(var l=0;l<r;l++)n=(o=e[l]).getBoundingSphereWC(n),s.intersectsWithBSphere(n)!==F.INTERSECTION_OUTSIDE&&this.visibleObjectsControler.currentVisibles0.push(o);for(l=0;l<i;l++)n=(a=t[l]).getBoundingSphereWC(n),s.intersectsWithBSphere(n)!==F.INTERSECTION_OUTSIDE&&this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.push(a);return this.bIntersectionCulling=!0,!0},$e.prototype.getBoundingSphereWC=function(e){void 0===e&&(e=new z);var t=this.geoLocDataManager.getCurrentGeoLocationData().tMatrix.transformPoint3D(new Jr(0,0,0),void 0),r=this.hotDistance;return e.setCenterPoint(t.x,t.y,t.z),e.setRadius(r),e},$e.prototype._getCubeMapFrameBuffer=function(e){if(!this.cubeMapFbo){this.cubeMapFbo=new ee(e,256,{})}return this.cubeMapFbo},$e.prototype._createCubeMatrix2=function(e,t,r){var i=new Ne;i._floatArrays=glMatrix.mat4.invert(i._floatArrays,t._floatArrays),this.mvMatRelToEyeArray[e]=i;var o=new Ne;o._floatArrays=glMatrix.mat4.multiply(o._floatArrays,r._floatArrays,i._floatArrays),this.mvpMatRelToEyeArray[e]=o},$e.prototype._createCubeMatrix=function(e,t,r,i,o,n,a,s,l){var u=new Jr,c=new Jr,d=new Jr,h=new Jr,f=this.hotDistance,g=new Ne,p=new Ne;c.set(t,r,i),h.set(o,n,a),d.set(u.x+c.x*f,u.y+c.y*f,u.z+c.z*f),g._floatArrays=Ne.lookAt(g._floatArrays,[u.x,u.y,u.z],[d.x,d.y,d.z],[h.x,h.y,h.z]),p._floatArrays=glMatrix.mat4.multiply(p._floatArrays,l._floatArrays,g._floatArrays);var m=new Ne;m._floatArrays=glMatrix.mat4.invert(m._floatArrays,p._floatArrays),this.mvMatRelToEyeArray[e]=m;var v=new Ne;v._floatArrays=glMatrix.mat4.multiply(v._floatArrays,s._floatArrays,m._floatArrays),this.mvpMatRelToEyeArray[e]=v},$e.prototype._createModelViewProjectionMatrixRelToEyes=function(){var e=90*Math.PI/180,t=this.getLightFallOffDistance(),r=new Ne;r._floatArrays=glMatrix.mat4.perspective(r._floatArrays,e,1,.05,t);var i=this.getGeoLocDataManager().getCurrentGeoLocationData(),o=i.geoLocMatrix,n=i.rotMatrix;o.getXAxis(),o.getYAxis(),o.getZAxis();this.mvMatRelToEyeArray||(this.mvMatRelToEyeArray=new Array(6)),this.mvpMatRelToEyeArray||(this.mvpMatRelToEyeArray=new Array(6)),this._createCubeMatrix(0,1,0,0,0,-1,0,r,n),this._createCubeMatrix(1,-1,0,0,0,-1,0,r,n),this._createCubeMatrix(3,0,1,0,0,0,1,r,n),this._createCubeMatrix(2,0,-1,0,0,0,-1,r,n),this._createCubeMatrix(4,0,0,1,0,-1,0,r,n),this._createCubeMatrix(5,0,0,-1,0,-1,0,r,n)},$e.prototype.getModelViewProjectionMatrixRelToEye=function(e){return this.mvpMatRelToEyeArray||this._createModelViewProjectionMatrixRelToEyes(),this.mvpMatRelToEyeArray[e]},$e.prototype.getModelViewMatrixRelToEye=function(e){return this.mvMatRelToEyeArray||this._createModelViewProjectionMatrixRelToEyes(),this.mvMatRelToEyeArray[e]},$e.prototype.bindCubeMapFrameBuffer=function(e,t){var r=t.getGl(),i=this._getCubeMapFrameBuffer(r);r.bindFramebuffer(r.FRAMEBUFFER,i.framebuffer[e]),r.bindRenderbuffer(r.RENDERBUFFER,i.depthBuffer),r.renderbufferStorage(r.RENDERBUFFER,r.DEPTH_COMPONENT16,i.width[0],i.width[0]),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.RENDERBUFFER,i.depthBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+e,i.colorBuffer,0)},$e.prototype.getDepthCubeMapTexture=function(e){var t=e.getGl();return this._getCubeMapFrameBuffer(t).colorBuffer};var et=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.sunGeoLocDataManager=new ye,this.lightSourcesArray,this.date,this.sunDirWC,this.bAnimation=!1,this.updated=!1;var r=this.sunGeoLocDataManager.newGeoLocationData("sunPosition"),i=(r=on.calculateGeoLocationData(115.31586919332165,10,0,void 0,void 0,void 0,r)).rotMatrix;this.sunDirWC=new Float32Array([-i._floatArrays[8],-i._floatArrays[9],-i._floatArrays[10]]),this.sunDirCC=new Float32Array([0,0,1]),this.init()};et.prototype.init=function(){void 0===this.lightSourcesArray&&(this.lightSourcesArray=[]);var e=2,t=new Le(e);t.directionalBoxWidth=400,t.geoCoord=new pe(126.61255088096084,37.58071053758259,50),this.lightSourcesArray.push(t),(t=new Le(e=2)).directionalBoxWidth=400,t.geoCoord=new pe(126.61255088096084,37.58071053758259,50),this.lightSourcesArray.push(t),void 0===this.date&&(this.date=new Date,this.date.setMonth(5),this.date.setHours(16),this.date.setMinutes(0),this.setDate(this.date))},et.prototype._getSolarDeclinationDegrees=function(){var e=this._getDaysCountFrom22December();return-23.45*Math.cos(2*Math.PI/365*e)},et.prototype._getDaysCountFrom22December=function(){var e,t=this.date,r=t.getMonth(),i=t.getDay(),o=t.getFullYear();e=12===r&&i>=22?o:o-1;var n=new Date;n.setFullYear(e),n.setMonth(12),n.setHours(0),n.setMinutes(0);var a=n.getTime();return(t.getTime()-a)/1e3/60/60/24},et.prototype._getJulianDate=function(){return this.getDate().getTime()/1e3/60/60/24},et.prototype.getDayNightLightingFactorOfPosition=function(e){var t=0,r=new Jr(e.x,e.y,e.z);r.unitary();var i=((t=r.scalarProduct(new Jr(-this.sunDirWC[0],-this.sunDirWC[1],-this.sunDirWC[2])))- -.2)/.4;return i<0&&(i=0),i>1&&(i=1),(t=i*i*(3-2*i))<.15&&(t=.15),t},et.prototype.getSunDirWC=function(){return this.sunDirWC},et.prototype.getSunDirCC=function(){return this.sunDirCC},et.prototype.getLight=function(e){if(void 0!==this.lightSourcesArray)return this.lightSourcesArray[e]},et.prototype.getLightsMatrixFloat32Array=function(){var e=this.lightSourcesArray.length;void 0===this.lightMatrixFloat32Array&&(this.lightMatrixFloat32Array=new Float32Array(16*e));for(var t=0;t<e;t++){var r=this.getLight(t).tMatrix;if(void 0!==r)for(var i=0;i<16;i++)this.lightMatrixFloat32Array[i+16*t]=r._floatArrays[i]}return this.lightMatrixFloat32Array},et.prototype.getLightsPosLOWFloat32Array=function(){var e=this.lightSourcesArray.length;void 0===this.lightPosLOWFloat32Array&&(this.lightPosLOWFloat32Array=new Float32Array(3*e));for(var t=0;t<e;t++){var r=this.getLight(t).positionLOW;if(void 0!==r)for(var i=0;i<3;i++)this.lightPosLOWFloat32Array[i+3*t]=r[i]}return this.lightPosLOWFloat32Array},et.prototype.getLightsPosHIGHFloat32Array=function(){var e=this.lightSourcesArray.length;void 0===this.lightPosHIGHFloat32Array&&(this.lightPosHIGHFloat32Array=new Float32Array(3*e));for(var t=0;t<e;t++){var r=this.getLight(t).positionHIGH;if(void 0!==r)for(var i=0;i<3;i++)this.lightPosHIGHFloat32Array[i+3*t]=r[i]}return this.lightPosHIGHFloat32Array},et.prototype.setDate=function(e){this.date=e,this.calculateSunGeographicCoords()},et.prototype.setAnimation=function(e){if(void 0!==e){this.bAnimation=!0;e.timeSpeed,e.startHour,e.startMin,e.endHour,e.endMin}},et.prototype.getDate=function(){return void 0===this.date&&(this.date=new Date,this.date.setMonth(2),this.date.setHours(15),this.date.setMinutes(0)),this.date},et.prototype.calculateSunGeographicCoords=function(){var e=180/Math.PI,t=this.getDate(),r=(t.getFullYear(),new Date(t.getFullYear(),0,0).getTime()),i=new Date(t.getFullYear()+1,0,0).getTime(),o=(t.getTime()-r)/(i-r),n=(.5-(t.getUTCMilliseconds()/1e3+t.getUTCSeconds()+60*(t.getUTCMinutes()+60*t.getUTCHours()))/86400)*Math.PI*2;n*=e;var a=.41*Math.sin((o-.22)*Math.PI*2);a*=e;var s=this.sunGeoLocDataManager.getCurrentGeoLocationData(),l=(s=on.calculateGeoLocationData(n,a,0,void 0,void 0,void 0,s)).rotMatrix;this.sunDirWC=new Float32Array([-l._floatArrays[8],-l._floatArrays[9],-l._floatArrays[10]])},et.prototype.updateSun=function(e,t){var r=this.getDate();if(this.lastUpdateTime!==r.getTime()&&(this.calculateSunGeographicCoords(),this.lastUpdateTime=r.getTime()),void 0!==this.lightSourcesArray&&void 0!==e.frustumVolumeControl){t&&t.date;var i=e.sceneState,o=i.getCamera(),n=o.position,a=o.getDirection(),s=e.frustumVolumeControl.getTotalBoundingFrustum(void 0);if(void 0!==s.bFrustumNear&&void 0!==s.bFrustumFar){var l=s.bFrustumNear,u=s.bFrustumFar,c=o.getFrustum(0).tangentOfHalfFovy[0],d=l;d<0&&(d=0);var h=u-d,f=e.getGl(),g=Math.floor(i.drawingBufferWidth[0]/2),p=Math.floor(.8*i.drawingBufferHeight[0]),m=on.calculatePixelPositionCamCoord(f,g,p,void 0,void 0,void 0,void 0,e,void 0);if(m){var v=Math.abs(m.z);v<100&&(v=100);var x=d+h;x<1&&(x=1),x>v&&(x=v);var _=this.lightSourcesArray[0],y=6*Math.abs(c*x),T=new Jr(n.x+a.x*x,n.y+a.y*x,n.z+a.z*x);void 0===_.bSphere?_.bSphere=new z(T.x,T.y,T.z,y):(_.bSphere.setCenterPoint(T.x,T.y,T.z),_.bSphere.setRadius(y)),_.lightPosWC=_.bSphere.centerPoint,_.directionalBoxWidth=_.bSphere.r,this.updateLight(_);var C=d+.9*h;C<10&&(C=10);_=this.lightSourcesArray[1],y=4*Math.abs(c*C),T=new Jr(n.x+a.x*C,n.y+a.y*C,n.z+a.z*C);void 0===_.bSphere?_.bSphere=new z(T.x,T.y,T.z,y):(_.bSphere.setCenterPoint(T.x,T.y,T.z),_.bSphere.setRadius(y)),_.lightPosWC=_.bSphere.centerPoint,_.directionalBoxWidth=2*_.bSphere.r,this.updateLight(_),this.updated=!0}}}},et.prototype.updateLight=function(e){var t=this.sunGeoLocDataManager.getCurrentGeoLocationData().getRotMatrixInv();void 0===e.tMatrix&&(e.tMatrix=new Ne);var r=e.lightPosWC,i=new Ne,o=e.directionalBoxWidth/2,n=-o,a=o,s=-o,l=o,u=-10*o,c=10*o;i._floatArrays=glMatrix.mat4.ortho(i._floatArrays,n,a,s,l,u,c),e.tMatrix=t.getMultipliedByMatrix(i,e.tMatrix),void 0===e.positionHIGH&&(e.positionHIGH=new Float32Array([0,0,0])),void 0===e.positionLOW&&(e.positionLOW=new Float32Array([0,0,0])),on.calculateSplited3fv([r.x,r.y,r.z],e.positionHIGH,e.positionLOW)};var tt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.workersManager=t,this.finishedMap={},this.maxWorkers=20,this.storeType=0};tt.prototype.isBusy=function(){return void 0===this.workersCount&&(this.workersCount=0),this.workersCount>this.maxWorkers},tt.prototype.doExtrude=function(e){void 0===this.workersCount&&(this.workersCount=0);var t=e.objectsToExtrudeArray,r=e.guid,i=e.color;i||(i=[241/255,231/255,200/255,1]);for(var o=t.length,n=new Array(o),a=0;a<o;a++){for(var s=t[a],l=s.geographicCoordsListsArray,u=l.length,c=new Array(u),d=0;d<u;d++){var h=l[d],f=ve.getNumbersArrayOfGeoCoordsList(h);c[d]=f}var g={geoCoordsNumbersArrayArray:c,height:s.height,floorHeight:s.floorHeight,color:i};n[a]=g}var p=this.workersManager.magoManager;if(!this.workerExtrudeObjects){var m=this;this.workerExtrudeObjects=Ko(p.config.scriptRootPath+"Worker/workerTenElevenExtrudeObjects.js"),this.workerExtrudeObjects.onmessage=function(e){var t=e.data.result,r=t.info.guid;m.finishedMap||(m.finishedMap={}),m.finishedMap[r]=t,m.workersCount-=1}}var v={info:{guid:r},objectsToExtrudeArrayWorker:n,geoLocation:e.geoLocation,rotation:e.rotation};this.workerExtrudeObjects.postMessage(v),this.workersCount++;this.requestdedMap||(this.requestdedMap={}),this.requestdedMap[r]=!0},tt.prototype.getResult=function(e){if(this.finishedMap&&this.finishedMap[e]){var t=this.finishedMap[e];return 0===this.storeType&&delete this.finishedMap[e],t}};var rt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._depth=0,this._numberName=1,this._terranTile_owner,this.projectsArray=[],this._BR_buildingsArray=[],this._boundingBox,this._pCloudMesh_array=[],this.position,this.radius,this.leftDown_position,this.rightDown_position,this.rightUp_position,this.leftUp_position,this.visibilityType,this.subTiles_array=[],this.terranIndexFile_readed=!1,this.empty_tile=!1,this.fileReading_started=!1,this.fileReading_finished=!1,this.fileArrayBuffer,this.fileBytesReaded=0,this.fileParsingFinished=!1,this.projectsParsed_count=0,this.current_BRProject_parsing,this.current_BRProject_parsing_state=0,this.readWriter};rt.prototype.newBRProject=function(){var e=new BRBuildingProject;return this._BR_buildingsArray.push(e),e},rt.prototype.newSubTerranTile=function(){var e=this.subTiles_array.length,t=new rt;return t._depth=this._depth+1,t._numberName=10*this._numberName+e+1,this.subTiles_array.push(t),t},rt.prototype.make4subTiles=function(){for(var e=0;e<4;e++)this.newSubTerranTile()},rt.prototype.setDimensions=function(e,t,r,i){this.longitudeMin=e,this.longitudeMax=t,this.latitudeMin=r,this.latitudeMax=i},rt.prototype.makeTree=function(e){if(this._depth<e)for(var t=0;t<4;t++)this.newSubTerranTile().makeTree(e)},rt.prototype.calculatePositionByLonLat=function(){var e=(this.longitudeMax+this.longitudeMin)/2,t=(this.latitudeMax+this.latitudeMin)/2;this.position=Cesium.Cartesian3.fromDegrees(e,t,0),this.leftDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMin,0),this.rightDown_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMin,0),this.rightUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMax,this.latitudeMax,0),this.leftUp_position=Cesium.Cartesian3.fromDegrees(this.longitudeMin,this.latitudeMax,0),this.radius=Cesium.Cartesian3.distance(this.leftDown_position,this.rightUp_position)/2*.9},rt.prototype.calculatePositionByLonLatSubTiles=function(){this.calculatePositionByLonLat();for(var e=this.subTiles_array.length,t=0;t<e;t++)this.subTiles_array[t].calculatePositionByLonLatSubTiles()},rt.prototype.parseFileHeader=function(e){var t=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=t)){var r,i=e._header,o=this.fileArrayBuffer,n=this.fileBytesReaded;void 0===this.readWriter&&(this.readWriter=new hr);for(var a=0;a<5;a++)i._version+=String.fromCharCode(new Int8Array(o.slice(n,n+1))),n+=1;i._f4d_version=2,r=this.readWriter.readInt32(o,n,n+4),n+=4;for(a=0;a<r;a++)i._global_unique_id+=String.fromCharCode(new Int8Array(o.slice(n,n+1))),n+=1;i._longitude=new Float64Array(o.slice(n,n+8))[0],n+=8,i._latitude=new Float64Array(o.slice(n,n+8))[0],n+=8,i._elevation=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.minX=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.minY=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.minZ=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.maxX=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.maxY=new Float32Array(o.slice(n,n+4))[0],n+=4,i._boundingBox.maxZ=new Float32Array(o.slice(n,n+4))[0],n+=4;var s=(i._boundingBox.maxZ-i._boundingBox.minZ)/2;i._elevation=45+s-.5;var l=!1;(i._boundingBox.maxX-i._boundingBox.minX>40||i._boundingBox.maxY-i._boundingBox.minY>40)&&(l=!0),!l&&i._boundingBox.maxZ-i._boundingBox.minZ<30&&(i.isSmall=!0);this.readWriter.readUInt8(o,n,n+1);n+=1;var u=Cesium.Cartesian3.fromDegrees(i._longitude,i._latitude,i._elevation),c=Cesium.Ellipsoid.WGS84.cartesianToCartographic(u).height;u=Cesium.Cartesian3.fromDegrees(i._longitude,i._latitude,c),e.buildingPosition=u;Cesium.EncodedCartesian3.encode(u);var d=Cesium.EncodedCartesian3.encode(u.x),h=Cesium.EncodedCartesian3.encode(u.y),f=Cesium.EncodedCartesian3.encode(u.z);e.buildingPositionHIGH=new Float32Array(3),e.buildingPositionHIGH[0]=d.high,e.buildingPositionHIGH[1]=h.high,e.buildingPositionHIGH[2]=f.high,e.buildingPositionLOW=new Float32Array(3),e.buildingPositionLOW[0]=d.low,e.buildingPositionLOW[1]=h.low,e.buildingPositionLOW[2]=f.low,this.fileBytesReaded=n}},rt.prototype.parseFileSimpleBuilding=function(e){var t=this.fileArrayBuffer.byteLength;if(!(this.fileBytesReaded>=t)){void 0===this.readWriter&&(this.readWriter=new hr);var r,i,o=this.fileBytesReaded,n=this.fileArrayBuffer;void 0===e._simpleBuilding_v1&&(e._simpleBuilding_v1=new SimpleBuildingV1);var a=e._simpleBuilding_v1,s=this.readWriter.readUInt32(n,o,o+4);o+=4;for(var l=0;l<s;l++){var u=a.newSimpleObject()._vtCacheKeys_container.newVertexTexcoordsArraysCacheKey(),c=this.readWriter.readUInt32(n,o,o+4);r=o+=4,i=o+20*c,u.verticesArrayBuffer=n.slice(r,i),o+=20*c,u._vertices_count=c}this.readWriter.readInt32(n,o,o+4);o+=4,this.fileBytesReaded=o}},rt.prototype.parseFileNailImage=function(e,t){void 0===e._simpleBuilding_v1&&(e._simpleBuilding_v1=new SimpleBuildingV1),void 0===this.readWriter&&(this.readWriter=new hr);var r=e._simpleBuilding_v1,i=this.fileBytesReaded,o=this.fileArrayBuffer,n=this.readWriter.readUInt32(o,i,i+4),a=i+=4,s=i+n;r.textureArrayBuffer=new Uint8Array(o.slice(a,s)),i+=n,this.fileBytesReaded=i},rt.prototype.parseFileAllBuildings=function(e){var t=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=t)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new hr);var r=this.fileArrayBuffer,i=this.readWriter.readInt32(r,0,4);this.fileBytesReaded+=4,0===i&&(this.empty_tile=!0);for(var o=0;o<i;o++){var n=this.fileBytesReaded;this.fileBytesReaded=n,this.current_BRProject_parsing=this.newBRProject(),this.parseFileHeader(this.current_BRProject_parsing),this.parseFileSimpleBuilding(this.current_BRProject_parsing),this.parseFileNailImage(this.current_BRProject_parsing,e)}this.fileParsingFinished=!0,this.fileArrayBuffer=null}},rt.prototype.parseFileOneBuilding=function(e,t){var r=this.fileArrayBuffer.byteLength;if(this.fileBytesReaded>=r)this.fileParsingFinished=!0;else{void 0===this.readWriter&&(this.readWriter=new hr);var i=this.readWriter.readInt32(this.fileArrayBuffer,0,4);if(this.projectsParsed_count>=i)return this.fileParsingFinished=!0,void(this.fileBytesReaded=null);0===this.current_BRProject_parsing_state&&(0===this.projectsParsed_count&&(this.fileBytesReaded=4),this.current_BRProject_parsing=this.newBRProject());var o=this.current_BRProject_parsing;0===this.current_BRProject_parsing_state?(this.parseFileHeader(o),this.current_BRProject_parsing_state=1):1===this.current_BRProject_parsing_state?t.backGround_imageReadings_count<1&&(this.parseFile_simpleBuilding_old(e,o),this.current_BRProject_parsing_state=2):2===this.current_BRProject_parsing_state&&t.backGround_imageReadings_count<1&&(this.parseFile_nailImage_old(e,o,t),this.current_BRProject_parsing_state=0,this.projectsParsed_count++,t.backGround_imageReadings_count++)}},rt.prototype.setDimensionsSubTiles=function(){var e=this.subTiles_array.length;if(4===e){var t=(this.longitudeMax+this.longitudeMin)/2,r=(this.latitudeMax+this.latitudeMin)/2;this.subTiles_array[0].setDimensions(this.longitudeMin,t,this.latitudeMin,r),this.subTiles_array[1].setDimensions(t,this.longitudeMax,this.latitudeMin,r),this.subTiles_array[2].setDimensions(t,this.longitudeMax,r,this.latitudeMax),this.subTiles_array[3].setDimensions(this.longitudeMin,t,r,this.latitudeMax);for(var i=0;i<e;i++)this.subTiles_array[i].setDimensionsSubTiles()}},rt.prototype.getSmallestTiles=function(e){if(this.subTiles_array.length>0)for(var t=0;t<this.subTiles_array.length;t++)this.subTiles_array[t].visibilityType=this.visibilityType,this.subTiles_array[t].getSmallestTiles(e);else this.empty_tile.length||e.push(this)},rt.prototype.getIntersectedSmallestTiles=function(e,t,r){var i=[];this.getIntersectedTiles(e,i,r);for(var o=i.length,n=0;n<o;n++)i[n].getSmallestTiles(t);i.length=0},rt.prototype.getIntersectedTiles=function(e,t,r){if(void 0!==this.position)if(void 0===r&&(r=new Cesium.BoundingSphere),r.radius=this.radius,r.center.x=this.position.x,r.center.y=this.position.y,r.center.z=this.position.z,this.visibilityType=e.computeVisibility(r),this.visibilityType===Cesium.Intersect.OUTSIDE);else if(this.visibilityType===Cesium.Intersect.INSIDE)t.push(this);else if(this.subTiles_array.length>0)for(var i=0;i<this.subTiles_array.length;i++)this.subTiles_array[i].getIntersectedTiles(e,t);else t.push(this)};var it=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.textureTypeName="",this.textureImageFileName="",this.textureImageFileExtension="",this.texId,this.fileLoadState=I.fileLoadState.READY,this.imageBinaryData,this.imageWidth=32,this.imageHeight=32,this.url,this.blob,this.opacity=1,this.activeTextureType=1,t&&(void 0!==t.opacity&&(this.opacity=t.opacity),void 0!==t.url&&(this.url=t.url))};it.prototype.deleteObjects=function(e){this.deleteGlObjects(e),this.textureTypeName=void 0,this.textureImageFileName=void 0,this.textureImageFileExtension=void 0,this.texId=void 0,this.fileLoadState=void 0,this.imageBinaryData=void 0,this.imageWidth=void 0,this.imageHeight=void 0,this.url=void 0,this.blob=void 0,this.opacity=void 0,this.activeTextureType=void 0},it.prototype.deleteGlObjects=function(e){e.deleteTexture(this.texId)},it.prototype.setActiveTextureType=function(e){this.activeTextureType=e},it.prototype.setOpacity=function(e){this.opacity=e},it.prototype.deleteObjects=function(e){if(this.textureTypeName=void 0,this.textureImageFileName=void 0,void 0!==this.texId)if(this.texId instanceof WebGLTexture)e.deleteTexture(this.texId);else;this.texId=void 0,this.fileLoadState=void 0,this.imageBinaryData=void 0},it.resetTexture=function(e,t,r,i,o,n){void 0===r&&(r=t.LINEAR),void 0===i&&(i=t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,e.texId),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,r),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,o,n,0,t.RGBA,t.UNSIGNED_BYTE,null),t.bindTexture(t.TEXTURE_2D,null)},it.createTexture=function(e,t,r,i,o,n,a){void 0===n&&(n=e.CLAMP_TO_EDGE),void 0===t&&(t=e.NEAREST),void 0===r&&(r=null),void 0===a&&(a=!1);var s=e.createTexture();return e.bindTexture(e.TEXTURE_2D,s),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t),r instanceof Uint8Array||r instanceof Uint8ClampedArray||null===r?e.texImage2D(e.TEXTURE_2D,0,e.RGBA,i,o,0,e.RGBA,e.UNSIGNED_BYTE,r):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,r),e.bindTexture(e.TEXTURE_2D,null),s},it._swapTextures=function(e,t){var r=e.texId;e.texId=t.texId,t.texId=r};var ot=function(t){if(tn(t))throw new Error(Ue.REQUIRED_EMPTY_ERROR("url or urlFunction"));e.call(this),this._id=qo();var r=Zo(t.maxZoom,18),i=Zo(t.minZoom,0);this._freezeAttr={maxZoom:r,minZoom:i},Object.freeze(this._freezeAttr),this._show=Zo(t.show,!0),this._opacity=Zo(t.opacity,1),t.minAltitude&&(this.minAltitude=t.minAltitude),t.maxAltitude&&(this.maxAltitude=t.maxAltitude)};ot.prototype=Object.create(e.prototype),ot.prototype.constructor=ot,ot.EVENT_TYPE={CHANGESHOW:"changeshow",CHANGEOPACITY:"changeopacity"},Object.defineProperties(ot.prototype,{maxZoom:{get:function(){return this._freezeAttr.maxZoom}},minZoom:{get:function(){return this._freezeAttr.minZoom}},show:{get:function(){return this._show},set:function(e){var t=JSON.parse(e);"boolean"==typeof t&&this._show!==t&&(this._show=t,this.emit(ot.EVENT_TYPE.CHANGESHOW,this))}},opacity:{get:function(){return this._opacity},set:function(e){this._opacity=e,this.emit(ot.EVENT_TYPE.CHANGEOPACITY,this)}}}),ot.prototype.getUrl=function(){return ln()};var nt=function(e){if(!e||!e.type)throw new Error(Ue.REQUIRED_EMPTY_ERROR("type"));this.type=e.type,this.properties=e.properties};nt.prototype.getLegendImage=function(e,t){if(this.type!==I.imageFilter.BATHYMETRY)throw new Error("This filter not support legend.");var r;switch(this.type){case I.imageFilter.BATHYMETRY:r=function(e,t,r,i){var o=i.length,n=i[o-1],a=i[0],s=n/o,l=a,u=function(e,t){var r=document.createElement("canvas");r.width=e,r.height=t;var i=r.getContext("2d");return i.fillStyle="rgba(255, 255, 255, 1.0)",i.fillRect(0,0,e,t),i.save(),r}(t,r),c=u.getContext("2d");c.fillStyle="#f1f1f1",c.fillRect(0,0,t,r);var d=c.createLinearGradient(0,0,t,0);c.font="12px Arial";for(var h=0;h<o;h++){l=h*s;var f=J.getWhiteToBlueColor_byHeight2(l,i);d.addColorStop(1/o*h,"rgba("+255*f.r+", "+255*f.g+", "+255*f.b+", 1.0)"),c.fillStyle="rgba(102, 102, 102, 1.0)",c.textAlign="center";var g=parseInt(i[h],10),p=0;p=h===o-1?20:40,o>11&&i[h].toString().length>4&&h!==o-1||c.fillText(g,(h+1)*t*(1/o)-p,.8*r+4)}return c.fillStyle=d,c.fillRect(.035*t,0,.91*t,.6*r),u.toDataURL()}}return r.call(this,this,e,t,this.properties.stepGradient)};var at=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t,this._texturesLoaded=[],this.texturesMap={}};at.handleTextureLoaded=function(e,t,r){if(void 0===r&&(r=!0),void 0!==t){var i=e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,r),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR_MIPMAP_NEAREST),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),i}},at.prototype.getTexture=function(e){if(void 0!==e&&!(e<0)&&void 0!==this._texturesLoaded[e])return this._texturesLoaded[e]},at.prototype.getOrNewTexture=function(e){if(void 0!==e&&!(e<0)){if(void 0===this._texturesLoaded[e]){var t=new it;this._texturesLoaded[e]=t}return this._texturesLoaded[e]}},at.prototype.getTextureByName=function(e){return texturesMap[e]},at.loadTexture=function(e,t,r,i){var o=new Image;t.fileLoadState=I.fileLoadState.LOADING_STARTED,o.onload=function(){var e=r.getGl();void 0===t.texId&&(t.texId=e.createTexture()),void 0===i&&(i=!1),t.imageWidth=o.width,t.imageHeight=o.height,ut(e,o,t.texId,i,{magFilter:e.NEAREST}),t.fileLoadState=I.fileLoadState.BINDING_FINISHED},o.onerror=function(){t.fileLoadState=I.fileLoadState.LOAD_FAILED},o.crossOrigin="Anonymous",o.src=e},at.newWebGlTextureByBlob=function(e,t,r){var i=URL.createObjectURL(t);r.fileLoadState=I.fileLoadState.BINDING_STARTED;var o=new Image;o.onload=function(){URL.revokeObjectURL(i),r.texId=at.handleTextureLoaded(e,o),r.fileLoadState=I.fileLoadState.BINDING_FINISHED},o.crossOrigin="Anonymous",o.src=i},at.newWebGlTextureByEmbeddedImage=function(e,t,r){var i=new Blob([t],{type:"application/octet-binary"});at.newWebGlTextureByBlob(e,i,r)};var st=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._magoManager=t,this._gl=this._magoManager.getGl(),this._textureAux_1x1,this._noiseTexture_4x4,this.texturesManager};function lt(e){return Math.log(e)/Math.log(2)%1==0}function ut(e,t,r,i,o){if(void 0===i&&(i=!0),lt(t.width)&&lt(t.height)){var n=(o=o||{}).magFilter?o.magFilter:e.LINEAR,a=o.minFilter?o.minFilter:e.LINEAR_MIPMAP_NEAREST,s=o.wrapS?o.wrapS:e.REPEAT,l=o.wrapT?o.wrapT:e.REPEAT;e.bindTexture(e.TEXTURE_2D,r),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,a),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,l),e.generateMipmap(e.TEXTURE_2D)}else{n=o.magFilter?o.magFilter:e.LINEAR,a=o.minFilter?o.minFilter:e.LINEAR_MIPMAP_NEAREST,s=o.wrapS?o.wrapS:e.REPEAT,l=o.wrapT?o.wrapT:e.REPEAT;e.bindTexture(e.TEXTURE_2D,r),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE)}e.bindTexture(e.TEXTURE_2D,null)}st.prototype.getGl=function(){return void 0===this._gl&&(this._gl=this._magoManager.getGl()),this._gl},st.prototype.getTextureAux1x1=function(){if(void 0===this._textureAux_1x1){var e=this.getGl();this._textureAux_1x1=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._textureAux_1x1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([150,150,150,255])),e.bindTexture(e.TEXTURE_2D,null)}return this._textureAux_1x1},st.prototype.getCubeMapAux1x1=function(){if(!this._cubeMapAux_1x1){var e=this.getGl();this._cubeMapAux_1x1=e.createTexture(),e.bindTexture(e.TEXTURE_CUBE_MAP,this._cubeMapAux_1x1);for(var t=0;t<6;t++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,null)}return this._cubeMapAux_1x1},st.prototype.getNoiseTexture4x4=function(){if(void 0===this._noiseTexture_4x4){var e=this.getGl();this._noiseTexture_4x4=function(e,t,r,i){var o=e.createTexture();if(e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,o),void 0===i&&(i=new Uint8Array(64)),4===t&&4===r){var n=0;i[n]=50,i[++n]=58,i[++n]=229,i[++n]=120,i[++n]=212,i[++n]=236,i[++n]=251,i[++n]=148,i[++n]=75,i[++n]=92,i[++n]=246,i[++n]=59,i[++n]=197,i[++n]=95,i[++n]=235,i[++n]=216,i[++n]=130,i[++n]=124,i[++n]=215,i[++n]=154,i[++n]=25,i[++n]=41,i[++n]=221,i[++n]=146,i[++n]=187,i[++n]=217,i[++n]=130,i[++n]=199,i[++n]=142,i[++n]=112,i[++n]=61,i[++n]=135,i[++n]=67,i[++n]=125,i[++n]=159,i[++n]=153,i[++n]=215,i[++n]=49,i[++n]=49,i[++n]=69,i[++n]=126,i[++n]=168,i[++n]=61,i[++n]=215,i[++n]=21,i[++n]=93,i[++n]=183,i[++n]=1,i[++n]=125,i[++n]=44,i[++n]=22,i[++n]=130,i[++n]=197,i[++n]=118,i[++n]=109,i[++n]=23,i[++n]=195,i[++n]=4,i[++n]=148,i[++n]=245,i[++n]=124,i[++n]=125,i[++n]=185,i[++n]=28,n++}else for(var a=0;a<r;a++)for(var s=0;s<t;s++)i[4*(a*t+s)+0]=Math.floor(255*Math.random()),i[4*(a*t+s)+1]=Math.floor(255*Math.random()),i[4*(a*t+s)+2]=Math.floor(255*Math.random()),i[4*(a*t+s)+3]=Math.floor(255*Math.random());return e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,r,0,e.RGBA,e.UNSIGNED_BYTE,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.REPEAT),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.REPEAT),e.bindTexture(e.TEXTURE_2D,null),o.width=t,o.height=r,o}(e,4,4,void 0)}return this._noiseTexture_4x4};var ct=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vertexMatrix=new Di,this.vertexList=this.vertexMatrix.newVertexList(),this.triSurfacesArray=[]};ct.prototype.newTriSurface=function(){var e=new dt;return this.triSurfacesArray.push(e),e},ct.prototype.invertTrianglesSenses=function(){for(var e=this.triSurfacesArray.length,t=0;t<e;t++)this.triSurfacesArray[t].invertTrianglesSenses()},ct.prototype.getVBOArrayModePosNorCol=function(e,t){void 0===e&&(e=new vt),void 0===e.posVboDataArray&&(e.posVboDataArray=[]),void 0===e.norVboDataArray&&(e.norVboDataArray=[]),void 0===e.colVboDataArray&&(e.colVboDataArray=[]);var r,i,o,n,a,s,l=[],u=[],c=[];e.vertexCount=0;for(var d=this.triSurfacesArray.length,h=0;h<d;h++){a=(s=this.triSurfacesArray[h]).trianglesArray.length;for(var f=0;f<a;f++)void 0===(n=s.trianglesArray[f]).normal&&n.calculatePlaneNormal(),r=n.vertex0,i=n.vertex1,o=n.vertex2,l.push(r.point3d.x),l.push(r.point3d.y),l.push(r.point3d.z),l.push(i.point3d.x),l.push(i.point3d.y),l.push(i.point3d.z),l.push(o.point3d.x),l.push(o.point3d.y),l.push(o.point3d.z),u.push(n.normal.x),u.push(n.normal.y),u.push(n.normal.z),u.push(n.normal.x),u.push(n.normal.y),u.push(n.normal.z),u.push(n.normal.x),u.push(n.normal.y),u.push(n.normal.z),void 0===r.color4?(c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200),c.push(200)):(c.push(r.color4.r),c.push(r.color4.g),c.push(r.color4.b),c.push(r.color4.a),c.push(i.color4.r),c.push(i.color4.g),c.push(i.color4.b),c.push(i.color4.a),c.push(o.color4.r),c.push(o.color4.g),c.push(o.color4.b),c.push(o.color4.a)),e.vertexCount+=3}var g=e.vertexCount,p=new Float32Array(3*g);p.set(l);var m=new Int8Array(3*g);m.set(u);var v=new Uint8Array(4*g);return v.set(c),e.setDataArrayPos(p,t),e.setDataArrayNor(m,t),e.setDataArrayCol(v,t),e};var dt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vertexList,this.trianglesArray,this.trianglesList};dt.prototype.newTriangle=function(){void 0===this.trianglesArray&&(this.trianglesArray=[]);var e=new bi;return this.trianglesArray.push(e),e},dt.prototype.invertTrianglesSenses=function(){for(var e=this.trianglesArray.length,t=0;t<e;t++)this.trianglesArray[t].invertSense()};var ht=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.dataArray,this.dataLength,this.dataGlType,this.key,this.dataTarget,this.dataTarget=void 0!==t?t:34962,this.dataDimensions,this.dataStride=0,this.dataOffSet=0,this.normalized=!1,this.id,this.bKeepDataArray=!1,r&&void 0!==r.bKeepDataArray&&(this.bKeepDataArray=r.bKeepDataArray),this.attribLocation};ht.prototype.deleteGlObjects=function(e){if(void 0!==this.key&&e&&e.gl){var t=e.gl;this.dataTarget===t.ARRAY_BUFFER?e.storeClassifiedBufferKey(t,this.key,this.dataLength):this.dataTarget===t.ELEMENT_ARRAY_BUFFER&&e.storeClassifiedElementKey(t,this.key,this.dataLength)}this.dataArray=void 0,this.dataLength=void 0,this.dataGlType=void 0,this.key=void 0,this.dataTarget=void 0},ht.prototype.setDataArray=function(e,t,r,i,o){if(void 0!==e){this.dataGlType=ht.getGlTypeOfArray(e);var n=e.length,a=n;i.enableMemoryManagement?(a=i.getClassifiedBufferSize(n),this.dataArray=ht.newTypedArray(a,this.dataGlType),this.dataArray.set(e)):this.dataArray=e,5126!==this.dataGlType&&(r=!0),this.dataLength=n,this.dataDimensions=t,this.normalized=r,this.attribLocation=o}},ht.prototype.bindData=function(e,t,r){if(void 0===e)return!1;var i=e.gl;return!!this.isReady(i,r)&&(e.enableVertexAttribArray(t)?(this.key!==e.lastVboKeyBindedMap[t]&&(i.bindBuffer(this.dataTarget,this.key),i.vertexAttribPointer(t,this.dataDimensions,this.dataGlType,this.normalized,this.dataStride,this.dataOffSet),e.lastVboKeyBindedMap[t]=this.key),!0):(e.disableVertexAttribArray(t),!1))},ht.prototype.isReady=function(e,t){return void 0!==this.key||void 0!==this.dataArray&&(void 0===this.dataLength&&(this.dataLength=this.dataArray.length),this.key=t.getClassifiedBufferKey(e,this.dataLength),void 0!==this.key&&(e.bindBuffer(this.dataTarget,this.key),e.bufferData(this.dataTarget,this.dataArray,e.STATIC_DRAW),this.bKeepDataArray||(this.dataArray=void 0),!0))},ht.getGlTypeOfArray=function(e){var t=-1;return e.constructor===Float32Array?t=5126:e.constructor===Int32Array?t=5124:e.constructor===Uint32Array?t=5125:e.constructor===Int16Array?t=5122:e.constructor===Uint16Array?t=5123:e.constructor===Int8Array?t=5120:e.constructor===Uint8Array&&(t=5121),t},ht.newTypedArray=function(e,t){var r;return 5126===t?r=new Float32Array(e):5122===t?r=new Int16Array(e):5123===t?r=new Uint16Array(e):5120===t?r=new Int8Array(e):5121===t?r=new Uint8Array(e):5124===t?r=new Int32Array(e):5125===t&&(r=new Uint32Array(e)),r},ht.getByteSizeByGlType=function(e){return 5126===e?4:5122===e?2:5123===e?2:5120===e?1:5121===e?1:void 0};var ft=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var i;this.vboKeysStoreMap={},this.bufferSizes=t,this.minSize=r,this.maxSize=t[t.length-1],this.totalBytesUsed=0;for(var o=t.length,n=0;n<o;n++)i=new gt(t[n]),this.vboKeysStoreMap[t[n]]=i,t[n]>this.maxSize&&(this.maxSize=t[n])};ft.prototype.getClassifiedBufferKey=function(e,t,r,i){var o=this.getClosestBufferSize(t),n=this.vboKeysStoreMap[o];return n?n.getBufferKey(e,this,r,i):-1},ft.prototype.storeClassifiedBufferKey=function(e,t){var r=this.vboKeysStoreMap[t];r&&r.storeBufferKey(e)},ft.prototype.getClosestBufferSize=function(e){if(!this.isInsideRange(e))return-1;for(var t=this.bufferSizes.length,r=0;r<t;r++)if(e<=this.bufferSizes[r])return this.bufferSizes[r];return-1},ft.prototype.isInsideRange=function(e){return!(e>this.maxSize||e<this.minSize)};var gt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.classifiedSize=t,this.vboKeysArray=[],this.keysCreated=0};gt.prototype.getBufferKey=function(e,t,r,i){if(this.vboKeysArray.length>0)return o=this.vboKeysArray.pop();if(!i){var o=e.createBuffer();return this.keysCreated+=1,t.totalBytesUsed+=this.classifiedSize,r.totalBytesUsed+=this.classifiedSize,o}},gt.prototype.storeBufferKey=function(e){this.vboKeysArray.push(e)};var pt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.totalBytesUsed=0,this.bytesLimit=1e3,this.vboKeysNationsArray=[],this.vboKeyNation12to128=new ft(new Uint32Array([12,16,32,48,64,76,92,128]),0),this.vboKeysNationsArray.push(this.vboKeyNation12to128),this.vboKeyNation200to1000=new ft(new Uint32Array([200,300,400,500,600,700,800,900,1e3]),129),this.vboKeysNationsArray.push(this.vboKeyNation200to1000),this.vboKeyNation1500to6000=new ft(new Uint32Array([1500,2e3,2500,3e3,3500,4e3,4500,5e3,5500,6e3]),1001),this.vboKeysNationsArray.push(this.vboKeyNation1500to6000),this.vboKeyNation7000to16000=new ft(new Uint32Array([7e3,8e3,9e3,1e4,11e3,12e3,13e3,14e3,15e3,16e3]),6001),this.vboKeysNationsArray.push(this.vboKeyNation7000to16000),this.vboKeyNation20000to56000=new ft(new Uint32Array([2e4,24e3,28e3,32e3,36e3,4e4,44e3,48e3,52e3,56e3]),16001),this.vboKeysNationsArray.push(this.vboKeyNation20000to56000),this.vboKeyNation60000to150000=new ft(new Uint32Array([6e4,7e4,8e4,9e4,1e5,11e4,12e4,13e4,14e4,15e4]),56001),this.vboKeysNationsArray.push(this.vboKeyNation60000to150000),this.vboKeyNation200000to1100000=new ft(new Uint32Array([2e5,3e5,4e5,5e5,6e5,7e5,8e5,9e5,1e6,11e5]),150001),this.vboKeysNationsArray.push(this.vboKeyNation200000to1100000),this.vboKeyNation1500000to3000000=new ft(new Uint32Array([15e5,2e6,25e5,3e6,6e6,12e6,24e6,36e6,6e7]),1100001),this.vboKeysNationsArray.push(this.vboKeyNation1500000to3000000)};pt.prototype.getClassifiedBufferKey=function(e,t){var r=!1;this.totalBytesUsed>this.bytesLimit&&(r=!0);var i=this.getKeyNationBySize(t),o=void 0;return i&&(o=i.getClassifiedBufferKey(e,t,this,r)),o},pt.prototype.storeClassifiedBufferKey=function(e,t){var r=this.getKeyNationBySize(t);r&&r.storeClassifiedBufferKey(e,t)},pt.prototype.getKeyNationBySize=function(e){for(var t=this.vboKeysNationsArray.length,r=0;r<t;){if(this.vboKeysNationsArray[r].isInsideRange(e))return this.vboKeysNationsArray[r];r++}return-1},pt.prototype.getClassifiedBufferSize=function(e){var t=this.getKeyNationBySize(e),r=-1;return-1!==t&&(r=t.getClosestBufferSize(e)),r};var mt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl,this.enableMemoryManagement=Zo(t.enableMemoryManagement,!1),this.buffersKeyWorld=new pt,this.elementKeyWorld=new pt,this.buffersKeyWorld.bytesLimit=8e8,this.elementKeyWorld.bytesLimit=3e8,this.currentMemoryUsage=0};mt.prototype.isGpuMemFull=function(){return this.buffersKeyWorld.totalBytesUsed>this.buffersKeyWorld.bytesLimit||this.elementKeyWorld.totalBytesUsed>this.elementKeyWorld.bytesLimit},mt.prototype.getClassifiedBufferKey=function(e,t){if(this.enableMemoryManagement){var r=this.buffersKeyWorld.getClassifiedBufferKey(e,t);return void 0!==r&&(this.currentMemoryUsage+=t),r}return this.currentMemoryUsage+=t,e.createBuffer()},mt.prototype.storeClassifiedBufferKey=function(e,t,r){this.enableMemoryManagement?this.buffersKeyWorld.storeClassifiedBufferKey(t,r):e.deleteBuffer(t),this.currentMemoryUsage-=r,this.currentMemoryUsage<0&&(this.currentMemoryUsage=0)},mt.prototype.getClassifiedElementKey=function(e,t){return this.enableMemoryManagement?this.elementKeyWorld.getClassifiedBufferKey(e,t):e.createBuffer()},mt.prototype.storeClassifiedElementKey=function(e,t,r){this.enableMemoryManagement?this.elementKeyWorld.storeClassifiedBufferKey(t,r):e.deleteBuffer(t)},mt.prototype.getClassifiedBufferSize=function(e){return this.enableMemoryManagement?this.buffersKeyWorld.getClassifiedBufferSize(e):e};var vt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.indicesCount=-1,this.vertexCount=-1,this.bigTrianglesIndicesCount=-1,this.vboBufferPos,this.vboBufferNor,this.vboBufferIdx,this.vboBufferCol,this.vboBufferTCoord,this.vboBufferCustomMap,this.keepDataArrayBuffers,this.keepedColDataArray,this.keepedIdxDataArray,this.keepedNorDataArray,this.keepedPosDataArray,this.keepedTexCoordDataArray};vt.prototype.setKeepDataArray=function(e){this.keepDataArrayBuffers=e},vt.prototype.stepOverPosNorIdx=function(e,t,r,i){var o=t.readUInt32(e,i,i+4),n=3*o;i+=4,i+=4*n;var a=3*(o=t.readUInt32(e,i,i+4));i+=4,i+=1*a;var s=t.readUInt32(e,i,i+4);i+=4;var l=t.readUInt8(e,i,i+1);i+=1;for(var u=0;u<l;u++)i+=4;for(u=0;u<l;u++)i+=4;return i,i+2*s,i+=2*s},vt.prototype.readPositions=function(e,t,r){var i=new Uint16Array(e.slice(r,r+2))[0];r+=2;var o=new Uint8Array(e.slice(r,r+1))[0];r+=1;var n=new Uint32Array(e.slice(r,r+4))[0]*o,a=r+=4,s=ht.getByteSizeByGlType(i),l=r+s*n,u=new Float32Array(e.slice(a,l));return r+=s*n,this.setDataArrayPos(u,t),r},vt.prototype.readNormals=function(e,t,r){var i=new Uint16Array(e.slice(r,r+2))[0];r+=2;var o=new Uint8Array(e.slice(r,r+1))[0];r+=1;var n=new Uint32Array(e.slice(r,r+4))[0]*o,a=r+=4,s=ht.getByteSizeByGlType(i),l=r+s*n,u=new Int8Array(e.slice(a,l));return r+=s*n,this.setDataArrayNor(u,t),r},vt.prototype.readTexCoords=function(e,t,r){var i=new Uint16Array(e.slice(r,r+2))[0];r+=2;var o=new Uint8Array(e.slice(r,r+1))[0];r+=1;var n=new Uint32Array(e.slice(r,r+4))[0]*o,a=r+=4,s=ht.getByteSizeByGlType(i),l=r+s*n,u=new Float32Array(e.slice(a,l));return r+=s*n,this.setDataArrayTexCoord(u,t),r},vt.prototype.readColors=function(e,t,r){var i=new Uint16Array(e.slice(r,r+2))[0];r+=2;var o=new Uint8Array(e.slice(r,r+1))[0];r+=1;var n=new Uint32Array(e.slice(r,r+4))[0]*o,a=r+=4,s=ht.getByteSizeByGlType(i),l=r+s*n,u=new Int8Array(e.slice(a,l));return r+=s*n,this.setDataArrayCol(u,t),r},vt.prototype.readPosNorIdx=function(e,t,r){var i,o,n=new Uint32Array(e.slice(r,r+4))[0];r+=4,this.vertexCount=n;var a=3*n;i=r,o=r+4*a;var s=new Float32Array(e.slice(i,o));this.setDataArrayPos(s,t),r+=4*a;var l=3*(n=new Uint32Array(e.slice(r,r+4))[0]);i=r+=4,o=r+1*l;var u=new Int8Array(e.slice(i,o));this.setDataArrayNor(u,t),r+=1*l;var c=new Uint32Array(e.slice(r,r+4))[0];r+=4;var d=new Uint8Array(e.slice(r,r+1))[0];r+=1;for(var h=[],f=0;f<d;f++)h.push(new Float32Array(e.slice(r,r+4))),r+=4;var g=[];for(f=0;f<d;f++)g.push(new Uint32Array(e.slice(r,r+4))),r+=4;var p=g[d-1];this.bigTrianglesIndicesCount=p,i=r,o=r+2*c;var m=new Uint16Array(e.slice(i,o));return this.setDataArrayIdx(m,t),r+=2*c},vt.prototype.bindDataCustom=function(e,t,r,i){if(void 0===e||void 0===this.vboBufferCustomMap)return!1;var o=this.vboBufferCustomMap[r];return void 0!==i&&(o.attribLocation=i),o.bindData(e,o.attribLocation,t)},vt.prototype.bindDataPosition=function(e,t){return void 0!==e&&this.vboBufferPos.bindData(e,e.position3_loc,t)},vt.prototype.bindDataNormal=function(e,t){if(void 0===e)return!1;var r=this.vboBufferNor;return void 0===r?(e.disableVertexAttribArray(e.normal3_loc),!0):r.bindData(e,e.normal3_loc,t)},vt.prototype.bindDataTexCoord=function(e,t){if(void 0===e)return!1;var r=this.vboBufferTCoord;return void 0===r?(e.disableVertexAttribArray(e.texCoord2_loc),!0):r.bindData(e,e.texCoord2_loc,t)},vt.prototype.bindDataColor=function(e,t){if(void 0===e)return!1;var r=this.vboBufferCol;return void 0===r?(e.disableVertexAttribArray(e.color4_loc),!0):r.bindData(e,e.color4_loc,t)},vt.prototype.bindDataIndice=function(e,t){if(void 0===e)return!1;var r=e.gl,i=this.vboBufferIdx;return!!i.isReady(r,t)&&(i.key!==e.lastVboKeyBindedMap.elemIdx&&(r.bindBuffer(i.dataTarget,i.key),e.lastVboKeyBindedMap.elemIdx=i.key),!0)},vt.prototype.getVboCustom=function(e){if(void 0!==this.vboBufferCustomMap)return this.vboBufferCustomMap[e]},vt.prototype.setDataArrayCustom=function(e,t,r,i,o){if(void 0!==e&&void 0!==r&&void 0!==i&&void 0!==o){void 0===this.vboBufferCustomMap&&(this.vboBufferCustomMap={});var n=t.gl,a=new ht(n.ARRAY_BUFFER);a.setDataArray(e,r,!1,t,o),this.vboBufferCustomMap[i]=a}},vt.prototype.setDataArrayPos=function(e,t,r,i){if(void 0!==e){var o=t.gl;void 0===this.vboBufferPos&&(this.vboBufferPos=new ht(o.ARRAY_BUFFER)),void 0===r&&(r=3);this.vboBufferPos.setDataArray(e,r,!1,t),this.vertexCount=this.vboBufferPos.dataLength/r,this.keepDataArrayBuffers&&(this.keepedPosDataArray=e)}},vt.prototype.setDataArrayNor=function(e,t){if(void 0!==e){var r=t.gl;void 0===this.vboBufferNor&&(this.vboBufferNor=new ht(r.ARRAY_BUFFER));this.vboBufferNor.setDataArray(e,3,!0,t),this.keepDataArrayBuffers&&(this.keepedNorDataArray=e)}},vt.prototype.setDataArrayIdx=function(e,t){if(void 0!==e){var r=t.gl;void 0===this.vboBufferIdx&&(this.vboBufferIdx=new ht(r.ELEMENT_ARRAY_BUFFER));this.vboBufferIdx.setDataArray(e,1,!1,t),this.indicesCount=this.vboBufferIdx.dataLength,this.keepDataArrayBuffers&&(this.keepedIdxDataArray=e)}},vt.prototype.setDataArrayCol=function(e,t){if(void 0!==e){var r=t.gl;void 0===this.vboBufferCol&&(this.vboBufferCol=new ht(r.ARRAY_BUFFER));this.vboBufferCol.setDataArray(e,4,!0,t),this.keepDataArrayBuffers&&(this.keepedColDataArray=e)}},vt.prototype.setDataArrayTexCoord=function(e,t){if(void 0!==e){var r=t.gl;void 0===this.vboBufferTCoord&&(this.vboBufferTCoord=new ht(r.ARRAY_BUFFER));this.vboBufferTCoord.setDataArray(e,2,!1,t),this.keepDataArrayBuffers&&(this.keepedTexCoordDataArray=e)}},vt.prototype.deleteGlObjects=function(e,t){void 0!==this.vboBufferPos&&(this.vboBufferPos.deleteGlObjects(t),this.vboBufferPos=void 0),void 0!==this.vboBufferNor&&(this.vboBufferNor.deleteGlObjects(t),this.vboBufferNor=void 0),void 0!==this.vboBufferIdx&&(this.vboBufferIdx.deleteGlObjects(t),this.vboBufferIdx=void 0),void 0!==this.vboBufferCol&&(this.vboBufferCol.deleteGlObjects(t),this.vboBufferCol=void 0),void 0!==this.vboBufferTCoord&&(this.vboBufferTCoord.deleteGlObjects(t),this.vboBufferTCoord=void 0),this.keepedColDataArray=void 0,this.keepedIdxDataArray=void 0,this.keepedNorDataArray=void 0,this.keepedPosDataArray=void 0,this.keepedTexCoordDataArray=void 0};var xt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vboCacheKeysArray=[]};xt.prototype.newVBOVertexIdxCacheKey=function(){void 0===this.vboCacheKeysArray&&(this.vboCacheKeysArray=[]);var e=new vt;return this.vboCacheKeysArray.push(e),e},xt.prototype.deleteGlObjects=function(e,t){if(void 0!==this.vboCacheKeysArray){for(var r=this.vboCacheKeysArray.length,i=0;i<r;i++)this.vboCacheKeysArray[i].deleteGlObjects(e,t),this.vboCacheKeysArray[i]=void 0;this.vboCacheKeysArray.length=0,this.vboCacheKeysArray=void 0}},xt.prototype.getVbosCount=function(){return void 0===this.vboCacheKeysArray?0:this.vboCacheKeysArray.length},xt.prototype.getVboKey=function(e){if(void 0!==this.vboCacheKeysArray)return this.vboCacheKeysArray[e]};var _t=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisibles0Transparents=[],this.currentVisibles1Transparents=[],this.currentVisibles2Transparents=[],this.currentVisibles3Transparents=[],this.currentVisiblesAux=[],this.currentVisiblesPT10=[],this.currentVisibleNativeObjects={opaquesArray:[],transparentsArray:[],excavationsArray:[],vectorTypeArray:[],pointTypeArray:[],lightSourcesArray:[]},this.currentVisiblesToPrepare=[],this.mgSetsArray=[],this.bSphere,this.bFrustumNear,this.bFrustumFar};function we(){return(we=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e}).apply(this,arguments)}_t.prototype.initArrays=function(){this.currentVisibles0=[],this.currentVisibles1=[],this.currentVisibles2=[],this.currentVisibles3=[],this.currentVisibles0Transparents=[],this.currentVisibles1Transparents=[],this.currentVisibles2Transparents=[],this.currentVisibles3Transparents=[],this.currentVisiblesAux=[],this.currentVisiblesPT10=[],this.currentVisibleNativeObjects={opaquesArray:[],transparentsArray:[],excavationsArray:[],vectorTypeArray:[],pointTypeArray:[],lightSourcesArray:[]},this.currentVisiblesToPrepare=[],this.mgSetsArray=[],this.bSphere=void 0,this.bFrustumNear=void 0,this.bFrustumFar=void 0},_t.prototype.clear=function(){this.currentVisibles0.length=0,this.currentVisibles1.length=0,this.currentVisibles2.length=0,this.currentVisibles3.length=0,this.currentVisibles0Transparents.length=0,this.currentVisibles1Transparents.length=0,this.currentVisibles2Transparents.length=0,this.currentVisibles3Transparents.length=0,this.currentVisiblesAux.length=0,this.currentVisiblesPT10.length=0,this.currentVisibleNativeObjects.opaquesArray.length=0,this.currentVisibleNativeObjects.transparentsArray.length=0,this.currentVisibleNativeObjects.excavationsArray.length=0,this.currentVisibleNativeObjects.vectorTypeArray.length=0,this.currentVisibleNativeObjects.pointTypeArray.length=0,this.currentVisibleNativeObjects.lightSourcesArray.length=0,this.currentVisiblesToPrepare.length=0,this.mgSetsArray.length=0,this.bSphere=void 0,this.bFrustumNear=void 0,this.bFrustumFar=void 0},_t.prototype.getOpaquesTransparentsByLod=function(e){return 0===e?[].concat(this.currentVisibles0,this.currentVisibles0Transparents):2===e?[].concat(this.currentVisibles2,this.currentVisibles2Transparents):3===e?[].concat(this.currentVisibles3,this.currentVisibles3Transparents):void 0},_t.prototype.getAllVisibles=function(){return[].concat(this.currentVisibles0,this.currentVisibles1,this.currentVisibles2,this.currentVisibles3,this.currentVisibles0Transparents,this.currentVisibles1Transparents,this.currentVisibles2Transparents,this.currentVisibles3Transparents,this.currentVisiblesAux,this.currentVisiblesPT10)},_t.prototype.get01Visibles=function(){return[].concat(this.currentVisibles0,this.currentVisibles1)},_t.prototype.hasRenderables=function(){return this.currentVisibles0.length>0||this.currentVisibles1.length>0||this.currentVisibles2.length>0||this.currentVisibles3.length>0||this.currentVisibles0Transparents.length>0||this.currentVisibles1Transparents.length>0||this.currentVisibles2Transparents.length>0||this.currentVisibles3Transparents.length>0||this.currentVisiblesAux.length>0||this.currentVisiblesPT10.length>0||this.currentVisibleNativeObjects.opaquesArray.length>0||this.currentVisibleNativeObjects.transparentsArray.length>0||this.currentVisibleNativeObjects.excavationsArray.length>0||this.currentVisibleNativeObjects.vectorTypeArray.length>0||this.currentVisibleNativeObjects.pointTypeArray.length>0||this.currentVisibleNativeObjects.lightSourcesArray.length>0||this.mgSetsArray.length>0},_t.prototype.getAllNatives=function(){var e=[],t=this.currentVisibleNativeObjects;for(var r in t)if(t.hasOwnProperty(r))for(var i=t[r],o=0,n=i.length;o<n;o++)i[o]instanceof $e||e.push(i[o]);return e},_t.prototype.getObjectIdxSortedByDist=function(e,t,r,i){var o=r-t;if(o<6){for(var n,a=!1,s=t;!a&&s<=r;){var l=e[s];i.distToCamera<l.distToCamera&&(n=s,a=!0),s++}return a?n:r+1}var u,c,d=t+Math.floor(o/2);return e[d].distToCamera>i.distToCamera?(u=t,c=d):(u=d,c=r),this.getObjectIdxSortedByDist(e,u,c,i)},_t.prototype.putObjectToArraySortedByDist=function(e,t){if(e.length>0){var r=e.length-1,i=this.getObjectIdxSortedByDist(e,0,r,t);e.splice(i,0,t)}else e.push(t)},_t.prototype.getNodeIdxSortedByDist=function(e,t,r,i){i.data.neoBuilding;var o=r-t;if(o<6){for(var n,a=!1,s=t;!a&&s<=r;){var l=e[s];i.data.distToCam<l.data.distToCam&&(n=s,a=!0),s++}return a?n:r+1}var u,c,d=t+Math.floor(o/2);return e[d].data.distToCam>i.data.distToCam?(u=t,c=d):(u=d,c=r),this.getNodeIdxSortedByDist(e,u,c,i)},_t.calculateBoundingSphereForArray=function(e,t){void 0===t&&(t=new z);for(var r,i=e.length,o=0;o<i;o++){var n=e[o];void 0!==n&&(r=n.getBoundingSphereWC(r),0===o?t.copyFrom(r):t.addBSphere(r))}return t},_t.getBoundaryNodes=function(e,t){var i,o,n,a,s,l,u,c;void 0===t&&(t=[]);for(var d=e.length,h=0;h<d;h++){var f,g=e[h];if(g instanceof lr)f=g.data.geographicCoord;else if(g instanceof r){f=g.getCurrentGeoLocationData().geographicCoord}0===h?(i=f.longitude,o=f.latitude,n=f.longitude,a=f.latitudes,s=g,l=g,u=g,c=g):(f.longitude<i?(i=f.longitude,s=g):f.longitude>n&&(n=f.longitude,l=g),f.latitude<o?(o=f.latitude,u=g):f.latitude>a&&(a=f.latitude,c=g))}return t.push.apply(t,[s,l,u,c]),t},_t.prototype.calculateBoundingFrustum=function(e){var t=this.currentVisibles0.concat(this.currentVisibles1,this.currentVisibles2,this.currentVisibles3),r=this.getAllNatives();if([].push.apply(t,r),0!==t.length){var i=e.getPosition(),o=e.getDirection(),n=new Jr(i.x,i.y,i.z),a=new Jr(o.x,o.y,o.z),s=new Rr(n,a),l=[];l=_t.getBoundaryNodes(t,l);for(var u=1e11,c=0,d=new Jr,h=l.length,f=0;f<h;f++){var g=l[f].getBoundingSphereWC(g);if(g){var p=g.getCenterPoint(),m=g.getRadius(),v=s.getProjectedPoint(p,void 0),x=new Jr(v.x-o.x*m,v.y-o.y*m,v.z-o.z*m),_=new Jr(v.x+o.x*m,v.y+o.y*m,v.z+o.z*m),y=i.squareDistTo(x.x,x.y,x.z),T=i.squareDistTo(_.x,_.y,_.z);if(u>0)d.set(x.x-i.x,x.y-i.y,x.z-i.z),o.scalarProduct(d)<0&&(y=0);else y=0;0===f?(u=y,c=T):(y<u&&(u=y),T>c&&(c=T))}}this.bFrustumNear=Math.sqrt(u),this.bFrustumFar=Math.sqrt(c)}},_t.prototype.calculateBoundingSpheres=function(){void 0===this.bSphere&&(this.bSphere=new z);var e=this.currentVisibles0.concat(this.currentVisibles1,this.currentVisibles2,this.currentVisibles3);if(0!==e.length){var t=[];t=_t.getBoundaryNodes(e,t),this.bSphere=_t.calculateBoundingSphereForArray(t,this.bSphere)}},_t.prototype.putNodeToArraySortedByDist=function(e,t){if(e.length>0){var r=e.length-1,i=this.getNodeIdxSortedByDist(e,0,r,t);e.splice(i,0,t)}else e.push(t)},_t.prototype.putNodeByLod=function(e,t){var r=e.isOpaque();0===t||1===t?r?this.putNodeToArraySortedByDist(this.currentVisibles0,e):this.putNodeToArraySortedByDist(this.currentVisibles0Transparents,e):2===t?r?this.putNodeToArraySortedByDist(this.currentVisibles2,e):this.putNodeToArraySortedByDist(this.currentVisibles2Transparents,e):t>2&&(r?this.putNodeToArraySortedByDist(this.currentVisibles3,e):this.putNodeToArraySortedByDist(this.currentVisibles3Transparents,e))},_t.prototype.putNodeByProjectType=function(e){this.putNodeToArraySortedByDist(this.currentVisiblesPT10,e)};var yt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);ot.call(this,t),this.url=t.url,this.param=we({},e.DEAFULT_PARAM,t.param||{});var r=Zo(t.filter,void 0);this.filter=r?new nt(r):void 0,this._requestParam=new URLSearchParams(this.param),window.navigator.userAgent.indexOf("Trident")>-1?"1.3.0"===this._requestParam.searchString.VERSION?delete this._requestParam.searchString.SRS:delete this._requestParam.searchString.CRS:"1.3.0"===this._requestParam.get("VERSION")?this._requestParam.delete("SRS"):this._requestParam.delete("CRS")};(yt.prototype=Object.create(ot.prototype)).constructor=yt,yt.DEAFULT_PARAM={SERVICE:"WMS",VERSION:"1.1.1",REQUEST:"GetMap",SRS:"EPSG:900913",CRS:"EPSG:900913",WIDTH:256,HEIGHT:256,FORMAT:"image/png",TRANSPARENT:!0},yt.prototype.getUrl=function(e){var t,r=Ke.getGeographicExtentOfTileLXY(parseInt(e.z),parseInt(e.x),parseInt(e.y),void 0,I.imageryType.WEB_MERCATOR),i=r.minGeographicCoord,o=r.maxGeographicCoord,n=Te.geographicToMercatorProjection(i.longitude,i.latitude,void 0),a=Te.geographicToMercatorProjection(o.longitude,o.latitude,void 0),s=n.x+","+n.y+","+a.x+","+a.y;if(window.navigator.userAgent.indexOf("Trident")>-1){this._requestParam.searchString.BBOX=s;var l=[];for(var u in this._requestParam.searchString)this._requestParam.searchString.hasOwnProperty(u)&&l.push(u+"="+this._requestParam.searchString[u]);t=this.url+"?"+l.join("&")}else this._requestParam.set("BBOX",s),t=this.url+"?"+this._requestParam.toString();return t};var Tt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t,this.workerExtrudeManager,this.tenelevenExtrudeWorkerManager,this.extrusionWorkerManager};Tt.prototype.getExtrudeWorkerManager=function(){return this.workerExtrudeManager||(this.workerExtrudeManager=new ie(this)),this.workerExtrudeManager},Tt.prototype.getTenElevenExtrudeWorkerManager=function(){return this.tenelevenExtrudeWorkerManager||(this.tenelevenExtrudeWorkerManager=new tt(this)),this.tenelevenExtrudeWorkerManager},Tt.prototype.getExtrusionWorkerManager=function(){return this.extrusionWorkerManager||(this.extrusionWorkerManager=new oe(this)),this.extrusionWorkerManager};var Ct=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);ot.call(this,t);var r=t.url,i=t.urlFunction;if(tn(r)&&tn(i))throw new Error(Ue.REQUIRED_EMPTY_ERROR("url or urlFunction"));this.url=r,this.reg=/{[^}]+}/g,this.urlFunction=Zo(i,void 0),this.urlFunction||this._setDefaultUrlFunction()};(Ct.prototype=Object.create(ot.prototype)).constructor=Ct,Ct.prototype.getUrl=function(e){return this.urlFunction.call(this,e)},Ct.prototype._setDefaultUrlFunction=function(){var e=this;e.urlFunction=function(t){for(var r=e.url.match(e.reg),i=e.url,o=0,n=r.length;o<n;o++){var a=r[o],s=t[a.substring(1,a.length-1).toLowerCase()];i=i.replace(a,s)}return i}};var bt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.effectsManager,this.birthData,this.durationSeconds,this.complete,this.effectType="unknown",(t=t||{}).effectType&&(this.effectType=t.effectType),t.durationSeconds&&(this.durationSeconds=t.durationSeconds),t.zVelocity&&(this.zVelocity=t.zVelocity),t.zMax&&(this.zMax=t.zMax),t.zMin&&(this.zMin=t.zMin),t.blinkDuration&&(this.blinkDuration=Zo(t.blinkDuration,.2)),t.complete&&(this.complete=t.complete)};bt.prototype.execute=function(e,t){var r=!1;if(void 0===this.birthData)return this.birthData=e,r;var i=this.effectsManager.gl,o=t.postFxShadersManager.currentShaderUsing,n=o.getName(),a=this.effectsManager.currShader,s=!1;o!==a&&(s=!0,a.useProgram());var l=e-this.birthData;if("zBounceSpring"===this.effectType){var u=1;if(l>=this.durationSeconds)u=1,r=!0;else{var c=5/this.durationSeconds,d=l;u=(1-(u=1*Math.pow(Math.E,-.1*d)*(Math.cos(c*d+0)+Math.sin(c*d+0))))*Math.log(d/this.durationSeconds+1.1)}i.uniform3fv(a.scaleLC_loc,[1,1,u])}else if("zBounceLinear"===this.effectType){u=1;l>=this.durationSeconds?(u=1,r=!0):u=l/this.durationSeconds,i.uniform3fv(a.scaleLC_loc,[1,1,u])}else if("zBounceLinearReverse"===this.effectType){u=1;l>=this.durationSeconds?(u=0,r=!0):u=1-l/this.durationSeconds,i.uniform3fv(a.scaleLC_loc,[1,1,u])}else if("borningLight"===this.effectType){var h=1;if(l>=this.durationSeconds)h=1,r=!0;else h=1/((m=l/this.durationSeconds)*m);i.uniform4fv(a.colorMultiplier_loc,[h,h,h,1])}else if("blinker"===this.effectType){var f,g=[.4,.4,.4,1];h=1;if(l>=this.durationSeconds)f=g,r=!0;else void 0===this.blink&&(this.blink=!0),this.blinkTime||(this.blinkTime=e),this.blinkDuration||(this.blinkDuration=.2),e-this.blinkTime>this.blinkDuration&&(this.blink=!this.blink,this.blinkTime=e),h=1/((m=l/this.durationSeconds)*m),f=this.blink?[1e3*h,1e3*h,1e3*h,1]:g;i.uniform4fv(a.colorMultiplier_loc,f)}else if("fadeIn"===this.effectType){var p=1;if(l>=this.durationSeconds)p=1,r=!0;else p=m=l/this.durationSeconds;i.uniform4fv(a.colorMultiplier_loc,[1,1,1,p])}else if("fadeOut"===this.effectType){var m;p=1;if(l>=this.durationSeconds)p=0,r=!0;else p-=m=l/this.durationSeconds;i.uniform4fv(a.colorMultiplier_loc,[1,1,1,p])}else if("zMovement"===this.effectType){if(void 0===this.zVelocity&&(this.zVelocity=1),void 0===this.zMax&&(this.zMax=1),void 0===this.zMin&&(this.zMin=-1),void 0===this.zOffset&&(this.zOffset=0),void 0===this.lastTime&&(this.lastTime=e),l>=this.durationSeconds)this.zOffset=0,r=!0;else{var v=e-this.lastTime;if(this.zOffset+=this.zVelocity*v,this.zVelocity>0){if(this.zOffset>this.zMax){var x=this.zOffset-this.zMax;this.zOffset=this.zMax-x,this.zVelocity*=-1}}else if(this.zOffset<this.zMin){x=this.zOffset-this.zMin;this.zOffset=this.zMin-x,this.zVelocity*=-1}}i.uniform3fv(a.aditionalOffset_loc,[0,this.zOffset,0]),this.lastTime=e}s&&t.postFxShadersManager.getShader(n).useProgram();return r};var Mt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.effectsObjectsMap={},this.gl,this.currShader};Mt.prototype.setCurrentShader=function(e){this.currShader=e},Mt.prototype.getEffectsObject=function(e){return this.effectsObjectsMap[e]},Mt.prototype.hasEffects=function(e){return!!this.effectsObjectsMap[e]&&!(!this.effectsObjectsMap[e].effectsArray||0===this.effectsObjectsMap[e].effectsArray.length)},Mt.prototype.addEffect=function(e,t){var r=this.getEffectsObject(e);void 0===r&&(r={},this.effectsObjectsMap[e]=r),void 0===r.effectsArray&&(r.effectsArray=[]),t.effectsManager=this,r.effectsArray.push(t)},Mt.prototype.executeEffects=function(e,t){var r=this.getEffectsObject(e),i=!1,o=t.getCurrentTime();if(void 0===r)return!1;for(var n=r.effectsArray.length,a=0;a<n;a++){var s=r.effectsArray[a];s.execute(o/1e3,t)&&(s.complete&&"function"==typeof s.complete&&s.complete.call(null,t),r.effectsArray.splice(a,1),n=r.effectsArray.length),i=!0,0===r.effectsArray.length&&(this.effectsObjectsMap[e]=void 0,delete this.effectsObjectsMap[e])}return i};var At=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._electroMagnetismManagerOwner,this.geoLocationDataManager,this.gl,this._timeSlicesArray,this.altitude,this.timeInterval_min,this.timeSlicesCount,this.timeSliceFileNames,this.timeSliceFileFolderPath,this._isPrepared=!1,this._terrainSamplingState=I.processState.NO_STARTED,this.vboKeysContainer,this._makingMeshProcess,this._currTimeSliceIdx=0,void 0!==t&&(void 0!==t.electroMagnetismManagerOwner&&(this._electroMagnetismManagerOwner=t.electroMagnetismManagerOwner),void 0!==t.altitude&&(this.altitude=t.altitude),void 0!==t.timeInterval_min&&(this.timeInterval_min=t.timeInterval_min),void 0!==t.timeSlicesCount&&(this.timeSlicesCount=t.timeSlicesCount),void 0!==t.timeSliceFileNames&&(this.timeSliceFileNames=t.timeSliceFileNames),void 0!==t.timeSliceFileFolderPath&&(this.timeSliceFileFolderPath=t.timeSliceFileFolderPath))};At.prototype._prepareLayer=function(){if(this._isPrepared)return!0;if(void 0===this._timeSlicesArray&&(this._timeSlicesArray=[]),0===this._timeSlicesArray.length)for(var e=this.timeSliceFileNames.length,t=0;t<e;t++){var r=this.timeSliceFileFolderPath+"\\"+this.timeSliceFileNames[t],i=new Lt({filePath:r,EMSurfaceLayerOwner:this});this._timeSlicesArray.push(i)}var o=!0,n=this._timeSlicesArray.length;for(t=0;t<n;t++){(i=this._timeSlicesArray[t])._prepare()||(o=!1)}if(!o)return!1;if(0===this._timeSlicesArray.length)return!1;if(void 0===this._makingMeshProcess&&(this._makingMeshProcess=I.processState.NO_STARTED),this._makingMeshProcess===I.processState.NO_STARTED){void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt,this.vboKeysContainer.newVBOVertexIdxCacheKey());i=this._timeSlicesArray[this._currTimeSliceIdx];void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var a=this.geoLocDataManager.getCurrentGeoLocationData();void 0===a&&(a=this.geoLocDataManager.newGeoLocationData("default"));var s=i._jsonFile.centerGeographicCoord;a=on.calculateGeoLocationData(s.longitude,s.latitude,s.altitude,0,0,0,a);var l=new Float32Array(i._jsonFile.positions),u=new Float32Array(i._jsonFile.soundLevelValues),c=this._electroMagnetismManagerOwner.magoManager,d=this.vboKeysContainer.getVboKey(0);if(l.length/3>=65535){c.getGl().getExtension("OES_element_index_uint");var h=new Uint32Array(i._jsonFile.indices);d.setDataArrayIdx(h,c.vboMemoryManager)}else{h=new Uint16Array(i._jsonFile.indices);d.setDataArrayIdx(h,c.vboMemoryManager)}d.setDataArrayPos(l,c.vboMemoryManager);return d.setDataArrayCustom(u,c.vboMemoryManager,1,"soundLevelValue",4),this._makingMeshProcess=I.processState.FINISHED,!1}return this._isPrepared=!0,this._isPrepared},At.prototype.render=function(e){if(void 0===this._timeSlicesArray||0===this._timeSlicesArray.length)return!1;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount())return!1;e.getCurrentTime(),this._electroMagnetismManagerOwner._animationStartTime,this._timeSlicesArray.length,this.timeInterval_min;var t=e.getGl(),r=e.sceneState,i=e.extbuffers;e.bindMainFramebuffer(),t.framebufferTexture2D(t.FRAMEBUFFER,i.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,i.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,i.COLOR_ATTACHMENT5_WEBGL,t.TEXTURE_2D,null,0),i.drawBuffersWEBGL([i.COLOR_ATTACHMENT0_WEBGL,i.NONE,i.NONE,i.COLOR_ATTACHMENT3_WEBGL,i.COLOR_ATTACHMENT4_WEBGL,i.NONE]);var o=e.postFxShadersManager.getShader("electroMagnetismSurface");e.postFxShadersManager.useProgram(o),t.uniform1i(o.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),t.uniform1i(o.bApplySpecularLighting_loc,!0),t.uniform1f(o.uFCoef_logDepth_loc,r.fCoef_logDepth[0]),t.uniform1i(o.uFrustumIdx_loc,e.currentFrustumIdx),t.uniform1i(o.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),t.disableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),t.disableVertexAttribArray(o.normal3_loc),-1!==o.color4_loc&&t.disableVertexAttribArray(o.color4_loc),o.bindUniformGenerals(),t.uniform1f(o.externalAlpha_loc,1),t.uniform1i(o.textureFlipYAxis_loc,e.sceneState.textureFlipYAxis),t.uniform3fv(o.scaleLC_loc,[1,1,1]),t.uniform4fv(o.colorMultiplier_loc,[1,1,1,1]),t.uniform3fv(o.aditionalMov_loc,[0,0,0]),t.uniform1i(o.colorType_loc,this._electroMagnetismManagerOwner._colorType);var n=this._electroMagnetismManagerOwner._legendColors4,a=this._electroMagnetismManagerOwner._legendValues;t.uniform4fv(o.uLegendColors_loc,n),t.uniform1fv(o.uLegendValues_loc,a),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.uniform1f(o.uModelOpacity_loc,1),t.uniform4fv(o.oneColor4_loc,[.99,.5,.25,1]);for(var s=this._timeSlicesArray.length,l=0;l<s;l++){var u=this._timeSlicesArray[l],c=u._jsonFile.minSoundValue,d=u._jsonFile.maxSoundValue;t.uniform1fv(o.uMinMaxValue_loc,new Float32Array([c,d])),u.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(t,o);for(var h=e.vboMemoryManager,f=u.vboKeysContainer.vboCacheKeysArray.length,g=0;g<f;g++){var p=u.vboKeysContainer.vboCacheKeysArray[g];if(!p)return!1;if(!p.bindDataPosition(o,h))return!1;if(!p.bindDataCustom(o,h,"soundLevelValue",o.value_loc))return!1;if(!p.bindDataIndice(o,h))return!1;var m=t.TRIANGLES,v=p.vboBufferIdx.dataGlType;t.drawElements(m,p.indicesCount,v,0)}}return t.disable(t.BLEND),o.disableVertexAttribArrayAll(),e.postFxShadersManager.useProgram(null),!0};var Et=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._EMSurfLayersArray,this.magoManager,this._geoJsonIndexFileLoadState=I.fileLoadState.READY,this._geoJsonIndexFile,this._geoJsonIndexFilePath,this._geoJsonIndexFileFolderPath,this._allLayersArePrepared=!1,this._geoJsonIndexFilePathsArray,this._highVoltageCablesJsonFile,this._highVoltageCablesJsonFilePath=void 0,this._highVoltageCablesJsonFileLoadState=I.fileLoadState.READY,this._vectorMeshCablesArray,this._animationState=0,this._animationStartTime=0,this._totalAnimTime,this._increTime,this._colorType=5,this._baseColor4=new Float32Array([0,0,0,0]),this._legendColors4,this._legendValues,t&&(void 0!==t.magoManager&&(this.magoManager=t.magoManager),t.geoJsonIndexFilePath&&(this._geoJsonIndexFilePath=t.geoJsonIndexFilePath),t.geoJsonIndexFilePathsArray&&(this._geoJsonIndexFilePathsArray=t.geoJsonIndexFilePathsArray),t.geoJsonIndexFileFolderPath&&(this._geoJsonIndexFileFolderPath=t.geoJsonIndexFileFolderPath),void 0!==t.animationSpeed&&(this._animationSpeed=t.animationSpeed),t.highVoltageCablesJsonFilePath&&(this._highVoltageCablesJsonFilePath=t.highVoltageCablesJsonFilePath))};Et.prototype._loadGeoJsonIndexFile=function(){if(this._geoJsonIndexFileLoadState===I.fileLoadState.READY){this._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._geoJsonIndexFilePath,void 0,void 0,"json","GET").done(function(t){e._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,e._geoJsonIndexFile=t})}},Et.prototype._loadHighVoltageCablesJsonIndexFile=function(){if(this._highVoltageCablesJsonFileLoadState===I.fileLoadState.READY){this._highVoltageCablesJsonFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._highVoltageCablesJsonFilePath,void 0,void 0,"json","GET").done(function(t){e._highVoltageCablesJsonFileLoadState=I.fileLoadState.LOADING_FINISHED,e._highVoltageCablesJsonFile=t})}},Et.prototype._prepareEMSurfaceGeoJsonIndexFile=function(){return this._geoJsonIndexFileLoadState===I.fileLoadState.READY?(this._loadGeoJsonIndexFile(),!1):this._geoJsonIndexFileLoadState===I.fileLoadState.LOADING_FINISHED},Et.prototype._prepareHighVoltageCablesJsonIndexFile=function(){return void 0===this._highVoltageCablesJsonFilePath||(this._highVoltageCablesJsonFileLoadState===I.fileLoadState.READY?(this._loadHighVoltageCablesJsonIndexFile(),!1):this._highVoltageCablesJsonFileLoadState===I.fileLoadState.LOADING_FINISHED)},Et.prototype.getEMSurfacesLayersCount=function(){return void 0===this._EMSurfLayersArray?0:this._EMSurfLayersArray.length},Et.prototype.newEMSurfaceLayer=function(e){void 0===this._EMSurfLayersArray&&(this._EMSurfLayersArray=[]);var t=new At(e);return this._EMSurfLayersArray.push(t),t},Et.prototype._prepareEMSurfacesLayers=function(e){if(!0===this._allLayersArePrepared)return!0;if(0===(s=this.getEMSurfacesLayersCount()))for(var t=this._geoJsonIndexFile.layersCount,r=this._geoJsonIndexFileFolderPath,i=0;i<t;i++){var o=this._geoJsonIndexFile.layers[i],n={electroMagnetismManagerOwner:this,timeInterval_min:o.timeInterval_min,timeSlicesCount:o.timeSlicesCount,timeSliceFileNames:o.timeSliceFileNames,timeSliceFileFolderPath:r};this.newEMSurfaceLayer(n)}var a=!0,s=this.getEMSurfacesLayersCount();for(i=0;i<s;i++){this._EMSurfLayersArray[i]._prepareLayer()||(a=!1)}return this._allLayersArePrepared=a,!1},Et.prototype._prepareVectorMeshCables=function(){if(this._highVoltagesCablesPrepared)return!0;if(void 0!==this._highVoltageCablesJsonFilePath){var e=this._highVoltageCablesJsonFile.cablesCount,t=this._highVoltageCablesJsonFile.cables,r={},i=this.magoManager;void 0===this.geoLocDataManagerHighVoltageCables&&(this.geoLocDataManagerHighVoltageCables=new ye);var o=this.geoLocDataManagerHighVoltageCables.getCurrentGeoLocationData();void 0===o&&(o=this.geoLocDataManagerHighVoltageCables.newGeoLocationData("default"));var n=this._highVoltageCablesJsonFile.centerGeoCoord;o=on.calculateGeoLocationData(n.longitude,n.latitude,n.altitude,0,0,0,o);for(var a=0;a<e;a++){var s=t[a],l=[new Jr(s.startCartesianCoordLC.x,s.startCartesianCoordLC.y,s.startCartesianCoordLC.z),new Jr(s.endCartesianCoordLC.x,s.endCartesianCoordLC.y,s.endCartesianCoordLC.z)],u=_o.getVectorMeshItineraryFromPoints3dLCArray(l,o,i,r);void 0===this._lineThickness&&(this._lineThickness=4),void 0===this._thickLineColor&&(this._thickLineColor=new J,this._thickLineColor.setRGBA(.9,1,1,1)),void 0===u.color4&&(u.color4=new J),u.color4.setRGB(this._thickLineColor.r,this._thickLineColor.g,this._thickLineColor.b),u.thickness=this._lineThickness,void 0===this._vectorMeshCablesArray&&(this._vectorMeshCablesArray=[]),this._vectorMeshCablesArray.push(u)}this._highVoltagesCablesPrepared=!0}return!0},Et.prototype.prepareVolume=function(){return!!this._prepareEMSurfaceGeoJsonIndexFile()&&(!!this._prepareHighVoltageCablesJsonIndexFile()&&(void 0!==this._highVoltageCablesJsonFilePath&&this._prepareVectorMeshCables(),!!this._prepareEMSurfacesLayers()))},Et.prototype.getEMLayersCount=function(){return void 0===this._EMSurfLayersArray?0:this._EMSurfLayersArray.length},Et.prototype._TEST_setLegendsColors=function(){this._legendColors4=new Float32Array([0,0,143/255,128/255,0,15/255,1,128/255,0,95/255,1,128/255,0,175/255,1,128/255,0,1,1,128/255,79/255,1,175/255,128/255,159/255,1,95/255,128/255,239/255,1,15/255,128/255,1,191/255,0,128/255,1,111/255,0,128/255,1,31/255,0,128/255,207/255,0,0,128/255,127/255,0,0,128/255,127/255,0,0,128/255,127/255,0,0,128/255,127/255,0,0,128/255]);for(var e=this._legendColors4.length/4,t=1.5/(e-1),r=[],i=0;i<e;i++)r.push(t*i+0);this._legendValues=new Float32Array(r)},Et.prototype.setLegendRGBA=function(e){this._legendColors4=e},Et.prototype.setLegendValues=function(e){this._legendValues=e},Et.prototype.setBaseRGBA=function(e){this._baseColor4=e},Et.prototype.render=function(){if(!this.prepareVolume(this.magoManager))return!1;if(0===this.getEMLayersCount())return!1;if(void 0===this.currLayerIdx&&(this.currLayerIdx=0),this._EMSurfLayersArray[this.currLayerIdx].render(this.magoManager),this._vectorMeshCablesArray){var e=this.magoManager,t=e.sceneState,r=e.extbuffers,i=e.getGl();e.bindMainFramebuffer(),i.framebufferTexture2D(i.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,e.depthTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,e.normalTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,e.albedoTex,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]);var o=e.postFxShadersManager.getShader("thickLine");o.useProgram(),o.bindUniformGenerals(),i.enableVertexAttribArray(o.prev_loc),i.enableVertexAttribArray(o.current_loc),i.enableVertexAttribArray(o.next_loc),i.uniform2fv(o.viewport_loc,[t.drawingBufferWidth[0],t.drawingBufferHeight[0]]),i.uniform1i(o.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(o.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),i.uniform1i(o.uFrustumIdx_loc,e.currentFrustumIdx),i.uniform1i(o.bUseOutline_loc,!0),i.uniform4fv(o.uBaseColor4_loc,this._baseColor4),i.enable(i.BLEND);for(var n=this.geoLocDataManagerHighVoltageCables.getCurrentGeoLocationData(),a=this._vectorMeshCablesArray.length,s=0;s<a;s++){var l=this._vectorMeshCablesArray[s];i.uniform4fv(o.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(o.colorType_loc,0),i.uniform1f(o.thickness_loc,l.thickness);n.bindGeoLocationUniforms(i,o),this._thisckLineDepthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),l.render(e,o,1),i.enable(i.DEPTH_TEST)}i.useProgram(null),i.disable(i.BLEND)}return!0};var Lt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._EMSurfaceLayerOwner,this._fileileLoadState=I.fileLoadState.READY,this._filePath,this._jsonFile,this._isPrepared=!1,this._glTexture,void 0!==t&&(t.filePath&&(this._filePath=t.filePath),t.EMSurfaceLayerOwner&&(this._EMSurfaceLayerOwner=t.EMSurfaceLayerOwner))};Lt.prototype._prepare=function(){if(this._isPrepared)return!0;if(this._fileileLoadState===I.fileLoadState.READY){this._fileileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._filePath,void 0,void 0,"json","GET").done(function(t){e._fileileLoadState=I.fileLoadState.LOADING_FINISHED,e._jsonFile=t})}if(this._fileileLoadState!==I.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this._makingMeshProcess&&(this._makingMeshProcess=I.processState.NO_STARTED),this._makingMeshProcess===I.processState.NO_STARTED){void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt,this.vboKeysContainer.newVBOVertexIdxCacheKey()),void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var t=this.geoLocDataManager.getCurrentGeoLocationData();void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default"));var r=this._jsonFile.centerGeographicCoord;t=on.calculateGeoLocationData(r.longitude,r.latitude,r.altitude,0,0,0,t);var i=new Float32Array(this._jsonFile.positions),o=new Float32Array(this._jsonFile.soundLevelValues),n=this._EMSurfaceLayerOwner._electroMagnetismManagerOwner.magoManager,a=this.vboKeysContainer.getVboKey(0);if(i.length/3>=65535){n.getGl().getExtension("OES_element_index_uint");var s=new Uint32Array(this._jsonFile.indices);a.setDataArrayIdx(s,n.vboMemoryManager)}else{s=new Uint16Array(this._jsonFile.indices);a.setDataArrayIdx(s,n.vboMemoryManager)}a.setDataArrayPos(i,n.vboMemoryManager);return a.setDataArrayCustom(o,n.vboMemoryManager,1,"soundLevelValue",4),this._makingMeshProcess=I.processState.FINISHED,!1}return this._isPrepared=!0,this._isPrepared};var wt=function e(r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);r=r||{},t.call(this),r.handleDownEvent&&(this.handleDownEvent=r.handleDownEvent),r.handleUpEvent&&(this.handleUpEvent=r.handleUpEvent),r.handleMoveEvent&&(this.handleMoveEvent=r.handleMoveEvent),this.begin=!1,this.startPoint=void 0,this.startTime,this.endPoint=void 0,this.tolerance=0};(wt.prototype=Object.create(t.prototype)).constructor=wt,wt.prototype.init=function(){this.begin=!1,this.startPoint=void 0,this.endPoint=void 0},wt.prototype.setActive=function(e){if(!(this.manager&&this.manager instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));this.active!==e&&(this.active=e,e?this.emit(Pt.ACTIVE,this):this.emit(Pt.DEACTIVE))},wt.prototype.handle=function(e){if(!this.stop){var t=e.type;if(t!==Fe.EVENT_TYPE.MOUSEMOVE&&t!==Fe.EVENT_TYPE.LEFTDOWN&&t!==Fe.EVENT_TYPE.RIGHTDOWN&&t!==Fe.EVENT_TYPE.MIDDLEDOWN&&t!==Fe.EVENT_TYPE.LEFTUP&&t!==Fe.EVENT_TYPE.RIGHTUP&&t!==Fe.EVENT_TYPE.MIDDLEUP)return!1;if(this.begin&&t!==Fe.EVENT_TYPE.MOUSEMOVE){if(this.begin=!1,this.dragtype=void 0,this.endPoint=e.point,e.timestamp-this.startTime<1500){var r=this.startPoint.screenCoordinate,i=this.endPoint.screenCoordinate,o=Math.abs(r.x-i.x),n=Math.abs(r.y-i.y);if(o<=this.tolerance&&n<=this.tolerance){var a=this;this.manager.once("lastFrustum",function(){a.handleUpEvent.call(a,e)})}}}else t===Fe.EVENT_TYPE.MOUSEMOVE?this.handleMoveEvent.call(this,e):t===Fe.EVENT_TYPE.LEFTDOWN&&(this.begin=!0,this.startPoint=e.point,this.startTime=e.timestamp,this.handleDownEvent.call(this,e))}},wt.prototype.handleDownEvent=function(e){return ln()},wt.prototype.handleUpEvent=function(e){return ln()},wt.prototype.handleMoveEvent=function(e){return ln()};var St=function e(r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);r=r||{},t.call(this),r.handleDownEvent&&(this.handleDownEvent=r.handleDownEvent),r.handleDragEvent&&(this.handleDragEvent=r.handleDragEvent),r.handleMoveEvent&&(this.handleMoveEvent=r.handleMoveEvent),r.handleUpEvent&&(this.handleUpEvent=r.handleUpEvent),this.begin=!1,this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0};(St.prototype=Object.create(t.prototype)).constructor=St,St.prototype.init=function(){this.begin=!1,this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0},St.prototype.setActive=function(e){if(!(this.manager&&this.manager instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));if(this.active!==e){this.active=e,e?this.emit(Pt.ACTIVE,this):this.emit(Pt.DEACTIVE)}},St.prototype.handle=function(e){if(!this.stop){var t=e.type;this.dragging?t===Fe.EVENT_TYPE.LEFTUP||t===Fe.EVENT_TYPE.RIGHTUP||t===Fe.EVENT_TYPE.MIDDLEUP?(this.dragging=!1,this.mouseBtn=void 0,this.endPoint=e.point,this.handleUpEvent.call(this,e)):t===Fe.EVENT_TYPE.MOUSEMOVE&&this.handleDragEvent.call(this,e):t===Fe.EVENT_TYPE.LEFTDOWN||t===Fe.EVENT_TYPE.RIGHTDOWN||t===Fe.EVENT_TYPE.MIDDLEDOWN?(this.dragging=!0,this.mouseBtn=t,this.endPoint=void 0,this.startPoint=e.point,this.handleDownEvent.call(this,e)):t===Fe.EVENT_TYPE.MOUSEMOVE&&this.handleMoveEvent.call(this,e)}},St.prototype.handleDownEvent=function(e){return ln()},St.prototype.handleDragEvent=function(e){return ln()},St.prototype.handleMoveEvent=function(e){return ln()},St.prototype.handleUpEvent=function(e){return ln()};var Dt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);wt.call(this,t=t||{})};(Dt.prototype=Object.create(wt.prototype)).constructor=Dt,Dt.prototype.init=function(){this.begin=!1,this.startPoint=void 0,this.endPoint=void 0},Dt.prototype.handleDownEvent=function(e){},Dt.prototype.handleUpEvent=function(e){},Dt.prototype.handleMoveEvent=function(e){};var Rt=function e(r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);t.call(this),this.style,r?this.setStyle(r):this.style={},this.collection,this.result=[]};(Rt.prototype=Object.create(t.prototype)).constructor=Rt,Rt.prototype.getStyle=function(){return this.style},Rt.prototype.setStyle=function(e){this.style=e},Rt.prototype.setActive=function(e){if(!(this.manager&&this.manager instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));if(this.active!==e){this.collection||(this.collection=this.manager.interactionCollection);e?(this.collection.emit(Pt.ACTIVE,this),this.emit(this.constructor.EVENT_TYPE.ACTIVE,this)):(this.collection.emit(Pt.DEACTIVE),this.emit(this.constructor.EVENT_TYPE.DEACTIVE))}},Rt.createDrawGeometryInteraction=function(e){if(!e)throw new Error(Ue.REQUIRED_EMPTY_ERROR("geometry type"));var t;switch(e){case I.drawGeometryType.POINT:t=new Ot;break;case I.drawGeometryType.LINE:t=new It;break;case I.drawGeometryType.POLYGON:t=new PolygonDrawer;break;case I.drawGeometryType.RECTANGLE:t=new Nt}return t};var Pt={ACTIVE:"active",DEACTIVE:"deactive"},It=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);Rt.call(this,t),this.points=[],this.height=200,this.clickTime,this.clickPoint,this.tempLine,this.added=!1,this.result=[]};It.prototype=Object.create(Rt.prototype),It.prototype.constructor=It,It.EVENT_TYPE={DRAWEND:"drawend"},It.prototype.setHeight=function(e){this.height=e},It.prototype.getHeight=function(){return this.height},It.prototype.init=function(){this.points=[],this.tempLine=void 0,this.clickTime=void 0,this.clickPoint=void 0,clearTimeout(this.timeout)},It.prototype.clear=function(){this.init();for(var e=this.manager.modeler,t=this.result,r=0,i=t.length;r<i;r++){var o=t[r];e.removeObject(o)}this.result.length=0},It.prototype.start=function(){if(!(this.manager&&this.manager instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));var e=this,t=e.manager;this.added||(this.added=!0,t.on(Fe.EVENT_TYPE.LEFTUP,function(r){if(e.getActive())if(0===e.points.length)e.points.push(r.point.geographicCoordinate),e.clickTime||(e.clickTime=(new Date).getTime()),e.clickPoint||(e.clickPoint=r.point.screenCoordinate);else{var i=(new Date).getTime(),o=r.point.screenCoordinate,n=!1;if(i-e.clickTime<500&&Math.abs(o.x-e.clickPoint.x)<2&&Math.abs(o.y-e.clickPoint.y)<2&&(n=!0),n){if(e.tempLine){var a={coordinates:e.points};e.tempLine.init(t),e.tempLine.setPosition(a),e.end()}}else e.points.push(r.point.geographicCoordinate),e.clickTime=(new Date).getTime(),e.clickPoint=r.point.screenCoordinate}}),t.on(Fe.EVENT_TYPE.MOUSEMOVE,function(r){if(e.getActive()&&e.points.length>0){var i=e.points.slice(),o=r.endEvent.geographicCoordinate;i.push(o);var n={coordinates:i};e.tempLine?(e.tempLine.init(t),e.tempLine.setPosition(n)):(Object.keys(e.style).length<1&&(e.style={color:"#ff0000",thickness:2}),e.tempLine=new Br(n,e.style),t.modeler.magoRectangle=e.tempLine)}}))},It.prototype.end=function(){this.result.push(this.tempLine),this.manager.modeler.addObject(this.tempLine,1),this.emit(It.EVENT_TYPE.DRAWEND,this.tempLine),this.init()};var Ft=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);St.call(this,t=t||{}),this.targetType=te.NATIVE,this.filter=Zo(t.filter,"selected"),this.filter_,this.offset=Zo(t.filter,3.3),this.target=void 0,this.selObjMovePlaneCC=void 0,this.lineCC=new Rr,this.startPixel=void 0};(Ft.prototype=Object.create(St.prototype)).constructor=Ft,Ft.EVENT_TYPE={ACTIVE:"active",DEACTIVE:"deactive",CHANGEHEIGHT:"changeheight"},Ft.prototype.init=function(){this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0,this.selObjMovePlaneCC=void 0,this.startPixel=void 0,this.target=void 0},Ft.prototype.setFilter=function(e){var t=this.filter;this.filter=e,t!==e&&this.setFilterFunction()},Ft.prototype.getFilter=function(){return this.filter},Ft.prototype.handleDownEvent=function(e){var t=this.manager;if("leftdown"===e.type){var r=t.selectionManager,i=t.getGl();r.selectProvisionalObjectByPixel(i,e.point.screenCoordinate.x,e.point.screenCoordinate.y),this.filter_||this.setFilterFunction();var o=r.filterProvisional(this.targetType,this.filter_);tn(o)?this.init():this.target=o[this.targetType][0]}},Ft.prototype.handleDragEvent=function(e){if(this.target&&this.dragging){this.manager.setCameraMotion(!1);var t=this.target;if(t instanceof He)return;if(void 0===(t=t.getRootOwner()).attributes)return;var r=t.getGeoLocDataManager();if(void 0===r)return;var i=r.getCurrentGeoLocationData(),o=this.manager,n=o.getGl(),a=o.sceneState;if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new We;var s=i.geoLocMatrix,l=a.modelViewMatrix,u=a.modelViewRelToEyeMatrix,c=this.startPoint.screenCoordinate,d=on.calculatePixelPositionWorldCoord(n,c.x,c.y,d,void 0,void 0,void 0,o),h=l.transformPoint3D(this.startPoint.worldCoordinate,void 0),f=new Jr(s._floatArrays[8],s._floatArrays[9],s._floatArrays[10]),g=a.camera.direction,p=f.scalarProduct(g);if(Math.abs(p)>.9){var m=a.camera.right,v=new Ne;v.rotationAxisAngDeg(45,m.x,m.y,m.z);v.transformPoint3D(a.camera.position)}var x=f.crossProduct(g).crossProduct(f);x.unitary();var _=u.transformPoint3D(x,void 0);this.selObjMovePlaneCC.setPointAndNormal(h.x,h.y,h.z,_.x,_.y,_.z)}var y=e.endEvent.screenCoordinate,T=on.getRayCamSpace(y.x,y.y,T,o);this.lineCC.setPointAndDir(0,0,0,T[0],T[1],T[2]);var C=new Jr;C=this.selObjMovePlaneCC.intersectionLine(this.lineCC,C);var b=(l=a.getModelViewMatrixInv()).transformPoint3D(C,b),M=on.calculateWorldPositionToScreenCoord(void 0,b.x,b.y,b.z,M,o);if(!this.startPixel){var A=i.geographicCoord,E=on.geographicCoordToWorldPoint(A.longitude,A.latitude,A.altitude);this.startPixel=on.calculateWorldPositionToScreenCoord(void 0,E.x,E.y,E.z,this.startPixel,o)}var L=M.y-this.startPixel.y,w=L<0;if(Math.abs(L)>this.offset){var S=this.target,D=S.height,R=D;w?D+=this.offset:D-=this.offset,S.setHeight(D),this.emit(Ft.EVENT_TYPE.CHANGEHEIGHT,{type:Ft.EVENT_TYPE.CHANGEHEIGHT,timestamp:(new Date).getTime(),prevHeight:R,changedHeight:D}),this.startPixel.set(y.x,y.y,y.z)}}},Ft.prototype.handleMoveEvent=function(){},Ft.prototype.handleUpEvent=function(){this.init(),this.manager.setCameraMotion(!0),this.manager.isCameraMoved=!0},Ft.prototype.setFilterFunction=function(){var e=this.manager;"selected"===this.filter?this.filter_=function(t){return t===e.defaultSelectInteraction.getSelected()}:this.filter_=function(){return!0}};var Ot=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);Rt.call(this,t),this.startDraw=!1,this.startTime=void 0,this.startPoint=void 0,this.added=!1,this.result=[]};Ot.prototype=Object.create(Rt.prototype),Ot.prototype.constructor=Ot,Ot.EVENT_TYPE={DRAWEND:"drawend"},Ot.prototype.init=function(){this.startDraw=!1,this.startTime=void 0,this.startPoint=void 0},Ot.prototype.clear=function(){this.init();for(var e=this.manager.modeler,t=this.result,r=0,i=t.length;r<i;r++){var o=t[r];e.removeObject(o)}this.result.length=0},Ot.prototype.start=function(){if(!(this.manager&&this.manager instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));var e=this,t=e.manager;this.added||(this.added=!0,t.on(Fe.EVENT_TYPE.LEFTDOWN,function(t){e.getActive()&&(e.startDraw||(e.startDraw=!0,e.startTime=t.timestamp,e.startPoint=t.point.screenCoordinate))}),t.on(Fe.EVENT_TYPE.LEFTUP,function(t){if(e.getActive()&&e.startDraw){var r=!1;if(t.timestamp-e.startTime<1500){var i=e.startPoint,o=t.point.screenCoordinate,n=Math.abs(i.x-o.x),a=Math.abs(i.y-o.y);n<=0&&a<=0&&(r=!0)}if(!r)return void e.init();var s=t.point.geographicCoordinate;Object.keys(e.style).length<1&&(e.style={size:10,color:"#00FF00"}),e.end(new Or(s,e.style))}}))},Ot.prototype.end=function(e){this.result.push(e),this.manager.modeler.addObject(e,1),this.emit(Ot.EVENT_TYPE.DRAWEND,e),this.init()};var Bt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);wt.call(this,t=t||{}),this.selected=void 0,this.targetType=Zo(t.targetType,te.F4D),this.targetHighlight=Zo(t.targetHighlight,!0),this._initFilter();var r=this;this.on(e.EVENT_TYPE.DEACTIVE,function(){r.init(),r.selected=void 0,r.manager.selectionManager.clearCurrents()})};Bt.prototype=Object.create(wt.prototype),Bt.prototype.constructor=Bt,Bt.EVENT_TYPE={ACTIVE:"active",DEACTIVE:"deactive"},Bt.prototype.init=function(){this.begin=!1,this.startPoint=void 0,this.endPoint=void 0},Bt.prototype._initFilter=function(){for(var e in this.filter={},te)if(te.hasOwnProperty(e)){var t=te[e];t!==te.ALL&&"function"!=typeof t&&(this.filter[t]=un)}},Bt.prototype.setTargetType=function(e){this.targetType!==e&&(this.init(),this.selected=void 0,this.manager.isCameraMoved=!0,this.manager.selectionManager&&this.manager.selectionManager.clearCurrents(),this._initFilter()),this.targetType=e},Bt.prototype.getTargetType=function(){return this.targetType},Bt.prototype.setFilter=function(e,t){if(!e||!te.hasOwnProperty(te.getKey(e)))throw new Error("dataType is required.");t&&"function"==typeof t||(t=un),this.filter[e]=t},Bt.prototype.getFilter=function(e){return this.filter[e]},Bt.prototype.setTargetHighlight=function(e){e||(this.init(),this.manager.selectionManager&&this.manager.selectionManager.clearCurrents()),this.targetHighlight=e},Bt.prototype.getSelected=function(){return this.selected},Bt.prototype.getTargetHighlight=function(){return this.targetHighlight},Bt.prototype.handleDownEvent=function(e){},Bt.prototype.handleUpEvent=function(e){var t=this.manager.selectionManager;t.clearCurrents();var r=e.point.screenCoordinate;this.select(r);var i=this.selected;switch(this.targetType){case te.F4D:this.selected=t.getSelectedF4dNode();break;case te.OBJECT:this.selected=t.getSelectedF4dObject();break;case te.NATIVE:this.selected=t.getSelectedGeneral();break;case te.ALL:this.selected=t.getSelectedF4dNode()||t.getSelectedGeneral()}i&&this.emitEvent(i,!1,r),this.emitEvent(this.selected,!0,r)},Bt.prototype.emitEvent=function(e,t,r){if(e){var i=Bt.getEventType(this.targetType,t,e),o={type:i,pixel:r,timestamp:new Date};t?o.selected=e:o.deselected=e,this.targetType===te.OBJECT&&(o.f4d=this.manager.selectionManager.getSelectedF4dNode()),this.manager.emit(i,o)}},Bt.getEventType=function(e,t,r){var i;switch(e){case te.F4D:i=t?Fe.EVENT_TYPE.SELECTEDF4D:Fe.EVENT_TYPE.DESELECTEDF4D;break;case te.OBJECT:i=t?Fe.EVENT_TYPE.SELECTEDF4DOBJECT:Fe.EVENT_TYPE.DESELECTEDF4DOBJECT;break;case te.NATIVE:i=t?Fe.EVENT_TYPE.SELECTEDGENERALOBJECT:Fe.EVENT_TYPE.DESELECTEDGENERALOBJECT;break;case te.ALL:var o=r instanceof lr?te.F4D:te.NATIVE;return Bt.getEventType(o,t)}return i},Bt.prototype.handleMoveEvent=function(e){this.targetHighlight&&!this.selected&&this.select(e.endEvent.screenCoordinate)},Bt.prototype.select=function(e){var t=this.manager,r=t.selectionManager;if(void 0===r)throw new Error("selectionManager is not defined.");void 0===t.selectionFbo&&t.getSelectionFBO();var i=t.getGl();r.selectProvisionalObjectByPixel(i,e.x,e.y),this.targetType===te.ALL?(r.provisionalToCurrent(te.F4D,this.filter[te.F4D]),r.provisionalToCurrent(te.NATIVE,this.filter[te.NATIVE],!0)):r.provisionalToCurrent(this.targetType,this.filter[this.targetType])},Bt.prototype.clear=function(e){e||this.emitEvent(this.selected,!1),this.manager.selectionManager&&this.manager.selectionManager.clearCurrents(),this.init(),this.selected=void 0};var Nt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);Rt.call(this,t),this.startDraw=!1,this.dragging=!1,this.startPoint,this.endPoint,this.height=200,this.added=!1,this.tempRectangle,this.result=[]};Nt.prototype=Object.create(Rt.prototype),Nt.prototype.constructor=Nt,Nt.EVENT_TYPE={DRAWEND:"drawend",ACTIVE:"active",DEACTIVE:"deactive"},Nt.prototype.setHeight=function(e){this.height=e},Nt.prototype.getHeight=function(){return this.height},Nt.prototype.init=function(){this.startDraw=!1,this.dragging=!1,this.startPoint=void 0,this.endPoint=void 0,this.tempRectangle=void 0,this.manager.magoWorld.cameraMovable=!0,this.manager.modeler.magoRectangle&&(this.manager.modeler.magoRectangle.deleteObjects(this.manager.vboMemoryManager),this.manager.modeler.magoRectangle=void 0)},Nt.prototype.clear=function(){this.init();for(var e=this.manager.modeler,t=this.result,r=0,i=t.length;r<i;r++){var o=t[r];e.removeObject(o)}this.result.length=0},Nt.prototype.start=function(){if(!(this.manager&&this.manager instanceof Fe))throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));var e=this,t=e.manager;this.added||(this.added=!0,t.on(Fe.EVENT_TYPE.LEFTDOWN,function(r){e.getActive()&&(e.startDraw||(t.magoWorld.cameraMovable=!1,e.startDraw=!0,e.startPoint=r.point.geographicCoordinate))}),t.on(Fe.EVENT_TYPE.MOUSEMOVE,function(r){if(e.getActive()&&e.startDraw&&e.startPoint){e.dragging=!0;var i=r.endEvent.geographicCoordinate,o={minLongitude:e.startPoint.longitude<i.longitude?e.startPoint.longitude:i.longitude,minLatitude:e.startPoint.latitude<i.latitude?e.startPoint.latitude:i.latitude,maxLongitude:e.startPoint.longitude<i.longitude?i.longitude:e.startPoint.longitude,maxLatitude:e.startPoint.latitude<i.latitude?i.latitude:e.startPoint.latitude,altitude:-3e3};e.tempRectangle?(e.tempRectangle.init(t),e.tempRectangle.setPosition(o)):(Object.keys(e.style).length<1&&(e.style={fillColor:"#ff0000"}),e.tempRectangle=new Gr(o,e.style),t.modeler.magoRectangle=e.tempRectangle)}}),t.on(Fe.EVENT_TYPE.LEFTUP,function(t){e.getActive()&&e.dragging&&(e.endPoint=t.point,e.end())}))},Nt.prototype.end=function(){this.manager.magoWorld.cameraMovable=!0,this.result.push(this.tempRectangle),this.manager.modeler.addObject(this.tempRectangle,1),this.emit(Nt.EVENT_TYPE.DRAWEND,this.tempRectangle),this.init()},Nt.prototype.cancle=function(){var e=this.result.length-1,t=this.result[e];this.manager.modeler.removeObject(t),this.result=this.result.slice(0,e)};var Ut=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);St.call(this,t=t||{}),this.targetType=Zo(t.targetType,te.F4D),this.filter=Zo(t.filter,"selected"),this.filter_,this.target=void 0,this.parentNode=void 0,this.centerScreenCoord=void 0,this.clickDeg=void 0};(Ut.prototype=Object.create(St.prototype)).constructor=Ut,Ut.EVENT_TYPE={ACTIVE:"active",DEACTIVE:"deactive"},Ut.prototype.init=function(){this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0,this.target=void 0,this.parentNode=void 0,this.centerScreenCoord=void 0,this.clickDeg=void 0},Ut.prototype.setTargetType=function(e){this.targetType=e},Ut.prototype.getTargetType=function(){return this.targetType},Ut.prototype.setFilter=function(e){var t=this.filter;this.filter=e,t!==e&&this.setFilterFunction()},Ut.prototype.getFilter=function(){return this.filter},Ut.prototype.handleDownEvent=function(e){var t=this.manager;if("leftdown"===e.type){var r=t.selectionManager,i=t.getGl(),o=e.point.screenCoordinate;r.selectProvisionalObjectByPixel(i,o.x,o.y),this.filter_||this.setFilterFunction();var n=r.filterProvisional(this.targetType,this.filter_);if(tn(n))this.init();else{this.target=n[this.targetType][0],this.targetType===te.OBJECT&&(this.parentNode=n[te.F4D][0]);var a=this.target.getCurrentGeoLocationData().geographicCoord,s=on.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude);this.centerScreenCoord=on.calculateWorldPositionToScreenCoord(void 0,s.x,s.y,s.z,this.centerScreenCoord,t);var l=Math.atan2(o.x-this.centerScreenCoord.x,o.y-this.centerScreenCoord.y);this.clickDeg=Math.round(l*(180/Math.PI)*-1+100),this.manager.setCameraMotion(!1)}}},Ut.prototype.handleDragEvent=function(e){if(this.target&&this.dragging){var t=e.endEvent.screenCoordinate,r=Math.atan2(t.x-this.centerScreenCoord.x,t.y-this.centerScreenCoord.y),i=Math.round(r*(180/Math.PI)*-1+100)-this.clickDeg,o=this.target.getCurrentGeoLocationData(),n=o.geographicCoord,a=n.longitude,s=n.latitude,l=n.altitude,u=o.roll,c=o.pitch;this.target.changeLocationAndRotation(s,a,l,-i,u,c)}},Ut.prototype.handleUpEvent=function(){this.init(),this.manager.setCameraMotion(!0),this.manager.isCameraMoved=!0},Ut.prototype.handleMoveEvent=function(){},Ut.prototype.setFilterFunction=function(){var e=this.manager;"selected"===this.filter?this.filter_=function(t){return t===e.defaultSelectInteraction.getSelected()}:this.filter_=function(){return!0}};var Gt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);St.call(this,t=t||{}),this.targetType=Zo(t.targetType,te.F4D),this.filter=Zo(t.filter,"selected"),this.filter_,this.target=void 0,this.parentNode=void 0,this.selObjMovePlaneCC=void 0,this.selObjMovePlane=void 0,this.lineCC=new Rr,this.lineSC=new Rr,this.startGeoCoordDif=void 0,this.startMovPoint=void 0};Gt.prototype=Object.create(St.prototype),Gt.prototype.constructor=Gt,Gt.EVENT_TYPE={ACTIVE:"active",DEACTIVE:"deactive",MOVING_F4D:"movingf4d",MOVING_NATIVE:"movingNative",MOVING_OBJECT:"movingObject",MOVE_END_F4D:"moveEndf4d",MOVE_END_NATIVE:"moveEndNative",MOVE_END_OBJECT:"moveEndObject"},Gt.prototype.init=function(){this.begin=!1,this.dragging=!1,this.mouseBtn=void 0,this.startPoint=void 0,this.endPoint=void 0,this.selObjMovePlaneCC=void 0,this.selObjMovePlane=void 0,this.startGeoCoordDif=void 0,this.startMovPoint=void 0,this.target=void 0,this.parentNode=void 0},Gt.prototype.setTargetType=function(e){this.targetType=e},Gt.prototype.getTargetType=function(){return this.targetType},Gt.prototype.setFilter=function(e){var t=this.filter;this.filter=e,t!==e&&this.setFilterFunction()},Gt.prototype.getFilter=function(){return this.filter},Gt.prototype.handleDownEvent=function(e){var t=this.manager;if("leftdown"===e.type){var r=t.selectionManager,i=t.getGl();r.selectProvisionalObjectByPixel(i,e.point.screenCoordinate.x,e.point.screenCoordinate.y),this.filter_||this.setFilterFunction();var o=r.filterProvisional(this.targetType,this.filter_);tn(o)||!o.hasOwnProperty(this.targetType)&&this.targetType!==te.ALL?this.init():this.targetType!==te.ALL?(this.target=o[this.targetType][0],this.targetType===te.OBJECT&&(this.parentNode=o[te.F4D][0])):this.target=o[Object.keys(o)[0]][0]}},Gt.prototype.handleDragEvent=function(e){if(this.target&&this.dragging)switch(this.manager.setCameraMotion(!1),this.targetType){case te.F4D:this.handleF4dDrag(e);break;case te.OBJECT:this.handleObjectDrag(e);break;case te.NATIVE:this.handleNativeDrag(e);break;case te.ALL:this.target instanceof lr?this.handleF4dDrag(e):this.target instanceof r&&this.handleNativeDrag(e)}},Gt.prototype.handleF4dDrag=function(e){var t=this.manager,r=this.target.getNodeGeoLocDataManager().getCurrentGeoLocationData(),i=this.target.data.attributes;if(!this.selObjMovePlaneCC){this.selObjMovePlaneCC=new We;var o=r.geoLocMatrix,n=t.sceneState.modelViewMatrix,a=t.sceneState.modelViewRelToEyeMatrix,s=this.startPoint.screenCoordinate,l=on.calculatePixelPositionWorldCoord(t.getGl(),s.x,s.y,l,void 0,void 0,void 0,t),u=n.transformPoint3D(this.startPoint.worldCoordinate,u);if(i.movementInAxisZ){var c=new Jr(o._floatArrays[4],o._floatArrays[5],o._floatArrays[6]),d=a.transformPoint3D(c,void 0);this.selObjMovePlaneCC.setPointAndNormal(u.x,u.y,u.z,d.x,d.y,d.z)}else{var h=new Jr(o._floatArrays[8],o._floatArrays[9],o._floatArrays[10]),f=a.transformPoint3D(h,void 0);this.selObjMovePlaneCC.setPointAndNormal(u.x,u.y,u.z,f.x,f.y,f.z)}}var g=e.endEvent.screenCoordinate,p=on.getRayCamSpace(g.x,g.y,p,t);this.lineCC.setPointAndDir(0,0,0,p[0],p[1],p[2]);var m=new Jr;m=this.selObjMovePlaneCC.intersectionLine(this.lineCC,m);var v=(n=t.sceneState.getModelViewMatrixInv()).transformPoint3D(m,v),x=on.pointToGeographicCoord(v,x,this);if(!this.startGeoCoordDif){var _=r.geographicCoord;this.startGeoCoordDif=new pe(x.longitude-_.longitude,x.latitude-_.latitude,x.altitude-_.altitude)}var y=x.longitude-this.startGeoCoordDif.longitude,T=x.latitude-this.startGeoCoordDif.latitude,C=x.altitude-this.startGeoCoordDif.altitude;i.movementInAxisZ?t.changeLocationAndRotationNode(this.target,void 0,void 0,C,void 0,void 0,void 0):i.movementInAxisY?t.changeLocationAndRotationNode(this.target,T,void 0,void 0,void 0,void 0,void 0):t.changeLocationAndRotationNode(this.target,T,y,void 0,void 0,void 0,void 0),this.emit(Gt.EVENT_TYPE.MOVING_F4D,{type:Gt.EVENT_TYPE.MOVING_F4D,result:this.target,timestamp:new Date})},Gt.prototype.handleObjectDrag=function(e){var t=this.target,r=this.parentNode.getNodeGeoLocDataManager().getCurrentGeoLocationData(),i=r.getTMatrixInv(),o=this.manager.getGl();if(void 0===this.selObjMovePlane){this.selObjMovePlane=new We;var n=this.startPoint.screenCoordinate,a=on.calculatePixelPositionWorldCoord(o,n.x,n.y,a,void 0,void 0,void 0,this.manager),s=i.transformPoint3D(this.startPoint.worldCoordinate,s);this.selObjMovePlane.setPointAndNormal(s.x,s.y,s.z,0,0,1)}var l=e.endEvent.screenCoordinate;this.lineSC=on.getRayWorldSpace(o,l.x,l.y,this.lineSC,this.manager);var u=new Jr,c=new Jr;u=i.transformPoint3D(this.lineSC.point,u),c=i.rotatePoint3D(this.lineSC.direction,c);var d=new Rr;d.setPointAndDir(u.x,u.y,u.z,c.x,c.y,c.z);var h=new Jr;h=this.selObjMovePlane.intersectionLine(d,h),void 0===t.moveVectorRelToBuilding&&(t.moveVectorRelToBuilding=new Jr),this.startMovPoint||(this.startMovPoint=h,this.startMovPoint.add(-t.moveVectorRelToBuilding.x,-t.moveVectorRelToBuilding.y,-t.moveVectorRelToBuilding.z));var f=h.x-this.startMovPoint.x,g=h.y-this.startMovPoint.y,p=h.z-this.startMovPoint.z;t.moveVectorRelToBuilding.set(f,g,p),t.moveVector=r.tMatrix.rotatePoint3D(t.moveVectorRelToBuilding,t.moveVector);var m=this.parentNode.data.projectId,v=this.parentNode.data.nodeId,x=t._id;this.manager.config.deleteMovingHistoryObject(m,v,x),this.manager.objectMoved=!0},Gt.prototype.handleNativeDrag=function(e){var t=this.target;if(!(t instanceof He)&&void 0!==(M=(t=t.getRootOwner()).attributes)){var r=M.isMovable;if(void 0!==r&&!1!==r){var i=t.getGeoLocDataManager();if(void 0!==i){var o=i.getCurrentGeoLocationData(),n=this.manager,a=n.getGl(),s=n.sceneState;if(void 0===this.selObjMovePlaneCC){this.selObjMovePlaneCC=new We;var l=o.geoLocMatrix,u=s.modelViewMatrix,c=s.modelViewRelToEyeMatrix,d=this.startPoint.screenCoordinate,h=on.calculatePixelPositionWorldCoord(a,d.x,d.y,h,void 0,void 0,void 0,n),f=u.transformPoint3D(this.startPoint.worldCoordinate,void 0);if(M.movementInAxisZ){var g=new Jr(l._floatArrays[4],l._floatArrays[5],l._floatArrays[6]),p=c.transformPoint3D(g,void 0);this.selObjMovePlaneCC.setPointAndNormal(f.x,f.y,f.z,p.x,p.y,p.z)}else{var m=new Jr(l._floatArrays[8],l._floatArrays[9],l._floatArrays[10]),v=c.transformPoint3D(m,void 0);this.selObjMovePlaneCC.setPointAndNormal(f.x,f.y,f.z,v.x,v.y,v.z)}}var x=e.endEvent.screenCoordinate,_=on.getRayCamSpace(x.x,x.y,_,n);this.lineCC.setPointAndDir(0,0,0,_[0],_[1],_[2]);var y=new Jr;y=this.selObjMovePlaneCC.intersectionLine(this.lineCC,y);var T=(u=s.getModelViewMatrixInv()).transformPoint3D(y,T),C=on.pointToGeographicCoord(T,C,n);if(!this.startGeoCoordDif){var b=o.geographicCoord;this.startGeoCoordDif=new pe(C.longitude-b.longitude,C.latitude-b.latitude,C.altitude-b.altitude)}var M,A=C.longitude-this.startGeoCoordDif.longitude,E=C.latitude-this.startGeoCoordDif.latitude,L=C.altitude-this.startGeoCoordDif.altitude;if(void 0!==(M=t.attributes).minAltitude&&L<M.minAltitude&&(L=M.minAltitude),void 0!==M.maxAltitude&&L>M.maxAltitude&&(L=M.maxAltitude),M&&M.movementRestriction){var w=M.movementRestriction;if(w){w.restrictionType;var S=w.element;if(S&&"GeographicCoordSegment"===S.constructor.name){var D=S,R=new pe(A,E,0),P=me.getProjectedCoordToLine(D,R,void 0);if(me.intersectionWithGeoCoord(D,P))A=P.longitude,E=P.latitude;else{var I=me.getNearestGeoCoord(D,P);A=I.longitude,E=I.latitude}}}}if(M&&M.hasStaticModel){var F=M.projectId,O=M.instanceId;if(!Qo(F))return!1;if(!Qo(O))return!1;var B=n.hierarchyManager.getNodeByDataKey(F,O);void 0!==B&&B.changeLocationAndRotation(E,A,0,M.f4dHeading,0,0,this)}if(M.movementInAxisZ)o=on.calculateGeoLocationData(void 0,void 0,L,void 0,void 0,void 0,o,this);else if(M.movementInAxisY)o=on.calculateGeoLocationData(void 0,E,void 0,void 0,void 0,void 0,o,this);else if(M.movementInAxisX)o=on.calculateGeoLocationData(A,void 0,void 0,void 0,void 0,void 0,o,this);else{if(o=on.calculateGeoLocationData(A,E,void 0,void 0,void 0,void 0,o,this),t.localCoordListArray&&t.geographicCoordListsArray){for(var N=[],U=o.tMatrix,G=0,z=t.localCoordListArray.length;G<z;G++){for(var H=t.localCoordListArray[G],V=[],k=0,j=H.length;k<j;k++){var W=H[k],X=U.transformPoint3D(W),Y=on.pointToGeographicCoord(X);V.push(Y)}N.push(new ve(V))}t.geographicCoordListsArray=N}t.options&&t.options.limitationGeographicCoords&&t.makeUniformPoints2dArray()}this.emit(Gt.EVENT_TYPE.MOVING_NATIVE,{type:Gt.EVENT_TYPE.MOVING_NATIVE,result:this.target,timestamp:new Date}),t.moved(),t.dispatchEvent("MOVE_START",t)}}}},Gt.prototype.handleMoveEvent=function(){},Gt.prototype.handleUpEvent=function(){var e;e=this.target instanceof lr?Gt.EVENT_TYPE.MOVE_END_F4D:this.target instanceof r?Gt.EVENT_TYPE.MOVE_END_NATIVE:Gt.EVENT_TYPE.MOVE_END_OBJECT,this.emit(e,{type:e,result:this.target,timestamp:new Date}),this.init(),this.manager.setCameraMotion(!0),this.manager.isCameraMoved=!0},Gt.prototype.setFilterFunction=function(){var e=this.manager;"selected"===this.filter?this.filter_=function(t){return t===e.defaultSelectInteraction.getSelected()}:this.filter_=function(){return!0}};var zt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.bufferId,this.accesorType,this.bufferStart,this.stride,this.dataType,this.dimension,this.minX=0,this.minY=0,this.minZ=0,this.maxX=0,this.maxY=0,this.maxZ=0},Ht=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vBOVertexIdxCacheKeysContainer=new xt,this.mIFCEntityType=-1,this.isSmallObj=!1,this.bbox,this.radius=10,this.vertexCount=0,this.lego};Ht.prototype.deleteObjects=function(e,t){this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(e,t),this.vBOVertexIdxCacheKeysContainer=void 0,this.mIFCEntityType=void 0,this.isSmallObj=void 0,this.radius=void 0,this.vertexCount=void 0,this.lego&&this.lego.deleteGlObjects(e),this.lego=void 0},Ht.prototype.isReadyToRender=function(e,t,r){return!(r&&this.radius<r)&&!(t.isCameraMoving&&this.radius<t.smallObjectSize&&t.selectionManager.getSelectedF4dObject()!==e)};var Vt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.fileLoadState=I.fileLoadState.READY,this.dataArraybuffer},kt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.name="",this.version=t||"",this.blocksArray,this.fileLoadState=I.fileLoadState.READY,this.dataArraybuffer,this.keepDataArrayBuffers,this.xhr,this.blocksArrayPartitionsCount,this.blocksArrayPartitionsArray,this.blocksArrayPartitionsMasterPathName};kt.prototype.newBlock=function(){void 0===this.blocksArray&&(this.blocksArray=[]);var e=new Ht;return this.blocksArray.push(e),e},kt.prototype.getBlock=function(e){return void 0===this.blocksArray?null:e>=0&&e<this.blocksArray.length?this.blocksArray[e]:null},kt.prototype.deleteGlObjects=function(e,t){if(void 0!==this.xhr&&(this.xhr.abort(),this.xhr=void 0),void 0!==this.blocksArray){for(var r=0,i=this.blocksArray.length;r<i;r++){var o=this.blocksArray[r];o.vBOVertexIdxCacheKeysContainer.deleteGlObjects(e,t),o.vBOVertexIdxCacheKeysContainer=void 0,o.mIFCEntityType=void 0,o.isSmallObj=void 0,o.radius=void 0,o.vertexCount=void 0,o.lego&&(o.lego.vbo_vicks_container.deleteGlObjects(e,t),o.lego.vbo_vicks_container=void 0),o.lego=void 0,this.blocksArray[r]=void 0}this.blocksArray=void 0,this.name=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0}},kt.prototype.stepOverBlockVersioned=function(e,t,r){var i,o,n,a,s=r.readInt32(e,t,t+4);t+=4;for(var l=0;l<s;l++)i=r.readUInt32(e,t,t+4),t+=4,t+4*(o=3*i),t+=4*o,i=r.readUInt32(e,t,t+4),t+=4,t+=1*(3*i),n=r.readUInt32(e,t,t+4),t+=4,a=r.readUInt8(e,t,t+1),t+=1,t+=4*a,t+=4*a,t+=2*n;return t},kt.prototype.parseBlockVersioned=function(e,t,r,i,o,n){var a=o.vboMemoryManager,s=i.readInt32(e,t,t+4);t+=4;for(var l=0;l<s;l++){var u=r.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();void 0!==this.keepDataArrayBuffers&&this.keepDataArrayBuffers&&(u.keepDataArrayBuffers=!0),t=u.readPosNorIdx(e,a,t),r.vertexCount=u.vertexCount}return t},kt.prototype.parseBlocksListVersioned_v001=function(e,t,r,i){this.fileLoadState=I.fileLoadState.PARSE_STARTED;var o=0;o+=5;var n=t.readUInt32(e,o,o+4);o+=4;for(var a=0;a<n;a++){var s=t.readInt32(e,o,o+4);if(o+=4,r[s]){o+=24,o=this.stepOverBlockVersioned(e,o,t);var l=t.readUInt8(e,o,o+1);o+=1,l&&(o=this.stepOverBlockVersioned(e,o,t))}else{var u=new Ht;u.idx=s,r[s]=u,u.bbox=new G;var c=u.bbox,d=new Float32Array(e.slice(o,o+4));o+=4;var h=new Float32Array(e.slice(o,o+4));o+=4;var f=new Float32Array(e.slice(o,o+4));o+=4;var g=new Float32Array(e.slice(o,o+4));o+=4;var p=new Float32Array(e.slice(o,o+4));o+=4;var m=new Float32Array(e.slice(o,o+4));o+=4,c.minX=d[0],c.minY=h[0],c.minZ=f[0],c.maxX=g[0],c.maxY=p[0],c.maxZ=m[0];var v=c.getMaxLength();u.isSmallObj=v<.5,u.radius=v/2,o=this.parseBlockVersioned(e,o,u,t,i);l=t.readUInt8(e,o,o+1);o+=1,l&&(void 0===u.lego&&(u.lego=new Xt),o=this.parseBlockVersioned(e,o,u.lego,t,i))}}return this.fileLoadState=I.fileLoadState.PARSE_FINISHED,!0},kt.prototype.parseBlocksListVersioned_partitionsVersion=function(e,t,r){var i=this.blocksArrayPartitionsArray.length,o=this.blocksArrayPartitionsArray[i-1];if(o.fileLoadState===I.fileLoadState.LOADING_FINISHED){var n=o.dataArraybuffer;o.fileLoadState=I.fileLoadState.PARSE_STARTED;var a=0,s=r.vboMemoryManager,l=e.readUInt32(n,a,a+4);a+=4;for(var u=0;u<l;u++){var c,d=e.readInt32(n,a,a+4);a+=4,t[d]?c=t[d]:((c=new Ht).idx=d,t[d]=c);var h=e.readInt32(n,a,a+4);if(a+=4,0===h){var f=new G;f.minX=new Float32Array(n.slice(a,a+4)),a+=4,f.minY=new Float32Array(n.slice(a,a+4)),a+=4,f.minZ=new Float32Array(n.slice(a,a+4)),a+=4,f.maxX=new Float32Array(n.slice(a,a+4)),a+=4,f.maxY=new Float32Array(n.slice(a,a+4)),a+=4,f.maxZ=new Float32Array(n.slice(a,a+4)),a+=4;var g=f.getMaxLength();c.isSmallObj=g<.5,c.radius=g/2}var p=c.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[h];void 0===p?(p=new vt,c.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[h]=p,a=p.readPosNorIdx(n,e,s,a),c.vertexCount=p.vertexCount):l>1&&(a=p.stepOverPosNorIdx(n,e,s,a))}return o.fileLoadState=I.fileLoadState.PARSE_FINISHED,this.fileLoadState=I.fileLoadState.PARSE_FINISHED,!0}},kt.prototype.parseBlocksList=function(e,t,r,i){this.fileLoadState=I.fileLoadState.PARSE_STARTED;var o=0,n=t.readUInt32(e,o,o+4);o+=4;for(var a=i.vboMemoryManager,s=0;s<n;s++){var l=t.readInt32(e,o,o+4);if(o+=4,r[l]){o+=24;var u=t.readInt32(e,o,o+4);o+=4;for(var c=0;c<u;c++){var d=t.readUInt32(e,o,o+4);o+=4;var h=3*d;startBuff=o,endBuff=o+4*h,o+=4*h,d=t.readUInt32(e,o,o+4),o+=4,o+=1*(3*d);var f=t.readUInt32(e,o,o+4);o+=4;var g=t.readUInt8(e,o,o+1);o+=1,o+=4*g,o+=4*g,o+=2*f}}else{var p=new Ht;p.idx=l,r[l]=p;var m=new G;m.minX=new Float32Array(e.slice(o,o+4)),o+=4,m.minY=new Float32Array(e.slice(o,o+4)),o+=4,m.minZ=new Float32Array(e.slice(o,o+4)),o+=4,m.maxX=new Float32Array(e.slice(o,o+4)),o+=4,m.maxY=new Float32Array(e.slice(o,o+4)),o+=4,m.maxZ=new Float32Array(e.slice(o,o+4)),o+=4;var v=m.getMaxLength();p.isSmallObj=v<.5,p.radius=v/2,m.deleteObjects(),m=void 0;u=t.readInt32(e,o,o+4);o+=4;for(c=0;c<u;c++){var x=p.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();o=x.readPosNorIdx(e,a,o),p.vertexCount=x.vertexCount}}}return this.fileLoadState=I.fileLoadState.PARSE_FINISHED,!0},kt.prototype.prepareData=function(e,t){if("0.0.1"===this.version);else if("0.0.2"===this.version){void 0===this.blocksArrayPartitionsArray&&(this.blocksArrayPartitionsArray=[]);var r=this.blocksArrayPartitionsArray.length;if(0===r){var i=0,o=this.blocksArrayPartitionsMasterPathName+i.toString(),n=new Vt;this.blocksArrayPartitionsArray.push(n),e.readerWriter.getNeoBlocksArraybuffer_partition(o,t,n,e)}else{if(this.blocksArrayPartitionsArray[r-1].fileLoadState===I.fileLoadState.PARSE_FINISHED&&r<this.blocksArrayPartitionsCount){i=r,o=this.blocksArrayPartitionsMasterPathName+i.toString(),n=new Vt;this.blocksArrayPartitionsArray.push(n),e.readerWriter.getNeoBlocksArraybuffer_partition(o,t,n,e)}}}};var jt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.centerPos=new Jr,this.transformedCenterPos,this.half_dx=0,this.half_dy=0,this.half_dz=0,this.octree_owner,t&&(this.octree_owner=t,this.octree_level=t.octree_level+1),this.octree_level=0,this.octree_number_name=0,this.neoBuildingOwnerId,this.neoBuildingOwner,this.octreeKey,this.lod,this.fileLoadState=I.fileLoadState.READY,this.subOctrees_array=[],this.lowestOctrees_array,this.trianglesArray,this.currentVisibleOctreesArray,this.collisionState=!1,this.boundingSphere,this.collidedWithMeCollisionOctreesArray,this.vboKeysContainer,this.geoLocDataManager};jt.prototype.makeTreeByTrianglesArray=function(e){if(void 0!==this.trianglesArray&&0!==this.trianglesArray.length&&void 0!==e){var t=e.desiredMinOctreeSize/2;if(this.half_dx>t||this.half_dy>t||this.half_dz>t){this.createChildren();for(var r=0;r<8;r++)this.subOctrees_array[r].takeIntersectedTriangles(this.trianglesArray);for(r=0;r<8;r++)this.subOctrees_array[r].makeTreeByTrianglesArray(e);this.trianglesArray=void 0}}},jt.prototype.takeIntersectedTriangles=function(e){if(void 0!==e){void 0===this.trianglesArray&&(this.trianglesArray=[]);for(var t=this.getBoundingBox(),r=e.length,i=0;i<r;i++){var o=e[i];t.intersectsWithTriangle(o)&&this.trianglesArray.push(o)}}},jt.prototype.extractLowestOctreesIfHasTriangles=function(e){if(void 0!==this.subOctrees_array){var t=this.subOctrees_array.length;if(void 0!==this.trianglesArray&&this.trianglesArray.length>0)e.push(this);else for(var r=0;r<t;r++)this.subOctrees_array[r].extractLowestOctreesIfHasTriangles(e)}},jt.prototype.render=function(e,t,r,i){if(void 0===this.sphere){var o=new J;o.setRGB(.9,.1,.1);var n={};return n.color=o,this.sphere=new Je(n),this.sphere.setRadius(this.getRadius()),void this.sphere.setCenterPoint(this.centerPos.x,this.centerPos.y,this.centerPos.z)}var a=e.getGl();a.uniform1i(t.hasAditionalMov_loc,!1);a.uniform1i(t.refMatrixType_loc,1),a.uniform3fv(t.refTranslationVec_loc,[this.centerPos.x,this.centerPos.y,this.centerPos.z]),this.sphere.renderLocal(e,t,r,i,!1)},jt.prototype.hasChildren=function(){return void 0!==this.subOctrees_array&&this.subOctrees_array.length>0},jt.prototype.createChildren=function(){this.subOctrees_array=[];for(var e=0;e<8;e++){var t=this.new_subOctree();t.octree_number_name=10*this.octree_number_name+(e+1),t.neoBuildingOwnerId=this.neoBuildingOwnerId,t.octreeKey=this.neoBuildingOwnerId+"_"+t.octree_number_name}this.setSizesSubBoxes()},jt.prototype.new_subOctree=function(){var e=new jt(this);return e.octree_level=this.octree_level+1,this.subOctrees_array.push(e),e},jt.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array.length>0){var e=this.centerPos.x,t=this.centerPos.y,r=this.centerPos.z,i=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(i,e,o,t,n,r),this.subOctrees_array[1].setBoxSize(e,a,o,t,n,r),this.subOctrees_array[2].setBoxSize(e,a,t,s,n,r),this.subOctrees_array[3].setBoxSize(i,e,t,s,n,r),this.subOctrees_array[4].setBoxSize(i,e,o,t,r,l),this.subOctrees_array[5].setBoxSize(e,a,o,t,r,l),this.subOctrees_array[6].setBoxSize(e,a,t,s,r,l),this.subOctrees_array[7].setBoxSize(i,e,t,s,r,l);for(var u=0;u<8;u++)this.subOctrees_array[u].setSizesSubBoxes()}},jt.prototype.setBoxSize=function(e,t,r,i,o,n){this.centerPos.x=(t+e)/2,this.centerPos.y=(i+r)/2,this.centerPos.z=(n+o)/2,this.half_dx=(t-e)/2,this.half_dy=(i-r)/2,this.half_dz=(n-o)/2},jt.prototype.getBoundingBox=function(e){return void 0===e&&(e=new G),void 0===this.transformedCenterPos&&(this.transformedCenterPos=new Jr,this.transformedCenterPos.copyFrom(this.centerPos)),e.set(this.transformedCenterPos.x-this.half_dx,this.transformedCenterPos.y-this.half_dy,this.transformedCenterPos.z-this.half_dz,this.transformedCenterPos.x+this.half_dx,this.transformedCenterPos.y+this.half_dy,this.transformedCenterPos.z+this.half_dz),e},jt.prototype.getRadius=function(){return this.getBoundingBox().getRadius()},jt.prototype.getBoundingSphere=function(){return void 0===this.transformedCenterPos&&(this.transformedCenterPos=new Jr,this.transformedCenterPos.copyFrom(this.centerPos)),this.boundingSphere=new z(this.transformedCenterPos.x,this.transformedCenterPos.y,this.transformedCenterPos.z,this.getRadius()),this.boundingSphere},jt.prototype.checkCollision=function(e,t){if(void 0===e)return!1;var r=this.getBoundingSphere(),i=e.getBoundingSphere();if(r.intersectsWithBSphere(i)===F.INTERSECTION_OUTSIDE)return!1;if(!this.hasChildren()&&!e.hasChildren())return void 0!==e.trianglesArray&&0!==e.trianglesArray.length&&void 0!==this.trianglesArray&&0!==this.trianglesArray.length&&t.push(this),!0;if(r.r>i.r)if(this.hasChildren())for(var o=this.subOctrees_array.length,n=0;n<o;n++){(a=this.subOctrees_array[n]).checkCollision(e,t)}else for(o=e.subOctrees_array.length,n=0;n<o;n++){var a=e.subOctrees_array[n];this.checkCollision(a,t)}else if(e.hasChildren())for(o=e.subOctrees_array.length,n=0;n<o;n++){a=e.subOctrees_array[n];this.checkCollision(a,t)}else for(o=this.subOctrees_array.length,n=0;n<o;n++){(a=this.subOctrees_array[n]).checkCollision(e,t)}},jt.prototype.translate=function(e,t){if(void 0!==e&&(void 0===this.transformedCenterPos&&(this.transformedCenterPos=new Jr,this.transformedCenterPos.copyFrom(this.centerPos)),void 0===t&&(t=!1),t&&this.transformedCenterPos.copyFrom(this.centerPos),this.transformedCenterPos.addPoint(e),this.hasChildren()))for(var r=this.subOctrees_array.length,i=0;i<r;i++)this.subOctrees_array[i].translate(e,t)},jt.prototype.transformByMatrix4=function(e,t){if(void 0!==e&&(void 0===this.transformedCenterPos&&(this.transformedCenterPos=new Jr,this.transformedCenterPos.copyFrom(this.centerPos)),void 0===t&&(t=!1),t&&this.transformedCenterPos.copyFrom(this.centerPos),this.transformedCenterPos=e.transformPoint3D(this.transformedCenterPos,this.transformedCenterPos),this.hasChildren()))for(var r=this.subOctrees_array.length,i=0;i<r;i++)this.subOctrees_array[i].transformByMatrix4(e,t)};var Wt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.projectsMap={},this.staticModelsManager};Wt.prototype.deleteNodes=function(e,t){for(var r in this.projectsMap)if(Object.prototype.hasOwnProperty.call(this.projectsMap,r)){var i=this.projectsMap[r];for(var o in i)if(Object.prototype.hasOwnProperty.call(i,o)){var n=i[o];n instanceof lr&&(n.deleteObjects(e,t),delete i[o])}delete this.projectsMap[r]}this.projectsMap={}},Wt.prototype.getStaticModelsManager=function(){return void 0===this.staticModelsManager&&(this.staticModelsManager=new Ti),this.staticModelsManager},Wt.prototype.getNodeByDataName=function(e,t,r){var i=this.getNodesMap(e);if(void 0!==i){var o;for(var n in i)if(Object.prototype.hasOwnProperty.call(i,n)){var a=i[n];if(void 0!==a.data&&a.data[t]===r){o=a;break}}return o}},Wt.prototype.getNodeByDataKey=function(e,t){var r=this.getNodesMap(e);if(void 0!==r)return r[t]},Wt.prototype.getRootNodes=function(e,t){void 0===t&&(t=[]);var r=this.projectsMap[e];for(var i in r)if(Object.prototype.hasOwnProperty.call(r,i)){var o=r[i];o instanceof lr&&void 0===o.parent&&t.push(o)}return t},Wt.prototype.existProject=function(e){return this.projectsMap.hasOwnProperty(e)},Wt.prototype.getNodesMap=function(e,t){var r=this.projectsMap[e];return void 0===r?(r={},void 0!==t&&(r.attributes=t),this.projectsMap[e]=r):void 0!==t&&void 0===r.attributes&&(r.attributes=t),r},Wt.prototype.newNode=function(e,t,r){var i,o=this.getNodesMap(t,r);void 0===(i=o[e])&&((i=new lr).data={nodeId:e},o[e]=i);return i};var Xt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vbo_vicks_container=new xt,this.fileLoadState=I.fileLoadState.READY,this.bbox,this.dataArrayBuffer,this.selColor4,this.hasTexCoords,this.texture,this.textureName,this.legoKey,this.xhr,this.renderableType,this.hasColors,this.blendAlpha=0,this.birthTime,this.isAdult=!1,this.dataArrayBuffer};Xt.prototype.parseArrayBuffer=function(e,t){this.parseLegoData(e,t)},Xt.prototype.getBlendAlpha=function(e){return 1},Xt.prototype.isReadyToRender=function(){return this.fileLoadState===I.fileLoadState.PARSE_FINISHED&&(void 0!==this.texture&&void 0!==this.texture.texId)},Xt.prototype.deleteObjects=function(e,t){void 0!==this.vbo_vicks_container&&(this.vbo_vicks_container.deleteGlObjects(e,t),this.vbo_vicks_container=void 0),this.fileLoadState=void 0,this.dataArrayBuffer=void 0,void 0!==this.selColor4&&(this.selColor4.deleteObjects(),this.selColor4=void 0),this.textureName=void 0,this.texture&&this.texture.deleteObjects(e),this.texture=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0},Xt.prototype.parsePointsCloudData=function(e,t,r){if(this.fileLoadState===I.fileLoadState.LOADING_FINISHED){var i=new DataStream(e,0,DataStream.LITTLE_ENDIAN),o=i.readInt32(),n=r.vboMemoryManager;this.fileLoadState=I.fileLoadState.PARSE_STARTED,this.bbox=new G;var a=this.bbox,s=this.vbo_vicks_container.newVBOVertexIdxCacheKey();a.minX=i.readFloat32(),a.minY=i.readFloat32(),a.minZ=i.readFloat32(),a.maxX=i.readFloat32(),a.maxY=i.readFloat32(),a.maxZ=i.readFloat32(),this.bPositionsCompressed=i.readInt8();if(this.bPositionsCompressed?s.setDataArrayPos(i.readUint16Array(3*o),n):s.setDataArrayPos(i.readFloat32Array(3*o),n),this.hasNormals=i.readInt8(),this.hasNormals,this.hasColors=i.readInt8(),this.hasColors){var l=o;s.setDataArrayCol(i.readUint8Array(4*l),n)}this.hasTexCoords=i.readInt8(),this.hasTexCoords,this.hasIndices=i.readInt8(),this.hasIndices,this.fileLoadState=I.fileLoadState.PARSE_FINISHED}},Xt.prototype._parseLegoDataResultFromWorker=function(e,t){var r=t.vboMemoryManager,i=t._settings.keepVboPositionDataArrayBuffers;void 0===this.vbo_vicks_container&&(this.vbo_vicks_container=new xt),this.bbox=new G;var o=this.bbox,n=this.vbo_vicks_container.newVBOVertexIdxCacheKey(),a=e.bboxSize;o.set(a[0],a[1],a[2],a[3],a[4],a[5]),n.setDataArrayPos(e.posDataArray,r),i&&(n.vboBufferPos.bKeepDataArray=!0),e.norDataArray&&n.setDataArrayNor(e.norDataArray,r),e.colDataArray&&n.setDataArrayCol(e.colDataArray,r),this.hasTexCoords=void 0!==e.texCoordsArray,this.hasTexCoords&&n.setDataArrayTexCoord(e.texCoordsArray,r),this.fileLoadState=I.fileLoadState.PARSE_FINISHED,this.parsedFromWorker=!0},Xt.prototype.parseLegoData=function(e,t,r){if(this.fileLoadState===I.fileLoadState.LOADING_FINISHED||this.fileLoadState===I.fileLoadState.IN_PARSE_QUEUE){if(void 0===e&&(e=this.dataArrayBuffer),void 0===e)return r;var i=t.vboMemoryManager,o=t._settings.keepVboPositionDataArrayBuffers;void 0===r&&(r=0),void 0===this.vbo_vicks_container&&(this.vbo_vicks_container=new xt),this.fileLoadState=I.fileLoadState.PARSE_STARTED,this.bbox=new G;var n=this.bbox,a=this.vbo_vicks_container.newVBOVertexIdxCacheKey();r=n.readData(e,r);var s=new Int32Array(e.slice(r,r+4))[0],l=4,u=r+=4,c=r+l*s*3,d=new Float32Array(e.slice(u,c));a.setDataArrayPos(d,i),r+=l*s*3,o&&(a.vboBufferPos.bKeepDataArray=!0);var h=new Uint8Array(e.slice(r,r+1))[0];if(r+=1,h){var f=new Int32Array(e.slice(r,r+4))[0];u=r+=4,c=r+(l=1)*f*3;var g=new Int8Array(e.slice(u,c));a.setDataArrayNor(g,i),r+=l*f*3}var p=new Uint8Array(e.slice(r,r+1))[0];if(r+=1,p){var m=new Int32Array(e.slice(r,r+4))[0];u=r+=4,c=r+(l=1)*m*4;var v=new Uint8Array(e.slice(u,c));a.setDataArrayCol(v,i),r+=l*m*4}if(this.hasTexCoords=new Uint8Array(e.slice(r,r+1))[0],r+=1,this.hasTexCoords){new Uint16Array(e.slice(r,r+2))[0];r+=2;var x=new Uint32Array(e.slice(r,r+4))[0];u=r+=4,c=r+(l=4)*x*2;var _=new Float32Array(e.slice(u,c));a.setDataArrayTexCoord(_,i),r+=l*x*2}return this.fileLoadState=I.fileLoadState.PARSE_FINISHED,r}},Xt.prototype.makeStencilShadowMesh=function(e){if(void 0!==this.vbo_vicks_container){this.shadowMeshesArray=[];for(var t=this.vbo_vicks_container.getVbosCount(),r=0;r<t;r++){var i=this.vbo_vicks_container.getVboKey(r),o=kr.fromVbo(i);void 0!==o&&this.shadowMeshesArray.push(o)}}},Xt.prototype.renderStencilShadowMeshes=function(e,t,r,i,o){},Xt.prototype.render=function(e,t,r,i,o){var n=!1,a=e.sceneState.gl;if(void 0===o)return!1;if(0===this.vbo_vicks_container.vboCacheKeysArray.length)return!1;if(3!==t){var s=this.vbo_vicks_container.vboCacheKeysArray[0],l=s.vertexCount;if(0===l)return!1;if(0===t){if(i.disableVertexAttribArray(i.texCoord2_loc),i.enableVertexAttribArray(i.normal3_loc),i.disableVertexAttribArray(i.color4_loc),a.uniform1i(i.bHasTexture_loc,!1),!s.bindDataPosition(i,e.vboMemoryManager))return!1;if(i.normal3_loc>=0&&!s.bindDataNormal(i,e.vboMemoryManager))return!1;a.drawArrays(a.TRIANGLES,0,l),n=!0}else if(1===t){if(void 0===e.isTrailRender||!1===e.isTrailRender){var u=this.getBlendAlpha(e.currTime);a.uniform1f(i.externalAlpha_loc,u)}if(r&&s.vboBufferTCoord){if(!s.bindDataTexCoord(i,e.vboMemoryManager))return!1}else i.disableVertexAttribArray(i.texCoord2_loc),s.bindDataColor(i,e.vboMemoryManager),o.isColorChanged||!s.vboBufferCol?a.uniform1i(i.colorType_loc,0):a.uniform1i(i.colorType_loc,1);if(!s.bindDataPosition(i,e.vboMemoryManager))return!1;if(!s.bindDataNormal(i,e.vboMemoryManager))return!1;if(r&&void 0!==s.vboBufferTCoord&&(i.disableVertexAttribArray(i.color4_loc),!s.bindDataTexCoord(i,e.vboMemoryManager)))return!1;a.drawArrays(a.TRIANGLES,0,l),e.sceneState.trianglesRenderedCount+=l/3,n=!0,i.disableVertexAttribArray(i.color4_loc)}return n}var c=e.processCounterManager;if(void 0!==this.shadowMeshesArray)for(var d=this.shadowMeshesArray.length,h=0;h<d;h++){this.shadowMeshesArray[h].renderAsChild(e,i,t,void 0,!1)}else if(0===c.shadowMeshesMadeCount){var f=o.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData(),g=e.sceneState.sunSystem.getSunDirWC(),p=f.getRotatedRelativeVector(g,p);this.makeStencilShadowMesh(p),c.shadowMeshesMadeCount++}};var Yt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.dataType,this.distToCam,this.lod,this.filePath,this.texFilePath,this.skinMesh,this.octree,this.texture};Yt.prototype.deleteObjects=function(){this.dataType=void 0,this.distToCam=void 0,this.lod=void 0,this.filePath=void 0,this.texFilePath=void 0,this.skinMesh=void 0,this.octree=void 0,this.texture=void 0};var qt=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager,void 0!==t&&(this.magoManager=t),this.lod2PCloudDataMap={},this.tinTerrainDataMap={}};qt.prototype.putLod2PCloudData=function(e,t,r,i,o){e.lego.fileLoadState=I.fileLoadState.IN_QUEUE;var n=new Yt;n.filePath=t,n.octree=e,n.texFilePath=i,n.texture=r,this.lod2PCloudDataMap[t]=n},qt.prototype.resetQueue=function(){for(var e in this.lod2PCloudDataMap)if(Object.prototype.hasOwnProperty.call(this.lod2PCloudDataMap,e)){var t=this.lod2PCloudDataMap[e];if(void 0===t.octree||void 0===t.octree.lego)continue;t.octree.lego.fileLoadState=I.fileLoadState.READY}this.lod2PCloudDataMap={}},qt.prototype.manageQueue=function(){var e=this.magoManager.readerWriter,t=(this.magoManager.sceneState.gl,0);if(!this.magoManager.fileRequestControler.isFullPlusLowLodImages()){for(var r in t=0,this.lod2PCloudDataMap)if(Object.prototype.hasOwnProperty.call(this.lod2PCloudDataMap,r)){var i=this.lod2PCloudDataMap[r],o=i.octree,n=i.filePath;if(void 0!==o.lego&&e.getOctreePCloudArraybuffer(n,o,this.magoManager),delete this.lod2PCloudDataMap[r],i.deleteObjects(),i=void 0,++t>4){!0;break}}this.resetQueue()}};var Kt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.attributes,this.skinLego,this.texture};Kt.prototype.isReadyToRender=function(){return void 0!==this.skinLego&&(this.skinLego.fileLoadState===I.fileLoadState.PARSE_FINISHED&&("noTexture"===this.skinLego.textureName||void 0!==this.texture&&void 0!==this.texture.texId))},Kt.prototype.render=function(e,t,r,i,o){return this.skinLego.render(e,t,r,i,o)};var Zt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.lod,this.isModelRef,this.geometryFileName,this.textureFileName},Jt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.guid,this.version="",this.geographicCoord,this.heading,this.pitch,this.roll,this.bbox,this.imageLodCount,this.projectDataType,this.offSetX,this.offSetY,this.offSetZ,this.oct_min_x=0,this.oct_max_x=0,this.oct_min_y=0,this.oct_max_y=0,this.oct_min_z=0,this.oct_max_z=0,this.isSmall=!1,this.fileLoadState=I.fileLoadState.READY};Jt.prototype.deleteObjects=function(){this.guid=void 0,this.geographicCoord&&this.geographicCoord.deleteObjects(),this.geographicCoord=void 0,this.heading=void 0,this.pitch=void 0,this.roll=void 0,this.bbox&&this.bbox.deleteObjects(),this.bbox=void 0,this.imageLodCount=void 0,this.oct_min_x=void 0,this.oct_max_x=void 0,this.oct_min_y=void 0,this.oct_max_y=void 0,this.oct_min_z=void 0,this.oct_max_z=void 0,this.isSmall=void 0,this.fileLoadState=void 0},Jt.prototype.getProjectDataType=function(){return this.projectDataType},Jt.prototype.parseFileHeaderAsimetricVersion=function(e,t){var r,i=new TextDecoder("utf-8");this.version="",this.version=i.decode(new Int8Array(e.slice(t,t+5))),t+=5,void 0===this.guid&&(this.guid=""),r=hr.readInt32(e,t,t+4),t+=4,this.guid=i.decode(new Int8Array(e.slice(t,t+r))),t+=r,void 0===this.longitude?(this.longitude=new Float64Array(e.slice(t,t+8))[0],t+=8):t+=8,void 0===this.latitude?(this.latitude=new Float64Array(e.slice(t,t+8))[0],t+=8):t+=8,void 0===this.altitude?(this.altitude=new Float32Array(e.slice(t,t+4))[0],t+=4):t+=4,void 0===this.bbox&&(this.bbox=new G),t=this.bbox.readData(e,t);var o=!1;return(this.bbox.maxX-this.bbox.minX>40||this.bbox.maxY-this.bbox.minY>40)&&(o=!0),!o&&this.bbox.maxZ-this.bbox.minZ<30&&(this.isSmall=!0),this.projectDataType=0,"0.0.2"===this.version&&(this.projectDataType=new Uint16Array(e.slice(t,t+2))[0],t+=2,this.offSetX=new Float64Array(e.slice(t,t+8))[0],t+=8,this.offSetY=new Float64Array(e.slice(t,t+8))[0],t+=8,this.offSetZ=new Float64Array(e.slice(t,t+8))[0],t+=8),t};var Qt=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.modelIdx,this.referencesIdxArray=[]},$t=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.modelReferencedGroupsMap=[],this.modelReferencedGroupsArray=[]};$t.prototype.getModelReferencedGroup=function(e){var t=this.modelReferencedGroupsMap[e];return void 0===t&&((t=new Qt).modelIdx=e,this.modelReferencedGroupsMap[e]=t),t},$t.prototype.makeModelReferencedGroupsArray=function(){this.modelReferencedGroupsArray.length=0;for(var e=this.modelReferencedGroupsMap.length,t=0;t<e;t++)void 0!==this.modelReferencedGroupsMap[t]&&this.modelReferencedGroupsArray.push(this.modelReferencedGroupsMap[t]);this.modelReferencedGroupsMap.length=0},$t.prototype.createModelReferencedGroups=function(e,t){if(void 0!==e&&void 0!==t){for(var r,i,o=e.length,n=0;n<o;n++)i=t[r=e[n]]._block_idx,this.getModelReferencedGroup(i).referencesIdxArray.push(r);this.makeModelReferencedGroupsArray()}};var er=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.skinBuildingsArray,this.fileLoadState=I.fileLoadState.READY,this.dataArrayBuffer,this.bbox,this.geoCoords,this.vboKeysContainer,this.multiBuildingsElementsArray=[]};er.prototype.prepareData=function(e){if(this.fileLoadState===I.fileLoadState.READY){var t=this.nodeOwner,r=t.data.projectFolderName,i=t.data.multiBuildingsFolderName,o=i,n=e.readerWriter,a=e.readerWriter.geometryDataPath+"/"+r+"/"+i+"/"+o;n.getMultiBuildingsDataArrayBuffer(a,this,e)}},er.prototype.render=function(e,t){if(!this.isReadyToRender())return!1;if(void 0===this.vboKeysContainer)return!1;var r=e.getGl();this.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,t);var i=e.vboMemoryManager;if(0===this.vboKeysContainer.getVbosCount())return!1;var o=this.vboKeysContainer.getVboKey(0);if(!o.bindDataPosition(t,i))return!1;if(!o.bindDataNormal(t,i))return!1;if(!o.bindDataTexCoord(t,i))return!1;for(var n=this.multiBuildingsElementsArray.length,a=0;a<n;a++){this.multiBuildingsElementsArray[a].render(e,t)}},er.prototype.isReadyToRender=function(){return this.fileLoadState===I.fileLoadState.PARSE_FINISHED},er.prototype.parseData=function(e){if(this.fileLoadState!==I.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this.dataArrayBuffer)return!1;this.fileLoadState=I.fileLoadState.PARSE_STARTED,void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt);var t=this.vboKeysContainer.newVBOVertexIdxCacheKey(),r=this.dataArrayBuffer,i=0,o=e.vboMemoryManager;this.version="";for(var n=0;n<5;n++)this.version+=String.fromCharCode(new Int8Array(r.slice(i,i+1))[0]),i+=1;void 0===this.bbox&&(this.bbox=new G),i=this.bbox.readData(r,i),void 0===this.geoCoords&&(this.geoCoords=new pe),this.geoCoords.longitude=new Float64Array(r.slice(i,i+8))[0],i+=8,this.geoCoords.latitude=new Float64Array(r.slice(i,i+8))[0],i+=8,this.geoCoords.altitude=new Float32Array(r.slice(i,i+4))[0],i+=4,i=t.readPositions(r,o,i);var a=new Int8Array(r.slice(i,i+1))[0];i+=1,a&&(i=t.readNormals(r,o,i));var s=new Int8Array(r.slice(i,i+1))[0];i+=1,s&&(i=t.readTexCoords(r,o,i));var l=new Int8Array(r.slice(i,i+1))[0];i+=1,l&&(i=t.readColors(r,o,i));new Int8Array(r.slice(i,i+1))[0];i+=1;var u=new Int32Array(r.slice(i,i+4))[0];i+=4;for(var c=0;c<u;c++){var d=new tr;i=d.parseData(r,i),d.multiBuildingsOwner=this,this.multiBuildingsElementsArray.push(d)}var h=new Int32Array(r.slice(i,i+4))[0];i+=4,h>0&&void 0===this.texturesManager&&(this.texturesManager=new at);for(c=0;c<h;c++){var f=new Int32Array(r.slice(i,i+4))[0];i+=4;var g=new Int32Array(r.slice(i,i+4))[0];i+=4;var p="";for(n=0;n<g;n++)p+=String.fromCharCode(new Int8Array(r.slice(i,i+1))[0]),i+=1;var m=new Int32Array(r.slice(i,i+4))[0],v=i+=4,x=i+1*m,_=r.slice(v,x);i+=1*m;var y=this.texturesManager.getOrNewTexture(f);y.textureTypeName="diffuse",y.textureImageFileName=p,y.imageBinaryData=_,y.fileLoadState=I.fileLoadState.LOADING_FINISHED}this.fileLoadState=I.fileLoadState.PARSE_FINISHED};var tr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.multiBuildingsOwner,this.name,this.id,this.bbox,this.geoCoords,this.indexRange,this.localIndexRangesArray};tr.prototype.render=function(e,t){if(void 0===this.localIndexRangesArray)return!1;for(var r=e.getGl(),i=this.localIndexRangesArray.length,o=0;o<i;o++){var n=this.localIndexRangesArray[o],a=n.strIdx,s=n.endIdx-a+1,l=n.attributes.materialId;if(void 0!==l&&l>=0){var u=this.multiBuildingsOwner.texturesManager.getTexture(l);if(void 0!==u&&void 0===u.texId){at.newWebGlTextureByEmbeddedImage(r,u.imageBinaryData,u)}void 0!==u&&void 0!==u.texId&&(r.uniform1i(t.colorType_loc,2),t.last_tex_id!==u.texId&&(r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,u.texId),t.last_tex_id=u.texId))}r.drawArrays(r.TRIANGLES,a,s)}return!0},tr.prototype.parseData=function(e,t){this.name="";var r=new Int16Array(e.slice(t,t+2))[0];t+=2;for(var i=0;i<r;i++)this.name+=String.fromCharCode(new Int8Array(e.slice(t,t+1))[0]),t+=1;this.id="";var o=new Int16Array(e.slice(t,t+2))[0];t+=2;for(i=0;i<o;i++)this.id+=String.fromCharCode(new Int8Array(e.slice(t,t+1))[0]),t+=1;void 0===this.bbox&&(this.bbox=new G),t=this.bbox.readData(e,t),void 0===this.geoCoords&&(this.geoCoords=new pe),this.geoCoords.longitude=new Float64Array(e.slice(t,t+8))[0],t+=8,this.geoCoords.latitude=new Float64Array(e.slice(t,t+8))[0],t+=8,this.geoCoords.altitude=new Float32Array(e.slice(t,t+4))[0],t+=4,void 0===this.indexRange&&(this.indexRange=new Dr),this.indexRange.strIdx=new Uint32Array(e.slice(t,t+4))[0],t+=4,this.indexRange.endIdx=new Uint32Array(e.slice(t,t+4))[0],t+=4,this.localIndexRangesArray=[];var n=new Uint32Array(e.slice(t,t+4))[0];t+=4;for(var a=0;a<n;a++){var s=new Dr;s.strIdx=new Uint32Array(e.slice(t,t+4))[0],t+=4,s.endIdx=new Uint32Array(e.slice(t,t+4))[0],t+=4;var l=new Uint32Array(e.slice(t,t+4))[0];t+=4,s.attributes={materialId:l},this.localIndexRangesArray.push(s)}return t};var rr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.name="",this.metaData,this.buildingId,this.buildingType,this.buildingFileName="",this.bbox,this.bboxAbsoluteCenterPos,this.motherNeoReferencesArray=[],this.motherNeoReferencesMap,this.motherBlocksArray=[],this.isHighLighted,this.isColorChanged,this.aditionalColor,this.texturesLoaded,this.texturesManager,this.octree,this.currentLod,this.currentVisibleOctreesControler,this.myCameraRelative,this.simpleBuilding3x3Texture,this.lodMeshesMap,this.lodBuildingDatasMap,this.lodBuildingMap,this.applyOcclusionCulling,this.headerDataArrayBuffer,this.attributes};rr.prototype.getImageFileNameForLOD=function(e){var t=this.getLodBuildingData(e);if(void 0!==t)return t.textureFileName},rr.prototype.setAttribute=function(e,t){void 0===this.attributes&&(this.attributes={}),this.attributes[e]=t},rr.prototype.getReferenceObject=function(e){if(void 0!==this.motherNeoReferencesArray)return this.motherNeoReferencesArray[e]},rr.prototype.getReferenceObjectsArrayByObjectId=function(e){if(void 0!==this.motherNeoReferencesMap)return this.motherNeoReferencesMap[e]},rr.prototype.putReferenceObject=function(e,t){void 0===this.motherNeoReferencesArray&&(this.motherNeoReferencesArray=[]),this.motherNeoReferencesArray[t]=e,void 0===this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={});var r=this.motherNeoReferencesMap[e.objectId];void 0===r&&(r=[]),r.push(e),this.motherNeoReferencesMap[e.objectId]=r},rr.prototype.getRenderSettingApplyOcclusionCulling=function(){return this.applyOcclusionCulling},rr.prototype.setRenderSettingApplyOcclusionCulling=function(e){this.applyOcclusionCulling=e},rr.prototype.deleteObjectsModelReferences=function(e,t){this.motherNeoReferencesMap&&(this.motherNeoReferencesMap={},this.motherNeoReferencesMap=void 0);for(var r=this.motherBlocksArray.length,i=0;i<r;i++)this.motherBlocksArray[i]&&this.motherBlocksArray[i].deleteObjects(e,t),this.motherBlocksArray[i]=void 0;this.motherBlocksArray=[];var o=this.motherNeoReferencesArray.length;for(i=0;i<o;i++)this.motherNeoReferencesArray[i]&&this.motherNeoReferencesArray[i].deleteObjects(e,t),this.motherNeoReferencesArray[i]=void 0;if(this.motherNeoReferencesArray=[],this.texturesLoaded){var n,a=this.texturesLoaded.length;for(i=0;i<a;i++)(n=this.texturesLoaded[i])&&n.texId&&(e.deleteTexture(n.texId),n.texId=void 0,n.fileLoadState=I.fileLoadState.READY)}},rr.prototype.deleteObjectsLodMesh=function(e,t,r){if(void 0!==this.lodMeshesMap&&Object.prototype.hasOwnProperty.call(this.lodMeshesMap,r)){var i=this.lodMeshesMap[r];if(void 0===i)return;delete this.lodMeshesMap[r],i.deleteObjects(e,t),i=void 0}},rr.prototype.deleteObjectsLod2=function(e,t){void 0!==this.octree&&this.octree.deleteObjectsLego(e,t)},rr.prototype.isDeletable=function(){return void 0===this.attributes||void 0===this.attributes.isDeletable||!1!==this.attributes.isDeletable},rr.prototype.deleteObjects=function(e,t,r){if(this.isDeletable()){if(r&&this.metaData.deleteObjects(),this.metaData.fileLoadState=I.fileLoadState.READY,this.deleteObjectsModelReferences(e,t),void 0!==this.octree&&this.octree.deleteObjects(e,t),this.octree=void 0,this.allFilesLoaded=!1,this.isReadyToRender=!1,this.texturesLoaded){for(var i=this.texturesLoaded.length,o=0;o<i;o++)this.texturesLoaded[o]&&this.texturesLoaded[o].deleteObjects(e),this.texturesLoaded[o]=void 0;this.texturesLoaded.length=0}if(this.texturesLoaded=void 0,void 0!==this.lodMeshesMap){for(var n in this.lodMeshesMap)if(Object.prototype.hasOwnProperty.call(this.lodMeshesMap,n)){var a=this.lodMeshesMap[n];if(void 0===a)continue;a.deleteObjects(e,t),a=void 0}this.lodMeshesMap=void 0}}},rr.prototype.deleteLodMesh=function(e,t,r){if(void 0!==this.lodMeshesMap){var i=this.lodMeshesMap[t];void 0!==i&&(i.deleteObjects(e,r),i=void 0)}},rr.prototype.getBBox=function(){return void 0!==this.bbox?this.bbox:void 0!==this.metaData&&void 0!==this.metaData.bbox?this.metaData.bbox:void 0},rr.prototype.getBBoxCenterPositionWorldCoord=function(e){return void 0===this.bboxAbsoluteCenterPos&&this.calculateBBoxCenterPositionWorldCoord(e),this.bboxAbsoluteCenterPos},rr.prototype.calculateBBoxCenterPositionWorldCoord=function(e){var t,r;(t=this.bbox.getCenterPoint(t),this.bboxAbsoluteCenterPos=e.tMatrix.transformPoint3D(t,this.bboxAbsoluteCenterPos),e.pivotPointTraslation)&&(r=e.tMatrix.rotatePoint3D(e.pivotPointTraslation,r),this.bboxAbsoluteCenterPos.add(r.x,r.y,r.z))},rr.prototype.getTextureId=function(e){for(var t,r=this.texturesLoaded.length,i=!1,o=0;!i&&o<r;)this.texturesLoaded[o].textureImageFileName===e.textureImageFileName&&(i=!0,t=this.texturesLoaded[o].texId),o++;return t},rr.prototype.getSameTexture=function(e){for(var t,r=this.texturesLoaded.length,i=!1,o=0;!i&&o<r;)this.texturesLoaded[o].textureImageFileName===e.textureImageFileName&&(i=!0,t=this.texturesLoaded[o]),o++;return t},rr.prototype.updateCurrentVisibleIndicesExterior=function(e,t,r){this._neoRefLists_Container.updateCurrentVisibleIndicesOfLists(e,t,r)},rr.prototype.updateCurrentAllIndicesExterior=function(){this._neoRefLists_Container.updateCurrentAllIndicesOfLists()},rr.prototype.isCameraInsideOfBuilding=function(e,t,r){return this.metaData.bbox.isPoint3dInside(e,t,r)},rr.prototype.getTransformedRelativeEyePositionToBuilding=function(e,t,r,i){var o=this.buildingPosition,n=e-o.x,a=t-o.y,s=r-o.z;void 0===this.buildingPosMatInv&&(this.buildingPosMatInv=new Ne,this.buildingPosMatInv.setByFloat32Array(this.moveMatrixInv));var l=new Jr;return void 0===i&&(i=new Jr),l.set(n,a,s),i=this.buildingPosMatInv.transformPoint3D(l,i)},rr.prototype.getHeaderVersion=function(){return this.metaData?this.metaData.version:void 0},rr.prototype.getLodBuildingData=function(e){if(void 0!==this.lodBuildingDatasMap)return this.lodBuildingDatasMap[e]},rr.prototype.getOrNewLodMesh=function(e){void 0===this.lodMeshesMap&&(this.lodMeshesMap={});var t=this.lodMeshesMap[e];return void 0===t&&((t=new Xt).fileLoadState=I.fileLoadState.READY,t.legoKey=this.buildingId+"_"+e,this.lodMeshesMap[e]=t),t},rr.prototype.getOrNewLodBuilding=function(e){void 0===this.lodBuildingMap&&(this.lodBuildingMap={});var t=this.lodBuildingMap[e];return void 0===t&&((t=new Kt).attributes={},this.lodBuildingMap[e]=t),t},rr.prototype.getCurrentLodString=function(){return this.getLodBuildingData(this.currentLod).geometryFileName},rr.prototype.getLowerSkinLodToLoad=function(e){for(var t,r=5;r>=0&&!(r<e);r--){var i,o="lod"+r.toString();if(void 0!==this.lodBuildingMap&&(i=this.lodBuildingMap[o]),void 0===i||void 0===i.skinLego||i.skinLego.fileLoadState!==I.fileLoadState.PARSE_FINISHED){t=r;break}if(void 0===i.skinLego.vbo_vicks_container.vboCacheKeysArray){t=r;break}if(i.skinLego.vbo_vicks_container.vboCacheKeysArray[0]&&i.skinLego.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord){if(void 0===i.texture){t=r;break}if(void 0===i.texture.texId){if(i.texture.fileLoadState!==I.fileLoadState.BINDING_FINISHED&&i.texture.fileLoadState!==I.fileLoadState.LOADING_STARTED){t=r;break}break}}}return t},rr.prototype.getLowerSkinLodToLoad__original=function(e){for(var t,r=5;r>=0&&!(r<e);r--){var i=this.getLodBuildingData(r);if(void 0!==i&&!i.isModelRef){var o,n=i.geometryFileName;if(void 0!==this.lodMeshesMap&&(o=this.lodMeshesMap[n]),void 0===o||o.fileLoadState!==I.fileLoadState.PARSE_FINISHED){t=r;break}if(void 0===o.vbo_vicks_container.vboCacheKeysArray){t=r;break}if(o.vbo_vicks_container.vboCacheKeysArray[0]&&o.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord&&(void 0===o.texture||void 0===o.texture.texId)){t=r;break}}}return t},rr.prototype.getCurrentSkin=function(){if(void 0!==this.lodMeshesMap){var e=this.getLodBuildingData(this.currentLod);if(void 0!==e){var t=e.geometryFileName,r=this.lodBuildingMap[t];return void 0!==r&&r.isReadyToRender()?r:(0===this.currentLod?void 0!==(r=this.lodBuildingMap.lod0)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod1)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod2)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod3)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):1===this.currentLod?void 0!==(r=this.lodBuildingMap.lod1)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod2)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod3)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):2===this.currentLod?void 0!==(r=this.lodBuildingMap.lod2)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod3)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):3===this.currentLod?void 0!==(r=this.lodBuildingMap.lod3)&&r.isReadyToRender()||void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):4===this.currentLod?void 0!==(r=this.lodBuildingMap.lod4)&&r.isReadyToRender()||(r=this.lodBuildingMap.lod5):5===this.currentLod&&(r=this.lodBuildingMap.lod5),r)}}},rr.prototype.getCurrentSkin__original=function(){if(void 0!==this.lodMeshesMap){var e,t=this.getLodBuildingData(this.currentLod);if(void 0!==t){var r=t.geometryFileName;return void 0!==(e=this.lodMeshesMap[r])&&e.isReadyToRender()?e:(0===this.currentLod?void 0!==(e=this.lodMeshesMap.lod0)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod1)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod2)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod3)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):1===this.currentLod?void 0!==(e=this.lodMeshesMap.lod1)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod2)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod3)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):2===this.currentLod?void 0!==(e=this.lodMeshesMap.lod2)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod3)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):3===this.currentLod?void 0!==(e=this.lodMeshesMap.lod3)&&e.isReadyToRender()||void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):4===this.currentLod?void 0!==(e=this.lodMeshesMap.lod4)&&e.isReadyToRender()||(e=this.lodMeshesMap.lod5):5===this.currentLod&&(e=this.lodMeshesMap.lod5),e)}}},rr.prototype.manageNeoReferenceTexture=function(e,t){void 0===this.texturesManager&&(this.texturesManager=new at);var r=void 0,i=this.metaData.version;if("v"===i[0]){if(void 0===e.texture)return;if(void 0===e.texture.texId&&""!==e.texture.textureImageFileName){void 0===this.texturesLoaded&&(this.texturesLoaded=[]);var o=this.getSameTexture(e.texture);if(void 0===o){if(t.backGround_fileReadings_count>10)return;if(e.texture.fileLoadState===I.fileLoadState.READY){var n=t.sceneState.gl,a=this.projectFolderName,s=t.readerWriter.geometryDataPath+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+e.texture.textureImageFileName;this.texturesLoaded.push(e.texture),t.readerWriter.readNeoReferenceTexture(n,s,e.texture,this,t),t.backGround_fileReadings_count++}}else o.fileLoadState===I.fileLoadState.LOADING_FINISHED&&(e.texture=o)}return e.texture.fileLoadState}if("0"===i[0]&&"0"===i[2]&&"1"===i[4]){if(void 0===e.texture||e.texture.fileLoadState===I.fileLoadState.READY){var l=e.materialId;if(r=this.texturesLoaded[l],e.texture=r,r&&void 0===r.texId&&""!==r.textureImageFileName){if(t.backGround_fileReadings_count>10)return;if(r.fileLoadState===I.fileLoadState.READY){n=t.sceneState.gl,a=this.projectFolderName,s=t.readerWriter.getCurrentDataPath()+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+r.textureImageFileName;t.readerWriter.readNeoReferenceTexture(n,s,r,this,t),t.backGround_fileReadings_count++}}}if(e.texture)return e.texture.fileLoadState}else if("0"===i[0]&&"0"===i[2]&&"2"===i[4]){if(void 0===this.metaData.projectDataType||4===this.metaData.projectDataType||5===this.metaData.projectDataType)return e.texture.fileLoadState;if(void 0===e.texture||e.texture.fileLoadState===I.fileLoadState.READY){l=e.materialId;if(r=this.texturesLoaded[l],e.texture=r,r&&void 0===r.texId&&""!==r.textureImageFileName){if(t.backGround_fileReadings_count>10)return;if(r.fileLoadState===I.fileLoadState.READY){n=t.sceneState.gl,a=this.projectFolderName,s=t.readerWriter.getCurrentDataPath()+"/"+a+"/"+this.buildingFileName+"/Images_Resized/"+r.textureImageFileName;t.readerWriter.readNeoReferenceTexture(n,s,r,this,t),t.backGround_fileReadings_count++}}}if(e.texture)return e.texture.fileLoadState}},rr.prototype.getShaderName=function(e,t,r){var i;return 0===r?e<=1&&(i="modelRefDepth"):1===r&&e<=2&&(i="modelRefSsao"),i},rr.prototype.parseTexturesList=function(e,t){var r=new TextDecoder("utf-8"),i=hr.readInt32(e,t,t+4);t+=4;for(var o=0;o<i;o++){var n,a="",s=hr.readUInt32(e,t,t+4);t+=4,n=r.decode(new Int8Array(e.slice(t,t+s))),t+=s;var l=hr.readUInt32(e,t,t+4);t+=4;var u=new Uint8Array(e.slice(t,t+l));if(t+=l,a=r.decode(u),l>0){var c=new it;c.textureTypeName=n,c.textureImageFileName=a;var d=a.split(".").pop();c.textureImageFileExtension="PNG"===d||"png"===d?"PNG":d,void 0===this.texturesLoaded&&(this.texturesLoaded=[]),this.texturesLoaded.push(c)}}return t},rr.prototype.getTriangles=function(e){if(void 0===this.motherNeoReferencesArray||void 0===this.motherBlocksArray)return!1;var t;void 0===e&&(e=[]);for(var r=this.motherNeoReferencesArray.length,i=0;i<r;i++)void 0!==(t=this.motherNeoReferencesArray[i])&&(e=t.getTriangles(this,e));return e},rr.prototype.allModelsAndReferencesAreParsed=function(e){if(void 0===this.octree)return!1;var t=[];this.octree.extractLowestOctreesIfHasTriPolyhedrons(t);for(var r=t.length,i=0;i<r;i++){var o=t[i];if(void 0===o.neoReferencesMotherAndIndices)return!1;if(o.neoReferencesMotherAndIndices.fileLoadState!==I.fileLoadState.PARSE_FINISHED)return!1;if(o.neoReferencesMotherAndIndices.blocksList.fileLoadState!==I.fileLoadState.PARSE_FINISHED)return!1}return!0},rr.prototype.forceToLoadModelsAndReferences=function(e){var t={parseImmediately:!0},r=[];this.octree.extractLowestOctreesIfHasTriPolyhedrons(r);for(var i=r.length,o=0;o<i;o++){var n=r[o];if(0!==n.triPolyhedronsCount){var a=e.readerWriter.geometryDataPath,s=this.buildingFileName,l=this.projectFolderName,u=!1,c=this.attributes;if(void 0!==c&&void 0!==c.keepDataArrayBuffers&&!0===c.keepDataArrayBuffers&&(u=!0),void 0===n.neoReferencesMotherAndIndices&&(n.neoReferencesMotherAndIndices=new nr,n.neoReferencesMotherAndIndices.motherNeoRefsList=this.motherNeoReferencesArray),n.neoReferencesMotherAndIndices.fileLoadState===I.fileLoadState.READY){void 0===n.neoReferencesMotherAndIndices.blocksList&&(n.neoReferencesMotherAndIndices.blocksList=new kt("0.0.1")),u&&(n.neoReferencesMotherAndIndices.blocksList.keepDataArrayBuffers=u);var d=a+"/"+l+"/"+s+"/References"+"/"+n.octree_number_name.toString()+"_Ref";e.readerWriter.getNeoReferencesArraybuffer(d,n,e,t)}else n.neoReferencesMotherAndIndices.fileLoadState===I.fileLoadState.LOADING_FINISHED&&cr.parseOctreesLod0References(n,e);var h=n.neoReferencesMotherAndIndices.blocksList;if(void 0===h)return;if(h.fileLoadState===I.fileLoadState.READY){var f=a+"/"+l+"/"+s+"/Models"+"/"+n.octree_number_name.toString()+"_Model";e.readerWriter.getNeoBlocksArraybuffer(f,n,e,t)}else h.fileLoadState===I.fileLoadState.LOADING_FINISHED&&cr.parseArrayOctreesLod0Models(n,e)}}return!0},rr.prototype.makeCollisionCheckOctree=function(e){if(void 0===this.motherNeoReferencesArray||void 0===this.motherBlocksArray)return!1;if(void 0===this.collisionCheckOctree){var t=new jt,r=this.octree;if(t.centerPos.copyFrom(r.centerPos),t.half_dx=r.half_dx,t.half_dy=r.half_dy,t.half_dz=r.half_dz,t.octree_level=r.octree_level,t.trianglesArray=this.getTriangles(),!t.trianglesArray)return!1;var i={};i.desiredMinOctreeSize=e,t.makeTreeByTrianglesArray(i),this.collisionCheckOctree=t}var o=this.nodeOwner.data.geoLocDataManager.getCurrentGeoLocationData(),n=o.pivotPointTraslationLC,a=!0;void 0!==n&&(this.collisionCheckOctree.translate(n,a),a=!1);var s=o.tMatrix;this.collisionCheckOctree.transformByMatrix4(s,a)},rr.prototype.getCollisionCheckOctree=function(){return this.collisionCheckOctree},rr.prototype.parseHeader=function(e,t){void 0===this.metaData&&(this.metaData=new Jt),void 0===t&&(t=0);var r=this.metaData;if(t=r.parseFileHeaderAsimetricVersion(e,t),20!==r.projectDataType){void 0===this.octree&&(this.octree=new ur(void 0));var i=this.octree;i.neoBuildingOwnerId=this.buildingId,i.octreeKey=this.buildingId+"_"+i.octree_number_name,t=5===r.projectDataType?i.parsePyramidVersion(e,t,this):i.parseAsimetricVersion(e,t,this);var o=i.centerPos;r.oct_min_x=o.x-i.half_dx,r.oct_max_x=o.x+i.half_dx,r.oct_min_y=o.y-i.half_dy,r.oct_max_y=o.y+i.half_dy,r.oct_min_z=o.z-i.half_dz,r.oct_max_z=o.z+i.half_dz,"0.0.1"!==r.version&&"0.0.2"!==r.version||(t=this.parseTexturesList(e,t),t=this.parseLodBuildingData(e,t))}else t=this.parseTexturesList(e,t);return r.fileLoadState=I.fileLoadState.PARSE_FINISHED,this.headerDataArrayBuffer=void 0,this.bbox=this.metaData.bbox,t},rr.prototype.parseLodBuildingData=function(e,t){var r,i=new Uint8Array(e.slice(t,t+1))[0];if(t+=1,void 0!==i){this.lodBuildingDatasMap={};for(var o=new TextDecoder("utf-8"),n=0;n<i;n++){var a=new Zt;a.lod=new Uint8Array(e.slice(t,t+1))[0],t+=1,a.isModelRef=new Uint8Array(e.slice(t,t+1))[0],t+=1,2===a.lod&&(r=new Int8Array(e.slice(t,t+1))[0],t+=1,a.textureFileName="",a.textureFileName=o.decode(new Int8Array(e.slice(t,t+r))),t+=r),a.isModelRef||(r=new Int8Array(e.slice(t,t+1))[0],t+=1,a.geometryFileName="",a.geometryFileName=o.decode(new Int8Array(e.slice(t,t+r))),t+=r,r=new Int8Array(e.slice(t,t+1))[0],t+=1,a.textureFileName="",a.textureFileName=o.decode(new Int8Array(e.slice(t,t+r))),t+=r),this.lodBuildingDatasMap[a.lod]=a}new Uint8Array(e.slice(t,t+1))[0];t+=1}return t},rr.prototype._parseLegoByWorker=function(e,t,r){if(e){r.workerParseLego||(r.workerParseLego=Ko(r.config.scriptRootPath+"Worker/workerParseLego.js"),r.workerParseLego.onmessage=function(e){var t=e.data.info,i=e.data;r.legoParsedMap||(r.legoParsedMap={});var o=r.legoParsedMap;o[t.smartTileDepth]||(o[t.smartTileDepth]={}),o[t.smartTileDepth][t.smartTileX]||(o[t.smartTileDepth][t.smartTileX]={}),o[t.smartTileDepth][t.smartTileX][t.smartTileY]||(o[t.smartTileDepth][t.smartTileX][t.smartTileY]={}),o[t.smartTileDepth][t.smartTileX][t.smartTileY][t.buildingId]||(o[t.smartTileDepth][t.smartTileX][t.smartTileY][t.buildingId]={}),o[t.smartTileDepth][t.smartTileX][t.smartTileY][t.buildingId][t.legoKey]||(o[t.smartTileDepth][t.smartTileX][t.smartTileY][t.buildingId][t.legoKey]=i)});var i=this.nodeOwner.data.smartTileOwner,o=i.X,n=i.Y,a=i.depth,s=t.legoKey,l={dataArrayBuffer:e,info:{smartTileX:o,smartTileY:n,smartTileDepth:a,buildingId:this.buildingId,legoKey:s}};r.workerParseLego.postMessage(l,[l.dataArrayBuffer]),t.fileLoadState=I.fileLoadState.PARSE_STARTED}},rr.prototype.prepareSkin=function(e){var t,r=this.getHeaderVersion();if(void 0===r)return!1;if("0"!==r[0])return!1;this.currentLod||(this.currentLod=this.nodeOwner.data.currentLod),t=this.getLowerSkinLodToLoad(this.currentLod);var i=this.getLodBuildingData(t);if(void 0===i)return!1;if(i.isModelRef)return!1;var o=this.projectFolderName,n=this.buildingFileName,a=e.readerWriter.geometryDataPath,s=i.textureFileName,l="lod"+i.lod.toString(),u=this.getOrNewLodBuilding(l);"noTexture"!==s?(u.attributes.hasTexture=!0,u.textureName=s):u.attributes.hasTexture=!1;var c=i.geometryFileName,d=this.getOrNewLodMesh(c);if(d.textureName=s,u.skinLego=d,-1===d.fileLoadState)return!1;var h=this.nodeOwner.data.attributes.fromSmartTile;if(void 0===h&&(h=!1),d.fileLoadState===I.fileLoadState.READY){if(h){if(t<3&&e.readerWriter.skinLegos_requested<5){var f=a+"/"+o+"/"+n+"/"+c;e.readerWriter.getLegoArraybuffer(f,d,e),void 0===d.vbo_vicks_container.vboCacheKeysArray&&(d.vbo_vicks_container.vboCacheKeysArray=[])}}else if(e.readerWriter.skinLegos_requested<5){f=a+"/"+o+"/"+n+"/"+c;e.readerWriter.getLegoArraybuffer(f,d,e),void 0===d.vbo_vicks_container.vboCacheKeysArray&&(d.vbo_vicks_container.vboCacheKeysArray=[])}}else if(d.fileLoadState===I.fileLoadState.LOADING_FINISHED)this._parseLegoByWorker(d.dataArrayBuffer,d,e);else if(d.fileLoadState===I.fileLoadState.PARSE_STARTED){var g=this.nodeOwner.data.smartTileOwner,p=g.X,m=g.Y,v=g.depth,x=this.buildingId,_=d.legoKey,y=e.legoParsedMap;if(!y)return;if(!y[v])return;if(!y[v][p])return;if(!y[v][p][m])return;if(!y[v][p][m][x])return;if(!y[v][p][m][x][_])return;var T=y[v][p][m][x][_];d._parseLegoDataResultFromWorker(T,e),delete y[v][p][m][x][_]}else if(d.vbo_vicks_container.vboCacheKeysArray[0]&&d.vbo_vicks_container.vboCacheKeysArray[0].vboBufferTCoord&&u.attributes.hasTexture)if(void 0===u.texture){if(h){if(t<3&&e.fileRequestControler.lowLodImagesRequestedCount<4){u.texture=new it;var C=a+"/"+o+"/"+n+"/"+s,b=e.sceneState.gl,M=!0;e.readerWriter.readLegoSimpleBuildingTexture(b,C,u.texture,e,M)}}else if(e.fileRequestControler.lowLodImagesRequestedCount<4){u.texture=new it;C=a+"/"+o+"/"+n+"/"+s,b=e.sceneState.gl,M=!0;e.readerWriter.readLegoSimpleBuildingTexture(b,C,u.texture,e,M)}}else if(u.texture.fileLoadState===I.fileLoadState.LOADING_FINISHED&&void 0===u.texture.texId){b=e.sceneState.gl;at.newWebGlTextureByEmbeddedImage(b,u.texture.imageBinaryData,u.texture),e.readerWriter.skinLegos_requested++}return!0},rr.prototype.renderCollisionCheckSpheres=function(e,t,r){if(void 0!==this.collisionCheckOctree){var i=[];this.collisionCheckOctree.extractLowestOctreesIfHasTriangles(i);for(var o=i.length,n=0;n<o;n++);}},rr.prototype.render=function(e,t,r,i,o,n){var a=e.sceneState.gl;void 0!==n&&(this.currentLod=n);var s=this.metaData.getProjectDataType(),l=-1;if(5===s)return l;if(10===s){var u=!1;0===r?u=!1:1===r&&(u=!!(this.texturesLoaded&&this.texturesLoaded.length>0));var c=this.octree;return c.neoReferencesMotherAndIndices&&(c.neoReferencesMotherAndIndices.currentVisibleIndices=c.neoReferencesMotherAndIndices.neoRefsIndices,c.renderContent(e,this,r,u,t,0,i,o)&&(l=0)),l}var d=this.getLodBuildingData(this.currentLod);if(this.currentLod<=2)if(d&&!d.isModelRef)this.renderSkin(e,t,r)&&(l=3);else{var h=this.renderDetailed(e,t,r,i,o);if(h>0&&(l=0),void 0===this.currentVisibleOctreesControler)this.renderSkin(e,t,r)&&(l=3);else{var f=this.currentVisibleOctreesControler.currentVisibles0.length,g=this.currentVisibleOctreesControler.currentVisibles1.length,p=this.currentVisibleOctreesControler.currentVisibles2.length;2===this.metaData.projectDataType?h<=0&&this.renderSkin(e,t,r)&&(l=3):h<.1*(f+g+p)&&this.renderSkin(e,t,r)&&(l=3)}}else this.currentLod>2&&this.renderSkin(e,t,r)&&(l=3);if(void 0!==this.collisionCheckOctree&&void 0!==this.collisionCheckOctree.currentVisibleOctreesArray){a.uniform1i(t.refMatrixType_loc,0);for(var m=this.collisionCheckOctree.currentVisibleOctreesArray,v=m.length,x=0;x<v;x++)m[x].render(e,t,r,void 0)}return l},rr.prototype.renderShadowMesh=function(e,t,r){var i=this.getCurrentSkin();if(void 0!==i&&i.isReadyToRender()){var o=e.sceneState.gl;o.uniform1i(t.colorType_loc,0),o.uniform4fv(t.oneColor4_loc,[.7,.7,.7,1]),o.uniform1i(t.refMatrixType_loc,0),i.render(e,r,!0,t,this)}},rr.prototype.renderSkin=function(e,t,r){var i=this.getCurrentSkin();if(void 0!==i&&i.isReadyToRender()){var o,n=e.sceneState.gl,a=e.renderer.currentObjectsRendering,s=!0;if(i.attributes.hasTexture||(s=!1),1===r){if(n.uniform4fv(t.oneColor4_loc,[.7,.7,.7,1]),this.isHighLighted?(n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,this.highLightColor4),s=!1):this.isColorChanged&&(n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a]),s=!1),s)if(void 0!==i.texture&&i.texture.texId){n.uniform1i(t.textureFlipYAxis_loc,!1),t.enableVertexAttribArray(t.texCoord2_loc),n.uniform1i(t.colorType_loc,2),t.last_tex_id!==i.texture.texId&&(n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,i.texture.texId),t.last_tex_id=i.texture.texId)}else void 0!==e.textureAux_1x1?(t.enableVertexAttribArray(t.texCoord2_loc),n.uniform1i(t.colorType_loc,2),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,e.textureAux_1x1)):n.uniform1i(t.colorType_loc,0);if(e.isCameraMoved&&!this.mouseLeftDown&&!this.mouseMiddleDown){var l;e.selectionManager,e.selectionColor,o=a.curNode,a.curOctree,l=e.selectionColor.getAvailableColor(l);var u=e.selectionColor.decodeColor3(l.r,l.g,l.b);e.selectionManager.setCandidates(u,void 0,void 0,this,o),n.uniform4fv(t.uSelColor4_loc,[l.r/255,l.g/255,l.b/255,1])}}else 3===r&&(n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[.7,.7,.7,1]));return n.uniform1i(t.refMatrixType_loc,0),i.render(e,r,s,t,this)}},rr.prototype.renderDetailed=function(e,t,r,i,o){var n=0;if(void 0===this.currentVisibleOctreesControler)return n;var a,s=!1;e.sceneState.gl;0===r?s=!1:1===r&&(s=!!(this.texturesLoaded&&this.texturesLoaded.length>0)),e.renderer.currentObjectsRendering.curBuilding=this;var l,u,c,d,h=this.getRenderSettingApplyOcclusionCulling();void 0===h&&(h=!0),h&&(l=this.myCameraRelative.position.x,u=this.myCameraRelative.position.y,c=this.myCameraRelative.position.z);var f=0;d=this.currentVisibleOctreesControler.currentVisibles0.length;for(var g=0;g<d;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles0[g]).neoReferencesMotherAndIndices&&(a.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(l,u,c,h),a.lod=0,a.renderContent(e,this,r,s,t,f,0,o)&&n++);f=.45,d=this.currentVisibleOctreesControler.currentVisibles1.length;for(g=0;g<d;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles1[g]).neoReferencesMotherAndIndices&&(a.neoReferencesMotherAndIndices.updateCurrentVisibleIndices(l,u,c,h),a.lod=1,a.renderContent(e,this,r,s,t,f,0,o)&&n++);t.disableVertexAttribArray(t.color4_loc),d=this.currentVisibleOctreesControler.currentVisibles2.length;for(g=0;g<d;g++)void 0!==(a=this.currentVisibleOctreesControler.currentVisibles2[g]).lego&&(a.lod=2,a.renderContent(e,this,r,s,t,f,0,o)&&n++);return n},rr.prototype.deleteChangeColor=function(e,t){var r=this.getReferenceObjectsArrayByObjectId(t);if(void 0!==r){for(var i=r.length,o=this.nodeOwner.data.projectId,n=this.nodeOwner.data.nodeId,a=0;a<i;a++){var s=r[a];s&&s.deleteChangeColor()}e.config.deleteColorHistory(o,n,t)}};var ir=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.neoBuildingsArray=[]};ir.prototype.newNeoBuilding=function(){var e=new rr;return this.neoBuildingsArray.push(e),e},ir.prototype.getNeoBuildingByTypeId=function(e,t){for(var r,i=this.neoBuildingsArray.length,o=!1,n=0;!o&&n<i;)this.neoBuildingsArray[n].buildingType===e&&this.neoBuildingsArray[n].buildingId===t&&(o=!0,r=this.neoBuildingsArray[n]),n++;return r},ir.prototype.get=function(e){return this.neoBuildingsArray[e]},ir.prototype.add=function(e){void 0!==e&&this.neoBuildingsArray.push(e)};var or=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._id=0,this.objectId="",this._block_idx=-1,this._originalMatrix4=new Ne,this._matrix4=new Ne,this.tMatrixAuxArray,this.refMatrixType=2,this.refTranslationVec,this.vBOVertexIdxCacheKeysContainer,this.materialId,this.hasTexture=!1,this.texture,this.color4,this.aditionalColor,this.moveVectorRelToBuilding,this.moveVector,this.renderingFase=!1,this.blendAlpha=0,this.birthTime,this.isAdult=!1};or.prototype.getCenterPositionWC=function(e,t){var r=this._block_idx,i=e.motherBlocksArray[r];if(void 0===i)return t;var o=e.nodeOwner;if(void 0===o)return t;var n=i.bbox.getCenterPoint();return 1===this.refMatrixType?n.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(n=this._originalMatrix4.transformPoint3D(n,n)),this.moveVectorRelToBuilding&&n.add(this.moveVectorRelToBuilding.x,this.moveVectorRelToBuilding.y,this.moveVectorRelToBuilding.z),t=o.data.geoLocDataManager.getCurrentGeoLocationData().tMatrix.transformPoint3D(n,t)},or.prototype.swapRenderingFase=function(e){this.renderingFase=e},or.prototype.getBlendAlpha=function(e){if(this.isAdult)return 1;void 0===this.birthTime&&(this.birthTime=e),void 0===this.blendAlpha&&(this.blendAlpha=0);var t=1e-4*(e-this.birthTime);return this.blendAlpha+=t,this.blendAlpha>=1&&(this.isAdult=!0),this.blendAlpha},or.prototype.multiplyTransformMatrix=function(e){this._matrix4=this._originalMatrix4.getMultipliedByMatrix(e)},or.prototype.multiplyKeyTransformMatrix=function(e,t){void 0===this.tMatrixAuxArray&&(this.tMatrixAuxArray=[]),this.tMatrixAuxArray[e]=this._originalMatrix4.getMultipliedByMatrix(t,this.tMatrixAuxArray[e]),this.moveVectorRelToBuilding&&(this.moveVector=t.rotatePoint3D(this.moveVectorRelToBuilding,this.moveVector))},or.prototype.hasKeyMatrix=function(e){return void 0!==this.tMatrixAuxArray&&void 0!==this.tMatrixAuxArray[e]},or.prototype.isReadyToRender=function(){return void 0!==this.tMatrixAuxArray},or.prototype.solveReferencePngTextureForDepthRender=function(e,t,r,i){var o=e.getGl();return this.texture&&"PNG"===this.texture.textureImageFileExtension?(o.uniform1i(r.bHasTexture_loc,!0),r.last_tex_id!==this.texture.texId&&(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,this.texture.texId),r.last_tex_id=this.texture.texId),!0):(o.uniform1i(r.bHasTexture_loc,!1),!1)},or.prototype.solveReferenceColorOrTexture=function(e,t,r,i){var o=e.sceneState.gl,n=!1;e.selectionManager.parentSelected&&e.selectionManager.getSelectedF4dObject()===this&&(n=!0),t.isHighLighted?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,e.highLightColor4)):t.isColorChanged?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[t.aditionalColor.r,t.aditionalColor.g,t.aditionalColor.b,t.aditionalColor.a])):this.aditionalColor?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[this.aditionalColor.r,this.aditionalColor.g,this.aditionalColor.b,this.aditionalColor.a])):e.magoPolicy.getObjectMoveMode()===I.moveMode.OBJECT&&n?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[1,0,0,1])):e.magoPolicy.colorChangedObjectId===this.objectId?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[e.magoPolicy.color[0],e.magoPolicy.color[1],e.magoPolicy.color[2],1])):this.hasTexture?void 0!==this.texture&&void 0!==this.texture.texId?(o.uniform1i(r.colorType_loc,2),r.last_tex_id!==this.texture.texId&&(o.activeTexture(o.TEXTURE2),o.bindTexture(o.TEXTURE_2D,this.texture.texId),r.last_tex_id=this.texture.texId)):(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[.8,0,.8,1])):(o.uniform1i(r.bUse1Color_loc,!0),this.color4?(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[this.color4.r/255,this.color4.g/255,this.color4.b/255,this.color4.a/255])):(o.uniform1i(r.colorType_loc,0),o.uniform4fv(r.oneColor4_loc,[.8,.8,.8,1])))},or.prototype.getTriangles=function(e,t){if(void 0===e||void 0===e.motherBlocksArray)return motherBlocksArray;void 0===t&&(t=[]);var r=this._block_idx,i=e.motherBlocksArray[r];if(!i)return t;for(var o,n=i.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length,a=this._originalMatrix4,s={},l=0;l<n;l++){var u=(o=i.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[l]).keepedPosDataArray;if(void 0===u)return t;u.length;for(var c=o.keepedIdxDataArray,d=c.length/3,h=0;h<d;h++){var f=c[3*h],g=c[3*h+1],p=c[3*h+2],m=s[f];if(void 0===m){var v=new Jr(u[3*f],u[3*f+1],u[3*f+2]);1===this.refMatrixType?v.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(v=a.transformPoint3D(v,v)),m=new wi(v),s[f]=m}var x=s[g];if(void 0===x){var _=new Jr(u[3*g],u[3*g+1],u[3*g+2]);1===this.refMatrixType?_.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(_=a.transformPoint3D(_,_)),x=new wi(_),s[g]=x}var y=s[p];if(void 0===y){var T=new Jr(u[3*p],u[3*p+1],u[3*p+2]);1===this.refMatrixType?T.add(this.refTranslationVec[0],this.refTranslationVec[1],this.refTranslationVec[2]):2===this.refMatrixType&&(T=a.transformPoint3D(T,T)),y=new wi(T),s[p]=y}var C=new bi(m,x,y);t.push(C)}}return t},or.prototype.render=function(e,t,r,i,o,n,a){if(!this.isReadyToRender())return!1;if(this.hasTexture){if(t.manageNeoReferenceTexture(this,e)!==I.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this.texture)return!1;if(void 0===this.texture.texId)return!1}var s=e.renderer.currentObjectsRendering,l=e.sceneState.gl,u=this._block_idx,c=t.motherBlocksArray[u];if(void 0===c)return!1;if((e.mouseLeftDown||e.mouseMiddleDown)&&(a=.5),e.currentProcess!==I.magoCurrentProcess.ColorCodeRendering&&!c.isReadyToRender(this,e,a)&&e.selectionManager.getSelectedF4dObject()!==this)return!1;var d=!1;if(0===r)d=this.solveReferencePngTextureForDepthRender(e,t,o,s);else if(1===r&&(this.solveReferenceColorOrTexture(e,t,o,s),e.isCameraMoved&&!this.mouseLeftDown&&!this.mouseMiddleDown)){var h,f=(s=e.renderer.currentObjectsRendering).curNode,g=s.curOctree;h=e.selectionColor.getAvailableColor(h),this.selColor4=h;var p=e.selectionColor.decodeColor3(h.r,h.g,h.b);e.selectionManager.setCandidates(p,this,g,t,f),l.uniform4fv(o.uSelColor4_loc,[h.r/255,h.g/255,h.b/255,1])}if(this.aditionalColor=void 0,void 0===e.isTrailRender||!1===e.isTrailRender){var m=this.getBlendAlpha(e.currTime);l.uniform1f(o.externalAlpha_loc,m)}var v,x=c.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray.length;l.uniform1i(o.refMatrixType_loc,this.refMatrixType),1===this.refMatrixType?l.uniform3fv(o.refTranslationVec_loc,this.refTranslationVec):2===this.refMatrixType&&l.uniformMatrix4fv(o.refMatrix_loc,!1,this.tMatrixAuxArray[n]._floatArrays),void 0!==this.moveVector?(l.uniform1i(o.hasAditionalMov_loc,!0),l.uniform3fv(o.aditionalMov_loc,[this.moveVector.x,this.moveVector.y,this.moveVector.z]),o.last_isAditionalMovedZero=!1):o.last_isAditionalMovedZero||(l.uniform1i(o.hasAditionalMov_loc,!1),l.uniform3fv(o.aditionalMov_loc,[0,0,0]),o.last_isAditionalMovedZero=!0);for(var _=0;_<x;_++){if(!(v=c.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[_]).bindDataPosition(o,e.vboMemoryManager))return!1;if(0===r){if(o.normal3_loc>=0&&!v.bindDataNormal(o,e.vboMemoryManager))return!1;if(d&&this.vBOVertexIdxCacheKeysContainer){if(o.enableVertexAttribArray(o.texCoord2_loc),!(y=this.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[_]).bindDataTexCoord(o,e.vboMemoryManager))return!1}else o.disableVertexAttribArray(o.texCoord2_loc)}else if(1===r){if(!v.bindDataNormal(o,e.vboMemoryManager))return!1;var y;if(i&&this.hasTexture&&this.vBOVertexIdxCacheKeysContainer)if(c.vertexCount<=this.vertexCount){if(!(y=this.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[_]).bindDataTexCoord(o,e.vboMemoryManager))return!1}else o.disableVertexAttribArray(o.texCoord2_loc);else o.disableVertexAttribArray(o.texCoord2_loc);if(!this.hasTexture&&this.vBOVertexIdxCacheKeysContainer)(y=this.vBOVertexIdxCacheKeysContainer.vboCacheKeysArray[_]).vboBufferCol?y.bindDataColor(o,e.vboMemoryManager)?l.uniform1i(o.colorType_loc,1):o.disableVertexAttribArray(o.color4_loc):l.uniform1i(o.colorType_loc,0)}var T;if(e.isCameraMoving?T=v.indicesCount:e.thereAreUrgentOctrees?(T=v.bigTrianglesIndicesCount)>v.indicesCount&&(T=v.indicesCount):T=v.indicesCount,!v.bindDataIndice(o,e.vboMemoryManager))return!1;l.drawElements(l.TRIANGLES,T,l.UNSIGNED_SHORT,0),1===r&&(e.sceneState.trianglesRenderedCount+=T/3)}return!0},or.prototype.deleteObjects=function(e,t){this._id=void 0,this._block_idx=void 0,this._matrix4._floatArrays=void 0,this._matrix4=void 0,this._originalMatrix4._floatArrays=void 0,this._originalMatrix4=void 0,this.hasTexture=void 0,this.texture=void 0,this.color4&&this.color4.deleteObjects(),this.color4=void 0,this.selColor4&&this.selColor4.deleteObjects(),this.selColor4=void 0,this.moveVector&&this.moveVector.deleteObjects(),this.moveVector=void 0,this.bRendered=void 0,void 0!==this.vBOVertexIdxCacheKeysContainer&&(this.vBOVertexIdxCacheKeysContainer.deleteGlObjects(e,t),this.vBOVertexIdxCacheKeysContainer=void 0)},or.prototype.deleteChangeColor=function(){this.aditionalColor=void 0};var nr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.motherNeoRefsList,this.neoRefsIndices=[],this.modelReferencedGroupsList,this.blocksList,this.fileLoadState=0,this.dataArraybuffer,this.succesfullyGpuDataBinded,this.exterior_ocCullOctree,this.interior_ocCullOctree,this.currentVisibleIndices=[],this.currentVisibleMRG,this.xhr};nr.prototype.multiplyKeyTransformMatrix=function(e,t){for(var r,i=this.neoRefsIndices.length,o=0;o<i;o++)(r=this.motherNeoRefsList[this.neoRefsIndices[o]])&&r.multiplyKeyTransformMatrix(e,t)},nr.prototype.updateCurrentVisibleIndices=function(e,t,r,i){void 0===i&&(i=!0);var o=!1;if(void 0!==this.interior_ocCullOctree){var n=!1;if(this.interior_ocCullOctree._subBoxesArray&&this.interior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&i){var a=this.interior_ocCullOctree.getIntersectedSubBoxByPoint3D(e,t,r);void 0!==a&&a._indicesArray.length>0?(this.currentVisibleIndices=a._indicesArray,o=!1):o=!0}else this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList}if(o&&void 0!==this.exterior_ocCullOctree){n=!1;this.exterior_ocCullOctree._subBoxesArray&&this.exterior_ocCullOctree._subBoxesArray.length>0&&(n=!0),n&&i?(void 0===this.currentVisibleMRG&&(this.currentVisibleMRG=new $t),this.currentVisibleIndices=this.exterior_ocCullOctree.getIndicesVisiblesForEye(e,t,r,this.currentVisibleIndices,this.currentVisibleMRG)):(this.currentVisibleIndices=this.neoRefsIndices,this.currentVisibleMRG=this.modelReferencedGroupsList)}},nr.prototype.getNeoReference=function(e){return this.motherNeoRefsList[this.neoRefsIndices[e]]},nr.prototype.deleteObjects=function(e,t){void 0!==this.xhr&&(this.xhr.abort(),this.xhr=void 0),this.motherNeoRefsList=void 0,this.neoRefsIndices=void 0,void 0!==this.blocksList&&void 0!==this.blocksList.xhr&&this.fileLoadState!==I.fileLoadState.READY&&(this.blocksList.xhr.abort(),this.blocksList.xhr=void 0),this.blocksList=void 0,this.fileLoadState=void 0,this.dataArraybuffer=void 0,this.exterior_ocCullOctree=void 0,this.interior_ocCullOctree=void 0},nr.prototype.isReadyToRender=function(){return void 0!==this.neoRefsIndices&&0!==this.neoRefsIndices.length&&(void 0!==this.blocksList&&this.blocksList.fileLoadState===I.fileLoadState.PARSE_FINISHED)},nr.prototype.setRenderedFalseToAllReferences=function(){for(var e=this.neoRefsIndices.length,t=0;t<e;t++)this.motherNeoRefsList[this.neoRefsIndices[t]].bRendered=!1},nr.prototype.createModelReferencedGroups=function(){void 0!==this.neoRefsIndices&&(void 0===this.modelReferencedGroupsList&&(this.modelReferencedGroupsList=new $t),this.modelReferencedGroupsList.createModelReferencedGroups(this.neoRefsIndices,this.motherNeoRefsList))},nr.prototype.parseArrayBufferReferencesVersioned=function(e,t,r,i,o){this.fileLoadState=I.fileLoadState.PARSE_STARTED;o.getGl();var n,a,s,l,u,c,d=0,h=o.vboMemoryManager;this.succesfullyGpuDataBinded=!0;String.fromCharCode.apply(null,new Int8Array(e.slice(d,d+5)));d+=5;var f=t.readUInt32(e,d,d+4);d+=4;for(var g=0;g<f;g++){var p=new or,m=t.readUInt32(e,d,d+4);if(d+=4,p._id=m,this.motherNeoRefsList=r.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[p._id]){p=this.motherNeoRefsList[p._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(p._id);var v=t.readUInt8(e,d,d+1);d+=1;var x=String.fromCharCode.apply(null,new Int8Array(e.slice(d,d+v)));d+=v;var _=t.readUInt32(e,d,d+4);d+=4;var y=t.readUInt8(e,d,d+1);d+=1,0===y||(1===y?d+=12:2===y&&(d+=64));var T=t.readUInt8(e,d,d+1);if(d+=1,T){var C=t.readUInt16(e,d,d+2);d+=2;var b=t.readUInt8(e,d,d+1);d+=1,5121===C&&(B=1);var M=t.readUInt8(e,d,d+B);d+=B;var A=t.readUInt8(e,d,d+B);d+=B;var E=t.readUInt8(e,d,d+B);d+=B;var L=255;4===b&&(L=t.readUInt8(e,d,d+B),d+=B)}var w=t.readUInt8(e,d,d+1);d+=1;var S=t.readUInt8(e,d,d+1);if(d+=1,w||S){var D=t.readInt32(e,d,d+4);d+=4;for(var R=0;R<D;R++){if(w){C=t.readUInt16(e,d,d+2);d+=2;b=t.readUInt8(e,d,d+1);d+=1,5120===C||5121===C?B=1:5122===C||5123===C?B=2:5126===C&&(B=4);var P=t.readUInt32(e,d,d+4);n=d+=4,a=d+B*(N=P*b),d+=B*N}if(S){C=t.readUInt16(e,d,d+2);d+=2,5120===C||5121===C?B=1:5122===C||5123===C?B=2:5126===C&&(B=4);P=t.readUInt32(e,d,d+4);n=d+=4,a=d+B*(N=2*P),d+=B*N}}}t.readInt32(e,d,d+4);d+=4,0===p.refMatrixType&&1,1===p.refMatrixType&&1,2===p.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(p._id);v=t.readUInt8(e,d,d+1);d+=1,"noObjectId"!==(x=String.fromCharCode.apply(null,new Int8Array(e.slice(d,d+v))))&&0!==x.length||(x=p._id.toString()),p.objectId=x,d+=v,r.putReferenceObject(p,p._id);_=t.readUInt32(e,d,d+4);d+=4,p._block_idx=_,p.refMatrixType=t.readUInt8(e,d,d+1),d+=1,0===p.refMatrixType?1:1===p.refMatrixType?(l=t.readFloat32(e,d,d+4),d+=4,u=t.readFloat32(e,d,d+4),d+=4,c=t.readFloat32(e,d,d+4),d+=4,p.refTranslationVec=new Float32Array([l,u,c]),1):2===p.refMatrixType&&(p._originalMatrix4._floatArrays[0]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[1]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[2]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[3]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[4]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[5]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[6]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[7]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[8]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[9]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[10]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[11]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[12]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[13]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[14]=t.readFloat32(e,d,d+4),d+=4,p._originalMatrix4._floatArrays[15]=t.readFloat32(e,d,d+4),d+=4,1);T=t.readUInt8(e,d,d+1);if(d+=1,T){C=t.readUInt16(e,d,d+2);d+=2;b=t.readUInt8(e,d,d+1);d+=1,5121===C&&(B=1);M=t.readUInt8(e,d,d+B);d+=B;A=t.readUInt8(e,d,d+B);d+=B;E=t.readUInt8(e,d,d+B);d+=B;L=255;4===b&&(L=t.readUInt8(e,d,d+B),d+=B),p.color4=new J,p.color4.set(M,A,E,L)}w=t.readUInt8(e,d,d+1);d+=1;S=t.readUInt8(e,d,d+1);if(d+=1,!w);if(w||S){D=t.readInt32(e,d,d+4);d+=4,D>0&&void 0===p.vBOVertexIdxCacheKeysContainer&&(p.vBOVertexIdxCacheKeysContainer=new xt);for(R=0;R<D;R++){var F=p.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(w){C=t.readUInt16(e,d,d+2);d+=2;b=t.readUInt8(e,d,d+1);d+=1,5120===C||5121===C?B=1:5122===C||5123===C?B=2:5126===C&&(B=4);var O;P=t.readUInt32(e,d,d+4);d+=4,s=N=P*b,h.getClassifiedBufferSize(s),p.vertexCount=P,n=d,a=d+B*N,5121===C&&(O=new Uint8Array(e.slice(n,a))),5126===C&&(O=new Float32Array(e.slice(n,a))),F.setDataArrayCol(O,h),d+=B*N}if(S){var B;C=t.readUInt16(e,d,d+2);d+=2,5120===C||5121===C?B=1:5122===C||5123===C?B=2:5126===C&&(B=4);P=t.readUInt32(e,d,d+4);d+=4;var N=2*P;p.vertexCount=P,n=d,a=d+B*N;var U=new Float32Array(e.slice(n,a));F.setDataArrayTexCoord(U,h),d+=B*N}}}p.materialId=t.readInt32(e,d,d+4),d+=4,-1===p.materialId?p.hasTexture=!1:p.hasTexture=!0,i&&p.multiplyTransformMatrix(i)}}t.readUInt32(e,d,d+4);d+=4,void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new ke);var G=this.exterior_ocCullOctree;d=this.exterior_ocCullOctree.parseArrayBuffer(e,d,t),G.expandBox(1e3),G.setSizesSubBoxes(),G.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new ke);var z=this.interior_ocCullOctree;return d=this.interior_ocCullOctree.parseArrayBuffer(e,d,t),z.setSizesSubBoxes(),z.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=I.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},nr.prototype.parseArrayBufferReferences=function(e,t,r,i,o){this.fileLoadState=I.fileLoadState.PARSE_STARTED;var n,a,s=o.getGl(),l=0,u=t.readUInt32(e,l,l+4);l+=4;var c,d,h=o.vboMemoryManager,f=0,g=0;this.succesfullyGpuDataBinded=!0;for(var p=0;p<u;p++){var m=new or,v=t.readUInt32(e,l,l+4);if(l+=4,m._id=v,this.motherNeoRefsList=r.motherNeoReferencesArray,void 0!==this.motherNeoRefsList[m._id]){m=this.motherNeoRefsList[m._id],void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(m._id);var x=t.readUInt8(e,l,l+1);l+=1;var _=String.fromCharCode.apply(null,new Int8Array(e.slice(l,l+x)));l+=x;var y=t.readUInt32(e,l,l+4);l+=4,m._block_idx=y,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4,t.readFloat32(e,l,l+4),l+=4;var T=t.readUInt8(e,l,l+1);if(l+=1,T){var C=t.readUInt16(e,l,l+2);l+=2;var b=t.readUInt8(e,l,l+1);l+=1,5121===C&&(U=1);var M=t.readUInt8(e,l,l+U);l+=U;var A=t.readUInt8(e,l,l+U);l+=U;var E=t.readUInt8(e,l,l+U);l+=U;var L=255;4===b&&(L=t.readUInt8(e,l,l+U),l+=U)}var w=t.readUInt8(e,l,l+1);l+=1;var S=t.readUInt8(e,l,l+1);if(l+=1,w||S){var D=t.readInt32(e,l,l+4);l+=4;for(var R=0;R<D;R++){if(w){C=t.readUInt16(e,l,l+2);l+=2;b=t.readUInt8(e,l,l+1);l+=1,5120===C||5121===C?U=1:5122===C||5123===C?U=2:5126===C&&(U=4);var P=t.readUInt32(e,l,l+4);n=l+=4,a=l+U*(G=P*b),l+=U*G}if(S){C=t.readUInt16(e,l,l+2);l+=2,5120===C||5121===C?U=1:5122===C||5123===C?U=2:5126===C&&(U=4);P=t.readUInt32(e,l,l+4);n=l+=4,a=l+U*(G=2*P),l+=U*G}}}var F=t.readUInt32(e,l,l+4);if(l+=4,F>0){var O=t.readUInt32(e,l,l+4);l+=4;for(R=0;R<O;R++)l+=1;var B=t.readUInt32(e,l,l+4);l+=4;for(R=0;R<B;R++)l+=1}0===m.refMatrixType&&1,1===m.refMatrixType&&1,2===m.refMatrixType&&1}else{void 0===this.neoRefsIndices&&(this.neoRefsIndices=[]),this.neoRefsIndices.push(m._id);x=t.readUInt8(e,l,l+1);l+=1,"noObjectId"!==(_=String.fromCharCode.apply(null,new Int8Array(e.slice(l,l+x))))&&""!==_||(_=m._id),m.objectId=_,l+=x,r.putReferenceObject(m,m._id);y=t.readUInt32(e,l,l+4);l+=4,m._block_idx=y,m._originalMatrix4._floatArrays[0]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[1]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[2]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[3]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[4]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[5]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[6]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[7]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[8]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[9]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[10]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[11]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[12]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[13]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[14]=t.readFloat32(e,l,l+4),l+=4,m._originalMatrix4._floatArrays[15]=t.readFloat32(e,l,l+4),l+=4,m.refMatrixType=m._originalMatrix4.computeMatrixType(),0===m.refMatrixType&&1,1===m.refMatrixType&&(m.refTranslationVec=new Float32Array([m._originalMatrix4._floatArrays[12],m._originalMatrix4._floatArrays[13],m._originalMatrix4._floatArrays[14]]),1),2===m.refMatrixType&&1;T=t.readUInt8(e,l,l+1);if(l+=1,T){C=t.readUInt16(e,l,l+2);l+=2;b=t.readUInt8(e,l,l+1);l+=1,5121===C&&(U=1);M=t.readUInt8(e,l,l+U);l+=U;A=t.readUInt8(e,l,l+U);l+=U;E=t.readUInt8(e,l,l+U);l+=U;L=255;4===b&&(L=t.readUInt8(e,l,l+U),l+=U),m.color4=new J,m.color4.set(M,A,E,L)}w=t.readUInt8(e,l,l+1);l+=1;S=t.readUInt8(e,l,l+1);if(l+=1,w||S){D=t.readInt32(e,l,l+4);l+=4,D>0&&void 0===m.vBOVertexIdxCacheKeysContainer&&(m.vBOVertexIdxCacheKeysContainer=new xt);for(R=0;R<D;R++){var N=m.vBOVertexIdxCacheKeysContainer.newVBOVertexIdxCacheKey();if(w){C=t.readUInt16(e,l,l+2);l+=2;b=t.readUInt8(e,l,l+1);l+=1,5120===C||5121===C?U=1:5122===C||5123===C?U=2:5126===C&&(U=4);P=t.readUInt32(e,l,l+4);l+=4,c=U*(G=P*b),g=h.getClassifiedBufferSize(c),m.vertexCount=P,n=l,a=l+U*G,N.colVboDataArray=new Float32Array(g),N.colVboDataArray.set(new Float32Array(e.slice(n,a))),N.colArrayByteSize=g,l+=U*G,N.isReadyColors(s,o.vboMemoryManager)||(this.succesfullyGpuDataBinded=!1)}if(S){var U;C=t.readUInt16(e,l,l+2);l+=2,5120===C||5121===C?U=1:5122===C||5123===C?U=2:5126===C&&(U=4);var G;P=t.readUInt32(e,l,l+4);l+=4,d=U*(G=2*P),f=h.getClassifiedBufferSize(d),m.vertexCount=P,n=l,a=l+U*G,N.tcoordVboDataArray=new Float32Array(f),N.tcoordVboDataArray.set(new Float32Array(e.slice(n,a))),N.tcoordArrayByteSize=f,l+=U*G}}}F=t.readUInt32(e,l,l+4);if(l+=4,F>0){var z,H="";O=t.readUInt32(e,l,l+4);l+=4;for(R=0;R<O;R++)H+=String.fromCharCode(new Int8Array(e.slice(l,l+1))),l+=1;B=t.readUInt32(e,l,l+4);l+=4;var V=new Uint8Array(e.slice(l,l+B));l+=B,z=new TextDecoder("utf-8").decode(V),B>0&&(m.texture=new it,m.hasTexture=!0,m.texture.textureTypeName=H,m.texture.textureImageFileName=z)}else m.hasTexture=!1;i&&m.multiplyTransformMatrix(i)}}void 0===this.exterior_ocCullOctree&&(this.exterior_ocCullOctree=new ke);var k=this.exterior_ocCullOctree;l=this.exterior_ocCullOctree.parseArrayBuffer(e,l,t),k.expandBox(1e3),k.setSizesSubBoxes(),k.createModelReferencedGroups(this.motherNeoRefsList),void 0===this.interior_ocCullOctree&&(this.interior_ocCullOctree=new ke);var j=this.interior_ocCullOctree;return l=this.interior_ocCullOctree.parseArrayBuffer(e,l,t),j.setSizesSubBoxes(),j.createModelReferencedGroups(this.motherNeoRefsList),this.fileLoadState=I.fileLoadState.PARSE_FINISHED,this.succesfullyGpuDataBinded},nr.prototype.render=function(e,t,r,i,o,n,a){var s=!0,l=t.nodeOwner.data.attributes.isReference;if(!this.isReadyToRender())return!1;var u=e.sceneState.gl;0===r&&(o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc)),i&&(u.activeTexture(u.TEXTURE2),1===r&&u.uniform1i(o.colorType_loc,2));for(var c=this.currentVisibleIndices.length,d=0,h=0;h<c;h++){var f=this.motherNeoRefsList[this.currentVisibleIndices[h]];if(void 0!==f)if(e.currentProcess===I.magoCurrentProcess.SilhouetteDepthRendering)f.render(e,t,r,i,o,a,n);else{if(!l&&f.renderingFase===e.renderingFase)continue;f.render(e,t,r,i,o,a,n)||d++,f.swapRenderingFase(e.renderingFase)}}return(c-d)/c<.4&&(s=!1),d/c>.2&&(s=!1),s};var ar=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.accesorsArray=[],this.vbo_vicks_container=new xt,this.texturesArray=[]};ar.prototype.newAccesor=function(){var e=new zt;return this.accesorsArray.push(e),e},ar.prototype.newTexture=function(){var e=new sr;return this.texturesArray.push(e),e};var sr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.lod,this.textureId,this.texImage,this.loadStarted=!1,this.loadFinished=!1};function H(e){"@babel/helpers - typeof";return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var lr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._guid=qo(),this.parent,this.children=[],this.data};Object.defineProperties(lr.prototype,{guid:{get:function(){return this._guid}}}),lr.prototype.isReferenceNode=function(){var e=!1;if(void 0!==this.data){var t=this.data.attributes;void 0!==t&&void 0!==t.isReference&&(e=t.isReference)}return e},lr.prototype.isOpaque=function(){var e=!0;return this.data&&this.data.attributes&&void 0!==this.data.attributes.opacity&&(e=1===this.data.attributes.opacity),e},lr.prototype.isReadyToRender=function(){var e=this.getNodeGeoLocDataManager();if(void 0===e)return!1;var t=e.getCurrentGeoLocationData();if(void 0===t)return!1;var r=t.getGeographicCoords();return void 0!==r&&(void 0!==r.longitude&&void 0!==r.latitude&&void 0!==r.altitude)},lr.prototype.getId=function(){if(!this.data)throw new Error("data is not ready.");return this.data.nodeId+"#"+this.data.projectId},lr.prototype.deleteObjects=function(e,t){this.parent=void 0;var r=this.data;if(void 0!==r){if(this.isReferenceNode())return;r.neoBuilding&&(r.neoBuilding.deleteObjects(e,t),r.neoBuilding=void 0),r.geographicCoord&&(r.geographicCoord.deleteObjects(),r.geographicCoord=void 0),r.rotationsDegree&&(r.rotationsDegree.deleteObjects(),r.rotationsDegree=void 0),r.bbox&&(r.bbox.deleteObjects(),r.bbox=void 0),this.data=void 0}if(this.children){for(var i=this.children.length,o=0;o<i;o++)this.children[o].deleteObjects(e,t),this.children[o]=void 0;this.children=void 0}},lr.prototype.calculateGeoLocData=function(e){var t=this.getRoot();void 0===t.data.geoLocDataManager&&(t.data.geoLocDataManager=new ye);var r,i,o=t.data.geoLocDataManager,n=o.getCurrentGeoLocationData();if(void 0===n&&(n=o.newGeoLocationData("deploymentLoc")),void 0===this.data.geographicCoord){var a=this.data.buildingSeed;r=a.geographicCoord,i=a.rotationsDegree}else r=this.data.geographicCoord,i=this.data.rotationsDegree;void 0===i&&(i=new Jr(0,0,0));var s=r.longitude,l=r.latitude,u=r.altitude,c=i.z,d=i.x,h=i.y;return on.calculateGeoLocationData(s,l,u,c,d,h,n,e),this.correctGeoLocationDataByMappingType(n),n},lr.prototype.correctGeoLocationDataByMappingType=function(e){var t;void 0!==this.data.mapping_type?void 0!==(t=this.data.buildingSeed?this.data.buildingSeed.bBox:this.data.neoBuilding.metaData.bbox)&&("boundingboxcenter"===this.data.mapping_type.toLowerCase()?this.pointSC=t.getCenterPoint(this.pointSC):"boundingboxbottomcenter"===this.data.mapping_type.toLowerCase()?this.pointSC=t.getBottomCenterPoint(this.pointSC):(e.pivotPointTraslationLC=void 0,this.pointSC=new Jr(0,0,0)),on.translatePivotPointGeoLocationData(e,this.pointSC)):this.data.mapping_type="origin"},lr.prototype.checkChangesHistoryMovements=function(){var e=this.data.moveHistoryMap;if(void 0!==e){var t=this.data.neoBuilding;for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)){var i=e[r],o=i.getObjectIndexOrder(),n=t.getReferenceObject(o);if(void 0===n)continue;void 0===n.moveVector&&(n.moveVector=new Jr),void 0===n.moveVectorRelToBuilding&&(n.moveVectorRelToBuilding=new Jr);var a=i.getReferenceObjectAditionalMovement(),s=i.getReferenceObjectAditionalMovementRelToBuilding();n.moveVectorRelToBuilding.set(s.x,s.y,s.z),n.moveVector.set(a.x,a.y,a.z);var l=this.getRoot();if(void 0===l)continue;var u=l.getNodeGeoLocDataManager().getCurrentGeoLocationData();n.moveVector=u.tMatrix.rotatePoint3D(n.moveVectorRelToBuilding,n.moveVector)}}},lr.prototype.checkChangesHistoryColors=function(){var e=this.data;if(void 0!==e){var t=e.colorChangedHistoryMap;if(void 0!==t){for(var r in t)if(Object.prototype.hasOwnProperty.call(t,r)){var i=t[r];if(null===i.objectId||void 0===i.objectId||""===i.objectId)if(null===i.property||void 0===i.property||""===i.property)e.isColorChanged=!0,void 0===e.aditionalColor&&(e.aditionalColor=new J),e.aditionalColor.setRGBA(i.color[0],i.color[1],i.color[2],i.color[3]);else{var o=[];this.extractNodes(o);for(var n,a=o.length,s=0;s<a;s++){n=o[s];var l=i.propertyKey,u=i.propertyValue;void 0!==n.data.attributes[l]&&n.data.attributes[l].toString()===u&&(e.isColorChanged=!0,void 0===e.aditionalColor&&(e.aditionalColor=new J),e.aditionalColor.setRGBA(i.color[0],i.color[1],i.color[2],i.color[3]))}}else{var c=this.data.neoBuilding;if(void 0===c)return;var d=i.objectId,h=c.getReferenceObjectsArrayByObjectId(d);if(h)for(var f=h.length,g=0;g<f;g++){var p=h[g];void 0===p.aditionalColor&&(p.aditionalColor=new J),p.aditionalColor.setRGBA(i.color[0],i.color[1],i.color[2],i.color[3])}}}}}},lr.prototype.renderContent=function(e,t,r,i){var o=this.data;if(void 0!==o){this.renderCondition&&"function"==typeof this.renderCondition&&this.renderCondition.call(this,o);var n=o.attributes;if(n){if(void 0!==n.isVisible&&!1===n.isVisible)return;if(e.currentProcess===I.magoCurrentProcess.DepthShadowRendering&&void 0!==n.castShadow&&!1===n.castShadow)return}if(2!==r&&e.currentProcess!==I.magoCurrentProcess.StencilSilhouetteRendering)var a=e.effectsManager.executeEffects(this.guid,e);var s=e.selectionManager;s.isObjectSelected(this)?s.parentSelected=!0:s.parentSelected=!1;var l=o.neoBuilding;if(void 0!==l){l.currentVisibleOctreesControler=o.currentVisibleOctreesControler,l.myCameraRelative=o.myCameraRelative,l.isColorChanged=o.isColorChanged,l.aditionalColor=o.aditionalColor,this.checkChangesHistoryColors(),this.checkChangesHistoryMovements();l.metaData.projectDataType;var u=this.getRoot().data.geoLocDataManager;if(void 0!==u){var c=e.sceneState.gl,d=e.hierarchyManager.getNodesMap(o.projectId);if(void 0!==d.attributes&&void 0!==d.attributes.specularLighting&&void 0!==t.bApplySpecularLighting_loc)d.attributes.specularLighting?c.uniform1i(t.bApplySpecularLighting_loc,!0):c.uniform1i(t.bApplySpecularLighting_loc,!1);e.renderer.currentObjectsRendering.curNode=this;var h=!1;void 0!==o.attributes.flipYTexCoords&&(h=o.attributes.flipYTexCoords),c.uniform1i(t.textureFlipYAxis_loc,h);var f=e.renderingFase;this.isReferenceNode()&&(e.renderingFase=-10);var g,p=this.data.isTrailRender;if(void 0!==p&&!0===p&&1===r){e.isTrailRender=!0,c.depthRange(.1,1);for(var m=u.getGeoLocationDatasCount(),v=1;v<m;v++){var x;(x=u.getGeoLocationData(v)).bindGeoLocationUniforms(c,t);var _=(m-v)/(7*m);c.uniform1f(t.externalAlpha_loc,_),l.currentLod=o.currentLod,l.render(e,t,r,i,h,o.currentLod)}c.depthRange(0,1),e.isTrailRender=!1}g=u.getGeoLocationDatasCount()>1?1:0,(x=u.getGeoLocationData(g)).bindGeoLocationUniforms(c,t);var y=1;if(void 0!==n.opacity&&(y=n.opacity),10===l.metaData.getProjectDataType()){var T=l.octree;T&&T.neoReferencesMotherAndIndices&&this.mustRecalculateRefKeyMatrix&&(T.multiplyKeyTransformMatrix(0,x.rotMatrix),this.mustRecalculateRefKeyMatrix=!1)}c.uniform1f(t.externalAlpha_loc,1),c.uniform1f(t.uModelOpacity_loc,y),l.currentLod=o.currentLod;var C=l.render(e,t,r,i,h,o.currentLod);return e.renderingFase=f,void 0!==this.data.animationData&&!0===this.data.animationData.finished&&(u.getGeoLocationDatasCount()>1?u.popGeoLocationData():this.data.animationData=void 0),a&&(c.uniform3fv(t.scaleLC_loc,[1,1,1]),1===r&&c.uniform4fv(t.colorMultiplier_loc,[1,1,1,1])),c.uniform1f(t.uModelOpacity_loc,1),C}}}},lr.prototype.addChildren=function(e){e.setParent(this),this.children.push(e)},lr.prototype.setParent=function(e){this.parent=e},lr.prototype.getRoot=function(){return void 0===this.parent?this:this.parent.getRoot()},lr.prototype.setRenderCondition=function(e){if(!e||"function"!=typeof e)throw new Error("renderCondition is required.");this.renderCondition=e},lr.prototype.getRenderCondition=function(){return this.renderCondition},lr.prototype.getClosestParentWithData=function(e){return this.data&&this.data[e]?this:this.parent?this.parent.getClosestParentWithData(e):void 0},lr.prototype.extractNodesByDataName=function(e,t){this.data[t]&&e.push(this);for(var r=this.children.length,i=0;i<r;i++)this.children[i].extractNodesByDataName(e,t)},lr.prototype.extractNodes=function(e){e.push(this);for(var t=this.children.length,r=0;r<t;r++)this.children[r].extractNodes(e)},lr.prototype.getBBox=function(){var e,t=this.data;if(void 0===t.bbox){var r=t.neoBuilding;if(void 0!==r&&void 0!==r.metaData){var i=r.metaData;t.bbox=new G,t.bbox.copyFrom(i.bbox),e=t.bbox}else if(void 0!==t.buildingSeed){e=t.buildingSeed.bbox}}else e=t.bbox;return e},lr.prototype.getBBoxCenterPositionWorldCoord=function(e){return void 0===this.bboxAbsoluteCenterPos?this.calculateBBoxCenterPositionWorldCoord(e):this.bboxAbsoluteCenterPos},lr.prototype.calculateBBoxCenterPositionWorldCoord=function(e){var t,r=this.data,i=r.mapping_type;void 0===i&&(i="origin");var o,n=new Jr(0,0,0);if("origin"===i.toLowerCase())r.bbox||this.getBBox(),n=r.bbox.getCenterPoint(n);else if("boundingboxcenter"===i.toLowerCase())n.set(0,0,0);else if("boundingboxbottomcenter"===i.toLowerCase()){var a=r.bbox.getZLength();n.set(0,0,a/2)}(t=e.tMatrix.transformPoint3D(n,t),e.pivotPointTraslation)&&(o=e.tMatrix.rotatePoint3D(e.pivotPointTraslation,o),t.add(o.x,o.y,o.z));return t},lr.prototype.getBoundingSphereWC=function(e){if(void 0===this.bboxAbsoluteCenterPos)return e;void 0===e&&(e=new z);var t,r=this.getRoot().data.geoLocDataManager.getCurrentGeoLocationData(),i=this.getBBoxCenterPositionWorldCoord(r);return t=this.getBBox().getRadiusAprox(),e.setCenterPoint(i.x,i.y,i.z),e.setRadius(t),e},lr.prototype.getDistToCamera=function(e,t){var r=this.data,i=this.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0===this.bboxAbsoluteCenterPos){void 0===r.mapping_type&&(r.mapping_type="origin");var o=new Jr(0,0,0);if("origin"===r.mapping_type.toLowerCase())this.data.bbox||this.getBBox(),o=this.data.bbox.getCenterPoint(o);else if("boundingboxcenter"===r.mapping_type.toLowerCase())o.set(0,0,0);else if("boundingboxbottomcenter"===r.mapping_type.toLowerCase()){var n=this.data.bbox.getZLength();o.set(0,0,n/2)}this.bboxAbsoluteCenterPos=i.tMatrix.transformPoint3D(o,this.bboxAbsoluteCenterPos)}var a,s=this.getBBoxCenterPositionWorldCoord(i);a=this.getBBox().getRadiusAprox(),t.setCenterPoint(s.x,s.y,s.z),t.setRadius(a);var l=r.neoBuilding,u=l.metaData.projectDataType;if(u&&(4===u||5===u)){var c,d=l.octree;if(void 0===d)return;c=i.getTransformedRelativePosition(e,c);r.distToCam=d.getMinDistToCameraInTree(c,t,120),t.setCenterPoint(s.x,s.y,s.z),t.setRadius(l.bbox.getRadiusAprox())}return r.distToCam=e.distToSphere(t),r.distToCam},lr.prototype.getNodeGeoLocDataManager=function(){var e=this.getClosestParentWithData("geoLocDataManager");if(void 0!==e&&void 0!==e.data)return e.data.geoLocDataManager},lr.prototype.getCurrentGeoLocationData=function(){if(!this.isReadyToRender()||!this.data||!this.data.geoLocDataManager)throw new Error("this node is not ready to use.");return this.getNodeGeoLocDataManager().getCurrentGeoLocationData()},lr.prototype.finishedAnimation=function(e){var t=!1,r=this.data.animationData;if(void 0===r)return!0;var i,o,n,a,s,l,u=e.getCurrentTime(),c=r.autoChangeRotation;if(void 0===c&&(c=!1),r.animationType===I.animationType.PATH){if(r.stop)return r.lastTime=u,!1;var d=U.getNextPosition(r,u,e);if(void 0===d)return r.finished=!0,!0;var h=r.path.getGeoLocationDataManager().getCurrentGeoLocationData(),f=d.point,g=d.direction,p=h.tMatrix.transformPoint3D(f,void 0),m=Te.CartesianToGeographicWgs84(p.x,p.y,p.z,void 0);if(o=m.latitude,i=m.longitude,n=m.altitude,c){var v=new Kr(0,1),x=new Kr(g.x,g.y);x.unitary(),a=v.angleDegToVector(x),x.x>0&&(a*=-1)}else a=r.targetHeading,s=r.targetPitch,l=r.targetRoll;return this.changeLocationAndRotation(o,i,n,a,s,l,e),r.lastTime=u,t}if(r.finished)return!0;if(void 0===r.startLongitude||void 0===r.startLatitude||void 0===r.startAltitude)return!0;void 0===r.lastTime&&(r.lastTime=r.birthTime);var _=(u-r.birthTime)/1e3,y=(r.targetLongitude-r.startLongitude)/r.durationInSeconds,T=(r.targetLatitude-r.startLatitude)/r.durationInSeconds,C=(r.targetAltitude-r.startAltitude)/r.durationInSeconds,b=this.getNodeGeoLocDataManager();if(void 0===b)return!0;var M=b.getCurrentGeoLocationData();if(void 0===M)return!0;M.geographicCoord;if(_>r.durationInSeconds)i=r.targetLongitude,o=r.targetLatitude,n=r.targetAltitude,a=r.targetHeading,s=r.targetPitch,l=r.targetRoll,t=!0,this.data.animationData.finished=!0;else{var A=_/r.durationInSeconds;if(A>.3)a=r.targetHeading,s=r.targetPitch,l=r.targetRoll;else{var E=r.targetHeading-r.startHeading;a=r.startHeading+E*A/.3,s=r.startPitch,l=r.startRoll}r.targetLongitude,r.targetLatitude,r.targetAltitude;i=r.startLongitude+y*_,o=r.startLatitude+T*_,n=r.startAltitude+C*_,r.lastTime=u,t=!1}return this.changeLocationAndRotation(o,i,n,a,s,l,e),t},lr.prototype.changeLocationAndRotationAnimated=function(e,t,r,i,o,n,a,s){void 0===this.data.animationData&&(this.data.animationData=new N);var l=this.data.animationData;l.finished=!1,l.animationType=s.animationType,l.path=s.path,l.linearVelocityInMetersSecond=s.linearVelocityInMetersSecond,l.autoChangeRotation=s.autoChangeRotation,l.durationInSeconds=s.durationInSeconds;var u=this.getNodeGeoLocDataManager();if(void 0!==u){var c=u.getCurrentGeoLocationData();if(void 0!==c){var d=u.getGeoLocationData(1);void 0===d&&(d=u.getCurrentGeoLocationData());var h=c.getGeographicCoords();if(void 0!==h&&void 0!==h.longitude&&void 0!==h.latitude&&void 0!==h.altitude){var f=h.longitude-t,g=h.latitude-e,p=(h.altitude,Math.sqrt(f*f+g*g));if(p<65e-6)l.finished=!0;else{for(l.birthTime=a.getCurrentTime(),l.startLongitude=h.longitude,l.startLatitude=h.latitude,l.startAltitude=h.altitude;c.heading>360;)c.heading-=360;for(;c.heading<-360;)c.heading+=360;l.startHeading=c.heading,l.startPitch=c.pitch,l.startRoll=c.roll,l.targetLongitude=t,l.targetLatitude=e,l.targetAltitude=r;h.longitude,h.latitude,h.altitude;l.targetHeading=i,l.targetPitch=o,l.targetRoll=n;var m="object"===H(s)&&isNaN(s),v=3;if(void 0!==l.durationInSeconds&&(v=l.durationInSeconds),m)if(s.duration&&(v=s.duration),s.autoChangeRotation){var x,_=Te.geographicToCartesianWgs84(l.targetLongitude,l.targetLatitude,l.targetAltitude,void 0),y=new Jr(_[0],_[1],_[2]);(x=d.getTransformedRelativePositionNoApplyHeadingPitchRoll(y,x)).unitary();var T=new Kr(0,1),C=new Kr(x.x,x.y);C.unitary();var b=T.angleDegToVector(C);x.x>0&&(b*=-1),b>180?b-=360:b<180&&(b+=360);var M=b;for(Math.sqrt(x.x*x.x+x.y*x.y);M>360;)M-=360;for(;M<-360;)M+=360;(A=M-l.startHeading)>180?M-=360:A<-180&&(M+=360),p<65e-6*1.5&&C.y<.1&&(M=l.startHeading),l.targetHeading=M,l.targetPitch=0,l.targetRoll=n}else{for(;i>360;)i-=360;for(;i<-360;)i+=360;var A;(A=i-l.startHeading)>180?i-=360:A<-180&&(i+=360),l.targetHeading=i}else v=s;l.durationInSeconds=v}}}}},lr.prototype.nodeMoved=function(e){if(void 0!==e){var t=e.data.smartTileOwner;if(!t.intersectsNode(e)){t.eraseNode(e);var r=t.targetDepth;magoManager.smartTileManager.putNode(r,e,magoManager)}}},lr.prototype.isNeedValidHeight=function(e){return!!(e.isCesiumGlobe()&&this.data&&this.data.attributes&&this.data.attributes.heightReference&&this.data.attributes.heightReference!==Ce.NONE)},lr.prototype.changeLocationAndRotation=function(e,t,r,i,o,n,a){var s;if(void 0!==(s=this.getClosestParentWithData("geoLocDataManager"))&&s.data.bbox){var l,u=[];s.extractNodesByDataName(u,"neoBuilding"),s.data.geographicCoord.longitude=t,s.data.geographicCoord.latitude=e,s.data.geographicCoord.altitude=r;for(var c=u.length,d=0;d<c;d++){var h,f=(l=u[d]).getNodeGeoLocDataManager();if(void 0!==f)if(void 0!==(h=void 0!==this.data.animationData?f.newGeoLocationData():f.getCurrentGeoLocationData())&&(h=on.calculateGeoLocationData(t,e,r,i,o,n,h,a),this.correctGeoLocationDataByMappingType(h),void 0!==h&&void 0!==h.geographicCoord)){var g=l.data.buildingSeed;g&&(g.geographicCoordOfBBox.longitude=t,g.geographicCoordOfBBox.latitude=e);var p=l.data.neoBuilding;p.octree&&p.octree.multiplyKeyTransformMatrix(0,h.rotMatrix),p.calculateBBoxCenterPositionWorldCoord(h),s.bboxAbsoluteCenterPos=void 0,s.bboxAbsoluteCenterPos=s.calculateBBoxCenterPositionWorldCoord(h),l.bboxAbsoluteCenterPos=void 0,l.bboxAbsoluteCenterPos=l.calculateBBoxCenterPositionWorldCoord(h),10===p.metaData.getProjectDataType()&&(this.mustRecalculateRefKeyMatrix=!0),void 0===s.data.bbox.geographicCoord&&(s.data.bbox.geographicCoord=new pe),s.data.bbox.geographicCoord.setLonLatAlt(t,e,r);var m=l.data.smartTileOwner;if(!m.intersectsNode(l)){m.eraseNode(l);var v=m.depth;a.smartTileManager.putNode(v,l,a)}var x=l.data.accessory;if(x&&x instanceof $e&&x.localWC){var _=h.tMatrix.transformPoint3D(x.localWC),y=on.pointToGeographicCoord(_),T=x.getCurrentGeoLocationData();T=on.calculateGeoLocationData(y.longitude,y.latitude,y.altitude,h.heading,h.pitch,h.roll,T),x.bCubeMapMade=!1}}}}},lr.prototype.intersectionWithPolygon2D=function(e){var t=this.data.bbox,r=this.getCurrentGeoLocationData().tMatrix,i=t.getGeographicCoordPolygon2D(r);return e.intersectionWithPolygon2D(i)},lr.prototype.caculateHeightByReference=function(e){void 0!==e&&null!==e||(e=0);this.getCurrentGeoLocationData().geographicCoord;var t=this.getBBox(),r=0;if("origin"===this.data.mapping_type)r=e-t.minZ;else if("boundingboxcenter"===this.data.mapping_type){r=e+Math.abs(t.maxZ-t.minZ)/2}return this.data.surfaceHeight=r,this.data.attributes.heightReference===Ce.RELATIVE_TO_GROUND&&(r+=this.data.relativeHeight),r},lr.prototype.setHeightReference=function(e,t){this.data.attributes.heightReference=e,this.data.attributes.heightReference!==Ce.NONE&&this.isNeedValidHeight(t)&&t._needValidHeightNodeArray.push(this)},lr.prototype.getHeightReference=function(){return this.data.attributes.heightReference},lr.prototype.deleteChangeColor=function(e){if(void 0===this.data)return!1;this.data.isColorChanged=!1,this.data.colorChangedHistoryMap=void 0,e.config.deleteF4dColorHistory(this.data.projectId,this.data.nodeId)},lr.prototype.setFromDate=function(e){if(!(e&&e instanceof Date))throw new Error("fromDate is required(Date Type).");if(!this.isReadyToRender())throw new Error("this date is not ready to use.");this.data.attributes.fromDate=e},lr.prototype.getFromDate=function(){return this.data.attributes.fromDate},lr.prototype.setToDate=function(e){if(!(e&&e instanceof Date))throw new Error("toDate is required(Date Type).");if(!this.isReadyToRender())throw new Error("this date is not ready to use.");this.data.attributes.toDate=e},lr.prototype.getToDate=function(){return this.data.attributes.toDate},lr.prototype.setVisible=function(e){this.data.attributes.isVisible=e},lr.prototype.getVisible=function(){return this.data.attributes.isVisible};var ur=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.centerPos=new Jr,this.half_dx=0,this.half_dy=0,this.half_dz=0,this.octree_owner,t&&(this.octree_owner=t,this.octree_level=t.octree_level+1),this.octree_level=0,this.octree_number_name=0,this.neoBuildingOwnerId,this.neoBuildingOwner,this.octreeKey,this.lod,this.distToCamera,this.triPolyhedronsCount=0,this.fileLoadState=I.fileLoadState.READY,this.subOctrees_array=[],this.neoReferencesMotherAndIndices,this.lowestOctrees_array,this.lego,this.pCloudPartitionsCount,this.pCloudPartitionsArray,this.objectsArray};ur.prototype.new_subOctree=function(){var e=new ur(this);return e.octree_level=this.octree_level+1,this.subOctrees_array.push(e),e},ur.prototype.deleteObjectsModelReferences=function(e,t){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(e,t),this.neoReferencesMotherAndIndices=void 0,void 0!==this.subOctrees_array)for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteObjectsModelReferences(e,t)},ur.prototype.deleteObjectsLego=function(e,t){if(void 0!==this.lego&&(this.lego.deleteObjects(e,t),this.lego=void 0),void 0!==this.subOctrees_array)for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteObjectsLego(e,t)},ur.prototype.deleteObjects=function(e,t){if(void 0!==this.lego&&(this.lego.deleteObjects(e,t),this.lego=void 0),this.legoDataArrayBuffer=void 0,this.centerPos&&this.centerPos.deleteObjects(),this.centerPos=void 0,this.half_dx=void 0,this.half_dy=void 0,this.half_dz=void 0,this.octree_owner=void 0,this.octree_level=void 0,this.octree_number_name=void 0,this.distToCamera=void 0,this.triPolyhedronsCount=void 0,this.fileLoadState=void 0,this.neoBuildingOwner=void 0,this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(e,t),this.neoReferencesMotherAndIndices=void 0,this.deletePCloudObjects(e,t),void 0!==this.subOctrees_array){for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteObjects(e,t),this.subOctrees_array[r]=void 0;this.subOctrees_array=void 0}},ur.prototype.deletePCloudObjects=function(e,t){if(void 0!==this.pCloudPartitionsArray){for(var r=this.pCloudPartitionsArray.length,i=0;i<r;i++){this.pCloudPartitionsArray[i].deleteObjects(e,t)}this.pCloudPartitionsArray=void 0}if(void 0!==this.subOctrees_array){var o=this.subOctrees_array.length;for(i=0;i<o;i++){this.subOctrees_array[i].deletePCloudObjects(e,t)}}},ur.prototype.deleteLod0GlObjects=function(e,t){if(this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(e,t),void 0!==this.subOctrees_array)for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteLod0GlObjects(e,t)},ur.prototype.deleteLod2GlObjects=function(e,t){if(void 0!==this.lego&&(this.lego.deleteObjects(e,t),this.lego=void 0),this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.deleteObjects(e,t),void 0!==this.subOctrees_array)for(var r=0,i=this.subOctrees_array.length;r<i;r++)this.subOctrees_array[r].deleteLod2GlObjects(e,t)},ur.prototype.createChildren=function(){this.subOctrees_array=[];for(var e=0;e<8;e++){var t=this.new_subOctree();t.octree_number_name=10*this.octree_number_name+(e+1),t.neoBuildingOwnerId=this.neoBuildingOwnerId,t.octreeKey=this.neoBuildingOwnerId+"_"+t.octree_number_name}this.setSizesSubBoxes()},ur.prototype.makeTree=function(e){if(this.octree_level<e){this.createChildren();for(var t=0;t<8;t++)this.subOctrees_array[t].makeTree(e)}},ur.prototype.prepareData=function(e){this.lod<2?this.prepareModelReferencesListData(e):this.lod>=2&&this.prepareSkinData(e)},ur.prototype.prepareSkinData=function(e){if(void 0!==this.octree_number_name&&void 0!==(d=this.neoBuildingOwner))if(10!==d.metaData.getProjectDataType()){void 0===this.lego&&(this.lego=new Xt,this.lego.birthTime=e.currTime,this.lego.fileLoadState=I.fileLoadState.READY,this.lego.legoKey=this.octreeKey+"_lego");var t=e.sceneState.gl,r=e.readerWriter.geometryDataPath,i=d.projectFolderName,o=d.buildingFileName,n=d.getHeaderVersion();if(this.lego.fileLoadState===I.fileLoadState.READY){var a=r+"/"+i+"/"+o+"/Bricks"+"/"+this.octree_number_name.toString()+"_Brick";if("v"===n[0])if(this.lego.vbo_vicks_container.vboCacheKeysArray[0]&&this.lego.vbo_vicks_container.vboCacheKeysArray[0].meshTexcoordsCacheKey){if(void 0===d.simpleBuilding3x3Texture){d.simpleBuilding3x3Texture=new it;var s=r+"/"+i+"/"+(o=d.buildingFileName)+"/SimpleBuildingTexture3x3.png"}void 0!==d.simpleBuilding3x3Texture&&d.simpleBuilding3x3Texture.fileLoadState===I.fileLoadState.READY&&e.readerWriter.readLegoSimpleBuildingTexture(t,s,d.simpleBuilding3x3Texture,e),e.readerWriter.getOctreeLegoArraybuffer(a,this,e)}else e.readerWriter.getOctreeLegoArraybuffer(a,this,e);else{void 0===d.simpleBuilding3x3Texture&&(d.simpleBuilding3x3Texture=new it);var l=d.getImageFileNameForLOD(2);if("noTexture"!==l){s=r+"/"+i+"/"+o+"/"+l;void 0!==d.simpleBuilding3x3Texture&&d.simpleBuilding3x3Texture.fileLoadState===I.fileLoadState.READY&&e.readerWriter.readLegoSimpleBuildingTexture(t,s,d.simpleBuilding3x3Texture,e,!0)}var u=d.lodBuildingDatasMap[2];if(u.isModelRef)e.readerWriter.getOctreeLegoArraybuffer(a,this,e);else if(d.lodMeshesMap){var c=u.geometryFileName;this.lego=d.lodMeshesMap[c]}}}else if(this.lego.fileLoadState===I.fileLoadState.PARSE_STARTED){var d,h=(d=this.neoBuildingOwner).nodeOwner.data.smartTileOwner,f=h.X,g=h.Y,p=h.depth,m=d.buildingId,v=this.lego.legoKey,x=e.legoParsedMap;if(!x)return;if(!x[p])return;if(!x[p][f])return;if(!x[p][f][g])return;if(!x[p][f][g][m])return;if(!x[p][f][g][m][v])return;var _=x[p][f][g][m][v];this.lego._parseLegoDataResultFromWorker(_,e),delete x[p][f][g][m][v]}}else this.prepareModelReferencesListData(e)},ur.prototype.prepareModelReferencesListData=function(e){var t=this.neoBuildingOwner;if(void 0!==t&&0!==this.triPolyhedronsCount&&void 0!==this.octree_number_name){t.getHeaderVersion();var r=e.readerWriter.geometryDataPath,i=t.buildingFileName,o=t.projectFolderName,n=!1,a=t.attributes;if(void 0!==a&&void 0!==a.keepDataArrayBuffers&&!0===a.keepDataArrayBuffers&&(n=!0),void 0===this.neoReferencesMotherAndIndices&&(this.neoReferencesMotherAndIndices=new nr,this.neoReferencesMotherAndIndices.motherNeoRefsList=t.motherNeoReferencesArray),this.neoReferencesMotherAndIndices.fileLoadState===I.fileLoadState.READY){void 0===this.neoReferencesMotherAndIndices.blocksList&&(this.neoReferencesMotherAndIndices.blocksList=new kt("0.0.1")),n&&(this.neoReferencesMotherAndIndices.blocksList.keepDataArrayBuffers=n);var s=r+"/"+o+"/"+i+"/References"+"/"+this.octree_number_name.toString()+"_Ref";e.readerWriter.getNeoReferencesArraybuffer(s,this,e)}var l=this.neoReferencesMotherAndIndices.blocksList;if(void 0!==l&&l.fileLoadState===I.fileLoadState.READY){var u=r+"/"+o+"/"+i+"/Models"+"/"+this.octree_number_name.toString()+"_Model";e.readerWriter.getNeoBlocksArraybuffer(u,this,e)}}},ur.prototype.prepareModelReferencesListData_partitionsVersion=function(e){var t=this.neoBuildingOwner;if(void 0!==t&&0!==this.triPolyhedronsCount&&void 0!==this.octree_number_name){var r=e.readerWriter.geometryDataPath,i=t.buildingFileName,o=t.projectFolderName;if(void 0===this.neoReferencesMotherAndIndices&&(this.neoReferencesMotherAndIndices=new nr,this.neoReferencesMotherAndIndices.motherNeoRefsList=t.motherNeoReferencesArray),this.neoReferencesMotherAndIndices.fileLoadState===I.fileLoadState.READY){if(void 0===this.neoReferencesMotherAndIndices.blocksList){var n=new kt("0.0.2");this.neoReferencesMotherAndIndices.blocksList=n,n.blocksArrayPartitionsCount=this.blocksListsPartitionsCount;var a=r+"/"+o+"/"+i+"/Models"+"/"+this.octree_number_name.toString()+"_Model_";n.blocksArrayPartitionsMasterPathName=a}var s=r+"/"+o+"/"+i+"/References"+"/"+this.octree_number_name.toString()+"_Ref";e.readerWriter.getNeoReferencesArraybuffer(s,this,e)}void 0!==(n=this.neoReferencesMotherAndIndices.blocksList)&&n.prepareData(e,this)}},ur.prototype.renderSkin=function(e,t,r,i,o){var n=e.sceneState.gl;if(void 0===this.lego)return this.lego=new Xt,this.lego.fileLoadState=I.fileLoadState.READY,this.lego.legoKey=this.octreeKey+"_lego",!1;if(this.lego.fileLoadState!==I.fileLoadState.PARSE_FINISHED)return!1;if(n.uniform1i(o.refMatrixType_loc,0),1===r){if(t.isHighLighted?(n.uniform1i(o.colorType_loc,0),n.uniform4fv(o.oneColor4_loc,this.highLightColor4),i=!1):t.isColorChanged&&(n.uniform1i(o.colorType_loc,0),n.uniform4fv(o.oneColor4_loc,[t.aditionalColor.r,t.aditionalColor.g,t.aditionalColor.b,t.aditionalColor.a]),i=!1),this.lego.hasTexCoords){if(void 0===t.simpleBuilding3x3Texture||!t.simpleBuilding3x3Texture.texId||!i)return!1;n.uniform1i(o.colorType_loc,2),o.last_tex_id!==t.simpleBuilding3x3Texture.texId&&(n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,t.simpleBuilding3x3Texture.texId),o.last_tex_id=t.simpleBuilding3x3Texture.texId)}if(e.isCameraMoved&&!e.isCameraMoving){var a,s=e.renderer.currentObjectsRendering.curNode;a=e.selectionColor.getAvailableColor(a);var l=e.selectionColor.decodeColor3(a.r,a.g,a.b);e.selectionManager.setCandidates(l,void 0,this,t,s),n.uniform4fv(o.uSelColor4_loc,[a.r/255,a.g/255,a.b/255,1])}}return this.lego.render(e,r,i,o,t)},ur.prototype.renderContent=function(e,t,r,i,o,n,a,s){var l=!1,u=e.sceneState.gl;if(10===t.metaData.getProjectDataType())return l=this.neoReferencesMotherAndIndices.render(e,t,r,i,o,n,a);if(this.lod<2){if(void 0===this.neoReferencesMotherAndIndices)return;u.uniform1i(o.textureFlipYAxis_loc,s),(l=this.neoReferencesMotherAndIndices.render(e,t,r,i,o,n,a))||(l=this.renderSkin(e,t,r,i,o))}else 2===this.lod&&(l=this.renderSkin(e,t,r,i,o));return l},ur.prototype.getPartitionsCountsForLod=function(e,t,r){var i=1;if(0===e)(i=t)>(o=r.magoPolicy.getPointsCloudSettings()).maxPartitionsLod0&&(i=o.maxPartitionsLod0);else if(1===e){var o=r.magoPolicy.getPointsCloudSettings();(i=Math.ceil(t/4))>o.maxPartitionsLod1&&(i=o.maxPartitionsLod1)}else e>1&&(i=1);return i},ur.prototype.preparePCloudData=function(e){if(void 0===this.pCloudPartitionsCount&&0===this.pCloudPartitionsCount)return!1;var t=this.neoBuildingOwner;if(void 0===t)return!1;if(e.processQueue.existOctreeToDeletePCloud(this))return!1;void 0===this.pCloudPartitionsArray&&(this.pCloudPartitionsArray=[]);for(var r=this.getPartitionsCountsForLod(this.lod,this.pCloudPartitionsCount,e),i=0;i<r;i++){var o=this.pCloudPartitionsArray[i];if(i<this.pCloudPartitionsArray.length){if(void 0!==o&&o.fileLoadState===I.fileLoadState.LOADING_FINISHED&&e.parseQueue.pCloudPartitionsParsed<4){var n=e.sceneState.gl;o.parsePointsCloudData(o.dataArrayBuffer,n,e),o.dataArrayBuffer=void 0,e.parseQueue.pCloudPartitionsParsed++}}else if(void 0===o){var a=e.readerWriter;if((0===this.octree_level?a.pCloudPartitionsMother_requested:a.pCloudPartitions_requested)<3&&e.vboMemoryManager.currentMemoryUsage<e.vboMemoryManager.buffersKeyWorld.bytesLimit/1.5){var s=new Xt;this.pCloudPartitionsArray.push(s),s.legoKey=this.octreeKey+"_"+i.toString();var l=t.projectFolderName,u=t.buildingFileName,c=e.readerWriter.geometryDataPath+"/"+l+"/"+u+"/References"+"/"+this.octree_number_name.toString()+"_Ref_"+i.toString();return a.getOctreePCloudPartitionArraybuffer(c,this,s,e),!0}}}return!1},ur.prototype.test__renderPCloud=function(e,t,r,i,o,n){var a=this.pCloudPartitionsCount;if(void 0!==a&&0!==a){var s=e.magoPolicy,l=(e.sceneState.camera,o.bigFrustum),u=o.position,c=this.centerPos.distToPoint(u)-this.getRadiusAprox();this.distToCamera=c;var d=e.visibleObjControlerPCloudOctrees;d.putObjectToArraySortedByDist(d.currentVisibles0,this),this.lod=s.getLod(c);var h=e.sceneState.gl;if(this.intersectionFrustum(l,e.boundingSphere_Aux)!==F.INTERSECTION_OUTSIDE){e.processQueue.eraseOctreeToDeletePCloud(this);if(void 0===this.pCloudPartitionsArray)return;for(var f=this.getPartitionsCountsForLod(this.lod,this.pCloudPartitionsCount,e),g=!0,p=0;p<f;p++){if(void 0===(_=this.pCloudPartitionsArray[p])||_.fileLoadState!==I.fileLoadState.PARSE_FINISHED){g=!1;break}var m=_.bPositionsCompressed;h.uniform1i(i.bPositionCompressed_loc,m);var v=_.bbox;h.uniform3fv(i.bboxSize_loc,new Float32Array([v.getXLength(),v.getYLength(),v.getZLength()])),h.uniform3fv(i.minPosition_loc,new Float32Array([v.minX,v.minY,v.minZ])),e.renderer.renderPCloud(h,_,e,i,r,c,this.lod)}if(this.lod>2&&(g=!1),2===this.lod&&this.octree_level>0&&(g=!1),g){p=0;for(var x=this.subOctrees_array.length;p<x;p++){this.subOctrees_array[p].test__renderPCloud(e,t,r,i,o,n)}}e.processQueue.eraseOctreeToDeletePCloud(this)}else if(c>50){if(void 0!==this.pCloudPartitionsArray)for(f=this.pCloudPartitionsArray.length,p=0;p<f;p++){var _=this.pCloudPartitionsArray[p];e.parseQueue.eraseOctreePCloudPartitionToParse(_)}e.processQueue.putOctreeToDeletePCloud(this)}}},ur.prototype.getNumberOfDigits=function(e){return e>0?Math.floor(Math.log10(e)+1):1},ur.prototype.getMotherOctree=function(){return void 0===this.octree_owner?this:this.octree_owner.getMotherOctree()},ur.prototype.getOctree=function(e,t){if(1===t)return 0===e?this.getMotherOctree():this.subOctrees_array[e-1];var r=t-1,i=Math.pow(10,r),o=Math.floor(e/i)%10,n=e-o*i;return this.subOctrees_array[o-1].getOctree(n,t-1)},ur.prototype.getOctreeByNumberName=function(e){var t=this.getMotherOctree(),r=this.getNumberOfDigits(e);if(1===r)return 0===e?t:t.subOctrees_array[e-1];if(0!==t.subOctrees_array.length){var i=r-1,o=Math.pow(10,i),n=Math.floor(e/o)%10,a=e-n*o;return t.subOctrees_array[n-1].getOctree(a,r-1)}},ur.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array.length>7){var e=this.centerPos.x,t=this.centerPos.y,r=this.centerPos.z,i=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(i,e,o,t,n,r),this.subOctrees_array[1].setBoxSize(e,a,o,t,n,r),this.subOctrees_array[2].setBoxSize(e,a,t,s,n,r),this.subOctrees_array[3].setBoxSize(i,e,t,s,n,r),this.subOctrees_array[4].setBoxSize(i,e,o,t,r,l),this.subOctrees_array[5].setBoxSize(e,a,o,t,r,l),this.subOctrees_array[6].setBoxSize(e,a,t,s,r,l),this.subOctrees_array[7].setBoxSize(i,e,t,s,r,l);for(var u=this.subOctrees_array.length,c=0;c<u;c++)this.subOctrees_array[c].setSizesSubBoxes()}},ur.prototype.setBoxSize=function(e,t,r,i,o,n){this.centerPos.x=(t+e)/2,this.centerPos.y=(i+r)/2,this.centerPos.z=(n+o)/2,this.half_dx=(t-e)/2,this.half_dy=(i-r)/2,this.half_dz=(n-o)/2},ur.prototype.getCenterPos=function(){return this.centerPos},ur.prototype.getRadiusAprox=function(){return 1.7*this.half_dx},ur.prototype.getFrustumVisibleLowestOctreesByLOD=function(e,t,r,i,o,n,a,s){for(var l=[],u=!1,c=(l=this.getFrustumVisibleOctreesNeoBuildingAsimetricVersion(e,l,i)).length,d=0;d<c;d++)l[d].setDistToCamera(o);for(d=0;d<c;d++)l[d].distToCamera<n?l[d].triPolyhedronsCount>0&&(r&&this.putOctreeInEyeDistanceSortedArray(r.currentVisibles0,l[d]),t.currentVisibles0.push(l[d]),l[d].lod=0,u=!0):l[d].distToCamera<a?l[d].triPolyhedronsCount>0&&(r&&this.putOctreeInEyeDistanceSortedArray(r.currentVisibles1,l[d]),t.currentVisibles1.push(l[d]),l[d].lod=1,u=!0):l[d].distToCamera<s?l[d].triPolyhedronsCount>0&&(r&&this.putOctreeInEyeDistanceSortedArray(r.currentVisibles2,l[d]),t.currentVisibles2.push(l[d]),l[d].lod=2,u=!0):l[d].triPolyhedronsCount>0&&(r&&r.currentVisibles3.push(l[d]),t.currentVisibles3.push(l[d]),l[d].lod=3,u=!0);return l=void 0,u},ur.prototype.getBoundingBox=function(e){return void 0===e&&(e=new G),e.set(this.centerPos.x-this.half_dx,this.centerPos.y-this.half_dy,this.centerPos.z-this.half_dz,this.centerPos.x+this.half_dx,this.centerPos.y+this.half_dy,this.centerPos.z+this.half_dz),e},ur.prototype.intersectsWithTriangle=function(e){if(void 0===e)return!1;this.getBoundingBox();return!0},ur.prototype.intersectsWithPoint3D=function(e,t,r){var i=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dz,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dz,l=this.centerPos.z+this.half_dz,u=!1;return e>i&&e<a&&t>o&&t<s&&r>n&&r<l&&(u=!0),u},ur.prototype.getIntersectedSubBoxByPoint3D=function(e,t,r){if(void 0===this.octree_owner&&!this.intersectsWithPoint3D(e,t,r))return!1;var i=void 0;if(this.subOctrees_array.length>0){var o,n=this.centerPos.x,a=this.centerPos.y,s=this.centerPos.z;o=e<n?t<a?r<s?0:4:r<s?3:7:t<a?r<s?1:5:r<s?2:6,i=this.subOctrees_array[o].getIntersectedSubBoxByPoint3D(e,t,r)}else i=this;return i},ur.prototype.getMinDistToCamera=function(e){var t,r=1e6;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var i=this.lowestOctrees_array.length,o=0;o<i;o++)(t=this.lowestOctrees_array[o].centerPos.distToPoint(e)-this.getRadiusAprox())<r&&(r=t);return r},ur.prototype.extractLowestOctreesByLOD=function(e,t,r,i,o,n,a){var s=!1;i.x,i.y,i.z;void 0===this.lowestOctrees_array&&(this.lowestOctrees_array=[],this.extractLowestOctreesIfHasTriPolyhedrons(this.lowestOctrees_array));for(var l=this.lowestOctrees_array.length,u=0;u<l;u++)this.lowestOctrees_array[u].setDistToCamera(i);for(u=0;u<l;u++)this.lowestOctrees_array[u].distToCamera<o?this.lowestOctrees_array[u].triPolyhedronsCount>0&&(t&&this.putOctreeInEyeDistanceSortedArray(t.currentVisibles0,this.lowestOctrees_array[u]),e.currentVisibles0.push(this.lowestOctrees_array[u]),this.lowestOctrees_array[u].lod=0,s=!0):this.lowestOctrees_array[u].distToCamera<n?this.lowestOctrees_array[u].triPolyhedronsCount>0&&(t&&this.putOctreeInEyeDistanceSortedArray(t.currentVisibles1,this.lowestOctrees_array[u]),e.currentVisibles1.push(this.lowestOctrees_array[u]),this.lowestOctrees_array[u].lod=1,s=!0):this.lowestOctrees_array[u].distToCamera<a?this.lowestOctrees_array[u].triPolyhedronsCount>0&&(t&&this.putOctreeInEyeDistanceSortedArray(t.currentVisibles2,this.lowestOctrees_array[u]),e.currentVisibles2.push(this.lowestOctrees_array[u]),this.lowestOctrees_array[u].lod=2,s=!0):this.lowestOctrees_array[u].triPolyhedronsCount>0&&(t&&t.currentVisibles3.push(this.lowestOctrees_array[u]),e.currentVisibles3.push(this.lowestOctrees_array[u]),this.lowestOctrees_array[u].lod=3,s=!0);return s},ur.prototype.intersectionFrustum=function(e,t){return void 0===t&&(t=new Je),t.centerPoint.x=this.centerPos.x,t.centerPoint.y=this.centerPos.y,t.centerPoint.z=this.centerPos.z,t.r=this.getRadiusAprox(),e.intersectionSphere(t)},ur.prototype.getFrustumVisibleOctreesNeoBuildingAsimetricVersion=function(e,t,r){if(void 0!==this.subOctrees_array&&(0!==this.subOctrees_array.length||0!==this.triPolyhedronsCount)){void 0===t&&(t=[]);var i=this.intersectionFrustum(e,r);if(i===F.INTERSECTION_INSIDE)this.getAllSubOctreesIfHasRefLists(t);else if(i===F.INTERSECTION_INTERSECT)if(0===this.subOctrees_array.length)t.push(this);else for(var o=0,n=this.subOctrees_array.length;o<n;o++)this.subOctrees_array[o].getFrustumVisibleOctreesNeoBuildingAsimetricVersion(e,t,r);return t}},ur.prototype.getBBoxIntersectedOctreesNeoBuildingAsimetricVersion=function(e,t,r){void 0!==this.subOctrees_array&&(0===this.subOctrees_array.length&&0===this.triPolyhedronsCount||(void 0===t&&(t=[]),void 0===r&&(r=new G),r.minX=this.centerPos.x-this.half_dx,r.maxX=this.centerPos.x+this.half_dx,r.minY=this.centerPos.y-this.half_dy,r.maxY=this.centerPos.y+this.half_dy,r.minZ=this.centerPos.z-this.half_dz,r.maxZ=this.centerPos.z+this.half_dz,e.intersectsWithBBox(r)&&this.getAllSubOctreesIfHasRefLists(t)))},ur.prototype.setDistToCamera=function(e){var t=this.centerPos.distToPoint(e)-this.getRadiusAprox();return this.distToCamera=t,t},ur.prototype.putOctreeInEyeDistanceSortedArray=function(e,t){if(e.length>0){var r=e.length-1,i=on.getIndexToInsertBySquaredDistToEye(e,t,0,r);e.splice(i,0,t)}else e.push(t)},ur.prototype.getAllSubOctreesIfHasRefLists=function(e){if(void 0!==this.subOctrees_array)if(void 0===e&&(e=[]),this.subOctrees_array.length>0)for(var t=0,r=this.subOctrees_array.length;t<r;t++)this.subOctrees_array[t].getAllSubOctreesIfHasRefLists(e);else this.triPolyhedronsCount>0&&e.push(this)},ur.prototype.getAllSubOctrees=function(e){if(void 0===e&&(e=[]),this.subOctrees_array.length>0)for(var t=0,r=this.subOctrees_array.length;t<r;t++)this.subOctrees_array[t].getAllSubOctrees(e);else e.push(this)},ur.prototype.extractLowestOctreesIfHasTriPolyhedrons=function(e){if(void 0!==this.subOctrees_array){var t=this.subOctrees_array.length;if(0===t&&this.triPolyhedronsCount>0)e.push(this);else for(var r=0;r<t;r++)this.subOctrees_array[r].extractLowestOctreesIfHasTriPolyhedrons(e)}},ur.prototype.multiplyKeyTransformMatrix=function(e,t){var r=this.subOctrees_array.length;if(0===r&&this.triPolyhedronsCount>0)this.neoReferencesMotherAndIndices&&this.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(e,t);else for(var i=0;i<r;i++)this.subOctrees_array[i].multiplyKeyTransformMatrix(e,t)},ur.prototype.parseAsimetricVersion=function(e,t,r){r.getHeaderVersion();var i=hr.readInt32(e,t,t+4);if(t+=4,0===i){var o=hr.readFloat32(e,t,t+4);t+=4;var n=hr.readFloat32(e,t,t+4);t+=4;var a=hr.readFloat32(e,t,t+4);t+=4;var s=hr.readFloat32(e,t,t+4);t+=4;var l=hr.readFloat32(e,t,t+4);t+=4;var u=hr.readFloat32(e,t,t+4);t+=4,this.setBoxSize(o,n,a,s,l,u),this.octree_number_name=0}var c=hr.readUInt8(e,t,t+1);t+=1,this.triPolyhedronsCount=hr.readInt32(e,t,t+4),t+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=r),c>0&&this.createChildren();for(var d=0;d<c;d++){t=this.subOctrees_array[d].parseAsimetricVersion(e,t,r)}return t},ur.prototype.parsePyramidVersion=function(e,t,r){var i=hr.readInt32(e,t,t+4);if(t+=4,0===i){var o=hr.readFloat32(e,t,t+4);t+=4;var n=hr.readFloat32(e,t,t+4);t+=4;var a=hr.readFloat32(e,t,t+4);t+=4;var s=hr.readFloat32(e,t,t+4);t+=4;var l=hr.readFloat32(e,t,t+4);t+=4;var u=hr.readFloat32(e,t,t+4);t+=4,this.setBoxSize(o,n,a,s,l,u),this.octree_number_name=0}var c=hr.readUInt8(e,t,t+1);t+=1,this.triPolyhedronsCount=hr.readInt32(e,t,t+4),t+=4,this.triPolyhedronsCount>0&&(this.neoBuildingOwner=r),this.pCloudPartitionsCount=hr.readInt32(e,t,t+4),t+=4;for(var d=0;d<c;d++){(h=this.new_subOctree()).octree_number_name=10*this.octree_number_name+(d+1),h.neoBuildingOwnerId=this.neoBuildingOwnerId,h.octreeKey=this.neoBuildingOwnerId+"_"+h.octree_number_name}this.setSizesSubBoxes();for(d=0;d<c;d++){var h;t=(h=this.subOctrees_array[d]).parsePyramidVersion(e,t,r)}return t},ur.prototype.getDistToCamera=function(e,t){return t.setCenterPoint(this.centerPos.x,this.centerPos.y,this.centerPos.z),t.setRadius(this.getRadiusAprox()),e.distToSphere(t)},ur.prototype.getMinDistToCameraInTree=function(e,t,r){var i,o=this.getRadiusAprox(),n=this.subOctrees_array.length;if(o>r&&n>0){for(var a,s,l,u=0;u<n;u++){var c=!1,d=this.subOctrees_array[u];d.pCloudPartitionsCount&&d.pCloudPartitionsCount>0&&(c=!0),d.triPolyhedronsCount&&d.triPolyhedronsCount>0&&(c=!0),c&&(a=d.centerPos.squareDistToPoint(e),void 0===s?(s=a,l=d):a<s&&(s=a,l=d))}if(l)return l.getMinDistToCameraInTree(e,t,r)}else i=this.centerPos.distToPoint(e);return i};var cr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.objectsToParseMap={},this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={},this.octreesPCloudToParseMap={},this.octreesPCloudPartitionToParseMap={},this.skinLegosToParseMap={},this.tinTerrainsToParseMap={},this.multiBuildingsToParseMap={},this.maxNumParses=10,this.smartTileF4dParsesCount=0,this.pCloudPartitionsParsed=0,this.lowlodMeshesParsed=0};cr.prototype.putMultiBuildingsToParse=function(e,t){void 0===t&&(t=0),this.multiBuildingsToParseMap[e.id]=e},cr.prototype.eraseMultiBuildingsToParse=function(e){if(void 0!==e){var t=e.id;return!!this.multiBuildingsToParseMap.hasOwnProperty(t)&&(delete this.multiBuildingsToParseMap[t],!0)}},cr.prototype.putTinTerrainToParse=function(e,t){void 0===t&&(t=0),this.tinTerrainsToParseMap[e.getPathName()]=e},cr.prototype.eraseTinTerrainToParse=function(e){if(void 0!==e){var t=e.getPathName();return!!this.tinTerrainsToParseMap.hasOwnProperty(t)&&(delete this.tinTerrainsToParseMap[t],!0)}},cr.prototype.parseMultiBuildings=function(e,t,r){if(Object.keys(this.multiBuildingsToParseMap).length>0){this.maxNumParses;for(var i=t.length,o=0;o<i;o++){var n=t[o].data.multiBuildings;this.eraseMultiBuildingsToParse(n)&&n.parseData(r)}}},cr.prototype.parseArraySkins=function(e,t,r){if(Object.keys(this.skinLegosToParseMap).length>0){var i,o,n=0;this.maxNumParses;50;for(var a=t.length,s=0;s<a;s++)if(void 0!==(o=t[s].data.neoBuilding)&&void 0!==o.lodMeshesMap){var l=o.currentLod;if(!(l<0)){var u=void 0;if(0===l?u="lod0":1===l?u="lod1":2===l?u="lod2":3===l?u="lod3":4===l?u="lod4":5===l&&(u="lod5"),void 0!==u&&void 0!==(i=o.getLowerSkinLodToLoad(l))&&(this.eraseSkinLegosToParse(i)&&(i.parseArrayBuffer(i.dataArrayBuffer,r),i.dataArrayBuffer=void 0,n++),n>50))break}}for(var c in this.skinLegosToParseMap)if(Object.prototype.hasOwnProperty.call(this.skinLegosToParseMap,c)){if(void 0===(i=this.skinLegosToParseMap[c]))continue;if(this.eraseSkinLegosToParse(i)&&(i.parseArrayBuffer(i.dataArrayBuffer,r),i.dataArrayBuffer=void 0,n++),n>50)break}}},cr.prototype.parseArrayOctreesPCloud=function(e,t,r){if(Object.keys(this.octreesPCloudToParseMap).length>0){for(var i,o=this.maxNumParses,n=0,a=t.length,s=0;s<a;s++){if(i=t[s],this.eraseOctreePCloudToParse(i)){if(void 0===i.lego)continue;i.lego.parsePointsCloudData(e,i.lego.dataArrayBuffer,r),i.lego.dataArrayBuffer=void 0,n++}if(n>o)break}if(0===n)for(var l in this.octreesPCloudToParseMap)if(Object.prototype.hasOwnProperty.call(this.octreesPCloudToParseMap,l)){if(i=this.octreesPCloudToParseMap[l],this.eraseOctreePCloudToParse(i)){if(void 0===i.lego)continue;i.lego.parsePointsCloudData(i.lego.dataArrayBuffer,e,r),i.lego.dataArrayBuffer=void 0,n++}if(n>o)break}n>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}},cr.prototype.parseArrayOctreesPCloudPartition=function(e,t,r){if(Object.keys(this.octreesPCloudPartitionToParseMap).length>0){for(var i,o=this.maxNumParses,n=0,a=t.length,s=0;s<a;s++)if(void 0!==(i=t[s]).pCloudPartitionsArray){for(var l=i.pCloudPartitionsArray.length,u=0;u<l;u++){var c=i.pCloudPartitionsArray[u];this.eraseOctreePCloudPartitionToParse(c)&&(c.parsePointsCloudData(e,c.dataArrayBuffer,r),c.dataArrayBuffer=void 0,n++)}if(n>o)break}if(0===n)for(var d in this.octreesPCloudPartitionToParseMap)if(Object.prototype.hasOwnProperty.call(this.octreesPCloudPartitionToParseMap,d)&&(i=this.octreesPCloudPartitionToParseMap[d],this.eraseOctreePCloudPartitionToParse(i)&&(c.parsePointsCloudData(e,c.dataArrayBuffer,r),c.dataArrayBuffer=void 0,n++),n>o))break;n>0&&this.selectionFbo&&(this.selectionFbo.dirty=!0)}},cr.prototype.parseArrayOctreesLod2Legos=function(e,t){if(Object.keys(this.octreesLod2LegosToParseMap).length>0){for(var r,i=0,o=e.length,n=0;n<o;n++)if(r=e[n],this.eraseOctreeLod2LegosToParse(r)){if(void 0===r.lego)continue;if(!r.lego.dataArrayBuffer||0===r.lego.dataArrayBuffer.byteLength)continue;r.neoBuildingOwner._parseLegoByWorker(r.lego.dataArrayBuffer,r.lego,t),i++}i>0&&t.selectionFbo&&(t.selectionFbo.dirty=!0)}},cr.parseArrayOctreesLod0Models=function(e,t){if(void 0!==e.neoReferencesMotherAndIndices){var r=e.neoReferencesMotherAndIndices.blocksList;if(void 0!==r){var i=e.neoBuildingOwner,o=i.getHeaderVersion();void 0!==r.dataArraybuffer&&r.fileLoadState===I.fileLoadState.LOADING_FINISHED&&("v"===o[0]?r.parseBlocksList(r.dataArraybuffer,t.readerWriter,i.motherBlocksArray,t):"0.0.1"!==o&&"0.0.2"!==o||r.parseBlocksListVersioned_v001(r.dataArraybuffer,t.readerWriter,i.motherBlocksArray,t),r.dataArraybuffer=void 0)}}},cr.prototype.parseArrayOctreesLod0Models=function(e,t){if(Object.keys(this.octreesLod0ModelsToParseMap).length>0){for(var r,i=this.maxNumParses,o=0,n=e.length,a=0;a<n&&(r=e[a],this.eraseOctreeLod0ModelsToParse(r)&&(cr.parseArrayOctreesLod0Models(r,t),o++),!(o>i));a++);o>0&&t.selectionFbo&&(t.selectionFbo.dirty=!0)}},cr.prototype.parseArrayOctreesLod0References=function(e,t){if(Object.keys(this.octreesLod0ReferencesToParseMap).length>0){for(var r,i=this.maxNumParses,o=0,n=e.length,a=0;a<n&&(r=e[a],this.parseOctreesLod0References(r,t)&&o++,!(o>i));a++);o>0&&t.selectionFbo&&(t.selectionFbo.dirty=!0)}},cr.prototype.parseOctreesLod0References=function(e,t){var r=!1;return this.eraseOctreeLod0ReferencesToParse(e)&&(cr.parseOctreesLod0References(e,t),r=!0),r},cr.parseOctreesLod0References=function(e,t){if(void 0===e.neoReferencesMotherAndIndices)return!1;if(void 0===e.neoReferencesMotherAndIndices.dataArraybuffer)return!1;if(e.neoReferencesMotherAndIndices.fileLoadState!==I.fileLoadState.LOADING_FINISHED)return!1;var r,i=e.neoBuildingOwner,o=i.nodeOwner;if(void 0===(r=o?o.getRoot():void 0))return!1;if(void 0===r.data)return!1;var n=r.data.geoLocDataManager;if(void 0===n)return!1;void 0===t.matrix4SC&&(t.matrix4SC=new Ne);var a=n.getCurrentGeoLocationData(),s=i.getHeaderVersion();return t.matrix4SC.setByFloat32Array(a.rotMatrix._floatArrays),"v"===s[0]?e.neoReferencesMotherAndIndices.parseArrayBufferReferences(e.neoReferencesMotherAndIndices.dataArraybuffer,t.readerWriter,i,t.matrix4SC,t):e.neoReferencesMotherAndIndices.parseArrayBufferReferencesVersioned(e.neoReferencesMotherAndIndices.dataArraybuffer,t.readerWriter,i,t.matrix4SC,t),e.neoReferencesMotherAndIndices.multiplyKeyTransformMatrix(0,a.rotMatrix),e.neoReferencesMotherAndIndices.dataArraybuffer=void 0,!0},cr.prototype.putOctreeLod0ReferencesToParse=function(e,t){void 0===t&&(t=0),this.octreesLod0ReferencesToParseMap[e.octreeKey]=e},cr.prototype.eraseOctreeLod0ReferencesToParse=function(e){var t=e.octreeKey;return!!this.octreesLod0ReferencesToParseMap.hasOwnProperty(t)&&(delete this.octreesLod0ReferencesToParseMap[t],!0)},cr.prototype.putOctreeLod0ModelsToParse=function(e,t){void 0===t&&(t=0),this.octreesLod0ModelsToParseMap[e.octreeKey]=e},cr.prototype.eraseOctreeLod0ModelsToParse=function(e){var t=e.octreeKey;return!!this.octreesLod0ModelsToParseMap.hasOwnProperty(t)&&(delete this.octreesLod0ModelsToParseMap[t],!0)},cr.prototype.putOctreeLod2LegosToParse=function(e,t){void 0===t&&(t=0),this.octreesLod2LegosToParseMap[e.octreeKey]=e},cr.prototype.eraseOctreeLod2LegosToParse=function(e){var t=e.octreeKey;return!!this.octreesLod2LegosToParseMap.hasOwnProperty(t)&&(delete this.octreesLod2LegosToParseMap[t],!0)},cr.prototype.putOctreePCloudToParse=function(e,t){void 0===t&&(t=0),this.octreesPCloudToParseMap[e.octreeKey]=e},cr.prototype.eraseOctreePCloudToParse=function(e){if(void 0===e)return!1;var t=e.octreeKey;return!!this.octreesPCloudToParseMap.hasOwnProperty(t)&&(delete this.octreesPCloudToParseMap[t],!0)},cr.prototype.putOctreePCloudPartitionToParse=function(e,t){void 0===t&&(t=0),this.octreesPCloudPartitionToParseMap[e.legoKey]=e},cr.prototype.eraseOctreePCloudPartitionToParse=function(e){if(void 0===e)return!1;var t=e.legoKey;return!!this.octreesPCloudPartitionToParseMap.hasOwnProperty(t)&&(delete this.octreesPCloudPartitionToParseMap[t],!0)},cr.prototype.putSkinLegosToParse=function(e,t){void 0===t&&(t=0),this.skinLegosToParseMap[e.legoKey]=e,e.fileLoadState=I.fileLoadState.IN_PARSE_QUEUE},cr.prototype.eraseSkinLegosToParse=function(e){var t=e.legoKey;return!!this.skinLegosToParseMap.hasOwnProperty(t)&&(delete this.skinLegosToParseMap[t],!0)},cr.prototype.clearAll=function(){this.octreesLod0ReferencesToParseMap={},this.octreesLod0ModelsToParseMap={},this.octreesLod2LegosToParseMap={}},cr.prototype.eraseAny=function(e){this.eraseOctreeLod0ReferencesToParse(e),this.eraseOctreeLod0ModelsToParse(e),this.eraseOctreeLod2LegosToParse(e)},cr.prototype.initCounters=function(){this.smartTileF4dParsesCount=0,this.pCloudPartitionsParsed=0};var dr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={},this.nodesToDeleteLessThanLod3Map={},this.nodesToDeleteLessThanLod4Map={},this.nodesToDeleteLessThanLod5Map={},this.nodesToDeleteLodMeshMap={},this.tinTerrainsToDeleteMap={},this.smartTilesToDeleteMap={},this.nativeSlowDeleteArray=[],this.octreeToDeletePCloudsMap={}};dr.prototype.putSmartTileToDelete=function(e,t){if(void 0===t&&(t=0),void 0!==e){var r=e.getId();this.smartTilesToDeleteMap[r]=e}},dr.prototype.eraseSmartTileToDelete=function(e){if(void 0===e)return!1;var t=e.getId();return!!this.smartTilesToDeleteMap.hasOwnProperty(t)&&(delete this.smartTilesToDeleteMap[t],!0)},dr.prototype.putOctreeToDeletePCloud=function(e,t){if(void 0===t&&(t=0),void 0!==e){var r=e.octreeKey;this.octreeToDeletePCloudsMap[r]=e}},dr.prototype.existOctreeToDeletePCloud=function(e){if(void 0===e)return!1;var t=e.octreeKey;return!!this.octreeToDeletePCloudsMap.hasOwnProperty(t)},dr.prototype.eraseOctreeToDeletePCloud=function(e){if(void 0===e)return!1;var t=e.octreeKey;return!!this.octreeToDeletePCloudsMap.hasOwnProperty(t)&&(delete this.octreeToDeletePCloudsMap[t],!0)},dr.prototype.putNodeToDeleteLodMesh=function(e,t){if(!e.isReferenceNode()&&(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding)){var r=e.data.neoBuilding.buildingId;this.nodesToDeleteLodMeshMap[r]=e}},dr.prototype.eraseNodeToDeleteLodMesh=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteLodMeshMap.hasOwnProperty(t)&&(delete this.nodesToDeleteLodMeshMap[t],!0)}},dr.prototype.putTinTerrainToDelete=function(e,t){if(void 0===t&&(t=0),void 0!==e){var r=e.pathName;this.tinTerrainsToDeleteMap[r]=e}},dr.prototype.eraseTinTerrainToDelete=function(e){if(void 0===e)return!1;var t=e.pathName;return!!this.tinTerrainsToDeleteMap.hasOwnProperty(t)&&(delete this.tinTerrainsToDeleteMap[t],!0)},dr.prototype.putNodeToDeleteLessThanLod3=function(e,t){if(!e.isReferenceNode()&&(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding)){var r=e.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod3Map[r]=e}},dr.prototype.eraseNodeToDeleteLessThanLod3=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod3Map.hasOwnProperty(t)&&(delete this.nodesToDeleteLessThanLod3Map[t],!0)}},dr.prototype.putNodeToDeleteLessThanLod4=function(e,t){if(!e.isReferenceNode()&&(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding)){var r=e.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod4Map[r]=e}},dr.prototype.eraseNodeToDeleteLessThanLod4=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod4Map.hasOwnProperty(t)&&(delete this.nodesToDeleteLessThanLod4Map[t],!0)}},dr.prototype.putNodeToDeleteLessThanLod5=function(e,t){if(!e.isReferenceNode()&&(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding)){var r=e.data.neoBuilding.buildingId;this.nodesToDeleteLessThanLod5Map[r]=e}},dr.prototype.eraseNodeToDeleteLessThanLod5=function(e){if(void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteLessThanLod5Map.hasOwnProperty(t)&&(delete this.nodesToDeleteLessThanLod5Map[t],!0)}},dr.prototype.putNodeToDeleteModelReferences=function(e,t){if(!e.isReferenceNode()&&(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding)){var r=e.data.neoBuilding.buildingId;this.nodesToDeleteModelReferencesMap[r]=e}},dr.prototype.eraseNodeToDeleteModelReferences=function(e){if(e&&void 0!==e.data&&void 0!==e.data.neoBuilding){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteModelReferencesMap.hasOwnProperty(t)&&(delete this.nodesToDeleteModelReferencesMap[t],!0)}},dr.prototype.putNodeToDelete=function(e,t){if(!e.isReferenceNode()&&(void 0===t&&(t=0),void 0!==e.data&&void 0!==e.data.neoBuilding)){var r=e.data.neoBuilding.buildingId;this.nodesToDeleteMap[r]=e}},dr.prototype.putNodesArrayToDelete=function(e,t){if(void 0!==e){void 0===t&&(t=0);for(var r=e.length,i=0;i<r;i++)this.putNodeToDelete(e[i],t)}},dr.prototype.eraseNodeToDelete=function(e){var t=e.data.neoBuilding.buildingId;return!!this.nodesToDeleteMap.hasOwnProperty(t)&&(delete this.nodesToDeleteMap[t],!0)},dr.prototype.eraseNodesArrayToDelete=function(e){for(var t,r=e.length,i=0;i<r;i++)t=e[i].data.neoBuilding.buildingId,delete this.nodesToDeleteMap[t]},dr.prototype.clearAll=function(){this.nodesToDeleteMap={},this.nodesToDeleteModelReferencesMap={}},dr.prototype.deleteNeoBuilding=function(e,t,r){var i=r.vboMemoryManager;r.selectionManager.getSelectedF4dBuildingArray().indexOf(t)>-1&&r.selectionManager.clearCurrents(),t.deleteObjects(e,i)},dr.prototype._slowDeleteNatives=function(e){if(this.nativeSlowDeleteArray.length>0)for(var t=e.vboMemoryManager,r=0;r<1;r++){this.nativeSlowDeleteArray.pop().deleteObjects(t)}},dr.prototype.deleteSmartTiles=function(e){var t,r,i=0,o=e.sceneState.gl;e.vboMemoryManager;for(var n in this.smartTilesToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.smartTilesToDeleteMap,n)){var a=this.smartTilesToDeleteMap[n];if(void 0===a)continue;if(this.eraseSmartTileToDelete(a)){if(void 0!==a.nodesArray)for(var s=a.nodesArray.length,l=0;l<s;l++)(t=a.nodesArray[l]).data&&void 0!==(r=t.data.neoBuilding)&&(this.deleteNeoBuilding(o,r,e),t.data.neoBuilding=void 0);else a.nodesArray=[];if(a.nodesArray.length=0,void 0!==a.smartTileF4dSeedArray){var u=a.smartTileF4dSeedArray.length;for(l=0;l<u;l++)a.smartTileF4dSeedArray[l].fileLoadState=I.fileLoadState.READY}var c=a.nativeObjects.generalObjectsArray,d=a.nativeObjects.nativeSeedArray,h=c.length,f=[];for(l=0;l<h;l++){var g=c[l];g.attributes.isDeletableByFrustumCulling?this.nativeSlowDeleteArray.push(g):f.push(g)}if(a.nativeObjects.generalObjectsArray=f,d[0]&&(d[0].status=Ee.STATUS.UNLOAD),++i>=1)break}}},dr.prototype.manageDeleteQueue=function(e){var t,r,i=e.sceneState.gl,o=8,n=Object.keys(this.nodesToDeleteMap).length;n<o&&(o=n);var a=0;for(var s in this.deleteSmartTiles(e),this._slowDeleteNatives(e),this.nodesToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteMap,s)){if(void 0===(r=this.nodesToDeleteMap[s]))continue;if(t=r.data.neoBuilding,this.eraseNodeToDelete(r)){if(void 0===t)continue;if(this.deleteNeoBuilding(i,t,e),++a>=10)break}}var l=0;for(var s in this.nodesToDeleteModelReferencesMap)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteModelReferencesMap,s)){if(void 0===(r=this.nodesToDeleteModelReferencesMap[s]).data)continue;if(t=r.data.neoBuilding,this.eraseNodeToDeleteModelReferences(r),void 0===t)continue;if(t.octree&&(t.octree.deleteObjectsModelReferences(i,e.vboMemoryManager),t.octree.deletePCloudObjects(i,e.vboMemoryManager)),(t.motherBlocksArray.length>0||t.motherNeoReferencesArray.length>0)&&l++,t.deleteObjectsModelReferences(i,e.vboMemoryManager),l>10)break}a=0;for(var s in this.nodesToDeleteLessThanLod3Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod3Map,s)){if(void 0===(r=this.nodesToDeleteLessThanLod3Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod3(r)){if(void 0===(t=r.data.neoBuilding))continue;if(t.octree&&(t.octree.deleteObjectsModelReferences(i,e.vboMemoryManager),t.octree.deletePCloudObjects(i,e.vboMemoryManager)),(t.motherBlocksArray.length>0||t.motherNeoReferencesArray.length>0)&&l++,t.deleteObjectsModelReferences(i,e.vboMemoryManager),t.deleteObjectsLod2(i,e.vboMemoryManager),++a>10)break}}for(var s in a=0,this.nodesToDeleteLessThanLod4Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod4Map,s)){if(void 0===(r=this.nodesToDeleteLessThanLod4Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod4(r)){if(void 0===(t=r.data.neoBuilding))continue;if(t.deleteObjectsModelReferences(i,e.vboMemoryManager),t.deleteObjectsLod2(i,e.vboMemoryManager),t.deleteObjectsLodMesh(i,e.vboMemoryManager,"lod3"),++a>10)break}}for(var s in a=0,this.nodesToDeleteLessThanLod5Map)if(Object.prototype.hasOwnProperty.call(this.nodesToDeleteLessThanLod5Map,s)){if(void 0===(r=this.nodesToDeleteLessThanLod5Map[s]).data)continue;if(this.eraseNodeToDeleteLessThanLod5(r)){if(void 0===(t=r.data.neoBuilding))continue;if(t.deleteObjectsModelReferences(i,e.vboMemoryManager),t.deleteObjectsLod2(i,e.vboMemoryManager),t.deleteObjectsLodMesh(i,e.vboMemoryManager,"lod3"),t.deleteObjectsLodMesh(i,e.vboMemoryManager,"lod4"),++a>10)break}}a=0;for(var s in this.tinTerrainsToDeleteMap)if(Object.prototype.hasOwnProperty.call(this.tinTerrainsToDeleteMap,s)){var u=this.tinTerrainsToDeleteMap[s];if(void 0===u)continue;if(this.eraseTinTerrainToDelete(u)&&(delete u.owner.childMap[u.indexName],u.deleteObjects(e),u=void 0,a++),a>20)break}a=0;for(var s in this.octreeToDeletePCloudsMap)if(Object.prototype.hasOwnProperty.call(this.octreeToDeletePCloudsMap,s)){var c=this.octreeToDeletePCloudsMap[s];if(void 0===c)continue;if(this.eraseOctreeToDeletePCloud(c)&&(c.deletePCloudObjects(i,e.vboMemoryManager),c=void 0,a++),a>1e4)break}};var hr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var r=t;void 0!==r&&(this.geometryDataPath=r.geo_data_path),this.geometryDataPath||(this.geometryDataPath="/f4d"),this.geometrySubDataPath,this.j_counter,this.k_counter,this.referencesList_requested=0,this.blocksList_requested=0,this.blocksListPartitioned_requested=0,this.octreesSkinLegos_requested=0,this.skinLegos_requested=0,this.pCloudPartitionsMother_requested=0,this.pCloudPartitions_requested=0,this.smartTileF4d_requested=0,this.gl,this.incre_latAng=.001,this.incre_longAng=.001,this.GAIA3D__offset_latitude=-.001,this.GAIA3D__offset_longitude=-.001,this.GAIA3D__counter=0,this.uint32,this.uint16,this.int16,this.float32,this.float16,this.int8,this.int8_value,this.max_color_value=126,this.startBuff,this.endBuff,this.filesReadings_count=0,this.temp_var_to_waste,this.countSC,this.xSC,this.ySC,this.zSC,this.point3dSC=new Jr,this.bboxSC=new G};hr.prototype.getCurrentDataPath=function(){return void 0!==this.geometrySubDataPath&&""!==this.geometrySubDataPath?this.geometryDataPath+"/"+this.geometrySubDataPath:this.geometryDataPath},hr.prototype.readUInt32=function(e,t,r){return new Uint32Array(e.slice(t,r))[0]},hr.readUInt32=function(e,t,r){return new Uint32Array(e.slice(t,r))[0]},hr.prototype.readInt32=function(e,t,r){return new Int32Array(e.slice(t,r))[0]},hr.readInt32=function(e,t,r){return new Int32Array(e.slice(t,r))[0]},hr.prototype.readUInt16=function(e,t,r){return new Uint16Array(e.slice(t,r))[0]},hr.readUInt16=function(e,t,r){return new Uint16Array(e.slice(t,r))[0]},hr.prototype.readInt16=function(e,t,r){return new Int16Array(e.slice(t,r))[0]},hr.readInt16=function(e,t,r){return new Int16Array(e.slice(t,r))[0]},hr.prototype.readFloat64=function(e,t,r){return new Float64Array(e.slice(t,r))[0]},hr.readFloat64=function(e,t,r){return new Float64Array(e.slice(t,r))[0]},hr.prototype.readFloat32=function(e,t,r){return new Float32Array(e.slice(t,r))[0]},hr.readFloat32=function(e,t,r){return new Float32Array(e.slice(t,r))[0]},hr.prototype.readFloat16=function(e,t,r){return new Float32Array(e.slice(t,r))[0]},hr.prototype.readInt8=function(e,t,r){return new Int8Array(e.slice(t,r))[0]},hr.readInt8=function(e,t,r){return new Int8Array(e.slice(t,r))[0]},hr.prototype.readUInt8=function(e,t,r){return new Uint8Array(e.slice(t,r))[0]},hr.readUInt8=function(e,t,r){return new Uint8Array(e.slice(t,r))[0]},hr.prototype.readInt8ByteColor=function(e,t,r){var i=new Int8Array(e.slice(t,r))[0];return i>max_color_value&&(i=max_color_value),i<0&&(i+=256),i},hr.prototype.getNeoBlocksArraybuffer=function(e,t,r,i){r.fileRequestControler.modelRefFilesRequestedCount+=1;var o=t.neoReferencesMotherAndIndices.blocksList;o.fileLoadState=I.fileLoadState.LOADING_STARTED,o.xhr=void 0;var n=!1;void 0!==i&&void 0!==i.parseImmediately&&(n=i.parseImmediately),this.blocksList_requested++,rn(e,void 0).then(function(e){var i=e;i?(o.dataArraybuffer=i,o.fileLoadState=I.fileLoadState.LOADING_FINISHED,i=null,n?cr.parseArrayOctreesLod0Models(t,r):r.parseQueue.putOctreeLod0ModelsToParse(t)):o.fileLoadState=500},function(e){console.log("Invalid XMLHttpRequest status = "+e),o.fileLoadState=0===e?500:-1===e?I.fileLoadState.READY:e}).finally(function(){r.readerWriter.blocksList_requested--,r.fileRequestControler.modelRefFilesRequestedCount-=1,r.fileRequestControler.modelRefFilesRequestedCount<0&&(r.fileRequestControler.modelRefFilesRequestedCount=0)})},hr.prototype.getNeoBlocksArraybuffer_partition=function(e,t,r,i){i.fileRequestControler.modelRefFilesRequestedCount+=1,r.fileLoadState=I.fileLoadState.LOADING_STARTED,this.blocksListPartitioned_requested++,rn(e,void 0).then(function(e){var o=e;o?(r.dataArraybuffer=o,r.fileLoadState=I.fileLoadState.LOADING_FINISHED,o=null,i.parseQueue.putOctreeLod0ModelsToParse(t)):r.fileLoadState=500},function(e){console.log("Invalid XMLHttpRequest status = "+e),r.fileLoadState=0===e?500:-1===e?I.fileLoadState.READY:e}).finally(function(){i.readerWriter.blocksListPartitioned_requested--,i.fileRequestControler.blocksListPartitioned_requested<0&&(i.fileRequestControler.blocksListPartitioned_requested=0)})},hr.prototype.getNeoReferencesArraybuffer=function(e,t,r,i){if(void 0!==t.neoReferencesMotherAndIndices){r.fileRequestControler.modelRefFilesRequestedCount+=1,t.neoReferencesMotherAndIndices.fileLoadState=I.fileLoadState.LOADING_STARTED,t.neoReferencesMotherAndIndices.xhr=void 0;var o=!1;void 0!==i&&void 0!==i.parseImmediately&&(o=i.parseImmediately),this.referencesList_requested++,rn(e,void 0).then(function(e){var i=e;if(i){var n=t.neoReferencesMotherAndIndices;n&&(n.dataArraybuffer=i,n.fileLoadState=I.fileLoadState.LOADING_FINISHED,o?cr.parseOctreesLod0References(t,r):r.parseQueue.putOctreeLod0ReferencesToParse(t)),i=null}else t.neoReferencesMotherAndIndices.fileLoadState=I.fileLoadState.LOAD_FAILED},function(e){console.log("xhr status = "+e),t.neoReferencesMotherAndIndices.fileLoadState=0===e?I.fileLoadState.LOAD_FAILED:-1===e?I.fileLoadState.READY:e}).finally(function(){r.readerWriter.referencesList_requested--,r.fileRequestControler.modelRefFilesRequestedCount-=1,r.fileRequestControler.modelRefFilesRequestedCount<0&&(r.fileRequestControler.modelRefFilesRequestedCount=0)})}},hr.prototype.getOctreeLegoArraybuffer=function(e,t,r){if(void 0!==t.lego){this.octreesSkinLegos_requested++,r.fileRequestControler.filesRequestedCount+=1,t.lego.fileLoadState=I.fileLoadState.LOADING_STARTED;var i=new XMLHttpRequest;t.lego.xhr=i,rn(e,i).then(function(e){var i=e;i?(t.lego?(t.lego.dataArrayBuffer=i,t.lego.fileLoadState=I.fileLoadState.LOADING_FINISHED,r.parseQueue.putOctreeLod2LegosToParse(t)):t=void 0,i=null):t.lego.fileLoadState=500},function(e){console.log("xhr status = "+e),t.lego.fileLoadState=0===e?500:e}).finally(function(){r.readerWriter.octreesSkinLegos_requested--,r.fileRequestControler.filesRequestedCount-=1,r.fileRequestControler.filesRequestedCount<0&&(r.fileRequestControler.filesRequestedCount=0)})}},hr.prototype.getOctreePCloudArraybuffer=function(e,t,r){void 0!==t.lego&&(r.fileRequestControler.filesRequestedCount+=1,t.lego.fileLoadState=I.fileLoadState.LOADING_STARTED,rn(e).then(function(e){var i=e;i?(t.lego?(t.lego.dataArrayBuffer=i,t.lego.fileLoadState=I.fileLoadState.LOADING_FINISHED,r.parseQueue.putOctreePCloudToParse(t)):t=void 0,i=null):t.lego.fileLoadState=500},function(e){console.log("xhr status = "+e),t.lego.fileLoadState=0===e?500:e}).finally(function(){r.fileRequestControler.filesRequestedCount-=1,r.fileRequestControler.filesRequestedCount<0&&(r.fileRequestControler.filesRequestedCount=0)}))},hr.prototype.getOctreePCloudPartitionArraybuffer=function(e,t,r,i){r.fileLoadState=I.fileLoadState.LOADING_STARTED;var o=t.octree_level;0===o?i.readerWriter.pCloudPartitionsMother_requested++:i.readerWriter.pCloudPartitions_requested++,rn(e).then(function(e){var i=e;i?(t&&r&&(r.dataArrayBuffer=i,r.fileLoadState=I.fileLoadState.LOADING_FINISHED),i=null):r.fileLoadState=500},function(e){console.log("xhr status = "+e),r.fileLoadState=0===e?500:e}).finally(function(){0===o?(i.readerWriter.pCloudPartitionsMother_requested--,i.readerWriter.pCloudPartitionsMother_requested<0&&(i.readerWriter.pCloudPartitionsMother_requested=0)):(i.readerWriter.pCloudPartitions_requested--,i.readerWriter.pCloudPartitions_requested<0&&(i.readerWriter.pCloudPartitions_requested=0))})},hr.prototype.getLegoArraybuffer=function(e,t,r){this.skinLegos_requested++,r.fileRequestControler.lowLodDataRequestedCount+=1,t.fileLoadState=I.fileLoadState.LOADING_STARTED,t.xhr=void 0,rn(e,void 0).then(function(e){var i=e;i?(t&&(t.dataArrayBuffer=i,t.fileLoadState=I.fileLoadState.LOADING_FINISHED,r.parseQueue.putSkinLegosToParse(t)),i=null):t.fileLoadState=500},function(e){console.log("xhr status = "+e),t.fileLoadState=0===e?500:-1}).finally(function(){r.readerWriter.skinLegos_requested--,r.fileRequestControler.lowLodDataRequestedCount-=1,r.fileRequestControler.lowLodDataRequestedCount<0&&(r.fileRequestControler.lowLodDataRequestedCount=0)})},hr.prototype.getObjectIndexFileSmartTileF4d=function(e,t,r){rn(e).then(function(e){var i=e;i&&(void 0===r.smartTileManager&&(r.smartTileManager=new Ze),r.smartTileManager.parseSmartTilesF4dIndexFile(i,t,r),i=void 0)},function(e){console.log("xhr status = "+e)}).finally(function(){})},hr.prototype.getObjectIndexFileSmartTileF4dAndDeleteTile=function(e,t,r){rn(e).then(function(e){var i=e;i&&(void 0===r.smartTileManager&&(r.smartTileManager=new Ze),r.smartTileManager.parseSmartTilesF4dIndexFileAndDeleteSmartTileF4dSeed(i,t,r),i=void 0)},function(e){console.log("xhr status = "+e)}).finally(function(){})},hr.prototype.getSmartTileF4d=function(e,t,r,i){this.smartTileF4d_requested++,t.fileLoadState=I.fileLoadState.LOADING_STARTED,rn(e).then(function(e){var r=e;r?(t.fileLoadState=I.fileLoadState.LOADING_FINISHED,t.dataArrayBuffer=r,r=void 0):t.fileLoadState=I.fileLoadState.LOAD_FAILED,i.readerWriter.smartTileF4d_requested--,i.readerWriter.smartTileF4d_requested<0&&(i.readerWriter.smartTileF4d_requested=0)},function(e){console.log("xhr status = "+e)}).finally(function(){})},hr.prototype.getMultiBuildingsDataArrayBuffer=function(e,t,r){this.skinLegos_requested++,r.fileRequestControler.multiBuildingsDataRequestedCount+=1,t.fileLoadState=I.fileLoadState.LOADING_STARTED,rn(e,void 0).then(function(e){var i=e;i?(t&&(t.dataArrayBuffer=i,t.fileLoadState=I.fileLoadState.LOADING_FINISHED,r.parseQueue.putMultiBuildingsToParse(t,0)),i=null):t.fileLoadState=500},function(e){console.log("xhr status = "+e),t.fileLoadState=0===e?500:-1}).finally(function(){r.fileRequestControler.multiBuildingsDataRequestedCount-=1,r.fileRequestControler.multiBuildingsDataRequestedCount<0&&(r.fileRequestControler.multiBuildingsDataRequestedCount=0)})},hr.prototype.getObjectIndexFileForSmartTile=function(e,t,r,i){rn(e).then(function(e){var r=e;if(r){var o=new W;o.dataArrayBuffer=r,o.parseBuildingSeedArrayBuffer(),t.makeSmartTile(o,i),r=null}},function(e){console.log("xhr status = "+e)}).finally(function(){})},hr.prototype.getObjectIndexFileForData=function(e,t,r,i,o){rn(e).then(function(e){var n=e;if(n){var a=new j;a.dataArrayBuffer=n,a.parseBuildingSeedArrayBuffer();for(var s={},l=a.buildingSeedArray.length,u=0;u<l;u++){var c=a.buildingSeedArray[u],d=c.buildingId;i.indexOf(d)>=0&&(s[d]=c)}if(Object.keys(s).length!==i.length)throw new Error("ObjectIndexFile is not ready. Please make objectIndexFile and try add data.");t.makeSmartTile(s,r,o,s),n=null}},function(e){console.log("xhr status = "+e)}).finally(function(){})},hr.prototype.getObjectIndexFile=function(e,t,r,i){rn(e).then(function(e){var o=e;o&&(t.parseObjectIndexFile(o,r),o=null,i.createDeploymentGeoLocationsForHeavyIndustries())},function(e){console.log("xhr status = "+e)}).finally(function(){})},hr.prototype.parseObjectIndexFile=function(e,t){var r,i,o,n,a=0,s=this.readInt32(e,a,a+4);a+=4;for(var l=0;l<s;l++){var u=t.newNeoBuilding();void 0===u.metaData&&(u.metaData=new Jt),void 0===u.metaData.geographicCoord&&(u.metaData.geographicCoord=new pe),void 0===u.metaData.bbox&&(u.metaData.bbox=new G),r=this.readInt32(e,a,a+4),a+=4;var c=String.fromCharCode.apply(null,new Int8Array(e.slice(a,a+r)));a+=r,i=this.readFloat64(e,a,a+8),a+=8,o=this.readFloat64(e,a,a+8),a+=8,n=this.readFloat32(e,a,a+4),a+=4,u.bbox=new G,u.bbox.minX=this.readFloat32(e,a,a+4),a+=4,u.bbox.minY=this.readFloat32(e,a,a+4),a+=4,u.bbox.minZ=this.readFloat32(e,a,a+4),a+=4,u.bbox.maxX=this.readFloat32(e,a,a+4),a+=4,u.bbox.maxY=this.readFloat32(e,a,a+4),a+=4,u.bbox.maxZ=this.readFloat32(e,a,a+4),a+=4,u.buildingId=c.substr(4,r-4),u.buildingType="basicBuilding",u.buildingFileName=c,u.metaData.geographicCoord.setLonLatAlt(i,o,n)}t.neoBuildingsArray.reverse()},hr.prototype.getNeoHeaderAsimetricVersion=function(e,t,r,i,o){o.fileRequestControler.headerFilesRequestedCount+=1,r.metaData.fileLoadState=I.fileLoadState.LOADING_STARTED,rn(t).then(function(e){var t=e;if(t){r.metaData.fileLoadState=I.fileLoadState.LOADING_FINISHED,r.headerDataArrayBuffer=t,t=void 0}else r.metaData.fileLoadState=500,t=void 0},function(e){console.log("xhr status = "+e),r.metaData.fileLoadState=0===e?500:e}).finally(function(){o.fileRequestControler.headerFilesRequestedCount-=1,o.fileRequestControler.headerFilesRequestedCount<0&&(o.fileRequestControler.headerFilesRequestedCount=0)})},hr.prototype.readTexture=function(e,t,r,i){r.loadStarted=!0,r.texImage=new Image,r.texImage.onload=function(){r.loadFinished=!0,i.backGround_fileReadings_count>0&&(i.backGround_fileReadings_count-=1)},r.texImage.onerror=function(){r.loadStarted=!1,i.backGround_fileReadings_count>0&&(i.backGround_fileReadings_count-=1)},r.texImage.crossOrigin="Anonymous",r.texImage.src=t},hr.prototype.decodeTGA=function(e){var t,r,i,o,n,a=new Uint8Array(e),s=18+a[0],l=a[2],u=a[12]+(a[13]<<8),c=a[14]+(a[15]<<8),d=a[16],h=d/8,f=4*u;if(!u||!c)return console.error("Invalid dimensions"),null;if(2!==l)return console.error("Unsupported TGA format:",l),null;for(t=new Uint8Array(u*c*4),r=s,n=c-1;n>=0;--n)for(o=0;o<u;++o,r+=h)t[i=4*o+n*f]=a[r+2],t[i+1]=a[r+1],t[i+2]=a[r+0],t[i+3]=32===d?a[r+3]:255;return{width:u,height:c,data:t}},hr.prototype.readNeoReferenceTexture=function(e,t,r,i,o){var n=t.split(".").pop();if("tga"===n||"TGA"===n||"Tga"===n)r.fileLoadState=I.fileLoadState.LOADING_STARTED,rn(t).then(function(t){var i=t;if(i){var o=new TGA;if(o.load(i),r.texId=e.createTexture(),o){var n;if(3===o.header.bytePerPixel)n=e.RGB;else if(4===o.header.bytePerPixel){n=e.RGBA;for(var a,s,l,u,c=o.imageData.length/4,d=0;d<c;d++)a=o.imageData[4*d],s=o.imageData[4*d+1],l=o.imageData[4*d+2],u=o.imageData[4*d+3],o.imageData[4*d]=l,o.imageData[4*d+1]=s,o.imageData[4*d+2]=a,o.imageData[4*d+3]=u}void 0!==o.imageData&&o.imageData.length>0&&void 0!==r.texId&&(e.bindTexture(e.TEXTURE_2D,r.texId),e.texImage2D(e.TEXTURE_2D,0,n,o.header.width,o.header.height,0,n,e.UNSIGNED_BYTE,o.imageData),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.generateMipmap(e.TEXTURE_2D),r.fileLoadState=I.fileLoadState.LOADING_FINISHED,e.bindTexture(e.TEXTURE_2D,null))}}},function(e){i&&(console.log("xhr status = "+e),i.metaData.fileLoadState=0===e?500:e)}).finally(function(){o.backGround_fileReadings_count-=1,o.backGround_fileReadings_count<0&&(o.backGround_fileReadings_count=0)});else{var a=new Image;r.fileLoadState=I.fileLoadState.LOADING_STARTED,a.onload=function(){void 0===r.texId&&(r.texId=e.createTexture()),ut(e,a,r.texId),r.fileLoadState=I.fileLoadState.LOADING_FINISHED,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1)},a.onerror=function(){},a.crossOrigin="Anonymous",a.src=t}},hr.loadBinaryData=function(e,t,r){t.fileLoadState=I.fileLoadState.LOADING_STARTED,rn(e).then(function(e){var i=e;i?(t.dataArraybuffer=i,t.fileLoadState=I.fileLoadState.LOADING_FINISHED,i=null,r.parseData(t)):t.fileLoadState=500},function(e){console.log("Invalid XMLHttpRequest status = "+e),t.fileLoadState=0===e?500:e}).finally(function(){})},hr.loadImage=function(e,t,r){var i=new Image;r.fileLoadState=I.fileLoadState.LOADING_STARTED,i.onload=function(){var t,o,n,a,s,l;void 0!==r.texId&&(r.imageWidth=i.width,r.imageHeight=i.height,r.texId=(t=e,o=e.NEAREST,n=i,l=t.createTexture(),t.bindTexture(t.TEXTURE_2D,l),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,o),n instanceof Uint8Array?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,a,s,0,t.RGBA,t.UNSIGNED_BYTE,n):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),t.bindTexture(t.TEXTURE_2D,null),l),r.fileLoadState=I.fileLoadState.BINDING_FINISHED)},i.onerror=function(){},i.crossOrigin="Anonymous",i.src=t},hr.prototype.readLegoSimpleBuildingTexture=function(e,t,r,i,o){var n=new Image;r.fileLoadState=I.fileLoadState.LOADING_STARTED,i.fileRequestControler.lowLodImagesRequestedCount+=1,n.onload=function(){void 0===r.texId&&(r.texId=e.createTexture()),void 0===o&&(o=!0),ut(e,n,r.texId,o),r.fileLoadState=I.fileLoadState.LOADING_FINISHED,i.fileRequestControler.lowLodImagesRequestedCount-=1,i.backGround_fileReadings_count>0&&(i.backGround_fileReadings_count-=1),i.fileRequestControler.lowLodImagesRequestedCount<0&&(i.fileRequestControler.lowLodImagesRequestedCount=0)},n.onerror=function(){void 0===r.texId&&(r.texId=e.createTexture(),e.bindTexture(e.TEXTURE_2D,r.texId),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,new Uint8Array([200,200,200,255])),e.bindTexture(e.TEXTURE_2D,null)),r.fileLoadState=I.fileLoadState.READY,i.fileRequestControler.lowLodImagesRequestedCount-=1,i.fileRequestControler.lowLodImagesRequestedCount<0&&(i.fileRequestControler.lowLodImagesRequestedCount=0)},n.crossOrigin="Anonymous",n.src=t},hr.prototype.getTileArrayBuffer=function(e,t,r,i,o){r.fileReading_started=!0,rn(t).then(function(e){var t=e;t&&(r.fileArrayBuffer=t,r.fileReading_finished=!0,o.backGround_fileReadings_count>0&&(o.backGround_fileReadings_count-=1),t=null)},function(e){console.log("xhr status = "+e)}).finally(function(){})},hr.prototype.loadTINTerrain=function(e,t,r){t.fileLoadState=I.fileLoadState.LOADING_STARTED,r.fileRequestControler.tinTerrainFilesRequested+=1,rn(e).then(function(e){var r=e;r?(t.dataArrayBuffer=r,t.fileLoadState=I.fileLoadState.LOADING_FINISHED,r=void 0):t.fileLoadState=500},function(e){t.fileLoadState=I.fileLoadState.LOAD_FAILED}).finally(function(){r.fileRequestControler.tinTerrainFilesRequested-=1,r.fileRequestControler.tinTerrainFilesRequested<0&&(r.fileRequestControler.tinTerrainFilesRequested=0)})},hr.prototype.imageFromArrayBuffer=function(e,t,r,i,o){var n=new Blob([t],{type:"image/png"}),a=(window.URL||window.webkitURL).createObjectURL(n),s=new Image;s.onload=function(){void 0===o&&(o=!1),void 0===r.texId&&(r.texId=e.createTexture()),ut(e,s,r.texId,o),r.fileLoadState=I.fileLoadState.LOADING_FINISHED,t=null},s.onerror=function(){},s.crossOrigin="Anonymous",s.src=a},hr.prototype.loadWMSImage=function(e,t,r,i,o){r.fileLoadState=I.fileLoadState.LOADING_STARTED;i.fileRequestControler.tinTerrainTexturesRequested+=1,rn(t).then(function(t){var i=t;if(i){void 0===o&&(o=!1);var n=new Blob([i],{type:"image/png"}),a=(window.URL||window.webkitURL).createObjectURL(n),s=new Image;s.onload=function(){void 0===r.texId&&(r.texId=e.createTexture()),e.bindTexture(e.TEXTURE_2D,r.texId),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,o),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),r.fileLoadState=I.fileLoadState.LOADING_FINISHED,i=null},s.onerror=function(){},s.crossOrigin="Anonymous",s.src=a}},function(e){console.log(e),r.texId="failed",r.fileLoadState=I.fileLoadState.LOADING_FINISHED}).finally(function(){i.backGround_fileReadings_count-=1,i.backGround_fileReadings_count<0&&(i.backGround_fileReadings_count=0),i.fileRequestControler.tinTerrainTexturesRequested-=1,i.fileRequestControler.tinTerrainTexturesRequested<0&&(i.fileRequestControler.tinTerrainTexturesRequested=0)})};var fr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.owner,this.depth,t?(this.owner=t,this.depth=t.depth+1):this.depth=0,this.childArray,this.childMap,this.X,this.Y,this.centerX,this.centerY,this.centerZ,this.cartesiansArray,this.normalsArray,this.texCoordsArray,this.colorsArray,this.indices,this.skirtCartesiansArray,this.skirtTexCoordsArray,this.geographicExtent,this.sphereExtent,this.webMercatorExtent,this.fileLoadState=0,this.dataArrayBuffer,this.vboKeyContainer,this.terrainPositionHIGH,this.terrainPositionLOW,this.indexName,this.pathName,this.texture={},this.textureMaster,this.textureMasterImageryLayers,this.textureElevation={},this.visible,this.tinTerrainManager,this.isAdult=!1,this.birthTime,this.renderingFase=0,this.isLeaf=!1};fr.prototype.deleteObjects=function(e){var t=e.sceneState.gl;if(void 0!==this.childMap){var r=this.childMap.LU;void 0!==r&&(r.deleteObjects(e),delete this.childMap.LU);var i=this.childMap.LD;void 0!==i&&(i.deleteObjects(e),delete this.childMap.LD);var o=this.childMap.RU;void 0!==o&&(o.deleteObjects(e),delete this.childMap.RU);var n=this.childMap.RD;void 0!==n&&(n.deleteObjects(e),delete this.childMap.RD),this.childMap=void 0}if(!(this.depth<=this.tinTerrainManager.maxTextureGuranteedDepth)){if(this.owner=void 0,this.depth=void 0,this.childArray=void 0,this.childMap=void 0,this.X=void 0,this.Y=void 0,void 0!==this.geographicExtent&&(this.geographicExtent.deleteObjects(),this.geographicExtent=void 0),void 0!==this.sphereExtent&&(this.sphereExtent.deleteObjects(),this.sphereExtent=void 0),this.fileLoadState=0,this.dataArrayBuffer=void 0,void 0!==this.vboKeyContainer&&(this.vboKeyContainer.deleteGlObjects(t,e.vboMemoryManager),this.vboKeyContainer=void 0),this.terrainPositionHIGH=void 0,this.terrainPositionLOW=void 0,this.indexName=void 0,this.pathName=void 0,void 0!==this.texture){for(var a=Object.keys(this.texture),s=0,l=a.length;s<l;s++){var u=this.texture[a[s]];u.deleteObjects(t),delete this.texture[a[s]],u=void 0}this.texture={}}this.visible=void 0,delete this.altArray,delete this.boundingSphereCenterX,delete this.boundingSphereCenterY,delete this.boundingSphereCenterZ,delete this.boundingSphereRadius,delete this.cartesiansArray,delete this.cartesiansArraySea,delete this.centerX,delete this.centerY,delete this.centerZ,delete this.eastIndices,delete this.eastVertexCount,delete this.westIndices,delete this.westVertexCount,delete this.extensionId,delete this.extensionLength,delete this.hValues,delete this.uValues,delete this.vValues,delete this.horizonOcclusionPointX,delete this.horizonOcclusionPointY,delete this.horizonOcclusionPointZ,delete this.indices,delete this.latArray,delete this.lonArray,delete this.maxHeight,delete this.minHeight,delete this.normalsArray,delete this.normalsArraySea,delete this.northIndices,delete this.northVertexCount,delete this.skirtAltitudesArray,delete this.skirtCartesiansArray,delete this.skirtCartesiansArraySea,delete this.skirtTexCoordsArray,delete this.skirtTexCoordsArraySea,delete this.southIndices,delete this.southVertexCount,delete this.texCoordsArray,delete this.texture,delete this.textureElevation,this.textureMaster&&t.deleteTexture(this.textureMaster),delete this.textureMaster,delete this.vertexCount,this.textureAux&&t.deleteTexture(this.textureAux),delete this.textureAux}},fr.prototype.getPathName=function(){return this.depth.toString()+"/"+this.X.toString()+"/"+this.Y.toString()},fr.prototype.getPathInfo=function(){return{z:this.depth.toString(),x:this.X.toString(),y:this.Y.toString()}},fr.prototype.checkAvailableTerrain=function(){for(var e=this.getPathInfo(),t=this.tinTerrainManager.terrainTilesInfo.available,r=!0,i=e.z,o=e.x,n=e.y,a=0,s=t.length;a<s;a++){var l=t[a];if(!l.hasOwnProperty(i)){r=!1;break}for(var u=l[i],c=0,d=u.length;c<d;c++){var h=u[c],f=h.startX,g=h.startY,p=h.endX,m=h.endY;if(o<f||o>p||n<g||n>m){r=!1;break}}}return r},fr.prototype.getBlendAlpha=function(e){if(this.isAdult)return 1;void 0===this.birthTime&&(this.birthTime=e),void 0===this.blendAlpha&&(this.blendAlpha=.1);var t=1e-4*(e-this.birthTime);return this.blendAlpha+=t,this.blendAlpha>=1&&(this.blendAlpha=1,this.isAdult=!0),this.blendAlpha},fr.prototype.setWebMercatorExtent=function(e,t,r,i){void 0===this.webMercatorExtent&&(this.webMercatorExtent=new hi),this.webMercatorExtent.setExtension(e,t,r,i)},fr.prototype.setGeographicExtent=function(e,t,r,i,o,n){void 0===this.geographicExtent&&(this.geographicExtent=new xe);var a=this.geographicExtent;void 0===a.minGeographicCoord&&(a.minGeographicCoord=new pe),void 0===a.maxGeographicCoord&&(a.maxGeographicCoord=new pe),a.minGeographicCoord.setLonLatAlt(e,t,r),a.maxGeographicCoord.setLonLatAlt(i,o,n)},fr.prototype.isRenderingPhase=function(e){return this.renderingFase===e},fr.prototype.getChildrenMapKeys=function(){return void 0!==this.childMap&&Object.keys(this.childMap)},fr.prototype.isChildrenRenderingPhase=function(e){if(void 0===this.childMap)return!1;if(this.getChildrenMapKeys().length<4)return!1;var t=this.childMap.LU.isVisible(),r=this.childMap.LD.isVisible(),i=this.childMap.RU.isVisible(),o=this.childMap.RD.isVisible();return!(!this.childMap.LU.isRenderingPhase(e)&&t||!this.childMap.LD.isRenderingPhase(e)&&r||!this.childMap.RU.isRenderingPhase(e)&&i||!this.childMap.RD.isRenderingPhase(e)&&o)},fr.prototype.isChildrenPrepared=function(){if(void 0===this.childMap)return!1;if(this.getChildrenMapKeys().length<4)return!1;var e=this.childMap.LU.isVisible(),t=this.childMap.LD.isVisible(),r=this.childMap.RU.isVisible(),i=this.childMap.RD.isVisible();return!(!this.childMap.LU.isPrepared()&&e||!this.childMap.LD.isPrepared()&&t||!this.childMap.RU.isPrepared()&&r||!this.childMap.RD.isPrepared()&&i)},fr.prototype.isAnyChildrenVisible=function(){return void 0!==this.childMap&&(!(this.getChildrenMapKeys().length<4)&&(!!this.childMap.LU.isVisible()||(!!this.childMap.LD.isVisible()||(!!this.childMap.RU.isVisible()||!!this.childMap.RD.isVisible()))))},fr.prototype.isChildrenMeshPrepared=function(){return void 0!==this.childMap&&(!(this.getChildrenMapKeys().length<4)&&!!(this.childMap.LU.isMeshPrepared()&&this.childMap.LD.isMeshPrepared()&&this.childMap.RU.isMeshPrepared()&&this.childMap.RD.isMeshPrepared()))},fr.prototype.hasAnyChildVisible=function(){return void 0!==this.childMap&&(!(this.getChildrenMapKeys().length<4)&&(!!this.childMap.LU.isVisible()||(!!this.childMap.LD.isVisible()||(!!this.childMap.RU.isVisible()||!!this.childMap.RD.isVisible()))))},fr.prototype.isVisible=function(){return this.intersectionType===F.INTERSECTION_INTERSECT||this.intersectionType===F.INTERSECTION_INSIDE},fr.prototype.isTexturePrepared=function(e){for(var t=!0,r=Object.keys(e),i=r.length,o=this.depth.toString(),n=this.tinTerrainManager.getImageryLayers(),a=n.length,s=0;s<a;s++){var l=n[s];if(!this.texture[l._id]&&l.show&&l.maxZoom>parseInt(o)&&l.minZoom<parseInt(o)){t=!1;break}}if(!t)return t;for(s=0;s<i;s++){var u=e[r[s]];if(u.fileLoadState!==I.fileLoadState.LOADING_FINISHED||!u.texId){t=!1;break}}return t},fr.prototype.isPrepared=function(){return this.fileLoadState===I.fileLoadState.PARSE_FINISHED&&(!!this.isTexturePrepared(this.texture)&&!!this.isMeshPrepared(this.texture))},fr.prototype.isMeshPrepared=function(){return this.fileLoadState===I.fileLoadState.PARSE_FINISHED&&(void 0!==this.vboKeyContainer&&void 0!==this.vboKeyContainer.vboCacheKeysArray&&0!==this.vboKeyContainer.vboCacheKeysArray.length&&void 0!==this.terrainPositionHIGH)},fr.prototype.getTexCoordsOfGeoExtent=function(e){var t=e.geographicExtent.minGeographicCoord,r=e.geographicExtent.maxGeographicCoord,i=(t.longitude,t.latitude,r.longitude,r.latitude,this.geographicExtent.minGeographicCoord),o=this.geographicExtent.maxGeographicCoord,n=i.longitude,a=i.latitude;o.longitude,o.latitude},fr.prototype.mergeTexturesToTextureMaster=function(e,t,r){var i=r.length;i>8&&(i=8);for(var o,n=new Int32Array([0,0,0,0,0,0,0,0]),a=new Float32Array([1,1,1,1,1,1,1,1]),s=!1,l=0;l<i;l++){var u=r[l];if(e.activeTexture(e.TEXTURE0+l),e.bindTexture(e.TEXTURE_2D,u.texId),n[l]=u.activeTextureType,a[l]=u.opacity,2===u.activeTextureType)void 0===o&&(o=new Float32Array([0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1])),s=!0,o[4*l]=u.temp_clampToTerrainTexCoord[0],o[4*l+1]=u.temp_clampToTerrainTexCoord[1],o[4*l+2]=u.temp_clampToTerrainTexCoord[2],o[4*l+3]=u.temp_clampToTerrainTexCoord[3];else if(10===u.activeTextureType){var c=u.imagery.filter.properties;e.uniform2fv(t.uMinMaxAltitudes_loc,new Float32Array([c.minAltitude,c.maxAltitude]));var d=c.stepGradient;if(d){var h=d.length;e.uniform1fv(t.uGradientSteps_loc,new Float32Array(d)),e.uniform1i(t.uGradientStepsCount_loc,h)}else{var f=new Float32Array([0,-200]);h=f.length;e.uniform1fv(t.uGradientSteps_loc,f),e.uniform1i(t.uGradientStepsCount_loc,h)}}}e.uniform1iv(t.uActiveTextures_loc,n),e.uniform1fv(t.externalAlphasArray_loc,a),s&&e.uniform4fv(t.uExternalTexCoordsArray_loc,o),e.drawArrays(e.TRIANGLES,0,6);for(l=0;l<i;l++){(u=r[l]).temp_clampToTerrainTexCoord=void 0}},fr.prototype.makeTextureMasterImageryLayers=function(){if(!this.textureMasterImageryLayersPrepared){var e=this.tinTerrainManager.magoManager,t=e.postFxShadersManager,r=e.getGl();if(void 0===this.textureMasterImageryLayers){this.textureMasterImageryLayers=new it;var i=new Uint8Array(262144);this.textureMasterImageryLayers.texId=it.createTexture(r,r.LINEAR,i,256,256)}var o=this.tinTerrainManager.texturesMergerFbo;if(ae.bindFramebuffer(r,o,this.textureMasterImageryLayers.texId),r.viewport(0,0,256,256),r.clear(r.COLOR_BUFFER_BIT),void 0===this.tinTerrainManager.quadBuffer){var n=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.tinTerrainManager.quadBuffer=ae.createBuffer(r,n)}var a=t.getShader("texturesMerger");t.useProgram(a);for(var s=0;s<8;s++)r.activeTexture(r.TEXTURE0+s),r.bindTexture(r.TEXTURE_2D,null);r.enableVertexAttribArray(a.position2_loc),ae.bindAttribute(r,this.tinTerrainManager.quadBuffer,a.position2_loc,2);var l=[],u=[],c=this.tinTerrainManager.imagerys,d=c.length;for(s=0;s<d;s++){var h=c[s],f=this.texture[h._id];if(f){var g=h._id,p=1,m=f.imagery.filter;m&&m.type===I.imageFilter.BATHYMETRY&&(p=10),f.texId instanceof WebGLTexture&&(this.tinTerrainManager.textureIdDeleteMap[g]?(this.tinTerrainManager.eraseTexture(f,e),delete this.texture[g]):f.imagery.show&&(f.setOpacity(f.imagery.opacity),f.setActiveTextureType(p),u.push(f),8===u.length&&(l.push(u),u=[])))}}u.length>0&&l.push(u),r.enable(r.BLEND);var v=l.length;for(s=0;s<v;s++)this.mergeTexturesToTextureMaster(r,a,l[s]);r.disable(r.BLEND),this.isTexturePrepared(this.texture)&&(this.textureMasterImageryLayersPrepared=!0,this.layersStyleId=this.tinTerrainManager.layersStyleId),ae.bindFramebuffer(r,null)}},fr.prototype.makeTextureMaster=function(){this.makeTextureMasterImageryLayers();var e=this.tinTerrainManager.getIntersectedObjectToClampToTerrain(this.geographicExtent),t=this.tinTerrainManager.magoManager,r=t.postFxShadersManager,i=t.getGl();if(void 0===this.textureMaster){var o=new Uint8Array(262144);this.textureMaster=it.createTexture(i,i.LINEAR,o,256,256)}var n=this.tinTerrainManager.texturesMergerFbo;if(ae.bindFramebuffer(i,n,this.textureMaster),i.viewport(0,0,256,256),void 0===this.tinTerrainManager.quadBuffer){var a=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.tinTerrainManager.quadBuffer=ae.createBuffer(i,a)}var s=r.getShader("texturesMerger");r.useProgram(s),i.enableVertexAttribArray(s.position2_loc),ae.bindAttribute(i,this.tinTerrainManager.quadBuffer,s.position2_loc,2);var l=[],u=[];u.push(this.textureMasterImageryLayers);var c=!0;if(e&&e.length>0)for(var d=e.length,h=0;h<d;h++){var f=e[h];if(8===u.length&&(l.push(u),u=[]),f instanceof Ur)f.texture&&f.texture.fileLoadState===I.fileLoadState.BINDING_FINISHED?u.push(f.texture):c=!1;else if(f instanceof Br);}if(u.length>0&&l.push(u),c){i.clear(i.COLOR_BUFFER_BIT),i.enable(i.BLEND);var g=l.length;for(h=0;h<g;h++)this.mergeTexturesToTextureMaster(i,s,l[h]);i.disable(i.BLEND)}c&&this.isTexturePrepared(this.texture)&&(this.textureMasterPrepared=!0,this.objToClampToTerrainStyleId=this.tinTerrainManager.objToClampToTerrainStyleId),ae.bindFramebuffer(i,null)},fr.prototype.getTextureForVectorMeshObject=function(e,t,r){var i=this.tinTerrainManager.magoManager;i.postFxShadersManager,t=i.getGl();if(void 0===this.textureAux){var o=new Uint8Array(262144);this.textureAux=it.createTexture(t,t.LINEAR,o,256,256)}var n=this.tinTerrainManager.texturesMergerFbo;ae.bindFramebuffer(t,n,this.textureAux),t.viewport(0,0,256,256);var a=i.postFxShadersManager.getShader("thickLine");i.postFxShadersManager.useProgram(a),a.bindUniformGenerals(),(t=i.getGl()).uniform1i(a.bUseLogarithmicDepth_loc,i.postFxShadersManager.bUseLogarithmicDepth),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.disable(t.CULL_FACE),t.enableVertexAttribArray(a.prev_loc),t.enableVertexAttribArray(a.current_loc),t.enableVertexAttribArray(a.next_loc);i.sceneState;t.uniform2fv(a.viewport_loc,[256,256]);t.uniform4fv(r.oneColor4_loc,[.5,.7,.9,1]),t.uniform1f(r.thickness_loc,2);var s=vbo.vboBufferPos,l=s.dataDimensions;if(s.isReady(t,i.vboMemoryManager)){if(vbo.vboBufferCol){if(!vbo.bindDataColor(r,i.vboMemoryManager))return;t.uniform1i(r.colorType_loc,1)}else t.uniform1i(r.colorType_loc,0),t.disableVertexAttribArray(r.color4_loc);t.bindBuffer(t.ARRAY_BUFFER,s.key),t.vertexAttribPointer(r.prev_loc,l,t.FLOAT,!1,16,0),t.vertexAttribPointer(r.current_loc,l,t.FLOAT,!1,16,32),t.vertexAttribPointer(r.next_loc,l,t.FLOAT,!1,16,96),t.drawArrays(t.TRIANGLE_STRIP,0,vbo.vertexCount-4),t.enable(t.CULL_FACE),ae.bindFramebuffer(t,null)}},fr.prototype.bindTexture=function(e,t,r){if(this.textureMaster){var i=new Int32Array([1,1,0,0,1,0,0,0]),o=new Float32Array([1,1,1,1,1,1,1,1]);e.activeTexture(e.TEXTURE4+0),e.bindTexture(e.TEXTURE_2D,this.textureMaster);var n=this.geographicExtent.getExtentVec4();e.uniform4fv(t.uTileGeoExtentOfBindedTextures_loc,new Float32Array(n)),e.uniform1i(t.uTileDepthOfBindedTextures_loc,new Int32Array([this.depth])[0]);for(var a=Object.keys(this.texture),s=a.length,l=0;l<s;l++){var u=a[l],c=this.texture[u];if(c.texId instanceof WebGLTexture)if(this.tinTerrainManager.textureIdDeleteMap[u])this.tinTerrainManager.eraseTexture(c,magoManager),delete this.texture[u];else if(c.imagery.show){var d=c.imagery.filter;if(d)if(d.type===I.imageFilter.BATHYMETRY){i[5]=10,e.activeTexture(e.TEXTURE4+1),e.bindTexture(e.TEXTURE_2D,c.texId);var h=d.properties;e.uniform2fv(t.uMinMaxAltitudes_loc,new Float32Array([h.minAltitude,h.maxAltitude])),e.uniform1i(t.bApplyCaustics_loc,h.caustics)}else if(d.type===I.imageFilter.OCEANCOLOR_WATERMARKBYALPHA){i[5]=20,e.activeTexture(e.TEXTURE4+1),e.bindTexture(e.TEXTURE_2D,c.texId);h=d.properties;e.uniform2fv(t.uMinMaxAltitudes_loc,new Float32Array([h.minAltitude,h.maxAltitude])),e.uniform1i(t.bApplyCaustics_loc,h.caustics)}}}return e.uniform1iv(t.uActiveTextures_loc,i),e.uniform1fv(t.externalAlphasArray_loc,o),!0}return!!this.owner&&this.owner.bindTexture(e,t,r)},fr.prototype.prepareTexture=function(e,t,r,i){if(!(r.fileRequestControler.tinTerrainTexturesRequested>=6)){for(var o=r.sceneState.gl,n=this.depth.toString(),a=this.X.toString(),s=this.Y.toString(),l=0,u=0,c=t.length;u<c;u++){var d=t[u];if(!(!d.show||d.maxZoom<parseInt(n)||d.minZoom>parseInt(n))){var h=d._id;if(!this.texture[h]){var f=new it,g=d.getUrl({x:a,y:s,z:n});this.texFilePath__TEST=g;r.readerWriter.loadWMSImage(o,g,f,r,!1),this.texture[h]=f,this.texture[h].imagery=d,i.addTextureId(h),l+=1}}}return l}},fr.prototype.prepareTinTerrainPlain_FUNCTION_NO_USED=function(e,t){return!!this.tinTerrainManager.terrainReady&&(void 0===this.owner||this.owner.isPrepared()?(e.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState=I.fileLoadState.PARSE_FINISHED,this.fileLoadState===I.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer?(this.calculateCenterPosition(),this.makeMeshVirtually(20,20,void 0,void 0),this.makeVbo(e.vboMemoryManager),!1):this.isTexturePrepared(this.texture)?(this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(this.textureMasterImageryLayersPrepared=void 0,this.textureMasterPrepared=void 0),!this.textureMasterPrepared&&this.isTexturePrepared(this.texture)&&this.makeTextureMaster(),!0):(this.prepareTexture(this.texture,t.imagerys,e,t),!1)):this.owner.prepareTinTerrainPlain(e,t))},fr.prototype.prepareTinTerrainForward=function(e,t){if(this.depth<=this.tinTerrainManager.maxTextureGuranteedDepth?this.isPrepared():this.isMeshPrepared())!this.isLeaf&&this.childMap&&(this.childMap.LU.prepareTinTerrainForward(e,t),this.childMap.LD.prepareTinTerrainForward(e,t),this.childMap.RU.prepareTinTerrainForward(e,t),this.childMap.RD.prepareTinTerrainForward(e,t)),this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(this.textureMasterImageryLayersPrepared=void 0,this.textureMasterPrepared=void 0),!this.textureMasterPrepared&&this.isTexturePrepared(this.texture)&&this.makeTextureMaster();else{if(e.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState===I.fileLoadState.LOAD_FAILED)return this.fileLoadState=I.fileLoadState.LOADING_FINISHED,!1;if(this.fileLoadState===I.fileLoadState.READY){if(e.fileRequestControler.tinTerrainFilesRequested>5)return!1;if(!this.checkAvailableTerrain())return this.fileLoadState=I.fileLoadState.LOADING_FINISHED,!1;var r=this.getPathName(),i=(e.readerWriter.geometryDataPath,this.tinTerrainManager.terrainValue+r+".terrain");return e.readerWriter.loadTINTerrain(i,this,e),!1}if(this.fileLoadState===I.fileLoadState.LOADING_FINISHED)return e.parseQueue.putTinTerrainToParse(this,0),!1;if(this.fileLoadState===I.fileLoadState.PARSE_STARTED){var o=t.textureParsedTerrainMap,n=this.depth,a=this.X,s=this.Y;if(!o[n])return;if(!o[n][a])return;if(!o[n][a][s])return;var l=o[n][a][s];return this.centerX=l.centerX,this.centerY=l.centerY,this.centerZ=l.centerZ,this.minHeight=l.minHeight,this.maxHeight=l.maxHeight,this.geographicExtent.setExtent(void 0,void 0,this.minHeight[0],void 0,void 0,this.maxHeight[0]),this.boundingSphereCenterX=l.boundingSphereCenterX,this.boundingSphereCenterY=l.boundingSphereCenterY,this.boundingSphereCenterZ=l.boundingSphereCenterZ,this.boundingSphereRadius=l.boundingSphereRadius,this.horizonOcclusionPointX=l.horizonOcclusionPointX,this.horizonOcclusionPointY=l.horizonOcclusionPointY,this.horizonOcclusionPointZ=l.horizonOcclusionPointZ,this.vertexCount=l.vertexCount,this.indices=l.indices,this.westIndices=l.westIndices,this.southIndices=l.southIndices,this.eastIndices=l.eastIndices,this.northIndices=l.northIndices,this.extensionId=l.extensionId,this.extensionLength=l.extensionLength,this.texCoordsArray=l.texCoordsArray,this.cartesiansArray=l.cartesiansArray,this.skirtCartesiansArray=l.skirtCartesiansArray,this.skirtTexCoordsArray=l.skirtTexCoordsArray,this.skirtAltitudesArray=l.skirtAltitudesArray,this.altArray=l.altArray,this.normalsArray=l.normalsArray,this.lonArray=l.longitudesArray,this.latArray=l.latitudesArray,this.fileLoadState=I.fileLoadState.PARSE_FINISHED,delete this.tinTerrainManager.textureParsedTerrainMap[n][a][s],this.makeVbo(e.vboMemoryManager),this.makeSeaMeshVirtually(void 0),this.makeVboSea(e.vboMemoryManager),!1}if(!this.isTexturePrepared(this.texture))return this.depth<=t.maxTextureGuranteedDepth&&this.prepareTexture(this.texture,t.imagerys,e,t),!1}return!0},fr.prototype.prepareTinTerrainForward_original=function(e,t){if(this.depth<=this.tinTerrainManager.maxTextureGuranteedDepth?this.isPrepared():this.isMeshPrepared())!this.isLeaf&&this.childMap&&(this.childMap.LU.prepareTinTerrainForward(e,t),this.childMap.LD.prepareTinTerrainForward(e,t),this.childMap.RU.prepareTinTerrainForward(e,t),this.childMap.RD.prepareTinTerrainForward(e,t)),this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(this.textureMasterImageryLayersPrepared=void 0,this.textureMasterPrepared=void 0),!this.textureMasterPrepared&&this.isTexturePrepared(this.texture)&&this.makeTextureMaster();else{if(e.processQueue.eraseTinTerrainToDelete(this),this.fileLoadState===I.fileLoadState.LOAD_FAILED)return this.prepareTinTerrainPlain(e,t);if(this.fileLoadState===I.fileLoadState.READY){if(e.fileRequestControler.tinTerrainFilesRequested>5)return!1;if(!this.checkAvailableTerrain())return this.fileLoadState=I.fileLoadState.LOAD_FAILED,!1;var r=this.getPathName(),i=(e.readerWriter.geometryDataPath,this.tinTerrainManager.terrainValue+r+".terrain");return e.readerWriter.loadTINTerrain(i,this,e),!1}if(this.fileLoadState===I.fileLoadState.LOADING_FINISHED)return e.parseQueue.putTinTerrainToParse(this,0),!1;if(this.fileLoadState===I.fileLoadState.PARSE_STARTED){var o=t.textureParsedTerrainMap,n=this.depth,a=this.X,s=this.Y;if(!o[n])return;if(!o[n][a])return;if(!o[n][a][s])return;var l=o[n][a][s];return this.centerX=l.centerX,this.centerY=l.centerY,this.centerZ=l.centerZ,this.minHeight=l.minHeight,this.maxHeight=l.maxHeight,this.geographicExtent.setExtent(void 0,void 0,this.minHeight[0],void 0,void 0,this.maxHeight[0]),this.boundingSphereCenterX=l.boundingSphereCenterX,this.boundingSphereCenterY=l.boundingSphereCenterY,this.boundingSphereCenterZ=l.boundingSphereCenterZ,this.boundingSphereRadius=l.boundingSphereRadius,this.horizonOcclusionPointX=l.horizonOcclusionPointX,this.horizonOcclusionPointY=l.horizonOcclusionPointY,this.horizonOcclusionPointZ=l.horizonOcclusionPointZ,this.vertexCount=l.vertexCount,this.indices=l.indices,this.westIndices=l.westIndices,this.southIndices=l.southIndices,this.eastIndices=l.eastIndices,this.northIndices=l.northIndices,this.extensionId=l.extensionId,this.extensionLength=l.extensionLength,this.texCoordsArray=l.texCoordsArray,this.cartesiansArray=l.cartesiansArray,this.skirtCartesiansArray=l.skirtCartesiansArray,this.skirtTexCoordsArray=l.skirtTexCoordsArray,this.skirtAltitudesArray=l.skirtAltitudesArray,this.altArray=l.altArray,this.normalsArray=l.normalsArray,this.lonArray=l.longitudesArray,this.latArray=l.latitudesArray,this.fileLoadState=I.fileLoadState.PARSE_FINISHED,delete this.tinTerrainManager.textureParsedTerrainMap[n][a][s],this.makeVbo(e.vboMemoryManager),this.makeSeaMeshVirtually(void 0),this.makeVboSea(e.vboMemoryManager),!1}if(!this.isTexturePrepared(this.texture))return this.depth<=t.maxTextureGuranteedDepth&&this.prepareTexture(this.texture,t.imagerys,e,t),!1}return!0},fr.prototype.prepareTinTerrainRealTimeElevation=function(e,t){if(this.depth<10)return this.prepareTinTerrainPlain(e,t);if(void 0===this.owner||this.owner.isPrepared()){if(e.processQueue.eraseTinTerrainToDelete(this),!this.isTexturePrepared(this.textureElevation))return this.prepareTexture(this.textureElevation,t.imagerysDEM,e,t),!1;if(this.fileLoadState===I.fileLoadState.READY){var r=Object.keys(this.textureElevation);if(r.length>0){var i=this.textureElevation[r[0]];if(i){this.minHeight=new Float32Array([-200]),this.maxHeight=new Float32Array([1943.15]);var o=this.makeAltitudesSliceByTexture(16,16,void 0,i,e);this.test_mesh=1;var n={};n.altitudesSlice=o,this.makeMeshVirtually(16,16,void 0,n),this.fileLoadState=I.fileLoadState.PARSE_FINISHED}}return!1}return this.fileLoadState===I.fileLoadState.PARSE_FINISHED&&void 0===this.vboKeyContainer?(this.makeVbo(e.vboMemoryManager),!1):this.isTexturePrepared(this.texture)?this.fileLoadState!==I.fileLoadState.LOAD_FAILED||this.prepareTinTerrainPlain(e,t):(this.prepareTexture(this.texture,t.imagerys,e,t),!1)}return this.owner.prepareTinTerrainRealTimeElevation(e,t)},fr.prototype.hasChildren=function(){return!(void 0===this.childMap||!(this.childMap.LD||this.childMap.RD||this.childMap.RU||this.childMap.LU))},fr.prototype.deleteTinTerrain=function(e){if(this.hasChildren()){for(var t in this.childMap){if(Object.prototype.hasOwnProperty.call(this.childMap,t))this.childMap[t].deleteTinTerrain(e)}return!1}return e.parseQueue.eraseTinTerrainToParse(this),e.processQueue.putTinTerrainToDelete(this,0),!0},fr.prototype.renderForward=function(e,t,r,i,o){if(!this.isChildrenMeshPrepared()||this.isLeaf){if(this.fileLoadState===I.fileLoadState.LOAD_FAILED)return!1;if(!this.isMeshPrepared())return!0;var n=t.getGl();if(1===i){var a=t.sceneState;if(a.applySunShadows){var s=a.sunSystem.getLight(0).bSphere;if(s){var l=s.getRadius(),u=s.getCenterPoint(),c=this.getSphereExtent(t);u.distToPoint(c.centerPoint)+c.r<5*l?n.uniform1i(e.sunIdx_loc,0):n.uniform1i(e.sunIdx_loc,1)}}var d=!1;if(this.objToClampToTerrainStyleId!==this.tinTerrainManager.objToClampToTerrainStyleId&&(d=!0),this.layersStyleId!==this.tinTerrainManager.layersStyleId&&(d=!0),d&&this.isTexturePrepared(this.texture)){this.makeTextureMaster(),(t=this.tinTerrainManager.magoManager).bindMagoFbo(),e.resetLastBuffersBinded(),t.postFxShadersManager.useProgram(e),e.enableVertexAttribArray(e.position3_loc),r?e.disableVertexAttribArray(e.texCoord2_loc):e.enableVertexAttribArray(e.texCoord2_loc),n.viewport(0,0,t.sceneState.drawingBufferWidth[0],t.sceneState.drawingBufferHeight[0]);n.uniform1i(e.bApplySsao_loc,!1);var h,f=this.tinTerrainManager.magoManager.sceneState.sunSystem;if(h=f.getLight(0))(h=f.getLight(0)).depthFbo&&(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,h.depthFbo.colorBuffer)),(h=f.getLight(1)).depthFbo&&(n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,h.depthFbo.colorBuffer))}n.uniform1i(e.colorType_loc,2),n.uniform1f(e.externalAlpha_loc,1);var g=(new Date).getTime()/1e3%1e3;void 0===this.timeRandomFactor&&(this.timeRandomFactor=1e3*Math.random()),(g+=this.timeRandomFactor)>1e3&&(g-=1e3),n.uniform1f(e.uTime_loc,g),this.bindTexture(n,e,this.depth)}var p=t.vboMemoryManager;if(Math.abs(this.terrainPositionHIGH[0])<10||Math.abs(this.terrainPositionHIGH[1])<10||Math.abs(this.terrainPositionHIGH[1])<10);n.uniform3fv(e.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(e.buildingPosLOW_loc,this.terrainPositionLOW),n.uniform1i(e.uTileDepth_loc,new Int32Array([this.depth])[0]),n.uniform1i(e.uSeaOrTerrainType_loc,0);var m=this.geographicExtent.getExtentVec4();n.uniform4fv(e.uTileGeoExtent_loc,new Float32Array(m)),(_=this.vboKeyContainer.vboCacheKeysArray[0]).bindDataPosition(e,p),_.bindDataTexCoord(e,p),_.bindDataNormal(e,p),_.bindDataIndice(e,p);var v=t.selectionManager,x=_.indicesCount;if(2400!==x);var _;v.getSelectedGeneral();if(n.drawElements(n.TRIANGLES,x,n.UNSIGNED_SHORT,0),o.push(this),this.intersectionType=F.INTERSECTION_OUTSIDE,void 0===(_=this.vboKeyContainer.vboCacheKeysArray[1]))return;return!!_.bindDataPosition(e,p)&&(!(1===i&&!_.bindDataTexCoord(e,p))&&(0===i&&e.disableVertexAttribArray(e.texCoord2_loc),e.disableVertexAttribArray(e.normal3_loc),n.uniform1i(e.bApplySsao_loc,!1),n.drawArrays(n.TRIANGLE_STRIP,0,_.vertexCount),this.renderingFase=this.tinTerrainManager.renderingFase,!0))}this.childMap.LU.renderForward(e,t,r,i,o),this.childMap.LD.renderForward(e,t,r,i,o),this.childMap.RU.renderForward(e,t,r,i,o),this.childMap.RD.renderForward(e,t,r,i,o)},fr.prototype.renderSea=function(e,t,r,i){if(0===this.depth)return!0;if(this.minHeight[0]>0)return!1;if(void 0!==this.vboKeyContainer){var o=this.vboKeyContainer.vboCacheKeysArray[2];if(void 0!==o){var n=t.getGl(),a=new Int32Array([1,1,0,0,0,0,0,0]);n.uniform1i(e.colorType_loc,2),n.uniform1f(e.externalAlpha_loc,1);for(var s=Object.keys(this.texture),l=s.length,u=0;u<l;u++){n.activeTexture(n.TEXTURE2+u);var c=this.texture[s[u]];n.bindTexture(n.TEXTURE_2D,c.texId),a[2+u]=1;var d=c.imagery.filter;d&&d.type===I.imageFilter.BATHYMETRY&&(a[2+u]=10)}n.uniform1iv(e.uActiveTextures_loc,a);var h=t.vboMemoryManager;n.uniform3fv(e.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(e.buildingPosLOW_loc,this.terrainPositionLOW),n.uniform1i(e.uTileDepth_loc,this.depth);var f=this.vboKeyContainer.vboCacheKeysArray[0];if(1===i&&o){if(n.uniform1i(e.colorType_loc,0),n.uniform4fv(e.oneColor4_loc,[.1,.7,.9,.5]),n.uniform1i(e.uSeaOrTerrainType_loc,1),!o.bindDataPosition(e,h))return!1;if(!o.bindDataNormal(e,h))return!1;if(!f.bindDataTexCoord(e,h))return!1;if(!(f=this.vboKeyContainer.vboCacheKeysArray[0]).bindDataIndice(e,h))return!1;var g=f.indicesCount;if(!1){var p=g;for(u=0;u<p;u++)n.drawElements(n.LINE_LOOP,3,n.UNSIGNED_SHORT,3*u)}else n.drawElements(n.TRIANGLES,g,n.UNSIGNED_SHORT,0)}return!0}}},fr.prototype.drawTerrainName=function(e){var t,r=e.getObjectLabel().getContext("2d"),i=e.getGl(),o=this.geographicExtent.getMidPoint(),n=on.geographicCoordToWorldPoint(o.longitude,o.latitude,o.altitude,void 0);if((t=on.calculateWorldPositionToScreenCoord(i,n.x,n.y,n.z,t,e)).x>=0&&t.y>=0){r.font="13px Arial";var a=this.getPathName();r.strokeText(a,t.x,t.y),r.fillText(a,t.x,t.y),e.canvasDirty=!0}r.restore()},fr.prototype.extractLowestTinTerrains=function(e){if(hasChildren())for(var t in this.childMap)if(Object.prototype.hasOwnProperty.call(this.childMap,t)){var r=this.childMap[t];r.visible=!1,e.push(r)}},fr.prototype.getObjectIdxSortedByDist=function(e,t,r,i){var o=r-t;if(o<6){for(var n,a=!1,s=t;!a&&s<=r;){var l=e[s];i.distToCam<l.distToCam&&(n=s,a=!0),s++}return a?n:r+1}var u,c,d=t+Math.floor(o/2);return e[d].distToCam>i.distToCam?(u=t,c=d):(u=d,c=r),this.getObjectIdxSortedByDist(e,u,c,i)},fr.prototype.putObjectToArraySortedByDist=function(e,t){if(e.length>0){var r=e.length-1,i=this.getObjectIdxSortedByDist(e,0,r,t);e.splice(i,0,t)}else e.push(t)},fr.prototype.getSphereExtent=function(e){if(void 0===this.sphereExtent){var t=this.geographicExtent.minGeographicCoord,r=this.geographicExtent.maxGeographicCoord;this.sphereExtent=Ke.computeSphereExtent(e,t,r,this.sphereExtent)}return this.sphereExtent},fr.prototype.getFrustumIntersectedTinTerrainsQuadTree=function(e,t,r,i,o,n){if(void 0!==this.geographicExtent&&void 0!==this.geographicExtent.minGeographicCoord&&void 0!==this.geographicExtent.maxGeographicCoord){var a=this.geographicExtent.minGeographicCoord,s=this.geographicExtent.maxGeographicCoord;this.sphereExtent=this.getSphereExtent(i);var l=this.sphereExtent,u=this.depth;this.intersectionType=e.intersectionSphere(this.sphereExtent),this.isLeaf=!1,this.distToCam=r.distToSphere(l),this.intersectionType===F.INTERSECTION_OUTSIDE&&this.depth>0&&(this.distToCam<0&&(this.distToCam=1),this.distToCam*=1e5);var c=this.tinTerrainManager.distLimitByDepth[u];if(this.distToCam>c)return this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),this.isLeaf=!0,this.putObjectToArraySortedByDist(o[this.depth],this),void(this.hasChildren()&&(n.push(this.childMap.LU),n.push(this.childMap.LD),n.push(this.childMap.RU),n.push(this.childMap.RD)));if(!(u<t))return this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),void this.putObjectToArraySortedByDist(o[this.depth],this);var d=this.X,h=this.Y,f=a.longitude,g=a.latitude,p=a.altitude,m=s.longitude,v=s.latitude,x=s.altitude,_=(f+m)/2,y=(g+v)/2;this.tinTerrainManager.imageryType===I.imageryType.WEB_MERCATOR&&(y=180*this.getMidLatitudeRadWebMercator()/Math.PI);var T=this.webMercatorExtent.minX,C=this.webMercatorExtent.minY,b=this.webMercatorExtent.maxX,M=this.webMercatorExtent.maxY,A=(b+T)/2,E=(M+C)/2;void 0===this.childMap&&(this.childMap={});var L=this.childMap.LU;void 0===L&&((L=new fr(this)).X=2*d,L.Y=2*h,L.setGeographicExtent(f,y,p,_,v,x),L.indexName="LU",L.tinTerrainManager=this.tinTerrainManager,this.childMap.LU=L,L.setWebMercatorExtent(T,E,A,M));var w=this.childMap.LD;void 0===w&&((w=new fr(this)).X=2*d,w.Y=2*h+1,w.setGeographicExtent(f,g,p,_,y,x),w.indexName="LD",w.tinTerrainManager=this.tinTerrainManager,this.childMap.LD=w,w.setWebMercatorExtent(T,C,A,E));var S=this.childMap.RU;void 0===S&&((S=new fr(this)).X=2*d+1,S.Y=2*h,S.setGeographicExtent(_,y,p,m,v,x),S.indexName="RU",S.tinTerrainManager=this.tinTerrainManager,this.childMap.RU=S,S.setWebMercatorExtent(A,E,b,M));var D=this.childMap.RD;if(void 0===D&&((D=new fr(this)).X=2*d+1,D.Y=2*h+1,D.setGeographicExtent(_,g,p,m,y,x),D.indexName="RD",D.tinTerrainManager=this.tinTerrainManager,this.childMap.RD=D,D.setWebMercatorExtent(A,C,b,E)),0===!this.depth&&!this.isPrepared()){this.visible=!0,void 0===o[this.depth]&&(o[this.depth]=[]),this.putObjectToArraySortedByDist(o[this.depth],this);var R=this.depth+1;return void 0===o[R]&&(o[R]=[]),this.putObjectToArraySortedByDist(o[R],this.childMap.LU),this.putObjectToArraySortedByDist(o[R],this.childMap.LD),this.putObjectToArraySortedByDist(o[R],this.childMap.RU),void this.putObjectToArraySortedByDist(o[R],this.childMap.RD)}L.getFrustumIntersectedTinTerrainsQuadTree(e,t,r,i,o,n),w.getFrustumIntersectedTinTerrainsQuadTree(e,t,r,i,o,n),S.getFrustumIntersectedTinTerrainsQuadTree(e,t,r,i,o,n),D.getFrustumIntersectedTinTerrainsQuadTree(e,t,r,i,o,n)}},fr.prototype.calculateCenterPosition_FUNCTION_NO_USED=function(){if(0===this.depth)this.centerX=new Float64Array([0]),this.centerY=new Float64Array([0]),this.centerZ=new Float64Array([0]);else{var e,t,r=(e=this.geographicExtent.getMidPoint(e)).longitude,i=e.latitude;t=Te.geographicToCartesianWgs84(r,i,0,t),this.centerX=new Float64Array([t[0]]),this.centerY=new Float64Array([t[1]]),this.centerZ=new Float64Array([t[2]])}},fr.prototype.getMidLatitudeRadWebMercator=function(){if(void 0!==this.webMercatorExtent){var e=(this.webMercatorExtent.maxY+this.webMercatorExtent.minY)/2;return 2*Math.atan(Math.pow(Math.E,e))-Math.PI/2}},fr.prototype.makeAltitudesSliceByTexture=function(e,t,r,i,o){var n=o.getGl(),a=n.createFramebuffer();if(n.bindFramebuffer(n.FRAMEBUFFER,a),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,i.texId,0),n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE){var s=i.imageWidth,l=i.imageHeight,u=new Uint8Array(4),c=new Float32Array((e+1)*(t+1));this.minHeight[0]=-200,this.maxHeight[0]=1943.15;var d=this.minHeight[0],h=this.maxHeight[0];void 0===d&&(d=0),void 0===h&&(h=0);for(var f=h-d,g=0,p=0;p<t+1;p++){var m=Math.floor((1-p/(t+1))*l);m<0&&(m=0),m>255&&(m=255);for(var v=0;v<e+1;v++){var x=Math.floor(v/(e+1)*s);x<0&&(x=0),n.readPixels(x,m,1,1,n.RGBA,n.UNSIGNED_BYTE,u);var _=d+u[0]/256*f;c[g]=_,g+=1}}}return n.bindFramebuffer(n.FRAMEBUFFER,null),c},fr.prototype.makeMeshVirtually_FUNCTION_NO_USED=function(e,t,r,i){var o;i&&i.altitudesSlice&&(o=i.altitudesSlice);var n=Math.PI/180,a=this.geographicExtent.minGeographicCoord.longitude*n,s=this.geographicExtent.minGeographicCoord.latitude*n,l=this.geographicExtent.maxGeographicCoord.longitude*n,u=this.geographicExtent.maxGeographicCoord.latitude*n;void 0===this.minHeight&&(this.minHeight=new Float32Array([0])),void 0===this.maxHeight&&(this.maxHeight=new Float32Array([0]));var c=l-a,d=u-s,h=this.depth,f=c/e,g=d/t,p=(e+1)*(t+1),m=new Float32Array(p),v=new Float32Array(p),x=new Float32Array(p);this.texCoordsArray=new Float32Array(2*p);var _,y,T=a,C=s,b=0,M=Math.PI,A=1/(2*M)*Math.pow(2,h),E=0;r&&(E=r);var L=M/4,w=Math.round(A*(M-Math.log(Math.tan(L+s/2)))),S=Math.round(A*(M-Math.log(Math.tan(L+u/2)))),D=Math.round(A*(a+M)),R=(Math.round(A*(l+M)),Math.floor(D));w=1-w,S=1-S;for(var P=this.tinTerrainManager.getTexCorrection(h),I=0;I<t+1;I++){(C=s+g*I)>u&&(C=u),y=1-(y=A*(M-Math.log(Math.tan(L+C/2)))),y-=w,_<0?_=0:_>1&&(_=1),y<0?y=0:y>1&&(y=1);for(var F=0;F<e+1;F++)(T=a+f*F)>l&&(T=l),m[b]=T,v[b]=C,x[b]=o?o[b]:E,_=A*(T+M),_-=R,0===F?_+=P/2:F===e&&(_+=-P/2),this.texCoordsArray[2*b]=_,this.texCoordsArray[2*b+1]=y,b++}this.cartesiansArray=Te.geographicRadianArrayToFloat32ArrayWgs84(m,v,x,void 0),this.normalsArray=new Int8Array(3*p);for(var O=new Jr,B=0;B<p;B++)O.set(this.cartesiansArray[3*B],this.cartesiansArray[3*B+1],this.cartesiansArray[3*B+2]),O.unitary(),this.normalsArray[3*B]=126*O.x,this.normalsArray[3*B+1]=126*O.y,this.normalsArray[3*B+2]=126*O.z;var N=this.cartesiansArray.length/3;for(B=0;B<N;B++)this.cartesiansArray[3*B]-=this.centerX,this.cartesiansArray[3*B+1]-=this.centerY,this.cartesiansArray[3*B+2]-=this.centerZ;var U=e+1,G=t+1,z=(i={bCalculateBorderIndices:!0},en.getIndicesTrianglesRegularNet(U,G,void 0,void 0,void 0,void 0,void 0,i));this.indices=z.indicesArray,this.southIndices=z.southIndicesArray,this.eastIndices=z.eastIndicesArray,this.northIndices=z.northIndicesArray,this.westIndices=z.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length;i={skirtDepth:1e4,texCorrectionFactor:P};var H=fr.getSkirtTrianglesStrip(m,v,x,this.texCoordsArray,this.southIndices,this.eastIndices,this.northIndices,this.westIndices,i);this.skirtCartesiansArray=H.skirtCartesiansArray,this.skirtTexCoordsArray=H.skirtTexCoordsArray;for(N=this.skirtCartesiansArray.length/3,B=0;B<N;B++)this.skirtCartesiansArray[3*B]-=this.centerX,this.skirtCartesiansArray[3*B+1]-=this.centerY,this.skirtCartesiansArray[3*B+2]-=this.centerZ;this.calculateCenterPosition()},fr.prototype.makeSeaMeshVirtually=function(e){var t=this.lonArray.length,r=new Float32Array(t);this.cartesiansArraySea=Te.geographicRadianArrayToFloat32ArrayWgs84(this.lonArray,this.latArray,r,void 0),this.normalsArraySea=new Int8Array(3*t);for(var i=new Jr,o=0;o<t;o++)i.set(this.cartesiansArraySea[3*o],this.cartesiansArraySea[3*o+1],this.cartesiansArraySea[3*o+2]),i.unitary(),this.normalsArraySea[3*o]=126*i.x,this.normalsArraySea[3*o+1]=126*i.y,this.normalsArraySea[3*o+2]=126*i.z;e={skirtDepth:1e4,texCorrectionFactor:this.tinTerrainManager.getTexCorrection(this.depth)};var n=fr.getSkirtTrianglesStrip(this.lonArray,this.latArray,r,this.texCoordsArray,this.southIndices,this.eastIndices,this.northIndices,this.westIndices,e);this.skirtCartesiansArraySea=n.skirtCartesiansArray,this.skirtTexCoordsArraySea=n.skirtTexCoordsArray},fr.prototype.makeMeshVirtuallyCRS84_FUNCTION_NO_USED=function(e,t,r,i){var o=Math.PI/180,n=this.geographicExtent.minGeographicCoord.longitude*o,a=this.geographicExtent.minGeographicCoord.latitude*o,s=this.geographicExtent.maxGeographicCoord.longitude*o,l=this.geographicExtent.maxGeographicCoord.latitude*o,u=s-n,c=l-a,d=(this.depth,u/e),h=c/t,f=(e+1)*(t+1),g=new Float32Array(f),p=new Float32Array(f),m=new Float32Array(f);this.texCoordsArray=new Float32Array(2*f);var v,x,_=n,y=a,T=0,C=0;r&&(C=r);for(var b=0;b<t+1;b++){(y=a+h*b)>l&&(y=l);for(var M=0;M<e+1;M++)(_=n+d*M)>s&&(_=s),g[T]=_,p[T]=y,m[T]=i?i.getValue(M,b):C,v=(_-n)/u,x=(y-a)/c,this.texCoordsArray[2*T]=v,this.texCoordsArray[2*T+1]=x,T++}this.cartesiansArray=Te.geographicRadianArrayToFloat32ArrayWgs84(g,p,m,this.cartesiansArray),this.normalsArray=new Int8Array(3*f);for(var A=new Jr,E=0;E<f;E++)A.set(this.cartesiansArray[3*E],this.cartesiansArray[3*E+1],this.cartesiansArray[3*E+2]),A.unitary(),this.normalsArray[3*E]=126*A.x,this.normalsArray[3*E+1]=126*A.y,this.normalsArray[3*E+2]=126*A.z;var L=e+1,w=t+1,S=en.getIndicesTrianglesRegularNet(L,w,void 0,void 0,void 0,void 0,void 0,{bCalculateBorderIndices:!0});this.indices=S.indicesArray,this.southIndices=S.southIndicesArray,this.eastIndices=S.eastIndicesArray,this.northIndices=S.northIndicesArray,this.westIndices=S.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length,this.calculateCenterPosition()},fr.prototype.zigZagDecode=function(e){return e>>1^-(1&e)},fr.prototype.makeVbo=function(e){if(void 0!==this.cartesiansArray){void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),on.calculateSplited3fv([this.centerX[0],this.centerY[0],this.centerZ[0]],this.terrainPositionHIGH,this.terrainPositionLOW),void 0===this.vboKeyContainer&&(this.vboKeyContainer=new xt);var t=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(t.setDataArrayPos(this.cartesiansArray,e),this.normalsArray&&t.setDataArrayNor(this.normalsArray,e),this.texCoordsArray&&t.setDataArrayTexCoord(this.texCoordsArray,e),t.setDataArrayIdx(this.indices,e),void 0!==this.skirtCartesiansArray){var r=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(r.setDataArrayPos(this.skirtCartesiansArray,e),this.skirtTexCoordsArray&&r.setDataArrayTexCoord(this.skirtTexCoordsArray,e),void 0!==this.seaCartesiansArray)this.vboKeyContainer.newVBOVertexIdxCacheKey().setDataArrayPos(this.seaCartesiansArray,e)}}},fr.prototype.makeVboSea=function(e){if(void 0!==this.cartesiansArraySea){for(var t=this.cartesiansArraySea.length/3,r=0;r<t;r++)this.cartesiansArraySea[3*r]-=this.centerX[0],this.cartesiansArraySea[3*r+1]-=this.centerY[0],this.cartesiansArraySea[3*r+2]-=this.centerZ[0];void 0===this.vboKeyContainer&&(this.vboKeyContainer=new xt);var i=this.vboKeyContainer.newVBOVertexIdxCacheKey();if(i.setDataArrayPos(this.cartesiansArraySea,e),this.normalsArraySea&&i.setDataArrayNor(this.normalsArraySea,e),this.texCoordsArraySea&&i.setDataArrayTexCoord(this.texCoordsArraySea,e),i.setDataArrayIdx(this.indicesSea,e),void 0!==this.skirtCartesiansArraySea){var o=this.skirtCartesiansArraySea.length;for(r=0;r<o;r++)this.skirtCartesiansArraySea[3*r]-=this.centerX[0],this.skirtCartesiansArraySea[3*r+1]-=this.centerY[0],this.skirtCartesiansArraySea[3*r+2]-=this.centerZ[0];var n=this.vboKeyContainer.newVBOVertexIdxCacheKey();n.setDataArrayPos(this.skirtCartesiansArraySea,e),this.skirtTexCoordsArraySea&&n.setDataArrayTexCoord(this.skirtTexCoordsArraySea,e)}}},fr.getSkirtTrianglesStrip=function(e,t,r,i,o,n,a,s,l){var u=1e3,c=1,d=!1;l&&(void 0!==l.skirtDepth&&(u=l.skirtDepth),void 0!==l.texCorrectionFactor&&(c=l.texCorrectionFactor),l.bMakeAltitudesArray&&(d=!0));for(var h=s.length,f=o.length,g=n.length,p=a.length,m=h+f+g+p,v=new Float32Array(2*m),x=new Float32Array(2*m),_=new Float32Array(2*m),y=new Float32Array(4*m),T=new Float32Array(4*m),C=0,b=0;b<h;b++){i[2*(M=s[b])]+=c,v[C]=e[M],x[C]=t[M],_[C]=r[M],y[2*C]=i[2*M],y[2*C+1]=i[2*M+1],d&&(T[C]=r[M]),v[C+=1]=e[M],x[C]=t[M],_[C]=r[M]-u,y[2*C]=i[2*M],y[2*C+1]=i[2*M+1],d&&(T[C]=r[M]),C+=1}for(b=0;b<f;b++){i[2*(M=o[b])+1]=c,v[C]=e[M],x[C]=t[M],_[C]=r[M],y[2*C]=i[2*M],y[2*C+1]=i[2*M+1],d&&(T[C]=r[M]),v[C+=1]=e[M],x[C]=t[M],_[C]=r[M]-u,y[2*C]=i[2*M],y[2*C+1]=i[2*M+1],d&&(T[C]=r[M]),C+=1}for(b=0;b<g;b++){i[2*(M=n[b])]-=c,v[C]=e[M],x[C]=t[M],_[C]=r[M],y[2*C]=i[2*M],y[2*C+1]=i[2*M+1],d&&(T[C]=r[M]),v[C+=1]=e[M],x[C]=t[M],_[C]=r[M]-u,y[2*C]=i[2*M],y[2*C+1]=i[2*M+1],d&&(T[C]=r[M]),C+=1}for(b=0;b<p;b++){var M;i[2*(M=a[b])+1]=1-c,v[C]=e[M],x[C]=t[M],_[C]=r[M],y[2*C]=i[2*M],y[2*C+1]=i[2*M+1],d&&(T[C]=r[M]),v[C+=1]=e[M],x[C]=t[M],_[C]=r[M]-u,y[2*C]=i[2*M],y[2*C+1]=i[2*M+1],d&&(T[C]=r[M]),C+=1}var A={skirtCartesiansArray:Te.geographicRadianArrayToFloat32ArrayWgs84(v,x,_,void 0),skirtTexCoordsArray:y,skirtAltitudesArray:_};return d&&(A.skirtAltitudesValuesArray=T),A},fr.getNormalCartesiansArray=function(e,t,r,i){for(var o,n,a,s,l,u,c=[],d=t.length/3,h=0;h<d;h++)o=t[3*h],n=t[3*h+1],a=t[3*h+2],s=new Jr(e[3*o],e[3*o+1],e[3*o+2]),l=new Jr(e[3*n],e[3*n+1],e[3*n+2]),u=new Jr(e[3*a],e[3*a+1],e[3*a+2]),g=bi.calculateNormal(s,u,l,void 0),void 0!==c[o]?c[o].addPoint(g):c[o]=g,void 0!==c[n]?c[n].addPoint(g):c[n]=g,void 0!==c[a]?c[a].addPoint(g):c[a]=g;var f=c.length;void 0===r&&(r=new Int8Array(3*f));for(h=0;h<f;h++){var g;(g=c[h]).unitary(),r[3*h]=Math.floor(255*g.x),r[3*h+1]=Math.floor(255*g.y),r[3*h+2]=Math.floor(255*g.z)}return r},fr.prototype.getAltitudes_byAltitudesMap=function(e,t,r){},fr.prototype.getAltitudes_byAltitudesOwnMap=function(e,t,r){void 0===this.altitudesFbo&&this.makeAltitudesOwnMap(r);var i=this.geographicExtent.minGeographicCoord.longitude,o=this.geographicExtent.minGeographicCoord.latitude,n=this.geographicExtent.maxGeographicCoord.longitude-i,a=this.geographicExtent.maxGeographicCoord.latitude-o,s=this.minHeight[0],l=this.maxHeight[0]-s,u=new Uint8Array(4),c=this.altitudesFbo.width,d=this.altitudesFbo.height;void 0===t&&(t=[]),this.altitudesFbo.bind();for(var h=e.length,f=0;f<h;f++){var g=e[f],p=(g.longitude-i)/n*c,m=(g.latitude-o)/a*d;gl.readPixels(p,m,1,1,gl.RGBA,gl.UNSIGNED_BYTE,u);var v=s+(u[0]/16777216+u[1]/65536+u[2]/256+u[3])/256*l;g.altitude=v,t.push(g)}return this.altitudesFbo.unbind(),t},fr.prototype.makeAltitudesOwnMap=function(e){var t=e.getGl();if(void 0===this.altitudesFbo){this.altitudesFbo=new ae(t,256,256)}for(var r,i,o,n,a,s,l=this.uValues,u=this.vValues,c=this.hValues,d=(this.indices,l.length),h=new Float32Array(3*d),f=0;f<d;f++)h[3*f]=l[f]/32767,h[3*f+1]=u[f]/32767,h[3*f+2]=c[f]/32767,0===f?(r=h[3*f],i=h[3*f+1],o=h[3*f+2],n=h[3*f],a=h[3*f+1],s=h[3*f+2]):(h[3*f]<n?n=h[3*f]:h[3*f]>r&&(r=h[3*f]),h[3*f+1]<a?a=h[3*f+1]:h[3*f+1]>i&&(i=h[3*f+1]),h[3*f+2]<s?s=h[3*f+2]:h[3*f+2]>o&&(o=h[3*f+2]));void 0===this.vboKeyContainerAltitudes&&(this.vboKeyContainerAltitudes=new xt);var g=this.vboKeyContainerAltitudes.newVBOVertexIdxCacheKey(),p=this.vboKeyContainer.vboCacheKeysArray[0],m=e.vboMemoryManager;g.setDataArrayPos(h,m);var v=new Ne,x=new Ne;this.altitudesMapMVPMat=new Ne;var _=1*-depthFactor,y=1*depthFactor;x._floatArrays=glMatrix.mat4.ortho(x._floatArrays,-1,1,-1,1,_,y),this.altitudesMapMVPMat=v.getMultipliedByMatrix(x,this.altitudesMapMVPMat),this.altitudesFbo.bind();var T=e.postFxShadersManager.getShader("tinTerrainAltitudes");if(T.useProgram(),T.enableVertexAttribArray(T.position3_loc),!g.bindDataPosition(T,m))return!1;if(!p.bindDataIndice(T,m))return!1;var C=p.indicesCount;t.drawElements(t.TRIANGLES,C,t.UNSIGNED_SHORT,0),this.altitudesFbo.unbind()},fr.prototype.decodeData_FUNCTION_NO_USED=function(e){if(void 0!==this.geographicExtent){void 0===this.vertexArray&&(this.vertexArray=[]);var t=this.tinTerrainManager;this.tinTerrainManager.workerDecodedTerrain||(this.tinTerrainManager.workerDecodedTerrain=Ko(this.tinTerrainManager.magoManager.config.scriptRootPath+"Worker/workerDecodeTerrain.js"),this.tinTerrainManager.workerDecodedTerrain.onmessage=function(e){var r=e.data.info,i=e.data.decodedTerrain,o=t.textureDecodedTerrainMap;o[r.z]||(o[r.z]={}),o[r.z][r.x]||(o[r.z][r.x]={}),o[r.z][r.x][r.y]||(o[r.z][r.x][r.y]=i)});this.tinTerrainManager.workerDecodedTerrain.postMessage({param:{minGeographicLongitude:this.geographicExtent.minGeographicCoord.longitude,minGeographicLatitude:this.geographicExtent.minGeographicCoord.latitude,maxGeographicLongitude:this.geographicExtent.maxGeographicCoord.longitude,maxGeographicLatitude:this.geographicExtent.maxGeographicCoord.latitude,minHeight:this.minHeight,maxHeight:this.maxHeight,vertexCount:this.vertexCount,uValues:this.uValues,vValues:this.vValues,hValues:this.hValues,imageryType:e,depth:this.depth,southIndices:this.southIndices,eastIndices:this.eastIndices,northIndices:this.northIndices,westIndices:this.westIndices,bMakeNormals:!0,indices:this.indices,X:this.X,Y:this.Y},info:{x:this.X,y:this.Y,z:this.depth}}),this.requestDecodeData=!0}},fr.prototype.parseData=function(e){var t=this.tinTerrainManager;this.fileLoadState=I.fileLoadState.PARSE_STARTED;var r=t.imageryType;if(e){this.tinTerrainManager.workerParseTerrain||(this.tinTerrainManager.workerParseTerrain=Ko(this.tinTerrainManager.magoManager.config.scriptRootPath+"Worker/workerParseTerrain.js"),this.tinTerrainManager.workerParseTerrain.onmessage=function(e){var r=e.data.info,i=e.data.parsedTerrain,o=t.textureParsedTerrainMap;o[r.z]||(o[r.z]={}),o[r.z][r.x]||(o[r.z][r.x]={}),o[r.z][r.x][r.y]||(o[r.z][r.x][r.y]=i)});var i={dataArrayBuffer:e,info:{x:this.X,y:this.Y,z:this.depth,minGeographicLongitude:this.geographicExtent.minGeographicCoord.longitude,minGeographicLatitude:this.geographicExtent.minGeographicCoord.latitude,maxGeographicLongitude:this.geographicExtent.maxGeographicCoord.longitude,maxGeographicLatitude:this.geographicExtent.maxGeographicCoord.latitude,imageryType:r,bMakeNormals:!0}};this.tinTerrainManager.workerParseTerrain.postMessage(i,[i.dataArrayBuffer])}else{this.tinTerrainManager.workerMakePlaneTerrain||(this.tinTerrainManager.workerMakePlaneTerrain=Ko(this.tinTerrainManager.magoManager.config.scriptRootPath+"Worker/workerMakePlaneTerrain.js"),this.tinTerrainManager.workerMakePlaneTerrain.onmessage=function(e){var r=e.data.info,i=e.data.parsedTerrain,o=t.textureParsedTerrainMap;o[r.z]||(o[r.z]={}),o[r.z][r.x]||(o[r.z][r.x]={}),o[r.z][r.x][r.y]||(o[r.z][r.x][r.y]=i)});var o=this.tinTerrainManager.getTexCorrection(this.depth);i={info:{x:this.X,y:this.Y,z:this.depth,minGeographicLongitude:this.geographicExtent.minGeographicCoord.longitude,minGeographicLatitude:this.geographicExtent.minGeographicCoord.latitude,maxGeographicLongitude:this.geographicExtent.maxGeographicCoord.longitude,maxGeographicLatitude:this.geographicExtent.maxGeographicCoord.latitude,lonSegments:20,latSegments:20,altitude:0,imageryType:r,bMakeNormals:!0,texCorrectionFactor:o}};this.tinTerrainManager.workerMakePlaneTerrain.postMessage(i)}};var gr=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.ready=!0,this.maxDepth=17,this.currentVisibles_terrName_geoCoords_map={},this.currentTerrainsMap={},this.visibleTilesArray=[],this.noVisibleTilesArray=[],this.visibleSeaTilesArray=[],this.noVisibleSeaTilesArray=[],this.tinTerrainsQuadTreeAsia,this.tinTerrainsQuadTreeAmerica,this.tinTerrainQuadTreeMercator;var i=t.config.getPolicy();this.terrainType=Zo(i.terrainType,I.magoEarthTerrainType.PLAIN),this.terrainValue=i.terrainValue,this.terrainReady=!1,this.terrainTilesInfo,this.selectable=!0,this.magoManager=t;var o=t.getGl();if(this.texturesMergerFbo=o.createFramebuffer(),this.terrainType!==I.magoEarthTerrainType.PLAIN&&!this.terrainValue)throw new Error("If use elevation model, require terrain value.");if(r&&(void 0!==r.createSea&&(this.bRenderSea=r.createSea),void 0!==r.terrainSelectable&&(this.selectable=r.terrainSelectable),void 0!==r.maxDepth&&(this.maxDepth=r.maxDepth)),this.imageryType=I.imageryType.WEB_MERCATOR,this.imagerys=[],r.layers&&Array.isArray(r.layers))for(var n=0,a=r.layers.length;n<a;n++){var s=r.layers[n];(s instanceof yt||s instanceof Ct)&&this.addImageryLayer(s)}this.textureParsedTerrainMap={},this.textureDecodedTerrainMap={},this.textureIdCntMap={},this.textureIdDeleteMap={},this.bRenderSea=!0,this.renderingFase=0,this.layersStyleId=0,this.objToClampToTerrainStyleId=0,this.objectsToClampToTerrainArray,this.maxTextureGuranteedDepth=1,this.init(),this.makeTinTerrainWithDEMIndex()};gr.INFO_FILE="terrainTiles-info.json",gr.prototype.deleteAll=function(){this.maxTextureGuranteedDepth=0,this.tinTerrainsQuadTreeAsia&&this.tinTerrainsQuadTreeAsia.deleteObjects(this.magoManager),this.tinTerrainsQuadTreeAmerica&&this.tinTerrainsQuadTreeAmerica.deleteObjects(this.magoManager),this.tinTerrainQuadTreeMercator&&this.tinTerrainQuadTreeMercator.deleteObjects(this.magoManager)},gr.prototype.getImageryLayers=function(){return this.imagerys},gr.prototype.imageryLayersChanged=function(){this.layersStyleId+=1,this.layersStyleId>1e6&&(this.layersStyleId=0)},gr.prototype.objectsClampToTerrainChanged=function(){this.objToClampToTerrainStyleId+=1,this.objToClampToTerrainStyleId>1e6&&(this.objToClampToTerrainStyleId=0)},gr.prototype.addObjectToClampToTerrain=function(e){void 0===this.objectsToClampToTerrainArray&&(this.objectsToClampToTerrainArray=[]),this.objectsToClampToTerrainArray.push(e),this.objectsClampToTerrainChanged()},gr.prototype.removeObjectToClampToTerrain=function(e){this.objectsToClampToTerrainArray=this.objectsToClampToTerrainArray.filter(function(t){return t!==e}),this.imageryLayersChanged()},gr.prototype.prepareObjectToClampToTerrain=function(){var e=this.objectsToClampToTerrainArray;if(e&&e.length>0)for(var t=e.length,r=0;r<t;r++){var i=e[r];if(i instanceof Ur)if(void 0===i.texture){i.texture=new it,i.texture.setActiveTextureType(2);var o=i.style;if(o){var n=o.imageUrl;i.texture.url=n;var a=!1;at.loadTexture(n,i.texture,this.magoManager,a)}}else i.texture.texId instanceof WebGLTexture||(i.texture.blob?at.newWebGlTextureByBlob(gl,i.texture.blob,i.texture):i.texture.url&&at.loadTexture(i.texture.url,i.texture,this.magoManager,a))}},gr.prototype.getIntersectedObjectToClampToTerrain=function(e,t){var r=this.objectsToClampToTerrainArray;if(r&&r.length>0)for(var i=r.length,o=0;o<i;o++){var n=r[o];if(n instanceof Ur){var a=n.minGeographicCoord,s=n.maxGeographicCoord,l=a.longitude,u=a.latitude,c=s.longitude,d=s.latitude;if(new xe(l,u,a.altitude,c,d,s.altitude).intersects2dWithGeoExtent(e)){if(void 0===n.texture){n.texture=new it,n.texture.setActiveTextureType(2);var h=n.style;if(h){var f=h.imageUrl;n.texture.url=f;var g=!1;at.loadTexture(f,n.texture,this.magoManager,g)}}else n.texture.texId instanceof WebGLTexture||(n.texture.blob?at.newWebGlTextureByBlob(gl,n.texture.blob,n.texture):n.texture.url&&at.loadTexture(n.texture.url,n.texture,this.magoManager,g));var p=e.minGeographicCoord.longitude,m=e.minGeographicCoord.latitude,v=e.maxGeographicCoord.longitude-p,x=e.maxGeographicCoord.latitude-m,_=(l-p)/v,y=(u-m)/x,T=(c-p)/v,C=(d-m)/x;n.texture.temp_clampToTerrainTexCoord=new Float32Array([_,y,T,C]),void 0===t&&(t=[]),t.push(n)}}}return t},gr.prototype.getTerrainType=function(){return this.terrainType},gr.prototype.setMaxDepth=function(e){this.maxDepth=e},gr.prototype.init=function(){if(this.imageryType===I.imageryType.WEB_MERCATOR){this.tinTerrainQuadTreeMercator=new fr(void 0);var e=180*(2*Math.atan(Math.pow(Math.E,Math.PI))-Math.PI/2)/Math.PI,t=-180,r=-90,i=0,o=180,n=90,a=0;r=-e,n=e,this.tinTerrainQuadTreeMercator.setGeographicExtent(t,r,i,o,n,a),this.tinTerrainQuadTreeMercator.setWebMercatorExtent(-1,-Math.PI,1,Math.PI),this.tinTerrainQuadTreeMercator.X=0,this.tinTerrainQuadTreeMercator.Y=0,this.tinTerrainQuadTreeMercator.indexName="RU",this.tinTerrainQuadTreeMercator.tinTerrainManager=this}else{this.tinTerrainsQuadTreeAsia=new fr(void 0),this.tinTerrainsQuadTreeAmerica=new fr(void 0);t=0,r=-90,i=0,o=180,n=90,a=0;this.tinTerrainsQuadTreeAsia.setGeographicExtent(t,r,i,o,n,a),this.tinTerrainsQuadTreeAsia.setWebMercatorExtent(0,-Math.PI,1,Math.PI),this.tinTerrainsQuadTreeAsia.X=1,this.tinTerrainsQuadTreeAsia.Y=0,this.tinTerrainsQuadTreeAsia.indexName="RU",this.tinTerrainsQuadTreeAsia.tinTerrainManager=this,t=-180,r=-90,i=0,o=0,n=90,a=0,this.tinTerrainsQuadTreeAmerica.setGeographicExtent(t,r,i,o,n,a),this.tinTerrainsQuadTreeAmerica.setWebMercatorExtent(-1,-Math.PI,0,Math.PI),this.tinTerrainsQuadTreeAmerica.X=0,this.tinTerrainsQuadTreeAmerica.Y=0,this.tinTerrainsQuadTreeAmerica.indexName="LU",this.tinTerrainsQuadTreeAmerica.tinTerrainManager=this}this.makeDistanceLimitByDepth(),this.loadTerrainMeta()},gr.prototype.loadTerrainMeta=function(){var e=this;if(e.terrainType!==I.magoEarthTerrainType.PLAIN){if(e.terrainType===I.magoEarthTerrainType.ELEVATION&&e.terrainValue&&!e.terrainReady){var t=e.terrainValue+gr.INFO_FILE,r=rn(t,void 0,void 0,"json");r.then(function(t){e.terrainTilesInfo=t,e.terrainReady=!0}),r.catch(function(){console.warn("Invalid or not exist "+gr.INFO_FILE),e.terrainType=I.magoEarthTerrainType.PLAIN,e.terrainReady=!0})}}else e.terrainReady=!0},gr.prototype.makeTinTerrainWithDEMIndex=function(){this.tinTerrainWithDEMIndex=[],this.tinTerrainWithDEMIndex[0]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[1]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[2]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[3]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[4]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[5]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[6]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[7]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[8]={minX:213,minY:94,maxX:222,maxY:105},this.tinTerrainWithDEMIndex[9]={minX:425,minY:189,maxX:443,maxY:211},this.tinTerrainWithDEMIndex[10]={minX:852,minY:376,maxX:885,maxY:423},this.tinTerrainWithDEMIndex[11]={minX:1705,minY:753,maxX:1770,maxY:844},this.tinTerrainWithDEMIndex[12]={minX:3412,minY:1506,maxX:3539,maxY:1689},this.tinTerrainWithDEMIndex[13]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[14]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[15]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[16]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[17]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[18]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[19]={minX:-1,minY:-1,maxX:-1,maxY:-1},this.tinTerrainWithDEMIndex[20]={minX:-1,minY:-1,maxX:-1,maxY:-1}},gr.prototype.makeDistanceLimitByDepth=function(){void 0===this.distLimitByDepth&&(this.distLimitByDepth=[]),this.distLimitByDepth[0]=1e8,this.distLimitByDepth[1]=4e7,this.distLimitByDepth[2]=2e7,this.distLimitByDepth[3]=12e6,this.distLimitByDepth[4]=6e6,this.distLimitByDepth[5]=3e6,this.distLimitByDepth[6]=1e6,this.distLimitByDepth[7]=6e5,this.distLimitByDepth[8]=2e5,this.distLimitByDepth[9]=1e5,this.distLimitByDepth[10]=6e4,this.distLimitByDepth[11]=3e4,this.distLimitByDepth[12]=9e3,this.distLimitByDepth[13]=6e3,this.distLimitByDepth[14]=4e3,this.distLimitByDepth[15]=2e3,this.distLimitByDepth[16]=800,this.distLimitByDepth[17]=400,this.distLimitByDepth[18]=200,this.distLimitByDepth[19]=100,this.distLimitByDepth[20]=50},gr.prototype.getTexCorrection=function(e){return void 0===this.texCorrection&&(this.texCorrection=[],this.texCorrection[0]=.003,this.texCorrection[1]=.003,this.texCorrection[2]=.003,this.texCorrection[3]=.003,this.texCorrection[4]=.003,this.texCorrection[5]=.003,this.texCorrection[6]=.003,this.texCorrection[7]=.003,this.texCorrection[8]=.003,this.texCorrection[9]=.003,this.texCorrection[10]=.003,this.texCorrection[11]=.003,this.texCorrection[12]=.003,this.texCorrection[13]=.003,this.texCorrection[14]=.002,this.texCorrection[15]=.002,this.texCorrection[16]=.002,this.texCorrection[17]=.002,this.texCorrection[18]=.002,this.texCorrection[19]=.002,this.texCorrection[20]=.002,this.texCorrection[21]=.002,this.texCorrection[22]=.002),this.texCorrection[e]},gr.prototype.doFrustumCulling=function(e,t,r,i){void 0===i&&(i=this.maxDepth);var o=t.position,n=!1;if(void 0===this.cameraLastPosition&&(this.cameraLastPosition=new Jr(0,0,0)),void 0===this.cameraLastTime&&(this.cameraLastTime=r.getCurrentTime()),void 0===this.cameraStopped&&(this.cameraStopped=!0),o.distToPoint(this.cameraLastPosition)<4){var a=r.getCurrentTime()-this.cameraLastTime;!this.cameraStopped&&a>500&&(this.cameraStopped=!0),this.cameraStopped&&(n=!0,this.cameraLastTime=r.getCurrentTime())}else n=!1,this.cameraStopped=!1;if(this.cameraLastPosition.set(o.x,o.y,o.z),n){this.visibleTilesArray.length=0,this.noVisibleTilesArray.length=0,this.visibleTilesArrayMap=[],this.imageryType===I.imageryType.WEB_MERCATOR?this.tinTerrainQuadTreeMercator.getFrustumIntersectedTinTerrainsQuadTree(e,i,o,r,this.visibleTilesArrayMap,this.noVisibleTilesArray):(this.tinTerrainsQuadTreeAsia.getFrustumIntersectedTinTerrainsQuadTree(e,i,o,r,this.visibleTilesArrayMap,this.noVisibleTilesArray),this.tinTerrainsQuadTreeAmerica.getFrustumIntersectedTinTerrainsQuadTree(e,i,o,r,this.visibleTilesArrayMap,this.noVisibleTilesArray));for(var s=this.maxDepth;s>=0;s--){var l=this.visibleTilesArrayMap[s];l&&l.length>0&&[].push.apply(this.visibleTilesArray,l)}}},gr.prototype.prepareVisibleTinTerrains=function(e){var t;if(this.visibleTilesArrayMap){this.tinTerrainQuadTreeMercator.childMap&&(this.tinTerrainQuadTreeMercator.childMap.LU&&this.tinTerrainQuadTreeMercator.childMap.LU.prepareTinTerrainForward(e,this),this.tinTerrainQuadTreeMercator.childMap.LD&&this.tinTerrainQuadTreeMercator.childMap.LD.prepareTinTerrainForward(e,this),this.tinTerrainQuadTreeMercator.childMap.RU&&this.tinTerrainQuadTreeMercator.childMap.RU.prepareTinTerrainForward(e,this),this.tinTerrainQuadTreeMercator.childMap.RD&&this.tinTerrainQuadTreeMercator.childMap.RD.prepareTinTerrainForward(e,this));for(var r=0;r<=this.maxDepth;r++)for(var i=0,o=this.noVisibleTilesArray.length,n=0;n<o&&(void 0!==(t=this.noVisibleTilesArray[n])&&t.depth>2&&(t.deleteTinTerrain(e),i++),!(i>50));n++);}},gr.prototype.prepareVisibleTinTerrainsTextures=function(e){var t;if(this.visibleTilesArrayMap)for(var r=this.maxDepth;r>0&&!(e.fileRequestControler.tinTerrainTexturesRequested>=5);r--){var i=this.visibleTilesArrayMap[r];if(i&&i.length>0){var o=i.length;if(this.terrainType===I.magoEarthTerrainType.PLAIN)for(var n=0;n<o&&!((t=i[n]).isMeshPrepared()&&t.prepareTexture(t.texture,this.imagerys,e,this)>0);n++);else if(this.terrainType===I.magoEarthTerrainType.ELEVATION){var a=0;for(n=0;n<o&&!((t=i[n]).isVisible()&&t.prepareTexture(t.texture,this.imagerys,e,this)>0)&&!(e.fileRequestControler.tinTerrainTexturesRequested>=6);n++);}else if(this.terrainType===I.magoEarthTerrainType.REALTIME)for(a=0,n=0;n<o&&((t=i[n]).prepareTinTerrainRealTimeElevation(e,this)||(a+=1),!(a>5));n++);}}},gr.prototype.getAltitudes=function(e,t){for(var r=e.length,i=0;i<r;i++)e[i]},gr.prototype.render=function(e,t,r,i){var o,n=e.sceneState,a=n.gl;(o=i||e.postFxShadersManager.getShader("tinTerrain")).resetLastBuffersBinded(),e.postFxShadersManager.useProgram(o),o.enableVertexAttribArray(o.position3_loc),t?o.disableVertexAttribArray(o.texCoord2_loc):o.enableVertexAttribArray(o.texCoord2_loc),o.bindUniformGenerals(),e.test__makingTerrainByAltitudesImage=0,0===r&&(a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null)),void 0===this.identityMat&&(this.identityMat=new Ne),a.uniform1i(o.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth);var s=n.getProjectionMatrixInv();if(a.uniformMatrix4fv(o.projectionMatrixInv_loc,!1,s._floatArrays),a.uniform1i(o.uRenderType_loc,1),a.uniform1f(o.uFCoef_logDepth_loc,n.fCoef_logDepth[0]),1===r){e.texturesStore.getTextureAux1x1();a.activeTexture(a.TEXTURE2),a.bindTexture(a.TEXTURE_2D,null),a.uniform1i(o.colorType_loc,2),a.uniform4fv(o.oneColor4_loc,[.5,.5,.5,1]),a.uniform1i(o.refMatrixType_loc,0),a.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,this.identityMat._floatArrays),a.uniform1i(o.bApplyCaustics_loc,!1),a.uniform1i(o.bExistAltitudes_loc,!1);var l=!0;e.isCesiumGlobe()&&(l=!1),a.uniform1i(o.textureFlipYAxis_loc,l),a.uniform1f(o.externalAlpha_loc,1),a.activeTexture(a.TEXTURE2)}var u=[];a.depthRange(0,1),this.tinTerrainQuadTreeMercator.childMap&&(this.tinTerrainQuadTreeMercator.childMap.LU&&this.tinTerrainQuadTreeMercator.childMap.LU.renderForward(o,e,t,r,u),this.tinTerrainQuadTreeMercator.childMap.LD&&this.tinTerrainQuadTreeMercator.childMap.LD.renderForward(o,e,t,r,u),this.tinTerrainQuadTreeMercator.childMap.RU&&this.tinTerrainQuadTreeMercator.childMap.RU.renderForward(o,e,t,r,u),this.tinTerrainQuadTreeMercator.childMap.RD&&this.tinTerrainQuadTreeMercator.childMap.RD.renderForward(o,e,t,r,u)),a.depthRange(0,1),a.depthFunc(a.LEQUAL),o.disableVertexAttribArray(o.texCoord2_loc),o.disableVertexAttribArray(o.position3_loc),o.disableVertexAttribArray(o.normal3_loc),o.disableVertexAttribArray(o.color4_loc),e.postFxShadersManager.useProgram(null),this.renderingFase+=1,this.renderingFase>1e6&&(this.renderingFase=0)},gr.prototype.addImageryLayer=function(e){var t=this;e.on(ot.EVENT_TYPE.CHANGEOPACITY,function(e){t.imageryLayersChanged()}),e.on(ot.EVENT_TYPE.CHANGESHOW,function(e){t.imageryLayersChanged()}),this.imagerys.push(e),this.imageryLayersChanged()},gr.prototype.addTextureId=function(e){this.textureIdCntMap[e]||(this.textureIdCntMap[e]=0),this.textureIdCntMap[e]+=1},gr.prototype.addDeleteTextureId=function(e){this.textureIdDeleteMap[e]||(this.textureIdDeleteMap[e]=0),this.textureIdDeleteMap[e]+=1},gr.prototype.eraseTexture=function(e,t){var r=t.sceneState.gl,i=e.imagery._id;e.deleteObjects(r),this.addDeleteTextureId(i),this.clearMap(i),this.imageryLayersChanged()},gr.prototype.clearMap=function(e){this.textureIdDeleteMap[e]===this.textureIdCntMap[e]&&(delete this.textureIdDeleteMap[e],delete this.textureIdCntMap[e]),this.imageryLayersChanged()};var pr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._itineraryManager,this._fileLoadState=I.fileLoadState.READY,this._filePath,this._jsonFile,this._isPrepared=!1,this.vectorMesh,this._animationStartTime=0,this._totalItineraryTimeSec,this._animatedIcon,this._WM_vboKeysContainer,this._layerShow=!0,this._samplingDataObj={},this._samplingData_vboKeysContainer,this._bRenderSampledPoints=!0,this._sampledPointsDepthTest=!0,this._timeScale=2e3,this._lineThickness=4,this._thickLineColor,this._thisckLineDepthTest=!0,this._walkingManMosaicTexIsPrepared=!1,this._walkingManAnimatedIconFilePath=void 0,void 0!==t&&(t.filePath&&(this._filePath=t.filePath),t.lineThickness&&(this._lineThickness=t.lineThickness),t.jsonFile&&(this._jsonFile=t.jsonFile,this._fileLoadState=I.fileLoadState.LOADING_FINISHED),t.thickLineColor&&(this._thickLineColor=new J(t.thickLineColor.r,t.thickLineColor.g,t.thickLineColor.b,t.thickLineColor.a)),t.animatedIconFilePath&&(this._walkingManAnimatedIconFilePath=t.animatedIconFilePath),void 0!==t.thickLineDepthTest&&(this._thisckLineDepthTest=t.thickLineDepthTest),void 0!==t.sampledPointsDepthTest&&(this._sampledPointsDepthTest=t.sampledPointsDepthTest))};pr.prototype.deleteObjects=function(e){for(var t in this._itineraryManager=void 0,this._fileLoadState=void 0,this._filePath=void 0,this._jsonFile)this._jsonFile.hasOwnProperty(t)&&delete this._jsonFile[t];this._jsonFile=void 0,this._isPrepared=void 0,this.vectorMesh&&(this.vectorMesh.deleteObjects(e),this.vectorMesh=void 0),this._animationStartTime=void 0,this._totalItineraryTimeSec=void 0,this._animatedIcon&&(this._animatedIcon.deleteObjects(e),this._animatedIcon=void 0),this._WM_vboKeysContainer&&(this._WM_vboKeysContainer.deleteGlObjects(e.gl,e),this._WM_vboKeysContainer=void 0),this._samplingDataObj=void 0,this._samplingData_vboKeysContainer&&(this._samplingData_vboKeysContainer.deleteGlObjects(e.gl,e),this._samplingData_vboKeysContainer=void 0),this._timeScale=void 0,this._lineThickness=void 0,this._thickLineColor&&(this._thickLineColor.deleteObjects(),this._thickLineColor=void 0)},pr.prototype.setRenderSampledPoints=function(e){this._bRenderSampledPoints=e},pr.prototype.setLayerShow=function(e){this._layerShow=e},pr.prototype.getLayerShow=function(){return this._layerShow},pr.prototype.setThickLineDepthTest=function(e){this._thisckLineDepthTest=e},pr.prototype.setSampledPointsDepthTest=function(e){this._sampledPointsDepthTest=e},pr.prototype.getThickLineDepthTest=function(){return this._thisckLineDepthTest},pr.prototype.getSampledPointsDepthTest=function(){return this._sampledPointsDepthTest},pr.prototype._prepareWalkingManTexture=function(){if(this._walkingManMosaicTexIsPrepared)return!0;if(void 0===this._walkingManAnimatedIconFilePath)return!1;if(void 0===this._walkingManAnimatedIcon&&(this._walkingManAnimatedIcon=new ki,this._walkingManAnimatedIcon._mosaicTexture=new it),this._walkingManAnimatedIcon._mosaicTexture.fileLoadState===I.fileLoadState.READY){this._walkingManAnimatedIcon._filePath=this._walkingManAnimatedIconFilePath;return at.loadTexture(this._walkingManAnimatedIcon._filePath,this._walkingManAnimatedIcon._mosaicTexture,this._itineraryManager.magoManager,!1),!1}return this._walkingManAnimatedIcon._mosaicTexture.fileLoadState===I.fileLoadState.BINDING_FINISHED&&(this._walkingManMosaicTexIsPrepared=!0),this._walkingManMosaicTexIsPrepared},pr.prototype._prepare=function(){if(this._isPrepared)return!0;if(this._fileLoadState===I.fileLoadState.READY){this._fileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._filePath,void 0,void 0,"json","GET").done(function(t){e._fileLoadState=I.fileLoadState.LOADING_FINISHED,e._jsonFile=t})}if(this._fileLoadState!==I.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this._makingMeshProcess&&(this._makingMeshProcess=I.processState.NO_STARTED),this._makingMeshProcess===I.processState.NO_STARTED){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var t=this.geoLocDataManager.getCurrentGeoLocationData();void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default"));var r=this._itineraryManager.magoManager,i=this._jsonFile.centerGeographicCoord;t=on.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,0,0,0,t);var o=new Float32Array(this._jsonFile.localPositions),n=Qr.float32ArrayToPoints3DArray(o,void 0),a={};this.vectorMesh=_o.getVectorMeshItineraryFromPoints3dLCArray(n,t,r,a),this.vectorMesh.thickness=this._lineThickness,void 0===this._thickLineColor&&(this._thickLineColor=new J,J.getColorPastelRGBRandom(this._thickLineColor)),void 0===this.vectorMesh.color4&&(this.vectorMesh.color4=new J),this.vectorMesh.color4.setRGB(this._thickLineColor.r,this._thickLineColor.g,this._thickLineColor.b),this._segmentsInfoArray=[];var s=this._jsonFile.nodes.length;this._totalItineraryTimeSec=0;for(var l=0;l<s-1;l++){var u=this._jsonFile.nodes[l],c=this._jsonFile.nodes[l+1],d=u.date,h=c.date,f=new Date;f.setFullYear(d.year),f.setMonth(d.month-1),f.setDate(d.day),f.setHours(d.hour),f.setMinutes(d.minute);var g=f.getTime(),p=new Date;p.setFullYear(h.year),p.setMonth(h.month-1),p.setDate(h.day),p.setHours(h.hour),p.setMinutes(h.minute);var m=(p.getTime()-g)/1e3,v=new Jr(n[l].x,n[l].y,n[l].z),x=new Jr(n[l+1].x,n[l+1].y,n[l+1].z),_=v.distToPoint(x),y=_/m;this._segmentsInfoArray[l]={dist:_,unixTimeMillisecond:g,diffTimeSec:m,velocity_metersSec:y,startPosLC:v,endPosLC:x},this._totalItineraryTimeSec+=m}return this._makingMeshProcess=I.processState.FINISHED,!1}if(void 0===this._animatedIcon){a={};this._animatedIcon=new ki(a)}return!(void 0!==this._walkingManAnimatedIconFilePath&&!this._prepareWalkingManTexture())&&(this._isPrepared=!0,this._isPrepared)},pr.prototype.render=function(e,t){if(!this._prepare())return!1;if(t){var r=this._itineraryManager.magoManager,i=r.getGl(),o=this.vectorMesh;i.uniform4fv(e.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(e.colorType_loc,0),i.uniform1f(e.thickness_loc,o.thickness);o.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,e),this._thisckLineDepthTest?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST),o.render(r,e,1),i.enable(i.DEPTH_TEST)}return!0},pr.prototype._getWalkingManPositionLC_forIncreTimeSec=function(e,t){if(void 0!==this._segmentsInfoArray&&0!==this._segmentsInfoArray.length){var r=this._segmentsInfoArray.length,i=!1,o=0,n=e;for(void 0===t&&(t=new Jr);!i&&o<r;){(h=this._segmentsInfoArray[o]).dist;var a=h.velocity_metersSec,s=h.diffTimeSec,l=a*n;if(s<n)n-=s;else{i=!0;var u=h.startPosLC,c=h.endPosLC;if(l<1e-12)void 0===t&&(t=new Jr),t.set(u.x,u.y,u.z);else{var d=u.getVectorToPoint(c,void 0);d.unitary(),void 0===t&&(t=new Jr),t.set(u.x+d.x*l,u.y+d.y*l,u.z+d.z*l)}}o++}if(!i){var h;c=(h=this._segmentsInfoArray[r-1]).endPosLC;t.set(c.x,c.y,c.z)}return t}},pr.prototype._getWalkingManPositionWC_forIncreTimeSec=function(e,t){var r=this._getWalkingManPositionLC_forIncreTimeSec(e,void 0);if(void 0!==r&&void 0!==this.vectorMesh)return void 0===t&&(t=new Jr),t=this.vectorMesh.geoLocDataManager.getCurrentGeoLocationData().localCoordToWorldCoord(r,t)},pr.prototype._getSegmentIdx_forUnixTimeMillisec=function(e){if(void 0!==this._segmentsInfoArray&&0!==this._segmentsInfoArray.length){var t=this._segmentsInfoArray.length,r=!1,i=0;if(e>this._segmentsInfoArray[t-1].unixTimeMillisecond)return t-1;for(;!r&&i<t-1;){var o=this._segmentsInfoArray[i],n=this._segmentsInfoArray[i+1],a=o.unixTimeMillisecond,s=n.unixTimeMillisecond;if(a<e&&e<s)return r=!0,i;i++}return-1}},pr.prototype._getWalkingManPositionLC_forUnixTimeMillisec=function(e,t){if(void 0!==this._segmentsInfoArray&&0!==this._segmentsInfoArray.length){var r=this._segmentsInfoArray.length,i=!0;void 0===t&&(t=new Jr);var o=this._getSegmentIdx_forUnixTimeMillisec(e);if(-1===o&&(i=!1),i){(c=this._segmentsInfoArray[o]).dist;var n=c.velocity_metersSec,a=(c.diffTimeSec,n*((e-c.unixTimeMillisecond)/1e3)),s=c.startPosLC,l=c.endPosLC;if(a<1e-12)void 0===t&&(t=new Jr),t.set(s.x,s.y,s.z);else{var u=s.getVectorToPoint(l,void 0);u.unitary(),void 0===t&&(t=new Jr),t.set(s.x+u.x*a,s.y+u.y*a,s.z+u.z*a)}}if(!i){var c;l=(c=this._segmentsInfoArray[r-1]).endPosLC;t.set(l.x,l.y,l.z)}return t}},pr.prototype._getWalkingManPositionWC_forUnixTimeMillisec=function(e,t){var r=this._getWalkingManPositionLC_forUnixTimeMillisec(e,void 0);if(void 0!==r&&void 0!==this.vectorMesh)return void 0===t&&(t=new Jr),t=this.vectorMesh.geoLocDataManager.getCurrentGeoLocationData().localCoordToWorldCoord(r,t)},pr.prototype._getDiffTimeSec=function(e){var t=(e-this._animationStartTime)/1e3;return t*=this._timeScale},pr.prototype.getTotalItineraryTime=function(){if(void 0===this._totalItineraryTimeSec){this._totalItineraryTimeSec=0;for(var e=this._segmentsInfoArray.length,t=0;t<e;t++)this._totalItineraryTimeSec+=this._segmentsInfoArray[t].diffTimeSec}return this._totalItineraryTimeSec},pr.prototype.sampleWeatherPollution=function(e,t){if(void 0===this.vectorMesh)return!1;var r=this._getDiffTimeSec(e);if(r>this.getTotalItineraryTime())return!1;var i=this._getWalkingManPositionWC_forIncreTimeSec(r,void 0);if(void 0===i)return!1;var o=t.getPollutionValue(i,e);if(void 0===o)return!1;var n=t._getMinMaxQuantizedValues();if(void 0===n)return!1;if(void 0===this._lastSamplingTime&&(this._lastSamplingTime=0),r-this._lastSamplingTime<this._itineraryManager._samplingDataIncrementTimeMilisec)return!1;this._lastSamplingTime=r,void 0===this._samplingDataObj&&(this._samplingDataObj={});var a=this.vectorMesh.geoLocDataManager.getCurrentGeoLocationData().worldCoordToLocalCoord(i,void 0);void 0===this._samplingDataObj.posLC_floatArray&&(this._samplingDataObj.posLC_floatArray=[]),this._samplingDataObj.posLC_floatArray.push(a.x,a.y,a.z);var s=(o-n[0])/(n[1]-n[0]);void 0===this._samplingDataObj.color4_uIntArray&&(this._samplingDataObj.color4_uIntArray=[]),void 0===this._samplingDataObj.valuesArray&&(this._samplingDataObj.valuesArray=[]),void 0===this._samplingDataObj.timesArray&&(this._samplingDataObj.timesArray=[]),void 0===this._samplingDataObj.positionWCArray&&(this._samplingDataObj.positionWCArray=[]),this._samplingDataObj.timesArray.push(r),this._samplingDataObj.valuesArray.push(o),this._samplingDataObj.positionWCArray.push(i);var l=J.getRainbowColor_byHeight(s,0,.08,!1);if(this._samplingDataObj.color4_uIntArray.push(Math.floor(255*l.r),Math.floor(255*l.g),Math.floor(255*l.b),Math.floor(255*l.a)),void 0===this._samplingData_vboKeysContainer){this._samplingData_vboKeysContainer=new xt;this._samplingData_vboKeysContainer.newVBOVertexIdxCacheKey()}var u=this._itineraryManager.magoManager,c=this._samplingData_vboKeysContainer.getVboKey(0),d=new Float32Array(this._samplingDataObj.posLC_floatArray),h=new Uint8Array(this._samplingDataObj.color4_uIntArray);return c.deleteGlObjects(u.vboMemoryManager),c.setDataArrayPos(d,u.vboMemoryManager),c.setDataArrayCol(h,u.vboMemoryManager),!0},pr.prototype.deleteSamplePoints=function(){if(void 0!==this._samplingData_vboKeysContainer){var e=this._itineraryManager.magoManager;this._samplingData_vboKeysContainer.getVboKey(0).deleteGlObjects(e.vboMemoryManager),this._samplingData_vboKeysContainer=void 0}void 0!==this._samplingDataObj&&(this._samplingDataObj.posLC_floatArray=void 0,this._samplingDataObj.color4_uIntArray=void 0,this._samplingDataObj.valuesArray=void 0,this._samplingDataObj.timesArray=void 0,this._samplingDataObj.positionWCArray=void 0),this._lastSamplingTime=void 0,this._lastSamplingUnixTime=void 0},pr.prototype.resetSampledPoints=function(){if(this._samplingDataObj.color4_uIntArray=void 0,this._samplingDataObj.valuesArray=void 0,this._samplingDataObj.timesArray=void 0,this._samplingDataObj.positionWCArray=void 0,this._samplingData_vboKeysContainer){var e=this._itineraryManager.magoManager;this._samplingData_vboKeysContainer.deleteGlObjects(e.vboMemoryManager.gl,e.vboMemoryManager),this._samplingData_vboKeysContainer=void 0}},pr.prototype.sampleChemicalContamination=function(e,t){if(void 0===this.vectorMesh)return!1;var r=this._getWalkingManPositionWC_forUnixTimeMillisec(e,void 0);if(void 0===r)return!1;var i=t.getContaminationValue(r,e);if(void 0===i)return!1;var o=t.getMinMaxPollutionValues();if(void 0===o)return!1;var n=(u=this._itineraryManager.magoManager).animationTimeController;if(void 0===this._lastSamplingUnixTime&&(this._lastSamplingUnixTime=n.getCurrentUnixTimeMilisec()),e-this._lastSamplingUnixTime<this._itineraryManager._samplingDataIncrementTimeMilisec)return!1;this._lastSamplingUnixTime=e,void 0===this._samplingDataObj&&(this._samplingDataObj={});var a=this.vectorMesh.geoLocDataManager.getCurrentGeoLocationData();this._walkingManCurrPosLC=a.worldCoordToLocalCoord(r,void 0),void 0===this._samplingDataObj.posLC_floatArray&&(this._samplingDataObj.posLC_floatArray=[]),this._samplingDataObj.posLC_floatArray.push(this._walkingManCurrPosLC.x,this._walkingManCurrPosLC.y,this._walkingManCurrPosLC.z);var s=(i-o[0])/(o[1]-o[0]);if(s>0);void 0===this._samplingDataObj.color4_uIntArray&&(this._samplingDataObj.color4_uIntArray=[]),void 0===this._samplingDataObj.valuesArray&&(this._samplingDataObj.valuesArray=[]),void 0===this._samplingDataObj.timesArray&&(this._samplingDataObj.timesArray=[]),void 0===this._samplingDataObj.positionWCArray&&(this._samplingDataObj.positionWCArray=[]),this._samplingDataObj.timesArray.push(e),this._samplingDataObj.valuesArray.push(i),this._samplingDataObj.positionWCArray.push(r);o[1];var l=J.getRainbowColor_byHeight(s,0,1e-5,!1);if(this._samplingDataObj.color4_uIntArray.push(Math.floor(255*l.r),Math.floor(255*l.g),Math.floor(255*l.b),Math.floor(255*l.a)),void 0===this._samplingData_vboKeysContainer){this._samplingData_vboKeysContainer=new xt;this._samplingData_vboKeysContainer.newVBOVertexIdxCacheKey()}var u=this._itineraryManager.magoManager,c=this._samplingData_vboKeysContainer.getVboKey(0),d=new Float32Array(this._samplingDataObj.posLC_floatArray),h=new Uint8Array(this._samplingDataObj.color4_uIntArray);return c.deleteGlObjects(u.vboMemoryManager),c.setDataArrayPos(d,u.vboMemoryManager),c.setDataArrayCol(h,u.vboMemoryManager),!0},pr.prototype.getSampledData=function(){return this._samplingDataObj},pr.prototype.renderSampledPoints=function(){if(!this._prepare())return!1;if(void 0===this._segmentsInfoArray||0===this._segmentsInfoArray.length)return!1;if(void 0===this._walkingManCurrPosLC)return!1;var e=this._itineraryManager.magoManager;if(void 0===this._animationStartTime&&(this._animationStartTime=0),!this._bRenderSampledPoints)return!1;var t=this._itineraryManager._samplePointsSize,r=e.getGl(),i=e.sceneState,o=e.postFxShadersManager.getShader("pointsCloudSsao");e.postFxShadersManager.useProgram(o),o.disableVertexAttribArrayAll(),o.resetLastBuffersBinded(),o.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals(),r.uniform1i(o.bPositionCompressed_loc,!1),r.uniform1i(o.bUse1Color_loc,!0),r.uniform4fv(o.oneColor4_loc,[.1,1,.1,1]),r.uniform1f(o.fixPointSize_loc,t),r.uniform1i(o.bUseFixPointSize_loc,1),r.uniform1f(o.externalAlpha_loc,1);var n=e.magoPolicy.getPointsCloudSettings();if(r.uniform1f(o.maxPointSize_loc,parseInt(n.maxPointSize)),r.uniform1f(o.minPointSize_loc,parseInt(n.minPointSize)),r.uniform1f(o.pendentPointSize_loc,parseInt(n.pendentPointSize)),r.uniform1i(o.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),r.uniform1i(o.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),r.uniform1f(o.uFCoef_logDepth_loc,i.fCoef_logDepth[0]),r.uniform2fv(o.uNearFarArray_loc,e.frustumVolumeControl.nearFarArray),r.uniform1i(o.uFrustumIdx_loc,e.currentFrustumIdx),this.vectorMesh.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,o),void 0===this._WM_vboKeysContainer){this._WM_vboKeysContainer=new xt;var a=this._WM_vboKeysContainer.newVBOVertexIdxCacheKey()}var s=new Float32Array(3);if(s[0]=this._walkingManCurrPosLC.x,s[1]=this._walkingManCurrPosLC.y,s[2]=this._walkingManCurrPosLC.z,(a=this._WM_vboKeysContainer.getVboKey(0)).deleteGlObjects(e.vboMemoryManager),a.setDataArrayPos(s,e.vboMemoryManager),!a.bindDataPosition(o,e.vboMemoryManager))return!1;r.depthRange(0,.1),r.drawArrays(r.POINTS,0,a.vertexCount);var l=this._bRenderSampledPoints;if(void 0===this._samplingDataObj&&(l=!1),void 0===this._samplingData_vboKeysContainer&&(l=!1),l){var u=this._samplingData_vboKeysContainer.getVboKey(0);if(!u.bindDataPosition(o,e.vboMemoryManager))return r.depthRange(0,1),!1;u.bindDataColor(o,e.vboMemoryManager)?(o.enableVertexAttribArray(o.color4_loc),r.uniform1i(o.bUse1Color_loc,!1)):(o.disableVertexAttribArray(o.color4_loc),r.uniform1i(o.bUse1Color_loc,!0)),this._sampledPointsDepthTest?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.drawArrays(r.POINTS,0,u.vertexCount),r.enable(r.DEPTH_TEST)}};var mr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager,this._itineraryLayersArray,this._walkingManAnimatedIcon,this._walkingManMosaicTexIsPrepared=!1,this._renderThickLine=!0,this._samplePointsSize=5,this._samplingDataIncrementTimeMilisec=200,void 0!==t&&(void 0!==t.magoManager&&(this.magoManager=t.magoManager),void 0!==t.walkingManMosaicTexPath&&void 0===this._walkingManAnimatedIcon&&(this._walkingManAnimatedIcon=new ki,this._walkingManAnimatedIcon._mosaicTexture=new it,this._walkingManAnimatedIcon._filePath=t.walkingManMosaicTexPath),void 0!==t.walkingManMosaicColumnsCount&&(this._walkingManAnimatedIcon._mosaicSize[0]=t.walkingManMosaicColumnsCount),void 0!==t.walkingManMosaicRowsCount&&(this._walkingManAnimatedIcon._mosaicSize[1]=t.walkingManMosaicRowsCount),void 0!==t.samplingDataIncrementTimeMilisec&&(this._samplingDataIncrementTimeMilisec=t.samplingDataIncrementTimeMilisec),void 0!==t.renderThickLine&&(this._renderThickLine=t.renderThickLine),void 0!==t.samplePointsSize&&(this._samplePointsSize=t.samplePointsSize)),void 0!==this.magoManager&&this.createDefaultShaders()};mr.prototype.loadItineraryJsonFile=function(e){var t={filePath:e};this.newItineraryLayer(t)},mr.prototype.newItineraryLayer=function(e){void 0===this._itineraryLayersArray&&(this._itineraryLayersArray=[]);var t=new pr(e);return t._itineraryManager=this,this._itineraryLayersArray.push(t),t},mr.prototype.getItineraryLayersCount=function(){return void 0===this._itineraryLayersArray?0:this._itineraryLayersArray.length},mr.prototype.getItineraryLayer=function(e){if(void 0!==this._itineraryLayersArray)return this._itineraryLayersArray[e]},mr.prototype._prepareWalkingManTexture=function(){if(this._walkingManMosaicTexIsPrepared)return!0;if(void 0===this._walkingManAnimatedIcon&&(this._walkingManAnimatedIcon=new ki,this._walkingManAnimatedIcon._mosaicTexture=new it),this._walkingManAnimatedIcon._mosaicTexture.fileLoadState===I.fileLoadState.READY){return at.loadTexture(this._walkingManAnimatedIcon._filePath,this._walkingManAnimatedIcon._mosaicTexture,this.magoManager,!1),!1}return this._walkingManAnimatedIcon._mosaicTexture.fileLoadState===I.fileLoadState.BINDING_FINISHED&&(this._walkingManMosaicTexIsPrepared=!0),this._walkingManMosaicTexIsPrepared},mr.prototype.deleteObjects=function(e){if(this.magoManager=void 0,this._itineraryLayersArray&&this._itineraryLayersArray.length>0){for(var t=this._itineraryLayersArray.length,r=0;r<t;r++)this._itineraryLayersArray[r].deleteObjects(e),this._itineraryLayersArray[r]=void 0;this._itineraryLayersArray.length=0}this._itineraryLayersArray=void 0,this._walkingManAnimatedIcon&&this._walkingManAnimatedIcon.deleteObjects(e),this._walkingManMosaicTexIsPrepared=void 0,this._samplingDataIncrementTimeMilisec=void 0},mr.prototype.sampleWeatherPollution=function(e,t){if(void 0===this._itineraryLayersArray)return!1;var r=this.getItineraryLayersCount();if(0===r)return!1;for(var i=0;i<r;i++){this.getItineraryLayer(i).sampleWeatherPollution(e,t)}return!0},mr.prototype.deleteSamplePoints=function(){for(var e=this.getItineraryLayersCount(),t=0;t<e;t++){this.getItineraryLayer(t).deleteSamplePoints()}},mr.prototype.sampleChemicalContamination=function(e,t){if(void 0===this._itineraryLayersArray)return!1;if(this.magoManager.animationTimeController._animationState===I.processState.PAUSED)return!1;var r=this.getItineraryLayersCount();if(0===r)return!1;for(var i=0;i<r;i++){this.getItineraryLayer(i).sampleChemicalContamination(e,t)}return!0},mr.prototype.resetSampledPoints=function(){for(var e=this.getItineraryLayersCount(),t=0;t<e;t++){this.getItineraryLayer(t).resetSampledPoints()}},mr.prototype.render=function(){if(void 0===this._itineraryLayersArray)return!1;var e=this.getItineraryLayersCount();if(0===e)return!1;var t=this.magoManager,r=t.sceneState,i=t.extbuffers,o=t.getGl();t.bindMainFramebuffer(),o.framebufferTexture2D(o.FRAMEBUFFER,i.COLOR_ATTACHMENT1_WEBGL,o.TEXTURE_2D,t.depthTex,0),o.framebufferTexture2D(o.FRAMEBUFFER,i.COLOR_ATTACHMENT2_WEBGL,o.TEXTURE_2D,t.normalTex,0),o.framebufferTexture2D(o.FRAMEBUFFER,i.COLOR_ATTACHMENT3_WEBGL,o.TEXTURE_2D,t.albedoTex,0),i.drawBuffersWEBGL([i.COLOR_ATTACHMENT0_WEBGL,i.COLOR_ATTACHMENT1_WEBGL,i.COLOR_ATTACHMENT2_WEBGL,i.COLOR_ATTACHMENT3_WEBGL]);var n=t.postFxShadersManager.getShader("thickLine");n.useProgram(),n.bindUniformGenerals(),o.enableVertexAttribArray(n.prev_loc),o.enableVertexAttribArray(n.current_loc),o.enableVertexAttribArray(n.next_loc),o.uniform2fv(n.viewport_loc,[r.drawingBufferWidth[0],r.drawingBufferHeight[0]]),o.uniform1i(n.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),o.uniform1i(n.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),o.uniform1i(n.uFrustumIdx_loc,t.currentFrustumIdx),o.uniform1i(n.bUseOutline_loc,!1),o.blendEquationSeparate(o.FUNC_ADD,o.FUNC_ADD),o.blendFuncSeparate(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA,o.ONE,o.ONE_MINUS_SRC_ALPHA),o.enable(o.BLEND);for(var a=!0,s=0;s<e;s++){!1!==(h=this.getItineraryLayer(s))._layerShow&&(h.render(n,this._renderThickLine)||(a=!1))}if(o.useProgram(null),o.disable(o.BLEND),!a)return!1;o.framebufferTexture2D(o.FRAMEBUFFER,i.COLOR_ATTACHMENT1_WEBGL,o.TEXTURE_2D,null,0),o.framebufferTexture2D(o.FRAMEBUFFER,i.COLOR_ATTACHMENT2_WEBGL,o.TEXTURE_2D,null,0),o.framebufferTexture2D(o.FRAMEBUFFER,i.COLOR_ATTACHMENT3_WEBGL,o.TEXTURE_2D,t.albedoTex,0),i.drawBuffersWEBGL([i.COLOR_ATTACHMENT0_WEBGL,i.NONE,i.NONE,i.COLOR_ATTACHMENT3_WEBGL]);for(s=0;s<e;s++){!1!==(h=this.getItineraryLayer(s))._layerShow&&h.renderSampledPoints()}if(!this._prepareWalkingManTexture())return!1;var l=t.postFxShadersManager.getShader("animatedIcon");l.resetLastBuffersBinded();var u=l.program;o.useProgram(u),l.bindUniformGenerals(),t.effectsManager.setCurrentShader(l),o.uniformMatrix4fv(l.modelViewProjectionMatrix4RelToEye_loc,!1,t.sceneState.modelViewProjRelToEyeMatrix._floatArrays),o.uniform3fv(l.cameraPosHIGH_loc,t.sceneState.encodedCamPosHigh),o.uniform3fv(l.cameraPosLOW_loc,t.sceneState.encodedCamPosLow),o.uniformMatrix4fv(l.buildingRotMatrix_loc,!1,t.sceneState.modelViewRelToEyeMatrixInv._floatArrays),o.uniform1f(l.screenWidth_loc,parseFloat(t.sceneState.drawingBufferWidth[0])),o.uniform1f(l.screenHeight_loc,parseFloat(t.sceneState.drawingBufferHeight[0])),o.uniform1i(l.uFrustumIdx_loc,t.currentFrustumIdx),o.uniform2fv(l.uNearFarArray_loc,t.frustumVolumeControl.nearFarArray),o.uniform1i(l.textureFlipYAxis_loc,!0),o.uniform1i(l.texture_loc,0),o.enableVertexAttribArray(l.texCoord2_loc),o.enableVertexAttribArray(l.position4_loc),o.activeTexture(o.TEXTURE0);var c=this._walkingManAnimatedIcon.getPositionBuffer(o);o.bindBuffer(o.ARRAY_BUFFER,c),o.vertexAttribPointer(l.position4_loc,4,o.FLOAT,!1,0,0),o.bindBuffer(o.ARRAY_BUFFER,this._walkingManAnimatedIcon.texcoordBuffer),o.vertexAttribPointer(l.texCoord2_loc,2,o.FLOAT,!1,0,0),o.activeTexture(o.TEXTURE0),o.uniform1i(l.colorType_loc,2),o.uniform4fv(l.oneColor4_loc,[.2,.7,.9,1]),o.uniform2fv(l.scale2d_loc,[1,1]),o.uniform2fv(l.size2d_loc,[60,60]),o.uniform1i(l.bUseOriginalImageSize_loc,!1),o.uniform3fv(l.aditionalOffset_loc,[0,0,0]),o.uniform1iv(l.uMosaicSize_loc,this._walkingManAnimatedIcon._mosaicSize);t.selectionManager;var d=void 0;void 0===this.subImageIdx&&(this.subImageIdx=0),void 0===this.lastTimeSubImageChanged&&(this.lastTimeSubImageChanged=0),o.enable(o.BLEND),o.depthRange(0,.1);for(s=0;s<e;s++){var h;if(!1!==(h=this.getItineraryLayer(s))._layerShow){var f=this._walkingManAnimatedIcon._mosaicTexture;void 0!==h._walkingManAnimatedIcon&&(f=h._walkingManAnimatedIcon._mosaicTexture),o.uniform2fv(l.scale2d_loc,new Float32Array([1,1])),o.uniform2fv(l.imageSize_loc,[f.texId.imageWidth,f.texId.imageHeight]),o.uniform1i(l.uSubImageIdx_loc,this.subImageIdx);var g=h.vectorMesh.geoLocDataManager.getCurrentGeoLocationData();if(g.bindGeoLocationUniforms(o,l),void 0!==g){f.texId!==d&&(o.bindTexture(o.TEXTURE_2D,f.texId),d=f.texId);var p=t.animationTimeController.getCurrentTimeMilisec(),m=t.animationTimeController.getCurrentUnixTimeMilisec(),v=h._getWalkingManPositionWC_forUnixTimeMillisec(m,void 0),x=new Float32Array([0,0,0]),_=new Float32Array([0,0,0]);on.calculateSplited3fv([v.x,v.y,v.z],x,_),o.uniform3fv(l.buildingPosHIGH_loc,x),o.uniform3fv(l.buildingPosLOW_loc,_),o.drawArrays(o.TRIANGLE_STRIP,0,4),p-this.lastTimeSubImageChanged>300&&(this.subImageIdx+=1,this.lastTimeSubImageChanged=p),this.subImageIdx>=this._walkingManAnimatedIcon._mosaicSize[0]*this._walkingManAnimatedIcon._mosaicSize[1]&&(this.subImageIdx=0)}}}o.disable(o.BLEND),o.depthRange(0,1),o.depthMask(!0),o.useProgram(null)},mr.prototype.createDefaultShaders=function(){var e=this.magoManager,t=e.getGl(),r="USE_LINEAR_DEPTH",i="NO_USE_MULTI_RENDER_TARGET";t.getParameter(t.VERSION);e.isCesiumGlobe()||(t.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&t.getExtension("EXT_frag_depth"),e.EXTENSIONS_init=!0,r="USE_LOGARITHMIC_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!0);if(e.postFxShadersManager.bUseMultiRenderTarget=!1,t.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){t.getExtension("WEBGL_draw_buffers");e.postFxShadersManager.bUseMultiRenderTarget=!0,i="USE_MULTI_RENDER_TARGET"}window.navigator.userAgent.indexOf("Trident")>-1&&(r="USE_LINEAR_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!1);var o=Bo.AnimatedIconVS,n=Bo.AnimatedIconFS;n=(n=n.replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i);var a=e.postFxShadersManager.createShaderProgram(t,o,n,"animatedIcon",this.magoManager);a.position4_loc=t.getAttribLocation(a.program,"position"),a.texCoord2_loc=t.getAttribLocation(a.program,"texCoord"),a.scale2d_loc=t.getUniformLocation(a.program,"scale2d"),a.size2d_loc=t.getUniformLocation(a.program,"size2d"),a.imageSize_loc=t.getUniformLocation(a.program,"imageSize"),a.bUseOriginalImageSize_loc=t.getUniformLocation(a.program,"bUseOriginalImageSize"),a.aditionalOffset_loc=t.getUniformLocation(a.program,"aditionalOffset"),a.screenWidth_loc=t.getUniformLocation(a.program,"screenWidth"),a.screenHeight_loc=t.getUniformLocation(a.program,"screenHeight"),a.uMosaicSize_loc=t.getUniformLocation(a.program,"uMosaicSize"),a.uSubImageIdx_loc=t.getUniformLocation(a.program,"uSubImageIdx"),a.uFrustumIdx_loc=t.getUniformLocation(a.program,"uFrustumIdx"),a.uNearFarArray_loc=t.getUniformLocation(a.program,"uNearFarArray")};var vr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.startAngleDeg,this.sweepAngleDeg,this.numPointsFor360Deg,this.startPoint,this.endPoint,this.sweepSense};vr.prototype.deleteObjects=function(){void 0!==this.centerPoint&&this.centerPoint.deleteObjects(),this.centerPoint=void 0,this.radius=void 0,this.startAngleDeg=void 0,this.sweepAngleDeg=void 0,this.numPointsFor360Deg=void 0,void 0!==this.startPoint&&this.startPoint.deleteObjects(),this.startPoint=void 0,void 0!==this.endPoint&&this.endPoint.deleteObjects(),this.endPoint=void 0,this.sweepSense=void 0},vr.prototype.setCenterPosition=function(e,t){void 0===this.centerPoint&&(this.centerPoint=new Kr),this.centerPoint.set(e,t)},vr.prototype.setRadius=function(e){this.radius=e},vr.prototype.setStartAngleDegree=function(e){this.startAngleDeg=e},vr.prototype.setStartPoint=function(e,t){void 0===this.startPoint&&(this.startPoint=new Kr),this.startPoint.set(e,t)},vr.prototype.setEndPoint=function(e,t){void 0===this.endPoint&&(this.endPoint=new Kr),this.endPoint.set(e,t)},vr.prototype.setSense=function(e){this.sweepSense=e},vr.prototype.setSweepAngleDegree=function(e){this.sweepAngleDeg=e},vr.prototype.getPoints=function(e,t){if(void 0===this.centerPoint)return e;var r,i,o;if(t&&(this.numPointsFor360Deg=t),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=16),void 0===this.startAngleDeg){if(void 0===this.startPoint)return e;(r=new Kr).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y);var n=new Jr(1,0),a=r.angleRadToVector(n);o=r.getModul(),r.y<0&&(a*=-1),this.startAngleDeg=180*a/Math.PI}if(void 0===this.radius){if(void 0===this.startPoint)return e;void 0===o&&(void 0===r&&(r=new Kr).set(this.startPoint.x-this.centerPoint.x,this.startPoint.y-this.centerPoint.y),o=r.getModul()),this.radius=o}if(void 0===this.sweepAngleDeg){if(void 0===this.endPoint||void 0===this.sweepSense)return e;(i=new Kr).set(this.endPoint.x-this.centerPoint.x,this.endPoint.y-this.endPoint.y);n=new Jr(1,0),a=i.angleRadToVector(n);this.endPoint.y<0&&(a*=-1),this.sweepAngleDeg=180*a/Math.PI,this.sweepSense<0&&(this.sweepAngleDeg=360-this.sweepAngleDeg)}void 0===e&&(e=[]);var s,l,u,c=[],d=2*Math.PI/this.numPointsFor360Deg,h=this.centerPoint.x,f=this.centerPoint.y,g=Math.PI/180*this.startAngleDeg,p=Math.PI/180*this.sweepAngleDeg,m=Math.ceil(p/d),v=0;if(p>=0)for(var x=0;x<=m;x++)v>p&&(v=p),s=h+this.radius*Math.cos(v+g),l=f+this.radius*Math.sin(v+g),u=new Kr(s,l),c.push(u),v+=d;else for(x=0;x<=m;x++)v<p&&(v=p),s=h+this.radius*Math.cos(v+g),l=f+this.radius*Math.sin(v+g),u=new Kr(s,l),c.push(u),v-=d;var _=c.length;_>0&&(c[0].pointType=1,c[_-1].pointType=1);var y=e.length;for(x=0;x<_;x++)if(0===x)if(y>0){var T=e[y-1];u=c[x],T.isCoincidentToPoint(u,1e-4)||e.push(u)}else e.push(c[x]);else e.push(c[x]);if((y=e.length)>0){var C=e[y-1],b=e[0];C.isCoincidentToPoint(b,1e-4)&&(e.pop(),C.deleteObjects())}return e};var xr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.length=void 0===t?60:t,this.vbo_vicks_container=new xt};xr.prototype.setDimension=function(e){this.length=e},xr.prototype.makeMesh=function(e){void 0!==e&&(this.length=e);var t=new Wr;t.profile=new ii;var r,i=t.profile,o=i.newOuterRing(),n=this.length,a=.1*this.length,s=o.newElement("POLYLINE");s.newPoint2d(0,0);s.newPoint2d(.25*a,.25*n),s.newPoint2d(.25*a,.75*n),s.newPoint2d(.5*a,.75*n),s.newPoint2d(0,n),r=new mi;var l=new Kr(0,-10),u=new Kr(0,10);r.setPoints(l,u),t.revolve(i,360,8,r);var c=t.getSurfaceIndependentMesh(void 0,!1,!1);c.setColor(.1,1,.1,1),c.reverseSense();var d=new Ne,h=c.getCopy(void 0);d.rotationAxisAngDeg(-90,0,0,1),h.transformByMatrix4(d),h.setColor(1,.1,.1,1);var f=c.getCopy(void 0);return d.rotationAxisAngDeg(90,1,0,0),f.transformByMatrix4(d),f.setColor(.1,.1,1,1),c.mergeMesh(h),c.mergeMesh(f),c},xr.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container};var _r=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.minX=Number.MAX_VALUE,this.maxX=Number.MIN_VALUE,this.minY=Number.MAX_VALUE,this.maxY=Number.MIN_VALUE};_r.prototype.setInitXY=function(e,t){this.minX=e,this.minY=t,this.maxX=e,this.maxY=t},_r.prototype.setInit=function(e){void 0!==e&&(this.minX=e.x,this.minY=e.y,this.maxX=e.x,this.maxY=e.y)},_r.prototype.setInitByRectangle=function(e){void 0!==e&&(this.minX=e.minX,this.minY=e.minY,this.maxX=e.maxX,this.maxY=e.maxY)},_r.prototype.addPointXY=function(e,t){e<this.minX?this.minX=e:e>this.maxX&&(this.maxX=e),t<this.minY?this.minY=t:t>this.maxY&&(this.maxY=t)},_r.prototype.addPoint=function(e){void 0!==e&&(e.x<this.minX?this.minX=e.x:e.x>this.maxX&&(this.maxX=e.x),e.y<this.minY?this.minY=e.y:e.y>this.maxY&&(this.maxY=e.y))},_r.prototype.addRectangle=function(e){void 0!==e&&(e.minX<this.minX&&(this.minX=e.minX),e.maxX>this.maxX&&(this.maxX=e.maxX),e.minY<this.minY&&(this.minY=e.minY),e.maxY>this.maxY&&(this.maxY=e.maxY))},_r.prototype.intersectsWithRectangle=function(e){return void 0!==e&&(!(e.minX>this.maxX)&&(!(e.maxX<this.minX)&&(!(e.minY>this.maxY)&&!(e.maxY<this.minY))))},_r.prototype.intersectsWithPoint2D=function(e){return void 0!==e&&(!(e.x>this.maxX)&&(!(e.x<this.minX)&&(!(e.y>this.maxY)&&!(e.y<this.minY))))},_r.prototype.intersectsWithPointXY=function(e,t){return!(e>this.maxX)&&(!(e<this.minX)&&(!(t>this.maxY)&&!(t<this.minY)))},_r.prototype.getCenterPoint=function(){var e=(this.minX+this.maxX)/2,t=(this.minY+this.maxY)/2;return new Kr(e,t)},_r.prototype.getCenterPoint=function(){var e=(this.minX+this.maxX)/2,t=(this.minY+this.maxY)/2;return new Kr(e,t)},_r.prototype.getXLength=function(){return this.maxX-this.minX},_r.prototype.getYLength=function(){return this.maxY-this.minY};var yr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.triPolyhedron=new ct,this.vbo_vicks_container=new xt,this.vBOVertexIdxCacheKey=this.vbo_vicks_container.newVBOVertexIdxCacheKey()};yr.prototype.getVboKeysContainer=function(){return this.vbo_vicks_container},yr.prototype.makeAABB=function(e,t,r){var i,o=-e/2,n=-t/2,a=-r/2,s=e/2,l=t/2,u=r/2,c=this.triPolyhedron.vertexList,d=c.newVertex();d.setPosition(o,n,a),(d=c.newVertex()).setPosition(s,n,a),(d=c.newVertex()).setPosition(s,l,a),(d=c.newVertex()).setPosition(o,l,a),(d=c.newVertex()).setPosition(o,n,u),(d=c.newVertex()).setPosition(s,n,u),(d=c.newVertex()).setPosition(s,l,u),(d=c.newVertex()).setPosition(o,l,u),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(c.getVertex(0),c.getVertex(2),c.getVertex(1)),i.newTriangle().setVertices(c.getVertex(0),c.getVertex(3),c.getVertex(2)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(c.getVertex(4),c.getVertex(5),c.getVertex(6)),i.newTriangle().setVertices(c.getVertex(4),c.getVertex(6),c.getVertex(7)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(c.getVertex(0),c.getVertex(1),c.getVertex(5)),i.newTriangle().setVertices(c.getVertex(0),c.getVertex(5),c.getVertex(4)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(c.getVertex(1),c.getVertex(2),c.getVertex(6)),i.newTriangle().setVertices(c.getVertex(1),c.getVertex(6),c.getVertex(5)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(c.getVertex(2),c.getVertex(3),c.getVertex(7)),i.newTriangle().setVertices(c.getVertex(2),c.getVertex(7),c.getVertex(6)),(i=this.triPolyhedron.newTriSurface()).newTriangle().setVertices(c.getVertex(3),c.getVertex(0),c.getVertex(4)),i.newTriangle().setVertices(c.getVertex(3),c.getVertex(4),c.getVertex(7))};var Tr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.geoCoordsList,this.geoLocDataManager,this.bLoop=!1,this.knotPoints3dList,this.interpolatedPoints3dList,this.controlPoints3dMap,this.controlPointArmLengthRatio=.1,this.segmentLengthArray,this.dirty=!0,this.knotPointsDirty=!0,this.controlPointsDirty=!0,this.interpolatedPointsDirty=!0,this.renderablePointsMap,this.renderableCurve,this._renderableCurveDirty=!1,this._renderableCurveThickLinePosDataArray,this.bRenderablePointsVisible=!1,this.renderingState=I.curveRenderingState.EDITED,this.interpolationsCount=10,this.state=I.parametricCurveState.NORMAL,t&&(void 0!==t.bLoop&&(this.bLoop=t.bLoop),t.initialArmsLengthRatio&&(this.controlPointArmLengthRatio=t.initialArmsLengthRatio),void 0!==t.geoCoordsArray&&(void 0===this.geoCoordsList&&(this.geoCoordsList=new ve),this.geoCoordsList.addGeoCoordsArray(t.geoCoordsArray)))};Tr.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new ve,this.geoCoordsList.owner=this),this.geoCoordsList},Tr.prototype.getGeoLocationDataManager=function(e){return void 0===this.geoLocDataManager&&this.knotPoints3dList.geoLocDataManager&&(this.geoLocDataManager=this.knotPoints3dList.geoLocDataManager),this.geoLocDataManager},Tr.prototype._renderControlPointsArms=function(e,t,r){if(2!==r){var i=e.getGl(),o=e.postFxShadersManager.getShader("modelRefSsao");o.useProgram(),o.disableVertexAttribArrayAll(),o.resetLastBuffersBinded(),o.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals();var n=e.modeler.bSplineControlPointsColor;if(i.uniform1i(o.bPositionCompressed_loc,!1),i.uniform1i(o.bUse1Color_loc,!0),i.uniform4fv(o.oneColor4_loc,[n.r,n.b,n.g,n.a]),i.uniform1f(o.fixPointSize_loc,5),i.uniform1i(o.bUseFixPointSize_loc,1),void 0===this.armsLinesPoints3dList){this.armsLinesPoints3dList=new Qr;for(var a=[],s=this.knotPoints3dList.getPointsCount(),l=0;l<s;l++){var u=this.controlPoints3dMap[l],c=u.inningControlPoint,d=u.outingControlPoint,h=this.knotPoints3dList.getPoint(l);c&&(a.push(h),a.push(c)),d&&(a.push(h),a.push(d))}this.armsLinesPoints3dList.pointsArray=a,this.armsLinesPoints3dList.geoLocDataManager=this.knotPoints3dList.geoLocDataManager}var f=i.LINES;this.armsLinesPoints3dList.renderLines(e,o,r,!1,!0,f)}},Tr.prototype.knotPointMoved=function(e){var t,r,i=e.idxInCurve,o=this.renderablePointsMap[i];if(o){d=o.renderableKnotPoint,t=o.renderableInningControlPoint,r=o.renderableOutingControlPoint;var n=this.geoCoordsList.getGeoCoord(i),a=d.getGeoLocDataManager().getCurrentGeoLocationData().getGeographicCoords(),s=a.longitude-n.longitude,l=a.latitude-n.latitude,u=a.altitude-n.altitude,c=this.getGeoLocationDataManager().getCurrentGeoLocationData();if(0!==s||0!==l||0!==u){n.setLonLatAlt(a.longitude,a.latitude,a.altitude);var d=this.knotPoints3dList.getPoint(i),h=on.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude,void 0);d=c.getTransformedRelativePosition(h,d);var f=this.controlPoints3dMap[i].inningControlPoint,g=this.controlPoints3dMap[i].outingControlPoint;if(f){var p=t.getGeoLocDataManager().getCurrentGeoLocationData(),m=p.geographicCoord,v=m.longitude+s,x=m.latitude+l,_=m.altitude+u;p=on.calculateGeoLocationData(v,x,_,0,0,0,p);var y=on.geographicCoordToWorldPoint(v,x,_,void 0);f=c.getTransformedRelativePosition(y,f)}if(g){var T=r.getGeoLocDataManager().getCurrentGeoLocationData(),C=T.geographicCoord,b=C.longitude+s,M=C.latitude+l,A=C.altitude+u;T=on.calculateGeoLocationData(b,M,A,0,0,0,T);var E=on.geographicCoordToWorldPoint(b,M,A,void 0);g=c.getTransformedRelativePosition(E,g)}}this.armsLinesPoints3dList.setDirty(!0),this._reCalculateInterpolatedPointsForSegment(i-1),this._reCalculateInterpolatedPointsForSegment(i),this._renderableCurveDirty=!0}},Tr.prototype.controlPointMoved=function(e){var t,r,i,o=e.inOutControlPointType,n=e.idxInCurve,a=this.renderablePointsMap[n],s=this.controlPoints3dMap[n],l=s.inningControlPoint,u=s.outingControlPoint,c=s.inningArmLength,d=s.outingArmLength;a&&(a.renderableKnotPoint,t=a.renderableInningControlPoint,r=a.renderableOutingControlPoint);var h=this.knotPoints3dList.getPoint(n),f=this.getGeoLocationDataManager().getCurrentGeoLocationData();if("outingControlPoint"===o){var g=(E=r.getGeoLocDataManager().getCurrentGeoLocationData()).geographicCoord,p=g.longitude,m=g.latitude,v=g.altitude,x=on.geographicCoordToWorldPoint(p,m,v,void 0);if(u=f.getTransformedRelativePosition(x,u),s.outingArmLength=h.distToPoint(u),(i=new Jr(h.x-u.x,h.y-u.y,h.z-u.z)).unitary(),t){l.set(h.x+i.x*c,h.y+i.y*c,h.z+i.z*c);var _=f.localCoordToGeographicCoord(l,_),y=t.getGeoLocDataManager().getCurrentGeoLocationData();y=on.calculateGeoLocationData(_.longitude,_.latitude,_.altitude,0,0,0,y)}}else{var T=(y=t.getGeoLocDataManager().getCurrentGeoLocationData()).geographicCoord,C=T.longitude,b=T.latitude,M=T.altitude,A=on.geographicCoordToWorldPoint(C,b,M,void 0);if(l=f.getTransformedRelativePosition(A,l),s.inningArmLength=h.distToPoint(l),(i=new Jr(h.x-l.x,h.y-l.y,h.z-l.z)).unitary(),r){u.set(h.x+i.x*d,h.y+i.y*d,h.z+i.z*d);_=f.localCoordToGeographicCoord(u,_);var E=r.getGeoLocDataManager().getCurrentGeoLocationData();E=on.calculateGeoLocationData(_.longitude,_.latitude,_.altitude,0,0,0,E)}}this.armsLinesPoints3dList.setDirty(!0),this._reCalculateInterpolatedPointsForSegment(n-1),this._reCalculateInterpolatedPointsForSegment(n),this._renderableCurveDirty=!0},Tr.prototype.isPrepared=function(e){return!!this._makeKnotPoints(e)&&(!!this.makeControlPoints(void 0,e)&&!!this._makeInterpolatedPoints())},Tr.prototype.renderThicknessOne=function(e,t,r,i){if(void 0!==this.interpolatedPoints3dList){void 0===t&&((t=e.postFxShadersManager.getShader("modelRefSsao")).useProgram(),t.disableVertexAttribArrayAll(),t.resetLastBuffersBinded(),t.enableVertexAttribArray(t.position3_loc),t.bindUniformGenerals());var o=e.getGl();o.uniform1i(t.bPositionCompressed_loc,!1),1===r&&(o.uniform1i(t.bUse1Color_loc,!0),void 0!==t.oneColor4_loc&&null!==t.oneColor4_loc&&o.uniform4fv(t.oneColor4_loc,[1,0,0,1])),o.uniform1f(t.fixPointSize_loc,5),o.uniform1i(t.bUseFixPointSize_loc,!0),this.interpolatedPoints3dList.renderLines(e,t,r,this.bLoop,i)}},Tr.prototype.render=function(e,t,r){if(!this.isPrepared(e))return!1;this._renderControlPointsArms(e,t,r);e.sceneState.gl;this.renderableCurve||(this._makeRenderableCurve(e),e.modeler.addObject(this.renderableCurve)),this._renderableCurveDirty&&this._reMakeRenderableCurve(e),this.renderingState===I.curveRenderingState.EDITED&&(this.renderablePointsMap||this._makeRenderablePoints(e))},Tr.prototype._makeRenderablePoints=function(e){var t=e.modeler,r=this.geoCoordsList.getGeoCoordsCount();if(!this.renderablePointsMap||this.renderablePointsMap.length!==r){this.renderablePointsMap||(this.renderablePointsMap=[]);for(var i={opacity:1,color:t.bSplineKnotPointsColor,size:8,isMovable:!0},o={opacity:1,color:t.bSplineControlPointsColor,size:8,isMovable:!0},n=0;n<r;n++){var a=this.geoCoordsList.getGeoCoord(n),s={longitude:a.longitude,latitude:a.latitude,altitude:a.altitude},l=new Or(s,i,{description:{type:"curveMember",owner:this,idxInCurve:n}});t.addObject(l);var u=this.controlPoints3dMap[n].inningGeoCoord,c=this.controlPoints3dMap[n].outingGeoCoord,d=void 0,h=void 0;if(u){h=new Or(u,o,{description:{type:"curveControlMember",inOutControlPointType:"inningControlPoint",owner:this,idxInCurve:n}}),t.addObject(h);var f=new Re("MOVE_START",function(e){e._moveStart()});h.addEventListener(f)}if(c){d=new Or(c,o,{description:{type:"curveControlMember",inOutControlPointType:"outingControlPoint",owner:this,idxInCurve:n}}),t.addObject(d);f=new Re("MOVE_START",function(e){e._moveStart()});d.addEventListener(f)}this.renderablePointsMap[n]={renderableKnotPoint:l,renderableInningControlPoint:h,renderableOutingControlPoint:d};f=new Re("MOVE_START",function(e){e._moveStart()});l.addEventListener(f)}}},Tr.prototype._reMakeRenderableCurve=function(e){var t=this.renderableCurve.objectsArray[0],r=e.getGl(),i=e.vboMemoryManager;t.vboKeysContainer.deleteGlObjects(r,i);t.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(this._renderableCurveThickLinePosDataArray,e.vboMemoryManager,4),this._renderableCurveDirty=!1},Tr.prototype._makeRenderableCurve=function(e){if(!this.renderableCurve){this._renderableCurveThickLinePosDataArray=Qr.getThickLinesPositionDataArray(this.interpolatedPoints3dList.pointsArray,this._renderableCurveThickLinePosDataArray,{});var t=this.getGeoLocationDataManager().getCurrentGeoLocationData(),i={};void 0===i.thickness&&(i.thickness=2),void 0===i.color&&(i.color=new J(1,.3,.3,1));var o=new _o(i);o.vboKeysContainer=new xt;o.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(this._renderableCurveThickLinePosDataArray,e.vboMemoryManager,4),this.renderableCurve=new ho,this.renderableCurve.geoLocDataManager=new ye,this.renderableCurve.geoLocDataManager.addGeoLocationData(t),this.renderableCurve.objectType=r.OBJECT_TYPE.VECTORMESH,this.renderableCurve.boundingSphereWC=new z;var n=t.position,a=Qr.getBoundingBoxOfPoints3DArray(this.interpolatedPoints3dList.pointsArray,void 0).getRadiusAprox();this.renderableCurve.boundingSphereWC.setCenterPoint(n.x,n.y,n.z),this.renderableCurve.boundingSphereWC.setRadius(a),this.renderableCurve.objectsArray.push(o)}},Tr.prototype._makeKnotPoints=function(e){return void 0!==this.knotPoints3dList&&!this.knotPointsDirty||(void 0===this.geoCoordsList.points3dList&&this.geoCoordsList.makeLines(e),this.knotPoints3dList=new Qr,this.knotPoints3dList.pointsArray=this.geoCoordsList.points3dList.pointsArray,this.knotPoints3dList.geoLocDataManager=this.geoCoordsList.points3dList.geoLocDataManager,this.knotPointsDirty=!1,!1)},Tr._makeControlPointsOfKnotPoint=function(e,t,r,i,o){var n=e.getTangentLine3D(t,void 0,o).direction,a=e.getPoint(e.getPrevIdx(t)),s=e.getPoint(t),l=e.getPoint(e.getNextIdx(t)),u=s.distToPoint(a)*i,c=new Jr;c.set(s.x-n.x*u,s.y-n.y*u,s.z-n.z*u);var d=r.localCoordToGeographicCoord(c,void 0),h=s.distToPoint(l)*i,f=new Jr;return f.set(s.x+n.x*h,s.y+n.y*h,s.z+n.z*h),{inningControlPoint:c,outingControlPoint:f,inningGeoCoord:d,outingGeoCoord:r.localCoordToGeographicCoord(f,void 0),outingArmLength:f.distToPoint(s),inningArmLength:c.distToPoint(s)}},Tr.prototype.makeControlPoints=function(e,t){if(!this._makeKnotPoints(t))return!1;if(void 0===this.knotPoints3dList.pointsArray)return!1;if(!this.controlPoints3dMap||this.controlPointsDirty){this.controlPoints3dMap={};var r,i,o,n,a,s=this.bLoop,l=this.knotPoints3dList.geoLocDataManager.getCurrentGeoLocationData();void 0===e&&(e=this.controlPointArmLengthRatio);for(var u=this.knotPoints3dList.getPointsCount(),c=0;c<u;c++)if(r=this.knotPoints3dList.getPoint(c),0===c)if(this.bLoop)this.controlPoints3dMap[c]=Tr._makeControlPointsOfKnotPoint(this.knotPoints3dList,c,l,e,s);else{o=this.knotPoints3dList.getPoint(c+1),a=e;var d=new Jr;d.set(r.x*(1-a)+o.x*a,r.y*(1-a)+o.y*a,r.z*(1-a)+o.z*a);var h=d.distToPoint(r),f=l.localCoordToGeographicCoord(d,void 0);this.controlPoints3dMap[c]={inningControlPoint:void 0,outingControlPoint:d,inningGeoCoord:void 0,outingGeoCoord:f,outingArmLength:h,inningArmLength:void 0}}else if(c===u-1)if(this.bLoop)this.controlPoints3dMap[c]=Tr._makeControlPointsOfKnotPoint(this.knotPoints3dList,c,l,e,s);else{i=this.knotPoints3dList.getPoint(c-1),n=e;var g=new Jr;g.set(r.x*(1-n)+i.x*n,r.y*(1-n)+i.y*n,r.z*(1-n)+i.z*n);var p=g.distToPoint(r),m=l.localCoordToGeographicCoord(g,void 0);this.controlPoints3dMap[c]={inningControlPoint:g,outingControlPoint:void 0,inningGeoCoord:m,outingGeoCoord:void 0,outingArmLength:void 0,inningArmLength:p}}else this.controlPoints3dMap[c]=Tr._makeControlPointsOfKnotPoint(this.knotPoints3dList,c,l,e,s);return this.controlPointsDirty=!1,!1}return!0},Tr.prototype._reCalculateInterpolatedPointsForSegment=function(e){var t=this.knotPoints3dList.getPointsCount();if(this.bLoop)e>=t?e-=t:e<0&&(e+=t);else if(e>=t-1||e<0)return;for(var r=this.interpolationsCount,i=this.bLoop,o=(this.interpolatedPoints3dList.getPointsCount(),e*r),n=(e+1)*r,a=this.knotPoints3dList.getSegment3D(e,void 0,i),s=a.startPoint3d,l=a.endPoint3d,u=this.controlPoints3dMap[e].outingControlPoint,c=this.knotPoints3dList.getNextIdx(e),d=this.controlPoints3dMap[c].inningControlPoint,h=1/r,f=h,g=s.x,p=s.y,m=s.z,v=u.x,x=u.y,_=u.z,y=d.x,T=d.y,C=d.z,b=l.x,M=l.y,A=l.z,E=0;E<r+1;E++){var L=1-(f=E*h),w=Math.pow(L,2),S=Math.pow(L,3),D=f*f,R=D*f,P=3*w*f,I=3*L*D,F=S*g+P*v+I*y+R*b,O=S*p+P*x+I*T+R*M,B=S*m+P*_+I*C+R*A,N=o+E;this.interpolatedPoints3dList.pointsArray[N].set(F,O,B)}if(this.interpolatedPoints3dList.setDirty(!0),this.renderableCurve){var U={startIdx:o,endIdx:n};this._renderableCurveThickLinePosDataArray=Qr.getThickLinesPositionDataArray(this.interpolatedPoints3dList.pointsArray,this._renderableCurveThickLinePosDataArray,U)}},Tr.prototype._makeInterpolatedPoints=function(){if(!this.makeControlPoints())return!1;if(void 0===this.interpolatedPoints3dList||this.interpolatedPointsDirty){void 0===this.interpolatedPoints3dList&&(this.interpolatedPoints3dList=new Qr);var e,t=this.interpolationsCount,r=[],i=this.bLoop,o=this.knotPoints3dList.getPointsCount();e=this.bLoop?o:o-1;for(var n=0;n<e;n++){var a=this.knotPoints3dList.getSegment3D(n,void 0,i),s=a.startPoint3d,l=a.endPoint3d,u=this.controlPoints3dMap[n].outingControlPoint,c=this.knotPoints3dList.getNextIdx(n),d=this.controlPoints3dMap[c].inningControlPoint;Tr.makeForSegment(s,u,d,l,t,r),n<e-1&&r.pop()}return this.interpolatedPoints3dList.pointsArray=r,this.interpolatedPoints3dList.geoLocDataManager=this.knotPoints3dList.geoLocDataManager,this.interpolatedPointsDirty=!1,!1}return!0},Tr.getLengthForSegment=function(e,t,r,i,o,n){void 0===o&&(o=1),void 0===n&&(n=10);for(var a,s,l=Tr.makeForSegmentPartial(e,t,r,i,o,n,void 0),u=0,c=l.length,d=0;d<c-1;d++)a=l[d],s=l[d+1],u+=a.distToPoint(s);return u},Tr.getLength=function(e,t){if(void 0!==e&&void 0!==e.knotPoints3dList){var r=e.knotPoints3dList.getPointsCount();if(void 0===e.segmentLengthArray){e.segmentLengthArray=[],void 0===t&&(t=20);for(var i=0;i<r-1;i++){var o=e.knotPoints3dList.getSegment3D(i,void 0,void 0),n=o.startPoint3d,a=o.endPoint3d,s=e.controlPoints3dMap[i].outingControlPoint,l=e.controlPoints3dMap[i+1].inningControlPoint,u=Tr.getLengthForSegment(n,s,l,a,1,t);e.segmentLengthArray[i]=u}}var c=0;for(i=0;i<r-1;i++)c+=e.segmentLengthArray[i];return c}},Tr.getUnitaryPositionForSegmentAtLinearPosition=function(e,t,r,i,o,n){for(var a,s=1/n,l=s,u=e.x,c=e.y,d=e.z,h=t.x,f=t.y,g=t.z,p=r.x,m=r.y,v=r.z,x=i.x,_=i.y,y=i.z,T=new Jr(0,0,0),C=new Jr(0,0,0),b=0,M=0;M<n+1;M++){var A=1-(l=M*s),E=Math.pow(A,2),L=Math.pow(A,3),w=l*l,S=w*l,D=3*E*l,R=3*A*w,P=L*u+D*h+R*p+S*x,I=L*c+D*f+R*m+S*_,F=L*d+D*g+R*v+S*y;if(T.set(P,I,F),M>0){var O=C.distToPoint(T);if((b+=O)>o){var B=(O-(b-o))/O;return a=(M-1)*s+(B/=n)}}C.set(P,I,F)}return void 0===a&&(a=1),a},Tr.getTangent=function(e,t,r,i){if(void 0===e.knotPoints3dList||e.knotPoints3dList.dirty){e.makeControlPoints(.3,i),e.knotPoints3dList.dirty=!1}var o=e.knotPoints3dList.getPointsCount();if(void 0===e.segmentLengthArray){e.segmentLengthArray=[];for(var n,a=20,s=1,l=0;l<o-1;l++){var u=(x=e.knotPoints3dList.getSegment3D(l,void 0,n)).startPoint3d,c=x.endPoint3d,d=e.controlPoints3dMap[l].outingControlPoint,h=e.controlPoints3dMap[l+1].inningControlPoint,f=Tr.getLengthForSegment(u,d,h,c,s,a);e.segmentLengthArray[l]=f}}for(var g=!1,p=(l=0,0),m=0,v=-1;!g&&l<o;){if((p+=e.segmentLengthArray[l])>=t){g=!0,v=l;var x,_=t-m,y=(s=_/e.segmentLengthArray[v],u=(x=e.knotPoints3dList.getSegment3D(v,void 0,n)).startPoint3d,c=x.endPoint3d,d=e.controlPoints3dMap[v].outingControlPoint,h=e.controlPoints3dMap[v+1].inningControlPoint,a=20,Tr.getUnitaryPositionForSegmentAtLinearPosition(u,d,h,c,_,a));r=Tr.getTangentForSegment(u,d,h,c,y,r)}m=p,l++}return r},Tr.getTangentForSegment=function(e,t,r,i,o,n){var a=o,s=1-a,l=s*s,u=a*a,c=2*s*a,d=e.x,h=e.y,f=e.z,g=t.x,p=t.y,m=t.z,v=r.x,x=r.y,_=r.z,y=l*d+c*g+u*v,T=l*h+c*p+u*x,C=l*f+c*m+u*_,b=l*g+c*v+u*i.x,M=l*p+c*x+u*i.y,A=l*m+c*_+u*i.z,E=new Jr(y,T,C),L=new Jr(b,M,A);void 0===n&&(n=new Rr);var w=E.getVectorToPoint(L,void 0);return w.unitary(),n.setPointAndDir(s*y+a*b,s*T+a*M,s*C+a*A,w.x,w.y,w.z),n},Tr.makeForSegment=function(e,t,r,i,o,n){return Tr.makeForSegmentPartial(e,t,r,i,1,o,n)},Tr.makeForSegmentPartial=function(e,t,r,i,o,n,a){void 0===a&&(a=[]);for(var s=o/n,l=s,u=e.x,c=e.y,d=e.z,h=t.x,f=t.y,g=t.z,p=r.x,m=r.y,v=r.z,x=i.x,_=i.y,y=i.z,T=0;T<n+1;T++){var C=1-(l=T*s),b=Math.pow(C,2),M=Math.pow(C,3),A=l*l,E=A*l,L=3*b*l,w=3*C*A,S=new Jr(M*u+L*h+w*p+E*x,M*c+L*f+w*m+E*_,M*d+L*g+w*v+E*y);a.push(S)}return a};var Cr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.centerPoint,this.radius,this.numPointsFor360Deg};Cr.prototype.setCenterPosition=function(e,t){void 0===this.centerPoint&&(this.centerPoint=new Kr),this.centerPoint.set(e,t)},Cr.prototype.setRadius=function(e){this.radius=e},Cr.prototype.getPoints=function(e,t){if(t&&(this.numPointsFor360Deg=t),void 0===this.numPointsFor360Deg&&(this.numPointsFor360Deg=36),void 0===this.centerPoint||void 0===this.radius)return e;var r=new vr;return r.setCenterPosition(this.centerPoint.x,this.centerPoint.y),r.setRadius(this.radius),r.setStartAngleDegree(0),r.setSweepAngleDegree(360),r.setSense(1),void 0===e&&(e=[]),e=r.getPoints(e,this.numPointsFor360Deg)};var br=function(e,t,r,i){if(!e||!e instanceof Zr)throw new Error("point2DList is required");this.point2DList=e,this.depth=Jo(t,8),this.quatTree,this.magoMangaer=r,this.renderFunction=i&&"function"==typeof i?i:this.defaultRenderFunc,this.initQuatTree()};br.prototype.initQuatTree=function(){var e=this.getTreeOption();this.quatTree=new di(e),this.quatTree.data=this.point2DList.pointsArray,this.makeTreeByDepth()},br.prototype.getTreeOption=function(){var e=this.point2DList.getBoundingRectangle(),t=e.getXLength(),r=e.getYLength(),i=e.getCenterPoint();return t<.03&&(t=.03),r<.03&&(r=.03),{halfWidth:t/2,halfHeight:r/2,center:i}},br.prototype.addPoint=function(e){this.point2DList.addPoint(e),this.initQuatTree()},br.prototype.deletePointByCondition=function(e){this.point2DList.deletePointByCondition(e),this.point2DList.getPointsCount()>0?this.initQuatTree():(this.quatTree=void 0,this.magoMangaer.objMarkerManager.setMarkerByCondition(function(e){return!e.tree}))},br.prototype.updatePoint=function(e,t){var r=this.point2DList.findPointArray(t)[0];r.set(e.getX(),e.getY());for(var i=Object.keys(r),o=0,n=i.length;o<n;o++){var a=i[o];r[a]=e[a]}this.initQuatTree()},br.prototype.makeTreeByDepth=function(){this.quatTree.makeTreeByDepth(this.depth)},br.prototype.defaultRenderFunc=function(e,t){t.objMarkerManager.loadDefaultImages(t),t.objMarkerManager.objectMarkerArray=[];for(var r=e.length,i=0;i<r;i++){var o=e[i];if(o.hasChildren())for(var n,a=(n=o.displayPointsArray).length,s=0;s<a;s++){var l=(c=n[s]).mass;l>50&&(l=50),l<15&&(l=15);var u={positionWC:c,imageFilePath:"defaultRed",sizeX:l,sizeY:l};t.objMarkerManager.newObjectMarker(u,t)}else if(n=o.data)for(a=n.length,s=0;s<a;s++){var c=n[s];u={positionWC:on.geographicCoordToWorldPoint(c.x,c.y,0),imageFilePath:"defaultBlue",sizeX:8,sizeY:8};t.objMarkerManager.newObjectMarker(u,t)}}};var Mr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.plane,this.geoLocDataManager,this.mesh};Mr.prototype.getPlane=function(){void 0===this.plane&&(this.plane=new We);var e=this.geoLocDataManager.getCurrentGeoLocationData(),t=e.tMatrix,r=e.position;return this.plane.setPointAndNormal(r.x,r.y,r.z,t._floatArrays[8],t._floatArrays[9],t._floatArrays[10]),this.plane},Mr.prototype.makeRectangle=function(e,t){void 0===this.mesh&&(this.mesh=new kr);var r=this.mesh.getVertexList(),i=e/2,o=t/2,n=r.newVertex();n.setPosition(-i,-o,100);var a=r.newVertex();a.setPosition(i,-o,100);var s=r.newVertex();s.setPosition(i,o,100);var l=r.newVertex();l.setPosition(-i,o,100),this.mesh.newSurface().newFace().addVerticesArray([n,a,s,l])},Mr.prototype.render=function(e,t,r){var i,o=e.sceneState.gl;if(1===r){o.uniform1i(t.colorType_loc,0),o.uniform4fv(t.oneColor4_loc,[1,1,0,1]);var n=0;o.uniform1i(t.refMatrixType_loc,n),i=o.LINE_LOOP}else if(0===r){n=0;o.uniform1i(t.refMatrixType_loc,n)}this.mesh.render(e,t,r,i)};var Ar=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.geoCoordsList,this.geoLocDataManager,this.excavationDepthInMeters,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges,this.dirty=!0,this.color4=new J(222/255,184/255,135/255,1),void 0!==t){if(void 0!==t.geoCoordsArray){this.geoCoordsList=new ve(t.geoCoordsArray),this.geoCoordsList.owner=this;var r=this.getGeoLocationData(),i=this.geoCoordsList.getGeoCoord(0);if(i){var o=i.getGeoLocationDataManager().getCurrentGeoLocationData();r.copyFrom(o)}}void 0!==t.excavationDepthInMeters&&(this.excavationDepthInMeters=t.excavationDepthInMeters),t.color&&t.color instanceof J&&(this.color4=t.color)}};Ar.prototype.getGeographicCoordsList=function(){return this.geoCoordsList},Ar.prototype.renderPoints=function(e,t,r){if(void 0===this.geoCoordsList)return!1;this.geoCoordsList.renderPoints(e,t,r,!1)},Ar.prototype.render=function(e,t,r,i,o){if(this.dirty)this.makeMesh(e);else if(void 0!==this.meshPositive){var n=e.sceneState.gl;t.useProgram(),t.resetLastBuffersBinded(),t.enableVertexAttribArray(t.position3_loc),t.bindUniformGenerals(),1===r&&(t.disableVertexAttribArray(t.color4_loc),t.enableVertexAttribArray(t.normal3_loc),t.disableVertexAttribArray(t.texCoord2_loc),n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[1,1,.1,0]),n.uniform1i(t.bApplySsao_loc,!0),n.uniform1i(t.colorType_loc,1),n.uniform1i(t.bApplySpecularLighting_loc,!0)),n.uniform1i(t.refMatrixType_loc,0),n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,t),n.colorMask(!1,!1,!1,!1),n.depthMask(!1),n.enable(n.CULL_FACE),n.enable(n.STENCIL_TEST),n.clearStencil(0);n.cullFace(n.FRONT),n.stencilFunc(n.ALWAYS,0,255),n.stencilOp(n.KEEP,n.INCR,n.KEEP),this.meshPositive.render(e,t,r,void 0),n.cullFace(n.BACK),n.stencilFunc(n.ALWAYS,0,255),n.stencilOp(n.KEEP,n.DECR,n.KEEP),this.meshPositive.render(e,t,r,void 0),1===r&&(n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])),n.colorMask(!0,!0,!0,!0),n.depthMask(!0),n.stencilMask(0),n.stencilFunc(n.LEQUAL,1,255),n.stencilOp(n.REPLACE,n.REPLACE,n.REPLACE),n.cullFace(n.BACK),n.depthFunc(n.GREATER),this.meshNegative.render(e,t,r,void 0),n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL),n.disable(n.STENCIL_TEST),n.stencilOp(n.KEEP,n.KEEP,n.KEEP),n.disable(n.POLYGON_OFFSET_FILL),n.stencilMask(255)}},Ar.prototype.getGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var e=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===e&&(e=this.geoLocDataManager.newGeoLocationData("default")),e},Ar.prototype.makeMesh=function(e){if(void 0===this.geoCoordsList)return!1;var t=this.getGeoLocationData(),r=(o=this.geoCoordsList.getGeoCoord(0)).getGeoLocationDataManager().getCurrentGeoLocationData();t.copyFrom(r),void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Fi);var i,o,n=[],a=[];void 0===this.excavationDepthInMeters&&(this.excavationDepthInMeters=30);for(var s=this.geoCoordsList.getGeoCoordsCount(),l=0;l<s;l++){o=this.geoCoordsList.getGeoCoord(l);var u=new Jr,c=new Jr;i=Te.geographicToCartesianWgs84(o.longitude,o.latitude,o.altitude-this.excavationDepthInMeters,i),u.set(i[0],i[1],i[2]),i=Te.geographicToCartesianWgs84(o.longitude,o.latitude,o.altitude+70,i),c.set(i[0],i[1],i[2]);var d=new Jr,h=new Jr;d=t.getTransformedRelativePosition(u,d),h=t.getTransformedRelativePosition(c,h),d.pointType=1,h.pointType=1,n[l]=d,a[l]=h}var f=this.vtxProfilesList.newVtxProfile(),g=this.vtxProfilesList.newVtxProfile();if(f.makeByPoints3DArray(n,void 0),g.makeByPoints3DArray(a,void 0),void 0===this.meshPositive){this.mesh=this.vtxProfilesList.getMesh(void 0,!0,!0),this.meshPositive=this.mesh.getCopySurfaceIndependentMesh(this.meshPositive),this.meshPositive.calculateVerticesNormals(),this.meshPositive.setColor(.1,.5,.5,1),this.meshPositive.getVbo(this.vboKeysContainer,e.vboMemoryManager),this.meshPositive.getVboEdges(this.vboKeysContainerEdges,e.vboMemoryManager),this.meshNegative=this.mesh.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,e.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,e.vboMemoryManager)}this.dirty=!1};var Er=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._guid=qo(),this.vertexArray,this.hEdge,this.planeNormal,this.surfaceOwner};Object.defineProperties(Er.prototype,{guid:{get:function(){return this._guid}}}),Er.prototype.deleteObjects=function(){this.vertexArray=void 0,this.hEdge=void 0,void 0!==this.planeNormal&&(this.planeNormal.deleteObjects(),this.planeNormal=void 0),this.surfaceOwner=void 0},Er.prototype.getVerticesCount=function(){return void 0===this.vertexArray?0:this.vertexArray.length},Er.prototype.setVertexIdxInList=function(){for(var e=this.getVerticesCount(),t=0;t<e;t++)this.vertexArray[t].setIdxInList(t)},Er.prototype.getHalfEdgeOutingFromVertex=function(e){for(var t,r=!1,i=0,o=this.hEdge,n=this.getVerticesCount();!r&&i<n;){if(o.startVertex===e){r=!0,t=o;break}o=o.next,i++}return t},Er.prototype.changeVertex=function(e,t){var r=this.getVerticesCount();if(e<0||e>=r)return!1;var i=this.vertexArray[e];return this.getHalfEdgeOutingFromVertex(i).setStartVertex(t),this.vertexArray[e]=t,!0},Er.prototype.addVertex=function(e){void 0===this.vertexArray&&(this.vertexArray=[]),this.vertexArray.push(e)},Er.prototype.addVerticesArray=function(e){void 0===this.vertexArray&&(this.vertexArray=[]),Array.prototype.push.apply(this.vertexArray,e)},Er.prototype.getVertex=function(e){if(void 0!==this.vertexArray)return this.vertexArray[e]},Er.prototype.reverseSense=function(){this.vertexArray.reverse()},Er.prototype.setColor=function(e,t,r,i){for(var o=this.getVerticesCount(),n=0;n<o;n++)this.getVertex(n).setColorRGBA(e,t,r,i)},Er.prototype.getPlaneNormal=function(){return(void 0===this.planeNormal||this.planeNormal.isNAN())&&this.calculatePlaneNormal(),this.planeNormal},Er.calculatePlaneNormal=function(e,t){void 0===t&&(t=new Jr),t.set(0,0,0);for(var r=e.length,i=0;i<r;i++){var o=Si.getPrevIdx(i,e),n=Si.getVector(o,e,void 0),a=Si.getVector(i,e,void 0);if(n.unitary(),a.unitary(),!n.isNAN()&&!a.isNAN()){var s=n.crossProduct(a,void 0);if(s.unitary(),!s.isNAN()){var l=n.scalarProduct(a);l>1?l=1:l<-1&&(l=-1);var u=Math.acos(l);t.add(s.x*u,s.y*u,s.z*u)}}}return t.unitary(),t},Er.prototype.calculatePlaneNormal=function(){return this.planeNormal=Er.calculatePlaneNormal(this.vertexArray,this.planeNormal),this.planeNormal},Er.prototype.calculateVerticesNormals=function(e){var t=this.vertexArray.length;void 0!==e&&e&&this.calculatePlaneNormal(),void 0===this.planeNormal&&this.calculatePlaneNormal();t=this.getVerticesCount();for(var r=0;r<t;r++)this.vertexArray[r].setNormal(this.planeNormal.x,this.planeNormal.y,this.planeNormal.z)},Er.prototype.calculateMinDistToPoint=function(e){},Er.prototype.calculateTexCoordsByHeight=function(e,t){for(var r=this.getPlaneNormal(),i=new Jr(0,0,1).scalarProduct(r)>.9,o=this.getHalfEdgesLoop(),n=0,a=o.length;n<a;n++){var s=o[n],l=s.getStartVertex(),u=l.getTexCoord(),c=s.getEndVertex(),d=c.getTexCoord(),h=l.getPosition(),f=c.getPosition(),g=h.z,p=f.z;if(i)u.set(0,0),d.set(0,0);else if(g<.5&&p<.5){s;var m=h.distToPoint(f)/3,v=0;u.set(0,v),d.set(m,v)}else if(g>.5&&p>.5){s;m=h.distToPoint(f)/3,v=g/e;u.set(m,v),d.set(0,v)}}},Er.prototype.calculateTexCoordsBox=function(e){var t=this.getPlaneNormal(),r=Er.getBestCubeFaceToProject(t),i=e.minX,o=e.maxX,n=e.minY,a=e.maxY,s=e.minZ,l=o-i,u=a-n,c=e.maxZ-s,d=this.getVerticesCount();if(r===I.boxFace.TOP)for(var h=0;h<d;h++){var f=(v=this.getVertex(h)).getPosition(),g=v.getTexCoord(),p=(f.x-i)/l,m=(f.y-n)/u;g.set(p,m)}else if(r===I.boxFace.BOTTOM)for(h=0;h<d;h++){f=(v=this.getVertex(h)).getPosition(),g=v.getTexCoord(),p=(f.x-i)/l;m=1-(m=(f.y-n)/u),g.set(p,m)}else if(r===I.boxFace.FRONT)for(h=0;h<d;h++){f=(v=this.getVertex(h)).getPosition(),g=v.getTexCoord(),p=(f.x-i)/l,m=(f.z-s)/c;g.set(p,m)}else if(r===I.boxFace.REAR)for(h=0;h<d;h++){f=(v=this.getVertex(h)).getPosition(),g=v.getTexCoord(),p=(f.x-i)/l;m=1-(m=(f.z-s)/c),g.set(p,m)}else if(r===I.boxFace.LEFT)for(h=0;h<d;h++){f=(v=this.getVertex(h)).getPosition(),g=v.getTexCoord(),m=(f.y-n)/u,p=(f.z-s)/c;g.set(p,m)}else if(r===I.boxFace.RIGHT)for(h=0;h<d;h++){var v;f=(v=this.getVertex(h)).getPosition(),g=v.getTexCoord(),m=(f.y-n)/u;p=1-(p=(f.z-s)/c),g.set(p,m)}},Er.prototype.solveUroborus=function(){var e=this.getVerticesCount();if(!(e<3)){var t=this.getVertex(0),r=this.getVertex(e-1),i=t.point3d,o=r.point3d;i.isCoincidentToPoint(o,1e-4)&&this.vertexArray.pop()}},Er.setTwinsFacesOfArray=function(e){for(var t,r,i=e.length,o=0;o<i;o++){t=e[o];for(var n=o+1;n<i;n++)o!==n&&(r=e[n],t.setTwinFace(r))}},Er.getBestFacePlaneToProject=function(e){var t=-1,r=Math.abs(e.x),i=Math.abs(e.y),o=Math.abs(e.z);return o>r&&o>=i?t=0:r>=i&&r>=o?t=1:i>r&&i>=o&&(t=2),t},Er.getBestCubeFaceToProject=function(e){var t=I.boxFace.UNKNOWN,r=Er.getBestFacePlaneToProject(e);if(0===r)t=e.z>0?I.boxFace.TOP:I.boxFace.BOTTOM;else if(1===r){t=e.x>0?I.boxFace.RIGHT:I.boxFace.LEFT}else if(2===r){t=e.y>0?I.boxFace.REAR:I.boxFace.FRONT}return t},Er.getProjectedPolygon2D=function(e,t,r){void 0===r&&(r=new $r),void 0===r.point2dList&&(r.point2dList=new Zr);var i=r.point2dList;return i.pointsArray=Si.getProjectedPoints2DArray(e,t,i.pointsArray),r},Er.prototype.getTessellatedTriangles=function(e){if(void 0===e&&(e=[]),this.getVerticesCount()<=3)return e=this.getTrianglesConvex(e);var t,r=this.getPlaneNormal(),i=Er.getProjectedPolygon2D(this.vertexArray,r,void 0);t=i.calculateNormal(t);var o=[];i.tessellate(t,o),this.calculateVerticesNormals();for(var n=o.length,a=0;a<n;a++){var s=o[a];if(0!==s.point2dList.getPointsCount()){var l,u,c,d,h,f;l=s.point2dList.getPoint(0).ownerVertex3d;for(var g=s.point2dList.getPointsCount(),p=1;p<g-1;p++)h=s.point2dList.getPoint(p),f=s.point2dList.getPoint(p+1),u=h.ownerVertex3d,c=f.ownerVertex3d,d=new bi(l,u,c),e.push(d)}}return e},Er.prototype.getTrianglesConvex=function(e){if(void 0===this.vertexArray||0===this.vertexArray.length)return e;var t,r,i,o;void 0===e&&(e=[]),t=this.getVertex(0);for(var n=this.getVerticesCount(),a=1;a<n-1;a++)r=this.getVertex(a),i=this.getVertex(a+1),o=new bi(t,r,i),e.push(o);return e},Er.prototype.setTwinHalfEdge=function(e){for(var t=!1,r=this.hEdge,i=this.hEdge;!t;){if(i.setTwin(e))return!0;(i=i.next)===r&&(t=!0)}return!1},Er.prototype.getFrontierHalfEdges=function(e){var t=this.getHalfEdgesLoop(void 0);if(void 0===t)return e;void 0===e&&(e=[]);for(var r,i=t.length,o=0;o<i;o++)(r=t[o]).isFrontier()&&e.push(r);return e},Er.prototype.getHalfEdgesLoop=function(e){return void 0===this.hEdge?e:e=Lr.getHalfEdgesLoop(this.hEdge,e)},Er.prototype.setTwinFace=function(e){if(void 0===e)return!1;if(void 0===this.hEdge||void 0===e.hEdge)return!1;for(var t,r=e.getHalfEdgesLoop(void 0),i=r.length,o=!1,n=0;n<i;n++)t=r[n],this.setTwinHalfEdge(t)&&(o=!0);return o},Er.prototype.createHalfEdges=function(e){if(void 0===this.vertexArray||0===this.vertexArray.length)return e;var t,r;void 0===e&&(e=[]);for(var i,o=this.getVerticesCount(),n=0;n<o;n++)t=this.getVertex(n),(r=new Lr).setStartVertex(t),r.setFace(this),e.push(r);for(n=0;n<o;n++)r=e[n],i=e[Si.getNextIdx(n,this.vertexArray)],r.setNext(i);return this.hEdge=e[0],e},Er.prototype.getBoundingBox=function(){if(void 0===this.bbox){for(var e=new G,t=0,r=this.getVerticesCount();t<r;t++){var i=this.getVertex(t);0===t?e.init(i.point3d):e.addPoint(i.point3d)}this.bbox=e}return this.bbox},Er.prototype.getBoundingSphere=function(){return this.getBoundingBox().getBoundingSphere()};var Lr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.startVertex,this.next,this.twin,this.face};Lr.prototype.deleteObjects=function(){this.startVertex=void 0,this.next=void 0,this.twin=void 0,this.face=void 0},Lr.prototype.setStartVertex=function(e){this.startVertex=e,e.outingHedge=this},Lr.prototype.setNext=function(e){this.next=e},Lr.prototype.setTwin=function(e){var t=Lr.areTwinables(e,this);return t&&(this.twin=e,e.twin=this),t},Lr.prototype.setFace=function(e){this.face=e,this.face.hEdge=this},Lr.prototype.getSegment3d=function(){if(void 0!==this.next){var e=this.getStartVertex().getPosition(),t=this.getEndVertex().getPosition();return new vi(e,t)}},Lr.prototype.getStartVertex=function(){return this.startVertex},Lr.prototype.getEndVertex=function(){if(void 0!==this.next)return this.next.startVertex},Lr.prototype.isFrontier=function(){return void 0===this.twin||null===this.twin},Lr.prototype.getPrev=function(){for(var e=this;;){if(e.next===this)return e;if(void 0===e.next)return;e=e.next}},Lr.prototype.getNextFrontier=function(){return this.getEndVertex().getOutingFrontierHEdge()},Lr.areTwinables=function(e,t){return e.startVertex===t.getEndVertex()&&e.getEndVertex()===t.startVertex},Lr.getHalfEdgesLoop=function(e,t){if(void 0===e)return t;void 0===t&&(t=[]),t.length=0;for(var r=e,i=e,o=!1;!o;)t.push(i),(i=i.next)!==r&&void 0!==i||(o=!0);return t};var wr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.hEdgesArray};wr.getSegment3dsFromHedgesArray=function(e,t){var r=e.length;if(0===r)return t;void 0===t&&(t=[]);for(var i=0;i<r;i++)t.push(e[i].getSegment3d());return t},wr.prototype.deleteObjects=function(){if(void 0!==this.hEdgesArray){for(var e=this.hEdgesArray.length,t=0;t<e;t++)this.hEdgesArray[t].deleteObjects(),this.hEdgesArray[t]=void 0;this.hEdgesArray=void 0}},wr.prototype.newHalfEdge=function(){void 0===this.hEdgesArray&&(this.hEdgesArray=[]);var e=new Lr;return this.hEdgesArray.push(e),e},wr.prototype.addHalfEdgesArray=function(e){void 0!==e&&(void 0===this.hEdgesArray&&(this.hEdgesArray=[]),Array.prototype.push.apply(this.hEdgesArray,e))};var Sr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.owner,this.idx};Sr.prototype.deleteObjects=function(){this.owner=void 0,this.idx=void 0};var Dr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.strIdx,this.endIdx};Dr.prototype.copyFrom=function(e){void 0!==e&&(this.strIdx=e.strIdx,this.endIdx=e.endIdx)},Dr.prototype.deleteObjects=function(){this.strIdx=void 0,this.endIdx=void 0};var Rr=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.point=void 0!==t?new Jr(t.x,t.y,t.z):new Jr,this.direction=void 0!==r?r:new Jr};Rr.prototype.setPointAndDir=function(e,t,r,i,o,n){this.point.set(e,t,r),this.direction.set(i,o,n),this.direction.unitary()},Rr.prototype.set2Points=function(e,t,r,i,o,n){var a=new Jr(i-e,o-t,n-r);a.unitary(),this.setPointAndDir(e,t,r,a.x,a.y,a.z)},Rr.prototype.getProjectedPoint=function(e,t){void 0===t&&(t=new Jr);var r=new We;return r.setPointAndNormal(e.x,e.y,e.z,this.direction.x,this.direction.y,this.direction.z),t=r.intersectionLine(this,t)},Rr.prototype.getDistToPoint=function(e){return this.getProjectedPoint(e).distToPoint(e)},Rr.prototype.intersectsWithSphere=function(e){var t=e.centerPoint,r=e.r;return this.getDistToPoint(t)<r},Rr.prototype.isCoincidentPoint=function(e,t){if(void 0===e)return!1;var r=this.getProjectedPoint(e);return void 0!==r&&(void 0===t&&(t=1e-7),r.squareDistToPoint(e)<t*t)};var Pr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.point=new Kr,this.direction=new Kr};Pr.prototype.setPointAndDir=function(e,t,r,i){this.point.set(e,t),this.direction.set(r,i),this.direction.unitary()},Pr.prototype.distToPoint=function(e){var t=this.getProjectedPoint(e);return e.distToPoint(t)},Pr.prototype.getPerpendicularRight=function(e){var t=new Pr;return e?t.point.set(e.x,e.y):t.point.set(this.point.x,this.point.y),t.direction.set(this.direction.y,-this.direction.x),t},Pr.prototype.getParallelRight=function(e){var t=this.getPerpendicularRight().direction,r=new Pr;return r.point.set(this.point.x+t.x*e,this.point.y+t.y*e),r.direction.copyFrom(this.direction),r},Pr.prototype.getParallelLeft=function(e){var t=this.getPerpendicularLeft().direction,r=new Pr;return r.point.set(this.point.x+t.x*e,this.point.y+t.y*e),r.direction.copyFrom(this.direction),r},Pr.prototype.getPerpendicularLeft=function(e){var t=new Pr;return e?t.point.set(e.x,e.y):t.point.set(this.point.x,this.point.y),t.direction.set(-this.direction.y,this.direction.x),t},Pr.prototype.getRelativeSideOfPoint=function(e,t){void 0===t&&(t=1e-7);var r=this.getProjectedPoint(e);if(e.squareDistToPoint(r)<t*t)return I.relativePosition2D.COINCIDENT;var i=new Kr(e.x-r.x,e.y-r.y);return i.unitary(),this.getPerpendicularLeft(e).direction.scalarProduct(i)<0?I.relativePosition2D.RIGHT:I.relativePosition2D.LEFT},Pr.prototype.getProjectedPoint=function(e,t){if(void 0!==e){void 0===t&&(t=new Kr);var r=this.getPerpendicularLeft(e);return t=this.intersectionWithLine(r,t)}},Pr.prototype.isCoincidentPoint=function(e,t){if(void 0===e)return!1;void 0===t&&(t=1e-7);var r=this.getProjectedPoint(e,r);return e.squareDistToPoint(r)<t*t},Pr.prototype.isParallelToLine=function(e){if(void 0===e)return!1;var t=this.direction.angleRadToVector(e.direction);return t<1e-9||Math.abs(t-Math.PI)<1e-9},Pr.prototype.intersectionWithLine=function(e,t){if(void 0!==e&&!this.isParallelToLine(e)){var r,i;if(Math.abs(this.direction.x)<1e-9){var o=e.direction.y/e.direction.x,n=e.point.y-o*e.point.x;r=this.point.x,i=o*this.point.x+n}else if(Math.abs(this.direction.y)<1e-9)if(Math.abs(e.direction.x)<1e-9)r=e.point.x,i=this.point.y;else{o=e.direction.y/e.direction.x,n=e.point.y-o*e.point.x;r=(this.point.y-n)/o,i=this.point.y}else if(Math.abs(e.direction.x)<1e-9){var a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;i=(r=e.point.x)*a+s}else{a=this.direction.y/this.direction.x,s=this.point.y-a*this.point.x;i=(o=e.direction.y/e.direction.x)*(r=(s-(n=e.point.y-o*e.point.x))/(o-a))+n}return void 0===t&&(t=new Kr),t.set(r,i),t}};var Ir=function e(t,i){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.setPosition(t),this.style={},i&&(this.style=i)};(Ir.prototype=Object.create(r.prototype)).constructor=Ir,Ir.prototype.setPosition=function(e){return ln()},Ir.prototype.setStyle=function(e,t){if(!e)throw new Error(Ue.REQUIRED_EMPTY_ERROR("style"));for(var r in t&&t instanceof Fe&&this.init(t),e)e.hasOwnProperty(r)&&(this.style[r]=e[r])};var Fr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.meshesArray,this.geoLocDataManager,this.vboKeysContainer};Fr.prototype.newParametricMesh=function(){void 0===this.meshesArray&&(this.meshesArray=[]);var e=new Wr;return this.meshesArray.push(e),e},Fr.prototype.deleteObjects=function(){if(void 0!==this.meshesArray){for(var e=this.meshesArray.length,t=0;t<e;t++)this.meshesArray[t].deleteObjects(),this.meshesArray[t]=void 0;this.meshesArray=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0}},Fr.prototype.getMeshesCount=function(){return void 0===this.meshesArray?0:this.meshesArray.length},Fr.prototype.getMesh=function(e){if(void 0!==this.meshesArray)return this.meshesArray[e]};var Or=function e(t,r,i){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.geoCoord,this.description,i&&(this.description=i.description),Ir.call(this,t,r);var o=new ye,n=o.newGeoLocationData();n=on.calculateGeoLocationData(this.geoCoord.longitude,this.geoCoord.latitude,this.geoCoord.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,r&&r.isMovable&&(this.attributes.isMovable=r.isMovable)};Or.prototype=Object.create(Ir.prototype),Or.prototype.constructor=Or,Or.prototype.setPosition=function(e){e&&(this.geoCoord=new pe(e.longitude,e.latitude,e.altitude))},Or.prototype._moveStart=function(){if(this.description){var e=this.description.owner;if(e instanceof Tr){var t=this.description.type;"curveMember"===t?e.knotPointMoved(this.description):"curveControlMember"===t&&e.controlPointMoved(this.description)}}},Or.prototype.makeMesh=function(e){var t=new xt,r=t.newVBOVertexIdxCacheKey(),i=e.vboMemoryManager,o=new Float32Array([0,0,0]);r.setDataArrayPos(o,i);var n=this.style,a=new co(n);a.owner=this,a.vboKeysContainer=t,this.objectsArray.push(a),this.setDirty(!1)};var Br=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var i;this.knotGeoCoordsArray,this.vboThickLinesByGeoCoords,Ir.call(this,t,r),this.style.thickness||(this.style.thickness=2),i=this.knotGeoCoordsArray[0];var o=new ye,n=o.newGeoLocationData();n=on.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,n.rotMatrix.Identity()};Br.prototype=Object.create(Ir.prototype),Br.prototype.constructor=Br,Br.prototype.setPosition=function(e){var t=e.coordinates.length;if(t>1){void 0===this.knotGeoCoordsArray&&(this.knotGeoCoordsArray=[]);for(var r=0;r<t;r++){var i=e.coordinates[r],o=new pe(i.longitude,i.latitude,i.altitude);this.knotGeoCoordsArray.push(o)}}},Br.prototype.getVBOThickLinesByGeoCoords=function(e,t){return void 0===this.vboThickLinesByGeoCoords&&(this.vboThickLinesByGeoCoords=ve.getVBOThickLines(e,geoCoordsArray,void 0,t)),this.vboThickLinesByGeoCoords},Br.prototype.makeMesh=function(e){if(void 0!==this.knotGeoCoordsArray){var t=J.fromHexCode(this.style.color,void 0),r={thickness:this.style.thickness,color:t},i=ve.getRenderableObjectOfGeoCoordsArray(this.knotGeoCoordsArray,e,r);if(this.style.point){var o=this.style.point,n=this.knotGeoCoordsArray.length;if(n>1)for(var a=0;a<n;a++){var s=this.knotGeoCoordsArray[a],l={longitude:s.longitude,latitude:s.latitude,altitude:s.altitude},u=new Or(l,o);this.objectsArray.push(u)}}this.objectsArray.push(i),this.setDirty(!1)}},Br.prototype.getPointByIndex=function(e){var t=this.getPoints();if(t.length<=e)throw new Error("Out of range");if(t.length>0)return t[e]},Br.prototype.getPoints=function(){return this.objectsArray.filter(function(e){return e instanceof Or})};var Nr=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var i;this.knotGeoCoordsArray,this.vboThickLinesByGeoCoords,Ir.call(this,t,r),this.style.thickness||(this.style.thickness=2),i=this.knotGeoCoordsArray[0];var o=new ye,n=o.newGeoLocationData();n=on.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,n.rotMatrix.Identity()};(Nr.prototype=Object.create(Ir.prototype)).constructor=Nr,Nr.prototype.setPosition=function(e){var t=e.coordinates.length;if(t>1){void 0===this.knotGeoCoordsArray&&(this.knotGeoCoordsArray=[]);for(var r=0;r<t;r++){var i=e.coordinates[r],o=new pe(i.longitude,i.latitude,i.altitude);this.knotGeoCoordsArray.push(o)}}},Nr.prototype.getVBOThickLinesByGeoCoords=function(e,t){return void 0===this.vboThickLinesByGeoCoords&&(this.vboThickLinesByGeoCoords=ve.getVBOThickLines(e,geoCoordsArray,void 0,t)),this.vboThickLinesByGeoCoords},Nr.prototype.makeMesh=function(e){if(void 0!==this.knotGeoCoordsArray){var t=J.fromHexCode(this.style.color,void 0),r={thickness:this.style.thickness,color:t},i=ve.getRenderableExpandedAndExtrudedObjectOfGeoCoordsArray(this.knotGeoCoordsArray,e,r);if(this.style.point){var o=this.style.point,n=this.knotGeoCoordsArray.length;if(n>1)for(var a=0;a<n;a++){var s=this.knotGeoCoordsArray[a],l={longitude:s.longitude,latitude:s.latitude,altitude:s.altitude},u=new Or(l,o);this.objectsArray.push(u)}}this.objectsArray.push(i),this.setDirty(!1)}},Nr.prototype.getPointByIndex=function(e){var t=this.getPoints();if(t.length<=e)throw new Error("Out of range");if(t.length>0)return t[e]},Nr.prototype.getPoints=function(){return this.objectsArray.filter(function(e){return e instanceof Or})};var Ur=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var i;this.minGeographicCoord,this.maxGeographicCoord,Ir.call(this,t,r),i=pe.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,i);var o=new ye,n=o.newGeoLocationData();n=on.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,n.rotMatrix.Identity()};Ur.prototype=Object.create(Ir.prototype),Ur.prototype.constructor=Ur,Ur.prototype.clone=function(){var e={minLongitude:this.minGeographicCoord.longitude,minLatitude:this.minGeographicCoord.latitude,maxLongitude:this.maxGeographicCoord.longitude,maxLatitude:this.maxGeographicCoord.latitude,altitude:this.maxGeographicCoord.altitude},t=JSON.parse(JSON.stringify(this.style));return new Ur(e,t)},Ur.prototype.setPosition=function(e){if(!e)throw new Error(Ue.REQUIRED_EMPTY_ERROR("position"));var t=e.altitude;e.minLongitude&&e.minLatitude&&(this.minGeographicCoord=new pe(e.minLongitude,e.minLatitude,t)),e.maxLongitude&&e.maxLatitude&&(this.maxGeographicCoord=new pe(e.maxLongitude,e.maxLatitude,t))},Ur.prototype.getArea=function(){var e=new pe(this.minGeographicCoord.longitude,this.maxGeographicCoord.latitude,this.maxGeographicCoord.altitude),t=Te.getArcDistanceBetweenGeographicCoords(this.minGeographicCoord,e),r=Te.getArcDistanceBetweenGeographicCoords(e,this.maxGeographicCoord);return Math.abs(r*t)},Ur.prototype.makeMesh=function(e){var t,r,i,o=this.minGeographicCoord.longitude,n=this.minGeographicCoord.latitude,a=this.maxGeographicCoord.longitude,s=this.maxGeographicCoord.latitude;t=Math.floor(5*(a-o)),r=Math.floor(5*(s-n)),t<1&&(t=1),r<1&&(r=1),i=this.minGeographicCoord.altitude;var l=Math.PI/180,u=o*l,c=n*l,d=a*l,h=s*l,f=d-u,g=h-c,p=f/t,m=g/r,v=(t+1)*(r+1),x=new Float32Array(v),_=new Float32Array(v),y=new Float32Array(v);this.texCoordsArray=new Float32Array(2*v);var T,C,b=u,M=c,A=0,E=0;i&&(E=i);for(var L=0;L<r+1;L++){(M=c+m*L)>h&&(M=h);for(var w=0;w<t+1;w++)(b=u+p*w)>d&&(b=d),x[A]=b,_[A]=M,y[A]=E,T=(b-u)/f,C=(M-c)/g,this.texCoordsArray[2*A]=T,this.texCoordsArray[2*A+1]=1-C,A++}this.cartesiansArray=void 0,this.cartesiansArray=Te.geographicRadianArrayToFloat32ArrayWgs84(x,_,y,this.cartesiansArray),this.normalsArray=new Int8Array(3*v);for(var S=new Jr,D=0;D<v;D++)S.set(this.cartesiansArray[3*D],this.cartesiansArray[3*D+1],this.cartesiansArray[3*D+2]),S.unitary(),this.normalsArray[3*D]=126*S.x,this.normalsArray[3*D+1]=126*S.y,this.normalsArray[3*D+2]=126*S.z;var R=t+1,P=r+1,I={bCalculateBorderIndices:!0},F=en.getIndicesTrianglesRegularNet(R,P,void 0,void 0,void 0,void 0,void 0,I);this.indices=F.indicesArray,this.southIndices=F.southIndicesArray,this.eastIndices=F.eastIndicesArray,this.northIndices=F.northIndicesArray,this.westIndices=F.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length;var O=this.geoLocDataManager.getCurrentGeoLocationData();if(void 0!==this.cartesiansArray){var B=this.cartesiansArray.length/3;for(D=0;D<B;D++)this.cartesiansArray[3*D]-=O.position.x,this.cartesiansArray[3*D+1]-=O.position.y,this.cartesiansArray[3*D+2]-=O.position.z;var N=new xt,U=N.newVBOVertexIdxCacheKey(),G=e.vboMemoryManager;U.setDataArrayPos(this.cartesiansArray,G),this.normalsArray&&U.setDataArrayNor(this.normalsArray,G),this.texCoordsArray&&U.setDataArrayTexCoord(this.texCoordsArray,G),U.setDataArrayIdx(this.indices,G);var z=new kr;if(z.vboKeysContainer=N,z.material=new Hr,this.style.imageUrl){var H=this.style.imageUrl;z.material.setDiffuseTextureUrl(H)}if(this.style.fillColor){var V=J.fromHexCode(this.style.fillColor,void 0);z.material.setColor4(V.r,V.g,V.b,1)}if(this.style.opacity&&(this.attributes.opacity=this.style.opacity),void 0!==this.style.strokeWidth){this.contourIndices=[],Array.prototype.push.apply(this.contourIndices,this.southIndices);var k=this.eastIndices.length;for(D=1;D<k;D++)this.contourIndices.push(this.eastIndices[D]);var j=this.northIndices.length;for(D=1;D<j;D++)this.contourIndices.push(this.northIndices[D]);var W=this.westIndices.length;for(D=1;D<W;D++)this.contourIndices.push(this.westIndices[D]);var X=[],Y=this.contourIndices.length;for(D=0;D<Y;D++){A=this.contourIndices[D];var q=this.cartesiansArray[3*A],K=this.cartesiansArray[3*A+1],Z=this.cartesiansArray[3*A+2],Q=new Jr(q,K,Z);X.push(Q)}I={thickness:this.style.strokeWidth};if(void 0!==this.style.strokeColor){V=J.fromHexCode(this.style.strokeColor,void 0);I.color=V}var $=new _o(I);$.vboKeysContainer=Qr.getVboThickLines(e,X,$.vboKeysContainer,I),this.objectsArray.push($)}this.objectsArray.push(z),this.setDirty(!1)}},Ur.prototype.setStyle=function(e,t){if(!e)throw new Error(Ue.REQUIRED_EMPTY_ERROR("style"));t&&t instanceof Fe&&this.init(t);var r=t.modeler.existObject(this);for(var i in e)if(e.hasOwnProperty(i)){var o="clampToTerrain"===i&&e[i]!==this.style[i];o&&r&&t.modeler.removeObject(this),this.style[i]=e[i],o&&r&&t.modeler.addObject(this,1),this.style.clampToTerrain&&"imageUrl"===i&&(this.texture=void 0,t.tinTerrainManager.imageryLayersChanged())}};var Gr=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var i;this.minGeographicCoord,this.maxGeographicCoord,Ir.call(this,t,r),i=pe.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,i);var o=new ye,n=o.newGeoLocationData();n=on.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,void 0,void 0,void 0,n),this.geoLocDataManager=o,void 0===this.color4&&this.setOneColor(.7,.7,.7,.5),this.style&&(this.style.fillColor&&J.fromHexCode(this.style.fillColor,this.color4),this.style.opacity&&(this.color4.a=this.style.opacity))};Gr.prototype=Object.create(Ir.prototype),Gr.prototype.constructor=Gr,Gr.prototype.makeMesh=function(e){if(this.maxGeographicCoord&&this.minGeographicCoord){var t;t=pe.getMidPoint(this.minGeographicCoord,this.maxGeographicCoord,t);var r=new ye,i=r.newGeoLocationData();i=on.calculateGeoLocationData(t.longitude,t.latitude,t.altitude,void 0,void 0,void 0,i),this.geoLocDataManager=r;var o=[],n=this.minGeographicCoord.longitude,a=this.minGeographicCoord.latitude,s=this.minGeographicCoord.altitude,l=this.maxGeographicCoord.longitude,u=this.maxGeographicCoord.latitude,c=new pe(n,a,s);o.push(c),c=new pe(l,a,s),o.push(c),c=new pe(l,u,s),o.push(c),c=new pe(n,u,s),o.push(c);var d=new ve(o).getExtrudedMeshRenderableObject(1e4,!0,void 0,e,void 0);this.objectsArray.push(d.objectsArray[0]),this.setDirty(!1)}},Gr.prototype.setPosition=function(e){if(!e)throw new Error(Ue.REQUIRED_EMPTY_ERROR("position"));var t=e.altitude;e.minLongitude&&e.minLatitude&&(this.minGeographicCoord=new pe(e.minLongitude,e.minLatitude,t)),e.maxLongitude&&e.maxLatitude&&(this.maxGeographicCoord=new pe(e.maxLongitude,e.maxLatitude,t))},Gr.prototype.setStyle=function(e,t){if(!e)throw new Error(Ue.REQUIRED_EMPTY_ERROR("style"));t&&t instanceof Fe&&this.init(t);var r=t.modeler.existObject(this);for(var i in e)if(e.hasOwnProperty(i)){var o="clampToTerrain"===i&&e[i]!==this.style[i];o&&r&&t.modeler.removeObject(this),this.style[i]=e[i],o&&r&&t.modeler.addObject(this,1),this.style.clampToTerrain&&"imageUrl"===i&&(this.texture=void 0,t.tinTerrainManager.imageryLayersChanged())}},Gr.prototype.clone=function(){var e={minLongitude:this.minGeographicCoord.longitude,minLatitude:this.minGeographicCoord.latitude,maxLongitude:this.maxGeographicCoord.longitude,maxLatitude:this.maxGeographicCoord.latitude,altitude:-200},t=JSON.parse(JSON.stringify(this.style));return new Ur(e,t)},Gr.prototype.getArea=function(){var e=new pe(this.minGeographicCoord.longitude,this.maxGeographicCoord.latitude,this.maxGeographicCoord.altitude),t=Te.getArcDistanceBetweenGeographicCoords(this.minGeographicCoord,e),r=Te.getArcDistanceBetweenGeographicCoords(e,this.maxGeographicCoord);return Math.abs(r*t)},Gr.prototype.render=function(e,t,r,i,o){if(1!==r)return!1;if(this.dirty&&this.makeMesh(e),0===this.objectsArray.length)return!1;var n,a=e.sceneState,s=a.gl,l=e.postFxShadersManager;n="groundStencilPrimitives"!==t.getName()?l.getShader("groundStencilPrimitives"):t,l.useProgram(n),n.resetLastBuffersBinded(),n.enableVertexAttribArray(n.position3_loc),n.bindUniformGenerals(),1===r&&(n.disableVertexAttribArray(n.color4_loc),n.disableVertexAttribArray(n.normal3_loc),n.disableVertexAttribArray(n.texCoord2_loc),s.uniform1i(n.colorType_loc,0),s.uniform4fv(n.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),s.uniform1i(n.bApplySsao_loc,!0),s.uniform1i(n.colorType_loc,1),s.uniform1i(n.bApplySpecularLighting_loc,!0)),s.uniform1i(n.refMatrixType_loc,0),s.uniform3fv(n.aditionalMov_loc,[0,0,0]),s.uniform3fv(n.refTranslationVec_loc,[0,0,0]),s.uniform3fv(n.scaleLC_loc,[1,1,1]),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(s,n),s.uniform1i(n.bUseLogarithmicDepth_loc,l.bUseLogarithmicDepth),s.uniform1f(n.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),s.colorMask(!1,!1,!1,!1),s.depthMask(!1),s.enable(s.CULL_FACE),s.enable(s.STENCIL_TEST),s.clearStencil(0);var u=this.objectsArray[0];s.cullFace(s.FRONT),s.stencilFunc(s.ALWAYS,0,255),s.stencilOp(s.KEEP,s.INCR,s.KEEP),u.render(e,n,r,void 0),s.cullFace(s.BACK),s.stencilFunc(s.ALWAYS,0,255),s.stencilOp(s.KEEP,s.DECR,s.KEEP),u.render(e,n,r,void 0),1===r&&(s.uniform1i(n.colorType_loc,0),s.uniform4fv(n.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])),s.colorMask(!0,!0,!0,!0),s.depthMask(!0),s.stencilMask(0),s.stencilFunc(s.LEQUAL,1,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE),s.cullFace(s.FRONT),s.depthFunc(s.GREATER),u.render(e,n,r,void 0),s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL),s.disable(s.STENCIL_TEST),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),s.disable(s.POLYGON_OFFSET_FILL),s.cullFace(s.BACK),s.stencilMask(255)};var zr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t,this.cameraMovable=!0};zr.prototype.renderScene=function(){var e=this.magoManager,t=e.sceneState;if("none"!==t.canvas.parentElement.style.display){var r=t.gl;r.enable(r.DEPTH_TEST),r.viewport(0,0,r.viewportWidth,r.viewportHeight),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),e.start(void 0,!0,0,1)}},zr.prototype.goto=function(e,t,r,i,o){var n=Te.geographicToCartesianWgs84(e,t,r,n),a=this.magoManager.sceneState.camera,s=a.position;if(i){var l=Te.CartesianToGeographicWgs84(s.x,s.y,s.z,void 0,!1),u=new pe(e,t,r),c=pe.getMidPoint(l,u,void 0),d=pe.getAngleBetweenCoords(l,u);c.altitude<3e4*d&&(c.altitude=3e4*d);var h=new Tr;h.getGeographicCoordsList().addGeoCoordsArray([l,c,u]);var f={animationType:I.animationType.PATH};f.path=h,f.birthTime=this.magoManager.getCurrentTime(),f.linearVelocityInMetersSecond=5e5,f.acceleration=2e3,f.durationInSeconds=Zo(i,3),a.animationData=f,void 0===this.magoManager.animationManager&&(this.magoManager.animationManager=new U),this.magoManager.animationManager.putObject(a)}else this.changeCameraPosition(n,o)},zr.prototype.changeCameraOrientation=function(e,t,r,i){if(e=parseFloat(e),t=parseFloat(t),r=parseFloat(r),isNaN(e))throw new Error("Heading require number type.");if(isNaN(t))throw new Error("Pitch require number type.");if(isNaN(r))throw new Error("Roll require number type.");var o=this.magoManager.sceneState.camera;X.setOrientation(o,e,t,r),this.updateModelViewMatrixByCamera(o,i)},zr.prototype.moveBackward=function(e,t){var r=this.magoManager.sceneState.camera,i=r.position,o=r.direction;e*=-1;var n=Jr.scale(o,e),a=Jr.add(i,n);this.changeCameraPosition(Jr.toArray(a),t)},zr.prototype.changeCameraPosition=function(e,t){var r=this.magoManager.sceneState.camera,i=r.position,o=r.direction,n=r.up,a=r.getOrientation(),s=180*a.headingRad/Math.PI,l=180*a.pitchRad/Math.PI;i.set(e[0],e[1],e[2]);var u=on.calculateTransformMatrixAtWorldPosition(i,s,l,0)._floatArrays;o.set(-u[8],-u[9],-u[10]),n.set(u[4],u[5],u[6]),this.updateModelViewMatrixByCamera(r,t)},zr.prototype.mousedown=function(e){this.magoManager.sceneState.mouseButton=e.button,zr.updateMouseStartClick(e.offsetX,e.offsetY,this.magoManager),this.magoManager.isCameraMoving=!0,this.magoManager.mouse_x=e.offsetX,this.magoManager.mouse_y=e.offsetY,0===this.magoManager.sceneState.mouseButton&&this.magoManager.mouseActionLeftDown(e.offsetX,e.offsetY)},zr.updateMouseClick=function(e,t,r){var i=r.sceneState.mouseAction;i.curX=e,i.curY=t},zr.prototype.mouseup=function(e){var t=this.magoManager;t.bPicking=!1,t.isCameraMoving=!1;var r=t.sceneState,i=r.mouseAction;if(0===r.mouseButton){if((new Date).getTime()-i.strTime<200){var o=e.offsetX-i.strX,n=e.offsetY-i.strY;Math.abs(o)<3&&Math.abs(n)<3&&(t.bPicking=!0,t.managePickingProcess())}this.magoManager.mouseActionLeftUp(e.offsetX,e.offsetY)}r.mouseButton=-1;var a=(new Date).getTime()-i.strTime,s=r.camera;a>.001&&a<200?s.lastMovement.deltaTime=a:s.lastMovement.movementType=I.movementType.NO_MOVEMENT,t.mustCheckIfDragging=!0},zr.prototype.mouseclick=function(e){if(2!==e.detail&&0===e.button){var t=e.offsetX,r=e.offsetY;this.magoManager.mouseActionLeftClick(t,r)}},zr.prototype.mouseRightClick=function(e){if(2!==e.detail&&2===e.button){var t=e.offsetX,r=e.offsetY;this.magoManager.mouseActionRightClick(t,r)}},zr.prototype.mouseDblClick=function(e){if(e.preventDefault(),e.stopPropagation(),0===e.button){var t=e.offsetX,r=e.offsetY;this.magoManager.mouseActionLeftDoubleClick(t,r)}},zr.prototype.mousewheel=function(e){if(this.cameraMovable){var t;e.wheelDelta?(t=e.wheelDelta/10,window.opera&&(t=-t)):t=-e.deltaY/3*12;var r=!0;t<0&&(r=!1);var i=this.magoManager,o=(i.sceneState.mouseAction,i.sceneState.camera),n=o.position,a=o.direction,s=o.up,l=e.offsetX,u=e.offsetY,c=on.getRayWorldSpace(void 0,l,u,void 0,i).direction,d=o.getCameraElevation(),h=Math.abs(d);if(!isNaN(d)){t*=d*d*1e-5+.001*h,r?t+=1:t-=1;var f=.5*h;f>2e5&&(f=2e5),r?t>f&&(t=f):t<-f&&(t=-f),Math.abs(t)<100&&(t=t<0?-20:20);var g,p=new Jr(n.x,n.y,n.z),m=new Jr(n.x+c.x*t,n.y+c.y*t,n.z+c.z*t);if(n.set(m.x,m.y,m.z),(g=p.crossProduct(m,g)).unitary(),!g.isNAN()){var v=p.angleRadToVector(m);if(0!==v&&!isNaN(v)){var x=new Ne;x.rotationAxisAngRad(v,g.x,g.y,g.z),a=x.transformPoint3D(a,a),s=x.transformPoint3D(s,s),this.updateModelViewMatrixByCamera(o)}}}}},zr.prototype.moveSelectedObject=function(e){var t=this.magoManager,r=t.selectionManager.getSelectedGeneral();t.moveSelectedObjectGeneral(void 0,r)},zr.prototype.mousemove=function(e){var t=this.magoManager,r=e.offsetX,i=e.offsetY;t.mouse_x=r,t.mouse_y=i,t.mustCheckIfDragging&&(t.isDragging()?t.mouseDragging=!0:t.mouseDragging=!1,t.mustCheckIfDragging=!1);var o=t.sceneState.mouseAction;if(o.strCamCoordPoint){var n=this.magoManager.sceneState.camera,a=o.strX,s=o.strY;if(this.magoManager.mouseActionMove({x:r,y:i},{x:a,y:s}),this.cameraMovable){void 0===n.lastMovement&&(n.lastMovement=new ze);var l=t.getCurrentTime()-o.strTime;if(0===t.sceneState.mouseButton){if(r===o.strX&&i===o.strY)return;var u=o.strX-r,c=o.strY-i;if(Math.abs(u)<3&&Math.abs(c)<3)return;t.sceneState.gl;var d=t.sceneState,h=o.strCamera,f=(g=o.strWorldPoint).getModul();if((p=o.strCamCoordPoint).getModul()<30){var g=o.strWorldPoint,p=o.strCamCoordPoint,m=(Te.planeAtCartesianPointWgs84(g.x,g.y,g.z,void 0),Te.normalAtCartesianPointWgs84(g.x,g.y,g.z,void 0)),v=new Jr(m[0],m[1],m[2]),x=d.modelViewMatrix.rotatePoint3D(v,void 0),_=new We;_.setPointAndNormal(p.x,p.y,p.z,x.x,x.y,x.z);var y=on.getRayCamSpace(r,i,S,this.magoManager);(S=new Rr).setPointAndDir(0,0,0,y[0],y[1],y[2]);var T=_.intersectionLine(S,void 0);if(void 0===T)return;var C=new Jr(T.x-p.x,T.y-p.y,T.z-p.z),b=(D=d.getModelViewMatrixInv()).rotatePoint3D(C,void 0),M=b.getModul();if(M>100||M<1e-5)return;n.copyPosDirUpFrom(h);var A=new Jr(-b.x,-b.y,-b.z);n.translate(A),this.updateModelViewMatrixByCamera(n);var E=new Jr;E.copyFrom(b),E.unitary();var L=M/l*.25;n.lastMovement.movementType=I.movementType.TRANSLATION,n.lastMovement.currLinearVelocity=L,n.lastMovement.translationDir=E}else{var w,S;d=this.magoManager.sceneState,h=o.strCamera,n=this.magoManager.sceneState.camera,f=(g=o.strWorldPoint).getModul();S=on.getRayCamSpace(r,i,S,this.magoManager),void 0===this.pointSC&&(this.pointSC=new Jr),this.pointSC.set(S[0],S[1],S[2]);var D=o.strModelViewMatrixInv;this.pointSC2=D.rotatePoint3D(this.pointSC,this.pointSC2),this.pointSC2.unitary(),w=new Rr;var R,P=h.position;if(w.setPointAndDir(1e-4*P.x,1e-4*P.y,1e-4*P.z,this.pointSC2.x,this.pointSC2.y,this.pointSC2.z),void 0===(R=this.magoManager.globe.intersectionLineWgs84(w,R,1e-4*f)))return;var F,O=new Jr(1e-4*g.x,1e-4*g.y,1e-4*g.z),B=new Jr(R[0],R[1],R[2]);if((F=O.crossProduct(B,F)).unitary(),F.isNAN())return;var N=O.angleRadToVector(B);if(N<1e-8||isNaN(N))return;n.copyPosDirUpFrom(h);var U=new Ne;U.rotationAxisAngRad(-N,F.x,F.y,F.z),n.transformByMatrix4(U),this.updateModelViewMatrixByCamera(n);var G=N/l*.25;n.lastMovement.movementType=I.movementType.ROTATION,n.lastMovement.currAngularVelocity=G,n.lastMovement.rotationAxis=F,n.lastMovement.rotationPoint=void 0}}else if(1===this.magoManager.sceneState.mouseButton){h=o.strCamera;n.copyPosDirUpFrom(h);var z,H=o.strWorldPoint;void 0===this.magoManager.globe&&(this.magoManager.globe=new Te),z=Te.normalAtCartesianPointWgs84(H.x,H.y,H.z,z);var V=n.getCameraRight(),k=(r=e.offsetX,i=e.offsetY,.003*(r-o.strX)),j=.003*(i-o.strY),W=-o.startCamOrintation.pitchRad;Math.PI;if(W<0);else;if(j+W>-.1&&(j=W<0?-W:W),0===k&&0===j)return;void 0===this.rotMat&&(this.rotMat=new Ne);var X=glMatrix.quat.create();X=glMatrix.quat.setAxisAngle(X,z,-k);var Y=glMatrix.quat.create();Y=glMatrix.quat.setAxisAngle(Y,[V.x,V.y,V.z],-j);var q=glMatrix.quat.create();q=glMatrix.quat.multiply(q,X,Y),this.rotMat._floatArrays=glMatrix.mat4.fromQuat(this.rotMat._floatArrays,q);var K=new Jr(-H.x,-H.y,-H.z),Z=new Jr(H.x,H.y,H.z);n.translate(K),n.transformByMatrix4(this.rotMat),n.translate(Z),this.updateModelViewMatrixByCamera(n);G=N/l*.3;n.lastMovement.movementType=I.movementType.ROTATION_ZX,n.lastMovement.rotationPoint=H,n.lastMovement.xAngVelocity=-j/l*.3,n.lastMovement.zAngVelocity=-k/l*.3}}}},zr.screenToCamCoord=function(e,t,r,i,o){var n,a,s,l=r.sceneState,u=l.gl;l.camera;void 0===i&&(i=new Jr);r.numFrustums;if(o&&o.linearDepth&&(s=o.linearDepth,n=o.far,a=o.near),!s){var c=r.texturesManager.texturesMergerFbo,d=c.colorBuffersArray[0],h=c.colorBuffersArray[1],f=on.calculatePixelLinearDepthV2(u,e,t,d,h,r);f.frustumIdx<r.numFrustums&&(s=f.linearDepth,n=f.far,a=f.near)}return r.isCesiumGlobe()||(a=0),o||(o={}),o.linearDepth=s,i=on.calculatePixelPositionCamCoord(u,e,t,i,void 0,a,n,r,o)},zr.updateMouseStartClick=function(e,t,r){var i=r.sceneState,o=i.gl,n=i.mouseAction;zr.updateMouseClick(e,t,r);var a=new Date;n.strTime=a.getTime(),n.strX=e,n.strY=t,0===i.mouseButton&&(r.bPicking=!0);var s,l=i.camera,u=!1,c=r.texturesManager.texturesMergerFbo,d=c.colorBuffer,h=c.colorBuffer1,f=on.calculatePixelLinearDepthV2(o,e,t,d,h,r);if(f.frustumIdx<r.numFrustums&&(s=f.linearDepth,f.far,f.near,u=!0),u||void 0===r.scene){if(n.strLinealDepth=s,n.strCamCoordPoint=zr.screenToCamCoord(e,t,r,n.strCamCoordPoint),n.strCamCoordPoint){n.strWorldPoint=on.cameraCoordPositionToWorldCoord(n.strCamCoordPoint,n.strWorldPoint,r),n.strCamera.copyPosDirUpFrom(l),n.startCamOrintation=l.getOrientation();var g=i.modelViewMatrix,p=i.getModelViewMatrixInv();n.strModelViewMatrix._floatArrays=glMatrix.mat4.copy(n.strModelViewMatrix._floatArrays,g._floatArrays),n.strModelViewMatrixInv._floatArrays=glMatrix.mat4.copy(n.strModelViewMatrixInv._floatArrays,p._floatArrays)}}else{var m=r.scene,v=(l=m.frameState.camera).getPickRay(new Cesium.Cartesian2(e,t)),x=m.globe.pick(v,m);n.strWorldPoint=x}},zr.prototype.updateModelViewMatrixByCamera=function(e,t){t||this.magoManager.cameraMoveStart();var r=(e=this.magoManager.sceneState.camera).position,i=e.direction,o=e.up,n=e.frustum.far[0],a=r.x+i.x*n,s=r.y+i.y*n,l=r.z+i.z*n,u=this.magoManager.sceneState.modelViewMatrix;if(u._floatArrays=Ne.lookAt(u._floatArrays,[r.x,r.y,r.z],[a,s,l],[o.x,o.y,o.z]),this.magoManager.sceneState.modelViewMatrixInv.dirty=!0,!t){var c=this;setTimeout(function(){c.magoManager.cameraMoveEnd()},10)}},zr.prototype.doTest__BSpline3DCubic=function(e){var t=this.magoManager,r=t.modeler;void 0===r.bSplineCubic3d&&(r.bSplineCubic3d=new Tr);var i=r.bSplineCubic3d;if(void 0!==i){void 0===i.geoCoordsList&&(i.geoCoordsList=new ve),i.geoCoordsList=r.geoCoordsList;for(var o=i.geoCoordsList.geographicCoordsArray.length,n=0;n<o;n++){var a=i.geoCoordsList.geographicCoordsArray[n],s=a.getGeoLocationDataManager().newGeoLocationData("noName");s=on.calculateGeoLocationData(a.longitude,a.latitude,a.altitude,void 0,void 0,void 0,s,t)}i.getGeographicCoordsList().makeLines(t);i.makeControlPoints(.2,t),i.makeInterpolatedPoints()}},zr.prototype.doTest__ExtrudedObject=function(e){var t=this.magoManager,r=t.modeler.getGeographicCoordsList();if(r){var i=r.getExtrudedMeshRenderableObject(100,!0,void 0,t,void 0);i.setOneColor(.2,.7,.8,.3),i.attributes.isMovable=!0,i.attributes.isSelectable=!0,i.attributes.name="extrudedObject",i.attributes.selectedColor4=new J(1,1,0,0),void 0===i.options&&(i.options={}),i.options.renderWireframe=!0,i.options.renderShaded=!0,i.options.depthMask=!0,t.smartTileManager.putObject(10,i)}},zr.prototype.doTest__CameraOrientation=function(){var e=this.magoManager.sceneState.camera;X.setOrientation(e,145,80,void 0),this.updateModelViewMatrixByCamera(e);var t=e.getOrientation();t.headingRad,Math.PI,t.pitchRad,Math.PI,t.rollRad,Math.PI},zr.prototype.doTest__GoTo=function(e){this.goto(127,36,1500,3)},zr.prototype.doTest__TerrainScanner=function(){var e=new pe(126.31394,33.18262,0),t=new pe(126.34513,33.215,0),r=new me(e,t),i=new po(r),o=new ye,n=o.newGeoLocationData();n=on.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,void 0,void 0,void 0,n),i.geoLocDataManager=o;this.magoManager.modeler.addObject(i,10),e.makeDefaultGeoLocationData(),t.makeDefaultGeoLocationData(),this.magoManager.modeler.addObject(e,10),this.magoManager.modeler.addObject(t,10)},zr.prototype.doTest__MagoRectangle=function(){void 0===this.countAux&&(this.countAux=0);var e={minLongitude:126.31394+.06*this.countAux,minLatitude:33.22,maxLongitude:126.34513+.06*this.countAux,maxLatitude:33.25,altitude:800},t=new Ur(e,{strokeWidth:2,strokeColor:"#FF0000",fillColor:"#00FF00",imageUrl:"/images/materialImages/factoryRoof.jpg",opacity:.7,clampToTerrain:!0}),r=3;this.magoManager.modeler.addObject(t,r);e={minLongitude:126.31394+.06*this.countAux,minLatitude:33.22,maxLongitude:126.34513+.06*this.countAux,maxLatitude:33.25,altitude:800},t=new Ur(e,{strokeWidth:2,strokeColor:"#FF0000",fillColor:"#00FF00",imageUrl:"/images/materialImages/factoryRoof.jpg",opacity:.7,clampToTerrain:!1}),r=3;this.magoManager.modeler.addObject(t,r),this.countAux++},zr.prototype.doTest__MagoRectangleGround=function(){void 0===this.countAux&&(this.countAux=0);var e={minLongitude:126.31394+.06*this.countAux,minLatitude:33.22,maxLongitude:126.34513+.06*this.countAux,maxLatitude:33.25,altitude:-200},t=new Gr(e,{strokeWidth:2,strokeColor:"#FF0000",fillColor:"#00FF00",imageUrl:"/images/materialImages/factoryRoof.jpg",opacity:.5});this.magoManager.modeler.addObject(t,3),this.countAux++},zr.prototype.doTest__MagoPoint=function(){var e=new Or({longitude:126.31394,latitude:33.18262,altitude:200},{size:10,strokeColor:"#FF0000",color:"#00FF00",opacity:.7});this.magoManager.modeler.addObject(e,10)},zr.prototype.doTest__MagoPolyline=function(){var e=new Nr({coordinates:[{longitude:126.31394,latitude:33.16,altitude:200},{longitude:126.31394,latitude:33.18262,altitude:200},{longitude:126.34513,latitude:33.215,altitude:200},{longitude:126.33,latitude:33.18,altitude:200},{longitude:126.35,latitude:33.18262,altitude:200},{longitude:126.38,latitude:33.195,altitude:200}]},{color:"#00ffff",thickness:4});this.magoManager.modeler.addObject(e,1)},zr.prototype.doTest__ObjectMarker=function(){var e=this.magoManager,t=e.modeler.getGeographicCoordsList();if(t)for(var r=t.getGeoCoordsCount(),i=0;i<r;i++){e.speechBubble||(e.speechBubble=new Mago3D.SpeechBubble);var o=e.speechBubble,n=J.getHexCode(1,1,1),a=o.getPng([256,256],n,{pixel:12,color:"blue",borderColor:"white",text:"blabla"}),s=t.getGeoCoord(i),l=s.longitude,u=s.latitude,c=s.altitude,d={positionWC:Mago3D.ManagerUtils.geographicCoordToWorldPoint(l,u,c),imageFilePath:a};e.objMarkerManager.newObjectMarker(d,e)}},zr.prototype.doTest__logarithmicDepthBuffer_encode_decode=function(){var e=new Jr(125.3569,165.02054,542.360145),t=new Jr(-3276800,3997696,3604480),r=new Jr(-7867.3564453125,65481.85546875,41420.75),i=new Jr(-3276800,4063232,3604480),o=new Jr(-7671.60400390625,4366.1689453125,41714.70703125),n=new Jr(t.x,t.y,t.z),a=new Jr(r.x+e.x,r.y+e.y,r.z+e.z),s=new Jr(n.x-i.x,n.y-i.y,n.z-i.z),l=new Jr(a.x-o.x,a.y-o.y,a.z-o.z),u=new Jr(s.x+l.x,s.y+l.y,s.z+l.z),c=this.magoManager.sceneState,d=c.modelViewRelToEyeMatrix.transformPoint3D(u,void 0),h=c.fCoef_logDepth[0],f=1-d.z,g=.5*h,p=Math.log2(f)*g,m=on.packDepth(p),v=on.unpackDepth(m),x=new Uint8Array([256*m[0],256*m[1],256*m[2],256*m[3]]),_=(on.unpackDepth(x),v/256),y=c.fCoef_logDepth[0]/2,T=c.camera.frustum.far[0],C=c.camera.frustum.near[0];Math.pow(2,_/y)},zr.prototype.keydown=function(e){var t=e.key,r=this.magoManager;r.modeler;if("m"===t)void 0===r.magoMode&&(r.magoMode=I.magoMode.NORMAL),r.magoMode===I.magoMode.DRAWING?r.magoMode=I.magoMode.NORMAL:r.magoMode===I.magoMode.NORMAL&&(r.magoMode=I.magoMode.DRAWING);else if("s"===t){var i=r.sceneState.applySunShadows;r.sceneState.setApplySunShadows(!i)}else if("t"===t){this.doTest__ObjectMarker()}else if("p"===t){if(void 0===this.smartTile_f4d_tested){var o=r.f4dController;this.smartTile_f4d_tested=1;r.readerWriter.geometryDataPath;for(var n=["busan-apartment","busan-curture","busan-edc","busan-etc","busan-general-house","busan-industry","busan-mj","busan-public","busan-service","busan-sv","busan-welfare","sejong-apartment","sejong-bus-sign","sejong-curture","sejong-etc","sejong-general-house","sejong-industry","sejong-jeonju","sejong-pedestrian-light","sejong-public","sejong-road-sign","sejong-safe-sign","sejong-service","sejong-special","sejong-street-lamp","sejong-taxi-sign","sejong-traffic-light","sejong-tree","sejong-welfare"],a=n.length,s=0;s<a;s++){var l=n[s];o.smartTilePathInfo[l]||(o.smartTilePathInfo[l]={}),o.smartTilePathInfo[l].projectId=l,o.smartTilePathInfo[l].projectFolderPath=l}r.getObjectIndexFileSmartTileF4d("SmartTilesF4D_WorkFolder")}}else if("z"===t){var u=r.sceneState.getApplySsao();r.sceneState.setApplySsao(!u)}};var Hr=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.id,this.name=t,void 0===this.name&&(this.name="noName"),this.diffuseTexture,this.color4};Hr.prototype.setDiffuseTextureUrl=function(e){void 0===this.diffuseTexture&&(this.diffuseTexture=new it),this.diffuseTexture.url=e},Hr.prototype.setColor4=function(e,t,r,i){void 0===this.color4&&(this.color4=new J),this.color4.setRGBA(e,t,r,i)};var Vr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t,this.materialsMap={},this.texturesManager,this.imagesPath="/images/materialImages"};Vr.prototype.getMaterial=function(e){return this.materialsMap[e]},Vr.prototype.getOrNewMaterial=function(e){var t=this.getMaterial(e);return void 0===t&&(t=new Hr(e),this.materialsMap[e]=t),t},Vr.prototype.getOrLoadTexture=function(e){void 0===this.texturesManager&&(this.texturesManager=new at(this.magoManager));this.texturesManager.getTextureByName(e)};var kr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.name,this.id,this.vertexList,this.surfacesArray,this.color4,this.hedgesList,this.edgesSegment3dsArray,this.vboKeysContainer,this.edgesVboKeysContainer,this.bbox,this.material};kr.fromVbo=function(e){if(void 0!==e){var t=new kr;t.vertexList=new Si;var r=t.vertexList;t.hedgesList=new wr;var i,o,n,a,s,l,u=t.hedgesList,c=t.newSurface();if(void 0!==e.vboBufferIdx);else{var d=e.vboBufferPos.dataArray;if(void 0===d)return;var h=d.length/3;if(0===h)return;var f=h/3,g=new Ri;g.vertexArray=new Array(h);for(var p=g.vertexArray,m=0;m<f;m++)i=new Jr(d[9*m],d[9*m+1],d[9*m+2]),o=new Jr(d[9*m+3],d[9*m+4],d[9*m+5]),n=new Jr(d[9*m+6],d[9*m+7],d[9*m+8]),a=r.newVertex(i),s=r.newVertex(o),l=r.newVertex(n),(D=c.newFace()).addVerticesArray([a,s,l]),u.addHalfEdgesArray(D.createHalfEdges(void 0)),a.facesOwnerArray=[D],s.facesOwnerArray=[D],l.facesOwnerArray=[D],p[3*m]=a,p[3*m+1]=s,p[3*m+2]=l;var v=r.getBoundingBox(void 0),x=v.getMaxLength();g.setBoxSize(v.minX,v.minX+x,v.minY,v.minY+x,v.minZ,v.minZ+x);var _=x/30;_<.1&&(_=.1),g.makeTreeByMinSize(_);g.extractOctreesWithData();var y=r.getVertexCount();for(m=0;m<y;m++){var T=r.getVertex(m);if(-1!==T.getVertexType()){for(var C=T.vertexIndexingOctree.vertexArray,b=wi.getCoincidentVertexArray(T,C,void 0,1e-4),M=b.length,A=0;A<M;A++){var E=b[A];E.setVertexType(-1);for(var L=E.facesOwnerArray,w=L.length,S=0;S<w;S++){var D;(D=L[S]).setVertexIdxInList();var R=E.getIdxInList();D.changeVertex(R,T),T.facesOwnerArray.push(D)}}Er.setTwinsFacesOfArray(T.facesOwnerArray)}}r.deleteVertexByVertexType(-1)}return t}},kr.prototype.deleteObjects=function(e){if(void 0!==this.vertexList&&this.vertexList.deleteObjects(),void 0!==this.surfacesArray){for(var t=this.surfacesArray.length,r=0;r<t;r++)this.surfacesArray[r].deleteObjects(),this.surfacesArray[r]=void 0;this.surfacesArray=void 0}void 0!==this.hedgesList&&(this.hedgesList.deleteGlObjects(),this.hedgesList=void 0),void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(e.gl,e),this.vboKeysContainer=void 0)},kr.prototype.deleteVbos=function(e){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(e.gl,e),this.vboKeysContainer=void 0)},kr.prototype.newSurface=function(e){void 0===this.surfacesArray&&(this.surfacesArray=[]);var t=new Ci(e);return this.surfacesArray.push(t),t},kr.prototype.getHalfEdgesList=function(){return void 0===this.hedgesList&&(this.hedgesList=new wr),this.hedgesList},kr.prototype.getSurface=function(e){if(void 0!==this.surfacesArray)return this.surfacesArray[e]},kr.prototype.getSurfaceByName=function(e){if(void 0!==this.surfacesArray)return this.surfacesArray.filter(function(t){return t.name===e})},kr.prototype.addSurface=function(e){void 0!==e&&(void 0===this.surfacesArray&&(this.surfacesArray=[]),this.surfacesArray.push(e))},kr.prototype.mergeMesh=function(e){if(void 0!==e){void 0===this.surfacesArray&&(this.surfacesArray=[]);for(var t=e.getSurfacesCount(),r=0;r<t;r++)this.addSurface(e.getSurface(r));e.surfacesArray=void 0}},kr.prototype.getSurfacesCount=function(){return void 0===this.surfacesArray?0:this.surfacesArray.length},kr.prototype.getCopySurfaceIndependentMesh=function(e){var t,r;void 0===e&&(e=new kr);for(var i=this.getSurfacesCount(),o=0;o<i;o++)t=this.getSurface(o),r=e.newSurface(),r=t.getCopyIndependentSurface(r);return this.bbox&&(e.bbox=this.bbox),e},kr.prototype.getTriangles=function(e){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return e;void 0===e&&(e=[]);for(var t=this.getSurfacesCount(),r=0;r<t;r++)e=this.getSurface(r).getTriangles(e);return e},kr.prototype.getTrianglesConvex=function(e){if(void 0===this.surfacesArray||0===this.surfacesArray.length)return e;void 0===e&&(e=[]);for(var t=this.getSurfacesCount(),r=0;r<t;r++)e=this.getSurface(r).getTrianglesConvex(e);return e},kr.prototype.getNoRepeatedVerticesArray=function(e){var t,r,i;void 0===e&&(e=[]);for(var o,n,a=0,s=this.getSurfacesCount(),l=0;l<s;l++){t=(i=this.getSurface(l)).getFacesCount();for(var u=0;u<t;u++){n=(r=i.getFace(u)).getVerticesCount();for(var c=0;c<n;c++)(o=r.getVertex(c)).setIdxInList(a),a++}}var d,h={};for(s=this.getSurfacesCount(),l=0;l<s;l++){t=(i=this.getSurface(l)).getFacesCount();for(u=0;u<t;u++){n=(r=i.getFace(u)).getVerticesCount();for(c=0;c<n;c++)h[(o=r.getVertex(c)).getIdxInList().toString()]=o}}for(var f in h)Object.prototype.hasOwnProperty.call(h,f)&&(d=h[f],e.push(d));return e},kr.prototype.getVertexList=function(){return void 0===this.vertexList&&(this.vertexList=new Si),this.vertexList},kr.prototype.getBoundingBox=function(){return void 0===this.bbox&&(this.bbox=new G,this.vertexList||(this.vertexList=new Si,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.bbox=this.vertexList.getBoundingBox(this.bbox)),this.bbox},kr.prototype.getBoundingSphere=function(){return this.getBoundingBox().getBoundingSphere()},kr.prototype.rotate=function(e,t,r,i){var o=new Ne,n=new Xe,a=new Jr(t,r,i);a.unitary(),n.rotationAngDeg(e,a.x,a.y,a.z),o.rotationByQuaternion(n),this.transformByMatrix4(o)},kr.prototype.transformByMatrix4=function(e){void 0===this.vertexList&&(this.vertexList=new Si,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.transformPointsByMatrix4(e);this.calculateVerticesNormals(!0)},kr.prototype.translate=function(e,t,r){void 0===this.vertexList&&(this.vertexList=new Si,this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.vertexList.translateVertices(e,t,r)},kr.prototype.calculateVerticesNormals=function(e){for(var t=this.getSurfacesCount(),r=0;r<t;r++)this.getSurface(r).calculateVerticesNormals(e)},kr.prototype.calculateTexCoordsBox=function(e){e||(e=this.getBoundingBox());for(var t=this.getSurfacesCount(),r=0;r<t;r++)this.getSurface(r).calculateTexCoordsBox(e)},kr.prototype.calculateTexCoordsByHeight=function(e){for(var t=this.getSurfacesCount(),r=0;r<t;r++)this.getSurface(r).calculateTexCoordsByHeight(e)},kr.prototype.calculateTexCoordsSpherical=function(){for(var e=new pe,t=this.vertexList.getVertexCount(),r=0;r<t;r++){var i,o=this.vertexList.getVertex(r),n=(e=o.point3d.getSphericalCoords(e)).longitude/360;i=.5*(90+e.latitude)/90,void 0===o.texCoord&&(o.texCoord=new Kr(n,i))}},kr.prototype.setColor=function(e,t,r,i){for(var o=this.getSurfacesCount(),n=0;n<o;n++)this.getSurface(n).setColor(e,t,r,i)},kr.prototype.setOneColor=function(e,t,r,i){void 0===this.color4&&(this.color4=new J),this.color4.setRGBA(e,t,r,i)},kr.prototype.setMaterial=function(e){this.material=e},kr.prototype.reverseSense=function(){for(var e=this.getSurfacesCount(),t=0;t<e;t++)this.getSurface(t).reverseSense();this.calculateVerticesNormals()},kr.prototype.getFrontierHalfEdges=function(e){for(var t=this.getSurfacesCount(),r=0;r<t;r++)e=this.getSurface(r).getFrontierHalfEdges(e);return e},kr.prototype.getCopy=function(e){var t,r,i,o,n,a,s,l;void 0===this.vertexList&&(this.vertexList=new Si),void 0!==this.vertexList.vertexArray&&0!==this.vertexList.vertexArray.length||(this.vertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),void 0===e&&(e=new kr),void 0===e.vertexList&&(e.vertexList=new Si),e.vertexList.copyFrom(this.vertexList),this.vertexList.setIdxInList(),e.vertexList.setIdxInList();for(var u=this.getSurfacesCount(),c=0;c<u;c++){t=this.getSurface(c),(a=e.newSurface()).id=t.id,a.name=t.name,r=t.getFacesCount();for(var d=0;d<r;d++){i=t.getFace(d),s=a.newFace(),o=i.getVerticesCount();for(var h=0;h<o;h++)n=i.getVertex(h).getIdxInList(),l=e.vertexList.getVertex(n),s.addVertex(l)}}return e.calculateVerticesNormals(),e},kr.prototype.getTrianglesListsArrayBy2ByteSize=function(e,t){void 0===t&&(t=[]);var r=new Ai;if(t.push(r),3*(a=e.length)<65535)return r.trianglesArray=[],Array.prototype.push.apply(r.trianglesArray,e),t;var i=Ai.getNoRepeatedVerticesArray(e,void 0);if(i.length<65535)return r.trianglesArray=[],Array.prototype.push.apply(r.trianglesArray,e),t;Si.setIdxInList(i);for(var o,n=[],a=e.length,s=0;s<a;s++)(o=e[s]).vertex0.idxInList<65535&&o.vertex1.idxInList<65535&&o.vertex2.idxInList<65535?r.addTriangle(o):n.push(o);return n.length>0&&(t=this.getTrianglesListsArrayBy2ByteSize(n,t)),t},kr.prototype.renderAsChild=function(e,t,r,i,o,n,a){var s=!0,l=!1,u=!0,c=e.getGl(),d=!1;if(a){if(1!==r)return;n&&(void 0!==n.renderWireframe&&(l=n.renderWireframe),void 0!==n.depthMask&&(u=n.depthMask)),l&&(d=this.renderWireframe(e,t,r,i,o))}else n&&(void 0!==n.renderShaded&&(s=n.renderShaded),void 0!==n.depthMask&&(u=n.depthMask)),s&&(c.depthMask(u),d=this.render(e,t,r,i,o),c.depthMask(!0));return d},kr.prototype.render=function(e,t,r,i,o){var n=e.vboMemoryManager;void 0===this.vboKeysContainer&&(this.vboKeysContainer=this.getVbo(this.vboKeysContainer,n));var a,s=e.sceneState.gl;if(0===r)s.uniform1i(t.bHasTexture_loc,!1),s.uniform1i(t.colorType_loc,0);else if(1===r&&!o){var l=!1,u=this.material;if(void 0!==u){var c=u.diffuseTexture;if(void 0!==c){if(void 0!==c.texId)s.uniform1i(t.colorType_loc,2),t.last_tex_id!==c.texId&&(s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,c.texId),t.last_tex_id=c.texId,l=!0);else if(c.fileLoadState===I.fileLoadState.READY){var d=c.url;return at.loadTexture(d,c,e,!1),!1}}else{var h=u.color4;h&&(s.uniform1i(t.colorType_loc,0),s.uniform4fv(t.oneColor4_loc,[h.r,h.g,h.b,h.a]))}}!l&&this.color4&&(s.uniform1i(t.colorType_loc,0),s.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]))}if(this.vboKeysContainer&&this.vboKeysContainer.vboCacheKeysArray){for(var f=this.vboKeysContainer.vboCacheKeysArray.length,g=0;g<f;g++){var p=this.vboKeysContainer.vboCacheKeysArray[g];if(!p)return!1;if(!p.bindDataPosition(t,n))return!1;if(0===r)if(p.vboBufferNor&&t.normal3_loc>=0){if(!p.bindDataNormal(t,n))return!1}else t.disableVertexAttribArray(t.normal3_loc);if(1===r){if(p.vboBufferNor&&t.normal3_loc>=0){if(!p.bindDataNormal(t,n))return!1}else t.disableVertexAttribArray(t.normal3_loc);if(p.vboBufferTCoord){if(!p.bindDataTexCoord(t,n))return!1}else t.disableVertexAttribArray(t.texCoord2_loc)}if(1===r)if(p.vboBufferCol){if(!p.bindDataColor(t,n))return!1;s.uniform1i(t.colorType_loc,p.vboBufferTCoord?2:1)}else t.disableVertexAttribArray(t.color4_loc);if(!p.bindDataIndice(t,n))return!1;a=i||s.TRIANGLES,s.drawElements(a,p.indicesCount,s.UNSIGNED_SHORT,0)}return!0}},kr.prototype.renderWireframe=function(e,t,r,i,o){e.vboMemoryManager;if(void 0===this.edgesVboKeysContainer)return this.edgesVboKeysContainer=this.getVboEdgesThickLines(this.edgesVboKeysContainer,e),!1;var n=e.sceneState.gl;if(0===r);else if(1===r&&!o)if(void 0!==this.material&&void 0!==this.material.diffuseTexture&&void 0!==this.material.diffuseTexture.texId){var a=this.material.diffuseTexture;n.uniform1i(t.colorType_loc,2),t.last_tex_id!==a.texId&&(n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,a.texId),t.last_tex_id=a.texId)}else this.color4&&(n.uniform1i(t.colorType_loc,0),n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]));var s=this.edgesVboKeysContainer.getVboKey(0);void 0===this.thickness&&(this.thickness=2),n.uniform1f(t.thickness_loc,this.thickness);var l=s.vboBufferPos,u=l.dataDimensions;return!!l.isReady(n,e.vboMemoryManager)&&(n.bindBuffer(n.ARRAY_BUFFER,l.key),n.vertexAttribPointer(t.prev_loc,u,n.FLOAT,!1,16,0),n.vertexAttribPointer(t.current_loc,u,n.FLOAT,!1,16,32),n.vertexAttribPointer(t.next_loc,u,n.FLOAT,!1,16,64),n.drawArrays(n.TRIANGLE_STRIP,0,s.vertexCount-6),!0)},kr.prototype.getVbo=function(e,t){void 0===e&&(e=new xt);var r=this.getTriangles(void 0);if(r){r.length;for(var i,o,n=this.getTrianglesListsArrayBy2ByteSize(r,void 0),a=n.length,s=0;s<a;s++){o=(i=n[s]).getNoRepeatedVerticesArray(void 0);var l=e.newVBOVertexIdxCacheKey();Si.setIdxInList(o),Si.getVboDataArrays(o,l,t),i.assignVerticesIdx(),Ai.getVboFaceDataArray(i.trianglesArray,l,t)}return e}},kr.prototype.getVboTrianglesConvex=function(e,t){void 0===e&&(e=new xt);for(var r,i,o=this.getTrianglesConvex(void 0),n=(o.length,this.getTrianglesListsArrayBy2ByteSize(o,void 0)),a=n.length,s=0;s<a;s++){i=(r=n[s]).getNoRepeatedVerticesArray(void 0);var l=e.newVBOVertexIdxCacheKey();Si.setIdxInList(i),Si.getVboDataArrays(i,l,t),r.assignVerticesIdx(),Ai.getVboFaceDataArray(r.trianglesArray,l,t)}return e},kr.prototype.getEdgeSegment3ds=function(e){for(var t,r=[],i=this.getSurfacesCount(),o=0;o<i;o++)"top"!==(t=this.getSurface(o)).name&&"bottom"!==t.name&&(r=t.getFrontierHalfEdges(r));var n,a,s,l,u,c,d=r.length;if(0===d)return e;e||(e=[]);for(o=0;o<d;o++)s=(n=r[o]).startVertex,l=n.getEndVertex(),u=s.getPosition(),c=l.getPosition(),a=new vi(u,c),e.push(a);return e},kr.prototype.getVboEdgesThickLines=function(e,t){return this.edgesSegment3dsArray=[],this.edgesSegment3dsArray=this.getEdgeSegment3ds(this.edgesSegment3dsArray),e=vi.getVboThickLines(t,this.edgesSegment3dsArray,e)},kr.prototype.getVboEdges=function(e,t){if(void 0!==e){for(var r,i,o,n=this.getFrontierHalfEdges(void 0),a=n.length,s=2*a,l=new Float32Array(3*s),u=new Uint16Array(s),c=0,d=0;d<a;d++)i=(r=n[d]).startVertex,o=r.getEndVertex(),l[6*d]=i.point3d.x,l[6*d+1]=i.point3d.y,l[6*d+2]=i.point3d.z,l[6*d+3]=o.point3d.x,l[6*d+4]=o.point3d.y,l[6*d+5]=o.point3d.z,u[2*d]=c,c++,u[2*d+1]=c,c++;var h=e.newVBOVertexIdxCacheKey();return h.setDataArrayPos(l,t),h.setDataArrayIdx(u,t),e}};var jr=function t(r){if(!(this instanceof t))throw new Error(Ue.CONSTRUCT_ERROR);e.call(this),this.magoManager=r,this.mode=I.modelerMode.INACTIVE,this.drawingState=I.modelerDrawingState.NO_STARTED,this.drawingElement=I.modelerDrawingElement.NOTHING,this.planeGrid,this.polyLine2d,this.geoCoordsList,this.excavation,this.tunnel,this.bSplineCubic3d,this.sphere,this.clippingBox,this.magoRectangle,this.vehicle,this.testObjectsArray,this.objectsArray=[],this.mergedObjectsArray=[],this.vectorsArray,this.currentVisibleObjectsArray,this.screenSpaceObjectsArray=[],this.bSplineKnotPointsColor=new J(1,.6,.2,1),this.bSplineControlPointsColor=new J(.3,.99,.99,1)};jr.EVENT_TYPE={ADD:"add"},jr.prototype=Object.create(e.prototype),jr.prototype.constructor=jr,jr.prototype.extractObjectsByClassName=function(e,t){if(void 0===this.objectsArray)return t;void 0===t&&(t=[]);for(var r=this.objectsArray.length,i=0;i<r;i++){var o=this.objectsArray[i];o.constructor.name===e&&t.push(o)}return t},jr.prototype.newPipe=function(e){var t=e.interiorRadius,r=e.exteriorRadius,i=e.height,o=new uo(t,r,i,e);return void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(o),o},jr.prototype.newTube=function(e){var t=e.interiorRadius,r=e.exteriorRadius,i=e.height,o=new vo(t,r,i,e);return void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(o),o},jr.prototype.addObject=function(e,t){if(void 0===this.objectsArray&&(this.objectsArray=[]),e instanceof Ur){var r=e.style;if(r&&r.clampToTerrain)return void this.magoManager.tinTerrainManager.addObjectToClampToTerrain(e)}if(e instanceof $e);e.magoManager=this.magoManager,this.objectsArray.push(e);var i=this.magoManager.smartTileManager,o=t||5;i.putObject(o,e,this.magoManager),e.isNeedValidHeight(this.magoManager)&&this.magoManager._needValidHeightNativeArray.push(e),this.emit(jr.EVENT_TYPE.ADD,{type:jr.EVENT_TYPE.ADD,timestamp:(new Date).getTime(),add:e})},jr.prototype.addMergedObject=function(e,t){void 0===this.mergedObjectsArray&&(this.mergedObjectsArray=[]),this.mergedObjectsArray.push(e);var r=this.magoManager.smartTileManager,i=t||15;r.putObject(i,e,this.magoManager),this.emit(jr.EVENT_TYPE.ADD,{type:jr.EVENT_TYPE.ADD,timestamp:(new Date).getTime(),add:e})},jr.prototype.__TEST__extrusionBuildings=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;for(var e=[[[126.75803650804234,37.542305898401864],[126.75775148613792,37.54169221219305]],[[126.75876942250916,37.54209007007311],[126.75803650804234,37.542305898401864]],[[126.75856142664138,37.542338644682935],[126.75814488092637,37.54246130823201]],[[126.75879130736978,37.542655204235615],[126.75891071408236,37.54262004068136],[126.75908168165888,37.54259851339269],[126.76083841338414,37.542081165430325],[126.76086449107228,37.54203602510164],[126.76072632370172,37.541738559244855],[126.76066963397577,37.54171779439718],[126.7589481268621,37.542224768337874]],[[126.75814488092637,37.54246130823201],[126.75830187641488,37.542799330753596]],[[126.75830187641488,37.542799330753596],[126.75853773564796,37.54272987604773]],[[126.75647554642633,37.54205554147102],[126.75698939424795,37.543161942874065],[126.75702552453218,37.5431751780913],[126.75758020626976,37.54301184283329]],[[126.7553629539039,37.54323821562699],[126.75541964329287,37.5432589830158],[126.75659185741048,37.54291382103152],[126.7566179379466,37.54286868165695],[126.75656024067062,37.54274444852217],[126.75650355135106,37.54272368167936],[126.75533133981014,37.543068843708205],[126.7553052584295,37.54311398279412],[126.7553629539039,37.54323821562699]],[[126.75553367505736,37.543605819311836],[126.7555903647719,37.54362658661854],[126.75676258387976,37.54328142207748],[126.75678866557396,37.54323628267043],[126.75672507962624,37.54309937487676],[126.75666838999233,37.54307860811323],[126.75549617363903,37.54342377083976],[126.75547009223273,37.543468909959266],[126.75553367505736,37.543605819311836]],[[126.75532671988232,37.54366675580393],[126.75530063828859,37.543711894883494],[126.75308830698322,37.54436327511884],[126.75303161741274,37.54434250661403],[126.75280321502872,37.54385066536827],[126.75282929817394,37.54380552684691],[126.7550416151971,37.54315415135227],[126.75509830443255,37.543174918895104],[126.75532671988232,37.54366675580393]],[[126.75994234474865,37.54264285543259],[126.76082303756968,37.54238349377465],[126.76090028752422,37.542411789271185],[126.76108002233144,37.542798741385894],[126.76119851677862,37.54306229038568],[126.76131005930701,37.543327756120505],[126.76141460099291,37.543595022330955],[126.76151209597705,37.54386397196788],[126.76160250148496,37.54413448724362],[126.76168577784559,37.54440644968352],[126.76176188850904,37.544679740177926],[126.76174123900638,37.544709453949615],[126.76100070053761,37.54492753946806]],[[126.75118073428933,37.544958504341906],[126.75281231054163,37.54447815597142],[126.75283839390211,37.54443301745361],[126.75250442970544,37.54371385468313],[126.75642701949113,37.54255889448344],[126.7564531000016,37.54251375514248],[126.75626859629809,37.542116480548586]],[[126.76078840570767,37.54499005866556],[126.76019912413601,37.54516359471923],[126.7601629923306,37.54515035957123],[126.7591271987355,37.54292036687665],[126.75915327774838,37.54287522693687],[126.75973008951188,37.54270536292907]],[[126.7594961603301,37.545370603540235],[126.75933010868047,37.54501310904902],[126.75923928551241,37.544895496941],[126.75886591458992,37.54409164380052],[126.75881925345297,37.54391325645393],[126.75877781925674,37.54382404966767]],[[126.75924744411678,37.54368575893788],[126.75995603659969,37.54521130506005],[126.75993941541172,37.54524007434763],[126.7594961603301,37.545370603540235]],[[126.75130675873775,37.54515194899639],[126.75134644326687,37.545237404738415],[126.75332045112502,37.54549054365014]],[[126.75332045112502,37.54549054365014],[126.75295245097637,37.54469810964504],[126.752906040372,37.54468110712942],[126.75130675873775,37.54515194899639]],[[126.75957045121858,37.54553605085727],[126.7608598742759,37.54515633739547]],[[126.75332628377853,37.54461981965763],[126.75542088765371,37.544003100357635],[126.75545202933567,37.54401450841053],[126.75612216638088,37.54545742943021],[126.75614471193218,37.5455010752552],[126.75617114318469,37.545543316303345]],[[126.75332628377853,37.54461981965763],[126.75375662037838,37.54554647160063]],[[126.75767351722469,37.543368619404376],[126.75869900781235,37.54557652373986]],[[126.75869900781235,37.54557652373986],[126.75813861783445,37.54574153823234],[126.75806400370533,37.54576010089876],[126.75798739155054,37.54577247085002],[126.75790958981122,37.545778517553565],[126.75783141948234,37.54577817720224],[126.75775370544868,37.54577145338765],[126.75680929231659,37.54565038592114],[126.75674802737876,37.5456395618299],[126.75668877728249,37.54562309666034],[126.75663235827126,37.545601217241],[126.75657954758492,37.54557422498836],[126.75653107275195,37.545542491754155],[126.75648760156663,37.54550645470255],[126.75644973288935,37.545466610287356],[126.7564179883967,37.545423507412615],[126.75639280539505,37.54537773987048],[126.75572266382696,37.54393482125236],[126.75573699216169,37.54391002481303],[126.75707096983139,37.5435172289335],[126.75724193884095,37.54349570431844],[126.75767351722469,37.543368619404376]],[[126.75023689600218,37.54569742679296],[126.7508095405226,37.54577086866128]],[[126.75727030872179,37.54590569405277],[126.75677061919642,37.54584163658855],[126.75669418402454,37.54582867214603],[126.75661976813191,37.545809667132936],[126.75654812248078,37.54578481333739],[126.75647997007565,37.54575436156988],[126.7564159986668,37.54571861913216],[126.75635685380969,37.5456779467159],[126.7563031323503,37.545632754762586],[126.75625537640195,37.54558349932136],[126.75621406787496,37.54553067744661]],[[126.7588448939716,37.54574010135705],[126.7582230062292,37.54592322591204],[126.75814116047293,37.545944201801554],[126.75805736125817,37.54595952657699],[126.75797222283933,37.54596908790654],[126.75788636928822,37.545972815704914],[126.7578004299191,37.54597068264708],[126.75771503467533,37.54596270436863],[126.75749374843726,37.54593433723137]],[[126.75978969823339,37.54613740173603],[126.75978426677408,37.546078455571056],[126.75971754441755,37.545896530247056],[126.7596462630381,37.545715704534096],[126.75957045121858,37.54553605085727]],[[126.75978969823339,37.54613740173603],[126.7612796120912,37.54632834957573]],[[126.76152111768855,37.546359299377414],[126.76210594851439,37.546434244585235]],[[126.76107223634487,37.54509379838593],[126.76178547414649,37.54488375281555],[126.76181728491342,37.5448979689481],[126.76187415670218,37.545144378759105],[126.76192522234895,37.5453915934871],[126.76197046388054,37.5456395264011],[126.76210594851439,37.546434244585235]],[[126.7599727642026,37.54682502745215],[126.76055096606808,37.54665476056993],[126.76139940859554,37.54676349303165]],[[126.76163782537691,37.54679404622127],[126.76217911531899,37.54686341068782]],[[126.76217911531899,37.54686341068782],[126.76222983586815,37.54716091929961],[126.7621920043084,37.54720036894779],[126.76173998071236,37.54724802326647]],[[126.76009488416847,37.5474214400244],[126.7600595081329,37.54722195936254],[126.76001879528624,37.547023125003285],[126.7599727642026,37.54682502745215]]],t=(new J(1,0,0,.8),new J(0,1,0,.8),new J(1,0,0,.8),new J(1,1,0,.8),new J(0,1,0,.8),new J(0,1,1,.8),new J(0,0,1,.8),e.length),r=0;r<t;r++){for(var i=e[r],o=new ve,n=i.length,a=0;a<n;a++){var s=i[a];o.newGeoCoord(s[0],s[1],3)}var l=new to(o,30,{});l.setOneColor(1,.5,.3,.5),l.attributes.isSelectable=!0,l.attributes.isMovable=!0,l.attributes.selectedColor4=new J(1,0,0,1),void 0===l.options&&(l.options={}),l.options.renderShaded=!0,this.addObject(l)}}},jr.prototype.__TEST__extrusionBuildings_son=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;0,0;var e=[[[127.20762,35.61518],[127.20762,35.60993],[127.20762+5e-4+0,35.60993],[127.20762+5e-4+0,35.61518]]];e.push([[127.20762,35.60993],[127.20762+5e-4,35.60993],[127.20762+5e-4,35.61043],[127.20762,35.61043]]);new J(1,0,0,.8),new J(0,1,0,.8),new J(1,0,0,1),new J(1,1,0,1),new J(0,1,0,1),new J(0,1,1,1),new J(0,0,1,1);for(var t=e.length,r=0;r<t;r++){for(var i=e[r],o=new ve,n=i.length,a=0;a<n;a++){var s=i[a];o.newGeoCoord(s[0],s[1],100)}var l=new to(o,230,{});l.setOneColor(1,.5,.3,1),l.attributes.isSelectable=!0,l.attributes.isMovable=!0,l.attributes.selectedColor4=new J(1,0,0,1),l.attributes.heightReference="none",l.attributes.doubleFace=!0,void 0===l.options&&(l.options={}),l.options.renderShaded=!0,l.options.renderWireframe=!1,this.addObject(l)}}},jr.prototype.__TEST__extrusionBuildings_sejongForWaterSimulation=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;0,0;var e=127.20762,t=(e=126.88027,[[[(e=127.177213)+0,37.62823],[e+0,37.61323],[127.177713,37.61323],[127.177713,37.62823]]]);t.push([[e,37.61323],[e+.02,37.61323],[e+.02,37.61323+5e-4],[e,37.61323+5e-4]]);new J(1,0,0,.8),new J(0,1,0,.8),new J(1,0,0,1),new J(1,1,0,1),new J(0,1,0,1),new J(0,1,1,1),new J(0,0,1,1);for(var r=t.length,i=0;i<r;i++){for(var o=t[i],n=new ve,a=o.length,s=0;s<a;s++){var l=o[s];n.newGeoCoord(l[0],l[1],100)}var u=new to(n,230,{});u.setOneColor(1,.5,.3,1),u.attributes.isSelectable=!0,u.attributes.isMovable=!0,u.attributes.selectedColor4=new J(1,0,0,1),u.attributes.heightReference="none",u.attributes.doubleFace=!0,void 0===u.options&&(u.options={}),u.options.renderShaded=!0,u.options.renderWireframe=!1,this.addObject(u)}}},jr.prototype.__TEST__extrudedLines=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;for(var e=[[[126.75803650804234,37.542305898401864],[126.75775148613792,37.54169221219305]],[[126.75876942250916,37.54209007007311],[126.75803650804234,37.542305898401864]],[[126.75856142664138,37.542338644682935],[126.75814488092637,37.54246130823201]],[[126.75879130736978,37.542655204235615],[126.75891071408236,37.54262004068136],[126.75908168165888,37.54259851339269],[126.76083841338414,37.542081165430325],[126.76086449107228,37.54203602510164],[126.76072632370172,37.541738559244855],[126.76066963397577,37.54171779439718],[126.7589481268621,37.542224768337874]],[[126.75814488092637,37.54246130823201],[126.75830187641488,37.542799330753596]],[[126.75830187641488,37.542799330753596],[126.75853773564796,37.54272987604773]],[[126.75647554642633,37.54205554147102],[126.75698939424795,37.543161942874065],[126.75702552453218,37.5431751780913],[126.75758020626976,37.54301184283329]],[[126.7553629539039,37.54323821562699],[126.75541964329287,37.5432589830158],[126.75659185741048,37.54291382103152],[126.7566179379466,37.54286868165695],[126.75656024067062,37.54274444852217],[126.75650355135106,37.54272368167936],[126.75533133981014,37.543068843708205],[126.7553052584295,37.54311398279412],[126.7553629539039,37.54323821562699]],[[126.75553367505736,37.543605819311836],[126.7555903647719,37.54362658661854],[126.75676258387976,37.54328142207748],[126.75678866557396,37.54323628267043],[126.75672507962624,37.54309937487676],[126.75666838999233,37.54307860811323],[126.75549617363903,37.54342377083976],[126.75547009223273,37.543468909959266],[126.75553367505736,37.543605819311836]],[[126.75532671988232,37.54366675580393],[126.75530063828859,37.543711894883494],[126.75308830698322,37.54436327511884],[126.75303161741274,37.54434250661403],[126.75280321502872,37.54385066536827],[126.75282929817394,37.54380552684691],[126.7550416151971,37.54315415135227],[126.75509830443255,37.543174918895104],[126.75532671988232,37.54366675580393]],[[126.75994234474865,37.54264285543259],[126.76082303756968,37.54238349377465],[126.76090028752422,37.542411789271185],[126.76108002233144,37.542798741385894],[126.76119851677862,37.54306229038568],[126.76131005930701,37.543327756120505],[126.76141460099291,37.543595022330955],[126.76151209597705,37.54386397196788],[126.76160250148496,37.54413448724362],[126.76168577784559,37.54440644968352],[126.76176188850904,37.544679740177926],[126.76174123900638,37.544709453949615],[126.76100070053761,37.54492753946806]],[[126.75118073428933,37.544958504341906],[126.75281231054163,37.54447815597142],[126.75283839390211,37.54443301745361],[126.75250442970544,37.54371385468313],[126.75642701949113,37.54255889448344],[126.7564531000016,37.54251375514248],[126.75626859629809,37.542116480548586]],[[126.76078840570767,37.54499005866556],[126.76019912413601,37.54516359471923],[126.7601629923306,37.54515035957123],[126.7591271987355,37.54292036687665],[126.75915327774838,37.54287522693687],[126.75973008951188,37.54270536292907]],[[126.7594961603301,37.545370603540235],[126.75933010868047,37.54501310904902],[126.75923928551241,37.544895496941],[126.75886591458992,37.54409164380052],[126.75881925345297,37.54391325645393],[126.75877781925674,37.54382404966767]],[[126.75924744411678,37.54368575893788],[126.75995603659969,37.54521130506005],[126.75993941541172,37.54524007434763],[126.7594961603301,37.545370603540235]],[[126.75130675873775,37.54515194899639],[126.75134644326687,37.545237404738415],[126.75332045112502,37.54549054365014]],[[126.75332045112502,37.54549054365014],[126.75295245097637,37.54469810964504],[126.752906040372,37.54468110712942],[126.75130675873775,37.54515194899639]],[[126.75957045121858,37.54553605085727],[126.7608598742759,37.54515633739547]],[[126.75332628377853,37.54461981965763],[126.75542088765371,37.544003100357635],[126.75545202933567,37.54401450841053],[126.75612216638088,37.54545742943021],[126.75614471193218,37.5455010752552],[126.75617114318469,37.545543316303345]],[[126.75332628377853,37.54461981965763],[126.75375662037838,37.54554647160063]],[[126.75767351722469,37.543368619404376],[126.75869900781235,37.54557652373986]],[[126.75869900781235,37.54557652373986],[126.75813861783445,37.54574153823234],[126.75806400370533,37.54576010089876],[126.75798739155054,37.54577247085002],[126.75790958981122,37.545778517553565],[126.75783141948234,37.54577817720224],[126.75775370544868,37.54577145338765],[126.75680929231659,37.54565038592114],[126.75674802737876,37.5456395618299],[126.75668877728249,37.54562309666034],[126.75663235827126,37.545601217241],[126.75657954758492,37.54557422498836],[126.75653107275195,37.545542491754155],[126.75648760156663,37.54550645470255],[126.75644973288935,37.545466610287356],[126.7564179883967,37.545423507412615],[126.75639280539505,37.54537773987048],[126.75572266382696,37.54393482125236],[126.75573699216169,37.54391002481303],[126.75707096983139,37.5435172289335],[126.75724193884095,37.54349570431844],[126.75767351722469,37.543368619404376]],[[126.75023689600218,37.54569742679296],[126.7508095405226,37.54577086866128]],[[126.75727030872179,37.54590569405277],[126.75677061919642,37.54584163658855],[126.75669418402454,37.54582867214603],[126.75661976813191,37.545809667132936],[126.75654812248078,37.54578481333739],[126.75647997007565,37.54575436156988],[126.7564159986668,37.54571861913216],[126.75635685380969,37.5456779467159],[126.7563031323503,37.545632754762586],[126.75625537640195,37.54558349932136],[126.75621406787496,37.54553067744661]],[[126.7588448939716,37.54574010135705],[126.7582230062292,37.54592322591204],[126.75814116047293,37.545944201801554],[126.75805736125817,37.54595952657699],[126.75797222283933,37.54596908790654],[126.75788636928822,37.545972815704914],[126.7578004299191,37.54597068264708],[126.75771503467533,37.54596270436863],[126.75749374843726,37.54593433723137]],[[126.75978969823339,37.54613740173603],[126.75978426677408,37.546078455571056],[126.75971754441755,37.545896530247056],[126.7596462630381,37.545715704534096],[126.75957045121858,37.54553605085727]],[[126.75978969823339,37.54613740173603],[126.7612796120912,37.54632834957573]],[[126.76152111768855,37.546359299377414],[126.76210594851439,37.546434244585235]],[[126.76107223634487,37.54509379838593],[126.76178547414649,37.54488375281555],[126.76181728491342,37.5448979689481],[126.76187415670218,37.545144378759105],[126.76192522234895,37.5453915934871],[126.76197046388054,37.5456395264011],[126.76210594851439,37.546434244585235]],[[126.7599727642026,37.54682502745215],[126.76055096606808,37.54665476056993],[126.76139940859554,37.54676349303165]],[[126.76163782537691,37.54679404622127],[126.76217911531899,37.54686341068782]],[[126.76217911531899,37.54686341068782],[126.76222983586815,37.54716091929961],[126.7621920043084,37.54720036894779],[126.76173998071236,37.54724802326647]],[[126.76009488416847,37.5474214400244],[126.7600595081329,37.54722195936254],[126.76001879528624,37.547023125003285],[126.7599727642026,37.54682502745215]]],t=(new J(1,0,0,.8),new J(0,1,0,.8),{doubleFace:!0,polyLineLoop:!1,numSegments:4,colorsArray:[new J(1,0,0,.8),new J(1,1,0,.8),new J(0,1,0,.8),new J(0,1,1,.8),new J(0,0,1,.8)]}),r=e.length,i=0;i<r;i++){for(var o=e[i],n=new ve,a=o.length,s=0;s<a;s++){var l=o[s];n.newGeoCoord(l[0],l[1],3)}var u=n.getExtrudedWallRenderableObject(10,void 0,this.magoManager,void 0,t,void 0);u.setOneColor(1,.5,.3,.5),u.attributes.isSelectable=!0,u.attributes.isMovable=!0,u.attributes.selectedColor4=new J(1,0,0,1),u.attributes.opaque=!1,void 0===u.options&&(u.options={}),u.options.renderShaded=!0,this.addObject(u)}}},jr.prototype.__TEST__loftObjects=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;var e=[[[126.75803650804234,37.542305898401864],[126.75775148613792,37.54169221219305]],[[126.75876942250916,37.54209007007311],[126.75803650804234,37.542305898401864]],[[126.75856142664138,37.542338644682935],[126.75814488092637,37.54246130823201]],[[126.75879130736978,37.542655204235615],[126.75891071408236,37.54262004068136],[126.75908168165888,37.54259851339269],[126.76083841338414,37.542081165430325],[126.76086449107228,37.54203602510164],[126.76072632370172,37.541738559244855],[126.76066963397577,37.54171779439718],[126.7589481268621,37.542224768337874]],[[126.75814488092637,37.54246130823201],[126.75830187641488,37.542799330753596]],[[126.75830187641488,37.542799330753596],[126.75853773564796,37.54272987604773]],[[126.75647554642633,37.54205554147102],[126.75698939424795,37.543161942874065],[126.75702552453218,37.5431751780913],[126.75758020626976,37.54301184283329]],[[126.7553629539039,37.54323821562699],[126.75541964329287,37.5432589830158],[126.75659185741048,37.54291382103152],[126.7566179379466,37.54286868165695],[126.75656024067062,37.54274444852217],[126.75650355135106,37.54272368167936],[126.75533133981014,37.543068843708205],[126.7553052584295,37.54311398279412],[126.7553629539039,37.54323821562699]],[[126.75553367505736,37.543605819311836],[126.7555903647719,37.54362658661854],[126.75676258387976,37.54328142207748],[126.75678866557396,37.54323628267043],[126.75672507962624,37.54309937487676],[126.75666838999233,37.54307860811323],[126.75549617363903,37.54342377083976],[126.75547009223273,37.543468909959266],[126.75553367505736,37.543605819311836]],[[126.75532671988232,37.54366675580393],[126.75530063828859,37.543711894883494],[126.75308830698322,37.54436327511884],[126.75303161741274,37.54434250661403],[126.75280321502872,37.54385066536827],[126.75282929817394,37.54380552684691],[126.7550416151971,37.54315415135227],[126.75509830443255,37.543174918895104],[126.75532671988232,37.54366675580393]],[[126.75994234474865,37.54264285543259],[126.76082303756968,37.54238349377465],[126.76090028752422,37.542411789271185],[126.76108002233144,37.542798741385894],[126.76119851677862,37.54306229038568],[126.76131005930701,37.543327756120505],[126.76141460099291,37.543595022330955],[126.76151209597705,37.54386397196788],[126.76160250148496,37.54413448724362],[126.76168577784559,37.54440644968352],[126.76176188850904,37.544679740177926],[126.76174123900638,37.544709453949615],[126.76100070053761,37.54492753946806]],[[126.75118073428933,37.544958504341906],[126.75281231054163,37.54447815597142],[126.75283839390211,37.54443301745361],[126.75250442970544,37.54371385468313],[126.75642701949113,37.54255889448344],[126.7564531000016,37.54251375514248],[126.75626859629809,37.542116480548586]],[[126.76078840570767,37.54499005866556],[126.76019912413601,37.54516359471923],[126.7601629923306,37.54515035957123],[126.7591271987355,37.54292036687665],[126.75915327774838,37.54287522693687],[126.75973008951188,37.54270536292907]],[[126.7594961603301,37.545370603540235],[126.75933010868047,37.54501310904902],[126.75923928551241,37.544895496941],[126.75886591458992,37.54409164380052],[126.75881925345297,37.54391325645393],[126.75877781925674,37.54382404966767]],[[126.75924744411678,37.54368575893788],[126.75995603659969,37.54521130506005],[126.75993941541172,37.54524007434763],[126.7594961603301,37.545370603540235]],[[126.75130675873775,37.54515194899639],[126.75134644326687,37.545237404738415],[126.75332045112502,37.54549054365014]],[[126.75332045112502,37.54549054365014],[126.75295245097637,37.54469810964504],[126.752906040372,37.54468110712942],[126.75130675873775,37.54515194899639]],[[126.75957045121858,37.54553605085727],[126.7608598742759,37.54515633739547]],[[126.75332628377853,37.54461981965763],[126.75542088765371,37.544003100357635],[126.75545202933567,37.54401450841053],[126.75612216638088,37.54545742943021],[126.75614471193218,37.5455010752552],[126.75617114318469,37.545543316303345]],[[126.75332628377853,37.54461981965763],[126.75375662037838,37.54554647160063]],[[126.75767351722469,37.543368619404376],[126.75869900781235,37.54557652373986]],[[126.75869900781235,37.54557652373986],[126.75813861783445,37.54574153823234],[126.75806400370533,37.54576010089876],[126.75798739155054,37.54577247085002],[126.75790958981122,37.545778517553565],[126.75783141948234,37.54577817720224],[126.75775370544868,37.54577145338765],[126.75680929231659,37.54565038592114],[126.75674802737876,37.5456395618299],[126.75668877728249,37.54562309666034],[126.75663235827126,37.545601217241],[126.75657954758492,37.54557422498836],[126.75653107275195,37.545542491754155],[126.75648760156663,37.54550645470255],[126.75644973288935,37.545466610287356],[126.7564179883967,37.545423507412615],[126.75639280539505,37.54537773987048],[126.75572266382696,37.54393482125236],[126.75573699216169,37.54391002481303],[126.75707096983139,37.5435172289335],[126.75724193884095,37.54349570431844],[126.75767351722469,37.543368619404376]],[[126.75023689600218,37.54569742679296],[126.7508095405226,37.54577086866128]],[[126.75727030872179,37.54590569405277],[126.75677061919642,37.54584163658855],[126.75669418402454,37.54582867214603],[126.75661976813191,37.545809667132936],[126.75654812248078,37.54578481333739],[126.75647997007565,37.54575436156988],[126.7564159986668,37.54571861913216],[126.75635685380969,37.5456779467159],[126.7563031323503,37.545632754762586],[126.75625537640195,37.54558349932136],[126.75621406787496,37.54553067744661]],[[126.7588448939716,37.54574010135705],[126.7582230062292,37.54592322591204],[126.75814116047293,37.545944201801554],[126.75805736125817,37.54595952657699],[126.75797222283933,37.54596908790654],[126.75788636928822,37.545972815704914],[126.7578004299191,37.54597068264708],[126.75771503467533,37.54596270436863],[126.75749374843726,37.54593433723137]],[[126.75978969823339,37.54613740173603],[126.75978426677408,37.546078455571056],[126.75971754441755,37.545896530247056],[126.7596462630381,37.545715704534096],[126.75957045121858,37.54553605085727]],[[126.75978969823339,37.54613740173603],[126.7612796120912,37.54632834957573]],[[126.76152111768855,37.546359299377414],[126.76210594851439,37.546434244585235]],[[126.76107223634487,37.54509379838593],[126.76178547414649,37.54488375281555],[126.76181728491342,37.5448979689481],[126.76187415670218,37.545144378759105],[126.76192522234895,37.5453915934871],[126.76197046388054,37.5456395264011],[126.76210594851439,37.546434244585235]],[[126.7599727642026,37.54682502745215],[126.76055096606808,37.54665476056993],[126.76139940859554,37.54676349303165]],[[126.76163782537691,37.54679404622127],[126.76217911531899,37.54686341068782]],[[126.76217911531899,37.54686341068782],[126.76222983586815,37.54716091929961],[126.7621920043084,37.54720036894779],[126.76173998071236,37.54724802326647]],[[126.76009488416847,37.5474214400244],[126.7600595081329,37.54722195936254],[126.76001879528624,37.547023125003285],[126.7599727642026,37.54682502745215]]],t=new ii,r=t.newOuterRing().newElement("RECTANGLE");r.setCenterPosition(0,0),r.setExtension(-1,0,1,10);for(var i=e.length,o=0;o<i;o++){for(var n=e[o],a=new ve,s=n.length,l=0;l<s;l++){var u=n[l];a.newGeoCoord(u[0],u[1],3)}var c=jr._getLoftMesh(t,a.geographicCoordsArray,!0,!0,this.magoManager);this.addObject(c)}}},jr.prototype.__TEST__laser=function(){if(!this.testLinesExtrude){this.testLinesExtrude=!0;var e=new pe(126.7574,37.54302,29.133160613985577),t=new pe(126.75719736534053,37.54493737467032,44.055231264041986),r=ve.getRenderableObjectOfGeoCoordsArray([e,t],this.magoManager,{});this.addObject(r)}},jr._getLoftMesh=function(e,t,r,i,o){var n=new Fi,a=new ho;a.geoLocDataManager=new ye;var s,l=a.geoLocDataManager.newGeoLocationData();if(t instanceof Array){var u=t,c=ve.getMiddleGeographicCoords(u,void 0);on.calculateGeoLocationData(c.longitude,c.latitude,c.altitude,0,0,0,l);var d=ve.getGeoCoordsToWgs84Points3D(u,void 0);s=l.getTransformedRelativePositionsArray(d,void 0)}var h=new Qr(s),f=h.getBisectionPlane(0,void 0,!1);e.outerRing.getPoints([],24);var g=f.getRotationMatrix(void 0),p=h.getPoint(0);g.setTranslation(p.x,p.y,p.z),n.makeLoft(e,h,!1);var m=n.getMesh(void 0,!0,!0,!1).getCopySurfaceIndependentMesh(void 0);return m.calculateVerticesNormals(!1),m.setColor(.1,.5,.5,1),m.vboKeysContainer=m.getVbo(m.vboKeysContainer,o.vboMemoryManager),m.vboKeysContainerEdges=m.getVboEdges(m.vboKeysContainerEdges,o.vboMemoryManager),a.objectsArray.push(m),a},jr.prototype.existObject=function(e){if(!this.objectsArray||Array.isArray(this.objectsArray)&&0===this.objectsArray.length)return!1;if(e instanceof Ur){var t=e.style;if(t&&t.clampToTerrain)return this.magoManager.tinTerrainManager.objectsToClampToTerrainArray.filter(function(t){return t!==e}).length>0}return this.objectsArray.filter(function(t){return t!==e}).length>0},jr.prototype.removeObject=function(e){if(void 0===e)return!1;if(e instanceof Ur&&e.style.clampToTerrain)return this.magoManager.tinTerrainManager.removeObjectToClampToTerrain(e),void e.deleteObjects(this.magoManager.vboMemoryManager);e.deleteObjects(this.magoManager.vboMemoryManager);var t=e.smartTileOwner;t&&(t.nativeObjects.generalObjectsArray&&(t.nativeObjects.generalObjectsArray=t.nativeObjects.generalObjectsArray.filter(function(t){return t!==e})),t.nativeObjects.lightSourcesArray&&(t.nativeObjects.lightSourcesArray=t.nativeObjects.lightSourcesArray.filter(function(t){return t!==e}))),this.objectsArray=this.objectsArray.filter(function(t){return t!==e})},jr.prototype.getObjectByGuid=function(e){return this.objectsArray.filter(function(t){return t._guid===e})[0]},jr.prototype.getObjectByKV=function(e,t){return this.objectsArray.filter(function(r){return r[e]===t})},jr.prototype.newPerson=function(e){void 0===this.testObjectsArray&&(this.testObjectsArray=[]);var t=new ji;return this.testObjectsArray.push(t),t},jr.prototype.newCone=function(e,t,r){return new Qi(e,t,r)},jr.prototype.newClippingBox_by2geographicCoords=function(e,t,r,i){e.altitude=r,t.altitude=r;var o=new ye,n=new _e;n=on.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,0,0,0,n),o.addGeoLocationData(n);var a=ve.getPointsRelativeToGeoLocation(n,[e,t],void 0),s=a[0],l=a[1],u=new Kr(s.x,s.y),c=new Kr(l.x,l.y),d=u.distToPoint(c),h=u.getVectorToPoint(c);h.unitary();var f=h.getRight(),g=new Kr(u.x+f.x*d,u.y+f.y*d),p=new Kr(c.x+f.x*d,c.y+f.y*d),m=new Jr(g.x,g.y,s.z),v=new Jr(p.x,p.y,l.z),x=new Jr(0,0,1),_=new Ki;_.create_byExtrude([s,l,v,m],x,i),_.geoLocDataManager=o,this.clippingBox=_;return _},jr.prototype.newBasicFactory=function(e,t,r,i){var o=this.magoManager,n=o.materialsManager,a=n.getOrNewMaterial("basicFactoryRoof");if(void 0===a.diffuseTexture){a.diffuseTexture=new it,a.diffuseTexture.textureTypeName="diffuse",a.diffuseTexture.textureImageFileName="factoryRoof.jpg";var s=n.imagesPath+"//"+a.diffuseTexture.textureImageFileName;at.loadTexture(s,a.diffuseTexture,o,!0)}void 0===i&&(i={}),i.roof={material:a};var l=new Xi(e,t,r,i);return l.bHasGround=!0,void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(l),l},jr.getExtrudedSolidMesh=function(e,t,r,i,o,n,a){if(void 0!==e&&void 0!==t){var s=new Fi;s.convexFacesIndicesData=e.getConvexFacesIndicesData(void 0);var l=s.newVtxProfile();l.makeByProfile2D(e),void 0===i&&(i=new Jr(0,0,1));for(var u=t/r,c=0;c<r;c++){var d=s.newVtxProfile();d.copyFrom(l),d.translate(0,0,u*(c+1))}return(a=s.getMesh(a,o,n)).calculateVerticesNormals(),a}},jr.getExtrudedMesh=function(e,t,r,i,o,n,a){if(void 0!==e&&void 0!==t)return(a=jr.getExtrudedSolidMesh(e,t,r,i,void 0).getCopySurfaceIndependentMesh(a)).calculateVerticesNormals(),a.getBoundingBox(),a},jr.getExtrudedPlane=function(e,t,r,i,o,n,a){if(void 0!==e&&void 0!==t){var s=new Fi;s.convexFacesIndicesData=e.getConvexFacesIndicesData(void 0);var l=s.newVtxProfile();l.makeByProfile2D(e),void 0===i&&(i=new Jr(0,0,1));for(var u=t/r,c=0;c<r;c++){var d=s.newVtxProfile();d.copyFrom(l),d.translate(0,0,u*(c+1))}return(a=s.getMesh(a,!1,!1)).calculateVerticesNormals(),a}},jr.getLoftMesh=function(e,t){if(e&&e instanceof ve){if(!t){(t=[]).push(new Kr(-20,-100)),t.push(new Kr(20,-100)),t.push(new Kr(20,100)),t.push(new Kr(-20,100))}for(var r=ii.fromPoint2DArray(t),i=e.getGeographicExtent().getMidPoint(void 0),o=on.calculateGeoLocationData(i.longitude,i.latitude,i.altitude,0,0,0),n=new Fi,a=ve.getPointsRelativeToGeoLocation(o,e.geographicCoordsArray,void 0),s=new Qr(a),l=s.getPointsCount(),u=0;u<l-1;u++){var c=s.getNextIdx(u),d=s.getPoint(u),h=s.getPoint(c),f=d.getVectorToPoint(h);f.unitary();var g=e.getGeoCoord(u),p=on.geographicCoordToWorldPoint(g.longitude,g.latitude,g.altitude),m=Te.normalAtCartesianPointWgs84(p.x,p.y,p.z),v=new Jr(m[0],m[1],m[2]),x=o.getRotMatrixInv().transformPoint3D(v).crossProduct(f),_=f.crossProduct(x),y=new Ne;y.setByFloat32Array(new Float32Array([x.x,x.y,x.z,0,_.x,_.y,_.z,0,f.x,f.y,f.z,0,d.x,d.y,d.z,1]));var T=new Ii;T.makeByProfile2D(r),T.transformPointsByMatrix4(y),0===u&&n.addVtxProfile(T);var C=s.getBisectionPlane(c),b=Ii.getProjectedOntoPlane(T,C,f);n.addVtxProfile(b)}var M=new ho;M.geoLocDataManager=new ye,M.geoLocDataManager.addGeoLocationData(o),M.boundingSphereWC=new z;var A=o.position,E=Qr.getBoundingBoxOfPoints3DArray(a,void 0).getRadiusAprox();M.boundingSphereWC.setCenterPoint(A.x,A.y,A.z),M.boundingSphereWC.setRadius(E);var L=n.getMesh().getCopySurfaceIndependentMesh();return L.calculateVerticesNormals(),M.objectsArray.push(L),M}},jr.getRevolvedMesh=function(e,t,r,i,o,n,a){if(void 0!==e&&void 0!==t)return(a=jr.getRevolvedSolidMesh(e,t,r,i,o,n,a).getCopySurfaceIndependentMesh(a)).calculateVerticesNormals(),a},jr.getRevolvedSolidMesh=function(e,t,r,i,o,n,a){if(void 0!==e){var s=new Fi;s.convexFacesIndicesData=e.getConvexFacesIndicesData(void 0);var l=s.newVtxProfile();l.makeByProfile2D(e);var u=t/r,c=i.getLine(),d=new Kr(0,0),h=c.getProjectedPoint(d);h.inverse();var f=new Ne,g=new Xe,p=i.getDirection(),m=new Jr(p.x,p.y,0);m.unitary();for(var v=0;v<r;v++){g.rotationAngDeg(u*(v+1),m.x,m.y,m.z),f.rotationByQuaternion(g);var x=s.newVtxProfile();x.copyFrom(l),x.translate(h.x,h.y,0),x.transformPointsByMatrix4(f),x.translate(-h.x,-h.y,0)}return(a=s.getMesh(a,o,n)).calculateVerticesNormals(),a}},jr.getPoints3DList_fromPoints3dArray=function(e,t,r){var i=new G;i.init(e[0]),i.addPointsArray(e);var o,n=i.getCenterPoint();if(void 0!==r&&void 0!==r.geoLocationData)o=r.geoLocationData;else{var a=on.pointToGeographicCoord(n,void 0);o=on.calculateGeoLocationData(a.longitude,a.latitude,a.altitude,0,0,0,void 0)}var s=o.getTransformedRelativePositionsArray(e,void 0);return void 0===t&&(t=new Qr),t.pointsArray=s,void 0===t.geoLocDataManager&&(t.geoLocDataManager=new ye),t.geoLocDataManager.addGeoLocationData(o),t},jr.prototype.getGeographicCoordsList=function(){return void 0===this.geoCoordsList&&(this.geoCoordsList=new ve),this.geoCoordsList},jr.prototype.getExcavation=function(){return this.excavation},jr.prototype.getTunnel=function(){return this.tunnel},jr.prototype.addPointToPolyline=function(e){void 0===this.polyLine2d&&(this.polyLine2d=new ei),this.polyLine2d.newPoint2d(e.x,e.y)},jr.prototype.render=function(e,t,r,i){if(void 0!==this.testObjectsArray)for(var o=this.testObjectsArray.length,n=0;n<o;n++){this.testObjectsArray[n].render(e,t,r)}if(void 0!==this.planeGrid&&this.planeGrid.render(e,t),void 0!==this.geoCoordsList&&1===r){if(void 0!==this.geoCoordsList.points3dList&&void 0!==this.geoCoordsList.points3dList.vboKeysContainer){var a=!0,s={},l=e.postFxShadersManager.getShader("thickLine");l.useProgram();var u=this.magoManager.getGl();u.uniform1i(l.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth);var c=this.magoManager.sceneState;u.uniform4fv(l.oneColor4_loc,[.9,.5,.3,1]),u.uniform2fv(l.viewport_loc,[c.drawingBufferWidth,c.drawingBufferHeight]),u.uniform1f(l.thickness_loc,5),this.geoCoordsList.points3dList.renderThickLines(e,l,r,a,s),t.useProgram()}s={writeGeographicCoords:!0},a=!1;this.geoCoordsList.renderPoints(e,t,r,a,s)}if(void 0!==this.excavation&&this.excavation.renderPoints(e,t,r),void 0!==this.tunnel&&this.tunnel.renderPoints(e,t,r),1===r&&void 0!==this.clippingBox){i=void 0;var d=!1;this.clippingBox.render(e,t,r,i,d)}void 0!==this.bSplineCubic3d&&this.bSplineCubic3d.render(e,t,r),void 0!==this.sphere&&this.sphere.render(e,t,r),0!==r&&this.magoRectangle&&this.magoRectangle.render(e,t,r,i,d)},jr.prototype.__TEST=function(){this.__TEST__convertF4D_to_MagoNode()},jr.prototype.__TEST__convertF4D_to_MagoNode=function(){var e=this.magoManager,t=e.selectionManager.getSelectedF4dNode();if(t){var r=t.data,i=r.smartTileOwner,o=r.neoBuilding,n=r.geoLocDataManager.getCurrentGeoLocationData();if(!this.__loadedAllReferences)return o.forceToLoadModelsAndReferences(e),void(this.__loadedAllReferences=!0);if(o.allModelsAndReferencesAreParsed(e)){if(!this.bPrimitivesCreated){for(var a=o.motherNeoReferencesArray,s=o.motherBlocksArray,l={},u=a.length,c=0;c<u;c++){var d=a[c];if(d){s[d._block_idx];var h=d.materialId;void 0===l[h]&&(l[h]=[]),l[h].push(d)}}var f=new m;for(var g in l)if(l.hasOwnProperty(g)){var p=l[g];f=this.__TEST__convertF4D_to_MagoNode__createPrimitives(p,o,f)}i.mgSetArray||(i.mgSetArray=[]);var v=x.makeMgSetFromMgNodesArray([f]);v.geoLocDataManager=new ye,v.geoLocDataManager.newGeoLocationData().copyFrom(n),i.mgSetArray.push(v),this.bPrimitivesCreated=!0}}else;}},jr.prototype.__TEST__convertF4D_to_MagoNode__createPrimitives=function(e,t,r){t.motherNeoReferencesArray;for(var i=t.motherBlocksArray,o=this.magoManager.getGl(),n=e.length,a=0;a<n;a++){for(var s=e[a],l=s.refMatrixType,u=i[s._block_idx],c=s.refTranslationVec,h=u.vBOVertexIdxCacheKeysContainer,f=s.vBOVertexIdxCacheKeysContainer,m=s._originalMatrix4,x=f.vboCacheKeysArray.length,_=0;_<x;_++){if(x>1);var y=f.vboCacheKeysArray[_],T=h.vboCacheKeysArray[_],C=(s.color4,T.vboBufferIdx,T.vboBufferPos,T.vboBufferNor,y.vboBufferCol,y.vboBufferTCoord,new g);if(T.vboBufferPos){var b=d.getCopyTypedArray(T.vboBufferPos.dataArray);if(1===l)for(var M=b.length/3,A=0;A<M;A++)b[3*A]+=c[0],b[3*A+1]+=c[1],b[3*A+2]+=c[2];else if(2===l){b=m.transformDataArray3D(b)}(E=new d).setBufferData(b),E.dataDimensions=3,E.dataTarget=o.ARRAY_BUFFER,E.name="POSITION3",C.getOrNewMgBufferView("POSITION3").setAuxMgBuffer(E)}if(T.vboBufferNor){b=d.getCopyTypedArray(T.vboBufferNor.dataArray);if(2===l)b=m.rotateDataArray3D(b);(E=new d).setBufferData(b),E.dataDimensions=3,E.dataTarget=o.ARRAY_BUFFER,E.name="NORMAL3",C.getOrNewMgBufferView("NORMAL3").setAuxMgBuffer(E)}if(y.vboBufferCol){var E=new d;b=d.getCopyTypedArray(y.vboBufferCol.dataArray);E.setBufferData(b),E.dataDimensions=4,E.dataTarget=o.ARRAY_BUFFER,E.name="COLOR4",C.getOrNewMgBufferView("COLOR4").setAuxMgBuffer(E)}if(y.vboBufferTCoord){E=new d,b=d.getCopyTypedArray(y.vboBufferTCoord.dataArray);E.setBufferData(b),E.dataDimensions=2,E.dataTarget=o.ARRAY_BUFFER,E.name="TEXCOORD2",C.getOrNewMgBufferView("TEXCOORD2").setAuxMgBuffer(E)}if(T.vboBufferIdx){E=new d,b=d.getCopyTypedArray(T.vboBufferIdx.dataArray);E.setBufferData(b),E.dataDimensions=1,E.dataTarget=o.ELEMENT_ARRAY_BUFFER,E.name="INDICE",C.getOrNewMgBufferView("INDICE").setAuxMgBuffer(E)}var L=new p({mgOwner:r}),w=new v({mgOwner:L});w.mgBufferViewSet=C,w.hasTexture=s.hasTexture,w.materialId=s.materialId,w.objectId=s.objectId,C.mgOwner=w,L.primitives.push(w),r.mgMeshArray.push(L)}}return r},jr.prototype.__TEST__bSpline=function(){var e=this.magoManager.modeler;if(e.geoCoordsList){var t={geoCoordsArray:e.geoCoordsList.geographicCoordsArray,initialArmsLengthRatio:.2,bLoop:!1};e.bSplineCubic3d=new Tr(t),e.geoCoordsList.geographicCoordsArray=[]}},jr.prototype.createPlaneGrid=function(e,t,r,i){void 0===e&&(e=500),void 0===t&&(t=500),void 0===r&&(r=50),void 0===i&&(i=50),void 0===this.planeGrid&&(this.planeGrid=new qr(e,t,r,i))};var Wr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vtxProfilesList,this.profile,this.vboKeyContainer,this.vboKeyContainerEdges};Wr.prototype.deleteObjects=function(){this.profile&&this.profile.deleteObjects(),this.profile=void 0},Wr.prototype.getVboKeysContainer=function(){return this.vboKeyContainer},Wr.prototype.getMesh=function(e,t,r){return void 0===e&&(e=new kr),(e=this.vtxProfilesList.getMesh(e,t,r)).calculateVerticesNormals(),e},Wr.prototype.getSurfaceIndependentMesh=function(e,t,r){return void 0===e&&(e=new kr),this.mesh=this.vtxProfilesList.getMesh(void 0,t,r),(e=this.mesh.getCopySurfaceIndependentMesh(e)).calculateVerticesNormals(),e},Wr.prototype.revolve=function(e,t,r,i){if(void 0!==e){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Fi),this.vtxProfilesList.convexFacesIndicesData=e.getConvexFacesIndicesData(void 0);var o=this.vtxProfilesList.newVtxProfile();o.makeByProfile2D(e);var n=t/r,a=i.getLine(),s=new Kr(0,0),l=a.getProjectedPoint(s);l.inverse();var u=new Ne,c=new Xe,d=i.getDirection(),h=new Jr(d.x,d.y,0);h.unitary();for(var f=0;f<r;f++){c.rotationAngDeg(n*(f+1),h.x,h.y,h.z),u.rotationByQuaternion(c);var g=this.vtxProfilesList.newVtxProfile();g.copyFrom(o),g.translate(l.x,l.y,0),g.transformPointsByMatrix4(u),g.translate(-l.x,-l.y,0)}}},Wr.prototype.extrude=function(e,t,r,i){if(void 0!==e&&void 0!==t){void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Fi),this.vtxProfilesList.convexFacesIndicesData=e.getConvexFacesIndicesData(void 0);var o=this.vtxProfilesList.newVtxProfile();o.makeByProfile2D(e),void 0===i&&(i=new Jr(0,0,1));for(var n=t/r,a=0;a<r;a++){var s=this.vtxProfilesList.newVtxProfile();s.copyFrom(o),s.translate(0,0,n*(a+1))}}};var Xr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.geoCoordsList,void 0!==t&&(this.geoCoordsList=new ve(t)),this.controlPointArmLength=.2,this.curvesArray,this.dirty=!0};Xr.prototype.getTangent=function(e,t,r){if(this.dirty){void 0===this.curvesArray&&(this.curvesArray=[]);Xr.insertPointsOnLargeSegments(this.geoCoordsList.geographicCoordsArray,.001,r);for(var i=this.geoCoordsList.geographicCoordsArray.length,o=0;o<i;o++){var n=this.geoCoordsList.geographicCoordsArray[o],a=n.getGeoLocationDataManager().newGeoLocationData("noName");a=on.calculateGeoLocationData(n.longitude,n.latitude,n.altitude,void 0,void 0,void 0,a,r)}var s=new Tr;this.curvesArray.push(s),s.geoCoordsList=this.geoCoordsList,s.geoCoordsList.makeLines(r);var l=this.controlPointArmLength;s.makeControlPoints(l,r),this.dirty=!1}s=this.curvesArray[0];return t=Tr.getTangent(s,e,t,r)},Xr.prototype.getGeoLocationDataManager=function(){if(void 0!==this.curvesArray&&0!==this.curvesArray.length){var e=this.curvesArray[0];if(void 0!==e)return e.knotPoints3dList.geoLocDataManager}},Xr.insertPointsOnLargeSegments=function(e,t,r){if(void 0!==e)for(var i=e.length,o=0;o<i-1;o++){var n=e[o],a=e[o+1];if(pe.getAngleBetweenCoords(n,a)>t){var s=pe.getMidPoint(n,a,void 0);e.splice(o+1,0,s),i=e.length,o--}}};var Yr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.pipeKnotsArray,this.dirty=!0};Yr.make=function(){};var qr=function e(t,r,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.geoLocDataManager,this.width,this.height,this.altitude=0,this.numCols,this.numRows,this.vboKeysContainer,this.setSize(t,r,i,o)};qr.prototype.setSize=function(e,t,r,i){void 0!==e&&(this.width=e),void 0!==t&&(this.height=t),void 0!==r&&(this.numCols=r),void 0!==i&&(this.numRows=i)},qr.prototype.render=function(e,t){if(void 0!==this.vboKeysContainer){var r=e.sceneState.gl,i=(e.vboMemoryManager,this.geoLocDataManager.getCurrentGeoLocationData());r.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,i.rotMatrix._floatArrays),r.uniform3fv(t.buildingPosHIGH_loc,i.positionHIGH),r.uniform3fv(t.buildingPosLOW_loc,i.positionLOW),r.uniform1i(t.refMatrixType_loc,0),r.uniform1i(t.hasAditionalMov_loc,!1),t.disableVertexAttribArray(t.texCoord2_loc),r.uniform1i(t.colorType_loc,0),r.uniform4fv(t.oneColor4_loc,[1,1,1,1]),r.uniform1i(t.bApplySpecularLighting_loc,!1),t.disableVertexAttribArrayAll();for(var o=this.vboKeysContainer.vboCacheKeysArray.length,n=0;n<o;n++){var a=this.vboKeysContainer.vboCacheKeysArray[n];if(void 0!==a.vboBufferPos&&!a.bindDataPosition(t,e.vboMemoryManager))return!1;if(void 0!==a.vboBufferNor){if(!vbo_vicky.bindDataNormal(t,e.vboMemoryManager))return!1}else t.disableVertexAttribArray(t.normal3_loc);if(void 0!==a.vboBufferCol){if(!vbo_vicky.bindDataColor(t,e.vboMemoryManager))return!1}else t.disableVertexAttribArray(t.color4_loc);if(void 0!==a.vboBufferTCoord){if(!vbo_vicky.bindDataTexCoord(t,e.vboMemoryManager))return!1}else t.disableVertexAttribArray(t.texCoord2_loc);r.drawArrays(r.LINES,0,a.vertexCount)}}},qr.prototype.makeVbo=function(e){var t,r,i,o,n=this.width/2,a=this.height/2,s=this.altitude,l=new Jr(-n,-a,s),u=new Jr(n,-a,s),c=(new Jr(n,a,s),new Jr(-n,a,s)),d=this.width/(this.numCols-1),h=this.height/(this.numRows-1),f=2*this.numCols+2*this.numRows,g=new Float32Array(3*f),p=0;r=l.y,o=c.y;for(var m=0;m<this.numCols;m++)i=t=l.x+m*d,g[p]=t,g[++p]=r,g[++p]=s,g[++p]=i,g[++p]=o,g[++p]=s,p++;t=l.x,i=u.x;for(var v=0;v<this.numRows;v++)o=r=l.y+v*h,g[p]=t,g[++p]=r,g[++p]=s,g[++p]=i,g[++p]=o,g[++p]=s,p++;void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt),this.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(g,e)};var Kr=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.x=t||0,this.y=r||0,this.ownerVertex3d,this.associated};Kr.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0},Kr.prototype.setAssociated=function(e){this.associated.x=e.x,this.associated.y=e.y},Kr.prototype.getAssociated=function(){return this.associated},Kr.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y},Kr.prototype.inverse=function(){this.x=-this.x,this.y=-this.y},Kr.prototype.set=function(e,t){this.x=e,this.y=t},Kr.prototype.getX=function(){return this.x},Kr.prototype.getY=function(){return this.y},Kr.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y},Kr.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},Kr.prototype.unitary=function(){var e=this.getModul();this.x/=e,this.y/=e},Kr.prototype.isParallelToPoint=function(e,t){if(void 0===e)return!1;var r=Zo(t,1e-9),i=this.angleRadToVector(e);return i<r||Math.abs(i-Math.PI)<r},Kr.prototype.squareDistToPoint=function(e){if(e){var t=this.x-e.x,r=this.y-e.y;return t*t+r*r}},Kr.prototype.distToPoint=function(e){return Math.sqrt(this.squareDistToPoint(e))},Kr.prototype.getLeft=function(e){return void 0===e&&(e=new Kr),e.set(-this.y,this.x),e},Kr.prototype.getRight=function(e){return void 0===e&&(e=new Kr),e.set(this.y,-this.x),e},Kr.prototype.isCoincidentToPoint=function(e,t){var r=this.distToPoint(e),i=!1;return t||(t=1e-7),r<t*t&&(i=!0),i},Kr.prototype.getVectorToPoint=function(e,t){if(void 0!==e)return void 0===t&&(t=new Kr),t.set(e.x-this.x,e.y-this.y),t},Kr.prototype.crossProduct=function(e){return this.x*e.y-e.x*this.y},Kr.prototype.scalarProduct=function(e){return this.x*e.x+this.y*e.y},Kr.mix=function(e,t,r,i){i||(i=new Kr);var o=e.x*(1-r)+t.x*r,n=e.y*(1-r)+t.y*r;return i.set(o,n),i},Kr.prototype.angleRadToVector=function(e){if(void 0!==e){var t=this.getModul(),r=e.getModul();if(!(t<1e-9||r<1e-9))return Math.acos(this.scalarProduct(e)/(t*r))}},Kr.prototype.angleDegToVector=function(e){if(void 0!==e){var t=this.angleRadToVector(e);if(void 0!==t)return 180*t/Math.PI}};var Zr=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.pointsArray};Zr.prototype.deleteObjects=function(){if(void 0!==this.pointsArray){for(var e=this.pointsArray.length,t=0;t<e;t++)this.pointsArray[t].deleteObjects(),this.pointsArray[t]=void 0;this.pointsArray=void 0}},Zr.prototype.addPoint=function(e){void 0!==e&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(e))},Zr.prototype.insertPoint=function(e,t){void 0===this.pointsArray&&(this.pointsArray=[]),t>this.pointsArray.length-1?this.pointsArray.push(e):this.pointsArray.splice(t,0,e)},Zr.prototype.newPoint=function(e,t){void 0===this.pointsArray&&(this.pointsArray=[]);var r=new Kr(e,t);return this.pointsArray.push(r),r},Zr.prototype.deletePointByCondition=function(e){this.pointsArray=this.findPointArray(e)},Zr.prototype.findPointArray=function(e){var t=this;return t.pointsArray.filter(function(r){return e.call(t,r)})},Zr.prototype.getPoint=function(e){return this.pointsArray[e]},Zr.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},Zr.prototype.getPrevIdx=function(e){var t=this.pointsArray.length;return 0===e?t-1:e-1},Zr.prototype.getNextIdx=function(e){return e===this.pointsArray.length-1?0:e+1},Zr.prototype.getIdxOfPoint=function(e){for(var t=this.pointsArray.length,r=0,i=-1,o=!1;!o&&r<t;)this.pointsArray[r]===e&&(o=!0,i=r),r++;return i},Zr.prototype.getSegment=function(e,t){var r=this.getPoint(e),i=this.getNextIdx(e),o=this.getPoint(i);return void 0===t?t=new mi(r,o):t.setPoints(r,o),t},Zr.prototype.setIdxInList=function(){for(var e=this.pointsArray.length,t=0;t<e;t++)this.pointsArray[t].idxInList=t},Zr.prototype.getCopy=function(e){var t;void 0===e?e=new Zr:e.deleteObjects();for(var r=this.getPointsCount(),i=0;i<r;i++)t=this.getPoint(i),e.newPoint(t.x,t.y);return e},Zr.prototype.getBoundingRectangle=function(e){var t=this.getPointsCount();if(0===t)return e;void 0===e&&(e=new _r);for(var r=0;r<t;r++)0===r?e.setInit(this.getPoint(r)):e.addPoint(this.getPoint(r));return e},Zr.prototype.getNearestPointIdxToPoint=function(e){if(void 0!==e){for(var t,r,i,o=this.getPointsCount(),n=0;n<o;n++)r=this.getPoint(n).squareDistToPoint(e),void 0===t?(t=n,i=r):r<i&&(t=n,i=r);return t}},Zr.prototype.reverse=function(){void 0!==this.pointsArray&&this.pointsArray.reverse()},Zr.prototype.getPointsIdxSortedByDistToPoint=function(e,t){if(void 0===this.pointsArray)return t;void 0===t&&(t=[]);for(var r,i,o,n,a,s,l=this.pointsArray,u=[],c=l.length,d=0;d<c;d++)(i=l[d])!==e&&(o=e.squareDistToPoint(i),(r={}).pointIdx=d,r.squaredDist=o,n=0,a=u.length-1,s=this.getIndexToInsertBySquaredDist(u,r,n,a),u.splice(s,0,r));t.length=0;var h=u.length;for(d=0;d<h;d++)t.push(u[d].pointIdx);return t},Zr.prototype.getIndexToInsertBySquaredDist=function(e,t,r,i){var o=i-r;if(0===e.length)return 0;if(o<6){for(var n,a=!1,s=r;!a&&s<=i;)t.squaredDist<e[s].squaredDist&&(n=s,a=!0),s++;return a?n:i+1}var l,u,c=r+Math.floor(o/2);return e[c].squaredDist>t.squaredDist?(l=r,u=c):(l=c,u=i),this.getIndexToInsertBySquaredDist(e,t,l,u)},Zr.getExpandedPoints=function(e,t,r,i,o){if(void 0!==e){void 0===t&&(t=[]);var n,a,s,l,u,c,d,h,f,g,p,m,v,x=[],_=[],y=e.length,T=new mi(void 0,void 0),C=new mi(void 0,void 0);if(void 0===o&&(o=!1),o)for(var b=0;b<y;b++);else{for(b=0;b<y;b++)if(l=e[b],0===(n=b)){u=e[a=en.getNextIdx(n,y)],C.setPoints(l,u),v=(d=C.getLine(d)).getPerpendicularLeft();var M=new Kr(l.x+v.direction.x*r,l.y+v.direction.y*r);x.push(M);var A=new Kr(l.x-v.direction.x*i,l.y-v.direction.y*i);_.push(A)}else if(n===y-1){c=e[s=en.getPrevIdx(n,y)],C.setPoints(c,l),v=(d=C.getLine(d)).getPerpendicularLeft();M=new Kr(l.x+v.direction.x*r,l.y+v.direction.y*r);x.push(M);A=new Kr(l.x-v.direction.x*i,l.y-v.direction.y*i);_.push(A)}else{a=en.getNextIdx(n,y),s=en.getPrevIdx(n,y),u=e[a],c=e[s],T.setPoints(c,l),C.setPoints(l,u),h=T.getLine(h),d=C.getLine(d),g=h.getParallelLeft(r),f=d.getParallelLeft(r);M=g.intersectionWithLine(f,void 0);x.push(M),m=h.getParallelRight(i),p=d.getParallelRight(i);A=m.intersectionWithLine(p,void 0);_.push(A)}x.reverse(),t=x.concat(_)}return t}};var Jr=function e(t,r,i){if(!(this instanceof e))throw new Error(i18next.t("error.construct.create"));this.x=void 0!==t?t:0,this.y=void 0!==r?r:0,this.z=void 0!==i?i:0,this.pointType};Jr.prototype.deleteObjects=function(){this.x=void 0,this.y=void 0,this.z=void 0},Jr.prototype.copyFrom=function(e){this.x=e.x,this.y=e.y,this.z=e.z},Jr.prototype.getSquaredModul=function(){return this.x*this.x+this.y*this.y+this.z*this.z},Jr.prototype.getModul=function(){return Math.sqrt(this.getSquaredModul())},Jr.prototype.unitary=function(){var e=this.getModul();this.x/=e,this.y/=e,this.z/=e},Jr.prototype.isNAN=function(){return!!(isNaN(this.x)||isNaN(this.y)||isNaN(this.z))},Jr.prototype.crossProduct=function(e,t){return void 0===t&&(t=new Jr),t.x=this.y*e.z-e.y*this.z,t.y=e.x*this.z-this.x*e.z,t.z=this.x*e.y-e.x*this.y,t},Jr.prototype.scalarProduct=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},Jr.mix=function(e,t,r,i){i||(i=new Jr);var o=e.x*(1-r)+t.x*r,n=e.y*(1-r)+t.y*r,a=e.z*(1-r)+t.z*r;return i.set(o,n,a),i},Jr.prototype.getSphericalCoords=function(e){void 0===e&&(e=new pe);var t=new Kr(this.x,this.y),r=new Kr(1,0),i=t.angleDegToVector(r);this.y<0&&(i=360-i);var o=t.getModul(),n=180*Math.atan(this.z/o)/Math.PI;return this.z<0&&(n*=-1),e.longitude=i,e.latitude=n,e},Jr.prototype.getRelativeOrientationToVector=function(e,t){var r=this.angleRadToVector(e);return r<t?0:Math.abs(Math.PI-r)<t?1:2},Jr.prototype.angleRadToVector=function(e){if(void 0!==e){var t=this.getModul(),r=e.getModul();if(!(t<1e-9||r<1e-9))return Math.acos(this.scalarProduct(e)/(t*r))}},Jr.prototype.angleDegToVector=function(e){if(void 0!==e){var t=this.angleRadToVector(e);if(void 0!==t)return 180*t/Math.PI}},Jr.prototype.squareDistToPoint=function(e){var t=this.x-e.x,r=this.y-e.y,i=this.z-e.z;return t*t+r*r+i*i},Jr.prototype.isCoincidentToPoint=function(e,t){var r=!1;return this.distToPoint(e)<t&&(r=!0),r},Jr.prototype.isCoincidentToPointCHEAP=function(e,t){return!(Math.abs(this.x-e.x)>t)&&(!(Math.abs(this.y-e.y)>t)&&!(Math.abs(this.z-e.z)>t))},Jr.prototype.squareDistTo=function(e,t,r){var i=this.x-e,o=this.y-t,n=this.z-r;return i*i+o*o+n*n},Jr.prototype.distTo=function(e,t,r){return Math.sqrt(this.squareDistTo(e,t,r))},Jr.prototype.distToPoint=function(e){return Math.sqrt(this.squareDistToPoint(e))},Jr.prototype.distToSphere=function(e){return Math.sqrt(this.squareDistToPoint(e.centerPoint))-e.r},Jr.prototype.aproxDistTo=function(e,t){var r,i,o,n,a=Math.abs(this.x-e.x),s=Math.abs(this.y-e.y),l=Math.abs(this.z-e.z);return a>s?a>l?(i=s/(r=a),o=l/(n=r*t[Math.floor(10*i)]),n*t[Math.floor(10*o)]):(i=a/(r=l),o=s/(n=r*t[Math.floor(10*i)]),n*t[Math.floor(10*o)]):s>l?(i=a/(r=s),o=l/(n=r*t[Math.floor(10*i)]),n*t[Math.floor(10*o)]):(i=a/(r=l),o=s/(n=r*t[Math.floor(10*i)]),n*t[Math.floor(10*o)])},Jr.prototype.getVectorToPoint=function(e,t){if(void 0!==e)return void 0===t&&(t=new Jr),t.set(e.x-this.x,e.y-this.y,e.z-this.z),t},Jr.prototype.set=function(e,t,r){this.x=e,this.y=t,this.z=r},Jr.prototype.readDataFromBuffer=function(e,t){return this.x=new Float32Array(e.slice(t,t+4))[0],t+=4,this.y=new Float32Array(e.slice(t,t+4))[0],t+=4,this.z=new Float32Array(e.slice(t,t+4))[0],t+=4},Jr.prototype.add=function(e,t,r){this.x+=e,this.y+=t,this.z+=r},Jr.prototype.addPoint=function(e){this.x+=e.x,this.y+=e.y,this.z+=e.z},Jr.prototype.scale=function(e){this.x*=e,this.y*=e,this.z*=e},Jr.scale=function(e,t){var r=e.x*t,i=e.y*t,o=e.z*t;return new Jr(r,i,o)},Jr.add=function(e,t){var r=e.x+t.x,i=e.y+t.y,o=e.z+t.z;return new Jr(r,i,o)},Jr.fromArray=function(e){return new Jr(e[0],e[1],e[2])},Jr.toArray=function(e){return[e.x,e.y,e.z]};var Qr=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.pointsArray,void 0!==t&&(this.pointsArray=t),this.bLoop,this.geoLocDataManager,this.vboKeysContainer,this.dirty=!0};Qr.prototype.setDirty=function(e){this.dirty=e},Qr.prototype.deleteObjects=function(e){this.deletePoints3d(),this.deleteVboKeysContainer(e),void 0!==this.geoLocDataManager&&(this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0)},Qr.prototype.deleteVboKeysContainer=function(e){if(void 0!==this.vboKeysContainer){var t=e.sceneState.gl;this.vboKeysContainer.deleteGlObjects(t,e.vboMemoryManager),this.vboKeysContainer=void 0}},Qr.prototype.deletePoints3d=function(){if(void 0!==this.pointsArray){for(var e=this.pointsArray.length,t=0;t<e;t++)this.pointsArray[t].deleteObjects(),this.pointsArray[t]=void 0;this.pointsArray=void 0}},Qr.prototype.addPoint=function(e){void 0!==e&&(void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push(e))},Qr.prototype.getGeographicLocation=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var e=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===e&&(e=this.geoLocDataManager.newGeoLocationData("default")),e},Qr.prototype.addPoint3dArray=function(e){void 0===this.pointsArray&&(this.pointsArray=[]),this.pointsArray.push.apply(this.pointsArray,e)},Qr.prototype.newPoint=function(e,t,r){void 0===this.pointsArray&&(this.pointsArray=[]);var i=new Jr(e,t,r);return this.pointsArray.push(i),i},Qr.prototype.getPoint=function(e){return this.pointsArray[e]},Qr.prototype.getPointsCount=function(){return void 0===this.pointsArray?0:this.pointsArray.length},Qr.prototype.getPrevIdx=function(e){var t=this.pointsArray.length;return 0===e?t-1:e-1},Qr.prototype.getNextIdx=function(e){return e===this.pointsArray.length-1?0:e+1},Qr.prototype.getSegment3D=function(e,t,r){void 0===r&&(r=!1);var i=this.getPointsCount();if(r||e!==i-1){var o=this.getPoint(e),n=this.getNextIdx(e),a=this.getPoint(n);return void 0===t?t=new vi(o,a):t.setPoints(o,a),t}},Qr.prototype.getTangentLine3D=function(e,t,r){void 0===t&&(t=new Rr);var i=this.getPoint(e),o=this.getBisectionPlane(e,void 0,r).getNormal();return t.setPointAndDir(i.x,i.y,i.z,o.x,o.y,o.z),t},Qr.prototype.getBisectionPlane=function(e,t,r){void 0===r&&(r=!1);var i=this.getPointsCount();if(i<1)return t;void 0===t&&(t=new We);var o,n,a=this.getPoint(e);if(r){s=this.getPrevIdx(e);o=this.getSegment3D(e,void 0,r),n=this.getSegment3D(s,void 0,r)}else if(e===i-1){var s=e-1;o=this.getSegment3D(s,void 0,r),n=this.getSegment3D(s,void 0,r)}else if(0===e)o=this.getSegment3D(e,void 0,r),n=this.getSegment3D(e,void 0,r);else{var s=e-1;o=this.getSegment3D(e,void 0,r),n=this.getSegment3D(s,void 0,r)}var l=o.getDirection(),u=n.getDirection();return l.addPoint(u),l.unitary,t.setPointAndNormal(a.x,a.y,a.z,l.x,l.y,l.z),t},Qr.getBoundingBoxOfPoints3DArray=function(e,t){return e&&0!==e.length?(t||(t=new G),t.addPointsArray(e),t):t},Qr.getVbo=function(e,t,r){if(t&&0!==t.length){void 0===r&&(r=new xt);for(var i,o=t.length,n=new Float32Array(3*o),a=0;a<o;a++)i=t[a],n[3*a]=i.x,n[3*a+1]=i.y,n[3*a+2]=i.z;return r.newVBOVertexIdxCacheKey().setDataArrayPos(n,e.vboMemoryManager),r}},Qr.getVboThickLinesExtruded=function(e,t,r,i,o){if(void 0===t||t.length<2)return i;void 0===i&&(i=new xt);for(var n,a=t.length,s=(r.length,new Float32Array(4*(a+1+(a-1)+1+a)*2)),l=0,u=0;u<a;u++)0===u?(n=t[u],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=1,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-1):(n=t[u],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=2,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-2),l+=8;return i.newVBOVertexIdxCacheKey().setDataArrayPos(s,e.vboMemoryManager,4),i},Qr.getVboThickLinesExtruded__original=function(e,t,r,i,o){if(void 0===t||t.length<2)return i;void 0===i&&(i=new xt);for(var n,a=t.length,s=(r.length,new Float32Array(4*(a+1+(a-1)+1+a)*4)),l=0,u=0;u<a;u++)n=t[u],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=1,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-1,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=2,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-2,l+=16;n=t[a-1],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=11,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-11,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=12,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-12,l+=16;for(u=a-2;u>=0;u--)n=t[u],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=21,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-21,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=22,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-22,l+=16;n=t[0],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=31,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-31,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=32,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-32,l+=16;for(u=0;u<a;u++)n=t[u],s[l]=n.x,s[l+1]=n.y,s[l+2]=n.z,s[l+3]=41,s[l+4]=n.x,s[l+5]=n.y,s[l+6]=n.z,s[l+7]=-41,s[l+8]=n.x,s[l+9]=n.y,s[l+10]=n.z,s[l+11]=42,s[l+12]=n.x,s[l+13]=n.y,s[l+14]=n.z,s[l+15]=-42,l+=16;return i.newVBOVertexIdxCacheKey().setDataArrayPos(s,e.vboMemoryManager,4),i},Qr.getRenderableObjectOfPoints3DArray=function(e,t,i,o){if(void 0!==e&&0!==e.length){void 0===o&&(o={}),void 0===o.thickness&&(o.thickness=2),void 0===o.color&&(o.color=new J(1,.3,.3,1));var n=new _o(o);n.vboKeysContainer=Qr.getVboThickLines(t,e,n.vboKeysContainer,o);var a=new ho;a.geoLocDataManager=new ye,a.geoLocDataManager.addGeoLocationData(i),a.objectType=r.OBJECT_TYPE.VECTORMESH,a.boundingSphereWC=new z;var s=i.position,l=Qr.getBoundingBoxOfPoints3DArray(e,void 0).getRadiusAprox();return a.boundingSphereWC.setCenterPoint(s.x,s.y,s.z),a.boundingSphereWC.setRadius(l),a.objectsArray.push(n),a}},Qr.getThickLinesPositionDataArray=function(e,t,r){var i,o=e.length,n=4*o*4;(!t||t.length<n)&&(t=new Float32Array(n));r&&(r.startIdx&&r.startIdx,r.endIdx&&r.endIdx);for(var a=0;a<o;a++){var s=(i=e[a]).x,l=i.y,u=i.z;t[16*a]=s,t[16*a+1]=l,t[16*a+2]=u,t[16*a+3]=1,t[16*a+4]=s,t[16*a+5]=l,t[16*a+6]=u,t[16*a+7]=-1,t[16*a+8]=s,t[16*a+9]=l,t[16*a+10]=u,t[16*a+11]=2,t[16*a+12]=s,t[16*a+13]=l,t[16*a+14]=u,t[16*a+15]=-2}return t},Qr.float32ArrayToPoints3DArray=function(e,t){if(void 0===e||e.length<3)return t;void 0===t&&(t=[]);for(var r=e.length/3,i=0;i<r;i++){var o=new Jr(e[3*i],e[3*i+1],e[3*i+2]);t[i]=o}return t},Qr.getVboThickLines=function(e,t,r,i){if(void 0===t||t.length<2)return r;void 0===r&&(r=new xt);for(var o,n=t.length,a=new Float32Array(4*n*4),s=0;s<n;s++){var l=(o=t[s]).x,u=o.y,c=o.z;a[16*s]=l,a[16*s+1]=u,a[16*s+2]=c,a[16*s+3]=-1,a[16*s+4]=l,a[16*s+5]=u,a[16*s+6]=c,a[16*s+7]=1,a[16*s+8]=l,a[16*s+9]=u,a[16*s+10]=c,a[16*s+11]=-2,a[16*s+12]=l,a[16*s+13]=u,a[16*s+14]=c,a[16*s+15]=2}if(i.colorsArray){var d=i.colorsArray;f=new Uint8Array(4*n*4);var h=1;for(s=0;s<n;s++)(v=d[s])&&(x=Math.floor(255*v.r),_=Math.floor(255*v.g),y=Math.floor(255*v.b),T=Math.floor(255*v.a)),f[16*s]=x,f[16*s+1]=_,f[16*s+2]=y,f[16*s+3]=T,f[16*s+4]=x,f[16*s+5]=_,f[16*s+6]=y,f[16*s+7]=T,f[16*s+8]=x,f[16*s+9]=_,f[16*s+10]=y,f[16*s+11]=T,f[16*s+12]=x,f[16*s+13]=_,f[16*s+14]=y,f[16*s+15]=T}else{var f,g=new J(.6,.9,.99,1),p=new J(.6,.9,.99,1),m=!1;if(i&&(i.color&&(g.setRGBA(i.color.r,i.color.g,i.color.b,i.color.a),p.setRGBA(i.color.r,i.color.g,i.color.b,i.color.a)),i.startColor&&(g.setRGBA(i.startColor.r,i.startColor.g,i.startColor.b,i.startColor.a),m=!0),i.endColor&&(p.setRGBA(i.endColor.r,i.endColor.g,i.endColor.b,i.endColor.a),m=!0)),m){var v;f=new Uint8Array(4*n*4),(v=new J(.6,.9,.99,1)).copyFrom(g);for(h=1,s=0;s<n;s++){h=1-s/(n-1),v=J.mix(g,p,h);var x=Math.floor(255*v.r),_=Math.floor(255*v.g),y=Math.floor(255*v.b),T=Math.floor(255*v.a);f[16*s]=x,f[16*s+1]=_,f[16*s+2]=y,f[16*s+3]=T,f[16*s+4]=x,f[16*s+5]=_,f[16*s+6]=y,f[16*s+7]=T,f[16*s+8]=x,f[16*s+9]=_,f[16*s+10]=y,f[16*s+11]=T,f[16*s+12]=x,f[16*s+13]=_,f[16*s+14]=y,f[16*s+15]=T}}}var C=r.newVBOVertexIdxCacheKey();return C.setDataArrayPos(a,e.vboMemoryManager,4),f&&C.setDataArrayCol(f,e.vboMemoryManager),r},Qr.prototype.makeVbo=function(e){this.pointsArray&&0!==this.pointsArray.length&&(this.deleteVboKeysContainer(e),this.vboKeysContainer=Qr.getVbo(e,this.pointsArray,this.vboKeysContainer),this.dirty=!1)},Qr.prototype.makeThickLinesVbo=function(e,t){this.pointsArray&&0!==this.pointsArray.length&&(this.deleteVboKeysContainer(e),this.vboKeysContainer=Qr.getVboThickLines(e,this.pointsArray,this.vboKeysContainer,t),this.dirty=!1)},Qr.prototype.render=function(e,t,r,i,o){if(void 0===this.vboKeysContainer||this.dirty)this.makeVbo(e);else{var n,a=e.getGl();t.enableVertexAttribArray(t.position3_loc),void 0===n&&(n=!0),n?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST);a.uniform1i(t.hasAditionalMov_loc,!1),a.uniform1i(t.refMatrixType_loc,0),a.uniform4fv(t.oneColor4_loc,[1,0,0,.7]),a.uniform1i(t.colorType_loc,0),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,t);var s=this.vboKeysContainer.vboCacheKeysArray[0];if(!s.bindDataPosition(t,e.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,s.vertexCount),a.enable(a.DEPTH_TEST)}},Qr.prototype.renderAsChild=function(e,t,r,i,o){if(void 0!==this.vboKeysContainer){var n,a=e.getGl();t.enableVertexAttribArray(t.position3_loc),t.disableVertexAttribArray(t.normal3_loc),t.disableVertexAttribArray(t.color4_loc),t.disableVertexAttribArray(t.texCoord2_loc),void 0===n&&(n=!0),n?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST);a.uniform1i(t.hasAditionalMov_loc,!1),a.uniform1i(t.refMatrixType_loc,0),a.uniform1i(t.colorType_loc,0);var s=this.vboKeysContainer.vboCacheKeysArray[0];if(!s.bindDataPosition(t,e.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,s.vertexCount),a.enable(a.DEPTH_TEST)}else this.makeVbo(e)},Qr.prototype.renderThickLines__element=function(e,t,r,i,o){if(void 0!==this.vboKeysContainer&&void 0!==this.geoLocDataManager){var n=this.vboKeysContainer.getVboKey(0);(t=e.postFxShadersManager.getShader("thickLine")).useProgram(),t.bindUniformGenerals();var a=e.getGl();a.enable(a.BLEND),a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD),a.blendFuncSeparate(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA,a.ONE,a.ONE_MINUS_SRC_ALPHA),a.disable(a.CULL_FACE),a.enableVertexAttribArray(t.prev_loc),a.enableVertexAttribArray(t.current_loc),a.enableVertexAttribArray(t.next_loc),a.enableVertexAttribArray(t.order_loc);a.getAttribLocation(t.program,"order");this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,t);var s=e.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),u=s.drawingBufferHeight;this.thickness=10,a.uniform4fv(t.color_loc,[.5,.7,.9,1]),a.uniform2fv(t.viewport_loc,[l[0],u[0]]),a.uniform1f(t.thickness_loc,this.thickness);var c=n.vboBufferPos,d=c.dataDimensions;if(c.isReady(a,e.vboMemoryManager)){a.bindBuffer(a.ARRAY_BUFFER,c.key),a.vertexAttribPointer(t.prev_loc,d,a.FLOAT,!1,0,0),a.vertexAttribPointer(t.current_loc,d,a.FLOAT,!1,0,12),a.vertexAttribPointer(t.next_loc,d,a.FLOAT,!1,0,24);var h=n.getVboCustom("thickLineOrder");if(h.isReady(a,e.vboMemoryManager)){a.bindBuffer(a.ARRAY_BUFFER,h.key),a.vertexAttribPointer(t.order_loc,h.dataDimensions,a.FLOAT,!1,0,0);var f=n.indicesCount;if(!n.bindDataIndice(t,e.vboMemoryManager))return!1;a.disable(a.DEPTH_TEST),a.drawElements(a.LINE_STRIP,f,a.UNSIGNED_SHORT,0),a.enable(a.DEPTH_TEST),a.enable(a.CULL_FACE),a.disable(a.BLEND)}}}},Qr.prototype.renderThickLines=function(e,t,r,i,o){if(void 0!==this.vboKeysContainer){if(void 0!==this.geoLocDataManager){var n=this.vboKeysContainer.getVboKey(0);(t=e.postFxShadersManager.getShader("thickLine")).useProgram(),t.bindUniformGenerals();var a=e.getGl();a.disable(a.CULL_FACE),a.enableVertexAttribArray(t.prev_loc),a.enableVertexAttribArray(t.current_loc),a.enableVertexAttribArray(t.next_loc),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,t);var s=e.sceneState,l=s.drawingBufferWidth,u=s.drawingBufferHeight;this.thickness=3,a.uniform4fv(t.color_loc,[.5,.7,.9,1]),a.uniform2fv(t.viewport_loc,[l[0],u[0]]),a.uniform1f(t.thickness_loc,this.thickness);var c=n.vboBufferPos,d=c.dataDimensions;c.isReady(a,e.vboMemoryManager)&&(a.bindBuffer(a.ARRAY_BUFFER,c.key),a.vertexAttribPointer(t.prev_loc,d,a.FLOAT,!1,16,0),a.vertexAttribPointer(t.current_loc,d,a.FLOAT,!1,16,32),a.vertexAttribPointer(t.next_loc,d,a.FLOAT,!1,16,96),a.drawArrays(a.TRIANGLE_STRIP,0,n.vertexCount-4),a.enable(a.CULL_FACE))}}else this.makeThickLinesVbo(e,o)},Qr.prototype.renderLines=function(e,t,r,i,o,n){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var a=e.sceneState.gl;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount()||this.dirty)this.makeVbo(e);else{t.enableVertexAttribArray(t.position3_loc),void 0===o&&(o=!0),o?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(a,t);var s=this.vboKeysContainer.vboCacheKeysArray[0];if(!s.bindDataPosition(t,e.vboMemoryManager))return!1;void 0===n&&(n=a.LINE_STRIP),a.drawArrays(n,0,s.vertexCount),a.enable(a.DEPTH_TEST)}},Qr.prototype.renderPoints=function(e,t,r,i){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var o=e.sceneState.gl;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount()||this.dirty)this.makeVbo(e);else{t.enableVertexAttribArray(t.position3_loc),void 0===i&&(i=!0),i?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,t);var n=this.vboKeysContainer.vboCacheKeysArray[0];if(!n.bindDataPosition(t,e.vboMemoryManager))return!1;o.drawArrays(o.POINTS,0,n.vertexCount),o.enable(o.DEPTH_TEST)}},Qr.prototype.renderPointsIndividually=function(e,t,r,i){if(void 0===this.pointsArray)return!1;if(void 0===this.geoLocDataManager)return!1;var o=e.sceneState.gl;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount()||this.dirty)this.makeVbo(e);else{if(t.enableVertexAttribArray(t.position3_loc),void 0===i&&(i=!0),i?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,t),!this.vboKeysContainer.vboCacheKeysArray[0].bindDataPosition(t,e.vboMemoryManager))return!1;for(var n=this.pointsArray.length,a=0;a<n;a++)o.drawArrays(o.POINTS,a,1);o.enable(o.DEPTH_TEST)}};var $r=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.point2dList,this.normal,this.convexPolygonsArray,this.bRect,t&&t.point2dList&&(this.point2dList=t.point2dList)};$r.prototype.deleteObjects=function(){void 0!==this.point2dList&&(this.point2dList.deleteObjects(),this.point2dList=void 0),this.normal=void 0},$r.prototype.getBoundingRectangle=function(e){return void 0===this.point2dList?e:(this.bRect||(this.bRect=this.point2dList.getBoundingRectangle(e)),this.bRect)},$r.prototype.getEdgeDirection=function(e){return this.point2dList.getSegment(e).getDirection(void 0)},$r.prototype.getEdgeVector=function(e){return this.point2dList.getSegment(e).getVector(void 0)},$r.prototype.reverseSense=function(){void 0!==this.point2dList&&this.point2dList.reverse()},$r.prototype.getCopy=function(e){return void 0===this.point2dList?e:(void 0===e&&(e=new $r),void 0===e.point2dList&&(e.point2dList=new Zr),e.point2dList=this.point2dList.getCopy(e.point2dList),this.normal&&(e.normal=this.normal),e)},$r.prototype.calculateNormal=function(e){void 0===e&&(e=[]),this.normal=0;for(var t=this.point2dList.getPointsCount(),r=0;r<t;r++){this.point2dList.getPoint(r);var i=this.point2dList.getPrevIdx(r),o=this.getEdgeDirection(i),n=this.getEdgeDirection(r),a=o.crossProduct(n,a),s=o.scalarProduct(n);if(a<0)a=-1,e.push(r);else{if(!(a>0))continue;a=1}var l=s,u=Math.acos(l);this.normal+=a*u}return this.normal>0?this.normal=1:this.normal=-1,e},$r.splitPolygonByMultipleSegments=function(e,t,r,i){i||(i=1e-8);var o=[],n=[];o.push(e);i=1e-5;for(var a=t.length,s=0;s<a;s++){for(var l=t[s],u=o.length,c=0;c<u;c++){e=o[c];$r.splitPolygonBySegment(e,l,n,i)||n.push(e)}o=n,n=[]}return r||(r=[]),Array.prototype.push.apply(r,o),r},$r.splitPolygonBySegment=function(e,t,r,i){if(i||(i=1e-8),!e.intersectionWithSegment(t,i))return!1;for(var o=new Kr,n=new Kr,a=new Kr,s=-1,l=-1,u=e.point2dList.getPointsCount(),c=0;c<u;c++){e.point2dList.getSegment(c,void 0).intersectionWithSegment(t,i,o)===F.INTERSECTION_INTERSECT&&(s<0?(s=c,n.set(o.x,o.y)):(l=c,a.set(o.x,o.y)))}if(s<0||l<0)return!1;var d=s+1,h=l+2;return e.point2dList.insertPoint(n,d),e.point2dList.insertPoint(a,h),r=e.splitPolygon(d,h,r),!0},$r.prototype.tessellate=function(e,t){var r=e.length;if(t||(t=[]),0===r)return t.push(this),t;for(var i,o=!1,n=0;!o&&n<r;){var a=e[n],s=this.point2dList.getPoint(a),l=[];this.getPointsIdxSortedByDistToPoint(s,l);for(var u=l.length,c=0;!o&&c<u;)if(i=l[c],this.point2dList.getPrevIdx(a)!==i&&this.point2dList.getNextIdx(a)!==i){var d=new mi(this.point2dList.getPoint(a),this.point2dList.getPoint(i));if(this.intersectionWithSegment(d))c++;else{var h=this.splitPolygon(a,i);if(h.length<2)c++;else{var f=h[0],g=h[1],p=f.calculateNormal(),m=g.calculateNormal(),v=f.normal,x=g.normal;v===this.normal&&x===this.normal&&(o=!0,p.length>0?t=f.tessellate(p,t):(void 0===t&&(t=[]),t.push(f)),m.length>0?t=g.tessellate(m,t):(void 0===t&&(t=[]),t.push(g))),c++}}}else c++;n++}return t},$r.prototype.intersectionWithSegment=function(e,t){if(void 0!==this.bRect){var r=e.getBoundingRectangle(r);if(!this.bRect.intersectsWithRectangle(r))return!1}var i;void 0===t&&(t=1e-7);for(var o=this.point2dList.getPointsCount(),n=0;n<o;n++){if(i=this.point2dList.getSegment(n,i),!e.sharesPointsWithSegment(i))if(e.intersectionWithSegment(i,t)===F.INTERSECTION_INTERSECT)return!0}return!1},$r.prototype.splitPolygon=function(e,t,r){void 0===r&&(r=[]);var i=new $r;i.point2dList=new Zr,i.point2dList.pointsArray=[],i.point2dList.pointsArray.push(this.point2dList.getPoint(e)),i.point2dList.pointsArray.push(this.point2dList.getPoint(t));for(var o=!1,n=t,a=e,s=0,l=this.point2dList.getPointsCount();!o&&s<l;){(c=this.point2dList.getNextIdx(n))===a?o=!0:(i.point2dList.pointsArray.push(this.point2dList.getPoint(c)),n=c),s++}r.push(i);var u=new $r;for(u.point2dList=new Zr,u.point2dList.pointsArray=[],u.point2dList.pointsArray.push(this.point2dList.getPoint(t)),u.point2dList.pointsArray.push(this.point2dList.getPoint(e)),o=!1,n=e,a=t,s=0;!o&&s<l;){var c;(c=this.point2dList.getNextIdx(n))===a?o=!0:(u.point2dList.pointsArray.push(this.point2dList.getPoint(c)),n=c),s++}return r.push(u),r},$r.prototype.getPointsIdxSortedByDistToPoint=function(e,t){return void 0===t&&(t=[]),t=this.point2dList.getPointsIdxSortedByDistToPoint(e,t)},$r.prototype.getTrianglesConvexPolygon=function(e){void 0===e&&(e=[]);var t,r=this.point2dList.getPointsCount();if(r<3)return e;for(var i=1;i<r-1;i++){t=new bi;var o=this.point2dList.getPoint(0).idxInList,n=this.point2dList.getPoint(i).idxInList,a=this.point2dList.getPoint(i+1).idxInList;t.vtxIdx0=o,t.vtxIdx1=n,t.vtxIdx2=a,e.push(t)}return e},$r.prototype.getVbo=function(e){void 0===e&&(e=new vt);var t,r,i=[],o=[];r=this.normal>0?1:-1;for(var n=this.point2dList.getPointsCount(),a=0;a<n;a++)t=this.point2dList.getPoint(a),i.push(t.x),i.push(t.y),i.push(0),o.push(0),o.push(0),o.push(255*r);e.posVboDataArray=Float32Array.from(i),e.norVboDataArray=Int8Array.from(o),this.point2dList.setIdxInList();var s=[],l=this.convexPolygonsArray.length;for(a=0;a<l;a++){s=this.convexPolygonsArray[a].getTrianglesConvexPolygon(s)}return Ai.getVboFaceDataArray(s,e),e},$r.getVbo=function(e,t,r){void 0===r&&(r=new vt);var i,o,n=[],a=[];o=e.normal>0?1:-1;for(var s=e.point2dList.getPointsCount(),l=0;l<s;l++)i=e.point2dList.getPoint(l),n.push(i.x),n.push(i.y),n.push(0),a.push(0),a.push(0),a.push(255*o);r.posVboDataArray=Float32Array.from(n),r.norVboDataArray=Int8Array.from(a),e.point2dList.setIdxInList();var u=[],c=t.length;for(l=0;l<c;l++){u=t[l].getTrianglesConvexPolygon(u)}return Ai.getVboFaceDataArray(u,r),r},$r.prototype.intersectionWithPolygon2D=function(e){var t=this.calculateNormal(t);-1===this.normal&&(this.reverseSense(),t.length=0,t=this.calculateNormal(t)),(!this.convexPolygonsArray||Array.isArray(this.convexPolygonsArray)&&0===this.convexPolygonsArray.length)&&(this.convexPolygonsArray=[],this.tessellate(t,this.convexPolygonsArray));for(var r=this.convexPolygonsArray,i=!1,o=0,n=r.length;o<n;o++){if(r[o].intersectionWithPolygon2DConvexPolygon(e)){i=!0;break}}return i},$r.prototype.intersectionWithPolygon2DConvexPolygon=function(e){var t=this.getBoundingRectangle(),r=e.getBoundingRectangle();if(!t.intersectsWithRectangle(r))return!1;for(var i=e.point2dList,o=!1,n=0,a=i.getPointsCount();n<a;n++){var s=i.getPoint(n);if(3===this.getRelativePostionOfPoint2DConvexPolygon(s)){o=!0;break}}if(!o)for(n=0,a=i.getPointsCount();n<a;n++)if(this.intersectionWithSegment(i.getSegment(n),1e-15)){o=!0;break}return o},$r.prototype.getRelativePostionOfPoint2DConvexPolygon=function(e){if(!this.getBoundingRectangle().intersectsWithPoint2D(e))return 0;for(var t,r=0,i=this.point2dList.getPointsCount();r<i;r++){if(this.point2dList.getPoint(r).isCoincidentToPoint(e,1e-15))return 1}for(r=0,i=this.point2dList.getPointsCount();r<i;r++){if(this.point2dList.getSegment(r).intersectionWithPoint(e,1e-15))return 2}for(r=0,i=this.point2dList.getPointsCount();r<i;r++){var o=this.point2dList.getSegment(r).getLine().getRelativeSideOfPoint(e,1e-15);if(t||(t=o),t!==o)return 0}return 3},$r.prototype.solveDegeneratedPoints=function(){var e=this.point2dList.getPointsCount();if(!(e<3)){for(var t=[],r=0;r<e;r++){var i=this.point2dList.getPoint(r);if(t.length>0){var o=t[t.length-1];if(i.isCoincidentToPoint(o,1e-7))continue}t.push(i)}this.point2dList.pointsArray=t}},$r.prototype.solveUroborus=function(){var e=this.point2dList.getPointsCount();if(!(e<3)){var t=this.point2dList.getPoint(0),r=this.point2dList.getPoint(e-1);t.isCoincidentToPoint(r,1e-7)&&this.point2dList.pointsArray.pop()}},$r.makePolygonByGeographicCoordArray=function(e){for(var t=new Zr,r=0,i=e.length;r<i;r++){var o=e[r];t.newPoint(o.longitude,o.latitude)}var n=new $r;return n.point2dList=t,n.solveUroborus(),n.solveDegeneratedPoints(),n},$r.makePolygonByCartesian3Array=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(on.pointToGeographicCoord(e[r]));return $r.makePolygonByGeographicCoordArray(t)};var ei=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.point2dArray};ei.prototype.addPoint2d=function(e){if(void 0===this.point2dArray&&(this.point2dArray=[]),!(e&&e instanceof Kr))throw new Error(Ue.REQUIRED_EMPTY_ERROR("Point2D"));return this.point2dArray.push(e),e},ei.prototype.newPoint2d=function(e,t){void 0===this.point2dArray&&(this.point2dArray=[]);var r=new Kr(e,t);return this.addPoint2d(r),r},ei.prototype.getPointsCount=function(){return void 0===this.point2dArray?0:this.point2dArray.length},ei.prototype.deleteObjects=function(){for(var e=this.point2dArray.length,t=0;t<e;t++)this.point2dArray[t].deleteObjects(),this.point2dArray[t]=void 0;this.point2dArray=void 0},ei.prototype.getPoints=function(e){var t;void 0===e&&(e=[]);for(var r=e.length,i=this.point2dArray.length,o=0;o<i;o++)if(0===o)if(r>0){var n=e[r-1],a=this.point2dArray[o];n.isCoincidentToPoint(a,1e-7)||((t=new Kr).copyFrom(this.point2dArray[o]),t.pointType=1,e.push(t))}else(t=new Kr).copyFrom(this.point2dArray[o]),t.pointType=1,e.push(t);else(t=new Kr).copyFrom(this.point2dArray[o]),t.pointType=1,e.push(t);return e};var ti=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.point3dArray,this.geoLocDataManager,this.vboKeysContainer};ti.prototype.newPoint3d=function(e,t,r){void 0===this.point3dArray&&(this.point3dArray=[]);var i=new Jr(e,t,r);return this.point3dArray.push(i),i},ti.prototype.addPoint3dArray=function(e){void 0!==e&&(void 0===this.point3dArray&&(this.point3dArray=[]),this.point3dArray.push.apply(this.point3dArray,e))},ti.prototype.getGeographicLocation=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var e=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===e&&(e=this.geoLocDataManager.newGeoLocationData("default")),e},ti.prototype.makeVbo=function(e){this.point3dArray&&0!==this.point3dArray.length&&(this.vboKeysContainer=Qr.getVbo(e,this.point3dArray,this.vboKeysContainer))},ti.prototype.renderLines=function(e,t,r,i,o){if(void 0===this.point3dArray)return!1;var n=e.sceneState.gl;void 0!==this.vboKeysContainer&&0!==this.vboKeysContainer.getVbosCount()||this.makeVbo(e),t.enableVertexAttribArray(t.position3_loc),n.uniform1i(t.bPositionCompressed_loc,!1),n.uniform1i(t.bUse1Color_loc,!0),n.uniform4fv(t.oneColor4_loc,[1,1,.1,1]),n.uniform1f(t.fixPointSize_loc,5),n.uniform1i(t.bUseFixPointSize_loc,!0),void 0===o&&(o=!0),o?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,t);var a=this.vboKeysContainer.vboCacheKeysArray[0];if(!a.bindDataPosition(t,e.vboMemoryManager))return!1;n.drawArrays(n.LINE_STRIP,0,a.vertexCount),n.enable(n.DEPTH_TEST)},ti.prototype.renderPoints=function(e){};var ri=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.shadowMeshesMadeCount=0};ri.prototype.reset=function(){this.shadowMeshesMadeCount=0};var ii=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.outerRing,this.innerRingsList};ii.prototype.newOuterRing=function(){return void 0===this.outerRing?this.outerRing=new fi:this.outerRing.deleteObjects(),this.outerRing},ii.prototype.newInnerRing=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new gi),this.innerRingsList.newRing()},ii.prototype.getInnerRingsList=function(){return void 0===this.innerRingsList&&(this.innerRingsList=new gi),this.innerRingsList},ii.prototype.deleteObjects=function(){this.outerRing&&(this.outerRing.deleteObjects(),this.outerRing=void 0),this.innerRingsList&&(this.innerRingsList.deleteObjects(),this.innerRingsList=void 0)},ii.prototype.hasHoles=function(){return void 0!==this.innerRingsList&&0!==this.innerRingsList.getRingsCount()},ii.fromPoint2DArray=function(e){if(!e||!Array.isArray(e))throw new Error(Ue.REQUIRED_EMPTY_ERROR("Point2D Array"));for(var t=new ii,r=t.newOuterRing().newElement("POLYLINE"),i=e.length,o=0;o<i;o++)r.addPoint2d(e[o]);return t},ii.prototype.getVBO=function(e){if(void 0===this.outerRing)return e;this.getGeneralPolygon(void 0).getVbo(e)},ii.prototype.getConvexFacesIndicesData=function(e){if(void 0===this.outerRing)return resultVbo;var t,r,i,o,n,a,s=this.getGeneralPolygon(void 0);if(void 0===e&&(e=[]),this.outerRing.polygon.point2dList.setIdxInList(),void 0!==this.innerRingsList)for(var l=this.innerRingsList.getRingsCount(),u=0;u<l;u++){this.innerRingsList.getRing(u).polygon.point2dList.setIdxInList()}var c=s.convexPolygonsArray.length;for(u=0;u<c;u++){t=[];for(var d=(r=s.convexPolygonsArray[u]).point2dList.getPointsCount(),h=0;h<d;h++)o=(i=(a=r.point2dList.getPoint(h)).indexData).owner,i.idxInList=a.idxInList,n=o===this.outerRing?-1:this.innerRingsList.getRingIndex(o),i.ownerIdx=n,t.push(i);e.push(t)}return e},ii.prototype.getGeneralPolygon=function(e){if(this.checkNormals(),this.hasHoles())e=this.tessellateHoles(e);else{void 0===e&&(e=new $r),void 0===e.point2dList&&(e.point2dList=new Zr);for(var t=this.outerRing.polygon,r=t.point2dList.getPointsCount(),i=0;i<r;i++)t.point2dList.getPoint(i),e.point2dList.addPoint(t.point2dList.getPoint(i))}e.convexPolygonsArray=[];var o=e.calculateNormal(o);return e.convexPolygonsArray=e.tessellate(o,e.convexPolygonsArray),e},ii.prototype.eliminateHolePolygonBySplitPoints=function(e,t,r,i,o){void 0===o&&(o=new $r),void 0===o.point2dList&&(o.point2dList=new Zr);for(var n,a=e.point2dList.getPointsCount(),s=!1,l=0,u=r;!s&&l<a;)n=e.point2dList.getPoint(u),o.point2dList.addPoint(n),(u=e.point2dList.getNextIdx(u))===r&&(s=!0,n=e.point2dList.getPoint(u),o.point2dList.addPoint(n)),l++;var c,d=t.point2dList.getPointsCount();for(s=!1,l=0,u=i;!s&&l<d;)c=t.point2dList.getPoint(u),o.point2dList.addPoint(c),(u=t.point2dList.getNextIdx(u))===i&&(s=!0,c=t.point2dList.getPoint(u),o.point2dList.addPoint(c)),l++;return o},ii.prototype.eliminateHolePolygon=function(e,t,r,i){for(var o,n,a=[],s=t.polygon,l=s.point2dList.getPoint(r),u=(a=e.getPointsIdxSortedByDistToPoint(l,a)).length,c=new mi,d=!1,h=0;!d&&h<u;)o=a[h],n=e.point2dList.getPoint(o),c.setPoints(n,l),e.intersectionWithSegment(c)||s.intersectionWithSegment(c)?h++:(i=this.eliminateHolePolygonBySplitPoints(e,s,o,r,i),d=!0,h++);return!!d},ii.prototype.tessellateHoles=function(e){if(void 0===this.outerRing)return e;if(!this.hasHoles())return e;var t,r,i,o,n,a;void 0===e&&(e=new $r);var s=this.outerRing;void 0===s.polygon&&s.makePolygon();for(var l=s.polygon,u=l.calculateNormal(u),c=[],d=this.innerRingsList.getRingsCount(),h=0;h<d;h++)c.push(this.innerRingsList.getRing(h));var f=new $r,g=new $r;g.point2dList=new Zr;var p=l.point2dList.getPointsCount();for(h=0;h<p;h++)l.point2dList.getPoint(h),g.point2dList.addPoint(l.point2dList.getPoint(h));for(var m=new Kr,v=[],x=(d=c.length,h=0,!1);!x&&h<d;){if(a=gi.getBoundingRectangle(c,a),m.set(a.minX,a.minY),v.length=0,t=(o=(v=gi.getSortedRingsByDistToPoint(m,c,v))[0]).ring,r=o.ringIdx,i=t.polygon,n=o.pointIdx,i.calculateNormal(),this.eliminateHolePolygon(g,t,n,f)){if(g=f,1===c.length){x=!0;break}c.splice(r,1),f=new $r}h++}return e=g},ii.prototype.checkNormals=function(){if(void 0!==this.outerRing){var e=this.outerRing;void 0===e.polygon&&e.makePolygon();var t=e.polygon,r=t.calculateNormal(r),i=t.normal;if(void 0!==this.innerRingsList)for(var o,n=this.innerRingsList.getRingsCount(),a=0;a<n;a++){var s,l;void 0===(o=this.innerRingsList.getRing(a)).polygon&&o.makePolygon(),(s=o.polygon).calculateNormal(),(l=s.normal)===i&&(s.reverseSense(),s.normal=-l)}}},ii.prototype.TEST__setFigure_1=function(){var e,t,r,i=this.newOuterRing();(e=i.newElement("POLYLINE")).newPoint2d(7,7),e.newPoint2d(0,7),e.newPoint2d(0,0),e.newPoint2d(7,0),(t=i.newElement("ARC")).setCenterPosition(7,3.5),t.setRadius(3.5),t.setStartAngleDegree(-90),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(r=this.newInnerRing().newElement("RECTANGLE")).setCenterPosition(3,3),r.setDimensions(2,2)},ii.prototype.TEST__setFigure_2holes=function(){var e,t,r,i,o=this.newOuterRing();(e=o.newElement("POLYLINE")).newPoint2d(7,7),e.newPoint2d(0,7),e.newPoint2d(0,0),e.newPoint2d(7,0),(t=o.newElement("ARC")).setCenterPosition(7,3.5),t.setRadius(3.5),t.setStartAngleDegree(-90),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24;var n=this.newInnerRing();(i=n.newElement("RECTANGLE")).setCenterPosition(3,3),i.setDimensions(2,2),(r=(n=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(7,3),r.setRadius(1)},ii.prototype.TEST__setFigureHole_2=function(){var e,t,r,i,o,n=this.newOuterRing();(e=n.newElement("POLYLINE")).newPoint2d(-13,3),e.newPoint2d(-13,-11),(t=n.newElement("ARC")).setCenterPosition(-8,-11),t.setRadius(5),t.setStartAngleDegree(180),t.setSweepAngleDegree(90),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(-8,-16),e.newPoint2d(-5,-16),e.newPoint2d(-3,-15),e.newPoint2d(-3,-14),e.newPoint2d(-5,-12),e.newPoint2d(-3,-11),e.newPoint2d(-2,-9),e.newPoint2d(3,-9),(t=n.newElement("ARC")).setCenterPosition(9,-9),t.setRadius(6),t.setStartAngleDegree(180),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(15,-9),e.newPoint2d(16,-9),e.newPoint2d(16,4),(t=n.newElement("ARC")).setCenterPosition(11,4),t.setRadius(5),t.setStartAngleDegree(0),t.setSweepAngleDegree(90),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(11,9),e.newPoint2d(4,9),(t=n.newElement("ARC")).setCenterPosition(4,11),t.setRadius(2),t.setStartAngleDegree(-90),t.setSweepAngleDegree(-180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(4,13),e.newPoint2d(9,13),(t=n.newElement("ARC")).setCenterPosition(9,14.5),t.setRadius(1.5),t.setStartAngleDegree(-90),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(9,16),e.newPoint2d(2,16),e.newPoint2d(0,14),e.newPoint2d(-4,16),e.newPoint2d(-9,16),(t=n.newElement("ARC")).setCenterPosition(-9,14),t.setRadius(2),t.setStartAngleDegree(90),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(-9,12),e.newPoint2d(-6,12),(t=n.newElement("ARC")).setCenterPosition(-6,10.5),t.setRadius(1.5),t.setStartAngleDegree(90),t.setSweepAngleDegree(-180),t.numPointsFor360Deg=24,(e=n.newElement("POLYLINE")).newPoint2d(-6,9),e.newPoint2d(-7,9),(t=n.newElement("ARC")).setCenterPosition(-7,3),t.setRadius(6),t.setStartAngleDegree(90),t.setSweepAngleDegree(90),t.numPointsFor360Deg=24;var a=this.newInnerRing();(e=a.newElement("POLYLINE")).newPoint2d(-9,3),e.newPoint2d(-10,-4),e.newPoint2d(-10,-8),e.newPoint2d(-8,-11),e.newPoint2d(-3,-7),e.newPoint2d(4,-7),(t=a.newElement("ARC")).setCenterPosition(8,-7),t.setRadius(4),t.setStartAngleDegree(180),t.setSweepAngleDegree(180),t.numPointsFor360Deg=24,(e=a.newElement("POLYLINE")).newPoint2d(12,-7),e.newPoint2d(12,-4),e.newPoint2d(8,-10),e.newPoint2d(4,-5),e.newPoint2d(-8,-5),e.newPoint2d(-7,4),e.newPoint2d(9,4),e.newPoint2d(9,-5),e.newPoint2d(14,2),e.newPoint2d(13,2),e.newPoint2d(11,0),e.newPoint2d(11,7),e.newPoint2d(13,8),e.newPoint2d(5,8),e.newPoint2d(9,6),e.newPoint2d(-6,6),(t=a.newElement("ARC")).setCenterPosition(-6,3),t.setRadius(3),t.setStartAngleDegree(90),t.setSweepAngleDegree(90),t.numPointsFor360Deg=24,(r=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-10,-13),r.setRadius(1),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-6.5,-14),o.setRadiusCount(5),o.setInteriorRadius(.6),o.setExteriorRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-9,14),o.setRadiusCount(6),o.setInteriorRadius(.5),o.setExteriorRadius(1.5),(i=(a=this.newInnerRing()).newElement("RECTANGLE")).setCenterPosition(-4.5,1.5),i.setDimensions(3,3),(r=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-4.5,-2.5),r.setRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(0,0),o.setRadiusCount(5),o.setInteriorRadius(1),o.setExteriorRadius(2.5),(r=(a=this.newInnerRing()).newElement("CIRCLE")).setCenterPosition(-6,14),r.setRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(-1.5,11),o.setRadiusCount(12),o.setInteriorRadius(.6),o.setExteriorRadius(2),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(13.5,5),o.setRadiusCount(25),o.setInteriorRadius(.4),o.setExteriorRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(9,-13),o.setRadiusCount(10),o.setInteriorRadius(.4),o.setExteriorRadius(1.5),(o=(a=this.newInnerRing()).newElement("STAR")).setCenterPosition(5.5,1.5),o.setRadiusCount(7),o.setInteriorRadius(.7),o.setExteriorRadius(2)};var oi=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.profilesArray,this.auxiliarAxis};oi.prototype.newProfile=function(){void 0===this.profilesArray&&(this.profilesArray=[]);var e=new ii;return this.profilesArray.push(e),e},oi.prototype.deleteObjects=function(){if(this.profilesArray){for(var e=this.profilesArray.length,t=0;t<e;t++)this.profilesArray[t].deleteObjects(),this.profilesArray=void 0;this.profilesArray=void 0}};var ni=function e(t,r,i){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.quantizedMeshManager=t,this.guid,this.geoCoordsArray=r,this.excavationAltitude=i,this.geoExtent,this.minDepth=10,this.maxDepth=23,this.intersectedTilesMap};ni.prototype.getGeographicExtent=function(){if(this.geoCoordsArray&&0!==this.geoCoordsArray.length)return this.geoExtent||(this.geoExtent=ve.getGeographicExtent(this.geoCoordsArray,void 0)),this.geoExtent},ni.prototype.getIntersectedTiles=function(){if(!this.intersectedTilesMap){var e=this.getGeographicExtent(),t=e.minGeographicCoord,r=e.maxGeographicCoord,i=t.longitude,o=t.latitude,n=r.longitude,a=r.latitude;this.intersectedTilesMap={};for(var s=this.minDepth;s<=this.maxDepth;s++){var l=Ke.selectTileIndicesArray(s,i,o,n,a,void 0);this.intersectedTilesMap[s]={};for(var u=0,c=l.length;u<c;u++){var d=l[u];this.intersectedTilesMap[s][d.X]||(this.intersectedTilesMap[s][d.X]=[]),this.intersectedTilesMap[s][d.X].push(d.Y)}}}return this.intersectedTilesMap};var ai=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t,this.excavatedQuantizedMeshMap={},this.excavationSetsArray=[],this.quantizedMeshExcavationSet,this.workerQuantizedMeshExcavation,this._status=!0,this.excavatedTilesMap={},this.tilesMap={}};function si(e,t,r,i,o){if(!ui(r,e))return!1;if(ui(i,e))return!!t&&(!!ui(r,t)&&(!ui(i,t)&&(li(t,o),i[t.level]||(i[t.level]={}),i[t.level][t.x]||(i[t.level][t.x]=[]),i[t.level][t.x].indexOf(t.y)<0&&i[t.level][t.x].push(t.y),!0)));var n=e.parent;return!(13!==e.level&&!si(n,e,r,i,o))&&(li(e,o),i[e.level]||(i[e.level]={}),i[e.level][e.x]||(i[e.level][e.x]=[]),i[e.level][e.x].indexOf(e.y)<0&&i[e.level][e.x].push(e.y),!0)}function li(e,t){e.data=void 0,e.state=Cesium.QuadtreeTileLoadState.START;var r=t.globe._surface.tileProvider;Cesium.GlobeSurfaceTile.initialize(e,t.terrainProvider,r._imageryLayers)}function ui(e,t){var r=t.x,i=t.y,o=t.level;return e[o]&&e[o][r]&&e[o][r].indexOf(i)>-1}Object.defineProperties(ai.prototype,{status:{get:function(){return this._status},set:function(e){this._status=e}}}),ai.prototype.newExcavationSet=function(e,t){var r,i=e[0];if(r=i,isNaN(parseFloat(r))||isNaN(r-0)){if(Array.isArray(i)){o=e;e=[];for(n=o.length,a=0;a<n;a++){s=o[a][0],l=o[a][1],i=new pe(s,l,0);e.push(i)}}}else{var o=e;e=[];for(var n=o.length/2,a=0;a<n;a++){var s=o[2*a],l=o[2*a+1],i=new pe(s,l,0);e.push(i)}}var u=new ni(this,e,t);return this.excavationSetsArray.push(u),u},ai.prototype.setQuantizedMeshExcavationSet=function(e,t){this.quantizedMeshExcavationSet=new ni(this,e,t)},ai.prototype.excavate=function(){this.magoManager.scene.terrainProvider;this.testAndReproductionTerrain()},ai.prototype.applyQuantizedMeshExcavation=function(){this.magoManager.scene.terrainProvider},ai.prototype.stopQuantizedMeshExcavation=function(){var e=this.magoManager.scene.terrainProvider;if(!e.target)return!1;e.target=void 0,this.excavatedTilesMap={}},ai.prototype.testAndReproductionTerrain=function(){for(var e=this.magoManager.scene,t=0,r=e.globe._surface._tilesToRender,i=this.tilesMap,o=0,n=r.length;o<n&&!(t>10);++o){si(r[o],void 0,i,this.excavatedTilesMap,e)&&t++}},ai.prototype.doExcavationPromise=function(e,t,r){var i=e.tileIndices.X,o=e.tileIndices.Y,n=e.tileIndices.L,a=I.imageryType.CRS84,s=Ke.getGeographicExtentOfTileLXY(n,i,o,void 0,a),l=s.minGeographicCoord.longitude,u=s.minGeographicCoord.latitude,c=s.maxGeographicCoord.longitude,d=s.maxGeographicCoord.latitude,h={info:{X:i,Y:o,L:n},uValues:e._uValues,vValues:e._vValues,hValues:e._heightValues,indices:e._indices,minHeight:e._minimumHeight,maxHeight:e._maximumHeight,southIndices:e._southIndices,eastIndices:e._eastIndices,northIndices:e._northIndices,westIndices:e._westIndices,southSkirtHeight:e._southSkirtHeight,eastSkirtHeight:e._eastSkirtHeight,northSkirtHeight:e._northSkirtHeight,westSkirtHeight:e._westSkirtHeight,boundingSphere:{center:e._boundingSphere.center,radius:e._boundingSphere.radius},horizonOcclusionPoint:e._horizonOcclusionPoint,geoExtent:{minLongitude:l,minLatitude:u,maxLongitude:c,maxLatitude:d},excavationGeoCoords:t,excavationAltitude:r};this.workerQuantizedMeshExcavation||(this.workerQuantizedMeshExcavation=new PromiseWorker(Ko(this.magoManager.config.scriptRootPath+"Worker/workerQuantizedMeshExcavationPromise.js")));var f=this.magoManager;return this.workerQuantizedMeshExcavation.postMessage(h).then(function(e){for(var t=e.result,r=e.info,i=f.scene.terrainProvider,o=i._tilingScheme.tileXYToRectangle(r.X,r.Y,r.L),n=Cesium.OrientedBoundingBox.fromRectangle(o,t.minHeight,t.maxHeight,i._tilingScheme.ellipsoid),a=0;a<9;a++)n.halfAxes[a]=3*n.halfAxes[a];return new Cesium.QuantizedMeshTerrainData({minimumHeight:t.minHeight,maximumHeight:t.maxHeight,quantizedVertices:t.uvhValues,indices:t.indices,boundingSphere:t.boundingSphere,orientedBoundingBox:n,horizonOcclusionPoint:t.horizonOcclusionPoint,westIndices:t.westIndices,southIndices:t.southIndices,eastIndices:t.eastIndices,northIndices:t.northIndices,westSkirtHeight:t.westSkirtHeight,southSkirtHeight:t.southSkirtHeight,eastSkirtHeight:t.eastSkirtHeight,northSkirtHeight:t.northSkirtHeight})})},ai.prototype.doExcavation=function(e,t,r){var i=this.magoManager;if(!this.workerQuantizedMeshExcavation){var o=this;this.workerQuantizedMeshExcavation=Ko(i.config.scriptRootPath+"Worker/workerQuantizedMeshExcavation.js"),this.workerQuantizedMeshExcavation.onmessage=function(e){var t=e.data.info,r=e.data.result,i=o.excavatedQuantizedMeshMap,n=t.L,a=t.X,s=t.Y;i[n]||(i[n]={}),i[n][a]||(i[n][a]={}),i[n][a][s]=r}}var n=e.tileIndices.X,a=e.tileIndices.Y,s=e.tileIndices.L,l=I.imageryType.CRS84,u=(e.tileIndices,Ke.getGeographicExtentOfTileLXY(s,n,a,void 0,l)),c={info:{X:n,Y:a,L:s},uValues:e._uValues,vValues:e._vValues,hValues:e._heightValues,indices:e._indices,minHeight:e._minimumHeight,maxHeight:e._maximumHeight,southIndices:e._southIndices,eastIndices:e._eastIndices,northIndices:e._northIndices,westIndices:e._westIndices,southSkirtHeight:e._southSkirtHeight,eastSkirtHeight:e._eastSkirtHeight,northSkirtHeight:e._northSkirtHeight,westSkirtHeight:e._westSkirtHeight,boundingSphere:{center:e._boundingSphere.center,radius:e._boundingSphere.radius},horizonOcclusionPoint:e._horizonOcclusionPoint,geoExtent:{minLongitude:u.minGeographicCoord.longitude,minLatitude:u.minGeographicCoord.latitude,maxLongitude:u.maxGeographicCoord.longitude,maxLatitude:u.maxGeographicCoord.latitude},excavationGeoCoords:t,excavationAltitude:r};this.workerQuantizedMeshExcavation.postMessage(c)},ai.prototype.getExcavatedQuantizedMesh=function(e,t,r){var i=this.excavatedQuantizedMeshMap;if(i[r]&&(i[r][e]&&i[r][e][t]))return i[r][e][t]},ai.prototype.test__doQuantizedSurfaceExcavation=function(e){var t=this;if(this.qMeshTestFinished)this._renderQMesh(e);else{if(!this.requestedTile){var r=55930,i=9737,o={L:15,X:r,Y:i};this.requestedTile=!0,this.qMeshPromise=e.scene.globe.terrainProvider.requestTileGeometry(r,i,15),this.qMeshPromise.then(function(e){t.testQMesh=e,t.testQMesh.tileIndices={L:15,X:r,Y:i}})}if(!this.quantizedSurfaceTest&&this.testQMesh){var n=I.imageryType.CRS84,a=(o=this.testQMesh.tileIndices,Ke.getGeographicExtentOfTileLXY(o.L,o.X,o.Y,void 0,n)),s=a.minGeographicCoord,l=a.maxGeographicCoord,u=(s.longitude,s.latitude,l.longitude,l.latitude,[]);.004,u.push(127.23582829477431,36.51155941930476),u.push(127.23583033107829,36.511375920386314),u.push(127.23600525531623,36.51139813828419),u.push(127.23604468555075,36.511551079347164),this.qMeshTest_geoLocData=on.calculateGeoLocationData(127.23582829477431,36.51155941930476,50,0,0,0,void 0);for(var c=e.modeler.getGeographicCoordsList(),d=u.length/2,h=0;h<d;h++){var f=new pe(u[2*h],u[2*h+1],50);f.makeDefaultGeoLocationData(),c.addGeoCoord(f)}if(g=e.quantizedMeshManager){g.doExcavation(this.testQMesh,u,103);g.newExcavationSet(u,103).getIntersectedTiles()}this.quantizedSurfaceTest=!0}var g;if((g=e.quantizedMeshManager)&&this.testQMesh&&!this.testQMesh_received){o=this.testQMesh.tileIndices;var p=g.getExcavatedQuantizedMesh(o.X,o.Y,o.L);p&&(this.testQMesh_received||(this.testQMesh._uValues=p.uValues,this.testQMesh._vValues=p.vValues,this.testQMesh._heightValues=p.hValues,this.testQMesh._indices=p.indices,this.testQMesh._southIndices=p.southIndices,this.testQMesh._eastIndices=p.eastIndices,this.testQMesh._northIndices=p.northIndices,this.testQMesh._westIndices=p.westIndices,this.testQMesh._minimumHeight=p.minHeight,this.testQMesh._maximumHeight=p.maxHeight,this.testQMesh_received=!0))}!this.qSurfaceMesh_dem_texture&&this.testQMesh_received&&(this.qMeshVboKeyContainer||this._makeQuantizedMeshVbo__testQSurfaceMesh(this.testQMesh),this.qMeshTestFinished=!0)}},ai.makeQuantizedMesh_virtually=function(e,t,r,i){i||(i={}),i._minimumHeight=r,i._maximumHeight=r;for(var o=(e+1)*(t+1),n=new Uint16Array(o),a=new Uint16Array(o),s=new Uint16Array(o),l=(new Uint16Array(o),1/e),u=1/t,c=0,d=0;d<t+1;d++)for(var h=0;h<e+1;h++)n[c]=Math.round(h*l*32767),a[c]=Math.round(d*u*32767),s[c]=32767,c+=1;var f=e+1,g=t+1,p=en.getIndicesTrianglesRegularNet(f,g,void 0,void 0,void 0,void 0,void 0,void 0);return i._uValues=n,i._vValues=a,i._heightValues=s,i._indices=p.indicesArray,i},ai.prototype._makeQuantizedMeshVbo__testQSurfaceMesh=function(e){if(this.qMeshVboKeyContainer)return!0;e._minimumHeight,e._maximumHeight;var t,r=e._uValues,i=e._vValues,o=e._heightValues;this.indices=e._indices,e._colors&&(t=e._colors);for(var n,a,s,l=r.length,u=new Uint16Array(3*l),c=0;c<l;c++)n=r[c],a=i[c],s=o[c],u[3*c]=n,u[3*c+1]=a,u[3*c+2]=s;var d,h=this.magoManager.vboMemoryManager;void 0===this.qMeshVboKeyContainer&&(this.qMeshVboKeyContainer=new xt),(d=this.qMeshVboKeyContainer.newVBOVertexIdxCacheKey()).setDataArrayPos(u,h),t&&d.setDataArrayCol(t,h),d.setDataArrayIdx(this.indices,h);var f,g=(m=e._southIndices).length,p=[];for(c=0;c<g;c++)n=r[f=m[c]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);for(g=(m=e._eastIndices).length,c=0;c<g;c++)n=r[f=m[c]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);for(c=(g=(m=e._northIndices).length)-1;c>=0;c--)n=r[f=m[c]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);var m;for(c=(g=(m=e._westIndices).length)-1;c>=0;c--)n=r[f=m[c]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);(d=this.qMeshVboKeyContainer.newVBOVertexIdxCacheKey()).setDataArrayPos(new Uint16Array(p),h)},ai.prototype._renderQMesh=function(e){if(this.qMeshVboKeyContainer){var t=(e=this.magoManager).vboMemoryManager,r=e.getGl(),i=e.postFxShadersManager.getShader("qMeshRenderTEST");e.postFxShadersManager.useProgram(i),i.bindUniformGenerals();var o=this.qMeshTest_geoLocData.positionHIGH,n=this.qMeshTest_geoLocData.positionLOW,a=this.qMeshTest_geoLocData.rotMatrix;r.uniform4fv(i.u_oneColor4_loc,[1,.5,.25,1]),r.uniform3fv(i.buildingPosHIGH_loc,o),r.uniform3fv(i.buildingPosLOW_loc,n),r.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,a._floatArrays);var s=(h=this.qMeshVboKeyContainer.vboCacheKeysArray[0]).vertexCount;h.vboBufferPos.bindData(i,i.attribLocations.a_pos,t),h.vboBufferCol&&h.vboBufferCol.bindData(i,i.color4_loc,t);var l=h.indicesCount;if(!h.bindDataIndice(i,e.vboMemoryManager))return!1;var u,c=l/3;if(!this.randomColorsArray){this.randomColorsArray=[];for(var d=0;d<c;d++)this.randomColorsArray.push([.5*Math.random(),.5*Math.random(),.5*Math.random(),1])}r.uniform1i(i.colorType_loc,1);for(d=0;d<c;d++)u=3*d*2,r.uniform4fv(i.u_oneColor4_loc,this.randomColorsArray[d]),r.drawElements(r.TRIANGLES,3,r.UNSIGNED_SHORT,u);var h;s=(h=this.qMeshVboKeyContainer.vboCacheKeysArray[1]).vertexCount;h.vboBufferPos.bindData(i,i.attribLocations.a_pos,t),r.drawArrays(r.TRIANGLE_STRIP,0,s)}};var ci=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.qMesh=t,this.vertexList,this.trianglesList,this.newVertexArray=[]};ci.prototype._makeQuantizedMeshFromTrianglesList=function(e,t,r){for(var i,o,n=t.getVertexCount(),a=new Uint16Array(n),s=new Uint16Array(n),l=new Uint16Array(n),u=0;u<n;u++)o=(i=t.getVertex(u)).getPosition(),a[u]=Math.round(o.x),s[u]=Math.round(o.y),l[u]=Math.round(o.z),i.idxInList=u;var c,d=[],h=e.getTrianglesCount();for(u=0;u<h;u++)(c=e.getTriangle(u)).getStatus()!==I.status.DELETED&&d.push(c);h=d.length;var f,g,p,m=new Uint16Array(3*h);for(u=0;u<h;u++)f=(c=d[u]).vertex0,g=c.vertex1,p=c.vertex2,m[3*u]=f.idxInList,m[3*u+1]=g.idxInList,m[3*u+2]=p.idxInList;return r||(r={}),r._uValues=a,r._vValues=s,r._heightValues=l,r._indices=m,r},ci.prototype.recalculateQuantizedAltitudes=function(e,t,r,i,o){for(var n=t-e,a=i-r,s=o.getVertexCount(),l=0;l<s;l++){var u=o.getVertex(l).getPosition(),c=(r+u.z/32767*a-e)/n;u.z=32767*c}},ci.prototype._makeTrianglesListFromQuantizedMesh=function(e){var t=this.qMesh,r=(t._minimumHeight,t._maximumHeight,t._uValues),i=t._vValues,o=t._heightValues;this.indices=t._indices,this.vertexList||(this.vertexList=new Si);for(var n=r.length,a=0;a<n;a++)this.vertexList.newVertex(new Jr(r[a],i[a],o[a]));var s=(l=t._southIndices).length;for(a=0;a<s;a++)u=l[a],this.vertexList.getVertex(u).bSouth=!0;for(s=(l=t._eastIndices).length,a=0;a<s;a++)u=l[a],this.vertexList.getVertex(u).bEast=!0;for(s=(l=t._northIndices).length,a=0;a<s;a++)u=l[a],this.vertexList.getVertex(u).bNorth=!0;var l,u;for(s=(l=t._westIndices).length,a=0;a<s;a++)u=l[a],this.vertexList.getVertex(u).bWest=!0;e||(e=new Ai);var c,d,h,f,g,p,m,v=this.indices.length/3;for(a=0;a<v;a++)c=this.indices[3*a],d=this.indices[3*a+1],h=this.indices[3*a+2],c!==d&&c!==h&&d!==h&&(f=this.vertexList.getVertex(c),g=this.vertexList.getVertex(d),p=this.vertexList.getVertex(h),m=e.newTriangle(f,g,p),ci._storeTriangleInVertices(m));return e},ci.prototype.getTrianglesList=function(){return this.trianglesList||(this.trianglesList=this._makeTrianglesListFromQuantizedMesh(void 0)),this.trianglesList},ci._segment2DIntersectsTriangle2D=function(e,t){var r=ci.getError(),i=new Kr,o=e.getSegment2D(0);if(o.intersectionWithSegment(t,r,i)&&o.getRelativePositionOfPoint2DReport(i,void 0).relPos===I.relativePositionPoint2DWithSegment2D.INSIDE);},ci.getQuantizedPointsArrayFromGeoCoords=function(e,t,r){return e&&0!==e.length?(r||(r=[]),r=t.getQuantizedPoints(e,r)):r},ci.getTriangleBoundingRect=function(e,t){t||(t=new _r);var r=e.vertex0.getPosition();return t.setInitXY(r.x,r.y),r=e.vertex1.getPosition(),t.addPointXY(r.x,r.y),r=e.vertex2.getPosition(),t.addPointXY(r.x,r.y),t},ci.getProjectedTriangle2D_planeXY=function(e,t){t||(t=new Mi);var r=e.vertex0.getPosition(),i=e.vertex1.getPosition(),o=e.vertex2.getPosition(),n=new Kr(r.x,r.y),a=new Kr(i.x,i.y),s=new Kr(o.x,o.y);return t.setPoints(n,a,s),t},ci._storeTriangleInVertices=function(e){var t=e.vertex0,r=e.vertex1,i=e.vertex2;t.trianglesArray||(t.trianglesArray=[]),r.trianglesArray||(r.trianglesArray=[]),i.trianglesArray||(i.trianglesArray=[]),t.trianglesArray.push(e),r.trianglesArray.push(e),i.trianglesArray.push(e)},ci._recalculateTrianglesStoredInVertices=function(e,t){for(var r=t.getVertexCount(),i=0;i<r;i++){var o=t.getVertex(i);o.trianglesArray&&(o.trianglesArray.length=0)}var n=e.getTrianglesCount();for(i=0;i<n;i++){var a=e.getTriangle(i);ci._storeTriangleInVertices(a)}},ci._testDebug_isTriangleNormal_010=function(e){e.calculatePlaneNormal();var t=e.normal.x,r=e.normal.y,i=e.normal.z;return Math.abs(t)<1e-6&&Math.abs(r)-1<1e-6&&Math.abs(i)<1e-6},ci._getCoincidentVertexFromVertexArray=function(e,t,r){r||(r=ci.getError());for(var i,o,n=e.length,a=0;a<n;a++)if((o=e[a]).getPosition().isCoincidentToPoint(t,r)){i=o;break}return i},ci._getOrNewVertex=function(e,t,r){var i=ci.getError(),o=ci._getCoincidentVertexFromVertexArray(e,r,i);return o||(o=t.newVertex(r),e.push(o)),o},ci.insertQPointIntoTriangle=function(e,t,r,i,o){var n,a,s,l,u,c,d=new Jr(e.x,e.y,e.z),h=ci._getOrNewVertex(o,i,d);l=t.vertex0,u=t.vertex1,c=t.vertex2,n=r.newTriangle(h,l,u),a=r.newTriangle(h,u,c),s=r.newTriangle(h,c,l),ci._storeTriangleInVertices(n),ci._storeTriangleInVertices(a),ci._storeTriangleInVertices(s),n.setStatus(I.status.HIGHLIGHTED),a.setStatus(I.status.HIGHLIGHTED),s.setStatus(I.status.HIGHLIGHTED),t.setStatus(I.status.DELETED)},ci._setCardinalToVertex=function(e,t){t!==I.cardinal.UNKNOWN&&(t===I.cardinal.SOUTH?e.bSouth=!0:t===I.cardinal.EAST?e.bEast=!0:t===I.cardinal.NORTH?e.bNorth=!0:t===I.cardinal.WEST&&(e.bWest=!0))},ci._getCardinalsOfTriangle=function(e,t){var r=e.vertex0,i=e.vertex1,o=e.vertex2,n=ci._getCardinalOfEdge(r,i),a=ci._getCardinalOfEdge(i,o),s=ci._getCardinalOfEdge(o,r);return t||(t=[]),n!==I.cardinal.UNKNOWN&&t.push(n),a!==I.cardinal.UNKNOWN&&t.push(a),s!==I.cardinal.UNKNOWN&&t.push(s),t},ci._getCardinalOfEdge=function(e,t){if(e.bSouth){if(t.bSouth)return I.cardinal.SOUTH}else if(e.bEast){if(t.bEast)return I.cardinal.EAST}else if(e.bNorth){if(t.bNorth)return I.cardinal.NORTH}else if(e.bWest&&t.bWest)return I.cardinal.WEST;return I.cardinal.UNKNOWN},ci.insertQPointIntoTriangleEdge=function(e,t,r,i,o,n){var a,s,l,u,c,d=new Jr(e.x,e.y,e.z),h=ci._getOrNewVertex(n,i,d);l=t.vertex0,u=t.vertex1,c=t.vertex2;var f=I.cardinal.UNKNOWN;0===o?(a=r.newTriangle(h,u,c),s=r.newTriangle(h,c,l),f=ci._getCardinalOfEdge(l,u)):1===o?(a=r.newTriangle(h,c,l),s=r.newTriangle(h,l,u),f=ci._getCardinalOfEdge(u,c)):2===o&&(a=r.newTriangle(h,l,u),s=r.newTriangle(h,u,c),f=ci._getCardinalOfEdge(c,l)),ci._setCardinalToVertex(h,f),ci._storeTriangleInVertices(a),ci._storeTriangleInVertices(s),t.setStatus(I.status.DELETED)},ci.insert2QPointIntoTriangleEdges=function(e,t,r,i,o,n,a,s){var l,u,c,d,h,f,g,p,m=new Jr(e.x,e.y,e.z),v=ci._getOrNewVertex(s,o,m),x=new Jr(t.x,t.y,t.z),_=ci._getOrNewVertex(s,o,x);d=r.vertex0,h=r.vertex1,f=r.vertex2,0===n?1===a?(l=i.newTriangle(d,v,f),u=i.newTriangle(v,_,f),c=i.newTriangle(v,h,_),g=ci._getCardinalOfEdge(d,h),p=ci._getCardinalOfEdge(h,f)):2===a&&(l=i.newTriangle(d,v,_),u=i.newTriangle(v,f,_),c=i.newTriangle(v,h,f),g=ci._getCardinalOfEdge(d,h),p=ci._getCardinalOfEdge(f,d)):1===n?0===a?(l=i.newTriangle(d,_,f),u=i.newTriangle(_,v,f),c=i.newTriangle(_,h,v),g=ci._getCardinalOfEdge(h,f),p=ci._getCardinalOfEdge(d,h)):2===a&&(l=i.newTriangle(d,h,v),u=i.newTriangle(d,v,_),c=i.newTriangle(_,v,f),g=ci._getCardinalOfEdge(h,f),p=ci._getCardinalOfEdge(f,d)):2===n&&(0===a?(l=i.newTriangle(d,_,v),u=i.newTriangle(_,f,v),c=i.newTriangle(_,h,f),g=ci._getCardinalOfEdge(f,d),p=ci._getCardinalOfEdge(d,h)):1===a&&(l=i.newTriangle(d,h,_),u=i.newTriangle(d,_,v),c=i.newTriangle(v,_,f),g=ci._getCardinalOfEdge(f,d),p=ci._getCardinalOfEdge(h,f))),ci._setCardinalToVertex(v,g),ci._setCardinalToVertex(_,p),ci._storeTriangleInVertices(l),ci._storeTriangleInVertices(u),ci._storeTriangleInVertices(c),l.setStatus(I.status.HIGHLIGHTED),u.setStatus(I.status.HIGHLIGHTED),c.setStatus(I.status.HIGHLIGHTED),r.setStatus(I.status.DELETED)},ci.insertQPointIntoTrianglesList=function(e,t,r,i){var o,n,a,s=t.getTrianglesCount(),l=ci.getError(),u=new Rr;u.set2Points(e.x,e.y,0,e.x,e.y,3e4);for(var c=0,d=0;d<s;d++)if((o=t.getTriangle(d)).getStatus()!==I.status.DELETED&&(o.bRectXY||(o.bRectXY=ci.getTriangleBoundingRect(o,void 0)),o.bRectXY.intersectsWithPointXY(e.x,e.y))){var h=(a=o.getPlane(a)).intersectionLine(u);if(h){var f=new Kr(h.x,h.y),g=(n=ci.getProjectedTriangle2D_planeXY(o,n)).getRelativePositionOfPoint2DReport(f,void 0,l);if(g.relPos===I.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT);if(g.relPos===I.relativePositionPoint2DWithTriangle2D.INSIDE){ci.insertQPointIntoTriangle(h,o,t,r,i);break}if(g.relPos===I.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE){var p=g.segmentIdx;if(ci.insertQPointIntoTriangleEdge(h,o,t,r,p,i),(c+=1)>1)break}}}},ci.insertQPointsArrayIntoTrianglesList=function(e,t,r,i){for(var o=e.length,n=0;n<o;n++)ci.insertQPointIntoTrianglesList(e[n],t,r,i)},ci.getError=function(){return.001},ci._cutTrianglesWithPlane=function(e,t,r,i,o,n){for(var a,s,l=e.getTrianglesCount(),u=ci.getError(),c=0;c<l;c++)if((a=e.getTriangle(c)).getStatus()!==I.status.DELETED){if((s=a.getIntersectionByPlaneReport(t,void 0,u))&&s.length>1){var d=s[0],h=s[1],f=d.intesectPoint,g=h.intesectPoint,p=new Kr(f.x,f.y),m=new Kr(g.x,g.y),v=r.getRelativePositionOfPoint2DReport(p,void 0,u),x=r.getRelativePositionOfPoint2DReport(m,void 0,u);if(v.relPos===I.relativePositionPoint2DWithSegment2D.OUTSIDE||x.relPos===I.relativePositionPoint2DWithSegment2D.OUTSIDE)continue;if("segmentIntersection"===d.intersectionType){if("segmentIntersection"===h.intersectionType){var _=d.intesectPoint,y=h.intesectPoint,T=d.idx,C=h.idx;ci.insert2QPointIntoTriangleEdges(_,y,a,e,i,T,C,n)}else if("startPointIntersection"===h.intersectionType){var b=d.intesectPoint,M=d.idx;ci.insertQPointIntoTriangleEdge(b,a,e,i,M,n)}}else if("startPointIntersection"===d.intersectionType)if("segmentIntersection"===h.intersectionType){b=h.intesectPoint,M=h.idx;ci.insertQPointIntoTriangleEdge(b,a,e,i,M,n)}else if("startPointIntersection"===h.intersectionType);}}},ci._getPolygon2D_fromQuantizedPoints=function(e,t){t||(t=new $r),t.point2dList||(t.point2dList=new Zr);for(var r,i=e.length,o=0;o<i;o++)r=e[o],t.point2dList.newPoint(r.x,r.y);return t},ci._isPoint2dInsideOfPolygon=function(e,t){for(var r=t.length,i=0;i<r;i++){if(0!==t[i].getRelativePostionOfPoint2DConvexPolygon(e))return!0}return!1},ci._classifyTrianglesAsInteriorOrExteriorOfPolygon=function(e,t){for(var r,i,o=e.getTrianglesCount(),n=new Kr,a=(ci.getError(),0);a<o;a++)(r=e.getTriangle(a)).getStatus()!==I.status.DELETED&&(i=r.getCenterPoint(i),n.set(i.x,i.y),ci._isPoint2dInsideOfPolygon(n,t)?r.setStatus(I.status.HIGHLIGHTED):r.setStatus(I.status.NORMAL))},ci._getAdjacentTriangles=function(e,t){for(var r,i=e.vertex0,o=e.vertex1,n=e.vertex2,a=i.trianglesArray,s=a.length,l=0;l<s;l++)if((d=a[l]).getStatus()!==I.status.DELETED&&d!==e&&d.hasVertex(i)&&d.hasVertex(o)){r=d;break}var u,c=o.trianglesArray;for(s=c.length,l=0;l<s;l++)if((d=c[l]).getStatus()!==I.status.DELETED&&d!==e&&d.hasVertex(o)&&d.hasVertex(n)){u=d;break}var d,h,f=n.trianglesArray;for(s=f.length,l=0;l<s;l++)if((d=f[l]).getStatus()!==I.status.DELETED&&d!==e&&d.hasVertex(n)&&d.hasVertex(i)){h=d;break}return t||(t=new Array(3)),t[0]=r,t[1]=u,t[2]=h,t},ci._swapTriangleVertex=function(e,t,r){return e.vertex0===t?(e.vertex0=r,0):e.vertex1===t?(e.vertex1=r,1):e.vertex2===t?(e.vertex2=r,2):-1},ci._unweldTriangles=function(e,t,r,i,o){var n,a;0===t?(n=e.vertex0,a=e.vertex1):1===t?(n=e.vertex1,a=e.vertex2):2===t&&(n=e.vertex2,a=e.vertex0);var s=n.getPosition(),l=o.newVertex(new Jr(s.x,s.y,s.z)),u=a.getPosition(),c=o.newVertex(new Jr(u.x,u.y,u.z));ci._swapTriangleVertex(r,n,l),ci._swapTriangleVertex(r,a,c)},ci._createLateralTrianglesOfTriangle=function(e,t){var r,i,o,n,a=void 0,s=void 0;return e.vertex0.twinVertex?e.vertex1.twinVertex?(r=e.vertex0,a=e.vertex0.twinVertex,i=e.vertex1,s=e.vertex1.twinVertex):e.vertex2.twinVertex&&(r=e.vertex2,a=e.vertex2.twinVertex,i=e.vertex0,s=e.vertex0.twinVertex):e.vertex1.twinVertex&&(r=e.vertex1,a=e.vertex1.twinVertex,e.vertex2.twinVertex&&(i=e.vertex2,s=e.vertex2.twinVertex)),!(!a||!s)&&(o=t.newTriangle(a,s,i),n=t.newTriangle(a,i,r),ci._storeTriangleInVertices(o),ci._storeTriangleInVertices(n),!0)},ci._getNextSkirtVertexReport=function(e,t,r){var i=e.trianglesArray;if(i){var o,n={},a=i.length;if(r===I.cardinal.SOUTH){for(var s=0;s<a;s++)if((o=i[s])!==t&&o.getStatus()!==I.status.DELETED){if(o.vertex0!==e&&o.vertex0.bSouth)return n.vertex=o.vertex0,n.triangle=o,n;if(o.vertex1!==e&&o.vertex1.bSouth)return n.vertex=o.vertex1,n.triangle=o,n;if(o.vertex2!==e&&o.vertex2.bSouth)return n.vertex=o.vertex2,n.triangle=o,n}}else if(r===I.cardinal.EAST){for(s=0;s<a;s++)if((o=i[s])!==t&&o.getStatus()!==I.status.DELETED){if(o.vertex0!==e&&o.vertex0.bEast)return n.vertex=o.vertex0,n.triangle=o,n;if(o.vertex1!==e&&o.vertex1.bEast)return n.vertex=o.vertex1,n.triangle=o,n;if(o.vertex2!==e&&o.vertex2.bEast)return n.vertex=o.vertex2,n.triangle=o,n}}else if(r===I.cardinal.NORTH){for(s=0;s<a;s++)if((o=i[s])!==t&&o.getStatus()!==I.status.DELETED){if(o.vertex0!==e&&o.vertex0.bNorth)return n.vertex=o.vertex0,n.triangle=o,n;if(o.vertex1!==e&&o.vertex1.bNorth)return n.vertex=o.vertex1,n.triangle=o,n;if(o.vertex2!==e&&o.vertex2.bNorth)return n.vertex=o.vertex2,n.triangle=o,n}}else if(r===I.cardinal.WEST)for(s=0;s<a;s++)if((o=i[s])!==t&&o.getStatus()!==I.status.DELETED){if(o.vertex0!==e&&o.vertex0.bWest)return n.vertex=o.vertex0,n.triangle=o,n;if(o.vertex1!==e&&o.vertex1.bWest)return n.vertex=o.vertex1,n.triangle=o,n;if(o.vertex2!==e&&o.vertex2.bWest)return n.vertex=o.vertex2,n.triangle=o,n}}},ci._getSkirtVertices=function(e,t,r,i){r||(r=[]),r.push(t);var o=t,n=void 0,a=!1;void 0===i&&(i=35e3);for(var s=0;!a&&s<i;){var l=ci._getNextSkirtVertexReport(o,n,e);if(l){var u=l.vertex;r.push(u),o=u,n=l.triangle}else a=!0;s++}return r},ci.recalculateSkirtIndices=function(e,t,r){for(var i,o,n,a,s=t.getVertexCount(),l=0;l<s;l++)(i=t.getVertex(l)).bSouth&&i.bWest?o=i:i.bSouth&&i.bEast?n=i:i.bNorth&&i.bEast?i:i.bNorth&&i.bWest&&(a=i);var u=I.cardinal.SOUTH,c=ci._getSkirtVertices(u,o,void 0,s);u=I.cardinal.EAST;var d=ci._getSkirtVertices(u,n,void 0,s);u=I.cardinal.NORTH;var h=ci._getSkirtVertices(u,a,void 0,s);u=I.cardinal.WEST;var f=ci._getSkirtVertices(u,o,void 0,s);t.setIdxInList();var g=[],p=c.length;for(l=0;l<p;l++)g.push(c[l].idxInList);var m=[];p=d.length;for(l=0;l<p;l++)m.push(d[l].idxInList);var v=[];p=h.length;for(l=0;l<p;l++)v.push(h[l].idxInList);var x=[];p=f.length;for(l=0;l<p;l++)x.push(f[l].idxInList);r._southIndices=new Uint16Array(g),r._eastIndices=new Uint16Array(m),r._northIndices=new Uint16Array(v),r._westIndices=new Uint16Array(x)},ci.createLateralTrianglesOfExcavation=function(e,t,r){ci._recalculateTrianglesStoredInVertices(e,t);for(var i=t.getVertexCount(),o=0;o<i;o++){var n=t.getVertex(o),a=n.trianglesArray;if(a){for(var s=[],l=[],u=a.length,c=0;c<u;c++){var d=a[c],h=d.getStatus();h===I.status.NORMAL?l.push(d):h===I.status.HIGHLIGHTED&&s.push(d)}var f=l.length,g=s.length;if(f>0&&g>0){var p=n.getPosition(),m=t.newVertex(new Jr(p.x,p.y,p.z));m.twinVertex=n,n.bSouth&&(m.bSouth=!0),n.bEast&&(m.bEast=!0),n.bNorth&&(m.bNorth=!0),n.bWest&&(m.bWest=!0);for(c=0;c<f;c++){var v=l[c];ci._swapTriangleVertex(v,n,m)}}}}ci._recalculateTrianglesStoredInVertices(e,t);var x=e.getTrianglesCount();for(o=0;o<x;o++)(_=e.getTriangle(o)).getStatus()===I.status.NORMAL&&ci._createLateralTrianglesOfTriangle(_,e);x=e.getTrianglesCount();var _,y=r;for(o=0;o<x;o++)(_=e.getTriangle(o)).getStatus()===I.status.HIGHLIGHTED&&((p=_.vertex0.getPosition()).z=y,(p=_.vertex1.getPosition()).z=y,(p=_.vertex2.getPosition()).z=y)},ci.prototype.excavation=function(e,t){for(var r=this.getTrianglesList(),i=[],o=e.length/2,n=0;n<o;n++){var a=e[2*n],s=e[2*n+1],l=new pe(a,s,0);i.push(l)}if(!this.qMesh.geoExtent){var u=I.imageryType.CRS84,c=this.qMesh.tileIndices;this.qMesh.geoExtent=Ke.getGeographicExtentOfTileLXY(c.L,c.X,c.Y,void 0,u);var d=this.qMesh._maximumHeight,h=this.qMesh._minimumHeight;this.qMesh.geoExtent.setExtentAltitudes(h,d)}var f=this.qMesh.geoExtent,g=ci.getQuantizedPointsArrayFromGeoCoords(i,f,void 0);ci.insertQPointsArrayIntoTrianglesList(g,r,this.vertexList,this.newVertexArray);var p,m,v,x,_=g.length,y=new mi;x=new Jr;var T=new We;for(n=0;n<_;n++)p=en.getNextIdx(n,_),m=g[n],v=g[p],x.set(m.x,m.y,m.z+1e4),y.setPoints(new Kr(m.x,m.y),new Kr(v.x,v.y)),T.set3Points(m.x,m.y,m.z,v.x,v.y,v.z,x.x,x.y,x.z),ci._cutTrianglesWithPlane(r,T,y,this.vertexList,void 0,this.newVertexArray);var C=ci._getPolygon2D_fromQuantizedPoints(g,void 0),b=C.calculateNormal(),M=C.tessellate(b,void 0);ci._classifyTrianglesAsInteriorOrExteriorOfPolygon(r,M);var A=qMesh.excavationAltitude;h=qMesh.minHeight,d=qMesh.maxHeight;if(A<h){var E=A,L=qMesh.maxHeight;ci.recalculateQuantizedAltitudes(E,L,h,d,vertexList),qMesh.minHeight=E,qMesh.maxHeight=L}else if(A>d){E=qMesh.minHeight;ci.recalculateQuantizedAltitudes(E,L=A,h,d,vertexList),qMesh.minHeight=E,qMesh.maxHeight=L}var w=(A-qMesh.minHeight)/(qMesh.maxHeight-qMesh.minHeight)*32767;ci.createLateralTrianglesOfExcavation(r,this.vertexList,w),ci.recalculateSkirtIndices(r,this.vertexList,this.qMesh),this._makeQuantizedMeshFromTrianglesList(r,this.vertexList,this.qMesh)};var di=function(e,t){this.center=e.center||void 0,this.halfWidth=e.halfWidth||void 0,this.halfHeight=e.halfHeight||void 0,this.quatOwner=e.quatOwner||void 0,this.renderFunc=e.renderFunc||this.defaultRender,this.numberName,this.depth=0,this.children,this.data,this.dirty=!0,this.magoManager=t,this.displayPointsArray,this.realDatasCount,this.numberName,this.quatOwner||(this.numberName=1)};di.CHILDREN_CNT=4,di.getLimitDistByRadius=function(e){return 1.5*e},di.prototype.init=function(){this.children=void 0,this.data=void 0,this.dirty=!0,this.displayPointsArray=void 0,this.realDatasCount=void 0},di.prototype.hasChildren=function(){return this.children&&Array.isArray(this.children)&&this.children.length>0},di.prototype.hasData=function(){return this.data&&Array.isArray(this.data)&&this.data.length>0},di.prototype.getDisplayPoints=function(e){if(e||(e=[]),!this.displayPointsArray||0===this.displayPointsArray.length)if(this.hasChildren()){for(var t=this.children.length,r=[],i=new Jr(0,0,0),o=0;o<t;o++)r=this.children[o].getDisplayPoints(r);var n=r.length,a=0;for(o=0;o<n;o++){var s=(d=r[o]).mass,l=new Jr(d.x,d.y,d.z);l.scale(s),i.addPoint(l),a+=s}i.scale(1/a),i.mass=a,this.displayPointsArray=[],this.displayPointsArray.push(i)}else if(this.hasData()){var u=this.data.length,c=new Jr(0,0,0);for(o=0;o<u;o++){var d=this.data[o];c.addPoint(on.geographicCoordToWorldPoint(d.x,d.y,0))}c.scale(1/u),c.mass=u,this.displayPointsArray=[],this.displayPointsArray.push(c)}return this.displayPointsArray&&e.push.apply(e,this.displayPointsArray),e},di.prototype.getQuatTreeByCamDistance=function(e,t){e||(e=[]),this.bSphereWC||this.makeBSphereWC();var r=this.bSphereWC;if(t.distToSphere(r)<di.getLimitDistByRadius(r.getRadius()))if(this.children)for(var i=this.children.length,o=0;o<i;o++){this.children[o].getQuatTreeByCamDistance(e,t)}else this.data&&e.push(this);else this.displayPointsArray&&e.push(this);return e},di.prototype.makeBSphereWC=function(){var e=this.center,t=this.center.x+this.halfWidth,r=this.center.y+this.halfHeight,i=new Kr(t,r),o=on.geographicCoordToWorldPoint(e.x,e.y,0),n=on.geographicCoordToWorldPoint(i.x,i.y,0),a=o.distToPoint(n);this.bSphereWC=new z(o.x,o.y,o.z,a)},di.prototype.setData=function(e){this.data||(this.data=[]);for(var t=e.length,r=0;r<t;r++){var i=e[r];this.pushData(i)}},di.prototype.pushData=function(e){var t=this.magoManager.sceneState.modelViewProjMatrix.transformPoint4D__test([e.x,e.y,e.z,1]),r=t[3],i=t[0]/r,o=t[1]/r;if(i<1&&i>-1&&o<1&&o>-1){var n=new Kr(i,o);n.orgPos=e,this.data.push(n)}},di.prototype.addPoint2DToChild=function(e){var t,r=e.x,i=e.y,o=this.center;t=r<o.x?i<o.y?0:3:i<o.y?1:2,this.children||this.createChildren(),this.children[t].data||(this.children[t].data=[]),this.children[t].data.push(e)},di.prototype.createChildren=function(){this.children=[];var e={};e.quatOwner=this;var t=this.center.x-this.halfWidth,r=this.center.y-this.halfHeight,i=this.center.x+this.halfWidth,o=this.center.y+this.halfHeight,n=this.center.x,a=this.center.y,s=new di(e,this.magoManager);s.depth=this.depth+1,s.numberName=10*this.numberName+1,s.setSize(t,r,n,a);var l=new di(e,this.magoManager);l.depth=this.depth+1,l.numberName=10*this.numberName+2,l.setSize(n,r,i,a);var u=new di(e,this.magoManager);u.depth=this.depth+1,u.numberName=10*this.numberName+3,u.setSize(n,a,i,o);var c=new di(e,this.magoManager);c.depth=this.depth+1,c.numberName=10*this.numberName+4,c.setSize(t,a,n,o),this.children.push(s),this.children.push(l),this.children.push(u),this.children.push(c)},di.prototype.setSize=function(e,t,r,i){var o=(r+e)/2,n=(i+t)/2;this.center=new Kr(o,n),this.halfWidth=(r-e)/2,this.halfHeight=(i-t)/2},di.prototype.makeTreeByDepth=function(e){if(!(this.depth>=e)){if(this.data){for(var t=this.data.length,r=0;r<t;r++){var i=this.data[r];this.addPoint2DToChild(i)}delete this.data}if(this.children){var o=this.children.length;for(r=0;r<o;r++)this.children[r].makeTreeByDepth(e)}this.dirty=!1}},di.prototype.extractLeaf=function(e){if(e&&Array.isArray(e)||(e=[]),this.data&&this.data.length>0&&e.push(this),this.children)for(var t=this.children.length,r=0;r<t;r++)this.children[r].extractLeaf(e);return e},di.prototype.defaultRender=function(e){if(e){this.magoManager.objMarkerManager.objectMarkerArray=[];for(var t=e.length,r=0;r<t;r++){for(var i=e[r].data,o=new G,n=i.length,a=0;a<n;a++){var s=i[a];0===a?o.init(s.orgPos):o.addPoint(s.orgPos)}var l=o.getCenterPoint();n>50&&(n=50);var u=n,c=n;u<5&&(u=5),c<5&&(c=5);var d={positionWC:new Jr(l.x,l.y,l.z),imageFilePath:"defaultBlue",imageFilePathSelected:"defaultRed",sizeX:u,sizeY:c};this.magoManager.objMarkerManager.newObjectMarker(d,this.magoManager)}}};var hi=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.centerPoint,this.width,this.height,this.minX,this.minY,this.maxX,this.maxY};hi.prototype.setCenterPosition=function(e,t){void 0===this.centerPoint&&(this.centerPoint=new Kr),this.centerPoint.set(e,t)},hi.prototype.setExtension=function(e,t,r,i){this.minX=e,this.minY=t,this.maxX=r,this.maxY=i},hi.prototype.setDimensions=function(e,t){this.width=e,this.height=t},hi.prototype.getCenterPosition=function(){return this.centerPoint},hi.prototype.getWidth=function(){return this.width},hi.prototype.getHeight=function(){return this.height},hi.prototype.getMaxPoint=function(e){return void 0===e&&(e=new Kr),e.set(this.maxX,this.maxY),e},hi.prototype.getMinPoint=function(e){return void 0===e&&(e=new Kr),e.set(this.minX,this.minY),e},hi.prototype.getPoints=function(e){if(void 0===this.centerPoint||void 0===this.width||void 0===this.height)return e;var t;void 0===e&&(e=[]);var r=this.width/2,i=this.height/2;return(t=new Kr(this.centerPoint.x-r,this.centerPoint.y-i)).pointType=1,e.push(t),(t=new Kr(this.centerPoint.x+r,this.centerPoint.y-i)).pointType=1,e.push(t),(t=new Kr(this.centerPoint.x+r,this.centerPoint.y+i)).pointType=1,e.push(t),(t=new Kr(this.centerPoint.x-r,this.centerPoint.y+i)).pointType=1,e.push(t),e};var fi=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.elemsArray=[],this.polygon=void 0,this.isOpen};fi.prototype.getElement=function(e){return 0===this.elemsArray.length?null:this.elemsArray[e]},fi.prototype.deleteObjects=function(){for(var e=0,t=this.elemsArray.length;e<t;e++)this.elemsArray[e].deleteObjects();this.elemsArray=[],void 0!==this.polygon&&this.polygon.deleteObjects(),this.polygon=void 0},fi.prototype.addElement=function(e){this.elemsArray.push(e)},fi.prototype.newElement=function(e){var t=void 0;return"ARC"===e?t=new vr:"CIRCLE"===e?t=new Cr:"POLYLINE"===e?t=new ei:"RECTANGLE"===e?t=new hi:"STAR"===e&&(t=new _i),this.elemsArray.push(t),t},fi.prototype.makePolygon=function(){return this.polygon=this.getPolygon(this.polygon),this.polygon},fi.prototype.getPolygon=function(e){var t;void 0===e&&(e=new $r),void 0===e.point2dList&&(e.point2dList=new Zr),e.point2dList.deleteObjects(),e.point2dList.pointsArray=this.getPoints(e.point2dList.pointsArray);for(var r=e.point2dList.getPointsCount(),i=0;i<r;i++)(t=e.point2dList.getPoint(i)).indexData=new Sr,t.indexData.owner=this;return e},fi.prototype.getPoints=function(e){void 0===e&&(e=[]);for(var t=0,r=this.elemsArray.length;t<r;t++)this.elemsArray[t].getPoints(e);var i=e.length;if(i>1){var o=e[0],n=e[i-1];n.pointType=1,o.isCoincidentToPoint(n,1e-7)&&((n=e.pop()).deleteObjects(),n=void 0)}return e};var gi=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.ringsArray=[],this.idxInList};gi.prototype.newRing=function(){var e=new fi;return this.ringsArray.push(e),e},gi.prototype.addRing=function(e){this.ringsArray.push(e)},gi.prototype.deleteObjects=function(){for(var e=0,t=this.ringsArray.length;e<t;e++)this.ringsArray[e].deleteObjects(),this.ringsArray[e]=void 0;this.ringsArray=[]},gi.prototype.getRingsCount=function(){return this.ringsArray.length},gi.prototype.getRingIndex=function(e){return this.ringsArray.indexOf(e)},gi.prototype.getRing=function(e){return this.ringsArray[e]},gi.getBoundingRectangle=function(e,t){var r,i;void 0===t&&(t=new _r);for(var o=0,n=e.length;o<n;o++)void 0!==(r=e[o]).polygon&&(i=r.polygon.getBoundingRectangle(i),t.addRectangle(i));return t},gi.prototype.setIdxInList=function(){for(var e=0,t=this.ringsArray.length;e<t;e++)this.ringsArray[e].idxInList=e},gi.prototype.intersectionWithSegment=function(e){if(void 0===e)return!1;for(var t=0,r=!1,i=this.getRingsCount();!r&&t<i;)this.ringsArray[t].intersectionWithSegment(e)&&(r=!0),t++;return r},gi.getSortedRingsByDistToPoint=function(e,t,r){if(void 0===e)return r;void 0===r&&(r=[]);for(var i,o,n,a,s,l,u,c=[],d=0,h=t.length;d<h;d++)o=(i=t[d]).polygon.point2dList.getNearestPointIdxToPoint(e),n=i.polygon.point2dList.getPoint(o).squareDistToPoint(e),(a={}).ring=i,a.ringIdx=d,a.pointIdx=o,a.squaredDist=n,s=0,l=c.length-1,u=gi.getIndexToInsertBySquaredDist(c,a,s,l),c.splice(u,0,a);for(d=0,h=c.length;d<h;d++)r.push(c[d]);return r},gi.getIndexToInsertBySquaredDist=function(e,t,r,i){var o=i-r;if(0===e.length)return 0;if(o<6){for(var n,a=!1,s=r;!a&&s<=i;)t.squaredDist<e[s].squaredDist&&(n=s,a=!0),s++;return a?n:i+1}var l,u,c=r+Math.floor(o/2);return e[c].squaredDist>t.squaredDist?(l=r,u=c):(l=c,u=i),this.getIndexToInsertBySquaredDist(e,t,l,u)},gi.getBinarySearchIndex=function(e,t,r){var i=0,o=e.length-1;for(r=r||function(e){return e};i<=o;){var n=Math.floor((i+o)/2);r(e[n])<r(t)?i=n+1:o=n-1}return i};var pi=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vboCacheKey;var i=!1;r&&r.createTexCoordsBuffer&&(i=r.createTexCoordsBuffer),this.init(t,i)};pi.prototype.init=function(e,t){var r=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.vboCacheKey=new vt;var i=2;if(this.vboCacheKey.setDataArrayPos(r,e,i),t){var o=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);i=2;this.vboCacheKey.setDataArrayTexCoord(o,e,i)}},pi.prototype.render=function(e,t){var r=e.getGl();this.vboCacheKey.bindDataPosition(t,e.vboMemoryManager)&&(this.vboCacheKey.vboBufferTCoord&&!this.vboCacheKey.bindDataTexCoord(t,e.vboMemoryManager)||r.drawArrays(r.TRIANGLES,0,6))};var mi=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.startPoint2d,this.endPoint2d,t&&(this.startPoint2d=t),r&&(this.endPoint2d=r)};mi.prototype.setPoints=function(e,t){void 0!==e&&(this.startPoint2d=e),void 0!==t&&(this.endPoint2d=t)},mi.prototype.getVector=function(e){if(void 0!==this.startPoint2d&&void 0!==this.endPoint2d)return void 0===e&&(e=new Kr),e=this.startPoint2d.getVectorToPoint(this.endPoint2d,e)},mi.prototype.getDirection=function(e){return void 0===e&&(e=new Kr),(e=this.getVector(e)).unitary(),e},mi.prototype.getBoundingRectangle=function(e){return void 0===e&&(e=new _r),e.setInit(this.startPoint2d),e.addPoint(this.endPoint2d),e},mi.prototype.getLine=function(e){void 0===e&&(e=new Pr);var t=this.getDirection(),r=this.startPoint2d;return e.setPointAndDir(r.x,r.y,t.x,t.y),e},mi.prototype.getSquaredLength=function(){return this.startPoint2d.squareDistToPoint(this.endPoint2d)},mi.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},mi.prototype.getRelativePositionOfPoint2DReport=function(e,t,r){if(void 0===t&&(t={}),t.relPos=I.relativePositionPoint2DWithSegment2D.UNKNOWN,!this.getBoundingRectangle().intersectsWithPoint2D(e))return t.relPos=I.relativePositionPoint2DWithSegment2D.OUTSIDE,t;if(void 0===r&&(r=1e-8),e.isCoincidentToPoint(this.startPoint2d,r))return t.relPos=I.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_START_POINT,t;if(e.isCoincidentToPoint(this.endPoint2d,r))return t.relPos=I.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_END_POINT,t;if(!this.getLine().isCoincidentPoint(e,r))return t.relPos=I.relativePositionPoint2DWithSegment2D.OUTSIDE,t;var i=this.intersectionWithPointByDistances(e,r);return i===F.INTERSECTION_POINT_A?(t.relPos=I.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_START_POINT,t):i===F.INTERSECTION_POINT_B?(t.relPos=I.relativePositionPoint2DWithSegment2D.COINCIDENT_WITH_END_POINT,t):i===F.INTERSECTION_OUTSIDE?(t.relPos=I.relativePositionPoint2DWithSegment2D.OUTSIDE,t):i===F.INTERSECTION_INSIDE?(t.relPos=I.relativePositionPoint2DWithSegment2D.INSIDE,t):t},mi.prototype.getRelativePositionOfSegment2DReport=function(e,t){var r=this.getLine(),i=e.getLine(),o=(this.startPoint2d,this.endPoint2d,e.startPoint2d),n=(e.endPoint2d,r.intersectionWithLine(i));void 0===t&&(t={}),t.relPos=I.relativePositionPoint2DWithSegment2D.UNKNOWN,n||r.isCoincidentPoint(o,1e-8)},mi.prototype.intersectionWithPointByDistances=function(e,t){if(void 0!==e){void 0===t&&(t=1e-7);var r=this.startPoint2d.distToPoint(e),i=this.endPoint2d.distToPoint(e),o=this.getLength();return r<t?F.INTERSECTION_POINT_A:i<t?F.INTERSECTION_POINT_B:r>o||i>o?F.INTERSECTION_OUTSIDE:Math.abs(r+i-o)<t?F.INTERSECTION_INSIDE:void 0}},mi.prototype.intersectionWithPoint=function(e,t){if(void 0!==e)return void 0===t&&(t=1e-7),this.getLine().isCoincidentPoint(e,t)?this.intersectionWithPointByDistances(e,t):F.INTERSECTION_OUTSIDE},mi.prototype.intersectionWithSegment=function(e,t,r){if(void 0!==e){void 0===t&&(t=1e-7);var i=this.getLine(),o=e.getLine(),n=i.intersectionWithLine(o);if(void 0!==n){var a=this.intersectionWithPointByDistances(n,t),s=e.intersectionWithPointByDistances(n,t);return a===F.INTERSECTION_OUTSIDE?F.INTERSECTION_OUTSIDE:s===F.INTERSECTION_OUTSIDE?F.INTERSECTION_OUTSIDE:(r&&r.set(n.x,n.y),F.INTERSECTION_INTERSECT)}}},mi.prototype.hasPoint=function(e){return void 0!==e&&(e===this.startPoint2d||e===this.endPoint2d)},mi.prototype.sharesPointsWithSegment=function(e){return void 0!==e&&!(!this.hasPoint(e.startPoint2d)&&!this.hasPoint(e.endPoint2d))};var vi=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.startPoint3d,this.endPoint3d,t&&(this.startPoint3d=t),r&&(this.endPoint3d=r)};vi.getVboThickLines=function(e,t,r){if(void 0===t)return r;void 0===r&&(r=new xt);for(var i,o,n,a=t.length,s=new Float32Array(4*(2*a)*4),l=0;l<a;l++)o=(i=t[l]).startPoint3d,n=i.endPoint3d,s[32*l]=o.x,s[32*l+1]=o.y,s[32*l+2]=o.z,s[32*l+3]=1,s[32*l+4]=o.x,s[32*l+5]=o.y,s[32*l+6]=o.z,s[32*l+7]=-1,s[32*l+8]=o.x,s[32*l+9]=o.y,s[32*l+10]=o.z,s[32*l+11]=2,s[32*l+12]=o.x,s[32*l+13]=o.y,s[32*l+14]=o.z,s[32*l+15]=-2,s[32*l+16]=n.x,s[32*l+17]=n.y,s[32*l+18]=n.z,s[32*l+19]=1,s[32*l+20]=n.x,s[32*l+21]=n.y,s[32*l+22]=n.z,s[32*l+23]=-1,s[32*l+24]=n.x,s[32*l+25]=n.y,s[32*l+26]=n.z,s[32*l+27]=2,s[32*l+28]=n.x,s[32*l+29]=n.y,s[32*l+30]=n.z,s[32*l+31]=-2;return r.newVBOVertexIdxCacheKey().setDataArrayPos(s,e.vboMemoryManager,4),r},vi.prototype.intersectionWithPoint=function(e,t){if(void 0===e)return!1;void 0===t&&(t=1e-7);var r=this.getLength()-this.startPoint3d.distToPoint(e)-this.endPoint3d.distToPoint(e);return Math.abs(r)<t},vi.prototype.getLine=function(e){void 0===e&&(e=new Rr);var t=this.getDirection();return e.setPointAndDir(this.startPoint3d.x,this.startPoint3d.y,this.startPoint3d.z,t.x,t.y,t.z),e},vi.prototype.setPoints=function(e,t){e&&(this.startPoint3d=e),t&&(this.endPoint3d=t)},vi.prototype.getVector=function(e){if(void 0!==this.startPoint3d&&void 0!==this.endPoint3d)return void 0===e&&(e=new Jr),e=this.startPoint3d.getVectorToPoint(this.endPoint3d,e)},vi.prototype.getDirection=function(e){return void 0===e&&(e=new Jr),(e=this.getVector(e)).unitary(),e},vi.prototype.invertSense=function(){var e=this.startPoint3d;this.startPoint3d=this.endPoint3d,this.endPoint3d=e},vi.prototype.getLength=function(){return this.startPoint3d.distToPoint(this.endPoint3d)};var xi=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.ellipsoid};xi.prototype.render=function(e,t,r,i){if(void 0!==this.ellipsoid){var o=e.getGl();o.uniform3fv(t.buildingPosHIGH_loc,this.ellipsoid.terrainPositionHIGH),o.uniform3fv(t.buildingPosLOW_loc,this.ellipsoid.terrainPositionLOW);a=Te.equatorialRadius(),s=Te.polarRadius()+n;o.uniform1f(t.equatorialRadius_loc,a),o.depthRange(1,1),o.enable(o.BLEND),this.ellipsoid.render(e,t,r,i),o.depthRange(0,1),o.disable(o.BLEND)}else{var n=15e4,a=Te.equatorialRadius()+n,s=Te.polarRadius()+n;this.ellipsoid=new eo(a,a,s);this.ellipsoid.makeMesh({bLoopColumns:!1,bTrianglesSenseCCW:!1});var l=e.vboMemoryManager;this.ellipsoid.makeVbo(l)}};var _i=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.centerPoint,this.interiorRadius,this.exteriorRadius,this.radiusCount};_i.prototype.setCenterPosition=function(e,t){void 0===this.centerPoint&&(this.centerPoint=new Kr),this.centerPoint.set(e,t)},_i.prototype.setInteriorRadius=function(e){this.interiorRadius=e},_i.prototype.setExteriorRadius=function(e){this.exteriorRadius=e},_i.prototype.setRadiusCount=function(e){this.radiusCount=e},_i.prototype.getPoints=function(e){var t,r,i,o=360/this.radiusCount*Math.PI/180,n=o/2,a=90*Math.PI/180;void 0===e&&(e=[]);for(var s=0;s<this.radiusCount;s++)r=this.centerPoint.x+this.exteriorRadius*Math.cos(a),i=this.centerPoint.y+this.exteriorRadius*Math.sin(a),(t=new Kr(r,i)).pointType=1,e.push(t),r=this.centerPoint.x+this.interiorRadius*Math.cos(a+n),i=this.centerPoint.y+this.interiorRadius*Math.sin(a+n),(t=new Kr(r,i)).pointType=1,e.push(t),a+=o;return e};var yi=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.guid="",this.buildingFolderName="",this.projectFolderName="",this.neoBuilding=void 0},Ti=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.staticModelsMap={}};Ti.prototype.addStaticModel=function(e,t){this.staticModelsMap[e]=t},Ti.prototype.getStaticModel=function(e){var t=this.staticModelsMap[e];if(void 0===t)throw new Error("StaticModel is not exist.");return t},Ti.manageStaticModel=function(e,t){var r=e.data.attributes;if(void 0!==r){var i=e.data.neoBuilding;if(void 0!==r.projectId&&void 0!==r.isReference&&!0===r.isReference){var o;if(i||i instanceof rr)return;var n=r.buildingFolderName;r.projectFolderName;var a=r.projectId,s=t.hierarchyManager.getStaticModelsManager().getStaticModel(a);i=s.neoBuilding,n=s.buildingFolderName,o=s.projectFolderName;var l=new k;l.fisrtName=n,l.name=n,l.buildingId=n,l.buildingFileName=n,l.geographicCoord=new pe(r.longitude,r.latitude,r.height),l.rotationsDegree=new Jr(r.pitch,r.roll,r.heading),l.bBox=new G,l.bBox.init(),l.bBox.expand(10),l.geographicCoordOfBBox=new pe(r.longitude,r.latitude,r.height),l.smartTileOwner,i.buildingFileName=n,i.nodeOwner=e,e.data.neoBuilding=i,e.data.buildingSeed=l,e.data.projectFolderName=o,void 0===i.metaData?(i.metaData=new Jt,void 0===i.metaData.geographicCoord&&(i.metaData.geographicCoord=new pe),void 0===i.metaData.bbox&&(i.metaData.bbox=new G),i.metaData.geographicCoord.setLonLatAlt(l.geographicCoord.longitude,l.geographicCoord.latitude,l.geographicCoord.altitude),i.metaData.bbox.copyFrom(l.bBox),i.metaData.heading=l.rotationsDegree.z,i.metaData.pitch=l.rotationsDegree.x,i.metaData.roll=l.rotationsDegree.y,void 0===i.bbox&&(i.bbox=new G),i.bbox.copyFrom(l.bBox)):(i.bbox=i.metaData.bbox,e.isNeedValidHeight(t)&&t._needValidHeightNodeArray.push(e)),i.name="test_"+n,i.buildingId=n,i.buildingType="basicBuilding",i.projectFolderName=e.data.projectFolderName}}};var Ci=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._guid=qo(),this.id,this.name,this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0,void 0!==t&&(void 0!==t.id&&(this.id=t.id),void 0!==t.name&&(this.name=t.name))};Object.defineProperties(Ci.prototype,{guid:{get:function(){return this._guid}}}),Ci.prototype.deleteObjects=function(){for(var e=0,t=this.facesArray.length;e<t;e++)this.facesArray[e].deleteObjects(),this.facesArray[e]=void 0;this.facesArray=[],this.localVertexList=void 0,this.localHedgesList=void 0},Ci.prototype.newFace=function(){var e=new Er;return this.facesArray.push(e),e},Ci.prototype.getFacesCount=function(){return this.facesArray.length},Ci.prototype.getFace=function(e){return this.facesArray[e]},Ci.prototype.setColor=function(e,t,r,i){for(var o=0,n=this.getFacesCount();o<n;o++)this.getFace(o).setColor(e,t,r,i)},Ci.prototype.addFacesArray=function(e){void 0!==e&&Array.prototype.push.apply(this.facesArray,e)},Ci.prototype.getFrontierHalfEdges=function(e){if(void 0===this.facesArray)return e;e=e||[];for(var t=0,r=this.getFacesCount();t<r;t++)e=this.getFace(t).getFrontierHalfEdges(e);return e},Ci.prototype.getAnyFrontierHalfEdge=function(){if(void 0!==this.facesArray)for(var e=[],t=0,r=this.getFacesCount();t<r;t++)if((e=this.getFace(t).getFrontierHalfEdges(e)).length>0)return e[0]},Ci.prototype.getFrontierPolyline=function(e){var t=this.getAnyFrontierHalfEdge();if(void 0!==t){void 0===e&&(e=new ti);for(var r=t.startVertex.point3d,i=(e.newPoint3d(r.x,r.y,r.z),t.getNextFrontier());void 0!==i&&i!==t;)r=i.startVertex.point3d,e.newPoint3d(r.x,r.y,r.z),i=i.getNextFrontier();return e}},Ci.prototype.getHalfEdges=function(e){e=e||[];for(var t=0,r=this.getFacesCount();t<r;t++)e=this.getFace(t).getHalfEdgesLoop(e);return e},Ci.prototype.getCopyIndependentSurface=function(e){void 0===e&&(e=new Ci),void 0===e.localVertexList&&(e.localVertexList=new Si);var t,r=e.localVertexList;e.id=this.id,e.name=this.name;for(var i,o,n,a=this.getNoRepeatedVerticesArray(),s=a.length,l=0;l<s;l++)(t=a[l]).setIdxInList(l),r.newVertex().copyFrom(t);var u=this.getFacesCount();for(l=0;l<u;l++){i=this.getFace(l),(o=e.newFace()).vertexArray=[],s=i.getVerticesCount();for(var c=0;c<s;c++)n=(t=i.getVertex(c)).getIdxInList(),o.vertexArray.push(r.getVertex(n));o.createHalfEdges([])}return e.setTwinsFaces(),e},Ci.setTwinsFacesBetweenFaceAndFacesArrays=function(e,t,r){if(void 0===t)return!1;for(var i=!1,o=0,n=t.length;o<n;o++)if(t[o].setTwinFace(e)&&(i=!0,r))return!0;return i},Ci.setTwinsFacesBetweenFacesArrays_regularQuadGrid=function(e,t){if(void 0===e||void 0===t)return!1;for(var r,i,o=0,n=e.length-1;o<n;o++)r=e[o],i=t[o+1],r.setTwinFace(i)||(r=e[o+1],i=t[o],r.setTwinFace(i)||(r=e[o],i=t[o],r.setTwinFace(i)||(r=e[o+1],i=t[o+1],r.setTwinFace(i))))},Ci.prototype.setTwinsFaces=function(){for(var e,t,r=this.facesArray.length,i=0;i<r;i++){e=this.getFace(i);for(var o=i+1;o<r;o++)i!==o&&(t=this.getFace(o),e.setTwinFace(t))}},Ci.prototype.getNoRepeatedVerticesArray=function(e){var t,r;e=e||[];for(var i=0,o=this.getFacesCount(),n=0;n<o;n++)for(var a=0,s=(t=this.getFace(n)).getVerticesCount();a<s;a++)(r=t.getVertex(a)).setIdxInList(i),i++;var l,u={};for(n=0;n<o;n++)for(a=0,s=(t=this.getFace(n)).getVerticesCount();a<s;a++)u[(r=t.getVertex(a)).getIdxInList().toString()]=r;for(var c in u)Object.prototype.hasOwnProperty.call(u,c)&&(l=u[c],e.push(l));return e},Ci.prototype.getTrianglesConvex=function(e){e=e||[];for(var t=0,r=this.getFacesCount();t<r;t++)e=this.getFace(t).getTrianglesConvex(e);return e},Ci.prototype.getTriangles=function(e){e=e||[];for(var t=0,r=this.getFacesCount();t<r;t++)e=this.getFace(t).getTessellatedTriangles(e);return e},Ci.prototype.calculateVerticesNormals=function(e){for(var t=this.getFacesCount(),r=0;r<t;r++)this.getFace(r).calculateVerticesNormals(e)},Ci.prototype.calculateTexCoordsBox=function(e){for(var t=this.getFacesCount(),r=0;r<t;r++)this.getFace(r).calculateTexCoordsBox(e)},Ci.prototype.calculateTexCoordsByHeight=function(e){for(var t=this.getFacesCount(),r=0;r<t;r++)this.getFace(r).calculateTexCoordsByHeight(e)},Ci.prototype.reverseSense=function(){for(var e=this.getFacesCount(),t=0;t<e;t++)this.getFace(t).reverseSense()},Ci.prototype.getBoundingBox=function(){return void 0===this.bbox&&(this.bbox=new G,this.localVertexList||(this.localVertexList=new Si,this.localVertexList.vertexArray=this.getNoRepeatedVerticesArray(this.vertexList.vertexArray)),this.bbox=this.localVertexList.getBoundingBox(this.bbox)),this.bbox},Ci.prototype.getBoundingSphere=function(){return this.getBoundingBox().getBoundingSphere()};var bi=function e(t,r,i){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vertex0,this.vertex1,this.vertex2,this.vtxIdx0,this.vtxIdx1,this.vtxIdx2,this.normal,void 0!==t&&(this.vertex0=t),void 0!==r&&(this.vertex1=r),void 0!==i&&(this.vertex2=i),this.hEdge,this.status=I.status.NORMAL,this.bRectXY};bi.prototype.deleteObjects=function(){this.vertex0&&(this.vertex0=void 0),this.vertex1&&(this.vertex1=void 0),this.vertex2&&(this.vertex2=void 0),this.normal&&(this.normal.deleteObjects(),this.normal=void 0),this.vtxIdx0=void 0,this.vtxIdx1=void 0,this.vtxIdx2=void 0},bi.prototype.setVertices=function(e,t,r){this.vertex0=e,this.vertex1=t,this.vertex2=r},bi.prototype.setStatus=function(e){this.status=e},bi.prototype.getStatus=function(){return this.status},bi.prototype.assignVerticesIdx=function(){void 0!==this.vertex0&&void 0!==this.vertex1&&void 0!==this.vertex2&&(this.vtxIdx0=this.vertex0.getIdxInList(),this.vtxIdx1=this.vertex1.getIdxInList(),this.vtxIdx2=this.vertex2.getIdxInList())},bi.prototype.getIndicesArray=function(e){return void 0===e&&(e=[]),void 0!==this.vtxIdx0&&void 0!==this.vtxIdx1&&void 0!==this.vtxIdx2&&(e.push(this.vtxIdx0),e.push(this.vtxIdx1),e.push(this.vtxIdx2)),e},bi.prototype.hasVertex=function(e){return this.vertex0===e||this.vertex1===e||this.vertex2===e},bi.prototype.invertSense=function(){var e=this.vertex1;this.vertex1=this.vertex2,this.vertex2=e,this.calculatePlaneNormal()},bi.prototype.calculatePlaneNormal=function(){void 0===this.normal&&(this.normal=new Jr),this.getCrossProduct(0,this.normal),this.normal.unitary()},bi.calculateNormal=function(e,t,r,i){var o=e,n=r,a=t,s=new Jr(o.x-n.x,o.y-n.y,o.z-n.z),l=new Jr(a.x-o.x,a.y-o.y,a.z-o.z);return s.unitary(),l.unitary(),void 0===i&&(i=new Jr),(i=s.crossProduct(l,i)).unitary(),i},bi.prototype.getPlaneNormal=function(){return void 0===this.normal&&this.calculatePlaneNormal(),this.normal},bi.prototype.getIntersectionByPlaneReport=function(e,t,r){var i=this.getBoundingBox().getBoundingSphere();if(e.intersectionSphere(i)!==F.INTERSECTION_INTERSECT)return t;void 0===r&&(r=1e-8);var o=[],n=this.getSegment(0),a=e.getRelativePositionOfTheSegment(n,r);if(a===I.relativePositionSegment3DWithPlane2D.INTERSECTION){var s=n.getLine(),l=e.intersectionLine(s,void 0);n.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:0,intesectPoint:l})}else if(a===I.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT){var u=n.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:0,intesectPoint:u})}var c=this.getSegment(1),d=e.getRelativePositionOfTheSegment(c,r);if(d===I.relativePositionSegment3DWithPlane2D.INTERSECTION){s=c.getLine(),l=e.intersectionLine(s,void 0);c.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:1,intesectPoint:l})}else if(d===I.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT){u=c.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:1,intesectPoint:u})}if(o.length<2){var h=this.getSegment(2),f=e.getRelativePositionOfTheSegment(h,r);if(f===I.relativePositionSegment3DWithPlane2D.INTERSECTION){s=h.getLine(),l=e.intersectionLine(s,void 0);h.intersectionWithPoint(l,r)&&o.push({intersectionType:"segmentIntersection",idx:2,intesectPoint:l})}else if(f===I.relativePositionSegment3DWithPlane2D.START_POINT_COINCIDENT){u=h.startPoint3d;o.push({intersectionType:"startPointIntersection",idx:2,intesectPoint:u})}}return t||(t=[]),Array.prototype.push.apply(t,o),t},bi.prototype.getCrossProduct=function(e,t){var r,i,o;void 0===t&&(t=new Jr),0===e?(r=this.vertex0.point3d,i=this.vertex2.point3d,o=this.vertex1.point3d):1===e?(r=this.vertex1.point3d,i=this.vertex0.point3d,o=this.vertex2.point3d):2===e&&(r=this.vertex2.point3d,i=this.vertex1.point3d,o=this.vertex0.point3d);var n=new Jr,a=new Jr;return n.set(r.x-i.x,r.y-i.y,r.z-i.z),a.set(o.x-r.x,o.y-r.y,o.z-r.z),n.unitary(),a.unitary(),t=n.crossProduct(a,t)},bi.prototype.getBoundingBox=function(e){return void 0===e&&(e=new G),e.init(this.vertex0.getPosition()),e.addPoint(this.vertex1.getPosition()),e.addPoint(this.vertex2.getPosition()),e},bi.prototype.getPlane=function(e){void 0===e&&(e=new We);var t=this.vertex0.getPosition(),r=this.getPlaneNormal();return e.setPointAndNormal(t.x,t.y,t.z,r.x,r.y,r.z),e},bi.prototype.getCenterPoint=function(e){e||(e=new Jr);var t=this.vertex0.getPosition(),r=this.vertex1.getPosition(),i=this.vertex2.getPosition();return e.set((t.x+r.x+i.x)/3,(t.y+r.y+i.y)/3,(t.z+r.z+i.z)/3),e},bi.prototype.getSegment=function(e,t){if(void 0!==e)return void 0===t&&(t=new vi),0===e?t.setPoints(this.vertex0.getPosition(),this.vertex1.getPosition()):1===e?t.setPoints(this.vertex1.getPosition(),this.vertex2.getPosition()):2===e&&t.setPoints(this.vertex2.getPosition(),this.vertex0.getPosition()),t};var Mi=function e(t,r,i){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.point2d0,this.point2d1,this.point2d2,void 0!==t&&(this.point2d0=t),void 0!==r&&(this.point2d1=r),void 0!==i&&(this.point2d2=i)};Mi.prototype.setPoints=function(e,t,r){this.point2d0=e,this.point2d1=t,this.point2d2=r},Mi.sign=function(e,t,r){return(e.x-r.x)*(t.y-r.y)-(t.x-r.x)*(e.y-r.y)},Mi.prototype.isPoint2dInside=function(e){var t=Mi.sign(e,this.point2d0,this.point2d1)<0,r=Mi.sign(e,this.point2d1,this.point2d2)<0,i=Mi.sign(e,this.point2d2,this.point2d0)<0;return t===r&&r===i},Mi.prototype.getBoundingRectangle=function(e){return void 0===e&&(e=new _r),e.setInit(this.point2d0),e.addPoint(this.point2d1),e.addPoint(this.point2d2),e},Mi.prototype.getSegment2D=function(e){var t=new mi;return 0===e?t.setPoints(this.point2d0,this.point2d1):1===e?t.setPoints(this.point2d1,this.point2d2):2===e&&t.setPoints(this.point2d2,this.point2d0),t},Mi.prototype.getIntersectedPointsByLine2D=function(e,t){},Mi.prototype.getRelativePositionOfPoint2DReport=function(e,t,r){if(void 0===r&&(r=1e-8),void 0===t&&(t={}),t.relPos=I.relativePositionPoint2DWithTriangle2D.UNKNOWN,this.point2d0.isCoincidentToPoint(e,r))return t.relPos=I.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,t.pointIdx=0,t;if(this.point2d1.isCoincidentToPoint(e,r))return t.relPos=I.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,t.pointIdx=1,t;if(this.point2d2.isCoincidentToPoint(e,r))return t.relPos=I.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_POINT,t.pointIdx=2,t;var i=0,o=this.getSegment2D(i);return o.intersectionWithPointByDistances(e,r)===F.INTERSECTION_INSIDE?(t.relPos=I.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,t.segmentIdx=i,t):(i=1,(o=this.getSegment2D(i)).intersectionWithPointByDistances(e,r)===F.INTERSECTION_INSIDE?(t.relPos=I.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,t.segmentIdx=i,t):(i=2,(o=this.getSegment2D(i)).intersectionWithPointByDistances(e,r)===F.INTERSECTION_INSIDE?(t.relPos=I.relativePositionPoint2DWithTriangle2D.COINCIDENT_WITH_TRIANGLE_EDGE,t.segmentIdx=i,t):this.isPoint2dInside(e)?(t.relPos=I.relativePositionPoint2DWithTriangle2D.INSIDE,t):(t.relPos=I.relativePositionPoint2DWithTriangle2D.OUTSIDE,t)))};var Ai=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.trianglesArray=[]};Ai.prototype.newTriangle=function(e,t,r){var i=new bi(e,t,r);return this.trianglesArray.push(i),i},Ai.prototype.addTriangle=function(e){this.trianglesArray.push(e)},Ai.prototype.deleteObjects=function(){for(var e=this.getTrianglesCount(),t=0;t<e;t++)this.trianglesArray[t].deleteObjects(),this.trianglesArray[t]=void 0;this.trianglesArray=[]},Ai.prototype.deleteTriangleByIdx=function(e){this.trianglesArray.splice(e,1)},Ai.prototype.getTrianglesCount=function(){return this.trianglesArray.length},Ai.prototype.getTriangle=function(e){return this.trianglesArray[e]},Ai.prototype.assignVerticesIdx=function(){Ai.assignVerticesIdx(this.trianglesArray)},Ai.assignVerticesIdx=function(e){if(void 0!==e)for(var t=e.length,r=(e=e,0);r<t;r++)e[r].assignVerticesIdx()},Ai.getTrianglesIndicesArray=function(e,t){var r=e.length;void 0===t&&(t=new Uint16Array(3*r));for(var i=0;i<r;i++)t[3*i]=e[i].vtxIdx0,t[3*i+1]=e[i].vtxIdx1,t[3*i+2]=e[i].vtxIdx2;return t},Ai.prototype.getNoRepeatedVerticesArray=function(e){return e=Ai.getNoRepeatedVerticesArray(this.trianglesArray,e)},Ai.getNoRepeatedVerticesArray=function(e,t){var r;void 0===t&&(t=[]);for(var i,o,n,a=0,s=e.length,l=0;l<s;l++)i=(r=e[l]).vertex0,o=r.vertex1,n=r.vertex2,i.setIdxInList(a),a++,o.setIdxInList(a),a++,n.setIdxInList(a),a++;var u,c={};for(l=0;l<s;l++)i=(r=e[l]).vertex0,o=r.vertex1,n=r.vertex2,c[i.getIdxInList().toString()]=i,c[o.getIdxInList().toString()]=o,c[n.getIdxInList().toString()]=n;for(var d in c)Object.prototype.hasOwnProperty.call(c,d)&&(u=c[d],t.push(u));return t},Ai.getVboFaceDataArray=function(e,t,r){if(void 0===t&&(t=new vt),void 0===e)return t;if(0===e.length)return t;var i=Ai.getTrianglesIndicesArray(e,void 0);return t.setDataArrayIdx(i,r),t};var Ei=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.trianglesListsArray=[]};Ei.prototype.deleteObjects=function(){for(var e=this.trianglesListsArray.length,t=0;t<e;t++)this.trianglesListsArray[t].deleteObjects(),this.trianglesListsArray[t]=void 0;this.trianglesListsArray=[]},Ei.prototype.getTrianglesList=function(e){return this.trianglesListsArray[e]},Ei.prototype.getTrianglesListsCount=function(){return this.trianglesListsArray.length},Ei.prototype.newTrianglesList=function(){var e=new Ai;return this.trianglesListsArray.push(e),e},Ei.prototype.assignVerticesIdx=function(){for(var e=this.trianglesListsArray.length,t=0;t<e;t++)this.trianglesListsArray[t].assignVerticesIdx()},Ei.prototype.getVboFaceDataArray=function(e){for(var t=[],r=this.trianglesListsArray.length,i=0;i<r;i++)t=this.trianglesListsArray[i].getTrianglesIndicesArray(t);return e.idxVboDataArray=Int16Array.from(t),e.indicesCount=e.idxVboDataArray.length,e};var Li=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.geoCoordsListPath,this.geoCoordsListProfile,this.geoLocDataManager,this.vtxProfilesList,this.vboKeysContainer,this.vboKeysContainerEdges};Li.prototype.getGeoLocationData=function(){void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var e=this.geoLocDataManager.getCurrentGeoLocationData();return void 0===e&&(e=this.geoLocDataManager.newGeoLocationData("default")),e},Li.prototype.getPathGeographicCoordsList=function(){return void 0===this.geoCoordsListPath&&(this.geoCoordsListPath=new ve,this.geoCoordsListPath.owner=this),this.geoCoordsListPath},Li.prototype.getProfileGeographicCoordsList=function(){return void 0===this.geoCoordsListProfile&&(this.geoCoordsListProfile=new ve,this.geoCoordsListProfile.owner=this),this.geoCoordsListProfile},Li.prototype.renderPoints=function(e,t,r){if(void 0===this.geoCoordsListPath)return!1;this.renderTunnel(e,t,r),this.geoCoordsListPath.renderPoints(e,t,r,!1),this.geoCoordsListPath.renderLines(e,t,r,!1,!1)},Li.prototype.renderMesh=function(e,t,r){if(void 0!==this.meshPositive){var i=e.sceneState.gl;this.getGeoLocationData().bindGeoLocationUniforms(i,t),this.meshPositive.render(e,t,r)}},Li.prototype.renderTunnel=function(e,t,r){if(void 0!==this.meshPositive){var i=e.sceneState.gl;t.useProgram(),t.resetLastBuffersBinded(),t.enableVertexAttribArray(t.position3_loc),t.disableVertexAttribArray(t.color4_loc),t.enableVertexAttribArray(t.normal3_loc),t.disableVertexAttribArray(t.texCoord2_loc),t.bindUniformGenerals(),i.uniform1i(t.colorType_loc,0),i.uniform4fv(t.oneColor4_loc,[1,1,.1,0]),i.uniform1i(t.bApplySsao_loc,!1),i.uniform1i(t.refMatrixType_loc,0),i.uniform1i(t.colorType_loc,1),i.uniform1i(t.bApplySpecularLighting_loc,!0),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.depthRange(0,1),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,t),i.colorMask(!1,!1,!1,!1),i.depthMask(!1),i.enable(i.CULL_FACE),i.enable(i.STENCIL_TEST),i.clearStencil(0);i.cullFace(i.FRONT),i.stencilFunc(i.ALWAYS,0,255),i.stencilOp(i.KEEP,i.INCR,i.KEEP),this.meshPositive.render(e,t,r,void 0),i.cullFace(i.BACK),i.stencilFunc(i.ALWAYS,0,255),i.stencilOp(i.KEEP,i.DECR,i.KEEP),this.meshPositive.render(e,t,r,void 0),i.uniform1i(t.colorType_loc,0),i.uniform4fv(t.oneColor4_loc,[222/255,184/255,135/255,1]),i.colorMask(!0,!0,!0,!0),i.depthMask(!0),i.stencilMask(0),i.stencilFunc(i.LEQUAL,1,255),i.stencilOp(i.REPLACE,i.REPLACE,i.REPLACE),i.cullFace(i.BACK),i.depthFunc(i.ALWAYS),this.meshNegative.render(e,t,r,void 0),i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.disable(i.STENCIL_TEST),i.stencilOp(i.KEEP,i.KEEP,i.KEEP),i.disable(i.POLYGON_OFFSET_FILL),i.depthRange(0,1),i.useProgram(null),i.depthMask(!0),i.stencilMask(255)}},Li.prototype.makeMesh=function(e){if(void 0===this.geoCoordsListPath||void 0===this.geoCoordsListProfile)return!1;var t=this.getGeoLocationData(),r=this.geoCoordsListPath.getGeoCoord(0).getGeoLocationDataManager().getCurrentGeoLocationData();t.copyFrom(r),void 0===this.vtxProfilesList&&(this.vtxProfilesList=new Fi);var i=this.geoCoordsListPath.getWgs84Points3D(void 0),o=t.getTransformedRelativePositionsArray(i,void 0),n=new Qr(o),a=n.getBisectionPlane(0,void 0,!1),s=new ii,l=s.newOuterRing(),u=l.newElement("CIRCLE");u.setCenterPosition(0,0),u.setRadius(15);l.getPoints([],24);var c=a.getRotationMatrix(void 0),d=n.getPoint(0);if(c.setTranslation(d.x,d.y,d.z),void 0===this.meshPositive){this.vtxProfilesList.makeLoft(s,n,!1);var h=this.vtxProfilesList.getMesh(void 0,!0,!0,!1);this.meshPositive=h.getCopySurfaceIndependentMesh(this.meshPositive);this.meshPositive.calculateVerticesNormals(!1),this.meshPositive.setColor(.1,.5,.5,1),this.meshNegative=h.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,e.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,e.vboMemoryManager)}},Li.prototype.remakeMesh=function(e){if(void 0===this.vtxProfilesList)return!1;var t=this.getGeoLocationData(),r=this.geoCoordsListPath.getGeoCoord(0).getGeoLocationDataManager().getCurrentGeoLocationData();t.copyFrom(r);var i=this.geoCoordsListPath.getWgs84Points3D(void 0),o=t.getTransformedRelativePositionsArray(i,void 0),n=new Qr(o),a=n.getBisectionPlane(0,void 0,!1),s=new ii,l=s.newOuterRing(),u=l.newElement("CIRCLE");u.setCenterPosition(0,0),u.setRadius(15);l.getPoints([],24);var c=a.getRotationMatrix(void 0),d=n.getPoint(0);if(c.setTranslation(d.x,d.y,d.z),this.meshPositive=void 0,this.meshNegative=void 0,this.vtxProfilesList.deleteObjects(),this.vtxProfilesList=new Fi,void 0===this.meshPositive){this.vtxProfilesList.makeLoft(s,n,!1);var h=this.vtxProfilesList.getMesh(void 0,!0,!0,!1);this.meshPositive=h.getCopySurfaceIndependentMesh(this.meshPositive);this.meshPositive.calculateVerticesNormals(!1),this.meshPositive.setColor(.1,.5,.5,1),this.meshNegative=h.getCopySurfaceIndependentMesh(this.meshNegative),this.meshNegative.reverseSense(),this.meshNegative.setColor(.1,.5,.5,1),this.meshNegative.getVbo(this.vboKeysContainer,e.vboMemoryManager),this.meshNegative.getVboEdges(this.vboKeysContainerEdges,e.vboMemoryManager)}};var wi=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.point3d,this.normal,this.texCoord,this.color4,this.outingHedge,this.vertexType,this.idxInList,this.point3d=t||new Jr};wi.prototype.deleteObjects=function(){this.point3d&&this.point3d.deleteObjects(),this.normal&&this.normal.deleteObjects(),this.texCoord&&this.texCoord.deleteObjects(),this.color4&&this.color4.deleteObjects(),this.point3d=void 0,this.normal=void 0,this.texCoord=void 0,this.color4=void 0},wi.prototype.getIdxInList=function(){return this.idxInList},wi.prototype.setIdxInList=function(e){this.idxInList=e},wi.prototype.setVertexType=function(e){this.vertexType=e},wi.prototype.getVertexType=function(){return this.vertexType},wi.prototype.copyFrom=function(e){e.point3d&&(void 0===this.point3d&&(this.point3d=new Jr),this.point3d.copyFrom(e.point3d)),e.normal&&(void 0===this.normal&&(this.normal=new Jr),this.normal.copyFrom(e.normal)),e.texCoord&&(void 0===this.texCoord&&(this.texCoord=new Kr),this.texCoord.copyFrom(e.texCoord)),e.color4&&(void 0===this.color4&&(this.color4=new J),this.color4.copyFrom(e.color4)),this.vertexType=e.vertexType},wi.prototype.getPosition=function(){return this.point3d},wi.prototype.setPosition=function(e,t,r){void 0===this.point3d&&(this.point3d=new Jr),this.point3d.set(e,t,r)},wi.prototype.setTexCoord=function(e,t){void 0===this.texCoord&&(this.texCoord=new Kr),this.texCoord.set(e,t)},wi.prototype.setColorRGB=function(e,t,r){void 0===this.color4&&(this.color4=new J),this.color4.setRGB(e,t,r)},wi.prototype.setColorRGBA=function(e,t,r,i){void 0===this.color4&&(this.color4=new J),this.color4.setRGBA(e,t,r,i)},wi.prototype.setNormal=function(e,t,r){void 0===this.normal&&(this.normal=new Jr),this.normal.set(e,t,r)},wi.prototype.getNormal=function(){return void 0===this.normal&&(this.normal=new Jr),this.normal},wi.prototype.getTexCoord=function(){return void 0===this.texCoord&&(this.texCoord=new Kr),this.texCoord},wi.prototype.translate=function(e,t,r){this.point3d.add(e,t,r)},wi.prototype.getOutingHEdges=function(e){return void 0===e&&(e=[]),e},wi.prototype.getOutingFrontierHEdge=function(){if(this.outingHedge.isFrontier())return this.outingHedge;for(var e=this.outingHedge.twin.next;;){if(e.isFrontier())return e;if(void 0===(e=e.twin.next)||e===this.outingHedge)return}},wi.getCoincidentVertexArray=function(e,t,r,i){if(void 0===e||void 0===t)return r;void 0===r&&(r=[]),void 0===i&&(i=1e-4);for(var o=e.getPosition(),n=t.length,a=0;a<n;a++){var s=t[a];if(e!==s){var l=s.getPosition();o.isCoincidentToPointCHEAP(l,i)&&r.push(s)}}return r},wi.getProjectedOntoPlane=function(e,t,r,i){if(void 0===e)return i;var o,n=e.getPosition(),a=new Rr(n,r);return o=t.intersectionLine(a,o),void 0===i&&(i=new wi),i.copyFrom(e),i.setPosition(o.x,o.y,o.z),i};var Si=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vertexArray=[]};Si.prototype.addVertex=function(e){this.vertexArray.push(e)},Si.prototype.addVertexArray=function(e){this.vertexArray.push.apply(this.vertexArray,e)},Si.getPrevIdx=function(e,t){var r=t.length;if(!(e<0||e>r-1))return 0===e?r-1:e-1},Si.getNextIdx=function(e,t){var r=t.length;if(!(e<0||e>r-1))return e===r-1?0:e+1},Si.getVtxSegment=function(e,t,r){var i=t[e],o=t[Si.getNextIdx(e,t)];return void 0===r?r=new Ni(i,o):r.setVertices(i,o),r},Si.getVector=function(e,t,r){var i=t[e],o=t[Si.getNextIdx(e,t)],n=i.point3d,a=o.point3d;return void 0===r?r=new Jr(a.x-n.x,a.y-n.y,a.z-n.z):r.set(a.x-n.x,a.y-n.y,a.z-n.z),r},Si.getDirection=function(e,t,r){return(r=Si.getVector(e,t,r)).unitary(),r},Si.getCrossProduct=function(e,t,r){var i=Si.getVector(e,t,void 0),o=Si.getPrevIdx(e,t);return r=Si.getVector(o,t,void 0).crossProduct(i,r)},Si.getProjectedOntoPlane=function(e,t,r,i){if(void 0===e)return i;var o,n;void 0===i&&(i=new Si);for(var a=e.getVertexCount(),s=0;s<a;s++)o=e.getVertex(s),n=i.newVertex(),n=wi.getProjectedOntoPlane(o,t,r,n);return i},Si.getProjectedPoints2DArray=function(e,t,r){if(void 0===e)return r;void 0===r&&(r=[]);var i,o=Er.getBestFacePlaneToProject(t),n=e.length;if(0===o)for(var a=0;a<n;a++){var s=(l=e[a]).point3d;(i=t.z>0?new Kr(s.x,s.y):new Kr(s.x,-s.y)).ownerVertex3d=l,r.push(i)}else if(1===o)for(a=0;a<n;a++){s=(l=e[a]).point3d;(i=t.x>0?new Kr(s.y,s.z):new Kr(-s.y,s.z)).ownerVertex3d=l,r.push(i)}else if(2===o)for(a=0;a<n;a++){var l;s=(l=e[a]).point3d;(i=t.y>0?new Kr(-s.x,s.z):new Kr(s.x,s.z)).ownerVertex3d=l,r.push(i)}return r},Si.prototype.deleteVertexByVertexType=function(e){for(var t=[],r=this.getVertexCount(),i=0;i<r;i++){var o=this.getVertex(i);o.getVertexType()!==e?t.push(o):o.deleteObjects()}this.vertexArray=t},Si.prototype.deleteObjects=function(){for(var e=0,t=this.vertexArray.length;e<t;e++)this.vertexArray[e].deleteObjects(),this.vertexArray[e]=void 0;this.vertexArray=void 0},Si.prototype.copyFrom=function(e){var t;this.deleteObjects(),this.vertexArray=[];for(var r=e.getVertexCount(),i=0;i<r;i++)t=e.getVertex(i),this.newVertex().copyFrom(t)},Si.prototype.copyFromPoint3DArray=function(e){if(void 0!==e){var t,r;this.deleteObjects(),this.vertexArray=[];for(var i=e.length,o=0;o<i;o++)t=e[o],(r=this.newVertex()).point3d=new Jr,r.point3d.set(t.x,t.y,t.z),r.point3d.pointType=t.pointType,r.vertexType=t.pointType}},Si.prototype.copyFromPoint2DList=function(e,t){var r,i;this.deleteObjects(),this.vertexArray=[],void 0===t&&(t=0);for(var o=e.getPointsCount(),n=0;n<o;n++)r=e.getPoint(n),(i=this.newVertex()).point3d=new Jr,i.point3d.set(r.x,r.y,t),i.point3d.pointType=r.pointType,i.vertexType=r.pointType},Si.prototype.setNormal=function(e,t,r){for(var i=this.getVertexCount(),o=0;o<i;o++)this.getVertex(o).setNormal(e,t,r)},Si.prototype.setColorRGBA=function(e,t,r,i){for(var o=this.getVertexCount(),n=0;n<o;n++)this.getVertex(n).setColorRGBA(e,t,r,i)},Si.prototype.newVertex=function(e){var t=new wi(e);return this.vertexArray.push(t),t},Si.prototype.getVertex=function(e){return this.vertexArray[e]},Si.prototype.getVertexCount=function(){return this.vertexArray.length},Si.prototype.getPrevIdx=function(e){return Si.getPrevIdx(e,this.vertexArray)},Si.prototype.getNextIdx=function(e){return Si.getNextIdx(e,this.vertexArray)},Si.prototype.getIdxOfVertex=function(e){for(var t=this.vertexArray.length,r=0,i=-1,o=!1;!o&&r<t;)this.vertexArray[r]===e&&(o=!0,i=r),r++;return i},Si.prototype.getVtxSegment=function(e,t){return Si.getVtxSegment(e,this.vertexArray,t)},Si.prototype.translateVertices=function(e,t,r){for(var i=0,o=this.vertexArray.length;i<o;i++)this.vertexArray[i].translate(e,t,r)},Si.prototype.getBoundingBox=function(e){void 0===e&&(e=new G);for(var t=0,r=this.vertexArray.length;t<r;t++)0===t?e.init(this.vertexArray[t].point3d):e.addPoint(this.vertexArray[t].point3d);return e},Si.prototype.transformPointsByMatrix4=function(e){for(var t=0,r=this.vertexArray.length;t<r;t++){var i=this.vertexArray[t];e.transformPoint3D(i.point3d,i.point3d)}},Si.prototype.setIdxInList=function(){Si.setIdxInList(this.vertexArray)},Si.setIdxInList=function(e){if(void 0!==e)for(var t=0,r=e.length;t<r;t++)e[t].idxInList=t},Si.prototype.getVboDataArrays=function(e,t){return Si.getVboDataArrays(this.vertexArray,e,t),e},Si.getVboDataArrays=function(e,t,r){var i,o,n,a,s,l=e.length;if(0===l)return t;void 0===t&&(t=new vt);var u,c,d,h,f=!1,g=!1,p=!1;if(void 0===(i=e[0]).point3d)return t;(void 0!==i.normal&&(f=!0),void 0!==i.color4&&(g=!0),void 0!==i.texCoord&&(p=!0),u=new Float32Array(3*l),f)&&(c=new Int8Array(3*l));g&&(d=new Uint8Array(4*l));p&&(h=new Float32Array(2*l));for(var m=0;m<l;m++)void 0!==(i=e[m]).point3d&&(o=i.point3d,u[3*m]=o.x,u[3*m+1]=o.y,u[3*m+2]=o.z,f&&(n=i.normal,c[3*m]=127*n.x,c[3*m+1]=127*n.y,c[3*m+2]=127*n.z),g&&(a=i.color4,d[4*m]=255*a.r,d[4*m+1]=255*a.g,d[4*m+2]=255*a.b,d[4*m+3]=255*a.a),p&&(s=i.texCoord,h[2*m]=s.x,h[2*m+1]=s.y));return t.setDataArrayPos(u,r),f&&t.setDataArrayNor(c,r),g&&t.setDataArrayCol(d,r),p&&t.setDataArrayTexCoord(h,r),t},Si.eliminateCoincidentVerticesOfArray=function(e,t,r){t||(t=[]),t.push(e[0]);for(var i=e[0],o=e.length,n=1;n<o;n++){var a=e[n];a.getPosition().isCoincidentToPoint(i.getPosition(),r)||(t.push(a),i=a)}return t=Si.solveUroborusOfArray(t,r)},Si.solveUroborusOfArray=function(e,t){var r=e[0],i=e[e.length-1];return r.getPosition().isCoincidentToPoint(i.getPosition(),t)&&(e.length=e.length-1),e};var Di=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vertexListsArray=[],this.totalVertexArraySC=[]};Di.prototype.deleteObjects=function(){for(var e=0,t=this.vertexListsArray.length;e<t;e++)this.vertexListsArray[e].deleteObjects(),this.vertexListsArray[e]=void 0;this.vertexListsArray=void 0},Di.prototype.newVertexList=function(){var e=new Si;return this.vertexListsArray.push(e),e},Di.prototype.getVertexList=function(e){return e>=0&&e<this.vertexListsArray.length?this.vertexListsArray[e]:void 0},Di.prototype.copyFrom=function(e){if(void 0!==e)for(var t,r=e.vertexListsArray.length,i=0;i<r;i++)t=e.getVertexList(i),this.newVertexList().copyFrom(t)},Di.prototype.getBoundingBox=function(e){void 0===e&&(e=new G),this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);for(var t=0,r=this.totalVertexArraySC.length;t<r;t++)0===t?e.init(this.totalVertexArraySC[t].point3d):e.addPoint(this.totalVertexArraySC[t].point3d);return e},Di.prototype.setVertexIdxInList=function(){for(var e=0,t=0,r=this.vertexListsArray.length;t<r;t++)for(var i=this.vertexListsArray[t],o=0,n=i.vertexArray.length;o<n;o++){i.getVertex(o).mIdxInList=e,e++}},Di.prototype.getVertexCount=function(){for(var e=0,t=0,r=this.vertexListsArray.length;t<r;t++)e+=this.vertexListsArray[t].getVertexCount();return e},Di.prototype.getTotalVertexArray=function(e){for(var t=0,r=this.vertexListsArray.length;t<r;t++)for(var i=this.vertexListsArray[t],o=0,n=i.vertexArray.length;o<n;o++){var a=i.getVertex(o);e.push(a)}return e},Di.prototype.getVBOVertexColorFloatArray=function(e){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var t=this.totalVertexArraySC.length;void 0===e&&(e=new Float32Array(6*t));for(var r=0;r<t;r++){var i=this.totalVertexArraySC[r];e[6*r]=i.point3d.x,e[6*r+1]=i.point3d.y,e[6*r+2]=i.point3d.z,e[6*r+3]=i.color4.r,e[6*r+4]=i.color4.g,e[6*r+5]=i.color4.b}return e},Di.prototype.getVBOVertexColorRGBAFloatArray=function(e){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var t=this.totalVertexArraySC.length;void 0===e&&(e=new Float32Array(7*t));for(var r=0;r<t;r++){var i=this.totalVertexArraySC[r];e[7*r]=i.point3d.x,e[7*r+1]=i.point3d.y,e[7*r+2]=i.point3d.z,e[7*r+3]=i.color4.r,e[7*r+4]=i.color4.g,e[7*r+5]=i.color4.b,e[7*r+6]=i.color4.a}return e},Di.prototype.getVBOVertexFloatArray=function(e){this.totalVertexArraySC.length=0,this.totalVertexArraySC=this.getTotalVertexArray(this.totalVertexArraySC);var t=this.totalVertexArraySC.length;void 0===e&&(e=new Float32Array(3*t));for(var r=0;r<t;r++){var i=this.totalVertexArraySC[r];e[3*r]=i.point3d.x,e[3*r+1]=i.point3d.y,e[3*r+2]=i.point3d.z}return e},Di.prototype.translateVertices=function(e,t,r){for(var i=0,o=this.vertexListsArray.length;i<o;i++)this.vertexListsArray[i].translateVertices(e,t,r)},Di.prototype.makeTTrianglesLateralSidesLOOP=function(e){for(var t,r,i,o,n,a=0,s=0,l=this.vertexListsArray.length;s<l-1;s++){t=this.vertexListsArray[s],r=this.vertexListsArray[s+1],i=e.newTTrianglesList(),a=t.vertexArray.length;for(var u=0;u<a;u++)o=i.newTTriangle(),n=i.newTTriangle(),u===a-1?(o.setVertices(t.getVertex(u),r.getVertex(u),r.getVertex(0)),n.setVertices(t.getVertex(u),r.getVertex(0),t.getVertex(0))):(o.setVertices(t.getVertex(u),r.getVertex(u),r.getVertex(u+1)),n.setVertices(t.getVertex(u),r.getVertex(u+1),t.getVertex(u+1)))}},Di.makeMatrixByDataArray=function(e,t,r,i,o,n,a){if(void 0!==e){var s,l,u,c,d,h,f,g,p,m,v,x,_;void 0===a&&(a=new Di);for(var y=0;y<n;y++){s=a.newVertexList();for(var T=0;T<o;T++)l=s.newVertex(),u=e[3*T],c=e[3*T+1],d=e[3*T+2],l.setPosition(u,c,d),t&&(h=t[3*T],f=t[3*T+1],g=t[3*T+2],l.setNormal(h,f,g)),r&&(p=r[2*T],m=r[2*T+1],l.setTexCoord(p,m)),i&&(y=i[4*T],v=i[4*T+1],x=i[4*T+2],_=i[4*T+3],l.setColorRGBA(y,v,x,_))}return a}},Di.makeFacesBetweenVertexLists=function(e,t,r,i,o){var n,a;void 0===r&&(r=[]);var s,l,u,c,d=e.vertexArray.length;void 0===o&&(o=!1);var h=[],f=[];if(o)for(var g=0;g<d;g++)h.length=0,f.length=0,g<d-1?(s=e.getVertex(g),l=e.getVertex(g+1),u=t.getVertex(g+1),c=t.getVertex(g),n=new Er,a=new Er,n.addVerticesArray([s,c,l]),a.addVerticesArray([l,c,u]),r.push(n),r.push(a)):void 0!==i&&!0===i&&(s=e.getVertex(g),l=e.getVertex(0),u=t.getVertex(0),c=t.getVertex(g),n=new Er,a=new Er,n.addVerticesArray([s,c,l]),a.addVerticesArray([l,c,u]),r.push(n),r.push(a)),a;else for(g=0;g<d;g++)h.length=0,f.length=0,g<d-1?(s=e.getVertex(g),l=e.getVertex(g+1),u=t.getVertex(g+1),c=t.getVertex(g),n=new Er,a=new Er,n.addVerticesArray([s,l,c]),a.addVerticesArray([l,u,c]),r.push(n),r.push(a)):void 0!==i&&!0===i&&(s=e.getVertex(g),l=e.getVertex(0),u=t.getVertex(0),c=t.getVertex(g),n=new Er,a=new Er,n.addVerticesArray([s,l,c]),a.addVerticesArray([l,u,c]),r.push(n),r.push(a)),a;return r},Di.makeSurface=function(e,t,r,i){var o,n;void 0===t&&(t=new Ci);for(var a=[],s=e.vertexListsArray.length,l=0;l<s-1;l++)o=e.vertexListsArray[l],n=e.vertexListsArray[l+1],a=Di.makeFacesBetweenVertexLists(o,n,a,r,i),t.addFacesArray(a),a.length=0;return t},Di.prototype.makeTrianglesLateralSides=function(e,t){for(var r,i,o,n,a,s=0,l=0,u=this.vertexListsArray.length;l<u-1;l++){r=this.vertexListsArray[l],i=this.vertexListsArray[l+1],o=e.newTrianglesList(),s=r.vertexArray.length;for(var c=0;c<s;c++)c===s-1?void 0!==t&&!0===t&&(n=o.newTriangle(),a=o.newTriangle(),n.setVertices(r.getVertex(c),i.getVertex(c),i.getVertex(0)),a.setVertices(r.getVertex(c),i.getVertex(0),r.getVertex(0))):(n=o.newTriangle(),a=o.newTriangle(),n.setVertices(r.getVertex(c),i.getVertex(c),i.getVertex(c+1)),a.setVertices(r.getVertex(c),i.getVertex(c+1),r.getVertex(c+1)))}},Di.getIndexOfArray=function(e,t,r,i){return r+i*e},Di.prototype.transformPointsByMatrix4=function(e){for(var t=0,r=this.vertexListsArray.length;t<r;t++){this.vertexListsArray[t].transformPointsByMatrix4(e)}};var Ri=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.octree_owner=t,this.octree_level=0,this.octree_number_name=0,this.subOctrees_array,this.vertexArray,this.centerPos=new Jr,this.half_dx=0,this.half_dy=0,this.half_dz=0};Ri.prototype.setBoxSize=function(e,t,r,i,o,n){this.centerPos.x=(t+e)/2,this.centerPos.y=(i+r)/2,this.centerPos.z=(n+o)/2,this.half_dx=(t-e)/2,this.half_dy=(i-r)/2,this.half_dz=(n-o)/2},Ri.prototype.new_subOctree=function(){var e=new Ri(this);return e.octree_level=this.octree_level+1,this.subOctrees_array.push(e),e},Ri.prototype.setSizesSubBoxes=function(){if(this.subOctrees_array&&this.subOctrees_array.length>0){var e=this.centerPos.x,t=this.centerPos.y,r=this.centerPos.z,i=this.centerPos.x-this.half_dx,o=this.centerPos.y-this.half_dy,n=this.centerPos.z-this.half_dz,a=this.centerPos.x+this.half_dx,s=this.centerPos.y+this.half_dy,l=this.centerPos.z+this.half_dz;this.subOctrees_array[0].setBoxSize(i,e,o,t,n,r),this.subOctrees_array[1].setBoxSize(e,a,o,t,n,r),this.subOctrees_array[2].setBoxSize(e,a,t,s,n,r),this.subOctrees_array[3].setBoxSize(i,e,t,s,n,r),this.subOctrees_array[4].setBoxSize(i,e,o,t,r,l),this.subOctrees_array[5].setBoxSize(e,a,o,t,r,l),this.subOctrees_array[6].setBoxSize(e,a,t,s,r,l),this.subOctrees_array[7].setBoxSize(i,e,t,s,r,l);for(var u=0;u<8;u++)this.subOctrees_array[u].setSizesSubBoxes()}},Ri.prototype.createChildren=function(){this.subOctrees_array=[];for(var e=0;e<8;e++){this.new_subOctree().octree_number_name=10*this.octree_number_name+(e+1)}this.setSizesSubBoxes()},Ri.prototype.makeTreeByMinSize=function(e){if(void 0!==this.vertexArray&&0!==this.vertexArray.length&&2*Math.min.apply(null,[this.half_dx,this.half_dy,this.half_dz])>e){this.createChildren();for(var t=this.vertexArray.length,r=0;r<t;r++)this.insertVertexToChildren(this.vertexArray[r]);this.vertexArray.length=0;for(r=0;r<8;r++)this.subOctrees_array[r].makeTreeByMinSize(e)}},Ri.prototype.extractOctreesWithData=function(e){if(void 0===e&&(e=[]),void 0!==this.vertexArray&&this.vertexArray.length>0&&e.push(this),this.subOctrees_array)for(var t=this.subOctrees_array.length,r=0;r<t;r++)this.subOctrees_array[r].extractOctreesWithData(e);return e},Ri.prototype.insertVertexToChildren=function(e){var t=-1,r=e.getPosition();t=r.x<this.centerPos.x?r.y<this.centerPos.y?r.z<this.centerPos.z?0:4:r.z<this.centerPos.z?3:7:r.y<this.centerPos.y?r.z<this.centerPos.z?2:6:r.z<this.centerPos.z?1:5;var i=this.subOctrees_array[t];void 0===i.vertexArray&&(i.vertexArray=[]),e.vertexIndexingOctree=i,i.vertexArray.push(e)};var Pi=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t},Ii=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.outerVtxRing,this.innerVtxRingsList};Ii.prototype.deleteObjects=function(){void 0!==this.outerVtxRing&&(this.outerVtxRing.deleteObjects(),this.outerVtxRing=void 0),void 0!==this.innerVtxRingsList&&(this.innerVtxRingsList.deleteObjects(),this.innerVtxRingsList=void 0)},Ii.prototype.getInnerVtxRingsCount=function(){return void 0===this.innerVtxRingsList||0===this.innerVtxRingsList.getRingsCount?0:this.innerVtxRingsList.getVtxRingsCount()},Ii.prototype.getInnerVtxRing=function(e){if(void 0!==this.innerVtxRingsList&&0!==this.innerVtxRingsList.getRingsCount)return this.innerVtxRingsList.getVtxRing(e)},Ii.prototype.calculateConvexFacesIndicesData=function(e){return e=this.getProjectedProfile2D(void 0).getConvexFacesIndicesData(e)},Ii.prototype.setVerticesIdxInList=function(){this.outerVtxRing&&this.outerVtxRing.vertexList&&this.outerVtxRing.vertexList.setIdxInList(),this.innerVtxRingsList&&this.innerVtxRingsList.setVerticesIdxInList()},Ii.prototype.copyFrom=function(e){e.outerVtxRing&&(void 0===this.outerVtxRing&&(this.outerVtxRing=new Oi),this.outerVtxRing.copyFrom(e.outerVtxRing)),e.innerVtxRingsList&&(void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new Bi),this.innerVtxRingsList.copyFrom(e.innerVtxRingsList))},Ii.prototype.translate=function(e,t,r){void 0!==this.outerVtxRing&&this.outerVtxRing.translate(e,t,r),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.translate(e,t,r)},Ii.prototype.rotate=function(e,t,r,i){var o=new Ne,n=new Xe,a=new Jr(t,r,i);a.unitary(),n.rotationAngDeg(e,a.x,a.y,a.z),o.rotationByQuaternion(n),this.transformPointsByMatrix4(o)},Ii.prototype.transformPointsByMatrix4=function(e){void 0!==this.outerVtxRing&&this.outerVtxRing.transformPointsByMatrix4(e),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.transformPointsByMatrix4(e)},Ii.prototype.getProjectedProfile2D=function(e){if(void 0===this.outerVtxRing)return e;var t=this.outerVtxRing.calculatePlaneNormal(void 0);if(void 0===t)return e;if(void 0===e&&(e=new ii),e.outerRing=this.outerVtxRing.getProjectedPolyLineBasedRing2D(e.outerRing,t),void 0!==this.innerVtxRingsList){var r,i=this.innerVtxRingsList.getVtxRingsCount();i>0&&(r=e.getInnerRingsList());for(var o=0;o<i;o++){var n=this.innerVtxRingsList.getVtxRing(o).getProjectedPolyLineBasedRing2D(void 0,t);r.addRing(n)}}return e},Ii.prototype.makeByPoints3DArray=function(e,t,r){var i;void 0!==e&&(r&&r.outerVtxRingOptions&&(i=r.outerVtxRingOptions),void 0===this.outerVtxRing&&(this.outerVtxRing=new Oi),this.outerVtxRing.makeByPoints3DArray(e,i))},Ii.prototype.setColorRGBAVertices=function(e,t,r,i){void 0!==this.outerVtxRing&&this.outerVtxRing.setColorRGBAVertices(e,t,r,i),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.setColorRGBAVertices(e,t,r,i)},Ii.prototype.updateByPoints3DArray=function(e,t){void 0!==e&&void 0!==this.outerVtxRing&&this.outerVtxRing.updateByPoints3DArray(e)},Ii.prototype.makeByProfile2D=function(e){if(void 0!==e&&void 0!==e.outerRing){var t=e.outerRing;void 0===t.polygon&&t.makePolygon(),void 0===this.outerVtxRing&&(this.outerVtxRing=new Oi);var r=t.polygon.point2dList;if(this.outerVtxRing.makeByPoint2DList(r,0),void 0!==e.innerRingsList){var i=e.innerRingsList,o=i.getRingsCount();if(0!==o){var n;void 0===this.innerVtxRingsList&&(this.innerVtxRingsList=new Bi);for(var a=0;a<o;a++)void 0===(n=i.getRing(a)).polygon&&n.makePolygon(),r=n.polygon.point2dList,this.innerVtxRingsList.newVtxRing().makeByPoint2DList(r,0)}}}},Ii.prototype.getAllVertices=function(e){return void 0!==this.outerVtxRing&&this.outerVtxRing.getAllVertices(e),void 0!==this.innerVtxRingsList&&this.innerVtxRingsList.getAllVertices(e),e},Ii.getProjectedOntoPlane=function(e,t,r,i){return void 0===e.outerVtxRing?i:(void 0===i&&(i=new Ii),i.outerVtxRing=Oi.getProjectedOntoPlane(e.outerVtxRing,t,r,i.outerVtxRing),void 0!==e.innerVtxRingsList&&(i.innerVtxRingsList=Bi.getProjectedOntoPlane(e.innerVtxRingsList,t,r,i.innerVtxRingsList)),i)};var Fi=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vtxProfilesArray,this.convexFacesIndicesData};Fi.prototype.deleteObjects=function(){if(void 0!==this.vtxProfilesArray){for(var e=this.vtxProfilesArray.length,t=0;t<e;t++)this.vtxProfilesArray[t].deleteObjects(),this.vtxProfilesArray[t]=void 0;this.vtxProfilesArray=void 0}void 0!==this.convexFacesIndicesData&&(this.convexFacesIndicesData=void 0)},Fi.getLateralFaces=function(e,t,r,i,o){void 0===r&&(r=[]);var n,a,s,l,u,c,d,h,f=i.getHalfEdgesList(),g=[];n=o.strIdx;for(;n!==o.endIdx;)a=e.vertexList.getNextIdx(n),d=new Er,r.push(d),d.vertexArray=[],s=e.vertexList.getVertex(n),l=e.vertexList.getVertex(a),u=t.vertexList.getVertex(a),c=t.vertexList.getVertex(n),d.vertexArray=Si.eliminateCoincidentVerticesOfArray([s,l,u,c],d.vertexArray,1e-6),g.length=0,g=d.createHalfEdges(g),f.addHalfEdgesArray(g),void 0!==h&&d.setTwinFace(h),h=d,n=a;return r},Fi.prototype.addVtxProfile=function(e){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]),this.vtxProfilesArray.push(e)},Fi.prototype.newVtxProfile=function(){void 0===this.vtxProfilesArray&&(this.vtxProfilesArray=[]);var e=new Ii;return this.vtxProfilesArray.push(e),e},Fi.prototype.getVtxProfilesCount=function(){return void 0===this.vtxProfilesArray?0:this.vtxProfilesArray.length},Fi.prototype.getVtxProfile=function(e){if(void 0!==this.vtxProfilesArray)return this.vtxProfilesArray[e]},Fi.prototype.getAllVertices=function(e){void 0===e&&(e=[]);for(var t=this.getVtxProfilesCount(),r=0;r<t;r++)e=this.getVtxProfile(r).getAllVertices(e);return e},Fi.prototype.getMesh=function(e,t,r,i){if(void 0===this.vtxProfilesArray)return e;void 0===i&&(i=!1),!0===i&&(t=!1,r=!1),void 0===e&&(e=new kr),void 0===e.vertexList&&(e.vertexList=new Si);var o,n,a={},s=this.getVtxProfilesCount();if(s<2){a.name="surface",n=this.getVtxProfile(0);var l=e.newSurface(a);return l=Fi.getTransversalSurface(n,this.convexFacesIndicesData,l),e}e.vertexList.vertexArray=this.getAllVertices(e.vertexList.vertexArray);var u,c,d,h,f,g,p=(o=this.getVtxProfile(0)).outerVtxRing,m=[],v=p.elemsIndexRangesArray.length;a.name="outerLateral";for(var x=0;x<v;x++){h=e.newSurface(a),f=void 0,u=p.getElementIndexRange(x);for(var _=0;_<s;_++){if(_===s-1){if(!i)break;o=this.getVtxProfile(_),n=this.getVtxProfile(0)}else o=this.getVtxProfile(_),n=this.getVtxProfile(_+1);if(c=o.outerVtxRing,d=n.outerVtxRing,m.length=0,m=Fi.getLateralFaces(c,d,m,e,u),h.addFacesArray(m),void 0!==f&&f.length>0)for(var y=m.length,T=0;T<y;T++)b=m[T],M=f[T],b.setTwinFace(M);f=[],Array.prototype.push.apply(f,m)}}a.name="innerLateral";var C=o.getInnerVtxRingsCount();for(T=0;T<C;T++){v=(g=o.getInnerVtxRing(T)).elemsIndexRangesArray.length;for(x=0;x<v;x++){h=e.newSurface(a),f=void 0,u=g.getElementIndexRange(x);for(_=0;_<s;_++){if(_===s-1){if(!i)break;o=this.getVtxProfile(_),n=this.getVtxProfile(0)}else o=this.getVtxProfile(_),n=this.getVtxProfile(_+1);if(c=o.getInnerVtxRing(T),d=n.getInnerVtxRing(T),m.length=0,m=Fi.getLateralFaces(c,d,m,e,u),h.addFacesArray(m),void 0!==f&&f.length>0){y=m.length;for(var b,M,A=0;A<y;A++)b=m[A],M=f[A],b.setTwinFace(M)}f=[],Array.prototype.push.apply(f,m)}}}if(void 0===this.convexFacesIndicesData){var E=this.getVtxProfile(0);this.convexFacesIndicesData=E.calculateConvexFacesIndicesData(this.convexFacesIndicesData)}return void 0!==r&&!0!==r||(a.name="top",n=this.getVtxProfile(s-1),l=e.newSurface(a),l=Fi.getTransversalSurface(n,this.convexFacesIndicesData,l)),void 0!==t&&!0!==t||(a.name="bottom",o=this.getVtxProfile(0),l=e.newSurface(a),(l=Fi.getTransversalSurface(o,this.convexFacesIndicesData,l)).reverseSense()),e},Fi.getTransversalSurface=function(e,t,r){var i,o,n,a,s,l,u;(void 0===r&&(r=new Ci),void 0===t)&&(t=e.getProjectedProfile2D(void 0).getConvexFacesIndicesData(t));for(var c=t.length,d=0;d<c;d++){(l=r.newFace()).vertexArray=[],s=(i=t[d]).length;for(var h=0;h<s;h++){n=(o=i[h]).ownerIdx,a=o.idxInList,u=(-1===n?e.outerVtxRing:e.innerVtxRingsList.getVtxRing(n)).vertexList.getVertex(a),l.vertexArray.push(u);l.createHalfEdges([])}}return r},Fi.prototype.makeLoft=function(e,t,r){this.convexFacesIndicesData=e.getConvexFacesIndicesData(void 0);var i=new Ii;i.makeByProfile2D(e),void 0===r&&(r=!1);var o,n,a=t.getBisectionPlane(0,void 0,r),s=t.getPoint(0),l=a.getRotationMatrix(void 0);l.setTranslation(s.x,s.y,s.z),i.transformPointsByMatrix4(l);for(var u=t.getPointsCount(),c=0;c<u;c++){t.getPoint(c),o=t.getBisectionPlane(c,void 0,r),n=(0===c?t.getSegment3D(c,void 0,r):t.getSegment3D(c-1,void 0,r)).getDirection(void 0);var d=Ii.getProjectedOntoPlane(i,o,n,void 0);this.addVtxProfile(d),i=d}};var Oi=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vertexList,this.elemsIndexRangesArray,this.isOpen};Oi.prototype.deleteObjects=function(){void 0!==this.vertexList&&(this.vertexList.deleteObjects(),this.vertexList=void 0),void 0!==this.elemsIndexRangesArray&&this.deleteElementIndexRanges()},Oi.prototype.deleteElementIndexRanges=function(){if(void 0!==this.elemsIndexRangesArray){for(var e=this.elemsIndexRangesArray.length,t=0;t<e;t++)this.elemsIndexRangesArray[t].deleteObjects(),this.elemsIndexRangesArray[t]=void 0;this.elemsIndexRangesArray=void 0}},Oi.prototype.newElementIndexRange=function(){void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);var e=new Dr;return this.elemsIndexRangesArray.push(e),e},Oi.prototype.getElementIndexRange=function(e){if(void 0!==this.elemsIndexRangesArray)return this.elemsIndexRangesArray[e]},Oi.prototype.getAllVertices=function(e){return void 0===this.vertexList||void 0===this.vertexList.vertexArray?e:(void 0===e&&(e=[]),e.push.apply(e,this.vertexList.vertexArray),e)},Oi.prototype.copyFrom=function(e){if(void 0!==e.vertexList&&(void 0===this.vertexList&&(this.vertexList=new Si),this.vertexList.copyFrom(e.vertexList)),void 0!==e.elemsIndexRangesArray){var t;void 0===this.elemsIndexRangesArray&&(this.elemsIndexRangesArray=[]);for(var r=e.elemsIndexRangesArray.length,i=0;i<r;i++)t=e.elemsIndexRangesArray[i],this.newElementIndexRange().copyFrom(t)}this.isOpen=e.isOpen},Oi.prototype.translate=function(e,t,r){void 0!==this.vertexList&&this.vertexList.translateVertices(e,t,r)},Oi.prototype.transformPointsByMatrix4=function(e){void 0!==this.vertexList&&this.vertexList.transformPointsByMatrix4(e)},Oi.prototype.getProjectedPolyLineBasedRing2D=function(e,t){if(void 0===this.vertexList)return e;void 0===e&&(e=new fi);var r=[];return r=Si.getProjectedPoints2DArray(this.vertexList.vertexArray,t,r),e.newElement("POLYLINE").point2dArray=r,e},Oi.prototype.makeByPoints3DArray=function(e,t){if(void 0!==e){t&&t.isOpen&&this.setIsOpen(t.isOpen),void 0===this.vertexList&&(this.vertexList=new Si),this.vertexList.copyFromPoint3DArray(e);for(var r=this.vertexList.getVertexCount(),i=0;i<r;i++)this.vertexList.getVertex(i).setVertexType(1);this.calculateElementsIndicesRange()}},Oi.prototype.setColorRGBAVertices=function(e,t,r,i){this.vertexList.setColorRGBA(e,t,r,i)},Oi.prototype.updateByPoints3DArray=function(e){if(void 0!==e){var t,r;void 0===this.vertexList&&(this.vertexList=new Si);for(var i=e.length,o=0;o<i;o++)r=e[o],void 0===(t=this.vertexList.getVertex(o))&&(t=this.vertexList.newVertex()),void 0===t.point3d&&(t.point3d=new Jr),t.point3d.set(r.x,r.y,r.z);this.vertexList.copyFromPoint3DArray(e)}},Oi.prototype.makeByPoint2DList=function(e,t){void 0!==e&&(void 0===t&&(t=0),void 0===this.vertexList&&(this.vertexList=new Si),this.vertexList.copyFromPoint2DList(e,t),this.calculateElementsIndicesRange())},Oi.prototype.calculatePlaneNormal=function(e){return Er.calculatePlaneNormal(this.vertexList.vertexArray,void 0)},Oi.prototype.setIsOpen=function(e){this.isOpen=e},Oi.prototype.calculateElementsIndicesRange=function(){if(void 0===this.vertexList)return!1;this.deleteElementIndexRanges(),this.elemsIndexRangesArray=[];for(var e,t=void 0,r=this.vertexList.getVertexCount(),i=0;i<r;i++)(e=this.vertexList.getVertex(i).vertexType)&&1===e&&(void 0!==t&&(t.endIdx=i),i!==r&&(i===r-1&&this.isOpen?t=void 0:(t=this.newElementIndexRange()).strIdx=i));void 0!==t&&(t.endIdx=0)},Oi.getProjectedOntoPlane=function(e,t,r,i){return void 0===e.vertexList?resultRing2d:(void 0===i&&(i=new Oi),i.vertexList=Si.getProjectedOntoPlane(e.vertexList,t,r,i.vertexList),i.calculateElementsIndicesRange(),i)};var Bi=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.vtxRingsArray};Bi.prototype.deleteObjects=function(){if(void 0!==this.vtxRingsArray){for(var e=this.vtxRingsArray.length,t=0;t<e;t++)this.vtxRingsArray[t].deleteObjects(),this.vtxRingsArray[t]=void 0;this.vtxRingsArray=void 0}},Bi.prototype.setColorRGBAVertices=function(e,t,r,i){if(void 0!==this.vtxRingsArray)for(var o=this.vtxRingsArray.length,n=0;n<o;n++)this.vtxRingsArray[n].setColorRGBAVertices(e,t,r,i)},Bi.prototype.getVtxRingsCount=function(){return void 0===this.vtxRingsArray?0:this.vtxRingsArray.length},Bi.prototype.getVtxRing=function(e){if(void 0!==this.vtxRingsArray)return this.vtxRingsArray[e]},Bi.prototype.newVtxRing=function(){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);var e=new Oi;return this.vtxRingsArray.push(e),e},Bi.prototype.copyFrom=function(e){if(void 0!==e){void 0===this.vtxRingsArray&&(this.vtxRingsArray=[]);for(var t=e.getVtxRingsCount(),r=0;r<t;r++)this.newVtxRing().copyFrom(e.getVtxRing(r))}},Bi.prototype.translate=function(e,t,r){for(var i=this.getVtxRingsCount(),o=0;o<i;o++)this.vtxRingsArray[o].translate(e,t,r)},Bi.prototype.transformPointsByMatrix4=function(e){for(var t=this.getVtxRingsCount(),r=0;r<t;r++)this.vtxRingsArray[r].transformPointsByMatrix4(e)},Bi.prototype.getAllVertices=function(e){if(void 0===this.vtxRingsArray)return e;for(var t=this.getVtxRingsCount(),r=0;r<t;r++)this.vtxRingsArray[r].getAllVertices(e);return e},Bi.prototype.setVerticesIdxInList=function(){if(void 0!==this.vtxRingsArray)for(var e=this.getVtxRingsCount(),t=0;t<e;t++)this.vtxRingsArray[t].setVerticesIdxInList()},Bi.getProjectedOntoPlane=function(e,t,r,i){if(void 0===e)return i;var o,n;void 0===i&&(i=new Bi);for(var a=e.getVtxRingsCount(),s=0;s<a;s++)o=e.getVtxRing(s),n=i.newVtxRing(),n=Oi.getProjectedOntoPlane(o,t,r,n);return i};var Ni=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.startVertex,this.endVertex,t&&(this.startVertex=t),r&&(this.endVertex=r)};Ni.prototype.setVertices=function(e,t){this.startVertex=e,this.endVertex=t},Ni.prototype.getDirection=function(e){if(void 0!==(e=this.getVector()))return e.unitary(),e},Ni.prototype.getVector=function(e){if(void 0!==this.startVertex&&void 0!==this.endVertex){var t=this.startVertex.point3d,r=this.endVertex.point3d;if(void 0!==t&&void 0!==r)return e=t.getVectorToPoint(r,e)}},Ni.prototype.getLine=function(e){void 0===e&&(e=new Rr);var t=this.getDirection(),r=this.startVertex.point3d;return e.setPointAndDir(r.x,r.y,r.z,t.x,t.y,t.z),e},Ni.prototype.getSquaredLength=function(){return this.startVertex.point3d.squareDistToPoint(this.endVertex.point3d)},Ni.prototype.getLength=function(){return Math.sqrt(this.getSquaredLength())},Ni.prototype.intersectionWithPoint=function(e,t){var r=this.getLine();if(void 0===t&&(t=1e-7),!r.isCoincidentPoint(e,t))return F.INTERSECTION_OUTSIDE;var i=this.startVertex.point3d.distToPoint(e),o=this.endVertex.point3d.distToPoint(e),n=this.getLength();return i<t?F.INTERSECTION_POINT_A:o<t?F.INTERSECTION_POINT_B:i>n||o>n?F.INTERSECTION_OUTSIDE:Math.abs(i+o-n)<t?F.INTERSECTION_INSIDE:void 0};var Ui=function(e,t){this.handle=e,this.message=t||Gi};Ui.prototype.init=function(e){var t=this.handle;this.handle.use(i18nextXHRBackend).use(i18nextBrowserLanguageDetector).init({debug:!1,detection:{lookupQuerystring:"lang",lookupCookie:"i18nextLang",lookupLocalStorage:"i18nextLang"},fallbackLng:"en",resources:this.message,load:"languageOnly",ns:["common"],defaultNS:"common",keySeparator:".",nsSeparator:":",pluralSeparator:"_",contextSeparator:"_"},function(r,i){console.log("detected user language: "+t.language),console.log("loaded languages: "+t.languages.join(", ")),t.changeLanguage(t.languages[0]),e(r,i)})},Ui.prototype.getHandle=function(){return this.handle},Ui.prototype.getMessage=function(){return this.message};var Gi={en:{common:{welcome:"Welcome",error:{title:"Error",construct:{create:"This object should be created using new."}}}},ko:{common:{welcome:"환영합니다.",error:{title:"오류",construct:{create:"이 객체는 new 를 사용하여 생성해야 합니다."}}}}},zi=function(){this.serverInfo={}};zi.prototype.setServerInfo=function(e){this.serverInfo=e},zi.prototype.getDataUrl=function(){return this.serverInfo.dataUrl},zi.prototype.getDataWorkspace=function(){return this.serverInfo.dataWorkspace},zi.prototype.getDataRequestUrl=function(){return this.getDataUrl()+"/"+this.getDataWorkspace()},zi.prototype.getWmsVersion=function(){return this.serverInfo.wmsVersion};var Hi=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._oceanFluxManager=void 0,this._geoJsonFilePath=t.geoJsonFilePath,this._geoJsonFile=void 0,this._geoJsonFileLoadState=I.fileLoadState.READY,this._oceanFluxMapTexture=void 0,this.oceanFluxMapFolderPath=void 0,this.gl=void 0,this.streamLinesArray=void 0,this._animationState=1,this._particlesGenerationType=1,this._animationSpeed=1,this.framebuffer=void 0,t&&(t.oceanFluxManager&&(this._oceanFluxManager=t.oceanFluxManager),t.oceanFluxMapFolderPath&&(this.oceanFluxMapFolderPath=t.oceanFluxMapFolderPath),t.gl&&(this.gl=t.gl))};Hi.prototype.setGeoJson=function(e){e&&(this._geoJsonFile=e,this._geoJsonFileLoadState=I.fileLoadState.LOADING_FINISHED)},Hi.prototype.loadGeoJson=function(){if(this._geoJsonFileLoadState===I.fileLoadState.READY){this._geoJsonFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._geoJsonFilePath,void 0,void 0,"json","GET").done(function(t){e.setGeoJson(t)})}},Hi.prototype._prepareGeoJson=function(){return this._geoJsonFileLoadState===I.fileLoadState.READY?(this.loadGeoJson(),!1):this._geoJsonFileLoadState===I.fileLoadState.LOADING_FINISHED},Hi.prototype._prepareOceanFluxMapTexture=function(){if(void 0===this._oceanFluxMapTexture&&(this._oceanFluxMapTexture=new it,this._oceanFluxMapTexture.texId=this.gl.createTexture()),this._oceanFluxMapTexture.fileLoadState===I.fileLoadState.READY){if(!this.oceanFluxMapFileName){if(!this._geoJsonFile)return!1;this.oceanFluxMapFileName=this._geoJsonFile.properties.image.uri}var e;return e=this.oceanFluxMapFolderPath&&0!==this.oceanFluxMapFolderPath.length?this.oceanFluxMapFolderPath+"/"+this.oceanFluxMapFileName:this._geoJsonFile.properties.image.serviceUri,hr.loadImage(this.gl,e,this._oceanFluxMapTexture),!1}return this._oceanFluxMapTexture.fileLoadState===I.fileLoadState.BINDING_FINISHED},Hi.prototype.prepareLayer=function(){return!!this._prepareGeoJson()&&!!this._prepareOceanFluxMapTexture()},Hi.prototype.getGeographicExtent=function(){if(!this.geoExtent){var e=this._geoJsonFile.bbox[0],t=this._geoJsonFile.bbox[1],r=this._geoJsonFile.bbox[2],i=this._geoJsonFile.bbox[3],o=this._geoJsonFile.bbox[4],n=this._geoJsonFile.bbox[5];void 0!==this._geoJsonFile.height_above_ground&&(r=this._geoJsonFile.height_above_ground[0]),n=r,this.geoExtent=new xe(e,t,r,i,o,n)}return this.geoExtent},Hi.prototype.getVelocityVector2d=function(e,t,r,i){var o=this._oceanFluxMapTexture.imageWidth,n=this._oceanFluxMapTexture.imageHeight;if(e<0&&(e=0),t<0&&(t=0),!this.windVelocityMap){var a=i.getGl();if(void 0===this.framebuffer&&(this.framebuffer=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,this.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this._oceanFluxMapTexture.texId,0),a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE){var s=o*n;this.windVelocityMap=new Uint8Array(4*s),a.readPixels(0,0,o,n,a.RGBA,a.UNSIGNED_BYTE,this.windVelocityMap)}a.bindFramebuffer(a.FRAMEBUFFER,null)}var l=t*o+e,u=this.windVelocityMap[4*l]/255,c=this.windVelocityMap[4*l+1]/255;this.windVelocityMap[4*l+2],this.windVelocityMap[4*l+3];this.windData||(this.windData={},this.windData.uMin=this._geoJsonFile.properties.value.r.min,this.windData.uMax=this._geoJsonFile.properties.value.r.max,this.windData.vMin=this._geoJsonFile.properties.value.g.min,this.windData.vMax=this._geoJsonFile.properties.value.g.max);var d=this.windData.uMin,h=this.windData.vMin,f=d*(1-u)+this.windData.uMax*u,g=h*(1-c)+this.windData.vMax*c;return void 0===r&&(r=new Kr),r.set(f,g),r},Hi.prototype.getVelocityVector2d_biLinearInterpolation=function(e,t,r,i){var o=this._oceanFluxMapTexture.imageWidth,n=this._oceanFluxMapTexture.imageHeight,a=Math.floor(e*o),s=Math.floor(t*n),l=e*o,u=t*n,c=Math.ceil(1e4*(l<1?l:l%Math.floor(l)))/1e4,d=Math.ceil(1e4*(u<1?u:u%Math.floor(u)))/1e4,h=a+1<o?a+1:a,f=s+1<n?s+1:s,g=this.getVelocityVector2d(a,s,void 0,i),p=this.getVelocityVector2d(h,s,void 0,i),m=this.getVelocityVector2d(a,f,void 0,i),v=this.getVelocityVector2d(h,f,void 0,i),x=Kr.mix(g,p,c,void 0),_=Kr.mix(m,v,c,void 0);return r||(r=new Kr),r=Kr.mix(x,_,d,r)},Hi.prototype._getTrajectoryInGeographicCoordsRad=function(e,t,r){var i=this.getGeographicExtent();if(i.intersects2dWithGeoCoord(e)){var o=i.getMinLongitudeRad(),n=i.getMinLatitudeRad(),a=i.getMaxLongitudeRad()-o,s=i.getMaxLatitudeRad()-n,l=e.getLongitudeRad(),u=e.getLatitudeRad(),c=e.getAltitude(),d=i.getCenterLatitude(),h=Te.radiusAtLatitudeDeg(d),f=1/(h*(L=Math.cos(d*Math.PI/180))),g=1/h,p=20;r&&void 0!==r.numPoints&&(p=r.numPoints);for(var m,v,x,_,y=[],T=new Jr,C=100*p,b=0,M=0;M<C;M++){var A=(l-o)/a,E=(u-n)/s;if(A>1||E>1||A<0||E<0)return y;_=this.getVelocityVector2d_biLinearInterpolation(A,E,_,t),T.set(_.x,_.y,0);var L=Math.cos(n+u*s);if(m=T.x/L*100,v=100*T.y,x=100*T.z,0===b){var w=new Jr;w.set(l,u,c),y.push(w)}if(100===(b+=1)&&(b=0),r.velocitiesArray&&r.velocitiesArray.push(T),l+=m*f,u+=v*g,c+=x,Math.abs(T.x)+Math.abs(T.y)+Math.abs(T.z)<.002)return y}return y}},Hi.prototype._getVectorMeshFromGeoCoordsRadArray=function(e,t,i,o){if(e&&!(e.length<2)){void 0===o&&(o={}),void 0===o.thickness&&(o.thickness=2),void 0===o.color&&(o.color=new J(.8,1,1,1)),this.colorRamp&&void 0===o.velocitiesArray&&(o.velocitiesArray=[]),e.reverse();var n=new yo(o);if(this.colorRamp){o.colorsArray=[];for(var a,s,l=o.velocitiesArray.length,u=1e6,c=-100,d=0;d<l;d++)s=o.velocitiesArray[d].getModul(),a=this.colorRamp.getInterpolatedColor(s),o.colorsArray.push(a),s>c?c=s:s<u&&(u=s)}n.vboKeysContainer=Qr.getVboThickLines(i,e,n.vboKeysContainer,o),n.geoLocDataManager=new ye,n.geoLocDataManager.addGeoLocationData(t),n.objectType=r.OBJECT_TYPE.VECTORMESH;var h=e.length,f=new Float32Array(4*h);for(d=0;d<4*h;d++)f[d]=d.toFixed(0);var g=n.vboKeysContainer.getVboKey(0),p=i.vboMemoryManager;return g.setDataArrayCustom(f,p,1,"indices",4),n}},Hi.prototype._getWindStreamLine=function(e,t,r){void 0===r&&(r={}),void 0===r.thickness&&(r.thickness=4),void 0===r.color&&(r.color=new J(1,.3,.3,1)),this.colorRamp&&void 0===r.velocitiesArray&&(r.velocitiesArray=[]);var i=this._getTrajectoryInGeographicCoordsRad(e,t,r);if(i&&!(i.length<2)){var o=on.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,0,0,0,void 0);return this._getVectorMeshFromGeoCoordsRadArray(i,o,t,r)}},Hi.prototype.newWindStreamLine=function(e){var t={};t.startColor=new J(.8,1,1,1),t.endColor=new J(.8,1,1,1);t.numPoints=300;var r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0];if(1===this._particlesGenerationType){var n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o),s=Mago3D.ManagerUtils.screenCoordToWorldCoordUseDepthCheck(n,a,e,{highPrecision:!1});if(!s)return;var l=Mago3D.ManagerUtils.pointToGeographicCoord(s,void 0);return l.altitude+=1e3,this._getWindStreamLine(l,e,t)}},Hi.prototype.renderMode3DThickLines=function(e){if(!this.prepareLayer())return!1;this.streamLinesArray||(this.streamLinesArray=[]);if(this.streamLinesArray.length<500&&0===e.currentFrustumIdx)for(var t=0;t<2;t++){(a=this.newWindStreamLine(e))&&this.streamLinesArray.push(a)}if(0===this.streamLinesArray.length)return!1;var r=e.extbuffers,i=e.getGl();e.bindMainFramebuffer(),i.framebufferTexture2D(i.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,e.depthTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,e.normalTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,e.albedoTex,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]);i=e.getGl();var o=e.sceneState,n=e.postFxShadersManager.getShader("windStreamThickLineRAD");n.useProgram(),n.bindUniformGenerals(),i.uniform4fv(n.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(n.colorType_loc,0),i.uniform2fv(n.viewport_loc,[o.drawingBufferWidth[0],o.drawingBufferHeight[0]]);i.uniform1f(n.thickness_loc,3),i.uniform1i(n.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(n.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),i.uniform1i(n.uFrustumIdx_loc,e.currentFrustumIdx),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),i.disable(i.CULL_FACE),i.enable(i.BLEND),i.enableVertexAttribArray(n.prev_loc),i.enableVertexAttribArray(n.current_loc),i.enableVertexAttribArray(n.next_loc);var a,s=this.streamLinesArray.length,l=[],u={animationState:this._animationState,animationSpeed:this._animationSpeed};i.disable(i.BLEND);for(t=0;t<s;t++){(a=this.streamLinesArray[t]).geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,n),a.render(e,n,u),a.finished?(a.deleteObjects(e.vboMemoryManager),a=void 0):l.push(a)}i.enable(i.BLEND),this.streamLinesArray=l,i.useProgram(null),i.enable(i.CULL_FACE),i.disable(i.BLEND)};var Vi=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t.magoManager,this.oceanFluxLayersMap={},this.oceanFluxMapFolderPath=void 0,t&&t.oceanFluxMapFolderPath&&(this.oceanFluxMapFolderPath=t.oceanFluxMapFolderPath)};Vi.prototype.newOceanFluxLayer=function(e){var t={oceanFluxManager:this,geoJsonFilePath:e,oceanFluxMapFolderPath:this.oceanFluxMapFolderPath,gl:this.magoManager.sceneState.gl},r=new Hi(t);return this.oceanFluxLayersMap[r.geoJsonFilePath]=r,r},Vi.prototype.render=function(){for(var e in this.oceanFluxLayersMap){if(this.oceanFluxLayersMap.hasOwnProperty(e))this.oceanFluxLayersMap[e].renderMode3DThickLines(this.magoManager)}};var ki=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._owner,this._fileLoadState=I.fileLoadState.READY,this._filePath,this._mosaicTexture,this._mosaicSize=new Int32Array([1,1]),this._isPrepared=!1,this.positionBuffer,this.texcoordBuffer,void 0!==t&&(t.filePath&&(this._filePath=t.filePath),t.owner&&(this._owner=t.owner))};ki.prototype.deleteObjects=function(e){this._owner=void 0,this._fileLoadState=void 0,this._filePath=void 0,this._mosaicTexture&&(this._mosaicTexture.deleteObjects(e.gl),this._mosaicTexture=void 0),this._mosaicSize=void 0,this._isPrepared=void 0,this.positionBuffer&&(e.gl.deleteBuffer(this.positionBuffer),this.positionBuffer=void 0),this.texcoordBuffer&&(e.gl.deleteBuffer(this.texcoordBuffer),this.texcoordBuffer=void 0)},ki.prototype.getPositionBuffer=function(e){if(void 0===this.positionBuffer){this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer);var t=new Float32Array(16),r=new Jr(0,0,0);t[0]=r.x,t[1]=r.y,t[2]=r.z,t[3]=1,t[4]=r.x,t[5]=r.y,t[6]=r.z,t[7]=-1,t[8]=r.x,t[9]=r.y,t[10]=r.z,t[11]=2,t[12]=r.x,t[13]=r.y,t[14]=r.z,t[15]=-2,e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer);e.bufferData(e.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),e.STATIC_DRAW)}return this.positionBuffer};var ji=function(e){this.skeletalAnimObject};ji.prototype.render=function(e){};var Wi=function(e,t,i,o){if(r.call(this),this.color4=new J,this.color4.setRGBA(.2,.2,.25,1),this.type="extruded",this.totalLength=10,t&&(this.totalLength=t),this.bodyWidth=1,e&&(this.bodyWidth=.5*e),this.headWidth=1.5,e&&(this.headWidth=e),this.extrude=1,i&&(this.extrude=i),this.tailLength=.7*this.totalLength,o){var n=o.bodyWidth;n&&(this.bodyWidth=n);var a=o.headWidth;a&&(this.headWidth=a);var s=o.headLength;s&&(this.headLength=s);var l=o.totalLength;l&&(this.totalLength=l);var u=o.tailLength;u&&(this.tailLength=u);var c=o.extrude;c&&(this.extrude=c)}this.headWidth<this.bodyWidth&&(this.headWidth=1.5*this.bodyWidth),this.headLength||(this.headLength=.3*this.totalLength)};(Wi.prototype=Object.create(r.prototype)).constructor=Wi,Wi.prototype.makeMesh=function(){var e=new ii,t=e.newOuterRing(),r=.5*this.bodyWidth,i=.5*this.headWidth,o=this.totalLength-this.headLength,n=t.newElement("POLYLINE");this.tailLength?(n.newPoint2d(0,0),n.newPoint2d(r,this.tailLength),n.newPoint2d(r,o),n.newPoint2d(i,o),n.newPoint2d(0,this.totalLength),n.newPoint2d(-i,o),n.newPoint2d(-r,o),n.newPoint2d(-r,this.tailLength)):(n.newPoint2d(-r,0),n.newPoint2d(r,0),n.newPoint2d(r,o),n.newPoint2d(i,o),n.newPoint2d(0,this.totalLength),n.newPoint2d(-i,o),n.newPoint2d(-r,o));var a=jr.getExtrudedMesh(e,this.extrude,1,void 0,!1,!1,a);this.mesh=a,this.dirty=!1},Wi.prototype.render=function(e,t,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=e.getGl();this.renderRaw(e,t,r,i),o.disable(o.BLEND)}},Wi.prototype.renderAsChild=function(e,t,r,i,o){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var n=e.getGl();if(this.tMat&&this.tMat instanceof Ne&&n.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,this.tMat._floatArrays),0===r);else if(1===r){n.enable(n.BLEND),n.uniform1i(t.colorType_loc,0);var a=e.selectionManager;void 0!==o&&o?n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):a.isObjectSelected(this)?n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}this.mesh.render(e,t,r,i,o),n.disable(n.BLEND)}},Wi.prototype.renderRaw=function(e,t,r,i,o){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var n=e.getGl();if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,t),0===r);else if(1===r){n.enable(n.BLEND),n.uniform1i(t.colorType_loc,0);var a=e.selectionManager;void 0!==o&&o?n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):a.isObjectSelected(this)?n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]):n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}this.mesh.render(e,t,r,i,o),n.disable(n.BLEND)};var Xi=function e(t,i,o,n){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);r.call(this),this.name,this.width=t,this.length=i,this.height=o,this.bHasGround=!1,this.roofMinHeight,this.geoLocDataManager,this.objectsArray,this.objectsMap,this.bbox,this.dirty=!0,this.roofColor4=new J,this.roofColor4.setRGBA(98/256,233/256,134/256,.3),this.options=n,this.bbox=new G,this.bbox.set(-this.width/2,-this.length/2,0,this.width/2,this.length/2,this.height),this.attributes={isVisible:!0}};Xi.prototype=Object.create(r.prototype),Xi.prototype.constructor=Xi,Xi.wallType={FRONT:"front",REAR:"rear",LEFT:"left",RIGHT:"right"},Xi.prototype.getBoundingBox=function(){return this.bbox},Xi.getFactoryDimensionsByGeoCoordsArray=function(e,t,r){if(!(void 0===e||e.length<4)){var i=e[0],o=e[1],n=e[2],a=e[3];if(0===t)var s=new me(i,o),l=new me(o,n);else if(1===t)s=new me(o,n),l=new me(n,a);else if(2===t)s=new me(n,a),l=new me(a,i);else if(3===t)s=new me(a,i),l=new me(i,o);return{factoryWidth:me.getLengthInMeters(s,r),factoryLength:me.getLengthInMeters(l,r),headingDeg:180*me.calculateHeadingAngRadToNorthOfSegment(l,r)/Math.PI,longitude:(i.longitude+i.longitude+i.longitude+i.longitude)/4,latitude:(i.latitude+i.latitude+i.latitude+i.latitude)/4}}},Xi.getTriangularWallProfile2d=function(e,t){if(void 0===e)return t;void 0===t&&(t=new ii);var r=e.hasOpening;void 0===r&&(r=!1);var i=e.width,o=e.height,n=e.roofMinHeight;void 0===n&&(n=.75*o);var a=.5*i;if(r){var s=e.openingHeight;void 0===s&&(s=.6*o);var l=e.openingWidth;void 0===l&&(l=.8*i);var u=.5*l,c=.5*l;(d=t.newOuterRing().newElement("POLYLINE")).newPoint2d(-a,0),d.newPoint2d(-u,0),d.newPoint2d(-u,s),d.newPoint2d(c,s),d.newPoint2d(c,0),d.newPoint2d(a,0),d.newPoint2d(a,n),d.newPoint2d(0,o),d.newPoint2d(-a,n)}else{var d;(d=t.newOuterRing().newElement("POLYLINE")).newPoint2d(-a,0),d.newPoint2d(a,0),d.newPoint2d(a,n),d.newPoint2d(0,o),d.newPoint2d(-a,n)}return t},Xi.getLateralWallProfile2d=function(e,t){void 0===t&&(t=new ii);var r=e.height,i=e.length,o=t.newOuterRing().newElement("POLYLINE");o.newPoint2d(0,0);var n=0,a=e.openingsDataArray,s=0;void 0!==a&&(s=a.length);for(var l=0;l<s;l++){var u=e.openingsDataArray[l],c=u.offSet,d=u.height,h=u.width;o.newPoint2d(n+c,0),o.newPoint2d(n+c,d),o.newPoint2d(n+c+h,d),o.newPoint2d(n+c+h,0),n=n+c+h}return o.newPoint2d(i,0),o.newPoint2d(i,r),o.newPoint2d(0,r),t},Xi.prototype.getWallProfile2d=function(e,t,r){void 0===r&&(r=new ii);var i=e===Xi.wallType.FRONT||e===Xi.wallType.REAR,o=i?this.width:this.length,n=this.height,a=this.roofMinHeight,s=r.newOuterRing().newElement("POLYLINE");if(s.newPoint2d(0,0),t&&t.openingInfo)if(Array.isArray(t.openingInfo))for(var l=0,u=t.openingInfo,c=0,d=u.length;c<d;c++){var h=u[c];if(Qo(h.offset)){var f=h.offset,g=h.height,p=h.width;l+=f,h.centerPropterties=this.calculateOpeningProperties(e,l,p,g,h.thickness),s.newPoint2d(l,0),s.newPoint2d(l,g),l+=p,s.newPoint2d(l,g),s.newPoint2d(l,0)}}else{h=t.openingInfo;var m=Qo(h.offset)?h.offset:.5*(o-h.width);g=h.height,p=h.width;h.centerPropterties=this.calculateOpeningProperties(e,m,p,g,h.thickness),s.newPoint2d(m,0),s.newPoint2d(m,g),s.newPoint2d(m+p,g),s.newPoint2d(m+p,0)}return s.newPoint2d(o,0),s.newPoint2d(o,a),i&&s.newPoint2d(.5*o,n),s.newPoint2d(0,a),r},Xi.prototype.calculateOpeningProperties=function(e,t,r,i){var o=new ii,n=(s=o.newOuterRing()).newElement("POLYLINE");n.newPoint2d(t,0),n.newPoint2d(t+r,0),n.newPoint2d(t+r,i),n.newPoint2d(t,i);var a=new Ii;a.makeByProfile2D(o),this.validateWallGeom(e,a);var s,l=(s=a.outerVtxRing).vertexList.getBoundingBox().getCenterPoint(),u=s.calculatePlaneNormal(),c=this.geoLocDataManager.getCurrentGeoLocationData(),d=c.rotMatrix;return{openeingProfile2d:o,centerLC:l,normalLC:u,centerWC:c.localCoordToWorldCoord(l),normalWC:d.transformPoint3D(u)}},Xi.prototype.getOpeningProperties=function(e,t){var r,i,o=this.options.wallOptions;if(Qo(t)||(t=0),o)for(var n in o)o[n].type===e&&(r=o[n]);return Array.isArray(r.openingInfo)?(r.openingInfo[t].centerPropterties&&(r.openingInfo[t].centerPropterties.wallType=e),i=r.openingInfo[t].centerPropterties):(r.openingInfo.centerPropterties&&(r.openingInfo.centerPropterties.wallType=e),i=r.openingInfo.centerPropterties),i},Xi.prototype.makeMesh=function(){if(void 0!==this.width&&void 0!==this.length&&void 0!==this.height){if(void 0===this.objectsArray&&(this.objectsArray=[]),void 0===this.objectsMap&&(this.objectsMap={}),this.bHasGround){var e=this.width,t=this.length,r=.02*this.height,i=new qi(e,t,r,"ground");i.setOneColor(.2,.3,.3,1),i.owner=this,this.objectsArray.push(i),this.objectsMap[i.name]=i}this.roofMinHeight=Zo(this.options.roofMinHeight,.75*this.height);var o=this.options.wallOptions,n=.4;for(var a in Xi.wallType)if(Xi.wallType.hasOwnProperty(a)){var s,l=Xi.wallType[a];if(o){for(var u in o){if(o[u].type===l){s=o[u],n=Zo(s.thickness,.4);break}s=null}var c=l+"Wall";if(!this.objectsMap[c]){var d=this.getWallProfile2d(l,s,void 0);(p=jr.getExtrudedMesh(d,n,1,void 0,!0,!0,void 0)).name=c,this.objectsArray.push(p),this.objectsMap[c]=p,this.validateWallGeom(l,p)}}}var h=.5*this.width,f=this.roofMinHeight,g=new ei;g.newPoint2d(h,f),g.newPoint2d(0,this.height),g.newPoint2d(-h,f);var p,m,v=new ei;v.point2dArray=Zr.getExpandedPoints(g.point2dArray,v.point2dArray,0,.2),(d=new ii).newOuterRing().addElement(v),n=this.length,(p=jr.getExtrudedMesh(d,n,1,void 0,!0,!0,void 0)).name="roof",p.owner=this,this.objectsArray.push(p),this.objectsMap[p.name]=p,p.rotate(90,1,0,0),p.translate(0,.5*this.length,0),p.setOneColor(98/256,233/256,134/256,.3);var x=this.options.roofOptions;if(void 0!==x&&void 0!==(m=x.material)&&void 0!==m.diffuseTexture){var _=new G,y=this.width;_.set(-y,-60,-20,y,60,20),p.calculateTexCoordsBox(_),p.material=m}this.dirty=!1}},Xi.prototype.getObjectByName=function(e){return this.objectsMap[e]},Xi.prototype.removeMesh=function(e){this.objectsMap&&this.objectsMap[e]&&(this.objectsMap[e]=void 0),this.objectsArray&&Array.isArray(this.objectsArray)&&(this.objectsArray=this.objectsArray.filter(function(t){return t.name!==e}))},Xi.prototype.validateWallGeom=function(e,t,r){if("function"!=typeof t.rotate||"function"!=typeof t.translate)throw new Error("invalid geometry type.");switch(Qo(r)||(r=.4),e){case"front":t.rotate(90,1,0,0),t.translate(.5*-this.width,.5*-this.length+r,0);break;case"rear":t.rotate(90,1,0,0),t.translate(.5*-this.width,.5*this.length,0);break;case"left":t.rotate(90,1,0,0),t.rotate(90,0,0,1),t.translate(.5*-this.width,.5*-this.length,0);break;case"right":t.rotate(90,1,0,0),t.rotate(90,0,0,1),t.translate(.5*this.width-r,.5*-this.length,0)}t instanceof kr&&t.setOneColor(.9,.9,.9,1)};var Yi=function(){};Yi.degreeValidator=function(e){return e},Yi.MODE={NORMAL:0,PARALLEL_TRANSLATE:1,PARALLEL_ROTATION:2,CIRCULAR_ROTATION:3},Yi.ACCEL_STATUS={FORWARD:0,REVERSE:1,NONE:2};var qi=function e(t,i,o,n){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.mesh,this.centerPoint,this.width,this.length,this.height,this.owner,void 0!==n&&(this.name=n),void 0!==t&&(this.width=t),void 0!==i&&(this.length=i),void 0!==o&&(this.height=o)};qi.prototype=Object.create(r.prototype),qi.prototype.constructor=qi,qi.prototype.getMesh=function(){return void 0===this.mesh&&(this.mesh=this.makeMesh(this.width,this.length,this.height)),this.mesh},qi.prototype.moved=function(){this.boundingSphereWC=void 0},qi.prototype.makeMesh=function(){var e=new ii,t=e.newOuterRing(),r=.5*this.width,i=.5*this.length,o=t.newElement("POLYLINE");o.newPoint2d(-r,-i),o.newPoint2d(r,-i),o.newPoint2d(r,i),o.newPoint2d(-r,i);var n=this.height,a=jr.getExtrudedMesh(e,n,1,void 0,!0,!0,void 0);this.objectsArray.push(a),this.dirty=!1};var Ki=function e(){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.position,this.positiomHIGH,this.positionLOW,this.clippingPlanesArray,this.bActive=!1,this._pointsArrayToExtrude,this._extrudeQuantity,this.planesPositionsFloat32Array,this.planesNormalsFloat32Array,this.planesVec4Array};Ki.prototype=Object.create(r.prototype),Ki.prototype.constructor=Ki,Ki.prototype.create_byExtrude=function(e,t,r){this._pointsArrayToExtrude=e,this._extrudeQuantity=r;var i=e.length;void 0===this.clippingPlanesArray&&(this.clippingPlanesArray=[]);for(var o=0;o<i;o++){var n=e[o],a=e[o===i-1?0:o+1],s=new Jr(n.x+t.x*r,n.y+t.y*r,n.z+t.z*r),l=new Jr(a.x+t.x*r,a.y+t.y*r,a.z+t.z*r);(d=new Zi)._pointsArray=[n,a,l,s];var u=bi.calculateNormal(n,l,a,void 0);d.setPosition(n.x,n.y,n.z),d.setNormal(u.x,u.y,u.z),this.clippingPlanesArray.push(d)}var c=e[0],d=(s=new Jr(c.x+t.x*r,c.y+t.y*r,c.z+t.z*r),new Zi);u=new Jr(0,0,1);d.setPosition(s.x,s.y,s.z),d.setNormal(u.x,u.y,u.z),this.clippingPlanesArray.push(d);d=new Zi,u=new Jr(0,0,-1);d.setPosition(n.x,n.y,n.z),d.setNormal(u.x,u.y,u.z),this.clippingPlanesArray.push(d)},Ki.prototype.getPlanesCount=function(){return this.clippingPlanesArray?this.clippingPlanesArray.length:0},Ki.prototype.getPlanesPositionsFloat32Array=function(){if(!this.planesPositionsFloat32Array){var e=this.clippingPlanesArray.length;this.planesPositionsFloat32Array=new Float32Array(3*e);for(var t=0;t<e;t++){var r=this.clippingPlanesArray[t];this.planesPositionsFloat32Array[3*t]=r.position.x,this.planesPositionsFloat32Array[3*t+1]=r.position.y,this.planesPositionsFloat32Array[3*t+2]=r.position.z}}return this.planesPositionsFloat32Array},Ki.prototype.getPlanesNormalsFloat32Array=function(){if(!this.planesNormalsFloat32Array){var e=this.clippingPlanesArray.length;this.planesNormalsFloat32Array=new Float32Array(3*e);for(var t=0;t<e;t++){var r=this.clippingPlanesArray[t];this.planesNormalsFloat32Array[3*t]=r.normal.x,this.planesNormalsFloat32Array[3*t+1]=r.normal.y,this.planesNormalsFloat32Array[3*t+2]=r.normal.z}}return this.planesNormalsFloat32Array},Ki.prototype.moved=function(){this.planesPositionsVec3Array=void 0,this.planesNormalsVec3Array=void 0},Ki.prototype.makeMesh=function(){if(this._pointsArrayToExtrude){for(var e=new ii,t=e.newOuterRing(),r=(this.width,this.length,t.newElement("POLYLINE")),i=this._pointsArrayToExtrude.length,o=0;o<i;o++){var n=this._pointsArrayToExtrude[o];r.newPoint2d(n.x,n.y)}var a=this._extrudeQuantity,s=jr.getExtrudedMesh(e,a,1,void 0,!0,!0,void 0);return this.setOneColor(.2,.7,.8,.3),this.attributes.isMovable=!0,this.attributes.isSelectable=!0,this.attributes.name="clippingBox",this.attributes.selectedColor4=new J(1,0,0,0),void 0===this.options&&(this.options={}),this.options.renderWireframe=!0,this.options.renderShaded=!0,this.options.depthMask=!0,this.objectsArray.push(s),this.dirty=!1,s}};var Zi=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.position,this.normal,this._pointsArray,this.plane,t||(t={}),this.color4=Zo(t.color,new J(1,1,1,1)),t.renderWireframe=!0,r.call(this,t),t.position){var i=t.position;this.setGeographicPosition(new pe(i.longitude,i.latitude,i.altitude),0,0,0)}this.attributes.isMovable=Zo(t.isMovable,!0),this.attributes.movementInAxisZ=!0,this._width=50,this._length=50};Zi.prototype=Object.create(r.prototype),Zi.prototype.constructor=Zi,Zi.prototype.setPosition=function(e,t,r){void 0===this.position&&(this.position=new Jr),this.position.set(e,t,r)},Zi.prototype.setNormal=function(e,t,r){void 0===this.normal&&(this.normal=new Jr),this.normal.set(e,t,r)},Zi.prototype.makeMesh=function(){if(this.dirty){var e=this.geoLocDataManager.getCurrentGeoLocationData(),t=e.geographicCoord,r=t.longitude,i=t.latitude,o=t.altitude,n=new pe(r-.001,i-.001,o),a=new pe(r+.001,i-.001,o),s=new pe(r+.001,i+.001,o),l=new pe(r-.001,i+.001,o),u=on.geographicCoordToWorldPoint(n.longitude,n.latitude,n.altitude,void 0),c=on.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude,void 0),d=on.geographicCoordToWorldPoint(s.longitude,s.latitude,s.altitude,void 0),h=on.geographicCoordToWorldPoint(l.longitude,l.latitude,l.altitude,void 0),f=e.worldCoordToLocalCoord([u,c,d,h],void 0),g=new Ii;g.makeByPoints3DArray(f,void 0);var p=new kr,m=p.newSurface();(m=Fi.getTransversalSurface(g,void 0,m)).calculateVerticesNormals(),this.objectsArray.push(p),this.setDirty(!1)}};var Ji=function(e,t){r.call(this),this.height=Zo(e.height,0),this.geoLocDataManager,Qo(t)&&(this.geoLocDataManager=t),this.bbox,this.options=e};(Ji.prototype=Object.create(r.prototype)).constructor=Ji,Ji.prototype.clear=function(){this.objectsArray=[]},Ji.prototype.makeMesh=function(){var e=this.options.tubeInfos;if(Qo(e)){this.clear();for(var t=0,r=e.length;t<r;t++)this.makeTube(e[t]);this.setDirty(!1)}},Ji.prototype.makeTube=function(e){var t=e.interiorRadius,r=e.exteriorRadius,i=this.getHeight(),o=new vo(t,r,i,e);o.owner=this,this.objectsArray.push(o)},Ji.prototype.getBoundingBox=function(){if(void 0===this.bbox){this.bbox=new G;for(var e=0,t=this.getSize();e<t;e++){var r=this.getTube(e).getBoundingBox();0===e?this.bbox.copyFrom(r):this.bbox.addBox(r)}}return this.bbox},Ji.prototype.setHeight=function(e){this.height=e},Ji.prototype.getHeight=function(e){return this.height},Ji.prototype.addTube=function(e){this.objectsArray.push(e)},Ji.prototype.getTubes=function(){return this.objectsArray},Ji.prototype.getTube=function(e){return this.objectsArray[e]},Ji.prototype.getSize=function(){return this.objectsArray.length};var Qi=function e(t,i,o){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.radius=10,this.height=5,this.baseType=1,this.originType=0,void 0!==t&&(this.radius=t),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.bbox,void 0!==o){var n=o.color;n&&this.setOneColor(n.r,n.g,n.b,n.a);var a=o.selectedColor;a&&(this.selectedColor4=new J,this.selectedColor4.setRGBA(a.r,a.g,a.b,a.a));var s=o.baseType;s&&(this.baseType=s);var l=o.originType;l&&(this.originType=l)}};Qi.prototype=Object.create(r.prototype),Qi.prototype.constructor=Qi,Qi.prototype.makeMesh=function(){var e=new ii,t=e.newOuterRing(),r=this.height,i=this.radius,o=t.newElement("POLYLINE");if(o.newPoint2d(0,r),o.newPoint2d(-i,0),1===this.baseType)o.newPoint2d(0,0);else if(2===this.baseType){var n=Math.sqrt(r*r+i*i),a=180*Math.acos(r/n)/Math.PI,s=t.newElement("ARC");s.setCenterPosition(0,r),s.setRadius(n),s.setStartPoint(-i,0),s.setSweepAngleDegree(a)}var l=new mi,u=new Kr(0,0),c=new Kr(0,1);l.setPoints(u,c);var d=jr.getRevolvedMesh(e,360,24,l,!1,!1,void 0);this.mesh=d.getCopySurfaceIndependentMesh(d),this.mesh.rotate(90,1,0,0),1===this.originType&&this.mesh.translate(0,0,-r),this.objectsArray.push(this.mesh),this.dirty=!1};var $i=function e(t,i,o){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.radius=10,this.height=5,void 0!==t&&(this.radius=t),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==o){var n=o.color;n&&(this.color4=new J,this.color4.setRGBA(n.r,n.g,n.b,n.a));var a=o.selectedColor;a&&(this.selectedColor4=new J,this.selectedColor4.setRGBA(a.r,a.g,a.b,a.a))}};($i.prototype=Object.create(r.prototype)).constructor=$i,$i.prototype.makeMesh=function(){var e,t=new ii;(e=t.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),e.setRadius(this.radius);var r=this.height,i=jr.getExtrudedMesh(t,r,1,void 0,!0,!0,void 0);this.objectsArray.push(i),this.dirty=!1};var eo=function e(t,r,i){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.radiusX,this.radiusY,this.radiusZ,this.centerPosition,this.strLonRad,this.endLonRad,this.strLatRad,this.endLatRad,this.lonSegments=120,this.latSegments=60,this.cartesiansArray,this.normalsArray,this.texCoordsArray,this.colorsArray,this.indices,this.mesh,void 0!==t&&(this.radiusX=t),void 0!==r&&(this.radiusY=r),void 0!==i&&(this.radiusZ=i),void 0===this.strLonRad&&(this.strLonRad=0),void 0===this.endLonRad&&(this.endLonRad=2*Math.PI),void 0===this.strLatRad&&(this.strLatRad=-Math.PI/2),void 0===this.endLatRad&&(this.endLatRad=Math.PI/2)};eo.prototype.render=function(e,t,r,i){var o=e.getGl(),n=this.vboKeyContainer.vboCacheKeysArray[0];if(!n.bindDataPosition(t,e.vboMemoryManager))return!1;if(void 0!==n.vboBufferNor&&!n.bindDataNormal(t,e.vboMemoryManager))return!1;if(!n.bindDataIndice(t,e.vboMemoryManager))return!1;var a=n.indicesCount;o.drawElements(o.TRIANGLES,a,o.UNSIGNED_SHORT,0)},eo.prototype.makeVbo=function(e){if(void 0!==this.cartesiansArray){void 0===this.vboKeyContainer&&(this.vboKeyContainer=new xt);var t=this.vboKeyContainer.newVBOVertexIdxCacheKey();t.setDataArrayPos(this.cartesiansArray,e),this.normalsArray&&t.setDataArrayNor(this.normalsArray,e),this.texCoordsArray&&t.setDataArrayTexCoord(this.texCoordsArray,e),t.setDataArrayIdx(this.indices,e)}},eo.prototype.makeMesh=function(e){var t=!0;void 0!==e&&void 0!==e.bTrianglesSenseCCW&&(t=e.bTrianglesSenseCCW),this.strLonRad>this.endLonRad&&(this.strLonRad-=2*Math.PI);var r=(this.endLonRad-this.strLonRad)/this.lonSegments,i=(this.endLatRad-this.strLatRad)/this.latSegments,o=this.strLonRad,n=this.strLatRad,a=this.radiusX,s=this.radiusY,l=this.radiusZ,u=a*a,c=s*s,d=l*l,h=(this.lonSegments+1)*(this.latSegments+1);this.cartesiansArray=new Float32Array(3*h),this.normalsArray=new Int8Array(3*h);for(var f=0,g=new G,p=0;p<this.latSegments+1;p++){n=this.strLatRad+p*i;for(var m=Math.sin(n),v=Math.cos(n),x=0;x<this.lonSegments+1;x++){o=this.strLonRad+x*r;var _=Math.sin(o),y=a*v*Math.cos(o),T=s*v*_,C=l*m;this.cartesiansArray[3*f]=y,this.cartesiansArray[3*f+1]=T,this.cartesiansArray[3*f+2]=C;var b=new Jr(y,T,C);0===f?g.init(b):g.addPoint(b),b.set(y/u,T/c,C/d),b.unitary(),t?(this.normalsArray[3*f]=127*b.x,this.normalsArray[3*f+1]=127*b.y,this.normalsArray[3*f+2]=127*b.z):(this.normalsArray[3*f]=127*-b.x,this.normalsArray[3*f+1]=127*-b.y,this.normalsArray[3*f+2]=127*-b.z),f+=1}}this.centerPosition=g.getCenterPoint();for(x=0;x<h;x++)this.cartesiansArray[3*x]-=this.centerPosition.x,this.cartesiansArray[3*x+1]-=this.centerPosition.y,this.cartesiansArray[3*x+2]-=this.centerPosition.z;void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),on.calculateSplited3fv([this.centerPosition.x,this.centerPosition.y,this.centerPosition.z],this.terrainPositionHIGH,this.terrainPositionLOW);var M=this.lonSegments+1,A=this.latSegments+1,E=en.getIndicesTrianglesRegularNet(M,A,void 0,void 0,void 0,void 0,void 0,e);this.indices=E.indicesArray};var to=function e(t,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(!t)throw new Error(Ue.REQUIRED_EMPTY_ERROR("geographicCoordList"));if(this.geographicCoordListsArray=[],t instanceof ve?this.geographicCoordListsArray.push(t):t instanceof Array&&(this.geographicCoordListsArray=t),void 0===i||null===i)throw new Error(Ue.REQUIRED_EMPTY_ERROR("height"));if(0===i)throw new Error("height must higher than 0");r.call(this,o),o=o||{};var n=this.geographicCoordListsArray[0];this.setGeographicPosition(n.getMiddleGeographicCoords()),this.localCoordListArray=function(e,t){for(var r=t.getTMatrixInv(),i=[],o=0,n=e.length;o<n;o++){var a=e[o];ve.solveDegeneratedPoints(a.geographicCoordsArray,1e-7);for(var s=[],l=0,u=a.geographicCoordsArray.length;l<u;l++){var c=a.geographicCoordsArray[l],d=on.geographicCoordToWorldPoint(c.longitude,c.latitude,c.altitude),h=r.transformPoint3D(d);s.push(h)}i.push(s)}return i}(this.geographicCoordListsArray,this.geoLocDataManager.getCurrentGeoLocationData()),this.height=i,this.color4=Zo(o.color,new J(1,1,1,1)),this.attributes.isMovable=Zo(o.isMovable,!0),this.attributes.isSelectable=Zo(o.isSelectable,!0),this.attributes.selectedColor4=Zo(o.selectedColor,new J(1,1,0,1)),this.attributes.heightReference=Zo(o.heightReference,Ce.NONE),this.attributes.drawFloorText=Zo(o.drawFloorText,!1),this.divideLevel=Zo(o.divideLevel,!1),this.options||(this.options={}),this.options.renderWireframe=Zo(o.renderWireframe,!0),this.options.renderShaded=Zo(o.renderShaded,!0),this.options.depthMask=Zo(o.depthMask,!0),this.options.limitationGeographicCoords=Zo(o.limitationGeographicCoords,void 0),this.limitationConvexPolygon2dArray};to.prototype=Object.create(r.prototype),to.prototype.constructor=to,to.prototype.makeMesh=function(){if(this.dirty){var e=this.magoManager.workersManager.getExtrusionWorkerManager();if(!e.isBusy()&&this.geoLocDataManager){var t=this.geoLocDataManager.getCurrentGeoLocationData();if(t){this.attributes.heightReference!==Ce.NONE&&(t=on.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,t));this.objectsArray=[];for(var r=this.geographicCoordListsArray.length,i=new Array(r),o=0;o<r;o++){var n=this.geographicCoordListsArray[o],a={floorHeight:this.floorHeight?this.floorHeight:3.3,height:this.height,divideLevel:this.divideLevel,geographicCoordsListsArray:[n]};i[o]=a}var s={guid:this._guid,objectsToExtrudeArray:i,color:J.toArray(this.color4),geoLocation:{longitude:t.geographicCoord.longitude,latitude:t.geographicCoord.latitude,altitude:t.geographicCoord.altitude},rotation:{heading:0,pitch:0,roll:0}};e.doExtrude(s),this.objectsArray.push(new kr),this.setDirty(!1),this.options.limitationGeographicCoords&&this.makeUniformPoints2dArray(),this.attributes.heightReference!==Ce.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}}},to.prototype.render=function(e,t,r,i,o){if(this.attributes&&void 0!==this.attributes.isVisible&&!1===this.attributes.isVisible)return!0;if(this.dirty&&this.makeMesh(e),!this.vboFromWorker){var n=e.workersManager.getExtrusionWorkerManager().getResult(this._guid);if(!n)return!1;var a=n.vbosArray[0],s=new xt,l=e.vboMemoryManager,u=s.newVBOVertexIdxCacheKey();u.setDataArrayPos(a.posVboDataArray,l),a.norVboDataArray&&u.setDataArrayNor(a.norVboDataArray,l),a.tcoordVboDataArray&&u.setDataArrayTexCoord(a.tcoordVboDataArray,l),a.colVboDataArray&&u.setDataArrayCol(a.colVboDataArray,l),u.setDataArrayIdx(a.indicesArray,l),this.objectsArray[0].vboKeysContainer=s,this.vboFromWorker=!0}if(!this.objectsArray||0===this.objectsArray.length)return!1;var c=e.getGl();void 0!==this.attributes.opacity&&c.uniform1f(t.externalAlpha_loc,this.attributes.opacity),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(c,t),this.attributes.doubleFace?c.disable(c.CULL_FACE):c.enable(c.CULL_FACE);var d=!0;return this.options&&!1===this.options.renderShaded&&(d=!1),c.uniform1i(t.bApplySpecularLighting_loc,!1),d&&this.renderAsChild(e,t,r,i,o,this.options),c.uniform1f(t.externalAlpha_loc,1),c.uniform1i(t.bApplySpecularLighting_loc,!1),c.uniform1i(t.clippingType_loc,0),!0},to.prototype.setOneColor=function(e,t,r,i){void 0===this.color4&&(this.color4=new J),this.color4.setRGBA(e,t,r,i),i<1&&this.setOpaque(!1),this.divideLevel&&this.setDirty(!0)},to.prototype.makeUniformPoints2dArray=function(){if(this.geoLocDataManager){var e=this.geoLocDataManager.getCurrentGeoLocationData();if(e&&this.options.limitationGeographicCoords){this.limitationConvexPolygon2dArray=[];var t=this.options.limitationGeographicCoords,r=ve.getPointsRelativeToGeoLocation(e,t,void 0),i=new $r;i.point2dList=new Zr;for(var o=r.length,n=0;n<o;n++)var a=r[n],s=i.point2dList.newPoint(a.x,a.y);var l=i.calculateNormal(void 0);i.normal<0&&(i.reverseSense(),l=i.calculateNormal(void 0));var u=i.tessellate(l,void 0),c=new Float32Array(512),d=new Int32Array(256);for(n=0;n<256;n++)d[n]=-1;var h=0,f=u.length;for(n=0;n<f;n++){var g=u[n],p=g.point2dList.getPointsCount();d[2*n]=h;for(var m=0;m<p;m++){s=g.point2dList.getPoint(m);c[2*h]=s.x,c[2*h+1]=s.y,h+=1}d[2*n+1]=h-1}this.uniformPoints2dArray=c,this.uniformPolygonPointsIdx=d}}},to.makeExtrusionBuildingByCartesian3Array=function(e,t,r){var i=ve.fromCartesians(e);return new to(i,t,r)},to.prototype.setHeight=function(e){if(void 0===e||null===e)throw new Error(Ue.REQUIRED_EMPTY_ERROR("height"));this.height=e,this.setDirty(!0)},to.prototype.setLimitationGeographicCoords=function(e){this.options.limitationGeographicCoords=e,this.setDirty(!0)},to.prototype.setLimitationHeight=function(e){this.options.limitationHeights=e?new Float32Array([0,e]):void 0},to.prototype.setSplitHeight=function(e,t){if(isNaN(e)||isNaN(t))throw new Error("value must number");if(e>t)throw new Error("min value must lower than max value");this.options.limitationHeights=new Float32Array([e,t])},to.prototype.setLimitationColor=function(e){if(!e||!(e instanceof J||e instanceof re))throw new Error("invalid parameter");this.options||(this.options={}),this.options.limitationInfringingDynamicColor4=e},to.prototype.getHeight=function(){return this.height},to.prototype.getRealHeight=function(){return this.height+this.terrainHeight},to.prototype.getLevel=function(){return this.floorHeight?parseInt(this.height/this.floorHeight,10):0},to.prototype.getCenter=function(){for(var e=this.geographicCoordListsArray.length,t=[],r=0;r<e;r++){var i=this.geographicCoordListsArray[r].getGeographicExtent();t.push(new pe(i.getCenterLongitude(),i.getCenterLatitude(),i.getCenterAltitude()))}var o=new ve(t).getGeographicExtent();return new pe(o.getCenterLongitude(),o.getCenterLatitude(),o.getCenterAltitude())},to.prototype.getDistToCamera=function(e){var t=this.objectsArray[0].getBoundingBox().getRadiusAprox(),r=this.getBBoxCenterPositionWorldCoord(),i=new z(r.x,r.y,r.z,t);return e.distToSphere(i)},to.prototype.getBBoxCenterPositionWorldCoord=function(){var e=this.getCurrentGeoLocationData(),t=this.objectsArray[0].getBoundingSphere().centerPoint;return e.tMatrix.transformPoint3D(t)};var ro=function e(t,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(!t)throw new Error(Ue.REQUIRED_EMPTY_ERROR("geographicCoordList"));if(void 0===i||null===i)throw new Error(Ue.REQUIRED_EMPTY_ERROR("height"));if(0===i)throw new Error("height must higher than 0");r.call(this,o),this.geographicCoordList=t,this.height=i,this.setGeographicPosition(this.geographicCoordList.getMiddleGeographicCoords()),this.localCoordListArray=function(e,t){var r=t.getTMatrixInv();ve.solveDegeneratedPoints(e,1e-7);for(var i=[],o=0,n=e.length;o<n;o++){var a=e[o],s=on.geographicCoordToWorldPoint(a.longitude,a.latitude,a.altitude),l=r.transformPoint3D(s);i.push(l)}return i}(this.geographicCoordList.geographicCoordsArray,this.geoLocDataManager.getCurrentGeoLocationData()),o=o||{},this.color4=Zo(o.color,new J(1,1,1,1)),this.attributes.isMovable=Zo(o.isMovable,!0),this.attributes.isSelectable=Zo(o.isSelectable,!0),this.attributes.selectedColor4=Zo(o.selectedColor,new J(1,1,0,1)),this.attributes.heightReference=Zo(o.heightReference,Ce.NONE),this.attributes.doubleFace=Zo(o.doubleFace,!0),this.options||(this.options={}),this.options.loop=Zo(o.loop,!1),this.options.colorTop=Zo(o.colorTop,void 0),this.options.colorBottom=Zo(o.colorBottom,void 0),this.options.colorsArray=Zo(o.colorsArray,void 0);var n=this.options.colorsArray instanceof Array&&this.options.colorsArray.length>2?this.options.colorsArray.length-1:1;this.options.segmentCount=Zo(o.segmentCount,n),this.options.segmentCount>1&&!this.options.colorsArray&&this.options.colorTop&&this.options.colorBottom&&(this.options.colorsArray=J.getInterpolatedColorsArray(this.options.colorBottom,this.options.colorTop,this.options.segmentCount+1,this.options.colorsArray))};(ro.prototype=Object.create(r.prototype)).constructor=ro,ro.prototype.makeMesh=function(){if(this.dirty&&this.geoLocDataManager){var e=this.geoLocDataManager.getCurrentGeoLocationData();if(e){this.attributes.heightReference!==Ce.NONE&&(e=on.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,e));for(var t={outerVtxRingOptions:{isOpen:!this.options.loop}},r=new Fi,i=this.height/this.options.segmentCount,o=0;o<this.options.segmentCount+1;o++){var n=this.geographicCoordList.getCopy();n.setAltitude(i*o);var a=ve.getPointsRelativeToGeoLocation(e,n.geographicCoordsArray,void 0),s=r.newVtxProfile();if(s.makeByPoints3DArray(a,void 0,t),this.options.colorsArray){var l=this.options.colorsArray[o];s.setColorRGBAVertices(l.r,l.g,l.b,l.a)}else if(this.options.colorTop&&this.options.colorBottom&&1===this.options.segmentCount){var u=0===o?this.options.colorBottom:this.options.colorTop;s.setColorRGBAVertices(u.r,u.g,u.b,u.a)}}var c=r.getMesh(void 0,!1,!1,!1).getCopySurfaceIndependentMesh();c.calculateVerticesNormals(),this.objectsArray.push(c),this.setDirty(!1),this.attributes.heightReference!==Ce.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}},ro.makeExtrusionBuildingByCartesian3Array=function(e,t,r){var i=ve.fromCartesians(e);return new ro(i,t,r)};var io=function e(t,i,o){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.radius=1,this.height=5,void 0!==t&&(this.radius=t),void 0!==i&&(this.height=i),this.baseRadius=4*this.radius,this.flagOrientation,this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==o){var n=o.color;n&&(this.color4=new J,this.color4.setRGBA(n.r,n.g,n.b,n.a));var a=o.selectedColor;a&&(this.selectedColor4=new J,this.selectedColor4.setRGBA(a.r,a.g,a.b,a.a))}};io.prototype=Object.create(r.prototype),io.prototype.constructor=io,io.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]);var e=.01*this.height,t={color:new J(1,1,0,1)},r=new $i(this.baseRadius,e,t);this.objectsArray.push(r);t={color:new J(.9,.9,.95,1)};var i=new $i(this.radius,this.height,t);this.objectsArray.push(i);var o=new ii,n=o.newOuterRing().newElement("POLYLINE");n.newPoint2d(-1,0),n.newPoint2d(1,0),n.newPoint2d(0,10);var a=jr.getExtrudedMesh(o,.1,1,void 0,!1,!1,a);a.setOneColor(1,.1,.1,1),a.rotate(90,0,1,0),a.rotate(45,0,0,1),a.translate(0,0,this.height-1),this.objectsArray.push(a),this.dirty=!1};var oo=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.width=t,this.height=r,this.geoLocDataManager,this.vboKeysContainer};oo.prototype.makeMesh=function(e){var t=this.width/2,r=this.height/2,i=new wi;i.point3d.set(-t,-r,0),i.normal=new Jr(0,0,1),i.texCoord=new Kr(0,0);var o=new wi;o.point3d.set(t,-r,0),o.normal=new Jr(0,0,1),o.texCoord=new Kr(1,0);var n=new wi;n.point3d.set(t,r,0),n.normal=new Jr(0,0,1),n.texCoord=new Kr(1,1);var a=new wi;a.point3d.set(-t,r,0),a.normal=new Jr(0,0,1),a.texCoord=new Kr(0,1);var s=[i,o,n,a];void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt);var l=e.vboMemoryManager,u=this.vboKeysContainer.newVBOVertexIdxCacheKey();Si.setIdxInList(s),Si.getVboDataArrays(s,u,l);var c=new Uint16Array([0,1,3,1,2,3]);u.setDataArrayIdx(c,l)},oo.prototype.render=function(e,t,r){void 0===this.vboKeysContainer&&this.makeMesh(e);var i,o=e.vboMemoryManager,n=e.sceneState.gl;this.color4&&n.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]),t.useProgram(),t.resetLastBuffersBinded(),t.enableVertexAttribArray(t.position3_loc),t.disableVertexAttribArray(t.color4_loc),t.enableVertexAttribArray(t.normal3_loc),t.enableVertexAttribArray(t.texCoord2_loc),t.bindUniformGenerals(),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(n,t);for(var a=this.vboKeysContainer.vboCacheKeysArray.length,s=0;s<a;s++){var l=this.vboKeysContainer.vboCacheKeysArray[s];if(!l.bindDataPosition(t,o))return!1;if(l.vboBufferNor){if(!l.bindDataNormal(t,o))return!1}else t.disableVertexAttribArray(t.normal3_loc);if(l.vboBufferCol){if(!l.bindDataColor(t,o))return!1}else t.disableVertexAttribArray(t.color4_loc);if(l.vboBufferTCoord){if(!l.bindDataTexCoord(t,o))return!1}else t.disableVertexAttribArray(t.texCoord2_loc);if(!l.bindDataIndice(t,o))return!1;i=r||n.TRIANGLES,n.drawElements(i,l.indicesCount,n.UNSIGNED_SHORT,0)}};var no=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this._scheme={type:function(e){return"Feature"===e},geometry:function(e){},properties:function(e){return e.HEIGHT}},!t)throw new Error(Ue.REQUIRED_EMPTY_ERROR("geojson"));r.call(this),this.centerGeographicCoords,this.geographicCoordListsArray=[],this.height=3,this.groundHeight=0;var i={};this.color4=Zo(i.color,new J(1,.98823529,.8,1)),this.attributes.isMovable=Zo(i.isMovable,!0),this.attributes.isSelectable=Zo(i.isSelectable,!0),this.attributes.selectedColor4=Zo(i.selectedColor,new J(1,1,0,1)),this.attributes.heightReference=Zo(i.heightReference,Ce.CLAMP_TO_GROUND),this.initialize(t)};no.prototype=Object.create(r.prototype),no.prototype.constructor=no,no.prototype.initialize=function(e){var t=no.geometryToGeographicCoordsList(e.geometry);this.geographicCoordListsArray.push(t);var r=t.getMiddleGeographicCoords();this.setGeographicPosition(r),this.centerGeographicCoords=r;var i=e.properties.HEIGHT||e.properties.BLDH_BV,o=e.properties.BLDH_MN;0!==i&&(this.height=i),0!==o&&(this.groundHeight=o)},no.prototype.makeMesh=function(){if(this.dirty&&this.geoLocDataManager){var e=this.geoLocDataManager.getCurrentGeoLocationData();if(e){this.attributes.heightReference!==Ce.NONE&&(e=on.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,e));this.objectsArray=[];for(var t=this.geographicCoordListsArray.length,r=0;r<t;r++){var i=this.geographicCoordListsArray[r];ve.solveDegeneratedPoints(i.geographicCoordsArray,1e-8);var o=i.getCopy();i.setAltitude(0),o.setAltitude(this.height);var n=ve.getPointsRelativeToGeoLocation(e,i.geographicCoordsArray,void 0),a=ve.getPointsRelativeToGeoLocation(e,o.geographicCoordsArray,void 0),s=new Fi;s.newVtxProfile().makeByPoints3DArray(n,void 0),s.newVtxProfile().makeByPoints3DArray(a,void 0);var l=s.getMesh(void 0,!0,!0).getCopySurfaceIndependentMesh();l.calculateVerticesNormals(),this.objectsArray.push(l)}this.setDirty(!1),this.attributes.heightReference!==Ce.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}},no.geometryToGeographicCoordsList=function(e){var t=new ve;if("MultiPolygon"===e.type)for(var r=e.coordinates[0][0],i=r.length-1;i>0;i--){var o=r[i],n=o[0],a=o[1];t.newGeoCoord(n,a,0)}return ve.solveDegeneratedPoints(t.geographicCoordsArray,1e-8),t};var ao=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);t=t||{},this.width=t.width,this.height=t.height,this.position,this.minValue=t.minValue,this.maxValue=t.maxValue,this.colorRampType=t.colorRampType,this.geoLocDataManager,this.vboKeysContainer,this.dirty=!0};ao.prototype.makeMesh=function(e){this.vboKeysContainer||(this.vboKeysContainer=new xt);var t=new Float32Array([0,0,this.width,0,0,this.height,0,this.height,this.width,0,this.width,this.height]);this.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(t,vboMemManager,2),this.dirty=!1},ao.prototype.render=function(e){this.dirty&&this.makeMesh(e);e.postFxShadersManager.getShader("modelRefDepth")};var so=function e(t,r,i){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(!t)throw new Error(Ue.REQUIRED_EMPTY_ERROR("geographicCoordList"))};(so.prototype=Object.create(r.prototype)).constructor=so;var lo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(!t)throw new Error(Ue.REQUIRED_EMPTY_ERROR("MagoManager"));r.call(this),this._guid=qo(),this.geoLocDataManager,this.magoManager=t,this.attributes={isVisible:!0},this.magoRenderables=[],this.hash={},this.dirty=!0,this.masterId};lo.prototype=Object.create(r.prototype),lo.prototype.constructor=lo,lo.prototype.initialize=function(e){for(var t=this.magoManager.scene.globe.terrainProvider,r=t.tilingScheme,i=Fe.getMaximumLevelOfTerrainProvider(t),o={},n=e.length,a=[],s=[],l=[],u={longitude:0,latitude:0,altitude:0},c=0;c<n;c++){var d=e[c],h=Cesium.Cartographic.fromDegrees(d.centerGeographicCoords.longitude,d.centerGeographicCoords.latitude),f=r.positionToTileXY(h,i),g=f.toString();o.hasOwnProperty(g)||(o[g]=t.getTileDataAvailable(f.x,f.y,i)),o[g]?(s.push(d),l.push(h)):(a.push(d),u.longitude=u.longitude+d.centerGeographicCoords.longitude,u.latitude=u.latitude+d.centerGeographicCoords.latitude)}var p=this;return Cesium.sampleTerrain(t,i,l).then(function(e){for(var t=e.length,r=0;r<t;r++){for(var i=e[r],o=void 0===i.height?0:i.height,l=s[r],c=l.geographicCoordListsArray.length,d=0;d<c;d++)l.geographicCoordListsArray[d].setAltitude(l.groundHeight);u.longitude=u.longitude+180*i.longitude/Math.PI,u.latitude=u.latitude+180*i.latitude/Math.PI,u.altitude=u.altitude+o,a.push(l)}return p.setGeographicPosition(new pe(u.longitude/n,u.latitude/n,u.altitude/n)),p.addMagoRenderables(a),p})},lo.prototype.makeMesh=function(){var e=this.magoManager.workersManager.getExtrudeWorkerManager();if(!e.isBusy()&&this.dirty&&this.geoLocDataManager){var t=this.geoLocDataManager.getCurrentGeoLocationData();if(t){var r;this.attributes.heightReference!==Ce.NONE&&(t=on.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,t)),this.objectsArray=[];for(var i=this.magoRenderables.length,o=new Array(i),n=0;n<i;n++){for(var a=this.magoRenderables[n],s={height:a.height},l=[],u=a.geographicCoordListsArray.length,c=0;c<u;c++){var d=a.geographicCoordListsArray[c];l.push(d)}s.geographicCoordsListsArray=l,o[n]=s}var h={guid:this._guid,objectsToExtrudeArray:o,color:J.toArray(this.color4),geoLocation:{longitude:t.geographicCoord.longitude,latitude:t.geographicCoord.latitude,altitude:t.geographicCoord.altitude},rotation:{heading:t.heading,pitch:t.pitch,roll:t.roll}};e.doExtrude(h),r=new kr,this.objectsArray.push(r);var f=this.magoManager.vboMemoryManager,g=this.magoRenderables.length;for(c=0;c<g;c++){if(a.geographicCoordListsArray){for(u=a.geographicCoordListsArray.length,c=0;c<u;c++){(d=a.geographicCoordListsArray[c]).deleteObjects(f),delete a.geographicCoordListsArray[c]}delete a.geographicCoordListsArray}this.magoRenderables[c].deleteObjects(),delete this.magoRenderables[c]}delete this.magoRenderables,this.setDirty(!1),this.attributes.heightReference!==Ce.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}},lo.prototype.makeMesh_original=function(){if(this.dirty&&this.geoLocDataManager){var e=this.geoLocDataManager.getCurrentGeoLocationData();if(e){var t;this.attributes.heightReference!==Ce.NONE&&(e=on.calculateGeoLocationData(void 0,void 0,0,void 0,void 0,void 0,e)),this.objectsArray=[];for(var r=this.magoRenderables.length,i=0;i<r;i++)for(var o=this.magoRenderables[i],n=o.geographicCoordListsArray.length,a=0;a<n;a++){var s=o.geographicCoordListsArray[a],l=s.getCopy();l.addAltitude(o.height);var u=ve.getPointsRelativeToGeoLocation(e,s.geographicCoordsArray,void 0),c=ve.getPointsRelativeToGeoLocation(e,l.geographicCoordsArray,void 0),d=new Fi;d.newVtxProfile().makeByPoints3DArray(u,void 0),d.newVtxProfile().makeByPoints3DArray(c,void 0);var h=d.getMesh(void 0,!0,!0).getCopySurfaceIndependentMesh();h.calculateVerticesNormals(),0!==a||0!==i?t.mergeMesh(h):t=h}this.objectsArray.push(t),delete this.magoRenderables,this.setDirty(!1),this.attributes.heightReference!==Ce.NONE&&this.terrainHeight&&this.setTerrainHeight(this.terrainHeight)}}},lo.prototype.addMagoRenderables=function(e){this.magoRenderables.push.apply(this.magoRenderables,e);for(var t=e.length,r=0;r<t;r++)this.addMagoRenderable(e[r],!0);this.dirty=!0},lo.prototype.addMagoRenderable=function(e,t){this.magoRenderables.push(e),t||(this.dirty=!0)},lo.prototype.render=function(e,t,r,i,o){var n=e.koreaBuildingMaster[this.masterId];if(n&&(void 0===n.show||!1!==n.show)){if(this.dirty&&(this.color4=new J,this.color4.copyFrom(n.color),this.makeMesh(e)),!this.vboFromWorker){var a=e.workersManager.getExtrudeWorkerManager().getResult(this._guid);if(!a)return!1;var s=a.vbosArray[0],l=new xt,u=e.vboMemoryManager,c=l.newVBOVertexIdxCacheKey();c.setDataArrayPos(s.posVboDataArray,u),s.norVboDataArray&&c.setDataArrayNor(s.norVboDataArray,u),s.tcoordVboDataArray&&c.setDataArrayTexCoord(s.tcoordVboDataArray,u),s.colVboDataArray&&c.setDataArrayCol(s.colVboDataArray,u),c.setDataArrayIdx(s.indicesArray,u),this.objectsArray[0].vboKeysContainer=l,this.vboFromWorker=!0}if(!this.objectsArray||0===this.objectsArray.length)return!1;var d=e.getGl();void 0!==this.attributes.opacity&&d.uniform1f(t.externalAlpha_loc,this.attributes.opacity),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(d,t),this.attributes.doubleFace?d.disable(d.CULL_FACE):d.enable(d.CULL_FACE);var h=!0;this.options&&!1===this.options.renderShaded&&(h=!1),d.uniform1i(t.bApplySpecularLighting_loc,!1),h&&this.renderAsChild(e,t,r,i,o,this.options),d.uniform1f(t.externalAlpha_loc,1),d.uniform1i(t.bApplySpecularLighting_loc,!1),d.uniform1i(t.clippingType_loc,0)}};var uo=function e(t,r,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.height=5,void 0!==t&&(this.intRadius=t),void 0!==r&&(this.extRadius=r),void 0!==i&&(this.height=i),this.dirty=!0,this.mesh,this.geoLocDataManager,this.color4,void 0!==o){var n=o.color;n&&(this.color4=new J,this.color4.setRGBA(n.r,n.g,n.b,n.a))}};uo.prototype.makeMesh=function(){var e,t=new ii;(e=t.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),e.setRadius(this.extRadius),(e=t.newInnerRing().newElement("CIRCLE")).setCenterPosition(0,0),e.setRadius(this.intRadius);var r=this.height;this.mesh=jr.getExtrudedMesh(t,r,1,void 0,!0,!0,void 0),this.dirty=!1},uo.prototype.render=function(e,t,r,i){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=e.getGl();if(this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,t),o.uniform1i(t.refMatrixType_loc,0),0===r);else if(1===r){o.enable(o.BLEND),o.uniform1i(t.colorType_loc,0),e.selectionManager.isObjectSelected(this)?(o.disable(o.BLEND),o.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])):o.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a])}this.mesh.render(e,t,r,i)};var co=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.owner=void 0,this.name,this.id,this.size=1,this.color4,this.strokeColor4,this.opacity=1,this.vertexList,this.vboKeysContainer,t){if(t.size&&(this.size=t.size),t.color)if("string"==typeof t.color){var r=J.fromHexCode(t.color,void 0);this.color4=r}else this.color4=t.color;if(t.strokeColor)if("string"==typeof t.strokeColor){r=J.fromHexCode(t.strokeColor,void 0);this.strokeColor4=r}else this.strokeColor4=t.strokeColor;t.opacity&&(this.opacity=t.opacity)}};co.prototype.renderAsChild=function(e,t,r,i,o,n){var a=e.getGl();a.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),a.uniform1f(t.fixPointSize_loc,this.size),o&&a.uniform1f(t.fixPointSize_loc,2*this.size);var s=this.strokeColor4;if(s&&a.uniform4fv(t.uStrokeColor_loc,new Float32Array([s.r,s.g,s.b,s.a])),e.isCameraMoved&&!e.isCameraMoving){var l=e.selectionManager,u=e.selectionColor,c=u.getAvailableColor(void 0),d=u.decodeColor3(c.r,c.g,c.b),h=this;this.owner&&(h=this.owner),l.setCandidateGeneral(d,h),a.uniform4fv(t.uSelColor4_loc,[c.r/255,c.g/255,c.b/255,1])}var f=this.vboKeysContainer.vboCacheKeysArray[0];if(!f.bindDataPosition(t,e.vboMemoryManager))return!1;a.drawArrays(a.POINTS,0,f.vertexCount)},co.prototype.deleteObjects=function(e){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(e.gl,e),this.vboKeysContainer=void 0)};var ho=function e(t){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.setDirty(!1)};ho.prototype=Object.create(r.prototype),ho.prototype.constructor=ho,ho.prototype.makeMesh=function(){};var fo=function(e){this.modelMesh};fo.prototype.init_TEST=function(){};var go=function(){this.point2dArray=[],this.repository={},this.bubbleHeightRatio=.75};go.prototype.makeDefault=function(e){var t=e[0],r=e[1],i=t>r?r:t,o=.05*i,n=this.bubbleHeightRatio*r,a=.2*t,s=.5*t,l=.2*i;function u(e,t,r,i,o){var n=[e,t];return i&&o&&(n.push(i),n.push(o)),{point:n,command:r}}this.point2dArray[0]=u(s,r-o,"moveTo"),this.point2dArray[1]=u(s+a/2,n,"lineTo"),this.point2dArray[2]=u(t-l,n,"lineTo"),this.point2dArray[3]=u(t-o,n,"quadraticCurveTo",t-o,n-l),this.point2dArray[4]=u(t-o,l,"lineTo"),this.point2dArray[5]=u(t-o,o,"quadraticCurveTo",t-l,o),this.point2dArray[6]=u(l,o,"lineTo"),this.point2dArray[7]=u(o,o,"quadraticCurveTo",o,l),this.point2dArray[8]=u(o,n-l,"lineTo"),this.point2dArray[9]=u(o,n,"quadraticCurveTo",l,n),this.point2dArray[10]=u(s-a/2,n,"lineTo")},go.getImage=function(e,t){t.speechBubble||(t.speechBubble=new Mago3D.SpeechBubble);var r=t.speechBubble;if(e){var i=e.width,o=e.height,n=e.commentTextOption,a=e.bubbleColor,s=J.getHexCode(a.r,a.g,a.b);return r.getPng([i,o],s,n)}},go.getTextAreaSize=function(e,t){if(!e||!t)return!1;for(var r,i=e.split("\n"),o=i.length,n=0,a=0;a<o;a++){var s=i[a];if(s.length>0){var l=t.measureText(s);r||(r=l.fontBoundingBoxAscent+l.fontBoundingBoxDescent),l.width>n&&(n=l.width)}}return[n,1.5*r*o]},go.prototype.getPng=function(e,t,r){var i=[];i.push(e),i.push(t),i.push(r);var o,n,a,s,l,u,c=JSON.stringify(i);if(this.repository[c])return this.repository[c].toDataURL();if(r){var d=document.createElement("canvas");o=d.getContext("2d"),n=r.text,a=Zo(r.pixel,10),s=Zo(r.font,"Dotum"),l=Zo(r.color,"white"),u=Zo(r.borderColor,"black"),o.font="bold "+a+"px "+s,o.fillStyle=l,o.strokeStyle=u,o.textAlign="center"}var h=go.getTextAreaSize(n,o);e[0]<h[0]&&(e[0]=1.15*h[0]);var f=h[1]/this.bubbleHeightRatio;e[1]<f&&(e[1]=f),this.makeDefault(e);var g=function(e,t,r,i,c){d||(d=document.createElement("canvas"));var h=e[0],f=e[1];d.width=h,d.height=f,(o=d.getContext("2d")).save(),o.fillStyle=r,o.strokeStyle="#000000",o.lineWidth=2,o.beginPath();for(var g=c.length,p=0;p<g;p++){var m=c[p];2===m.point.length?o[m.command].call(o,m.point[0],m.point[1]):o[m.command].call(o,m.point[0],m.point[1],m.point[2],m.point[3])}if(o.closePath(),o.fill(),o.stroke(),i){n=i.text,a=Zo(i.pixel,10),s=Zo(i.font,"Dotum"),l=Zo(i.color,"white"),u=Zo(i.borderColor,"black"),o.font="bold "+a+"px "+s,o.fillStyle=l,o.strokeStyle=u,o.textAlign="center";for(var v=n.split("\n"),x=v.length,_=f*t,y=.95*_/(x+1),T=0;T<x;T++){var C=v[T];if(C.length>0){var b=o.measureText(C),M=y*(T+1.5);o.fillText(C,.5*h,M,b.width)}}}return o.restore(),d}(e,this.bubbleHeightRatio,t,r,this.point2dArray);return this.repository[c]=g,g.toDataURL()};var po=function e(t){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.geoCoordSegment=t};po.prototype=Object.create(r.prototype),po.prototype.constructor=po,po.prototype.makeMesh=function(e){var t=me.getArcInterpolatedGeoCoords(this.geoCoordSegment.strGeoCoord,this.geoCoordSegment.endGeoCoord,1500,void 0),r=ve.getRenderableObjectOfGeoCoordsArray(t,e,{color:"#ffff00",thickness:2});void 0===this.objectsArray&&(this.objectsArray=[]),this.objectsArray.push(r),this.setDirty(!1)};var mo=function e(t){if(r.call(this,t),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.height,this.point2DList,void 0!==t&&(void 0!==t.points2dArray&&(void 0===this.point2DList&&(this.point2DList=new Zr),this.point2DList.pointsArray=t.points2dArray),void 0!==t.height&&(this.height=t.height))};(mo.prototype=Object.create(r.prototype)).constructor=mo,mo.prototype.makeMesh=function(){for(var e=new ii,t=e.newOuterRing().newElement("POLYLINE"),r=this.point2DList.getPointsCount(),i=0;i<r;i++){var o=this.point2DList.getPoint(i);t.newPoint2d(o.x,o.y)}var n=this.height;void 0===this.objectsArray&&(this.objectsArray=[]);var a=jr.getExtrudedMesh(e,n,1,void 0,!0,!0,void 0);this.objectsArray.push(a),this.dirty=!1};var vo=function e(t,i,o,n){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.height=5,void 0!==t&&(this.intRadius=t),void 0!==i&&(this.extRadius=i),void 0!==o&&(this.height=o),this.dirty=!0,this.mesh,this.bbox,this.geoLocDataManager,this.color4,void 0!==n){var a=n.color;a&&(this.color4=new J,this.color4.setRGBA(a.r,a.g,a.b,a.a));var s=n.selectedColor;s&&(this.selectedColor4=new J,this.selectedColor4.setRGBA(s.r,s.g,s.b,s.a))}};vo.prototype=Object.create(r.prototype),vo.prototype.constructor=vo,vo.prototype.getBoundingBox=function(){if(void 0===this.bbox){this.bbox=new G;var e=this.extRadius;e<this.intRadius&&(e=this.intRadius),this.bbox.set(-e,-e,0,e,e,this.height)}return this.bbox},vo.prototype.makeMesh=function(){var e,t=new ii;(e=t.newOuterRing().newElement("CIRCLE")).setCenterPosition(0,0),e.setRadius(this.extRadius),(e=t.newInnerRing().newElement("CIRCLE")).setCenterPosition(0,0),e.setRadius(this.intRadius);var r=this.height,i=jr.getExtrudedMesh(t,r,1,void 0,!0,!0,void 0);this.objectsArray.push(i),this.dirty=!1};var xo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.name,this.id,this.thickness=1,this.color4,this.vertexList,this.vboKeysContainer,t&&(t.thickness&&(this.thickness=t.thickness),t.color))if("string"==typeof t.color){var r=J.fromHexCode(t.color,void 0);this.color4=r}else this.color4=t.color};xo.prototype.renderAsChild=function(e,t,r,i,o,n){var a=!0,s=e.getGl();n&&void 0!==n.depthMask&&(a=n.depthMask),s.depthMask(a),this.render(e,t,r,i,o),s.depthMask(!0)},xo.prototype.render=function(e,t,r,i,o){if(void 0!==this.vboKeysContainer){var n=this.vboKeysContainer.getVboKey(0),a=e.getGl();a.enable(a.CULL_FACE),a.enableVertexAttribArray(t.prev_loc),a.enableVertexAttribArray(t.current_loc),a.enableVertexAttribArray(t.next_loc),a.disableVertexAttribArray(t.color4_loc);var s=e.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),u=s.drawingBufferHeight;void 0===this.thickness&&(this.thickness=2),a.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),a.uniform2fv(t.viewport_loc,[l[0],u[0]]),a.uniform1f(t.thickness_loc,this.thickness);var c=n.vboBufferPos,d=c.dataDimensions;if(c.isReady(a,e.vboMemoryManager)){if(n.vboBufferCol){if(!n.bindDataColor(t,e.vboMemoryManager))return;a.uniform1i(t.colorType_loc,1)}else a.uniform1i(t.colorType_loc,0),a.disableVertexAttribArray(t.color4_loc);a.bindBuffer(a.ARRAY_BUFFER,c.key),a.vertexAttribPointer(t.prev_loc,d,a.FLOAT,!1,8,0),a.vertexAttribPointer(t.current_loc,d,a.FLOAT,!1,8,16),a.vertexAttribPointer(t.next_loc,d,a.FLOAT,!1,8,48),a.drawArrays(a.TRIANGLE_STRIP,0,n.vertexCount-4)}}},xo.prototype.deleteObjects=function(e){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(e.gl,e),this.vboKeysContainer=void 0)};var _o=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.name,this.id,this.thickness=1,this.color4,this.vertexList,this.vboKeysContainer,t&&(t.thickness&&(this.thickness=t.thickness),t.color))if("string"==typeof t.color){var r=J.fromHexCode(t.color,void 0);this.color4=r}else this.color4=t.color};_o.prototype.renderAsChild=function(e,t,r,i,o,n){var a=!0,s=e.getGl();n&&void 0!==n.depthMask&&(a=n.depthMask),s.depthMask(a),this.render(e,t,r,i,o),s.depthMask(!0)},_o.prototype.render=function(e,t,r,i,o){if(void 0!==this.vboKeysContainer){var n=this.vboKeysContainer.getVboKey(0),a=e.getGl();a.enableVertexAttribArray(t.prev_loc),a.enableVertexAttribArray(t.current_loc),a.enableVertexAttribArray(t.next_loc),a.disableVertexAttribArray(t.color4_loc);var s=e.sceneState,l=(s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth),u=s.drawingBufferHeight;void 0===this.thickness&&(this.thickness=2),1===r&&a.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),a.uniform2fv(t.viewport_loc,[l[0],u[0]]),a.uniform1f(t.thickness_loc,this.thickness);var c=n.vboBufferPos,d=c.dataDimensions;if(c.isReady(a,e.vboMemoryManager)){if(n.vboBufferCol){if(!n.bindDataColor(t,e.vboMemoryManager))return;a.uniform1i(t.colorType_loc,1),a.enableVertexAttribArray(t.color4_loc)}else a.uniform1i(t.colorType_loc,0),a.disableVertexAttribArray(t.color4_loc);a.bindBuffer(a.ARRAY_BUFFER,c.key),a.vertexAttribPointer(t.prev_loc,d,a.FLOAT,!1,0,0),a.vertexAttribPointer(t.current_loc,d,a.FLOAT,!1,0,32),a.vertexAttribPointer(t.next_loc,d,a.FLOAT,!1,0,64),a.drawArrays(a.TRIANGLE_STRIP,0,n.vertexCount-4)}}},_o.prototype.deleteObjects=function(e){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(e.gl,e),this.vboKeysContainer=void 0)},_o.getVectorMeshFromPoints3dLCArray=function(e,t,i,o){if(e&&!(e.length<2)){void 0===o&&(o={}),void 0===o.thickness&&(o.thickness=2),void 0===o.color&&(o.color=new J(.8,1,1,1)),e.reverse();var n=new yo(o);n.vboKeysContainer=Qr.getVboThickLines(i,e,n.vboKeysContainer,o),n.geoLocDataManager=new ye,n.geoLocDataManager.addGeoLocationData(t),n.objectType=r.OBJECT_TYPE.VECTORMESH;for(var a=e.length,s=new Float32Array(4*a),l=0;l<4*a;l++)s[l]=l.toFixed(0);var u=n.vboKeysContainer.getVboKey(0),c=i.vboMemoryManager;return u.setDataArrayCustom(s,c,1,"indices",4),n}},_o.getVectorMeshItineraryFromPoints3dLCArray=function(e,t,i,o){if(e&&!(e.length<2)){void 0===o&&(o={}),void 0===o.thickness&&(o.thickness=2),void 0===o.color&&(o.color=new J(.8,1,1,1)),e.reverse();var n=new _o(o);n.vboKeysContainer=Qr.getVboThickLines(i,e,n.vboKeysContainer,o),n.geoLocDataManager=new ye,n.geoLocDataManager.addGeoLocationData(t),n.objectType=r.OBJECT_TYPE.VECTORMESH;for(var a=e.length,s=new Float32Array(4*a),l=0;l<4*a;l++)s[l]=l.toFixed(0);var u=n.vboKeysContainer.getVboKey(0),c=i.vboMemoryManager;return u.setDataArrayCustom(s,c,1,"indices",4),n}};var yo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.name,this.id,this.thickness=1,this.color4,this.vertexList,this.vboKeysContainer,t&&(t.thickness&&(this.thickness=t.thickness),t.color))if("string"==typeof t.color){var r=J.fromHexCode(t.color,void 0);this.color4=r}else this.color4=t.color};yo.prototype.renderAsChild=function(e,t,r,i,o,n){var a=!0,s=e.getGl();n&&void 0!==n.depthMask&&(a=n.depthMask),s.depthMask(a),this.render(e,t,r,i,o),s.depthMask(!0)},yo.prototype.render=function(e,t,r){if(void 0!==this.vboKeysContainer){var i=this.vboKeysContainer.getVboKey(0),o=e.getGl(),n=1,a=1;r&&(void 0!==r.animationState&&(n=r.animationState),void 0!==r.animationSpeed&&(a=r.animationSpeed)),o.disableVertexAttribArray(t.color4_loc);var s=e.sceneState;s.projectionMatrix,s.modelViewMatrix,s.drawingBufferWidth,s.drawingBufferHeight;void 0===this.thickness&&(this.thickness=2),o.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,this.color4.a]),o.uniform1f(t.thickness_loc,this.thickness);var l=i.vboBufferPos,u=l.dataDimensions;if(l.isReady(o,e.vboMemoryManager)){if(i.vboBufferCol){if(!i.bindDataColor(t,e.vboMemoryManager))return;o.uniform1i(t.colorType_loc,1),o.enableVertexAttribArray(t.color4_loc)}else o.uniform1i(t.colorType_loc,0),o.disableVertexAttribArray(t.color4_loc);void 0===this.phase&&(this.phase=i.vertexCount-4,this.currElemIdx=i.vertexCount-4,this.vertexToDrawCount=200),o.bindBuffer(o.ARRAY_BUFFER,l.key),o.vertexAttribPointer(t.prev_loc,u,o.FLOAT,!1,16,0),o.vertexAttribPointer(t.current_loc,u,o.FLOAT,!1,16,32),o.vertexAttribPointer(t.next_loc,u,o.FLOAT,!1,16,64),i.bindDataCustom(t,e.vboMemoryManager,"indices");var c=i.vertexCount-4<400?i.vertexCount-4:400;if(1===n)if(this.phase<0)this.currElemIdx=0,this.vertexToDrawCount=c+this.phase;else{this.currElemIdx=this.phase;var d=i.vertexCount-4-this.currElemIdx;this.vertexToDrawCount=d>c?c:d}if(this.vertexToDrawCount<4)return this.phase-=a,void(this.phase<=1-c&&(this.finished=!0));o.uniform1i(t.uElemIndex_loc,this.currElemIdx),o.uniform1i(t.uTotalPointsCount_loc,this.vertexToDrawCount),o.drawArrays(o.TRIANGLE_STRIP,this.currElemIdx,this.vertexToDrawCount),1===n&&(this.phase-=a,this.phase<=1-c&&(this.finished=!0))}}},yo.prototype.deleteObjects=function(e){void 0!==this.vboKeysContainer&&(this.vboKeysContainer.deleteGlObjects(e.gl,e),this.vboKeysContainer=void 0),this.name=void 0,this.id=void 0,this.thickness=void 0,this.color4&&(this.color4.deleteObjects(),this.color4=void 0),this.vertexList&&(this.vertexList.deleteObjects(),this.vertexList=void 0)};var To=function e(t,i,o,n){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.PARALLEL_ROTATION_ANGLE=90,this.frame,this.frontArrow,this.rearArrow,this.frontArrowPos,this.rearArrowPos,this.width=t,this.length=i,this.height=o,this.wheelbase=.8*i,this.rearAngleDeg=0,this.frontAngleDeg=0,this.isDrawArrow=!0,this.eventStatus={changingFrontArrow:!1,changingRearArrow:!1,footOnAccel:!1},this.mode=Yi.MODE.NORMAL,this.accelStatus=Yi.ACCEL_STATUS.FORWARD,this.changingFrontArrowType=0,this.changingFrontArrowSpeed=.4,this.changingRearArrowType=0,this.changingRearArrowSpeed=.4,this.maxSpeed=12,this.frontCurrentSpeed=0,this.frontAcceleration=4,this.frontDeacceleration=3.8,this.rearCurrentSpeed=0,this.rearAcceleration=4,this.rearDeacceleration=3.8,this.pivotPointLC,this.isParallelDirection=!1,this.guidePoint=new Qr,this.auxOffsetVector,this.parallelRotationDist=10,this.frame,this.carriedObjectsArray=[],this.shimmyMatDimension=new Kr(.7*this.width,this.wheelbase),this.shimmyMat=new Kr(2,2);for(this.trajectoryLength=2*this.length,this.frontTrajectoryPointList=new Qr,this.rearTrajectoryPointList=new Qr;50!==this.frontTrajectoryPointList.getPointsCount();)this.frontTrajectoryPointList.newPoint();for(;50!==this.rearTrajectoryPointList.getPointsCount();)this.rearTrajectoryPointList.newPoint();this.objectsArray.push(this.frontTrajectoryPointList),this.objectsArray.push(this.rearTrajectoryPointList)};(To.prototype=Object.create(r.prototype)).constructor=To,To.prototype.addToContainer=function(e,t){this.carriedObjectsArray.push(e),this.updateContainer(t)},To.prototype.updateContainer=function(e){for(var t=this.geoLocDataManager.getCurrentGeoLocationData(),r=t.getGeographicCoords(),i=0,o=this.carriedObjectsArray.length;i<o;i++){var n=this.carriedObjectsArray[i];if(n instanceof lr){n.data.mapping_type="boundingboxcenter";n.data.geoLocDataManager.getCurrentGeoLocationData();var a=t.heading,s=n.data.bbox.getZLength()/2;n.changeLocationAndRotation(r.latitude,r.longitude,r.altitude+this.height+s,a,void 0,void 0,e)}}},To.prototype.render=function(e,t,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&(this.makeMesh(),this.arrowDirectionChanged(e)),void 0===this.objectsArray)return!1;var o=e.getGl();this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,t),o.uniform4fv(t.oneColor4_loc,[0,1,0,1]),this.changeArrow(e),this.move(e),o.uniform1i(t.refMatrixType_loc,0);var n=!1;if(0===r);else if(1===r){e.selectionManager.isObjectSelected(this)&&(n=!0),o.enable(o.BLEND),o.uniform1i(t.bApplySsao_loc,!0),o.uniform1i(t.colorType_loc,0),this.color4&&o.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])}n&&(void 0===this.selColor4&&(this.selColor4=new J,this.selColor4.setRGBA(.8,.4,.5,1)),o.uniform4fv(t.oneColor4_loc,[this.selColor4.r,this.selColor4.g,this.selColor4.b,1])),t.enableVertexAttribArray(t.position3_loc),this.guidePoint.renderAsChild(e,t,r,i),t.enableVertexAttribArray(t.normal3_loc);for(var a=this.objectsArray.length,s=0;s<a;s++){this.objectsArray[s].renderAsChild(e,t,r,i,n)}o.disable(o.BLEND)}},To.prototype.renderAsChild=function(e,t,r,i){},To.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]);var e=this.width,t=this.length,r=.15*this.height,i=new qi(e,t,r,"frame");i.setOneColor(196/255,117/255,0,1);var o=new Jr(0,0,this.height-r);i.tMatOriginal=new Ne,i.tMatOriginal.setTranslation(o.x,o.y,o.z),this.objectsArray.push(i),this.frame=i;var n=.4*e,a=.4*t,s={totalLength:a,bodyWidth:.5*n,headWidth:n,tailLength:.6*a,extrude:.1*r},l=new Wi(n,a,.5,s),u=new Wi(n,a,.5,s);this.objectsArray.push(l),this.frontArrow=l,this.frontArrow.setOneColor(.9,.1,.1,1),this.frontArrowPos=new Jr(0,.5*this.wheelbase,this.height),l.tMatOriginal=new Ne,l.tMatOriginal.setTranslation(this.frontArrowPos.x,this.frontArrowPos.y,this.frontArrowPos.z),this.objectsArray.push(u),this.rearArrow=u,this.rearArrowPos=new Jr(0,.5*-this.wheelbase,this.height),u.tMatOriginal=new Ne,u.tMatOriginal.setTranslation(this.rearArrowPos.x,this.rearArrowPos.y,this.rearArrowPos.z);var c=.25*this.width,d=this.height-r,h=this.getShimmyGearAssembly();this.shimmyGearAssembly=new h(c,.5,d),this.shimmyGearAssembly.setOneColor(196/255,117/255,0,1),this.shimmyGearAssembly.tMatOriginal=new Ne,this.shimmyGearAssembly.tMatOriginal.setTranslation(0,0,d),this.shimmyGearAssembly.makeMesh();for(var f=this.shimmyMat.x,g=this.shimmyMat.y,p=this.shimmyMatDimension.x/(f-1),m=this.shimmyMatDimension.y/(g-1),v=0;v<f;v++)for(var x=0;x<g;x++){var _=new h(c,.5,d);_.frame=this.shimmyGearAssembly.frame,_.rightWheel=this.shimmyGearAssembly.rightWheel,_.leftWheel=this.shimmyGearAssembly.leftWheel,_.color4=this.shimmyGearAssembly.color4,_.makeMesh();var y=m*x,T=new Jr(p*v-.5*this.shimmyMatDimension.x,y-.5*this.shimmyMatDimension.y,d);_.tMatOriginal=new Ne,_.tMatOriginal.setTranslation(T.x,T.y,T.z),_.orginShimmyPos=T,this.objectsArray.push(_)}this.updateMatrix(),this.setDirty(!1)},To.prototype.doChangeFrontAngleDeg=function(e){this.eventStatus.changingFrontArrow=!0,this.changingFrontArrowType="left"===e?0:1},To.prototype.stopChangeFrontAngleDeg=function(){this.eventStatus.changingFrontArrow=!1},To.prototype.doChangeRearAngleDeg=function(e){this.eventStatus.changingRearArrow=!0,this.changingRearArrowType="left"===e?0:1},To.prototype.stopChangeRearAngleDeg=function(){this.eventStatus.changingRearArrow=!1},To.prototype._updateLastTime=function(e){this.lastTime=e},To.prototype.moveParallelTranslate=function(e,t){var r=this.geoLocDataManager.newGeoLocationData(),i=r.geographicCoord,o=this.frontDirection2D;this.accelStatus===Yi.ACCEL_STATUS.REVERSE&&((o=new Kr).copyFrom(this.frontDirection2D),o.inverse());var n=new Jr(o.x,o.y,0),a=new Jr(n.x*this.frontCurrentSpeed*e,n.y*this.frontCurrentSpeed*e,n.z*this.frontCurrentSpeed*e),s=r.rotMatrix.rotatePoint3D(a),l=new Float32Array(3),u=new Float32Array(3);u[0]=r.positionLOW[0]+s.x,u[1]=r.positionLOW[1]+s.y,u[2]=r.positionLOW[2]+s.z,l[0]=r.positionHIGH[0],l[1]=r.positionHIGH[1],l[2]=r.positionHIGH[2];var c=r.localCoordToWorldCoord(a);i=on.pointToGeographicCoord(c,i),r=on.calculateGeoLocationDataByAbsolutePoint(u[0]+l[0],u[1]+l[1],u[2]+l[2],r,t)},To.prototype.moveCircularRotation=function(e,t){if(this.pivotPointLC){var r=this.geoLocDataManager.newGeoLocationData(),i=(r.geographicCoord,this.frontArrowPos),o=this.rearArrowPos,n=this.frontLine2D,a=(this.rearLine2D,this.frontDirection2D),s=this.rearDirection2D;this.auxOffsetVector||(this.auxOffsetVector=new Jr(0,0,0));var l=this.frontCurrentSpeed,u=l*e,c=new Jr(i.x,i.y,0);c.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);var d=this.pivotPointLC.distToPoint(i);if(d<.001)return this._updateLastTime(void 0),void(this.frontCurrentSpeed=0);var h=u/d;n.getRelativeSideOfPoint(this.pivotPointLC)===I.relativePosition2D.RIGHT&&(h*=-1),this.accelStatus===Yi.ACCEL_STATUS.REVERSE&&(h*=-1);var f=new Ne;f.rotationAxisAngRad(h,0,0,1);var g=f.rotatePoint3D(c),p=new Jr(g.x,g.y,g.z);p.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);s.scalarProduct(a);var m=new Jr(o.x,o.y,0);m.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);this.pivotPointLC.distToPoint(o);var v=h,x=new Ne;x.rotationAxisAngRad(v,0,0,1);var _=x.rotatePoint3D(m),y=new Jr(_.x,_.y,_.z);y.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);var T=new Jr((p.x+y.x)/2,(p.y+y.y)/2,0),C=new mi(y,p).getDirection(),b=new Kr(0,1),M=C.angleDegToVector(b);C.x>0&&(M*=-1);var A=r.rotMatrix,E=new Float32Array(3),L=new Float32Array(3),w=A.rotatePoint3D(T);L[0]=r.positionLOW[0]+w.x,L[1]=r.positionLOW[1]+w.y,L[2]=r.positionLOW[2]+w.z,E[0]=r.positionHIGH[0],E[1]=r.positionHIGH[1],E[2]=r.positionHIGH[2],void 0===r.heading&&(r.heading=0),M=r.heading+M;var S=new Jr(L[0]+E[0],L[1]+E[1],L[2]+E[2]),D=on.pointToGeographicCoord(S);D.altitude=0,r=on.calculateGeoLocationData(D.longitude,D.latitude,D.altitude,Yi.degreeValidator(M),r.pitch,r.roll,r,t),this.update(t)}},To.prototype.changeParallelRotationDist=function(e){0===e?this.parallelRotationDist-=.1:this.parallelRotationDist+=.1},To.prototype.moveNormal=function(e,t){this.isParallelDirection?this.moveParallelTranslate(e,t):this.moveCircularRotation(e,t)},To.prototype.moveParallelRotation=function(e,t){var r=this.geoLocDataManager.newGeoLocationData(),i=(r.geographicCoord,this.frontArrowPos),o=this.rearArrowPos,n=this.frontDirection2D,a=this.rearDirection2D,s=new mi(new Kr(i.x,i.y),new Kr(i.x+n.x,i.y+n.y)),l=new mi(new Kr(o.x,o.y),new Kr(o.x+a.x,o.y+a.y));this.frontLine2D=s.getLine(),this.rearLine2D=l.getLine();var u=this.frontLine2D;this.rearLine2D;this.pivotPointLC||(this.pivotPointLC=new Jr),this.setPivotPointLC(0,this.parallelRotationDist,0,t),this.guidePoint.deleteObjects(t),this.guidePoint.addPoint(new Jr(this.pivotPointLC.x,this.pivotPointLC.y,2.2));var c=new Kr(this.pivotPointLC.x,this.pivotPointLC.y);c.inverse(),this.auxOffsetVector=c;var d=this.frontCurrentSpeed,h=d*e,f=new Jr(i.x,i.y,0);f.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);var g=this.pivotPointLC.distToPoint(i);if(g<.001)return this._updateLastTime(void 0),void(this.frontCurrentSpeed=0);var p=h/g;u.getRelativeSideOfPoint(this.pivotPointLC)===I.relativePosition2D.RIGHT&&(p*=-1),this.accelStatus===Yi.ACCEL_STATUS.REVERSE&&(p*=-1);var m=new Ne;m.rotationAxisAngRad(p,0,0,1);var v=m.rotatePoint3D(f),x=new Jr(v.x,v.y,v.z);x.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);this.parallelRotationDist,this.wheelbase,h=this.parallelRotationDist-.5*this.wheelbase;var _=new Jr(o.x,o.y,0);_.add(this.auxOffsetVector.x,this.auxOffsetVector.y,0);this.pivotPointLC.distToPoint(o);var y=p,T=new Ne;T.rotationAxisAngRad(y,0,0,1);var C=T.rotatePoint3D(_),b=new Jr(C.x,C.y,C.z);b.add(-this.auxOffsetVector.x,-this.auxOffsetVector.y,0);var M=new Jr((x.x+b.x)/2,(x.y+b.y)/2,0),A=new mi(b,x).getDirection(),E=new Kr(0,1),L=A.angleDegToVector(E);A.x>0&&(L*=-1);var w=r.rotMatrix,S=new Float32Array(3),D=new Float32Array(3),R=w.rotatePoint3D(M);D[0]=r.positionLOW[0]+R.x,D[1]=r.positionLOW[1]+R.y,D[2]=r.positionLOW[2]+R.z,S[0]=r.positionHIGH[0],S[1]=r.positionHIGH[1],S[2]=r.positionHIGH[2],void 0===r.heading&&(r.heading=0),L=r.heading+L;var P=new Jr(D[0]+S[0],D[1]+S[1],D[2]+S[2]),F=on.pointToGeographicCoord(P);F.altitude=0,r=on.calculateGeoLocationData(F.longitude,F.latitude,F.altitude,Yi.degreeValidator(L),r.pitch,r.roll,r,t),this.update(t)},To.prototype.move=function(e){if(void 0!==this.renderingFase&&null!==this.renderingFase||(this.renderingFase=e.renderingFase),this.renderingFase!==e.renderingFase&&(this.eventStatus.footOnAccel||0!==this.frontCurrentSpeed)){var t=e.getCurrentTime();this.lastTime||this._updateLastTime(t);var r=(t-this.lastTime)/1e3;if(0!==r){var i=this.eventStatus.footOnAccel?this.frontAcceleration:-this.frontDeacceleration;switch(this.frontCurrentSpeed=function(e,t,r){(r+=t*e)<0&&(r=0);return r}(r,i,this.frontCurrentSpeed),this.frontCurrentSpeed>this.maxSpeed&&(this.frontCurrentSpeed=this.maxSpeed),this.mode){case Yi.MODE.NORMAL:this.moveNormal(r,e);break;case Yi.MODE.CIRCULAR_ROTATION:this.moveCircularRotation(r,e);break;case Yi.MODE.PARALLEL_TRANSLATE:this.moveParallelTranslate(r,e);break;case Yi.MODE.PARALLEL_ROTATION:this.moveParallelRotation(r,e)}var o=this.geoLocDataManager.getCurrentGeoLocationData().geographicCoord,n=this.smartTileOwner,a=o.longitude,s=o.latitude;if(!n.intersectPoint(a,s)){n.eraseObjectByComparision(this,"name");var l=n.depth;e.smartTileManager.putObject(l,this,e)}0!==this.frontCurrentSpeed||this.eventStatus.footOnAccel||(t=void 0),this._updateLastTime(t),this.renderingFase=!this.renderingFase,this.updateContainer(e)}}},To.prototype.getFrameDirection2D=function(e){e||(e=new Kr);var t=this.geoLocDataManager.getCurrentGeoLocationData().heading*Math.PI/180;return e.set(-Math.sin(t),Math.cos(t)),e},To.prototype.getFrontDirection2D=function(e){e||(e=new Kr);var t=this.frontAngleDeg*Math.PI/180;return e.set(-Math.sin(t),Math.cos(t)),e},To.prototype.getRearDirection2D=function(e){e||(e=new Kr);var t=this.rearAngleDeg*Math.PI/180;return e.set(-Math.sin(t),Math.cos(t)),e},To.prototype.footOnAccel=function(){this.eventStatus.footOnAccel=!0,this.accelStatus=Yi.ACCEL_STATUS.FORWARD},To.prototype.footOnReverseAccel=function(){this.eventStatus.footOnAccel=!0,this.accelStatus=Yi.ACCEL_STATUS.REVERSE},To.prototype.footOffAccel=function(){this.eventStatus.footOnAccel=!1},To.prototype.arrowDirectionChanged=function(e){this.update(e);var t=this.frontDirection2D,r=this.rearDirection2D;if(this.isParallelDirection=t.isParallelToPoint(r,.1),this.isParallelDirection)this.linearTrajectory(),this.frontTrajectoryPointList.deleteVboKeysContainer(e),this.rearTrajectoryPointList.deleteVboKeysContainer(e);else{var i=this.frontArrowPos,o=this.rearArrowPos,n=new mi(new Kr(i.x,i.y),new Kr(i.x+t.x,i.y+t.y)),a=new mi(new Kr(o.x,o.y),new Kr(o.x+r.x,o.y+r.y));this.frontLine2D=n.getLine(),this.rearLine2D=a.getLine();var s=this.frontLine2D,l=this.rearLine2D,u=s.getPerpendicularRight(),c=l.getPerpendicularRight(),d=u.intersectionWithLine(c);if(!d)return;this.setPivotPointLC(d.x,d.y,0,e),this.guidePoint.deleteObjects(e),this.guidePoint.addPoint(new Jr(this.pivotPointLC.x,this.pivotPointLC.y,2.2));var h=new Kr(d.x,d.y);h.inverse(),this.auxOffsetVector=h}},To.prototype.changeArrow=function(e){var t=!1,r=this.mode;switch(r){case Yi.MODE.NORMAL:if(this.eventStatus.changingFrontArrow){var i=this.changingFrontArrowSpeed;this.changingFrontArrowType>0&&(i=-i),this.frontAngleDeg=this.frontAngleDeg+i,this.frontAngleDeg=Yi.degreeValidator(this.frontAngleDeg),t=!0}if(this.eventStatus.changingRearArrow){i=this.changingRearArrowSpeed;this.changingRearArrowType>0&&(i=-i),this.rearAngleDeg=this.rearAngleDeg+i,this.rearAngleDeg=Yi.degreeValidator(this.rearAngleDeg),t=!0}break;case Yi.MODE.CIRCULAR_ROTATION:case Yi.MODE.PARALLEL_TRANSLATE:if(this.eventStatus.changingFrontArrow||this.eventStatus.changingRearArrow){i=this.changingFrontArrowSpeed;(this.eventStatus.changingFrontArrow?this.changingFrontArrowType:this.changingRearArrowType)>0&&(i=-i),this.frontAngleDeg=this.frontAngleDeg+i,this.rearAngleDeg=r===Yi.MODE.CIRCULAR_ROTATION?-this.frontAngleDeg:this.frontAngleDeg,t=!0}break;case Yi.MODE.PARALLEL_ROTATION:this.frontAngleDeg=this.PARALLEL_ROTATION_ANGLE,this.rearAngleDeg=this.PARALLEL_ROTATION_ANGLE,t=!0}t&&this.arrowDirectionChanged(e)},To.prototype.update=function(e){var t=this.frontArrow,r=new Ne;r.setTranslation(this.frontArrowPos.x,this.frontArrowPos.y,this.frontArrowPos.z);var i=new Ne;i.rotationAxisAngDeg(this.frontAngleDeg,0,0,1),this.frontDirection2D=this.getFrontDirection2D();var o=i.getMultipliedByMatrix(r);t.tMatOriginal=o;var n=this.rearArrow,a=new Ne;a.setTranslation(this.rearArrowPos.x,this.rearArrowPos.y,this.rearArrowPos.z);var s=new Ne;s.rotationAxisAngDeg(this.rearAngleDeg,0,0,1),this.rearDirection2D=this.getRearDirection2D();var l=s.getMultipliedByMatrix(a);n.tMatOriginal=l;var u=this.pivotPointLC;if(u&&u.x!==1/0){var c=new Kr(u.x,u.y),d=new Kr(0,1);for(g=0,p=this.objectsArray.length;g<p;g++){if(!((m=this.objectsArray[g])instanceof qi||m instanceof Wi||m instanceof Qr)){_=m.orginShimmyPos;(v=new Ne).setTranslation(_.x,_.y,_.z);x=new Ne;var h=c.getVectorToPoint(new Kr(_.x,_.y));h.unitary();var f=90-d.angleDegToVector(h);h.x<0&&(f*=-1),x.rotationAxisAngDeg(f,0,0,1);y=x.getMultipliedByMatrix(v);m.tMatOriginal=y}}}else for(var g=0,p=this.objectsArray.length;g<p;g++){var m;if(!((m=this.objectsArray[g])instanceof qi||m instanceof Wi||m instanceof Qr)){var v,x,_=m.orginShimmyPos;(v=new Ne).setTranslation(_.x,_.y,_.z),(x=new Ne).rotationAxisAngDeg(this.frontAngleDeg,0,0,1);var y=x.getMultipliedByMatrix(v);m.tMatOriginal=y}}this.updateMatrix()},To.prototype.getShimmyGearAssembly=function(){var e=function(e,t,i,o){r.call(this),this.width=e,this.height=i,this.wheelRadius=.4*this.height,this.frameLength=.4*t,this.frameHeight=this.height-.5*this.wheelRadius,this.frame};return(e.prototype=Object.create(r.prototype)).constructor=e,e.prototype.makeMesh=function(){void 0===this.objectsArray&&(this.objectsArray=[]),void 0===this.objectsMap&&(this.objectsMap={});var e=new ii,t=e.newOuterRing(),r=.5*this.frameLength,i=.25*this.width,o=t.newElement("POLYLINE");o.newPoint2d(r,0),o.newPoint2d(-r,0),o.newPoint2d(-r,-this.frameHeight),o.newPoint2d(r,-this.frameHeight),o.newPoint2d(2.5*r,.5*-this.frameHeight);var n=i,a=jr.getExtrudedMesh(e,n,1,void 0,!0,!0,void 0);a.name="frame",a.rotate(90,1,0,0),a.rotate(90,0,0,1),a.translate(.5*-n,0,0),this.objectsArray.push(a),this.objectsMap[a.name]=a;var s=this.wheelRadius,l=.5*s,u=.5*this.width-.5*i,c=new Co(l,s,u,{borderRadius:.2*u}),d=new Co(l,s,u,{borderRadius:.2*u});c.setOneColor(.1,.1,.15,1),d.setOneColor(.1,.1,.15,1),this.objectsArray.push(c),this.objectsArray.push(d);var h=new Jr(.5*-i-.5*u,0,-this.height+s),f=new Jr(.5*i+.5*u,0,-this.height+s);c.tMatOriginal=new Ne,c.tMatOriginal.setTranslation(h.x,h.y,h.z),d.tMatOriginal=new Ne,d.tMatOriginal.setTranslation(f.x,f.y,f.z),this.dirty=!1},e.prototype.renderAsChild=function(e,t,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.objectsArray)return!1;var o=e.getGl();o.uniform1i(t.refMatrixType_loc,0);var n=!1;if(0===r);else if(1===r){e.selectionManager.isObjectSelected(this)&&(n=!0),o.enable(o.BLEND),o.uniform1i(t.bApplySsao_loc,!0),o.uniform1i(t.colorType_loc,0),this.color4&&o.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1])}n&&(void 0===this.selColor4&&(this.selColor4=new J,this.selColor4.setRGBA(.8,.4,.5,1)),o.uniform4fv(t.oneColor4_loc,[this.selColor4.r,this.selColor4.g,this.selColor4.b,1])),this.tMat&&o.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,this.tMat._floatArrays);for(var a=this.objectsArray.length,s=0;s<a;s++){this.objectsArray[s].renderAsChild(e,t,r,i,n)}o.disable(o.BLEND)}},e},To.prototype.setPivotPointLC=function(e,t,r,i){switch(this.pivotPointLC||(this.pivotPointLC=new Jr),this.pivotPointLC.set(e,t,r),this.mode){case Yi.MODE.NORMAL:this.isParallelDirection?this.linearTrajectory():this.circleTrajectory();break;case Yi.MODE.PARALLEL_TRANSLATE:this.linearTrajectory();break;case Yi.MODE.CIRCULAR_ROTATION:case Yi.MODE.PARALLEL_ROTATION:this.circleTrajectory()}this.frontTrajectoryPointList.deleteVboKeysContainer(i),this.rearTrajectoryPointList.deleteVboKeysContainer(i)},To.prototype.linearTrajectory=function(){for(var e=this.frontTrajectoryPointList.getPointsCount(),t=this.trajectoryLength/e,r=0;r<e;r++){var i=this.frontTrajectoryPointList.getPoint(r),o=this.rearTrajectoryPointList.getPoint(r);i.set(this.frontDirection2D.x*t*(r+1),this.frontDirection2D.y*t*(r+1),this.height),o.set(this.frontDirection2D.x*-t*(r+1),this.frontDirection2D.y*-t*(r+1),this.height)}},To.prototype.circleTrajectory=function(){if(this.pivotPointLC){var e=this.frontTrajectoryPointList.getPointsCount(),t=new Kr(-this.pivotPointLC.x,-this.pivotPointLC.y),r=new Kr(1,0),i=t.angleRadToVector(r);t.y<0&&(i*=-1);for(var o=t.getModul(),n=this.trajectoryLength/o/(e-1),a=0;a<e;a++){var s=this.frontTrajectoryPointList.getPoint(a),l=this.rearTrajectoryPointList.getPoint(a),u=i+a*n,c=i+a*-n;s.set(-t.x+o*Math.cos(u),-t.y+o*Math.sin(u),this.height),l.set(-t.x+o*Math.cos(c),-t.y+o*Math.sin(c),this.height)}}};var Co=function e(t,i,o,n){if(r.call(this),!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);if(this.intRadius=10,this.extRadius=20,this.width=5,this.color4=new J,this.color4.setRGBA(.2,.2,.25,1),void 0!==t&&(this.intRadius=t),void 0!==i&&(this.extRadius=i),void 0!==o&&(this.width=o),this.borderRadius=.2*(this.extRadius-this.intRadius),void 0!==n){var a=n.color;a&&this.color4.setRGBA(a.r,a.g,a.b,a.a);var s=n.borderRadius;s&&(this.borderRadius=s)}this.width,this.borderRadius,this.borderRadius=.2*this.width};Co.prototype=Object.create(r.prototype),Co.prototype.constructor=Co,Co.prototype.makeMesh=function(){var e=new ii,t=e.newOuterRing(),r=.5*this.width,i=this.extRadius-this.borderRadius,o=t.newElement("POLYLINE");o.newPoint2d(-r,this.intRadius),o.newPoint2d(r,this.intRadius),o.newPoint2d(r,i);var n=t.newElement("ARC");n.setCenterPosition(r-this.borderRadius,i),n.setRadius(this.borderRadius),n.setStartAngleDegree(0),n.setSweepAngleDegree(90);var a=t.newElement("POLYLINE");a.newPoint2d(r-this.borderRadius,this.extRadius),a.newPoint2d(-r+this.borderRadius,this.extRadius);var s=t.newElement("ARC");s.setCenterPosition(-r+this.borderRadius,i),s.setRadius(this.borderRadius),s.setStartAngleDegree(90),s.setSweepAngleDegree(90),t.newElement("POLYLINE").newPoint2d(-r,i);var l=new mi,u=new Kr(-1,0),c=new Kr(1,0);l.setPoints(u,c);var d=jr.getRevolvedSolidMesh(e,360,18,l,!1,!1,void 0);this.mesh=d.getCopySurfaceIndependentMesh(d),this.dirty=!1},Co.prototype.render=function(e,t,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=e.getGl();if(this.geoLocDataManager)this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(o,t),o.uniform1i(t.refMatrixType_loc,0),o.uniform1i(t.colorType_loc,0),this.mesh.render(e,t,r,i),o.disable(o.BLEND)}},Co.prototype.renderAsChild=function(e,t,r,i){if(!this.attributes||void 0===this.attributes.isVisible||!1!==this.attributes.isVisible){if(this.dirty&&this.makeMesh(),void 0===this.mesh)return!1;var o=e.getGl();if(1===r)o.enable(o.BLEND),o.uniform1i(t.colorType_loc,0),e.selectionManager.isObjectSelected(this)?o.uniform4fv(t.oneColor4_loc,[.9,.1,.1,1]):this.color4&&o.uniform4fv(t.oneColor4_loc,[this.color4.r,this.color4.g,this.color4.b,1]);this.tMat&&o.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,this.tMat._floatArrays),this.mesh.render(e,t,r,i),o.disable(o.BLEND)}};var bo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.currentObjectsRendering=new function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.curNode=void 0,this.curBuilding=void 0,this.curOctree=void 0,this.curObject=void 0},this.renderNormals=!0,this.renderTexture=!0,this.magoManager=t,this._screenRectangleRenderType=0};bo.prototype.renderMgSets=function(e,t,r,i,o){for(var n=this.magoManager.getGl(),a=e.length,s=0;s<a;s++){e[s].render(n,t)}},bo.prototype.renderNodes=function(e,t,r,i,o,n,a,s){var l,u=t.length;if(0!==u){var c=r.texturesStore.getTextureAux1x1();e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,c);var d=r.sceneState;if(d.applySunShadows&&1===n){var h=d.sunSystem.getLight(0).bSphere;if(void 0===h)return;for(var f=h.getRadius(),g=h.getCenterPoint(),p=0;p<u;p++){var m=(l=t[p]).bboxAbsoluteCenterPos;if(void 0===m)e.uniform1i(i.sunIdx_loc,1);else g.distToPoint(m)<.5*f?e.uniform1i(i.sunIdx_loc,0):e.uniform1i(i.sunIdx_loc,1);l.renderContent(r,i,n,s)}}else for(p=0;p<u;p++)(l=t[p]).renderContent(r,i,n,s)}},bo.prototype.getPointsCountForDistance=function(e,t,r){var i=r.magoPolicy.getPointsCloudSettings();return e<=10?Math.floor(i.maxPerUnitPointsRenderDistToCam0m*t):e<100?Math.floor(i.maxPerUnitPointsRenderDistToCam100m*t):e<200?Math.floor(i.maxPerUnitPointsRenderDistToCam200m*t):e<400?Math.floor(i.maxPerUnitPointsRenderDistToCam400m*t):e<800?Math.floor(i.maxPerUnitPointsRenderDistToCam800m*t):e<1600?Math.floor(i.maxPerUnitPointsRenderDistToCam1600m*t):Math.floor(i.maxPerUnitPointsRenderDistToCamMoreThan1600m*t)},bo.prototype.renderPCloud=function(e,t,r,i,o,n){if(0!==t.vbo_vicks_container.vboCacheKeysArray.length){var a=t.vbo_vicks_container.vboCacheKeysArray[0],s=a.vertexCount;if(0!==s){var l=this.getPointsCountForDistance(n,s,r);if(r.isCameraMoving&&(l=Math.floor(l/5)),!(l<=0))if(0===o){if(!a.bindDataPosition(i,r.vboMemoryManager))return!1;e.drawArrays(e.POINTS,0,l)}else if(1===o){if(!a.bindDataPosition(i,r.vboMemoryManager))return!1;if(!a.bindDataColor(i,r.vboMemoryManager))return!1;e.drawArrays(e.POINTS,0,l),r.sceneState.pointsRenderedCount+=l}}}},bo.prototype.renderNeoBuildingsPCloud=function(e,t,r,i,o,n){var a,s,l;e.uniform1f(i.fixPointSize_loc,1),e.uniform1i(i.bUseFixPointSize_loc,!1);for(var u=t.length,c=0;c<u;c++){var d=(a=t[c]).data.attributes;if((!d||void 0===d.isVisible||!1!==d.isVisible)&&(s=a.getRoot().data.geoLocDataManager,void 0!==(l=a.data.neoBuilding)&&void 0!==l.octree)){var h=l.metaData.projectDataType,f=s.getCurrentGeoLocationData();if(e.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,f.rotMatrix._floatArrays),e.uniform3fv(i.buildingPosHIGH_loc,f.positionHIGH),e.uniform3fv(i.buildingPosLOW_loc,f.positionLOW),void 0!==h&&5===h){void 0===r.myCameraRelative&&(r.myCameraRelative=new X);var g=r.myCameraRelative;g.frustum.copyParametersFrom(r.myCameraSCX.bigFrustum),(g=f.getTransformedRelativeCamera(r.sceneState.camera,g)).calculateFrustumsPlanes();n=n;l.octree.test__renderPCloud(r,l,n,i,g,!0)}}}i.disableVertexAttribArrayAll()},bo.prototype.enableStencilBuffer=function(e){e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,1),e.stencilOp(e.KEEP,e.REPLACE,e.REPLACE),e.enable(e.POLYGON_OFFSET_FILL)},bo.prototype.disableStencilBuffer=function(e){e.disable(e.STENCIL_TEST),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.disable(e.POLYGON_OFFSET_FILL)},bo.prototype.renderObject=function(e,t,r,i,o,n){var a=t.getVboKeysContainer();if(void 0!==a&&0!==a.vboCacheKeysArray.length){void 0===n&&(n=!1);for(var s=a.getVbosCount(),l=0;l<s;l++){var u=a.vboCacheKeysArray[l],c=u.vertexCount;if(0===c)return;if(!u.bindDataPosition(i,r.vboMemoryManager))return!1;if(1===o){if(!u.bindDataNormal(i,r.vboMemoryManager))return!1;if(!u.bindDataColor(i,r.vboMemoryManager))return!1}if(!1===n)if(u.indicesCount>0){if(!u.bindDataIndice(i,r.vboMemoryManager))return!1;e.drawElements(e.TRIANGLES,u.indicesCount,e.UNSIGNED_SHORT,0)}else e.drawArrays(e.TRIANGLES,0,c);else e.drawArrays(e.LINE_STRIP,0,c)}}},bo.prototype.beginRenderSilhouetteDepth=function(){var e,t=this.magoManager,r=t.getGl();t.currentProcess=I.magoCurrentProcess.SilhouetteDepthRendering,t.getSilhouetteDepthFbo().bind(),t.isFarestFrustum()?(r.clearColor(1,1,1,1),r.clearDepth(1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT)):(r.clearDepth(1),r.clear(r.DEPTH_BUFFER_BIT)),t.swapRenderingFase(),(e=t.postFxShadersManager.getShader("modelRefDepth")).resetLastBuffersBinded(),e.useProgram(),e.disableVertexAttribArrayAll(),e.enableVertexAttribArray(e.position3_loc),e.bindUniformGenerals(),r.uniform3fv(e.scaleLC_loc,[1,1,1]);var i=t.modeler.clippingBox;if(void 0!==i){var o=i.getCurrentGeoLocationData();r.uniform3fv(e.uniformsLocations["clippingBoxSplittedPos[0]"],o.positionSplitted);var n=i.getPlanesPositionsFloat32Array(),a=i.getPlanesNormalsFloat32Array();r.uniform1i(e.bApplyClippingPlanes_loc,!0),r.uniform1i(e.clippingPlanesCount_loc,4);var s=e.uniformsLocations["clippingBoxPlanesPosLC[0]"],l=e.uniformsLocations["clippingBoxPlanesNorLC[0]"];r.uniform3fv(s,n),r.uniform3fv(l,a),r.uniformMatrix4fv(e.uniformsLocations.clippingBoxRotMatrix,!1,o.rotMatrix._floatArrays)}else r.uniform1i(e.bApplyClippingPlanes_loc,!1);t.isFarestFrustum()&&r.clearColor(0,0,0,1)},bo.prototype.endRenderSilhouetteDepth=function(e){e.unbind()},bo.prototype.renderSilhouetteDepth=function(){var e=this.magoManager,t=e.selectionManager;e.interactionCollection.getSelectType();if(t){var r=e.getGl();if(!t.existSelectedObjects())return;this.beginRenderSilhouetteDepth();var i=e.postFxShadersManager.getShader("modelRefDepth"),o=e.getSilhouetteDepthFbo(),n=e.texturesStore.getTextureAux1x1();r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,n);var a=t.getSelectedF4dNodeArray(),s=t.getSelectedF4dObjectArray();if(a.length>0&&0===s.length){r.uniform3fv(i.aditionalMov_loc,[0,0,0]);for(var l=0,u=0,c=0,d=a.length;c<d;c++){(h=a[c]).renderContent(e,i,l,u)}e.swapRenderingFase()}if(t.currentReferenceSelected){var h=t.getSelectedF4dNode(),f=t.getSelectedF4dBuilding();if(t.currentReferenceSelected instanceof or&&void 0!==h&&void 0!==f){e.currentProcess=I.magoCurrentProcess.SilhouetteDepthRendering;var g=h.getNodeGeoLocDataManager().getCurrentGeoLocationData();r.POINTS;r.TRIANGLES;u=0;g.bindGeoLocationUniforms(r,i),r.TRIANGLES;r.disable(r.CULL_FACE),t.getSelectedF4dObject().render(e,f,0,!1,i,u,0)}}l=0;var p=t.getSelectedGeneralArray();for(c=0;c<p.length;c++){p[c].render(e,i,l,r.TRIANGLES)}this.endRenderSilhouetteDepth(o),r.enable(r.CULL_FACE)}},bo.prototype.renderDepthSunSystem=function(e){var t=this.magoManager;if(t.depthFboNeo){var r=t.getGl(),i=t.sceneState;e.calculateBoundingFrustum(i.camera),r.clearColor(1,1,1,1),r.clearDepth(1);for(var o=i.sunSystem,n=o.lightSourcesArray.length,a=0;a<n;a++){var s=o.getLight(a),l=s.targetTextureWidth,u=s.targetTextureHeight;void 0===s.depthFbo&&(s.depthFbo=new ae(r,l,u)),t.swapRenderingFase(),s.depthFbo.bind(),t.isFarestFrustum()?r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT):r.clear(r.DEPTH_BUFFER_BIT),r.viewport(0,0,l,u),this._renderDepthSunPointOfView(r,e,s,o),s.depthFbo.unbind()}t.depthFboNeo.bind(),r.clearColor(0,0,0,1),r.viewport(0,0,t.sceneState.drawingBufferWidth[0],t.sceneState.drawingBufferHeight[0])}},bo.prototype._renderDepthSunPointOfView=function(e,t,r,i){if(void 0!==r.tMatrix){var o=this.magoManager;o.currentProcess=I.magoCurrentProcess.DepthShadowRendering;var n=o.postFxShadersManager.getShader("orthogonalDepth");n.resetLastBuffersBinded(),n.useProgram(),o.effectsManager.setCurrentShader(n),n.disableVertexAttribArrayAll(),n.enableVertexAttribArray(n.position3_loc),n.bindUniformGenerals(),e.uniformMatrix4fv(n.modelViewProjectionMatrixRelToEye_loc,!1,r.tMatrix._floatArrays),e.uniform3fv(n.encodedCameraPositionMCHigh_loc,r.positionHIGH),e.uniform3fv(n.encodedCameraPositionMCLow_loc,r.positionLOW),e.uniform3fv(n.scaleLC_loc,[1,1,1]),e.uniform1i(n.bApplySsao_loc,!1),e.disable(e.CULL_FACE);this.renderNodes(e,t.currentVisibles0,o,n,!1,0,0,0,0),this.renderNodes(e,t.currentVisibles2,o,n,!1,0,0,0,0),this.renderNodes(e,t.currentVisibles3,o,n,!1,0,0,0,0),this.renderNodes(e,t.currentVisibles0Transparents,o,n,!1,0,0,0,0),this.renderNodes(e,t.currentVisibles2Transparents,o,n,!1,0,0,0,0),this.renderNodes(e,t.currentVisibles3Transparents,o,n,!1,0,0,0,0);if(this.renderNativeObjects(e,n,0,t,{bRenderOpaques:!0,bRenderTransparents:!0}),void 0!==o.tinTerrainManager);e.enable(e.CULL_FACE),n.disableVertexAttribArrayAll(),e.useProgram(null)}},bo.prototype.renderDepthCameraPointOfView=function(e,t){if(void 0!==e){var r=this.magoManager;r.currentProcess=I.magoCurrentProcess.DepthShadowRendering;var i=r.getGl(),o=r.sceneState,n=r.postFxShadersManager.getShader("modelRefDepth");n.resetLastBuffersBinded(),n.useProgram(),r.effectsManager.setCurrentShader(n),n.disableVertexAttribArrayAll(),n.enableVertexAttribArray(n.position3_loc),n.bindUniformGenerals();var a=e.getEncodedCameraPosition(),s=e.getModelViewMatrixRelToEye(),l=e.getBigFrustum(),u=fe.getProjectionMatrix(l,void 0),c=new Ne;c._floatArrays=glMatrix.mat4.multiply(c._floatArrays,u._floatArrays,s._floatArrays);var d=i.getUniformLocation(n.program,"ModelViewProjectionMatrixRelToEye");i.uniformMatrix4fv(d,!1,c._floatArrays),i.uniformMatrix4fv(n.mvRelToEyeMatrix_loc,!1,s._floatArrays),i.uniform3fv(n.encodedCameraPositionMCHigh_loc,a.high),i.uniform3fv(n.encodedCameraPositionMCLow_loc,a.low),i.uniform3fv(n.scaleLC_loc,[1,1,1]),i.uniform1f(n.frustumFar_loc,l.far[0]),i.uniform1i(n.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),i.uniform1f(n.uFCoef_logDepth_loc,o.fCoef_logDepth[0]),i.uniform1i(n.bHasTexture_loc,!1),i.uniform1i(n.uFrustumIdx_loc,r.currentFrustumIdx);i.uniform1i(n.bUseMultiRenderTarget_loc,!1),i.uniform1i(n.bApplySsao_loc,!1),i.disable(i.CULL_FACE),i.enable(i.DEPTH_TEST);this.renderNodes(i,t.currentVisibles0,r,n,!1,0,0,0,0);if(this.renderNativeObjects(i,n,0,t,{bRenderOpaques:!0,bRenderTransparents:!0}),void 0!==r.tinTerrainManager);i.enable(i.CULL_FACE),n.disableVertexAttribArrayAll(),i.useProgram(null)}},bo.prototype.renderImageViewRectangle=function(e,t,r){if(void 0===t.imageViewerRectangle){t.imageViewerRectangle=new oo(100,100),t.imageViewerRectangle.geoLocDataManager=new ye;var i=t.imageViewerRectangle.geoLocDataManager.newGeoLocationData("noName");i=on.calculateGeoLocationData(126.61673801297405,37.580105647225956,50,void 0,void 0,void 0,i,t)}if(void 0!==r){var o=t.postFxShadersManager.getShader("imageViewerRectangle");o.useProgram();e.uniform1i(o.refMatrixType_loc,0),e.enableVertexAttribArray(o.texCoord2_loc),e.enableVertexAttribArray(o.position3_loc),o.bindUniformGenerals(),e.uniform1f(o.externalAlpha_loc,1),e.uniform1i(o.colorType_loc,2),e.uniform4fv(o.oneColor4_loc,[.1,.8,.99,1]),e.uniform3fv(o.buildingPosHIGH_loc,[0,0,0]),e.uniform3fv(o.buildingPosLOW_loc,[0,0,0]),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,t.depthFboNeo.colorBuffer),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,r.colorBuffer),o.last_tex_id=r.colorBuffer,t.imageViewerRectangle.render(t,o),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null),o.disableVertexAttribArrayAll(),e.useProgram(null)}},bo.prototype.renderAtmosphere=function(e,t){var r=this.magoManager;void 0===r.sky&&(r.sky=new xi),e.clearColor(0,0,0,1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var i=r.postFxShadersManager.getShader("atmosphere");i.useProgram();e.uniform1i(i.bApplySsao_loc,!1),e.uniform1i(i.bApplySpecularLighting_loc,!1),e.disableVertexAttribArray(i.texCoord2_loc),e.enableVertexAttribArray(i.position3_loc),i.bindUniformGenerals(),e.uniform1f(i.externalAlpha_loc,1),e.uniform1i(i.colorType_loc,0),e.uniform4fv(i.oneColor4_loc,[.1,.8,.99,1]),e.uniform3fv(i.buildingPosHIGH_loc,[0,0,0]),e.uniform3fv(i.buildingPosLOW_loc,[0,0,0]);r.sky.render(r,i,1,void 0),i.disableVertexAttribArrayAll(),e.useProgram(null),void 0!==r.sunDepthFbo&&this.renderImageViewRectangle(e,r,r.sunDepthFbo)},bo.prototype.renderNativeLightSources=function(e,t){var r=this.magoManager,i=t.currentVisibleNativeObjects.lightSourcesArray,o=i.length;if(o>0){var n=r.getGl(),a=r.sceneState,s=r.postFxShadersManager.getShader("modelRefSsao");s.useProgram();r.effectsManager.setCurrentShader(s),n.uniform1i(s.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),n.uniform1i(s.bApplySsao_loc,!1),n.uniform1i(s.bApplyShadow_loc,!1),n.uniform1i(s.bApplySpecularLighting_loc,!0),n.uniform1f(s.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),n.uniform1i(s.clippingType_loc,0),n.uniform1i(s.uFrustumIdx_loc,r.currentFrustumIdx),n.uniform1i(s.bUseMultiRenderTarget_loc,r.postFxShadersManager.bUseMultiRenderTarget);var l=a.getProjectionMatrixInv();n.uniformMatrix4fv(s.projectionMatrixInv_loc,!1,l._floatArrays);var u=a.getModelViewRelToEyeMatrixInv();n.uniformMatrix4fv(s.modelViewMatrixRelToEyeInv_loc,!1,u._floatArrays);n.enable(n.BLEND);for(var c=0;c<o;c++)i[c].render(r,s,e,void 0);n.disable(n.BLEND)}},bo.prototype.renderNativeObjects=function(e,t,r,i,o){var n=this.magoManager,a=n.sceneState,s=!1,l=!1;o&&(o.bRenderOpaques&&(s=o.bRenderOpaques),o.bRenderTransparents&&(l=o.bRenderTransparents)),e.uniform1i(t.refMatrixType_loc,0),e.uniform3fv(t.scaleLC_loc,[1,1,1]),e.uniform4fv(t.colorMultiplier_loc,[1,1,1,1]),e.uniform3fv(t.aditionalMov_loc,[0,0,0]);var u=n.texturesStore.getTextureAux1x1();if(e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,u),s){for(var c=i.currentVisibleNativeObjects.opaquesArray,d=c.length,h=0;h<d;h++)c[h].render(n,t,r,void 0);var f=i.currentVisibleNativeObjects.vectorTypeArray,g=f.length;if(g>0){var p=n.postFxShadersManager.getShader("thickLine");p.useProgram(),p.bindUniformGenerals(),e.uniform4fv(p.oneColor4_loc,[.3,.9,.5,1]),e.uniform1i(p.colorType_loc,0),e.uniform2fv(p.viewport_loc,[a.drawingBufferWidth,a.drawingBufferHeight]),e.uniform1f(p.thickness_loc,5);for(h=0;h<g;h++)f[h].render(n,p,r,void 0);t.useProgram()}}if(l){var m=i.currentVisibleNativeObjects.transparentsArray;d=m.length;for(h=0;h<d;h++)m[h].render(n,t,r,void 0)}if(s&&1===r){var v=i.currentVisibleNativeObjects.pointTypeArray;if(v){var x=v.length;if(x>0){var _=n.postFxShadersManager.getShader("pointsCloudSsao");_.useProgram(),_.disableVertexAttribArrayAll(),_.resetLastBuffersBinded(),_.enableVertexAttribArray(_.position3_loc),_.bindUniformGenerals(),e.uniform1i(_.bPositionCompressed_loc,!1),e.uniform1i(_.bUse1Color_loc,!0),e.uniform4fv(_.oneColor4_loc,[1,1,.1,1]),e.uniform1f(_.fixPointSize_loc,10),e.uniform1i(_.bUseFixPointSize_loc,1);var y=n.magoPolicy.getPointsCloudSettings();e.uniform1i(currentShader.bUseColorCodingByHeight_loc,!0),e.uniform1f(currentShader.minHeight_rainbow_loc,parseInt(y.minHeightRainbow)),e.uniform1f(currentShader.maxHeight_rainbow_loc,parseInt(y.maxHeightRainbow)),e.uniform1f(currentShader.maxPointSize_loc,parseInt(y.maxPointSize)),e.uniform1f(currentShader.minPointSize_loc,parseInt(y.minPointSize)),e.uniform1f(currentShader.pendentPointSize_loc,parseInt(y.pendentPointSize)),e.uniform1i(currentShader.bUseLogarithmicDepth_loc,n.postFxShadersManager.bUseLogarithmicDepth),e.uniform1i(currentShader.bUseMultiRenderTarget_loc,n.postFxShadersManager.bUseMultiRenderTarget),e.uniform1f(currentShader.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),e.uniform2fv(currentShader.uNearFarArray_loc,n.frustumVolumeControl.nearFarArray),e.uniform1i(currentShader.uFrustumIdx_loc,n.currentFrustumIdx);var T=!0;void 0===T&&(T=!0),T?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST);for(h=0;h<x;h++)v[h].renderPoint(n,_,e,r);t.useProgram()}}}e.enable(e.DEPTH_TEST)},bo.prototype.renderExcavationObjects=function(e,t,r,i){for(var o=this.magoManager,n=i.currentVisibleNativeObjects.excavationsArray,a=n.length,s=0;s<a;s++)n[s].render(o,t,r,void 0)},bo.prototype.renderSilhouette=function(){var e,t=(e=this.magoManager).getGl(),r=(e=this.magoManager).sceneState,i=e.postFxShadersManager.getShader("screenQuad");i.useProgram(),i.bindUniformGenerals();var o=r.getProjectionMatrixInv();t.uniformMatrix4fv(i.projectionMatrixInv_loc,!1,o._floatArrays);var n=r.getModelViewRelToEyeMatrixInv();t.uniformMatrix4fv(i.modelViewMatrixRelToEyeInv_loc,!1,n._floatArrays);t.uniform1i(i.bApplyShadow_loc,!1),t.uniform1i(i.bSilhouette_loc,!0),t.uniform1i(i.bFxaa_loc,!1),t.uniform1i(i.bApplySsao_loc,!1),t.uniform1f(i.uSceneDayNightLightingFactor_loc,1);r.sunSystem.getLight(0);var a=e.texturesStore.getTextureAux1x1(),s=e.getSilhouetteDepthFbo();t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,s.colorBuffer),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,a),t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,a),t.activeTexture(t.TEXTURE4),t.bindTexture(t.TEXTURE_2D,a),i.last_tex_id=a,t.depthMask(!1),t.depthRange(0,.01),t.disable(t.DEPTH_TEST),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),this.getScreenQuad().render(e,i),t.depthMask(!0),t.depthRange(0,1),t.enable(t.DEPTH_TEST),t.disable(t.BLEND)},bo.prototype.renderScreenQuad=function(e){var t,r=this.magoManager,i=r.sceneState,o=i.camera,n=!1;void 0!==i.sunSystem&&i.applySunShadows&&(n=!0);var a=r.shadedColorFbo;a.bind();var s=r.extbuffers;e.framebufferTexture2D(e.FRAMEBUFFER,s.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,r.brightColorTex,0),s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.COLOR_ATTACHMENT1_WEBGL,s.NONE,s.NONE,s.NONE]),e.clearColor(0,0,0,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var l=r.postFxShadersManager;t=l.getShader("screenQuad"),l.useProgram(t),t.bindUniformGenerals();var u=i.getProjectionMatrixInv();e.uniformMatrix4fv(t.projectionMatrixInv_loc,!1,u._floatArrays);var c=i.getModelViewRelToEyeMatrixInv();e.uniformMatrix4fv(t.modelViewMatrixRelToEyeInv_loc,!1,c._floatArrays),e.uniform1i(t.bApplyShadow_loc,!1),e.uniform1i(t.bApplyMagoShadow_loc,n),e.uniform1i(t.bSilhouette_loc,!1),e.uniform1i(t.bFxaa_loc,!1),e.uniform1i(t.bApplySsao_loc,!0),e.uniform2fv(t.uNearFarArray_loc,r.frustumVolumeControl.nearFarArray),e.uniform1i(t.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),e.uniform1f(t.uFCoef_logDepth_loc,i.fCoef_logDepth[0]),e.uniform3fv(t.uAmbientLight_loc,i.ambientColor),e.uniform3fv(t.uBrightnessContrastSaturation_loc,i.brightnessContrastSaturation),e.uniform1i(t.uBrightnessContrastType_loc,i.brightnessContrastType);var d=(_=i.sunSystem).getLight(0),h=_.getDayNightLightingFactorOfPosition(o.position);h<0&&(h=0),h=1,e.uniform1f(t.uSceneDayNightLightingFactor_loc,h);var f=r.texturesStore.getTextureAux1x1(),g=_.getSunDirWC();e.uniform3fv(t.sunDirWC_loc,g);var p=_.getSunDirCC();if(e.uniform3fv(t.sunDirCC_loc,p),n){var m=_.getLightsMatrixFloat32Array(),v=_.getLightsPosLOWFloat32Array(),x=_.getLightsPosHIGHFloat32Array();void 0!==d.tMatrix&&(e.uniformMatrix4fv(t.sunMatrix_loc,!1,m),e.uniform3fv(t.sunPosHigh_loc,x),e.uniform3fv(t.sunPosLow_loc,v),e.uniform1f(t.shadowMapWidth_loc,d.targetTextureWidth),e.uniform1f(t.shadowMapHeight_loc,d.targetTextureHeight))}if(e.activeTexture(e.TEXTURE3),n&&d.depthFbo){d=(_=i.sunSystem).getLight(0);e.bindTexture(e.TEXTURE_2D,d.depthFbo.colorBuffer)}else e.bindTexture(e.TEXTURE_2D,f);if(e.activeTexture(e.TEXTURE4),n&&d.depthFbo){var _;d=(_=i.sunSystem).getLight(1);e.bindTexture(e.TEXTURE_2D,d.depthFbo.colorBuffer)}else e.bindTexture(e.TEXTURE_2D,f);t.last_tex_id=f;var y=r.depthTex,T=r.normalTex,C=r.albedoTex,b=r.diffuseLightTex;r.specularLightTex;e.activeTexture(e.TEXTURE2),C?e.bindTexture(e.TEXTURE_2D,C):e.bindTexture(e.TEXTURE_2D,f),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,y);var M=r.ssaoFromDepthFbo;e.activeTexture(e.TEXTURE5),e.bindTexture(e.TEXTURE_2D,M.colorBuffersArray[0]),e.uniform2fv(t.ussaoTexSize_loc,new Float32Array([M.getWidth(),M.getHeight()])),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,T),e.activeTexture(e.TEXTURE6),b?e.bindTexture(e.TEXTURE_2D,b):e.bindTexture(e.TEXTURE_2D,f),e.depthMask(!1),e.disable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.getScreenQuad().render(r,t),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.disable(e.BLEND),a.unbind()},bo.prototype.renderScreenQuad2=function(e){var t,r=this.magoManager,i=r.sceneState,o=i.camera,n=!1;void 0!==i.sunSystem&&i.applySunShadows&&(n=!0);var a=r.postFxShadersManager;t=a.getShader("screenQuad2"),a.useProgram(t),t.bindUniformGenerals();var s=i.getProjectionMatrixInv();e.uniformMatrix4fv(t.projectionMatrixInv_loc,!1,s._floatArrays);var l=i.getModelViewRelToEyeMatrixInv();e.uniformMatrix4fv(t.modelViewMatrixRelToEyeInv_loc,!1,l._floatArrays),e.uniform1i(t.bApplyShadow_loc,!1),e.uniform1i(t.bApplyMagoShadow_loc,n),e.uniform1i(t.bSilhouette_loc,!1),e.uniform1i(t.bFxaa_loc,!1),e.uniform1i(t.bApplySsao_loc,!0),e.uniform2fv(t.uNearFarArray_loc,r.frustumVolumeControl.nearFarArray),e.uniform1i(t.bUseLogarithmicDepth_loc,r.postFxShadersManager.bUseLogarithmicDepth),e.uniform1f(t.uFCoef_logDepth_loc,i.fCoef_logDepth[0]),e.uniform3fv(t.uAmbientLight_loc,i.ambientColor);var u=i.sunSystem,c=u.getLight(0),d=u.getDayNightLightingFactorOfPosition(o.position);d<0&&(d=0),e.uniform1f(t.uSceneDayNightLightingFactor_loc,d);var h=r.texturesStore.getTextureAux1x1(),f=u.getSunDirWC();e.uniform3fv(t.sunDirWC_loc,f);var g=u.getSunDirCC();if(e.uniform3fv(t.sunDirCC_loc,g),n){var p=u.getLightsMatrixFloat32Array(),m=u.getLightsPosLOWFloat32Array(),v=u.getLightsPosHIGHFloat32Array();void 0!==c.tMatrix&&(e.uniformMatrix4fv(t.sunMatrix_loc,!1,p),e.uniform3fv(t.sunPosHigh_loc,v),e.uniform3fv(t.sunPosLow_loc,m),e.uniform1f(t.shadowMapWidth_loc,c.targetTextureWidth),e.uniform1f(t.shadowMapHeight_loc,c.targetTextureHeight),e.uniform1i(t.sunIdx_loc,1))}var x=r.depthTex,_=r.normalTex;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,x),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,_);e.activeTexture(e.TEXTURE2),r.LightFogTex?e.bindTexture(e.TEXTURE_2D,r.LightFogTex):e.bindTexture(e.TEXTURE_2D,h);var y=!1,T=r.screenSpaceFBO;e.activeTexture(e.TEXTURE3),T?(y=!0,e.bindTexture(e.TEXTURE_2D,T.colorBuffersArray[0])):e.bindTexture(e.TEXTURE_2D,h);var C=r.shadedColorFbo;e.activeTexture(e.TEXTURE4),e.bindTexture(e.TEXTURE_2D,C.colorBuffer),e.activeTexture(e.TEXTURE5),i.applyBloomEffect&&r.brightColorTex_A?e.bindTexture(e.TEXTURE_2D,r.brightColorTex_A):e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE6);var b=!1;if(r.soundManager&&r.soundManager.soundLayersArray.length>0){var M=r.soundManager.soundLayersArray[0];M.volumRenderTex&&(e.bindTexture(e.TEXTURE_2D,M.volumRenderTex),b=!0)}if(r.chemicalAccidentManager&&r.chemicalAccidentManager.chemAccidentLayersArray){if(r.chemicalAccidentManager.chemAccidentLayersArray.length>0){var A=r.chemicalAccidentManager.chemAccidentLayersArray[0];A.volumRenderTex&&(e.bindTexture(e.TEXTURE_2D,A.volumRenderTex),b=!0)}}else if(r.airPollutionManager&&r.airPollutionManager.airPollutionLayersArray&&r.airPollutionManager.airPollutionLayersArray.length>0){var E=r.airPollutionManager.airPollutionLayersArray[0];E.volumRenderTex&&(e.bindTexture(e.TEXTURE_2D,E.volumRenderTex),b=!0)}e.uniform1iv(t.u_activeTex_loc,[!0,y,0,0,0,0,b,0]),e.depthMask(!1),e.enable(e.CULL_FACE),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.getScreenQuad().render(r,t),e.depthMask(!0),e.disable(e.BLEND)},bo.prototype.getScreenQuad=function(){return void 0===this.screenQuad&&(this.screenQuad=new pi(this.magoManager.vboMemoryManager)),this.screenQuad},bo.prototype.renderScreenQuadGaussianBlur=function(e){var t,r=this.magoManager,i=r.getTexturesManager();r.sceneState;r.brightColorTex_A=i.bloomBufferFBO.colorBuffersArray[1],r.brightColorTex_B=i.bloomBufferFBO.colorBuffersArray[0];var o=r.brightColorTex_A,n=r.brightColorTex_B,a=r.brightColorTex,s=r.postFxShadersManager;t=s.getShader("gaussianBlur"),s.useProgram(t),t.bindUniformGenerals();var l=i.bloomBufferFBO;l.bind();var u=r.extbuffers;u.drawBuffersWEBGL([u.COLOR_ATTACHMENT0_WEBGL,u.NONE,u.NONE,u.NONE,u.NONE]),e.disable(e.DEPTH_TEST);var c=this.getScreenQuad();e.activeTexture(e.TEXTURE0);var d=!0,h=l.getWidth(),f=l.getHeight();e.uniform2fv(t.uImageSize_loc,new Float32Array([h,f]));for(var g=0;g<8;g++)e.uniform1i(t.u_bHorizontal_loc,d),0===g?(e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,o,0),e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.bindTexture(e.TEXTURE_2D,a)):d?(e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,o,0),e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.bindTexture(e.TEXTURE_2D,n)):(e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,n,0),e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.bindTexture(e.TEXTURE_2D,o)),c.render(r,t),d=!d;e.enable(e.DEPTH_TEST),l.unbind()},bo.prototype.renderScreenQuadBlur_ssaoTex=function(e){var t,r=this.magoManager,i=(r.getTexturesManager(),r.sceneState),o=(i.camera,i.drawingBufferWidth[0],i.drawingBufferHeight[0],r.ssaoFromDepthFbo),n=o.colorBuffersArray[1],a=o.colorBuffersArray[0],s=r.postFxShadersManager,l="screenQuadBlur";l="gaussianBlur",t=s.getShader(l),s.useProgram(t),t.bindUniformGenerals(),o.bind();var u=r.extbuffers;u.drawBuffersWEBGL([u.COLOR_ATTACHMENT0_WEBGL,u.NONE,u.NONE,u.NONE,u.NONE]),e.disable(e.DEPTH_TEST);var c=this.getScreenQuad();e.activeTexture(e.TEXTURE0);var d=o.getWidth(),h=o.getHeight();e.uniform2fv(t.uImageSize_loc,new Float32Array([d,h]));for(var f=!0,g=0;g<3;g++)e.uniform1i(t.u_bHorizontal_loc,f),f?(e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,n,0),e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.bindTexture(e.TEXTURE_2D,a)):(e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,a,0),e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,null,0),e.bindTexture(e.TEXTURE_2D,n)),c.render(r,t),f=!f;e.enable(e.DEPTH_TEST),e.bindTexture(e.TEXTURE_2D,null),e.framebufferTexture2D(e.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,a,0),o.unbind()},bo.prototype.renderSsaoFromDepth=function(e){var t=this.magoManager;if(t.texturesManager){var r=t.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=t.ssaoFromDepthFbo;n.bind(),e.clearColor(0,0,0,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);var a=t.postFxShadersManager.getShader("ssaoFromDepth");a.useProgram(),a.bindUniformGenerals(),e.viewport(0,0,i,o);e.uniform1i(a.bApplySsao_loc,!0);var s=r.getProjectionMatrixInv();e.uniformMatrix4fv(a.projectionMatrixInv_loc,!1,s._floatArrays),e.uniform1i(a.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),e.uniform1f(a.uFCoef_logDepth_loc,r.fCoef_logDepth[0]),e.uniform2fv(a.uNearFarArray_loc,t.frustumVolumeControl.nearFarArray),e.uniform1f(a.screenWidth_loc,n.getWidth()),e.uniform1f(a.screenHeight_loc,n.getHeight());t.texturesManager.texturesMergerFbo;var l=t.texturesStore.getNoiseTexture4x4(),u=t.depthTex,c=t.normalTex;e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,u),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,l),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,c),e.depthMask(!1),e.disable(e.DEPTH_TEST),this.getScreenQuad().render(t,a),n.unbind(),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE3),e.bindTexture(e.TEXTURE_2D,null),e.clearColor(0,0,0,1),e.viewport(0,0,r.drawingBufferWidth[0],r.drawingBufferHeight[0]),e.depthMask(!0),e.enable(e.DEPTH_TEST)}},bo.prototype.copyTexture=function(e,t,r,i){var o,n=this.magoManager,a=n.getGl();(o=n.postFxShadersManager.getShader("textureCopy")).useProgram(),o.bindUniformGenerals(),void 0===i&&(i=!1),void 0===r&&(r=!1),a.uniform1i(o.u_textureFlipXAxis_loc,r),a.uniform1i(o.u_textureFlipYAxis_loc,i),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,e),n.texturesManager.texturesMergerFbo.bind();var s=n.extbuffers;a.framebufferTexture2D(a.FRAMEBUFFER,s.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,t,0),a.framebufferTexture2D(a.FRAMEBUFFER,s.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,s.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,s.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,s.COLOR_ATTACHMENT4_WEBGL,a.TEXTURE_2D,null,0),s&&s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.NONE,s.NONE,s.NONE,s.NONE]),a.depthMask(!1),a.disable(a.DEPTH_TEST),this.getScreenQuad().render(n,o),n.texturesManager.texturesMergerFbo.unbind(),a.depthMask(!0),a.enable(a.DEPTH_TEST),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null)},bo.prototype.renderTerrainCopy=function(){var e=this.magoManager;if(e.depthTex&&e.normalTex){var t,r=e.sceneState,i=e.getGl();e.postFxShadersManager.bUseMultiRenderTarget;if(e.scene.view.globeDepth._copyDepthFramebuffer.framebuffer&&(e.czm_globeDepthText=e.scene.view.globeDepth._copyDepthFramebuffer.framebuffer._colorTextures[0]._texture),e.czm_globeDepthText){(t=e.postFxShadersManager.getShader("screenCopyQuad")).useProgram(),t.bindUniformGenerals();var o=r.getProjectionMatrixInv();i.uniformMatrix4fv(t.projectionMatrixInv_loc,!1,o._floatArrays);var n=r.getModelViewRelToEyeMatrixInv();i.uniformMatrix4fv(t.modelViewMatrixRelToEyeInv_loc,!1,n._floatArrays),i.uniformMatrix4fv(t.normalMatrix4_loc,!1,e.sceneState.normalMatrix4._floatArrays),i.uniform1i(t.uFrustumIdx_loc,e.currentFrustumIdx),i.uniform1f(t.frustumFar_loc,e.sceneState.camera.frustum.far[0]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,e.czm_globeDepthText),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,e.cesiumColorBuffer);var a=this.getScreenQuad();(e.isCameraMoved||e.bPicking)&&e.isFarestFrustum()&&e.selectionManager.clearCandidates();var s=e.extbuffers;e.texturesManager.texturesMergerFbo.bind(),i.framebufferTexture2D(i.FRAMEBUFFER,s.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,e.depthTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,s.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,e.normalTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,s.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,s.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,e.selColorTex,0),e.isCameraMoved||e.bPicking?s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.COLOR_ATTACHMENT1_WEBGL,s.NONE,s.COLOR_ATTACHMENT3_WEBGL]):s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.COLOR_ATTACHMENT1_WEBGL,s.NONE,s.NONE]),e.isFarestFrustum()?(i.clearColor(1,1,1,1),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT)):i.clear(i.DEPTH_BUFFER_BIT),a.render(e,t),e.texturesManager.texturesMergerFbo.unbind(),i.clearColor(0,0,0,1);for(var l=0;l<8;l++)i.activeTexture(i.TEXTURE0+l),i.bindTexture(i.TEXTURE_2D,null)}}},bo.prototype.renderScreenRectangle=function(e,t){var r=this.magoManager,i=r.sceneState;i.drawingBufferWidth[0],i.drawingBufferHeight[0];if(void 0===this.quadBuffer){var o=new Float32Array([0,0,.5,0,0,.5,0,.5,.5,0,.5,.5]);this.quadBuffer=ae.createBuffer(e,o);var n=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.texCoordBuffer=ae.createBuffer(e,n);var a=new Jr(1,-1,-1);a.unitary();var s=new Jr(-1,-1,-1);s.unitary();var l=new Jr(-1,1,-1);l.unitary();var u=new Jr(1,1,-1);u.unitary(),(a=new Jr(1,1,1)).unitary(),(s=new Jr(-1,1,1)).unitary(),(l=new Jr(-1,1,-1)).unitary(),(u=new Jr(1,1,-1)).unitary();var c=new Float32Array([u.x,u.y,u.z,l.x,l.y,l.z,a.x,a.y,a.z,a.x,a.y,a.z,l.x,l.y,l.z,s.x,s.y,s.z]);this.normalBuffer=ae.createBuffer(e,c)}var d=r.postFxShadersManager;if(void 0!==d){d.getCurrentShader();var h=d.getShader("rectangleScreen");d.useProgram(h);r.texturesStore.getTextureAux1x1();e.enableVertexAttribArray(h.position2_loc),ae.bindAttribute(e,this.quadBuffer,h.position2_loc,2),-1!==h.normal3_loc&&(e.enableVertexAttribArray(h.normal3_loc),ae.bindAttribute(e,this.normalBuffer,h.normal3_loc,3)),e.enableVertexAttribArray(h.texCoord2_loc),ae.bindAttribute(e,this.texCoordBuffer,h.texCoord2_loc,2);var f=r.getSilhouetteDepthFbo().colorBuffer;if(e.uniform1i(h.uTextureType_loc,0),r.depthTex&&(f=r.scene._context.defaultNormalTexture._texture),r.cesiumColorBuffer,r.brightColorTex_A,r.depthFboNeo.colorBuffer,r.framebufferAux.colorBuffer,r.normalTex,r.albedoTex,r.diffuseLightTex,r.specularLightTex,r.specularLightTex,r.debugTex,r.windPlaneDepthTex,r.windPngTex,r.windPlaneNormalTex,r.windVolumeRearNormalTex,r.selectionFbo,r.selColorTex,r.ssaoFromDepthFbo,r.weatherStation){var g=r.weatherStation;if(g.windVolumesArray&&g.windVolumesArray.length>0){var p=g.windVolumesArray[0],m=p._getVolumeFrontFBO(r);if(m)m.colorBuffersArray[1];var v=p._getVolumeRearFBO(r);if(v)v.colorBuffersArray[1]}}if(r.soundManager&&(void 0===this.lastIdx&&(this.lastIdx=0),r.soundManager.soundLayersArray.length>0)){var x=r.soundManager.soundLayersArray[0];x.demWithBuildingsTex&&x.demWithBuildingsTex.texId,x.soundSourceRealTexture3d&&x.soundSourceRealTexture3d.texturesArray.length>0&&(this.lastIdx>=x.soundSourceRealTexture3d.texturesArray.length&&(this.lastIdx=0),this.lastIdx+=1),x.soundSourceMosaicTexture3d&&x.soundSourceMosaicTexture3d.texturesArray.length,x.pressureMosaicTexture3d_A&&x.pressureMosaicTexture3d_A.texturesArray.length,x.pressureMosaicTexture3d_B&&x.pressureMosaicTexture3d_B.texturesArray.length,x.fluxRFUMosaicTexture3d_HIGH_A&&x.fluxRFUMosaicTexture3d_HIGH_A.texturesArray.length,x.fluxRFUMosaicTexture3d_HIGH_B&&x.fluxRFUMosaicTexture3d_HIGH_B.texturesArray.length,x.fluxRFUMosaicTexture3d_LOW_A&&x.fluxRFUMosaicTexture3d_LOW_A.texturesArray.length,x.fluxLBDMosaicTexture3d_HIGH_B&&x.fluxLBDMosaicTexture3d_HIGH_B.texturesArray.length,x.fluxLBDMosaicTexture3d_LOW_A&&x.fluxLBDMosaicTexture3d_LOW_A.texturesArray.length,x.auxMosaicTexture3d_forFluxCalculation&&x.auxMosaicTexture3d_forFluxCalculation.texturesArray.length,x.airVelocity_B&&x.airVelocity_B.texturesArray.length,x.shaderLogTexture&&x.shaderLogTexture.texturesArray.length,x.shaderLogTexture_vel&&x.shaderLogTexture_vel.texturesArray.length,x.simulBoxdoubleDepthTex,x.simulBoxDoubleNormalTex,x.volumRenderTex,x.auxTex3d_yDirection&&(x.auxTex3d_yDirection.texturesArray||x.auxTex3d_yDirection.texturesArray.length),x.mosaic_partial_ydirection&&(x.mosaic_partial_ydirection.texturesArray||x.mosaic_partial_ydirection.texturesArray.length)}if(r.chemicalAccidentManager&&r.chemicalAccidentManager.chemAccidentLayersArray&&r.chemicalAccidentManager.chemAccidentLayersArray.length>0){var _=r.chemicalAccidentManager.chemAccidentLayersArray[0];_.cuttingPlaneNormalTex,_.simulBoxdoubleDepthTex,_.simulBoxDoubleNormalTex,_.screenFBO,_._timeSlicesArray&&_._timeSlicesArray.length}if(r.waterManager&&r.waterManager.waterLayersArray.length>0){var y=r.waterManager.waterLayersArray[0];y.waterHeightTexA&&y.waterHeightTexA.texId,y.waterSourceTex&&y.waterSourceTex.texId,y.waterFluxTexA_HIGH&&y.waterFluxTexA_HIGH.texId,y.waterFluxTexA_LOW&&y.waterFluxTexA_LOW.texId,y.waterVelocityTexA&&y.waterVelocityTexA.texId,y.demWithBuildingsTex&&y.demWithBuildingsTex.texId,y.dem_texture&&y.dem_texture.texId,y.shaderLogTexA&&y.shaderLogTexA.texId,y.shaderLogParticlesPos_TexA&&y.shaderLogParticlesPos_TexA.texId,y.shaderLogTex_Flux_A&&y.shaderLogTex_Flux_A.texId,y.particlesPosTex_A&&y.particlesPosTex_A.texId,y.particlesTex_A&&y.particlesTex_A.texId,y.contaminationTex_A&&y.contaminationTex_A.texId,y.contaminantSourceTex&&y.contaminantSourceTex.texId,y.terrainMaxSlippageTex&&y.terrainMaxSlippageTex.texId,y.terrainFluxTexA_HIGH&&y.terrainFluxTexA_HIGH.texId,y.terrainFluxTexA_LOW&&y.terrainFluxTexA_LOW.texId,y.waterAditionTex&&y.waterAditionTex.texId,y.original_dem_texture&&y.original_dem_texture.texId,y.qSurfaceMesh_dem_texture&&y.qSurfaceMesh_dem_texture.texId}var T=i.sunSystem;if(T){var C=T.getLight(1);C&&C.depthFbo&&C.depthFbo.colorBuffer}if(r.scene&&r.scene.view.globeDepth.framebuffer._texture,r.screenSpaceFBO,void 0!==f){e.activeTexture(e.TEXTURE0+0),e.bindTexture(e.TEXTURE_2D,f),this.auxCubeMap||(this.auxCubeMap=r.texturesStore.getCubeMapAux1x1()),e.activeTexture(e.TEXTURE0+1),e.bindTexture(e.TEXTURE_CUBE_MAP,this.auxCubeMap);var b=new So(e);b.frontFace(e.CCW),b.depthMask(!1),b.disable_GL_DEPTH_TEST(),e.drawArrays(e.TRIANGLES,0,6),d.useProgram(null),b.restoreAllParameters(),e.activeTexture(e.TEXTURE0+0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+1),e.bindTexture(e.TEXTURE_CUBE_MAP,null)}}},bo.prototype.renderScreenRectangleMosaic=function(e,t){var r=this.magoManager,i=r.sceneState;i.drawingBufferWidth[0],i.drawingBufferHeight[0];if(void 0===this.quadBuffer_mosaic){var o=new Float32Array([0,.5,.5,.5,0,1,0,1,.5,.5,.5,1]);this.quadBuffer_mosaic=ae.createBuffer(e,o);var n=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.texCoordBuffer=ae.createBuffer(e,n);var a=new Jr(1,-1,-1);a.unitary();var s=new Jr(-1,-1,-1);s.unitary();var l=new Jr(-1,1,-1);l.unitary();var u=new Jr(1,1,-1);u.unitary(),(a=new Jr(1,1,1)).unitary(),(s=new Jr(-1,1,1)).unitary(),(l=new Jr(-1,1,-1)).unitary(),(u=new Jr(1,1,-1)).unitary();var c=new Float32Array([u.x,u.y,u.z,l.x,l.y,l.z,a.x,a.y,a.z,a.x,a.y,a.z,l.x,l.y,l.z,s.x,s.y,s.z]);this.normalBuffer=ae.createBuffer(e,c)}var d=r.postFxShadersManager;if(void 0!==d){d.getCurrentShader();var h=d.getShader("rectangleScreenMosaic");d.useProgram(h);r.texturesStore.getTextureAux1x1();e.enableVertexAttribArray(h.position2_loc),ae.bindAttribute(e,this.quadBuffer_mosaic,h.position2_loc,2),-1!==h.normal3_loc&&(e.enableVertexAttribArray(h.normal3_loc),ae.bindAttribute(e,this.normalBuffer,h.normal3_loc,3)),e.enableVertexAttribArray(h.texCoord2_loc),ae.bindAttribute(e,this.texCoordBuffer,h.texCoord2_loc,2);var f=r.getSilhouetteDepthFbo().colorBuffer;if(e.uniform1i(h.uTextureType_loc,0),e.uniform1i(h.uSliceIdx_loc,11),r.soundManager&&(void 0===this.lastIdx&&(this.lastIdx=0),r.soundManager.soundLayersArray.length>0)){var g=r.soundManager.soundLayersArray[0];g.demWithBuildingsTex&&g.demWithBuildingsTex.texId&&(f=g.demWithBuildingsTex.texId),g.soundSourceRealTexture3d&&g.soundSourceRealTexture3d.texturesArray.length>0&&(this.lastIdx>=g.soundSourceRealTexture3d.texturesArray.length&&(this.lastIdx=0),this.lastIdx+=1),g.soundSourceMosaicTexture3d&&g.soundSourceMosaicTexture3d.texturesArray.length,g.pressureMosaicTexture3d_A&&g.pressureMosaicTexture3d_A.texturesArray.length,g.pressureMosaicTexture3d_B&&g.pressureMosaicTexture3d_B.texturesArray.length,g.maxPressureMosaicTexture3d_A&&g.maxPressureMosaicTexture3d_A.texturesArray.length,g.fluxRFUMosaicTexture3d_HIGH_A&&g.fluxRFUMosaicTexture3d_LOW_A&&g.fluxLBDMosaicTexture3d_HIGH_A&&g.fluxLBDMosaicTexture3d_LOW_A,g.fluxRFUMosaicTexture3d_HIGH_A&&g.fluxRFUMosaicTexture3d_HIGH_A.texturesArray.length,g.fluxRFUMosaicTexture3d_HIGH_B&&g.fluxRFUMosaicTexture3d_HIGH_B.texturesArray.length,g.fluxRFUMosaicTexture3d_LOW_A&&g.fluxRFUMosaicTexture3d_LOW_A.texturesArray.length,g.fluxLBDMosaicTexture3d_HIGH_B&&g.fluxLBDMosaicTexture3d_HIGH_B.texturesArray.length,g.fluxLBDMosaicTexture3d_LOW_A&&g.fluxLBDMosaicTexture3d_LOW_A.texturesArray.length,g.auxMosaicTexture3d_forFluxCalculation&&g.auxMosaicTexture3d_forFluxCalculation.texturesArray.length,g.airVelocity_B&&g.airVelocity_B.texturesArray.length,g.shaderLogTexture&&g.shaderLogTexture.texturesArray.length,g.shaderLogTexture_vel&&g.shaderLogTexture_vel.texturesArray.length,g.simulBoxdoubleDepthTex,g.simulBoxDoubleNormalTex,g.volumRenderTex,g.auxTex3d_yDirection&&(g.auxTex3d_yDirection.texturesArray||g.auxTex3d_yDirection.texturesArray.length),g.mosaic_partial_ydirection&&(g.mosaic_partial_ydirection.texturesArray||g.mosaic_partial_ydirection.texturesArray.length)}if(e.uniform1iv(h.u_mosaicSize_loc,[1,1,1]),void 0!==f){e.activeTexture(e.TEXTURE0+0),e.bindTexture(e.TEXTURE_2D,f);var p=new So(e);p.frontFace(e.CCW),p.depthMask(!1),p.disable_GL_DEPTH_TEST(),e.drawArrays(e.TRIANGLES,0,6),d.useProgram(null),p.restoreAllParameters(),e.activeTexture(e.TEXTURE0+0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+1),e.bindTexture(e.TEXTURE_CUBE_MAP,null)}}},bo.prototype.renderScreenSpaceObjects=function(e){var t=this.magoManager;if(!t.screenSpaceFBO){var r=t.sceneState.drawingBufferWidth[0],i=t.sceneState.drawingBufferHeight[0],o=t.postFxShadersManager.bUseMultiRenderTarget;t.screenSpaceFBO=new ae(e,r,i,{matchCanvasSize:!0,multiRenderTarget:o,numColorBuffers:3})}var n=t.screenSpaceFBO,a=t.extbuffers;n.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,a.COLOR_ATTACHMENT0_WEBGL,e.TEXTURE_2D,n.colorBuffersArray[0],0),e.framebufferTexture2D(e.FRAMEBUFFER,a.COLOR_ATTACHMENT1_WEBGL,e.TEXTURE_2D,n.colorBuffersArray[1],0),e.framebufferTexture2D(e.FRAMEBUFFER,a.COLOR_ATTACHMENT2_WEBGL,e.TEXTURE_2D,n.colorBuffersArray[2],0),a.drawBuffersWEBGL([a.COLOR_ATTACHMENT0_WEBGL,a.COLOR_ATTACHMENT1_WEBGL,a.COLOR_ATTACHMENT2_WEBGL,a.NONE]),t.isFarestFrustum()&&(e.clearColor(0,0,0,0),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1)),e.clear(e.DEPTH_BUFFER_BIT),e.enable(e.BLEND);t.objMarkerManager.render(t,1),e.disable(e.BLEND)},bo.prototype.renderLightDepthCubeMaps=function(e){var t=this.magoManager,r=e.length;if(0!==r){var i=t.getGl(),o=t.sceneState,n=t.postFxShadersManager.getShader("modelRefDepth");n.resetLastBuffersBinded(),n.useProgram(),t.effectsManager.setCurrentShader(n),n.disableVertexAttribArrayAll(),n.enableVertexAttribArray(n.position3_loc);var a;i.uniform1i(n.bUseLogarithmicDepth_loc,!1),i.uniform1f(n.uFCoef_logDepth_loc,o.fCoef_logDepth[0]),i.uniform1i(n.bHasTexture_loc,!1),i.uniform1i(n.uFrustumIdx_loc,t.currentFrustumIdx),i.uniform1i(n.bUseMultiRenderTarget_loc,!1),i.uniform3fv(n.scaleLC_loc,[1,1,1]),i.uniform1i(n.bApplySsao_loc,!1),i.uniform3fv(n.aditionalMov_loc,[0,0,0]),i.depthRange(0,1),i.depthMask(!0),i.enable(i.CULL_FACE),i.enable(i.DEPTH_TEST),i.disable(i.BLEND);for(var s={bRenderOpaques:!0,bRenderTransparents:!1},l=0;l<r;l++)if(!(a=e[l]).bCubeMapMade){var u=a.visibleObjectsControler;if(u){u.currentVisibles0.length,u.currentVisibleNativeObjects.opaquesArray.length;var c=a.getGeoLocDataManager().getCurrentGeoLocationData();i.uniform3fv(n.encodedCameraPositionMCHigh_loc,c.positionHIGH),i.uniform3fv(n.encodedCameraPositionMCLow_loc,c.positionLOW);var d=a._getCubeMapFrameBuffer(i);i.viewport(0,0,d.width[0],d.width[0]),i.clearColor(1,1,1,1),i.clearDepth(1);for(var h=0;h<6;h++){a.bindCubeMapFrameBuffer(h,t),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);var f=a.getModelViewProjectionMatrixRelToEye(h),g=a.getModelViewMatrixRelToEye(h);i.uniform1i(n.refMatrixType_loc,0),i.uniformMatrix4fv(n.mvpRelToEyeMatrix_loc,!1,f._floatArrays),i.uniformMatrix4fv(n.mvRelToEyeMatrix_loc,!1,g._floatArrays),i.uniform1f(n.frustumFar_loc,a.falloffDistance),t.swapRenderingFase(),this.renderNodes(i,u.currentVisibles0,t,n,void 0,0,void 0,0),this.renderNativeObjects(i,n,0,u,s)}i.clearColor(0,0,0,1),a.bCubeMapMade=!0}}i.bindFramebuffer(i.FRAMEBUFFER,null)}},bo.prototype.renderLightBuffer=function(e){var t=this.magoManager,r=e.length,i=t.getGl(),o=t.sceneState,n=t.lBuffer;n.bind();var a=n.extbuffers;if(i.framebufferTexture2D(i.FRAMEBUFFER,n.extbuffers.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,t.diffuseLightTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.extbuffers.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,t.specularLightTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.extbuffers.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,t.LightFogTex,0),a.drawBuffersWEBGL([n.extbuffers.COLOR_ATTACHMENT0_WEBGL,n.extbuffers.COLOR_ATTACHMENT1_WEBGL,n.extbuffers.COLOR_ATTACHMENT2_WEBGL]),i.viewport(0,0,o.drawingBufferWidth[0],o.drawingBufferHeight[0]),i.clearColor(0,0,0,0),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.clearColor(0,0,0,1),0!==r){var s=o.applyLightsShadows,l=t.postFxShadersManager.getShader("lBuffer");t.postFxShadersManager.useProgram(l),t.effectsManager.setCurrentShader(l),i.uniform1i(l.bUseLogarithmicDepth_loc,t.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(l.bApplySpecularLighting_loc,!0),i.uniform1f(l.uFCoef_logDepth_loc,o.fCoef_logDepth[0]),i.uniform1i(l.bUseMultiRenderTarget_loc,t.postFxShadersManager.bUseMultiRenderTarget),i.uniform2fv(l.uNearFarArray_loc,t.frustumVolumeControl.nearFarArray),i.uniform1i(l.bApplyShadows_loc,s),i.enableVertexAttribArray(l.texCoord2_loc),i.enableVertexAttribArray(l.position3_loc),i.enableVertexAttribArray(l.normal3_loc),-1!==l.color4_loc&&i.disableVertexAttribArray(l.color4_loc),l.bindUniformGenerals(),i.uniformMatrix4fv(l.ModelViewProjectionMatrixRelToEye_loc,!1,o.modelViewProjRelToEyeMatrixLighting._floatArrays);var u,c=o.getModelViewRelToEyeMatrixInv();i.uniformMatrix4fv(l.modelViewMatrixRelToEyeInv_loc,!1,c._floatArrays),i.uniform1f(l.externalAlpha_loc,1),i.uniform1i(l.textureFlipYAxis_loc,t.sceneState.textureFlipYAxis),i.uniform1i(l.refMatrixType_loc,0),i.uniform3fv(l.scaleLC_loc,[1,1,1]),i.uniform4fv(l.colorMultiplier_loc,[1,1,1,1]),i.uniform3fv(l.aditionalMov_loc,[0,0,0]),i.uniform1i(l.normalTex_loc,1),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,t.depthTex),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,t.normalTex),i.frontFace(i.CW),i.enable(i.BLEND),i.blendFunc(i.SRC_ALPHA,i.ONE),i.depthMask(!1),i.disable(i.DEPTH_TEST);for(var d=0;d<r;d++){var h=(u=e[d]).getLightDirectionWC(),f=u._getCubeMapFrameBuffer(i),g=u.geoLocDataManager.getCurrentGeoLocationData().getRotMatrixInv();i.uniformMatrix4fv(l.buildingRotMatrixInv_loc,!1,g._floatArrays),i.uniform3fv(l.lightDirWC_loc,[h.x,h.y,h.z]),i.uniform3fv(l.uLightColorAndBrightness_loc,[u.color.r,u.color.g,u.color.b]),i.uniform1f(l.uLightIntensity_loc,u.intensity);var p=u.getLightParameters();p&&(i.uniform1fv(l.uLightParameters_loc,p),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_CUBE_MAP,f.colorBuffer),i.uniform1i(l.u_processType_loc,1),i.frontFace(i.CW),i.blendFunc(i.SRC_ALPHA,i.ONE),u.render(t,l,1,void 0,void 0),i.uniform1i(l.u_processType_loc,2),i.frontFace(i.CCW),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),u.render(t,l,1,void 0,void 0))}t.postFxShadersManager.useProgram(null),n.unbind(),i.frontFace(i.CCW),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.depthMask(!0),i.enable(i.DEPTH_TEST),i.disable(i.BLEND)}},bo.prototype.renderGeometryBufferORT=function(e,t,r,i){var o,n=this.magoManager,a=n.sceneState,s=n._settings.getRenderingSettings();e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.enable(e.CULL_FACE);if(e.disable(e.BLEND),1===t){n.texturesStore.getTextureAux1x1(),n.texturesStore.getNoiseTexture4x4();n.currentProcess=I.magoCurrentProcess.ColorRendering;var l=!1;if(n.currentFrustumIdx<2&&(l=a.getApplySsao()),void 0!==a.sunSystem&&a.applySunShadows&&!0,n.checkChangesHistoryMovements(r),n.checkChangesHistoryColors(r),r.hasRenderables()||void 0!==n.modeler){var u=n.postFxShadersManager;o=u.getShader("gBufferORT"),u.useProgram(o),n.effectsManager.setCurrentShader(o),e.uniform1i(o.bUseLogarithmicDepth_loc,u.bUseLogarithmicDepth),e.uniform1f(o.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),e.uniform1i(o.clippingType_loc,0),e.uniform1i(o.uFrustumIdx_loc,n.currentFrustumIdx),e.uniform1i(o.bUseMultiRenderTarget_loc,u.bUseMultiRenderTarget);var c=a.getProjectionMatrixInv();e.uniformMatrix4fv(o.projectionMatrixInv_loc,!1,c._floatArrays);var d=a.getModelViewRelToEyeMatrixInv();if(e.uniformMatrix4fv(o.modelViewMatrixRelToEyeInv_loc,!1,d._floatArrays),void 0!==n.modeler.clippingBox){var h=n.modeler.clippingBox.getPlanesRelToEyevec4Array(n),f=new Float32Array(h);e.uniform1i(o.bApplyClippingPlanes_loc,!0),e.uniform1i(o.clippingPlanesCount_loc,6),e.uniform4fv(o.clippingPlanes_loc,f)}else e.uniform1i(o.bApplyClippingPlanes_loc,!1);e.enableVertexAttribArray(o.texCoord2_loc),e.enableVertexAttribArray(o.position3_loc),-1!==o.normal3_loc&&e.enableVertexAttribArray(o.normal3_loc),-1!==o.color4_loc&&e.disableVertexAttribArray(o.color4_loc),o.bindUniformGenerals(),e.uniform1i(o.textureFlipYAxis_loc,n.sceneState.textureFlipYAxis),e.uniform1i(o.refMatrixType_loc,0),e.uniform3fv(o.scaleLC_loc,[1,1,1]),e.uniform4fv(o.colorMultiplier_loc,[1,1,1,1]),e.uniform3fv(o.aditionalMov_loc,[0,0,0]),e.enable(e.CULL_FACE);t=1;o=u.getShader("gBufferORT"),u.useProgram(o),e.uniform1i(o.clippingType_loc,0),n.bindMainFramebuffer();var g=!0,p=!0,m=!0,v=!0,x=n.depthTex,_=n.normalTex,y=n.cesiumColorBuffer,T=n.selColorTex;i&&(void 0!==i.bRenderDepth&&(g=i.bRenderDepth),void 0!==i.bRenderNormal&&(p=i.bRenderNormal),void 0!==i.bRenderAlbedo&&(m=i.bRenderAlbedo),void 0!==i.bRenderSelColor&&(v=i.bRenderSelColor),void 0!==i.ouputDepthTex&&(x=i.ouputDepthTex),void 0!==i.ouputNormalTex&&(_=i.ouputNormalTex),void 0!==i.ouputAlbedoTex&&(y=i.ouputAlbedoTex),void 0!==i.ouputSelColorTex&&(T=i.ouputSelColorTex));for(var C=0;C<4;C++){if(0===C){if(!g)continue;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,x,0)}else if(1===C){if(!p)continue;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,_,0)}else if(2===C){if(!m)continue;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,y,0)}else if(3===C){if(!v)continue;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,T,0),n.isFarestFrustum()?(e.clearColor(1,1,1,1),e.clearDepth(1),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),e.clearColor(0,0,0,1)):(e.clearDepth(1),e.clear(e.DEPTH_BUFFER_BIT))}if(e.uniform1i(o.u_outputTarget_loc,C),2===C&&r.currentVisibles0.length>0);this.renderNodes(e,r.currentVisibles0,n,o,!1,t,0,0),e.uniform1i(o.bApplySsao_loc,l),this.renderNodes(e,r.currentVisibles2,n,o,!1,t,0,0),this.renderNodes(e,r.currentVisibles3,n,o,!1,t,0,0);i={bRenderOpaques:!0,bRenderTransparents:!1};this.renderNativeObjects(e,o,t,r,i),e.uniform1i(o.clippingType_loc,0),n.swapRenderingFase()}u.useProgram(null)}if(n.visibleObjControlerNodes.currentVisiblesAux.length>0){n.sceneState.camera.setCurrentFrustum(0);var b,M=n.currentFrustumIdx;n.sceneState.camera.frustum.near[0]=n.sceneState.camera.frustumsArray[M].near[0],n.sceneState.camera.frustum.far[0]=n.sceneState.camera.frustumsArray[M].far[0],(b=(s.getApplySsao(),s.getPointsCloudInColorRamp()?n.postFxShadersManager.getShader("pointsCloudSsao_rainbow"):n.postFxShadersManager.getShader("pointsCloudSsao"))).useProgram(),b.resetLastBuffersBinded(),b.enableVertexAttribArray(b.position3_loc),b.enableVertexAttribArray(b.color4_loc),b.bindUniformGenerals(),e.uniform1f(b.externalAlpha_loc,1);l=!0;e.uniform1i(b.bApplySsao_loc,l),void 0!==n.pointsCloudWhite&&n.pointsCloudWhite?(e.uniform1i(b.bUse1Color_loc,!0),e.uniform4fv(b.oneColor4_loc,[.99,.99,.99,1])):e.uniform1i(b.bUse1Color_loc,!1);var A=n.magoPolicy.getPointsCloudSettings();e.uniform1i(b.bUseColorCodingByHeight_loc,!0),e.uniform1f(b.minHeight_rainbow_loc,parseInt(A.minHeightRainbow)),e.uniform1f(b.maxHeight_rainbow_loc,parseInt(A.maxHeightRainbow)),e.uniform1f(b.maxPointSize_loc,parseInt(A.maxPointSize)),e.uniform1f(b.minPointSize_loc,parseInt(A.minPointSize)),e.uniform1f(b.pendentPointSize_loc,parseInt(A.pendentPointSize)),e.uniform1i(b.bUseLogarithmicDepth_loc,n.postFxShadersManager.bUseLogarithmicDepth),e.uniform1i(b.bUseMultiRenderTarget_loc,n.postFxShadersManager.bUseMultiRenderTarget),e.uniform1f(b.uFCoef_logDepth_loc,a.fCoef_logDepth[0]),e.uniform2fv(b.uNearFarArray_loc,n.frustumVolumeControl.nearFarArray),e.uniform1i(b.uFrustumIdx_loc,n.currentFrustumIdx),void 0===n.visibleObjControlerPCloudOctrees&&(n.visibleObjControlerPCloudOctrees=new _t),n.visibleObjControlerPCloudOctrees.clear(),this.renderNeoBuildingsPCloud(e,n.visibleObjControlerNodes.currentVisiblesAux,n,b,!1,t),b.disableVertexAttribArrayAll(),e.useProgram(null);var E=n.visibleObjControlerPCloudOctrees.currentVisibles0,L=E.length,w=0;if(!n.isCameraMoving&&!n.mouseLeftDown&&!n.mouseMiddleDown)for(C=0;C<L;C++){if(E[C].preparePCloudData(n)&&w++,w>1)break}}}e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,n.cesiumColorBuffer,0),e.depthRange(0,1)},bo.prototype.renderGeometryBuffer=function(e,t,r){var i,o=this.magoManager,n=o.sceneState,a=o._settings.getRenderingSettings();e.enable(e.DEPTH_TEST),e.enable(e.CULL_FACE),e.disable(e.BLEND);if(1===t){o.texturesStore.getTextureAux1x1(),o.texturesStore.getNoiseTexture4x4();o.currentProcess=I.magoCurrentProcess.ColorRendering;var s=!1;o.currentFrustumIdx<2&&(s=n.getApplySsao()),void 0!==n.sunSystem&&n.applySunShadows&&!0,o.checkChangesHistoryMovements(r),o.checkChangesHistoryColors(r);var l=r.hasRenderables(),u=r.mgSetsArray;if(u&&u.length>0);if(l||void 0!==o.modeler){var c=o.postFxShadersManager;i=c.getShader("gBuffer"),c.useProgram(i),o.effectsManager.setCurrentShader(i),e.uniform1i(i.bUseLogarithmicDepth_loc,c.bUseLogarithmicDepth),e.uniform1f(i.uFCoef_logDepth_loc,n.fCoef_logDepth[0]),e.uniform1i(i.clippingType_loc,0),e.uniform1i(i.uFrustumIdx_loc,o.currentFrustumIdx),e.uniform1i(i.bUseMultiRenderTarget_loc,c.bUseMultiRenderTarget);var d=n.getProjectionMatrixInv();e.uniformMatrix4fv(i.projectionMatrixInv_loc,!1,d._floatArrays);var h=n.getModelViewRelToEyeMatrixInv();e.uniformMatrix4fv(i.modelViewMatrixRelToEyeInv_loc,!1,h._floatArrays);var f=o.modeler.clippingBox;if(void 0!==f){var g=f.getCurrentGeoLocationData();e.uniform3fv(i.uniformsLocations["clippingBoxSplittedPos[0]"],g.positionSplitted);var p=f.getPlanesPositionsFloat32Array(),m=f.getPlanesNormalsFloat32Array(),v=f.getPlanesCount();e.uniform1i(i.bApplyClippingPlanes_loc,!0),e.uniform1i(i.clippingPlanesCount_loc,v);var x=i.uniformsLocations["clippingBoxPlanesPosLC[0]"],_=i.uniformsLocations["clippingBoxPlanesNorLC[0]"];e.uniform3fv(x,p),e.uniform3fv(_,m),e.uniformMatrix4fv(i.uniformsLocations.clippingBoxRotMatrix,!1,g.rotMatrix._floatArrays)}else e.uniform1i(i.bApplyClippingPlanes_loc,!1);e.enableVertexAttribArray(i.texCoord2_loc),e.enableVertexAttribArray(i.position3_loc),-1!==i.normal3_loc&&e.enableVertexAttribArray(i.normal3_loc),-1!==i.color4_loc&&e.disableVertexAttribArray(i.color4_loc),i.bindUniformGenerals(),e.uniform1i(i.textureFlipYAxis_loc,o.sceneState.textureFlipYAxis),e.uniform1i(i.refMatrixType_loc,0),e.uniform3fv(i.scaleLC_loc,[1,1,1]),e.uniform4fv(i.colorMultiplier_loc,[1,1,1,1]),e.uniform3fv(i.aditionalMov_loc,[0,0,0]);t=1;i=c.getShader("gBuffer"),c.useProgram(i),e.uniform1i(i.clippingType_loc,0),this.renderNodes(e,r.currentVisibles0,o,i,!1,t,0,0),e.uniform1i(i.bApplySsao_loc,s),this.renderNodes(e,r.currentVisibles2,o,i,!1,t,0,0),this.renderNodes(e,r.currentVisibles3,o,i,!1,t,0,0);this.renderNativeObjects(e,i,t,r,{bRenderOpaques:!0,bRenderTransparents:!1}),e.uniform1i(i.clippingType_loc,0),r.mgSetsArray.length>0&&this.renderMgSets(r.mgSetsArray,i,!1,t,0),i.disableVertexAttribArrayAll(),c.useProgram(null)}if(o.magoPolicy.getShowOrigin()&&r.getAllVisibles().length>0&&this.renderAxisNodes(r.getAllVisibles(),t),o.visibleObjControlerNodes.currentVisiblesAux.length>0){o.sceneState.camera.setCurrentFrustum(0);var y,T=o.currentFrustumIdx;o.sceneState.camera.frustum.near[0]=o.sceneState.camera.frustumsArray[T].near[0],o.sceneState.camera.frustum.far[0]=o.sceneState.camera.frustumsArray[T].far[0],(y=(a.getApplySsao(),a.getPointsCloudInColorRamp()?o.postFxShadersManager.getShader("pointsCloudSsao_rainbow"):o.postFxShadersManager.getShader("pointsCloudSsao"))).useProgram(),y.resetLastBuffersBinded(),y.enableVertexAttribArray(y.position3_loc),y.enableVertexAttribArray(y.color4_loc),y.bindUniformGenerals(),e.uniform1f(y.externalAlpha_loc,1);s=!0;e.uniform1i(y.bApplySsao_loc,s),void 0!==o.pointsCloudWhite&&o.pointsCloudWhite?(e.uniform1i(y.bUse1Color_loc,!0),e.uniform4fv(y.oneColor4_loc,[.99,.99,.99,1])):e.uniform1i(y.bUse1Color_loc,!1);var C=o.magoPolicy.getPointsCloudSettings();e.uniform1i(y.bUseColorCodingByHeight_loc,!0),e.uniform1f(y.minHeight_rainbow_loc,parseInt(C.minHeightRainbow)),e.uniform1f(y.maxHeight_rainbow_loc,parseInt(C.maxHeightRainbow)),e.uniform1f(y.maxPointSize_loc,parseInt(C.maxPointSize)),e.uniform1f(y.minPointSize_loc,parseInt(C.minPointSize)),e.uniform1f(y.pendentPointSize_loc,parseInt(C.pendentPointSize)),e.uniform1i(y.bUseLogarithmicDepth_loc,o.postFxShadersManager.bUseLogarithmicDepth),e.uniform1i(y.bUseMultiRenderTarget_loc,o.postFxShadersManager.bUseMultiRenderTarget),e.uniform1f(y.uFCoef_logDepth_loc,n.fCoef_logDepth[0]),e.uniform2fv(y.uNearFarArray_loc,o.frustumVolumeControl.nearFarArray),e.uniform1i(y.uFrustumIdx_loc,o.currentFrustumIdx),void 0===o.visibleObjControlerPCloudOctrees&&(o.visibleObjControlerPCloudOctrees=new _t),o.visibleObjControlerPCloudOctrees.clear(),this.renderNeoBuildingsPCloud(e,o.visibleObjControlerNodes.currentVisiblesAux,o,y,!1,t),y.disableVertexAttribArrayAll(),e.useProgram(null);var b=o.visibleObjControlerPCloudOctrees.currentVisibles0,M=b.length,A=0;if(!o.isCameraMoving&&!o.mouseLeftDown&&!o.mouseMiddleDown)for(var E=0;E<M;E++){if(b[E].preparePCloudData(o)&&A++,A>1)break}}}},bo.prototype.renderGeometryBufferTransparents=function(e,t,r){var i;e.enable(e.DEPTH_TEST),e.enable(e.BLEND);var o=this.magoManager,n=o.sceneState;o._settings.getRenderingSettings(),o.selectionManager;if(e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),1===t){var a=o.texturesStore.getTextureAux1x1();o.texturesStore.getNoiseTexture4x4();o.currentProcess=I.magoCurrentProcess.ColorRendering;var s=!1,l=!1;if(o.currentFrustumIdx<2&&(s=n.getApplySsao()),void 0!==n.sunSystem&&n.applySunShadows&&(l=!0),o.checkChangesHistoryMovements(r),o.checkChangesHistoryColors(r),r.hasRenderables()||void 0!==o.modeler){i=o.postFxShadersManager.getShader("modelRefSsao"),o.postFxShadersManager.useProgram(i),o.effectsManager.setCurrentShader(i),e.uniform1i(i.bUseLogarithmicDepth_loc,o.postFxShadersManager.bUseLogarithmicDepth),e.uniform1i(i.bApplySsao_loc,s),e.uniform1i(i.bApplyShadow_loc,l),e.uniform1i(i.bApplySpecularLighting_loc,!0),e.uniform1f(i.uFCoef_logDepth_loc,n.fCoef_logDepth[0]),e.uniform1i(i.clippingType_loc,0),e.uniform1i(i.uFrustumIdx_loc,o.currentFrustumIdx),e.uniform1i(i.bUseMultiRenderTarget_loc,o.postFxShadersManager.bUseMultiRenderTarget);var u=n.getProjectionMatrixInv();e.uniformMatrix4fv(i.projectionMatrixInv_loc,!1,u._floatArrays);var c=n.getModelViewRelToEyeMatrixInv();e.uniformMatrix4fv(i.modelViewMatrixRelToEyeInv_loc,!1,c._floatArrays);var d=o.sceneState.sunSystem,h=d.getLight(0);if(l){var f=d.getLightsMatrixFloat32Array(),g=d.getLightsPosLOWFloat32Array(),p=d.getLightsPosHIGHFloat32Array(),m=d.getSunDirWC();void 0!==h.tMatrix&&(e.uniformMatrix4fv(i.sunMatrix_loc,!1,f),e.uniform3fv(i.sunPosHigh_loc,p),e.uniform3fv(i.sunPosLow_loc,g),e.uniform1f(i.shadowMapWidth_loc,h.targetTextureWidth),e.uniform1f(i.shadowMapHeight_loc,h.targetTextureHeight),e.uniform3fv(i.sunDirWC_loc,m),e.uniform1i(i.sunIdx_loc,1))}var v=o.modeler.clippingBox;if(void 0!==v){var x=v.getCurrentGeoLocationData();e.uniform3fv(i.uniformsLocations["clippingBoxSplittedPos[0]"],x.positionSplitted);var _=v.getPlanesPositionsFloat32Array(),y=v.getPlanesNormalsFloat32Array(),T=v.getPlanesCount();e.uniform1i(i.bApplyClippingPlanes_loc,!0),e.uniform1i(i.clippingPlanesCount_loc,T);var C=i.uniformsLocations["clippingBoxPlanesPosLC[0]"],b=i.uniformsLocations["clippingBoxPlanesNorLC[0]"];e.uniform3fv(C,_),e.uniform3fv(b,y),e.uniformMatrix4fv(i.uniformsLocations.clippingBoxRotMatrix,!1,x.rotMatrix._floatArrays)}else e.uniform1i(i.bApplyClippingPlanes_loc,!1);if(e.enableVertexAttribArray(i.texCoord2_loc),e.enableVertexAttribArray(i.position3_loc),e.enableVertexAttribArray(i.normal3_loc),-1!==i.color4_loc&&e.disableVertexAttribArray(i.color4_loc),i.bindUniformGenerals(),e.uniform1f(i.externalAlpha_loc,1),e.uniform1i(i.textureFlipYAxis_loc,o.sceneState.textureFlipYAxis),e.uniform1i(i.refMatrixType_loc,0),e.uniform3fv(i.scaleLC_loc,[1,1,1]),e.uniform4fv(i.colorMultiplier_loc,[1,1,1,1]),e.uniform3fv(i.aditionalMov_loc,[0,0,0]),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,a),e.activeTexture(e.TEXTURE3),l&&h.depthFbo){h=d.getLight(0);e.bindTexture(e.TEXTURE_2D,h.depthFbo.colorBuffer)}else e.bindTexture(e.TEXTURE_2D,a);if(e.activeTexture(e.TEXTURE4),l&&h.depthFbo){h=d.getLight(1);e.bindTexture(e.TEXTURE_2D,h.depthFbo.colorBuffer)}else e.bindTexture(e.TEXTURE_2D,a);e.enable(e.CULL_FACE);t=1;o.modeler.render(o,i,t),(i=o.postFxShadersManager.getShader("modelRefSsao")).useProgram(),e.uniform1i(i.clippingType_loc,0),e.uniform1f(i.uModelOpacity_loc,1),this.renderExcavationObjects(e,i,t,r),this.renderNodes(e,r.currentVisibles0Transparents,o,i,!1,t,0,0),e.uniform1i(i.bApplySsao_loc,s),this.renderNodes(e,r.currentVisibles2Transparents,o,i,!1,t,0,0),this.renderNodes(e,r.currentVisibles3Transparents,o,i,!1,t,0,0);this.renderNativeObjects(e,i,t,r,{bRenderOpaques:!1,bRenderTransparents:!0}),e.uniform1i(i.clippingType_loc,0),i.disableVertexAttribArrayAll(),o.postFxShadersManager.useProgram(null)}o.magoPolicy.getShowOrigin()&&r.getAllVisibles().length>0&&this.renderAxisNodes(r.getAllVisibles(),t)}e.disable(e.BLEND)},bo.prototype.renderAxisNodes=function(e,t){var r=this.magoManager;0===r.axisXYZ.vbo_vicks_container.vboCacheKeysArray.length&&r.axisXYZ.makeMesh(30).getVboTrianglesConvex(r.axisXYZ.vbo_vicks_container,r.vboMemoryManager);var i,o,n=r.getGl();0===t&&(o=r.postFxShadersManager.getShader("modelRefDepth"),n.disable(n.BLEND)),1===t&&(o=r.postFxShadersManager.getShader("modelRefSsao"),n.enable(n.BLEND));var a=r.texturesStore.getNoiseTexture4x4();o.useProgram(),n.uniform1i(o.bApplySsao_loc,!0),n.uniform1i(o.refMatrixType_loc,0),n.uniform1i(o.colorType_loc,1),o.disableVertexAttribArray(o.texCoord2_loc);o.program;if(o.bindUniformGenerals(),n.enableVertexAttribArray(o.position3_loc),1===t){var s=r.texturesStore.getTextureAux1x1();n.enableVertexAttribArray(o.normal3_loc),n.enableVertexAttribArray(o.color4_loc),n.uniform1i(o.bUse1Color_loc,!1),n.uniform4fv(o.oneColor4_loc,[1,.1,.1,1]),n.uniform1i(o.bUseNormal_loc,!0),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,r.depthFboNeo.colorBuffer),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,a),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,s)}for(var l=e.length,u=0;u<l;u++){(i=e[u]).data.neoBuilding,n.uniform3fv(o.scale_loc,[1,1,1]),i.getNodeGeoLocDataManager().getCurrentGeoLocationData().bindGeoLocationUniforms(n,o),n.uniform3fv(o.aditionalMov_loc,[0,0,0]),this.renderObject(n,r.axisXYZ,r,o,t)}o.disableVertexAttribArrayAll(),n.disable(n.BLEND)},bo.prototype.renderBoundingBoxesNodes=function(e,t,r){var i=this.magoManager,o=i.getGl();if(void 0!==e&&0!==e.length){var n;void 0===i.unitaryBoxSC&&(i.unitaryBoxSC=new yr,i.unitaryBoxSC.makeAABB(1,1,1),i.unitaryBoxSC.vBOVertexIdxCacheKey=i.unitaryBoxSC.triPolyhedron.getVBOArrayModePosNorCol(i.unitaryBoxSC.vBOVertexIdxCacheKey,i.vboMemoryManager));var a=i.postFxShadersManager.getUnitaryBBoxShader(i);a.program;a.useProgram(),a.disableVertexAttribArrayAll(),a.disableTextureImagesUnitsAll(),o.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,i.sceneState.modelViewProjRelToEyeMatrix._floatArrays),o.uniform3fv(a.cameraPosHIGH_loc,i.sceneState.encodedCamPosHigh),o.uniform3fv(a.cameraPosLOW_loc,i.sceneState.encodedCamPosLow),o.uniform3fv(a.aditionalMov_loc,[0,0,0]),o.uniform1i(a.bScale_loc,!0);var s;o.uniform1i(a.bUse1Color_loc,!0),t?o.uniform4fv(a.oneColor4_loc,[t.r,t.g,t.b,1]):o.uniform4fv(a.oneColor4_loc,[1,0,1,1]);for(var l=e.length,u=0;u<l;u++){a.resetLastBuffersBinded(),(n=e[u]).data.neoBuilding,s=n.getBBox(),o.uniform3fv(a.scale_loc,[s.getXLength(),s.getYLength(),s.getZLength()]),n.getNodeGeoLocDataManager().getCurrentGeoLocationData().bindGeoLocationUniforms(o,a),i.pointSC=s.getCenterPoint(i.pointSC),o.uniform3fv(a.aditionalMov_loc,[i.pointSC.x,i.pointSC.y,i.pointSC.z]),this.renderObject(o,i.unitaryBoxSC,i,a,1,r)}a.resetLastBuffersBinded(),a.disableVertexAttribArrayAll(),a.disableTextureImagesUnitsAll()}},bo.prototype.renderMagoGeometries=function(e){var t=this.magoManager;if(void 0===t.nativeProjectsArray){t.nativeProjectsArray=[];var r=new Fr;t.nativeProjectsArray.push(r),(d=r.newParametricMesh()).profile=new ii;var i,o=d.profile;o.TEST__setFigureHole_2(),void 0===d.vboKeyContainer&&(d.vboKeyContainer=new xt),void 0===d.vboKeyContainerEdges&&(d.vboKeyContainerEdges=new xt),90,i=new mi;var n=new Kr(20,-10),a=new Kr(20,10);i.setPoints(n,a),24,d.revolve(o,90,24,i),!0,!0;var s=d.getSurfaceIndependentMesh(void 0,!0,!0);if(s.setColor(.1,.5,.5,1),s.getVbo(d.vboKeyContainer,t.vboMemoryManager),s.getVboEdges(d.vboKeyContainerEdges,t.vboMemoryManager),void 0===r.geoLocDataManager){r.geoLocDataManager=new ye;var l=r.geoLocDataManager.newGeoLocationData("deploymentLoc");on.calculateGeoLocationData(126.61120237344926,37.577213509597016,50,0,0,0,l,t)}}var u,c=t.sceneState.gl;0===e&&(u=t.postFxShadersManager.getShader("modelRefDepth"),c.disable(c.BLEND)),1===e&&(u=t.postFxShadersManager.getShader("modelRefSsao"),c.enable(c.BLEND)),u.useProgram(),c.uniform1i(u.bApplySsao_loc,!0),c.uniform1i(u.refMatrixType_loc,0),c.uniform1i(u.colorType_loc,1),c.uniform1i(u.bApplySpecularLighting_loc,!0),u.disableVertexAttribArray(u.texCoord2_loc);var d,h;u.program;if(u.bindUniformGenerals(),c.enableVertexAttribArray(u.position3_loc),1===e){var f=t.texturesStore.getTextureAux1x1(),g=t.texturesStore.getNoiseTexture4x4();c.enableVertexAttribArray(u.normal3_loc),c.enableVertexAttribArray(u.color4_loc),c.uniform1i(u.bUse1Color_loc,!1),c.uniform4fv(u.oneColor4_loc,[1,.1,.1,1]),c.uniform1i(u.bUseNormal_loc,!0),c.activeTexture(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,t.depthFboNeo.colorBuffer),c.activeTexture(c.TEXTURE1),c.bindTexture(c.TEXTURE_2D,g),c.activeTexture(c.TEXTURE2),c.bindTexture(c.TEXTURE_2D,f)}for(var p=t.nativeProjectsArray.length,m=0;m<p;m++){h=(r=t.nativeProjectsArray[m]).geoLocDataManager,c.uniform3fv(u.scale_loc,[1,1,1]),h.getCurrentGeoLocationData().bindGeoLocationUniforms(c,u),c.uniform3fv(u.aditionalMov_loc,[0,0,0]);for(var v=r.getMeshesCount(),x=0;x<v;x++)d=r.getMesh(x),this.renderObject(c,d,t,u,e,!1)}u&&(-1!==u.texCoord2_loc&&c.disableVertexAttribArray(u.texCoord2_loc),-1!==u.position3_loc&&c.disableVertexAttribArray(u.position3_loc),-1!==u.normal3_loc&&c.disableVertexAttribArray(u.normal3_loc),-1!==u.color4_loc&&c.disableVertexAttribArray(u.color4_loc)),c.disable(c.BLEND)};var Mo=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._bApplySsao=!0,this._bPointsCloudInColorRamp=!1};Mo.prototype.getApplySsao=function(){return this._bApplySsao},Mo.prototype.setApplySsao=function(e){this._bApplySsao=e},Mo.prototype.getPointsCloudInColorRamp=function(){return this._bPointsCloudInColorRamp},Mo.prototype.setPointsCloudInColorRamp=function(e){this._bPointsCloudInColorRamp=e};var Ao=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl,this.modelMatrix=new Ne,this.viewMatrix=new Ne,this.modelViewProjRelToEyeMatrix=new Ne,this.modelViewRelToEyeMatrix=new Ne,this.modelViewRelToEyeMatrixInv=new Ne,this.modelViewMatrix=new Ne,this.modelViewMatrixInv=new Ne,this.projectionMatrix=new Ne,this.projectionMatrixInv=new Ne,this.modelViewProjMatrix=new Ne,this.modelViewProjMatrixInv,this.normalMatrix4=new Ne,this.identityMatrix4=new Ne,this.modelViewMatrixLast=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.projectionMatrixLast=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.projectionMatrixSky=new Ne,this.modelViewProjRelToEyeMatrixSky=new Ne,this.projectionMatrixLighting=new Ne,this.modelViewProjRelToEyeMatrixLighting=new Ne,this.encodedCamPosHigh=new Float32Array([0,0,0]),this.encodedCamPosLow=new Float32Array([0,0,0]),this.camera=new X,this.camera.id="mainCamera",this.drawingBufferWidth=new Int32Array([1e3]),this.drawingBufferHeight=new Int32Array([1e3]),this.mouseAction=new Ge,this.fCoef_logDepth=new Float32Array([1]);this.sunLight=new Le(2),this.sunSystem=new et,this.applySunShadows=!1,this.bApplySsao=!0,this.applyLightsShadows=!0,this.applyBloomEffect=!1,this.ambientReflectionCoef=new Float32Array([.5]),this.diffuseReflectionCoef=new Float32Array([1]),this.specularReflectionCoef=new Float32Array([.6]),this.specularColor=new Float32Array([.7,.7,.7]),this.ambientColor=new Float32Array([.6,.6,.6]),this.ssaoRadius=new Float32Array([.15]),this.brightnessContrastSaturation=new Float32Array([.01,.15,.05]),this.brightnessContrastType=0,this.shininessValue=new Float32Array([10]),this.ssaoNoiseScale2=new Float32Array([1,1]),this.ssaoKernel16=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.9,.2,-.15,.85,.6,0,.55,.5,.6,.95,-.01,.7,.6,-.33,.5,.99,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.55]),this.ssaoSphereKernel32=new Float32Array([.33,0,.85,.25,.3,.5,.1,.3,.85,-.15,.2,.85,-.33,.05,.6,-.1,-.15,.85,-.05,-.32,.25,.2,-.15,.85,.6,0,.55,.5,.6,.45,-.01,.7,.35,-.33,.5,.45,-.45,0,.55,-.65,-.5,.7,0,-.5,.55,.33,.3,.35,.33,0,-.85,.25,.3,-.5,.1,.3,-.85,-.15,.2,-.85,-.33,.05,-.6,-.1,-.15,-.85,-.05,-.32,-.25,.2,-.15,-.85,.6,0,-.55,.5,.6,-.45,-.01,.7,-.35,-.33,.5,-.45,-.45,0,-.55,-.65,-.5,-.7,0,-.5,-.55,.33,.3,-.35]),this.bMust=!1,this.dc,this.insertIssueState=0,this.textureFlipYAxis=!1,this.mouseButton=-1,this.trianglesRenderedCount=0,this.pointsRenderedCount=0,this.fps=0,"cesium"!==t.getPolicy().basicGlobe&&this.initMagoSceneState(t.getContainerId())};Ao.prototype.initMagoSceneState=function(e){var t=document.getElementById(e);if(!t)throw new Error("container is empty.");var r=document.createElement("canvas");r.id="_mago3dCanvas",r.style.width="100%",r.style.height="100%",t.appendChild(r);var i={antialias:!0,stencil:!0,premultipliedAlpha:!1},o=r.getContext("webgl",{glAttrs:i});o||(o=r.getContext("experimental-webgl",i)),r.width=r.clientWidth,r.height=r.clientHeight,this.canvas=r,this.gl=o,this.setDrawingBufferSize(r.offsetWidth,r.offsetHeight),this.camera.position.set(-7586937.743019165,10881859.054284709,5648264.99911627),this.camera.direction.set(.5307589970384617,-.7598419113077192,-.3754132585133587),this.camera.up.set(.23477224008249162,-.29380469331271475,.9265855321012102),this.encodedCamPosHigh[0]=-7536640,this.encodedCamPosHigh[1]=10878976,this.encodedCamPosHigh[2]=5636096,this.encodedCamPosLow[0]=-50297.7421875,this.encodedCamPosLow[1]=2883.05419921875,this.encodedCamPosLow[2]=12168.9990234375},Ao.prototype.resetStadistics=function(){this.trianglesRenderedCount=0,this.pointsRenderedCount=0,this.fps=0},Ao.prototype.restoreDefaultValuesAmbientDiffuseSpecularCoeficients=function(){this.ambientReflectionCoef[0]=.7,this.diffuseReflectionCoef[0]=.4,this.specularReflectionCoef[0]=.6},Ao.prototype.getModelViewMatrixInv=function(){return this.modelViewMatrixInv.dirty&&(this.modelViewMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewMatrixInv._floatArrays,this.modelViewMatrix._floatArrays),this.modelViewMatrixInv.dirty=!1),this.modelViewMatrixInv},Ao.prototype.getProjectionMatrixInv=function(){return void 0===this.projectionMatrixInv&&(this.projectionMatrixInv=new Ne,this.projectionMatrixInv._floatArrays=glMatrix.mat4.invert(this.projectionMatrixInv._floatArrays,this.projectionMatrix._floatArrays)),this.projectionMatrixInv},Ao.prototype.getModelViewProjectionMatrixInv=function(){return void 0===this.modelViewProjMatrixInv&&(this.modelViewProjMatrixInv=new Ne,this.modelViewProjMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewProjMatrixInv._floatArrays,this.modelViewProjMatrix._floatArrays)),this.modelViewProjMatrixInv},Ao.prototype.getModelViewRelToEyeMatrixInv=function(){return void 0===this.modelViewRelToEyeMatrixInv&&(this.modelViewRelToEyeMatrixInv=new Ne,this.modelViewRelToEyeMatrixInv._floatArrays=glMatrix.mat4.invert(this.modelViewRelToEyeMatrixInv._floatArrays,this.modelViewRelToEyeMatrix._floatArrays)),this.modelViewRelToEyeMatrixInv},Ao.prototype.getCamera=function(){return this.camera},Ao.prototype.getScreenCenterPositionPixels=function(e){var t=this.drawingBufferWidth[0],r=this.drawingBufferHeight[0];return void 0===e&&(e=new Kr),e.set(Math.floor(t/2),Math.floor(r/2)),e},Ao.prototype.getApplySsao=function(){return this.bApplySsao},Ao.prototype.setApplySsao=function(e){this.bApplySsao=e},Ao.prototype.setApplySunShadows=function(e){this.applySunShadows=e},Ao.prototype.setDrawingBufferSize=function(e,t){if(e!==this.drawingBufferWidth[0]||t!==this.drawingBufferHeight[0]){this.drawingBufferWidth[0]=e,this.drawingBufferHeight[0]=t;var r=this.camera,i=r.getFrustum(0);r.frustum.aspectRatio[0]=e/t;var o=r.frustum.fovRad[0]/r.frustum.aspectRatio[0];r.frustum.fovyRad[0]=o,r.frustum.tangentOfHalfFovy[0]=Math.tan(r.frustum.fovyRad[0]/2),i.aspectRatio[0]=r.frustum.aspectRatio[0],i.fovyRad[0]=r.frustum.fovyRad[0],i.tangentOfHalfFovy[0]=r.frustum.tangentOfHalfFovy[0]}};var Eo=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.drawing_height,this.drawing_width,this.GAIA_selectFrameBuffer,this.GAIA_selectRenderBuffer,this.GAIA_selectRttTexture};Eo.prototype.init=function(e,t,r){this.drawing_height=r,this.drawing_width=t,this.GAIA_selectFrameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.GAIA_selectFrameBuffer),this.GAIA_selectRenderBuffer=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this.GAIA_selectRenderBuffer),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,this.drawing_width,this.drawing_height),this.GAIA_selectRttTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.GAIA_selectRttTexture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.drawing_width,this.drawing_height,0,e.RGBA,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.GAIA_selectRttTexture,0),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,this.GAIA_selectRenderBuffer),e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null)};var Lo=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.familyTypeName,this.candidatesMap={},this.currentSelected};Lo.prototype.setCandidate=function(e,t){void 0!==e&&t&&(this.candidatesMap[e]=t)},Lo.prototype.clearCandidate=function(){this.candidatesMap={},this.currentSelected=void 0},Lo.prototype.clearCurrentSelected=function(){this.currentSelected=void 0},Lo.prototype.selectObject=function(e){return this.currentSelected=this.candidatesMap[e],this.currentSelected};var wo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t,this.selCandidatesMap={},this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.provisionalF4dArray=[],this.provisionalF4dObjectArray=[],this.provisionalNativeArray=[],this.currentReferenceSelected,this.currentOctreeSelected,this.currentBuildingSelected,this.currentNodeSelected,this.currentGeneralObjectSelected,this.currentReferenceSelectedArray=[],this.currentOctreeSelectedArray=[],this.currentBuildingSelectedArray=[],this.currentNodeSelectedArray=[],this.currentGeneralObjectSelectedArray=[],this.selCandidatesFamilyMap={},this.parentSelected=!1,this.selectionFbo=new ae(this.magoManager.getGl(),this.magoManager.sceneState.drawingBufferWidth[0],this.magoManager.sceneState.drawingBufferHeight[0],{matchCanvasSize:!0})};wo.prototype.newCandidatesFamily=function(e){var t=new Lo;return t.familyTypeName=e,this.selCandidatesFamilyMap[e]=t,t},wo.prototype.getSelectionCandidatesFamily=function(e){return this.selCandidatesFamilyMap[e]},wo.prototype.setCandidateCustom=function(e,t,r){var i=this.getSelectionCandidatesFamily(t);i&&i.setCandidate(e,r)},wo.prototype.setCandidateGeneral=function(e,t){this.selCandidatesMap[e]=t},wo.prototype.getCandidateGeneral=function(e){return this.selCandidatesMap[e]},wo.prototype.getSelectedGeneral=function(){return this.currentGeneralObjectSelected},wo.prototype.getSelectedGeneralArray=function(){return this.currentGeneralObjectSelectedArray},wo.prototype.setSelectedGeneral=function(e){this.currentGeneralObjectSelected=e},wo.prototype.getSelectedF4dBuilding=function(){if(this.currentNodeSelected)return this.currentNodeSelected.data.neoBuilding},wo.prototype.getSelectedF4dBuildingArray=function(){for(var e=[],t=this.getSelectedF4dNodeArray(),r=0,i=t.length;r<i;r++){var o=t[r];e.push(o.data.neoBuilding)}return e},wo.prototype.setSelectedF4dBuilding=function(e){this.currentBuildingSelected=e},wo.prototype.getSelectedF4dObject=function(){return this.currentReferenceSelected},wo.prototype.getSelectedF4dObjectArray=function(){return this.currentReferenceSelectedArray},wo.prototype.setSelectedF4dObject=function(e){this.currentReferenceSelected=e},wo.prototype.getSelectedF4dNode=function(){return this.currentNodeSelected},wo.prototype.existSelectedObjects=function(){var e=this.getSelectedGeneralArray(),t=this.getSelectedF4dNodeArray(),r=this.getSelectedF4dObjectArray();return e.length>0||t.length>0||r.length>0},wo.prototype.getSelectedF4dNodeArray=function(){return this.currentNodeSelectedArray},wo.prototype.setSelectedF4dNode=function(e){this.currentNodeSelected=e},wo.prototype.setCandidates=function(e,t,r,i,o){t&&(this.referencesMap[e]=t),r&&(this.octreesMap[e]=r),i&&(this.buildingsMap[e]=i),o&&(this.nodesMap[e]=o)},wo.prototype.clearCandidates=function(){for(var e in this.referencesMap={},this.octreesMap={},this.buildingsMap={},this.nodesMap={},this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,e))this.selCandidatesFamilyMap[e].clearCandidate()}this.selCandidatesMap={}},wo.prototype.selectObjects=function(e){for(var t in this.currentReferenceSelected=this.referencesMap[e],this.currentOctreeSelected=this.octreesMap[e],this.currentBuildingSelected=this.buildingsMap[e],this.currentNodeSelected=this.nodesMap[e],this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,t))this.selCandidatesFamilyMap[t].selectObject(e)}this.currentGeneralObjectSelected=this.selCandidatesMap[e]},wo.prototype.isObjectSelected=function(e){return void 0!==e&&(this.currentReferenceSelected===e||(this.currentBuildingSelected===e||(this.currentNodeSelected===e||(this.currentGeneralObjectSelected===e||(this.currentGeneralObjectSelectedArray.indexOf(e)>-1||this.currentNodeSelectedArray.indexOf(e)>-1)))))},wo.prototype.clearCurrents=function(){for(var e in this.currentReferenceSelected=void 0,this.currentOctreeSelected=void 0,this.currentBuildingSelected=void 0,this.currentNodeSelected=void 0,this.selCandidatesFamilyMap){if(Object.prototype.hasOwnProperty.call(this.selCandidatesFamilyMap,e))this.selCandidatesFamilyMap[e].clearCurrentSelected()}this.currentGeneralObjectSelected=void 0,this.currentReferenceSelectedArray=[],this.currentOctreeSelectedArray=[],this.currentBuildingSelectedArray=[],this.currentNodeSelectedArray=[],this.currentGeneralObjectSelectedArray=[],this.magoManager.isCameraMoved=!0},wo.prototype.clearProvisionals=function(){this.provisionalF4dArray=[],this.provisionalF4dObjectArray=[],this.provisionalNativeArray=[]},wo.prototype.TEST__CurrGeneralObjSel=function(){return!!this.currentGeneralObjectSelected},wo.prototype.selectObjectByPixel=function(e,t,r,i){void 0===i&&(i=!1),this.magoManager.selectionFbo.bind(),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.depthRange(0,1),e.disable(e.CULL_FACE);var o=new Uint8Array(4),n=t-Math.floor(.5),a=this.magoManager.sceneState.drawingBufferHeight-r-Math.floor(.5);n<0&&(n=0),a<0&&(a=0),e.readPixels(n,a,1,1,e.RGBA,e.UNSIGNED_BYTE,o),e.bindFramebuffer(e.FRAMEBUFFER,null);var s=Math.floor(.5),l=this.magoManager.selectionColor.decodeColor3(o[3*s],o[3*s+1],o[3*s+2]);this.currentReferenceSelected=this.referencesMap[l],this.currentOctreeSelected=this.octreesMap[l],this.currentBuildingSelected=this.buildingsMap[l],this.currentNodeSelected=this.nodesMap[l];var u=this.currentReferenceSelected,c=this.getSelectionCandidatesFamily("networkEdges");if(c)for(var d=c.currentSelected,h=0;void 0===d&&h<1;){l=this.magoManager.selectionColor.decodeColor3(o[3*h],o[3*h+1],o[3*h+2]);d=c.selectObject(l),h++}var f=this.getSelectionCandidatesFamily("general");if(f){var g=f.currentSelected;for(h=0;void 0===g&&h<1;){l=this.selectionColor.decodeColor3(o[3*h],o[3*h+1],o[3*h+2]);g=f.selectObject(l),h++}}void 0===u&&(u=this.selCandidatesMap[l]),this.setSelectedGeneral(this.selCandidatesMap[l]),this.magoManager.selectionFbo.unbind(),e.enable(e.CULL_FACE)},wo.prototype.selectProvisionalObjectByPixel=function(e,t,r){this.clearProvisionals();e=this.magoManager.getGl();this.magoManager.selectionFbo.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.magoManager.selColorTex,0);var i=new Uint8Array(4),o=t-Math.floor(.5),n=this.magoManager.sceneState.drawingBufferHeight-r-Math.floor(.5);o<0&&(o=0),n<0&&(n=0),e.readPixels(o,n,1,1,e.RGBA,e.UNSIGNED_BYTE,i),e.bindFramebuffer(e.FRAMEBUFFER,null);var a=Math.floor(.5),s=this.magoManager.selectionColor.decodeColor3(i[3*a],i[3*a+1],i[3*a+2]);this.nodesMap[s]&&this.provisionalF4dArray.push(this.nodesMap[s]),this.referencesMap[s]&&this.nodesMap[s]&&this.provisionalF4dObjectArray.push(this.referencesMap[s]),this.selCandidatesMap[s]&&this.provisionalNativeArray.push(this.selCandidatesMap[s]),this.magoManager.selectionFbo.unbind(),e.enable(e.CULL_FACE)},wo.prototype.filterProvisional=function(e,t){var r={};switch(e){case te.F4D:r[e]=this.provisionalF4dArray;break;case te.OBJECT:r[te.F4D]=this.provisionalF4dArray,r[e]=this.provisionalF4dObjectArray;break;case te.NATIVE:r[e]=this.provisionalNativeArray;break;case te.ALL:r[te.F4D]=this.provisionalF4dArray,r[te.NATIVE]=this.provisionalNativeArray}var i=0;for(var o in r)r.hasOwnProperty(o)&&(i+=r[o].length);if(0!==i){t=t||un;var n={};for(var o in r)if(r.hasOwnProperty(o))for(var a=r[o],s=0,l=a.length;s<l;s++){var u=t;e===te.OBJECT&&o===te.F4D&&(u=un),u.call(this,a[s])&&(n[o]||(n[o]=[]),n[o].push(a[s]))}return n}},wo.prototype.provisionalToCurrent=function(e,t,r){var i=this.filterProvisional(e,t);if(r||this.clearCurrents(),!tn(i)){for(var o in i)if(i.hasOwnProperty(o)){var n=a(o);this[n.currentMember]=i[o],this[n.auxMember]=i[o][0]}this.clearProvisionals()}function a(e){switch(e){case te.F4D:return{currentMember:"currentNodeSelectedArray",auxMember:"currentNodeSelected"};case te.OBJECT:return{currentMember:"currentReferenceSelectedArray",auxMember:"currentReferenceSelected"};case te.NATIVE:return{currentMember:"currentGeneralObjectSelectedArray",auxMember:"currentGeneralObjectSelected"}}}},wo.prototype.provisionalAddToCurrent=function(e,t){var r=this.filterProvisional(e,t);if(!tn(r)){for(var i in r)if(r.hasOwnProperty(i))for(var o=c(i),n=r[i],a=0,s=n.length;a<s;a++){var l=n[a],u=this[o.currentMember].indexOf(l);u>-1?this[o.currentMember].splice(u,1):this[o.currentMember].push(l)}this.clearProvisionals()}function c(e){switch(e){case te.F4D:return{currentMember:"currentNodeSelectedArray",auxMember:"currentNodeSelected"};case te.OBJECT:return{currentMember:"currentReferenceSelectedArray",auxMember:"currentReferenceSelected"};case te.NATIVE:return{currentMember:"currentGeneralObjectSelectedArray",auxMember:"currentGeneralObjectSelected"}}}},wo.prototype.selectionByPolygon2D=function(e,t){this.clearCurrents();var r,i=this.magoManager.frustumVolumeControl;if(t===te.ALL){var o=i.selectionByPolygon2D(e,te.F4D);this.currentNodeSelectedArray=o,this.currentNodeSelected=o[0];var n=i.selectionByPolygon2D(e,te.NATIVE);this.currentGeneralObjectSelectedArray=n,this.currentGeneralObjectSelected=n[0],r=[].concat(o,n)}else r=i.selectionByPolygon2D(e,t),t===te.F4D?(this.currentNodeSelectedArray=r,this.currentNodeSelected=r[0]):t===te.NATIVE&&(this.currentGeneralObjectSelectedArray=r,this.currentGeneralObjectSelected=r[0]);return r},wo.prototype.removeNative=function(e){var t=this.getSelectedGeneralArray();this.currentGeneralObjectSelectedArray=t.filter(function(t){return t!==e}),this.currentGeneralObjectSelected=this.currentGeneralObjectSelectedArray[0]},wo.prototype.removeF4d=function(e){var t=this.getSelectedF4dNodeArray();this.currentNodeSelectedArray=t.filter(function(t){return t!==e}),this.currentNodeSelected=this.currentNodeSelectedArray[0]},wo.prototype.selectF4d=function(e){e&&(this.getSelectedF4dNodeArray().filter(function(t){return t===e})[0]||(this.currentNodeSelectedArray.push(e),this.magoManager.emit(Fe.EVENT_TYPE.SELECTEDF4D,{type:Fe.EVENT_TYPE.SELECTEDF4D,selected:e,f4d:e,timestamp:new Date})),this.currentNodeSelected||(this.currentNodeSelected=e))};var So=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl=t,this.mapRestoringFunctions={},this.mapParameterNames={}};So.prototype.colorMask=function(e,t,r,i){var o=this.mapParameterNames;void 0===o.keep_GL_COLOR_WRITEMASK&&this._keepCurrent_GL_COLOR_WRITEMASK(),e===o.curr_GL_COLOR_WRITEMASK[0]&&t===o.curr_GL_COLOR_WRITEMASK[1]&&r===o.curr_GL_COLOR_WRITEMASK[2]&&i===o.curr_GL_COLOR_WRITEMASK[3]||(this.gl.colorMask(e,t,r,i),o.curr_GL_COLOR_WRITEMASK=[e,t,r,i])},So.prototype._keepCurrent_GL_COLOR_WRITEMASK=function(){var e=this.mapParameterNames;e.keep_GL_COLOR_WRITEMASK=this.gl.getParameter(this.gl.COLOR_WRITEMASK),e.curr_GL_COLOR_WRITEMASK=[e.keep_GL_COLOR_WRITEMASK[0],e.keep_GL_COLOR_WRITEMASK[1],e.keep_GL_COLOR_WRITEMASK[2],e.keep_GL_COLOR_WRITEMASK[3]],this.mapRestoringFunctions.GL_COLOR_WRITEMASK=function(e){var t=e.mapParameterNames;t.curr_GL_COLOR_WRITEMASK[0]===t.keep_GL_COLOR_WRITEMASK[0]&&t.curr_GL_COLOR_WRITEMASK[1]===t.keep_GL_COLOR_WRITEMASK[1]&&t.curr_GL_COLOR_WRITEMASK[2]===t.keep_GL_COLOR_WRITEMASK[2]&&t.curr_GL_COLOR_WRITEMASK[3]===t.keep_GL_COLOR_WRITEMASK[3]||e.gl.colorMask(t.keep_GL_COLOR_WRITEMASK[0],t.keep_GL_COLOR_WRITEMASK[1],t.keep_GL_COLOR_WRITEMASK[2],t.keep_GL_COLOR_WRITEMASK[3])}},So.prototype.depthMask=function(e){var t=this.mapParameterNames;void 0===t.keep_GL_DEPTH_WRITEMASK&&this._keepCurrent_GL_DEPTH_WRITEMASK(),e!==t.curr_GL_DEPTH_WRITEMASK&&(this.gl.depthMask(e),t.curr_GL_DEPTH_WRITEMASK=e)},So.prototype._keepCurrent_GL_DEPTH_WRITEMASK=function(){var e=this.mapParameterNames;e.keep_GL_DEPTH_WRITEMASK=this.gl.getParameter(this.gl.DEPTH_WRITEMASK),e.curr_GL_DEPTH_WRITEMASK=e.keep_GL_DEPTH_WRITEMASK,this.mapRestoringFunctions.GL_DEPTH_WRITEMASK=function(e){var t=e.mapParameterNames;t.curr_GL_DEPTH_WRITEMASK!==t.keep_GL_DEPTH_WRITEMASK&&e.gl.depthMask(t.keep_GL_DEPTH_WRITEMASK)}},So.prototype.frontFace=function(e){var t=this.mapParameterNames;void 0===t.keep_GL_FRONT_FACE&&this._keepCurrent_GL_FRONT_FACE(),e!==t.curr_GL_FRONT_FACE&&(this.gl.frontFace(e),t.curr_GL_FRONT_FACE=e)},So.prototype._keepCurrent_GL_FRONT_FACE=function(){var e=this.mapParameterNames;e.keep_GL_FRONT_FACE=this.gl.getParameter(this.gl.FRONT_FACE),e.curr_GL_FRONT_FACE=e.keep_GL_FRONT_FACE,this.mapRestoringFunctions.GL_FRONT_FACE=function(e){var t=e.mapParameterNames;t.curr_GL_FRONT_FACE!==t.keep_GL_FRONT_FACE&&e.gl.frontFace(t.keep_GL_FRONT_FACE)}},So.prototype.viewport=function(e,t,r,i){var o=this.mapParameterNames;void 0===o.keep_GL_VIEWPORT&&this._keepCurrent_GL_VIEWPORT(),e===o.curr_GL_VIEWPORT[0]&&t===o.curr_GL_VIEWPORT[1]&&r===o.curr_GL_VIEWPORT[2]&&i===o.curr_GL_VIEWPORT[3]||(this.gl.viewport(e,t,r,i),o.curr_GL_VIEWPORT[0]=e,o.curr_GL_VIEWPORT[1]=t,o.curr_GL_VIEWPORT[2]=r,o.curr_GL_VIEWPORT[3]=i)},So.prototype._keepCurrent_GL_VIEWPORT=function(){var e=this.mapParameterNames;e.keep_GL_VIEWPORT=this.gl.getParameter(this.gl.VIEWPORT),e.curr_GL_VIEWPORT=new Int32Array(4),e.curr_GL_VIEWPORT[0]=e.keep_GL_VIEWPORT[0],e.curr_GL_VIEWPORT[1]=e.keep_GL_VIEWPORT[1],e.curr_GL_VIEWPORT[2]=e.keep_GL_VIEWPORT[2],e.curr_GL_VIEWPORT[3]=e.keep_GL_VIEWPORT[3],this.mapRestoringFunctions.GL_VIEWPORT=function(e){var t=e.mapParameterNames;t.curr_GL_VIEWPORT[0]===t.keep_GL_VIEWPORT[0]&&t.curr_GL_VIEWPORT[1]===t.keep_GL_VIEWPORT[1]&&t.curr_GL_VIEWPORT[2]===t.keep_GL_VIEWPORT[2]&&t.curr_GL_VIEWPORT[3]===t.keep_GL_VIEWPORT[3]||e.gl.viewport(t.keep_GL_VIEWPORT[0],t.keep_GL_VIEWPORT[1],t.keep_GL_VIEWPORT[2],t.keep_GL_VIEWPORT[3])}},So.prototype.clearDepth=function(e){var t=this.mapParameterNames;void 0===t.keep_GL_DEPTH_CLEAR_VALUE&&this._keepCurrent_GL_DEPTH_CLEAR_VALUE(),e!==t.curr_GL_DEPTH_CLEAR_VALUE&&(this.gl.clearDepth(e),t.curr_GL_DEPTH_CLEAR_VALUE=e)},So.prototype._keepCurrent_GL_DEPTH_CLEAR_VALUE=function(){var e=this.mapParameterNames;e.keep_GL_DEPTH_CLEAR_VALUE=this.gl.getParameter(this.gl.DEPTH_CLEAR_VALUE),e.curr_GL_DEPTH_CLEAR_VALUE=e.keep_GL_DEPTH_CLEAR_VALUE,this.mapRestoringFunctions.GL_DEPTH_CLEAR_VALUE=function(e){var t=e.mapParameterNames;t.curr_GL_DEPTH_CLEAR_VALUE!==t.keep_GL_DEPTH_CLEAR_VALUE&&e.gl.clearDepth(t.keep_GL_DEPTH_CLEAR_VALUE)}},So.prototype.clearColor=function(e,t,r,i){var o=this.mapParameterNames;void 0===o.keep_GL_COLOR_CLEAR_VALUE&&this._keepCurrent_GL_COLOR_CLEAR_VALUE(),e===o.curr_GL_COLOR_CLEAR_VALUE[0]&&t===o.curr_GL_COLOR_CLEAR_VALUE[1]&&r===o.curr_GL_COLOR_CLEAR_VALUE[2]&&i===o.curr_GL_COLOR_CLEAR_VALUE[3]||(this.gl.clearColor(e,t,r,i),o.curr_GL_COLOR_CLEAR_VALUE[0]=e,o.curr_GL_COLOR_CLEAR_VALUE[1]=t,o.curr_GL_COLOR_CLEAR_VALUE[2]=r,o.curr_GL_COLOR_CLEAR_VALUE[3]=i)},So.prototype._keepCurrent_GL_COLOR_CLEAR_VALUE=function(){var e=this.mapParameterNames;e.keep_GL_COLOR_CLEAR_VALUE=this.gl.getParameter(this.gl.COLOR_CLEAR_VALUE),e.curr_GL_COLOR_CLEAR_VALUE=new Float32Array(4),e.curr_GL_COLOR_CLEAR_VALUE[0]=e.keep_GL_COLOR_CLEAR_VALUE[0],e.curr_GL_COLOR_CLEAR_VALUE[1]=e.keep_GL_COLOR_CLEAR_VALUE[1],e.curr_GL_COLOR_CLEAR_VALUE[2]=e.keep_GL_COLOR_CLEAR_VALUE[2],e.curr_GL_COLOR_CLEAR_VALUE[3]=e.keep_GL_COLOR_CLEAR_VALUE[3],this.mapRestoringFunctions.GL_COLOR_CLEAR_VALUE=function(e){var t=e.mapParameterNames;t.curr_GL_COLOR_CLEAR_VALUE[0]===t.keep_GL_COLOR_CLEAR_VALUE[0]&&t.curr_GL_COLOR_CLEAR_VALUE[1]===t.keep_GL_COLOR_CLEAR_VALUE[1]&&t.curr_GL_COLOR_CLEAR_VALUE[2]===t.keep_GL_COLOR_CLEAR_VALUE[2]&&t.curr_GL_COLOR_CLEAR_VALUE[3]===t.keep_GL_COLOR_CLEAR_VALUE[3]||e.gl.clearColor(t.keep_GL_COLOR_CLEAR_VALUE[0],t.keep_GL_COLOR_CLEAR_VALUE[1],t.keep_GL_COLOR_CLEAR_VALUE[2],t.keep_GL_COLOR_CLEAR_VALUE[3])}},So.prototype.blendFunc=function(e,t){var r=this.mapParameterNames;void 0===r.keep_GL_BLEND_SRC_FUNC&&this._keepCurrent_GL_BLEND_FUNC(),r.curr_GL_BLEND_SRC_FUNC===e&&r.curr_GL_BLEND_DST_FUNC===t||(this.gl.blendFunc(e,t),r.curr_GL_BLEND_SRC_FUNC=e,r.curr_GL_BLEND_DST_FUNC=t)},So.prototype._keepCurrent_GL_BLEND_FUNC=function(){var e=this.mapParameterNames;e.keep_GL_BLEND_SRC_FUNC=this.gl.getParameter(this.gl.BLEND_SRC_ALPHA),e.curr_GL_BLEND_SRC_FUNC=e.keep_GL_BLEND_SRC_FUNC,e.keep_GL_BLEND_DST_FUNC=this.gl.getParameter(this.gl.BLEND_DST_ALPHA),e.curr_GL_BLEND_DST_FUNC=e.keep_GL_BLEND_DST_FUNC,this.mapRestoringFunctions.GL_BLEND_FUNC=function(e){var t=e.mapParameterNames;t.curr_GL_BLEND_SRC_FUNC===t.keep_GL_BLEND_SRC_FUNC&&t.curr_GL_BLEND_DST_FUNC===t.keep_GL_BLEND_DST_FUNC||e.gl.blendFunc(t.keep_GL_BLEND_SRC_FUNC,t.keep_GL_BLEND_DST_FUNC)}},So.prototype.depthRange=function(e,t){var r=this.mapParameterNames;void 0===r.keep_GL_DEPTH_RANGE&&this._keepCurrent_GL_DEPTH_RANGE(),r.curr_GL_DEPTH_RANGE[0]===e&&r.curr_GL_DEPTH_RANGE[1]===t||(this.gl.depthRange(e,t),r.curr_GL_DEPTH_RANGE[0]=e,r.curr_GL_DEPTH_RANGE[1]=t)},So.prototype._keepCurrent_GL_DEPTH_RANGE=function(){var e=this.mapParameterNames;e.keep_GL_DEPTH_RANGE=this.gl.getParameter(this.gl.DEPTH_RANGE),e.curr_GL_DEPTH_RANGE=new Float32Array([e.keep_GL_DEPTH_RANGE[0],e.keep_GL_DEPTH_RANGE[1]]),this.mapRestoringFunctions.GL_DEPTH_RANGE=function(e){var t=e.mapParameterNames;t.curr_GL_DEPTH_RANGE[0]===t.keep_GL_DEPTH_RANGE[0]&&t.curr_GL_DEPTH_RANGE[1]===t.keep_GL_DEPTH_RANGE[1]||e.gl.depthRange(t.keep_GL_DEPTH_RANGE[0],t.keep_GL_DEPTH_RANGE[1])}},So.prototype.enable_GL_BLEND=function(){var e=this.mapParameterNames;void 0===e.keep_GL_BLEND&&this._keepCurrent_GL_BLEND(),e.curr_GL_BLEND||(this.gl.enable(this.gl.BLEND),e.curr_GL_BLEND=!0)},So.prototype.disable_GL_BLEND=function(){var e=this.mapParameterNames;void 0===e.keep_GL_BLEND&&this._keepCurrent_GL_BLEND(),e.curr_GL_BLEND&&(this.gl.disable(this.gl.BLEND),e.curr_GL_BLEND=!1)},So.prototype._keepCurrent_GL_BLEND=function(){var e=this.mapParameterNames;e.keep_GL_BLEND=this.gl.getParameter(this.gl.BLEND),e.curr_GL_BLEND=e.keep_GL_BLEND,this.mapRestoringFunctions.GL_BLEND=function(e){var t=e.mapParameterNames;t.curr_GL_BLEND!==t.keep_GL_BLEND&&(t.keep_GL_BLEND?e.gl.enable(e.gl.BLEND):e.gl.disable(e.gl.BLEND))}},So.prototype.enable_GL_DEPTH_TEST=function(){var e=this.mapParameterNames;void 0===e.keep_GL_DEPTH_TEST&&this._keepCurrent_GL_DEPTH_TEST(),e.curr_GL_DEPTH_TEST||(this.gl.enable(this.gl.DEPTH_TEST),e.curr_GL_DEPTH_TEST=!0)},So.prototype.disable_GL_DEPTH_TEST=function(){var e=this.mapParameterNames;void 0===e.keep_GL_DEPTH_TEST&&this._keepCurrent_GL_DEPTH_TEST(),e.curr_GL_DEPTH_TEST&&(this.gl.disable(this.gl.DEPTH_TEST),e.curr_GL_DEPTH_TEST=!1)},So.prototype._keepCurrent_GL_DEPTH_TEST=function(){var e=this.mapParameterNames;e.keep_GL_DEPTH_TEST=this.gl.getParameter(this.gl.DEPTH_TEST),e.curr_GL_DEPTH_TEST=e.keep_GL_DEPTH_TEST,this.mapRestoringFunctions.GL_DEPTH_TEST=function(e){var t=e.mapParameterNames;t.curr_GL_DEPTH_TEST!==t.keep_GL_DEPTH_TEST&&(t.keep_GL_DEPTH_TEST?e.gl.enable(e.gl.DEPTH_TEST):e.gl.disable(e.gl.DEPTH_TEST))}},So.prototype.enable_GL_CULL_FACE=function(){var e=this.mapParameterNames;void 0===e.keep_Gl_CULL_FACE&&this._keepCurrent_GL_CULL_FACE(),e.curr_Gl_CULL_FACE||(this.gl.enable(this.gl.CULL_FACE),e.curr_Gl_CULL_FACE=!0)},So.prototype.disable_GL_CULL_FACE=function(){var e=this.mapParameterNames;void 0===e.keep_Gl_CULL_FACE&&this._keepCurrent_GL_CULL_FACE(),e.curr_Gl_CULL_FACE&&(this.gl.disable(this.gl.CULL_FACE),e.curr_Gl_CULL_FACE=!1)},So.prototype._keepCurrent_GL_CULL_FACE=function(){var e=this.mapParameterNames;e.keep_Gl_CULL_FACE=this.gl.getParameter(this.gl.CULL_FACE),e.curr_Gl_CULL_FACE=e.keep_Gl_CULL_FACE,this.mapRestoringFunctions.GL_CULL_FACE=function(e){var t=e.mapParameterNames;t.curr_Gl_CULL_FACE!==t.keep_Gl_CULL_FACE&&(t.keep_Gl_CULL_FACE?e.gl.enable(e.gl.CULL_FACE):e.gl.disable(e.gl.CULL_FACE))}},So.prototype.restoreAllParameters=function(){if(void 0!==this.mapRestoringFunctions)for(var e in this.mapRestoringFunctions)this.mapRestoringFunctions.hasOwnProperty(e)&&this.mapRestoringFunctions[e](this)};var Do=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.texture3DXSize=1024,this.texture3DYSize=1024,this.texture3DZSize=128,this.mosaicXCount=1,this.mosaicYCount=1,this.finalTextureXSize,this.finalTextureZSize,this.finalSlicesCount=1,this.minMaxAltitudes=[0,0],this.texturesArray=[],this._fileLoadState=I.fileLoadState.READY,void 0!==t&&(void 0!==t.texture3DXSize&&(this.texture3DXSize=t.texture3DXSize),void 0!==t.texture3DYSize&&(this.texture3DYSize=t.texture3DYSize),void 0!==t.texture3DZSize&&(this.texture3DZSize=t.texture3DZSize),void 0!==t.mosaicXCount&&(this.mosaicXCount=t.mosaicXCount),void 0!==t.mosaicYCount&&(this.mosaicYCount=t.mosaicYCount))};Do.prototype.deleteTextures=function(e){var t=0;this.texturesArray&&(t=this.texturesArray.length);for(var r=0;r<t;r++)e.deleteTexture(this.texturesArray[r]);this.texturesArray.length=0},Do.prototype.createTextures=function(e){this.deleteTextures(e);var t=e.NEAREST,r=e.CLAMP_TO_EDGE;this.finalTextureXSize=this.mosaicXCount*this.texture3DXSize,this.finalTextureYSize=this.mosaicYCount*this.texture3DYSize,this.finalSlicesCount=Math.ceil(this.texture3DZSize/(this.mosaicXCount*this.mosaicYCount));for(var i=0;i<this.finalSlicesCount;i++){var o=it.createTexture(e,t,void 0,this.finalTextureXSize,this.finalTextureYSize,r);this.texturesArray.push(o)}},Do.prototype.createTexture=function(e,t,r){e.deleteTexture(this.texturesArray[t]);var i=e.NEAREST,o=e.CLAMP_TO_EDGE,n=r;this.finalTextureXSize=this.mosaicXCount*this.texture3DXSize,this.finalTextureYSize=this.mosaicYCount*this.texture3DYSize;var a=it.createTexture(e,i,n,this.finalTextureXSize,this.finalTextureYSize,o);this.texturesArray[t]=a},Do.prototype.getTexturesCount=function(){return this.texturesArray?this.texturesArray.length:0},Do.prototype.getTexture=function(e){return!this.texturesArray||this.texturesArray.length-1<e?null:e<0?null:this.texturesArray[e]},Do.prototype.copyParametersFrom=function(e){this.texture3DXSize=e.texture3DXSize,this.texture3DYSize=e.texture3DYSize,this.texture3DZSize=e.texture3DZSize,this.mosaicXCount=e.mosaicXCount,this.mosaicYCount=e.mosaicYCount};var Ro=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.soundManager=t,this.geographicExtent,this._bIsPrepared=!1,this.terrainMinMaxHeights=new Float32Array([180,540]),this.simulationTextureSize=new Float32Array([t.maxSimulationSize,t.maxSimulationSize]),this.texturesNumSlices=1,this.terrainTextureSize=new Float32Array([t.maxSimulationSize,t.maxSimulationSize]),this.simulationTimeStep=.08,this.simulationTimeStep=5e-4,this.simulationTimeStep=8e-4,this.simulationTimeStep=2e-4,this.simulationTimeStep=4e-4,this.waveLength=1,this.waveAmplitude=1,this.wavePhase=0,this.timeStepAccum=0,this.visibleObjectsControler,this.demWithBuildingsTex,this.pressureMosaicTexture3d_A,this.pressureMosaicTexture3d_B,r&&r.geographicExtent&&(this.geographicExtent=r.geographicExtent),this.init()};Ro.prototype.isPrepared=function(){return!!this._bIsPrepared||(this.init(),!1)},Ro.prototype.prepareTextures=function(){if("HIGHMAP"===this.soundManager.terrainDemSourceType){if(!this.original_dem_texture){var e=this.soundManager.magoManager.getGl();return this.original_dem_texture=new it,this.original_dem_texture.texId=e.createTexture(),!1}if(this.original_dem_texture.fileLoadState===I.fileLoadState.READY){e=this.soundManager.magoManager.getGl();var t=this.soundManager.DEMHighMapUrl;return hr.loadImage(e,t,this.original_dem_texture),!1}if(this.original_dem_texture.fileLoadState!==I.fileLoadState.BINDING_FINISHED)return!1}else if("QUANTIZEDMESH"===this.soundManager.terrainDemSourceType){if(!this.tilesArray){var r=this.geographicExtent,i=r.maxGeographicCoord.longitude-r.minGeographicCoord.longitude,o=r.maxGeographicCoord.latitude-r.minGeographicCoord.latitude,n=-1;if(i<o){for(var a=1;a<30;a++)if(Ke.selectTileAngleRangeByDepth(a)<i){n=a;break}}else for(a=1;a<30;a++)if(Ke.selectTileAngleRangeByDepth(a)<o){n=a;break}var s=this.soundManager;s.simulationTileDepth=n;var l=s.simulationTileDepth;this._targetDepth=l+6;var u=Fe.getMaximumLevelOfTerrainProvider(this.soundManager.terrainProvider);this._targetDepth>u&&(this._targetDepth=u);var c=this._targetDepth,d=r.minGeographicCoord.longitude,h=r.minGeographicCoord.latitude,f=r.maxGeographicCoord.longitude,g=r.maxGeographicCoord.latitude;this.tilesArray=Ke.selectTileIndicesArray(c,d,h,f,g,void 0)}if(!this.allQuantizedMeshesLoaded){var p=!0,m=this.tilesArray.length;for(a=0;a<m;a++){var v=this.tilesArray[a];if(v.fileLoadState||(v.fileLoadState=I.fileLoadState.READY),v.fileLoadState===I.fileLoadState.READY){var x=v.X,_=v.Y,y=v.L;this._loadQuantizedMesh(y,x,_,v),p=!1}else v.fileLoadState!==I.fileLoadState.LOADING_FINISHED&&(p=!1)}p&&(this.allQuantizedMeshesLoaded=!0)}if(this.allQuantizedMeshesLoaded&&!this.makeDemTextureByQMeshses_processFinished)return this.makeDEMTextureByQuantizedMeshes(),!1}return!0},Ro.prototype._loadQuantizedMesh=function(e,t,r,i){i.fileLoadState=I.fileLoadState.LOADING_STARTED,i.qMeshPromise=this.soundManager.terrainProvider.requestTileGeometry(t,r,e),i.qMeshPromise.then(function(o){i.fileLoadState=I.fileLoadState.LOADING_FINISHED,i.qMesh=o,i.geoExtent=Ke.getGeographicExtentOfTileLXY(e,t,r,void 0,I.imageryType.CRS84)},function(o){i.fileLoadState=I.fileLoadState.LOADING_FINISHED,i.geoExtent=Ke.getGeographicExtentOfTileLXY(e,t,r,void 0,I.imageryType.CRS84)})},Ro.prototype.init=function(){var e=this.geographicExtent.getLongitudeArcDistance(),t=this.geographicExtent.getLatitudeArcDistance(),r=this.soundManager.maxSimulationSize;this.pixelSizeInMeters=0,e>t?(this.simulationTextureSize[0]=r,this.simulationTextureSize[1]=Math.floor(r*(t/e)),this.pixelSizeInMeters=e/r):(this.simulationTextureSize[0]=Math.floor(r*(e/t)),this.simulationTextureSize[1]=r,this.pixelSizeInMeters=t/r);var i=this.geographicExtent.getAltitudeRange();this.texturesNumSlices=Math.floor(i/this.pixelSizeInMeters),this.terrainTextureSize[0]=this.simulationTextureSize[0],this.terrainTextureSize[1]=this.simulationTextureSize[1];var o=e/this.simulationTextureSize[0],n=t/this.simulationTextureSize[1],a=i/this.texturesNumSlices;this.oneVoxelSizeInMeters=[o,n,a];var s=this.soundManager.magoManager,l=s.getGl();if(!this.fbo){var u=this.simulationTextureSize[0],c=this.simulationTextureSize[1],d=s.postFxShadersManager.bUseMultiRenderTarget;this.fbo=new ae(l,u,c,{matchCanvasSize:!1,multiRenderTarget:d,numColorBuffers:3})}if(!this.terrainTexFbo){u=this.terrainTextureSize[0],c=this.terrainTextureSize[1],d=s.postFxShadersManager.bUseMultiRenderTarget;this.terrainTexFbo=new ae(l,u,c,{matchCanvasSize:!1,multiRenderTarget:d,numColorBuffers:3})}this._makeTextures(),this._bIsPrepared=!0},Ro.prototype._makeTextures=function(){var e=this.soundManager,t=e.magoManager.getGl(),r=this.simulationTextureSize[0],i=this.simulationTextureSize[1];this.demWithBuildingsTex=e._newTexture(t,r,i)},Ro.prototype._getSimulationBox=function(e){if(!this.simulationBox){this.simulationBox=this.geographicExtent.getRenderableObject(e),this.simulationBox.setOneColor(.2,.7,.8,.05),this.simulationBox.attributes.isMovable=!1,this.simulationBox.attributes.isSelectable=!1,this.simulationBox.attributes.name="simulationBox",this.simulationBox.attributes.selectedColor4=new J(1,0,0,0),void 0===this.simulationBox.options&&(this.simulationBox.options={}),this.simulationBox.options.renderWireframe=!1,this.simulationBox.options.renderShaded=!0,this.simulationBox.options.depthMask=!1;this.simulationBox.getBoundingBoxLC()}return this.simulationBox},Ro.prototype._getVolumeDepthFBO=function(e){if(!this.volumeDepthFBO){var t=e.getGl(),r=e.sceneState,i=2*r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.volumeDepthFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeDepthFBO},Ro.prototype._getScreenFBO=function(e){if(!this.screenFBO){var t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.screenFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.screenFBO},Ro.prototype._renderDepthVolume=function(e){e.sceneState;var t=e.getGl(),r=e.extbuffers;this.visibleObjControler||(this.visibleObjControler=new _t),this.simulationBox=this._getSimulationBox(e),this.simulationBox&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.simulationBox);var i=this._getVolumeDepthFBO(e);i.bind(),t.viewport(0,0,i.width[0]/2,i.height[0]),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,i.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,0),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT),t.clearColor(0,0,0,1)),t.clear(t.DEPTH_BUFFER_BIT);var o=1;t.frontFace(t.CCW),e.renderer.renderGeometryBuffer(t,o,this.visibleObjControler),this.simulBoxdoubleDepthTex=i.colorBuffersArray[1],this.simulBoxDoubleNormalTex=i.colorBuffersArray[2],t.viewport(i.width[0]/2,0,i.width[0]/2,i.height[0]);o=1;t.frontFace(t.CW),e.renderer.renderGeometryBuffer(t,o,this.visibleObjControler),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,null,0),i.unbind(),t.frontFace(t.CCW)},Ro.prototype.renderWave=function(e){if(this.pressureMosaicTexture3d_A&&this.pressureMosaicTexture3d_A.texturesArray&&0!==this.pressureMosaicTexture3d_A.texturesArray.length){this._renderDepthVolume(e);var t=this.soundManager,r=e.sceneState,i=e.getGl(),o=this._getScreenFBO(e),n=o.extbuffers;o.bind(),i.viewport(0,0,o.width[0],o.height[0]);var a=t.getQuadBuffer(),s=e.postFxShadersManager.getShader("volumetricWaves");e.postFxShadersManager.useProgram(s),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,o.colorBuffersArray[0],0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,o.colorBuffersArray[1],0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,o.colorBuffersArray[2],0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,o.colorBuffersArray[3],0),this.volumRenderTex=o.colorBuffersArray[0],n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.COLOR_ATTACHMENT1_WEBGL,n.COLOR_ATTACHMENT2_WEBGL,n.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(i.clearColor(0,0,0,0),i.clearDepth(1),i.clear(i.COLOR_BUFFER_BIT),i.clearColor(0,0,0,1)),i.clear(i.DEPTH_BUFFER_BIT),ae.bindAttribute(i,a.posBuffer,s.a_pos_loc,2),i.disable(i.BLEND),i.enable(i.DEPTH_TEST);var l=this.fluxRFUMosaicTexture3d_HIGH_A;s.bindUniformGenerals(),i.uniform1iv(s.u_texSize_loc,[l.texture3DXSize,l.texture3DYSize,l.texture3DZSize]),i.uniform1iv(s.u_mosaicSize_loc,[l.mosaicXCount,l.mosaicYCount,l.finalSlicesCount]);var u=r.getModelViewRelToEyeMatrixInv();i.uniformMatrix4fv(s.modelViewMatrixRelToEyeInv_loc,!1,u._floatArrays),i.uniform1f(s.u_airMaxPressure_loc,t.airMaxPressure),i.uniform1f(s.u_airEnvirontmentPressure_loc,t.airEnvirontmentPressure),i.uniform1f(s.u_maxVelocity_loc,t.airMaxVelocity),i.uniform2fv(s.u_screenSize_loc,[r.drawingBufferWidth[0],r.drawingBufferHeight[0]]),i.uniform2fv(s.uNearFarArray_loc,e.frustumVolumeControl.nearFarArray),i.uniform3fv(s.u_voxelSizeMeters_loc,[this.oneVoxelSizeInMeters[0],this.oneVoxelSizeInMeters[1],this.oneVoxelSizeInMeters[2]]),this.simulationBox=this._getSimulationBox(e);var c=this.simulationBox.geoLocDataManager.getCurrentGeoLocationData(),d=c.getRotMatrixInv();i.uniformMatrix4fv(s.u_simulBoxTMat_loc,!1,c.rotMatrix._floatArrays),i.uniformMatrix4fv(s.u_simulBoxTMatInv_loc,!1,d._floatArrays),i.uniform3fv(s.u_simulBoxPosHigh_loc,c.positionHIGH),i.uniform3fv(s.u_simulBoxPosLow_loc,c.positionLOW);var h=this.simulationBox.getBoundingBoxLC();i.uniform3fv(s.u_simulBoxMinPosLC_loc,[h.minX,h.minY,h.minZ]),i.uniform3fv(s.u_simulBoxMaxPosLC_loc,[h.maxX,h.maxY,h.maxZ]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.simulBoxdoubleDepthTex),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.simulBoxDoubleNormalTex),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(0)),i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,e.depthTex),i.activeTexture(i.TEXTURE4),i.bindTexture(i.TEXTURE_2D,e.normalTex),i.activeTexture(i.TEXTURE5),i.bindTexture(i.TEXTURE_2D,this.airVelocity_B.getTexture(0)),i.activeTexture(i.TEXTURE6),i.bindTexture(i.TEXTURE_2D,this.maxPressureMosaicTexture3d_A.getTexture(0)),i.drawArrays(i.TRIANGLES,0,6),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0);for(var f=0;f<8;f++)i.activeTexture(i.TEXTURE0+f),i.bindTexture(i.TEXTURE_2D,null);o.unbind(),i.enable(i.BLEND),this.drawSimulationVariables()}},Ro.prototype.newPointSource=function(e,t,r){var i=new pe(e,t,r);i.makeDefaultGeoLocationData(),this.soundManager.magoManager.modeler.getGeographicCoordsList().addGeoCoord(i);var o=this.getTileOrthographic_mvpMat();this.voxelizer.renderToMagoTexture3D(this.soundManager,this.soundSourceRealTexture3d,this.geographicExtent,o,[i])},Ro.prototype.newBSplineCubic3DSource=function(e){var t=new Tr({geoCoordsArray:e,initialArmsLengthRatio:.3,bLoop:!1}),r=this.getTileOrthographic_mvpMat();this.voxelizer.renderToMagoTexture3D(this.soundManager,this.soundSourceRealTexture3d,this.geographicExtent,r,[t])},Ro.prototype.TEST_yangDongHumenSiA_apt=function(){this.newPointSource(126.89556,35.15776,5),this.newPointSource(126.89535,35.15715,5);var e=new ve;e.newGeoCoord(126.89454,35.15673,3),e.newGeoCoord(126.89513,35.15698,3),e.newGeoCoord(126.89503,35.15736,3),e.newGeoCoord(126.89564,35.15784,3),this.newBSplineCubic3DSource(e.geographicCoordsArray)},Ro.prototype.TEST_MoATown_apt=function(){var e=new ve;e.newGeoCoord(126.90506,35.16952,3),e.newGeoCoord(126.90718,35.16899,3),this.newBSplineCubic3DSource(e.geographicCoordsArray)},Ro.prototype.TEST_NongSeon_SK_viewCentral_apt=function(){var e=new ve;e.newGeoCoord(126.88568,35.1552,3),e.newGeoCoord(126.8862,35.15494,3),e.newGeoCoord(126.88648,35.15528,3),e.newGeoCoord(126.88724,35.15534,3),e.newGeoCoord(126.8878,35.15602,3),this.newBSplineCubic3DSource(e.geographicCoordsArray)},Ro.prototype.doSimulationSteps=function(e){if(!this.prepareTextures())return!1;if(!this.overWriteDEMWithObjectsFinished)return!1;var t=(e=this.soundManager.magoManager).getGl();t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS);if(!this.voxelizer){var r={};r.voxelXSize=this.simulationTextureSize[0],r.voxelYSize=this.simulationTextureSize[1],r.voxelZSize=this.texturesNumSlices,this.voxelizer=new Pi(r)}if(!this.simulationMosaicFBO){var i=Pi.getMosaicColumnsAndRows(this.simulationTextureSize[0],this.simulationTextureSize[1],this.texturesNumSlices),o=i.numColumns,n=i.numRows,a=o*this.simulationTextureSize[0],s=n*this.simulationTextureSize[1],l=e.postFxShadersManager.bUseMultiRenderTarget;this.simulationMosaicFBO=new ae(t,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:8})}if(this.bSceneVoxelized||(this.fluxRFUMosaicTexture3d_HIGH_B=this.voxelizer.voxelizeByDepthTexture(e,this.demWithBuildingsTex,this.simulationTextureSize[0],this.simulationTextureSize[1],this.texturesNumSlices,this,void 0),this.bSceneVoxelized=!0),!this.fluxRFUMosaicTexture3d_HIGH_A){var u=this.fluxRFUMosaicTexture3d_HIGH_B;this.fluxRFUMosaicTexture3d_HIGH_A=new Do,this.fluxRFUMosaicTexture3d_HIGH_A.copyParametersFrom(u),this.fluxRFUMosaicTexture3d_HIGH_A.createTextures(t),this.fluxLBDMosaicTexture3d_HIGH_A=new Do,this.fluxLBDMosaicTexture3d_HIGH_A.copyParametersFrom(u),this.fluxLBDMosaicTexture3d_HIGH_A.createTextures(t),this.fluxLBDMosaicTexture3d_HIGH_B=new Do,this.fluxLBDMosaicTexture3d_HIGH_B.copyParametersFrom(u),this.fluxLBDMosaicTexture3d_HIGH_B.createTextures(t),this.fluxRFUMosaicTexture3d_LOW_A=new Do,this.fluxRFUMosaicTexture3d_LOW_A.copyParametersFrom(u),this.fluxRFUMosaicTexture3d_LOW_A.createTextures(t),this.fluxRFUMosaicTexture3d_LOW_B=new Do,this.fluxRFUMosaicTexture3d_LOW_B.copyParametersFrom(u),this.fluxRFUMosaicTexture3d_LOW_B.createTextures(t),this.fluxLBDMosaicTexture3d_LOW_A=new Do,this.fluxLBDMosaicTexture3d_LOW_A.copyParametersFrom(u),this.fluxLBDMosaicTexture3d_LOW_A.createTextures(t),this.fluxLBDMosaicTexture3d_LOW_B=new Do,this.fluxLBDMosaicTexture3d_LOW_B.copyParametersFrom(u),this.fluxLBDMosaicTexture3d_LOW_B.createTextures(t),this.shaderLogTexture=new Do,this.shaderLogTexture.copyParametersFrom(u),this.shaderLogTexture.createTextures(t),this.shaderLogTexture_vel=new Do,this.shaderLogTexture_vel.copyParametersFrom(u),this.shaderLogTexture_vel.createTextures(t),this._voxelizeInYDirection(e),this._voxelizeInXDirection(e),this._voxelizeInZDirection(e)}if(this.soundSourceRealTexture3d||(this.soundSourceRealTexture3d=new Do,this.soundSourceRealTexture3d.texture3DXSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DXSize,this.soundSourceRealTexture3d.texture3DYSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DYSize,this.soundSourceRealTexture3d.texture3DZSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DZSize,this.soundSourceRealTexture3d.mosaicXCount=1,this.soundSourceRealTexture3d.mosaicYCount=1,this.soundSourceRealTexture3d.createTextures(t),this.TEST_NongSeon_SK_viewCentral_apt()),!this.soundSourceRealTexture3d)return!1;if(this.soundSourceMosaicTexture3d||(this.soundSourceMosaicTexture3d=this.voxelizer.makeMosaicTexture3DFromRealTexture3D(e,this.soundSourceRealTexture3d,void 0)),!this.soundSourceMosaicTexture3d)return!1;if(this.pressureMosaicTexture3d_A||(this.pressureMosaicTexture3d_A=new Do,this.pressureMosaicTexture3d_A.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.pressureMosaicTexture3d_A.createTextures(t),this.pressureMosaicTexture3d_B=new Do,this.pressureMosaicTexture3d_B.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.pressureMosaicTexture3d_B.createTextures(t),this.maxPressureMosaicTexture3d_A=new Do,this.maxPressureMosaicTexture3d_A.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.maxPressureMosaicTexture3d_A.createTextures(t),this.maxPressureMosaicTexture3d_B=new Do,this.maxPressureMosaicTexture3d_B.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.maxPressureMosaicTexture3d_B.createTextures(t),this._setEnvirontmentAirPressure()),this.airVelocity_A||(this.airVelocity_A=new Do,this.airVelocity_A.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.airVelocity_A.createTextures(t),this.airVelocity_B=new Do,this.airVelocity_B.copyParametersFrom(this.fluxRFUMosaicTexture3d_HIGH_A),this.airVelocity_B.createTextures(t)),!this.auxMosaicTexture3d_forFluxCalculation){this.auxMosaicTexture3d_forFluxCalculation=new Do,this.auxMosaicTexture3d_forFluxCalculation.texture3DXSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DXSize,this.auxMosaicTexture3d_forFluxCalculation.texture3DYSize=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DYSize,this.auxMosaicTexture3d_forFluxCalculation.texture3DZSize=12,this.auxMosaicTexture3d_forFluxCalculation.mosaicXCount=4,this.auxMosaicTexture3d_forFluxCalculation.mosaicYCount=3,this.auxMosaicTexture3d_forFluxCalculation.finalSlicesCount=this.fluxRFUMosaicTexture3d_HIGH_A.finalSlicesCount;var c=t.NEAREST,d=t.CLAMP_TO_EDGE;this.auxMosaicTexture3d_forFluxCalculation.finalTextureXSize=this.auxMosaicTexture3d_forFluxCalculation.mosaicXCount*this.auxMosaicTexture3d_forFluxCalculation.texture3DXSize,this.auxMosaicTexture3d_forFluxCalculation.finalTextureYSize=this.auxMosaicTexture3d_forFluxCalculation.mosaicYCount*this.auxMosaicTexture3d_forFluxCalculation.texture3DYSize;for(var h=0;h<this.auxMosaicTexture3d_forFluxCalculation.finalSlicesCount;h++){var f=it.createTexture(t,c,void 0,this.auxMosaicTexture3d_forFluxCalculation.finalTextureXSize,this.auxMosaicTexture3d_forFluxCalculation.finalTextureYSize,d);this.auxMosaicTexture3d_forFluxCalculation.texturesArray.push(f)}}if(!this.auxMosaicTexture3d_forFluxCalculation)return!1;this.timeStepAccum||(this.timeStepAccum=0),this.oneSimulationStep||(this.airPresureFromSource||(this.timeStepAccum,this._calculateAirPressureFromSoundSource()),this._makeAuxMosaicTexture3D_forFluxCalculation(),this._calculateFlux(),this._makeAuxMosaicTexture3D_forFluxCalculation(),this._calculateVelocity()),this.timeStepAccum+=this.simulationTimeStep},Ro.prototype._calculateVelocity=function(){if(!this.voxelizer)return!1;var e=this.soundManager,t=e.magoManager,r=t.getGl(),i=this.simulationMosaicFBO,o=i.extbuffers;i.bind(),r.viewport(0,0,i.width[0],i.height[0]),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.COLOR_ATTACHMENT2_WEBGL,o.COLOR_ATTACHMENT3_WEBGL,o.NONE,o.NONE,o.NONE,o.NONE]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT4_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT5_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT6_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT7_WEBGL,r.TEXTURE_2D,null,0);var n=t.postFxShadersManager.getShader("soundCalculateVelocity");t.postFxShadersManager.useProgram(n);var a=e.getQuadBuffer(),s=new So(r),l=this.fluxRFUMosaicTexture3d_HIGH_A;r.uniform1f(n.u_airMaxPressure_loc,e.airMaxPressure),r.uniform1f(n.u_airEnvirontmentPressure_loc,e.airEnvirontmentPressure),r.uniform1f(n.u_maxFlux_loc,e.maxFlux),r.uniform1iv(n.u_mosaicSize_loc,[l.mosaicXCount,l.mosaicYCount,l.finalSlicesCount]),r.uniform1iv(n.u_texSize_loc,[l.texture3DXSize,l.texture3DYSize,l.texture3DZSize]),r.uniform3fv(n.u_voxelSizeMeters_loc,[this.oneVoxelSizeInMeters[0],this.oneVoxelSizeInMeters[1],this.oneVoxelSizeInMeters[2]]),r.uniform1f(n.u_timestep_loc,this.simulationTimeStep),r.uniform1f(n.u_maxVelocity_loc,e.airMaxVelocity),ae.bindAttribute(r,a.posBuffer,n.a_pos_loc,2),s.clearColor(0,0,0,0);for(var u=this.pressureMosaicTexture3d_A.finalSlicesCount,c=0;c<u;c++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(c),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.airVelocity_A.getTexture(c),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.maxPressureMosaicTexture3d_A.getTexture(c),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,this.shaderLogTexture_vel.getTexture(c),0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(c)),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_B.getTexture(c)),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_B.getTexture(c)),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_B.getTexture(c)),r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_B.getTexture(c)),r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,this.auxMosaicTexture3d_forFluxCalculation.getTexture(c)),r.activeTexture(r.TEXTURE6),r.bindTexture(r.TEXTURE_2D,this.maxPressureMosaicTexture3d_B.getTexture(c)),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.drawArrays(r.TRIANGLES,0,6);for(c=0;c<8;c++)r.activeTexture(r.TEXTURE0+c),r.bindTexture(r.TEXTURE_2D,null);i.unbind(),s.restoreAllParameters(),Ro._swapTextures3D(this.pressureMosaicTexture3d_A,this.pressureMosaicTexture3d_B),Ro._swapTextures3D(this.airVelocity_A,this.airVelocity_B),Ro._swapTextures3D(this.maxPressureMosaicTexture3d_A,this.maxPressureMosaicTexture3d_B)},Ro.prototype._makeAuxMosaicTexture3D_forFluxCalculation=function(){var e=this.soundManager.magoManager,t=e.getGl();if(!this.fbo_auxMosaicFlux){var r=4*this.fluxRFUMosaicTexture3d_HIGH_A.texture3DXSize,i=3*this.fluxRFUMosaicTexture3d_HIGH_A.texture3DYSize,o=e.postFxShadersManager.bUseMultiRenderTarget;this.fbo_auxMosaicFlux=new ae(t,r,i,{matchCanvasSize:!1,multiRenderTarget:o,numColorBuffers:1})}var n,a=this.fbo_auxMosaicFlux,s=a.extbuffers;a.bind(),t.viewport(0,0,a.width[0],a.height[0]),s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.NONE,s.NONE,s.NONE,s.NONE,s.NONE,s.NONE,s.NONE]),n=e.postFxShadersManager.getShader("copyTexturePartially"),e.postFxShadersManager.useProgram(n),n.bindUniformGenerals(),t.uniform1i(n.u_textureFlipYAxis_loc,!1),t.disable(t.CULL_FACE),t.disable(t.DEPTH_TEST),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE3),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE4),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE5),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE6),t.bindTexture(t.TEXTURE_2D,null),t.activeTexture(t.TEXTURE7),t.bindTexture(t.TEXTURE_2D,null),t.frontFace(t.CCW);for(var l=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DXSize,u=this.fluxRFUMosaicTexture3d_HIGH_A.texture3DYSize,c=this.fluxRFUMosaicTexture3d_HIGH_A.mosaicXCount,d=this.fluxRFUMosaicTexture3d_HIGH_A.mosaicYCount,h=1/c,f=1/d,g=this.auxMosaicTexture3d_forFluxCalculation.finalSlicesCount,p=0;p<g;p++){t.framebufferTexture2D(t.FRAMEBUFFER,s.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,this.auxMosaicTexture3d_forFluxCalculation.getTexture(p),0);for(var m=0;m<10;m++)if(0===m){var v=0,x=0;t.viewport(v,x,l,u);var _=(L=(c-1)*h)+h,y=(w=(d-1)*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);var A=p-1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(A)),t.drawArrays(t.TRIANGLES,0,6)}else if(1===m){v=1,x=0;t.viewport(v,x,l,u);_=(L=0*h)+h,y=(w=0*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);var E=p+1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(E)),t.drawArrays(t.TRIANGLES,0,6)}else if(2===m){v=2,x=0;t.viewport(v,x,l,u);_=(L=(c-1)*h)+h,y=(w=(d-1)*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);A=p-1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(A)),t.drawArrays(t.TRIANGLES,0,6)}else if(3===m){v=3,x=0;t.viewport(v,x,l,u);_=(L=0*h)+h,y=(w=0*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);E=p+1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(E)),t.drawArrays(t.TRIANGLES,0,6)}else if(4===m){v=0,x=1;t.viewport(v,x,l,u);_=(L=(c-1)*h)+h,y=(w=(d-1)*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);A=p-1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_A.getTexture(A)),t.drawArrays(t.TRIANGLES,0,6)}else if(5===m){v=1,x=1;t.viewport(v,x,l,u);_=(L=0*h)+h,y=(w=0*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);E=p+1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_A.getTexture(E)),t.drawArrays(t.TRIANGLES,0,6)}else if(6===m){v=2,x=1;t.viewport(v,x,l,u);_=(L=(c-1)*h)+h,y=(w=(d-1)*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);A=p-1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_A.getTexture(A)),t.drawArrays(t.TRIANGLES,0,6)}else if(7===m){v=3,x=1;t.viewport(v,x,l,u);_=(L=0*h)+h,y=(w=0*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);E=p+1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_A.getTexture(E)),t.drawArrays(t.TRIANGLES,0,6)}else if(8===m){v=0,x=2;t.viewport(v,x,l,u);_=(L=(c-1)*h)+h,y=(w=(d-1)*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);A=p-1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_A.getTexture(A)),t.drawArrays(t.TRIANGLES,0,6)}else if(9===m){v=1,x=2;t.viewport(v,x,l,u);var L,w;_=(L=0*h)+h,y=(w=0*f)+f,T=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),C=new Float32Array([L,w,_,w,L,y,L,y,_,w,_,y]),b=ae.createBuffer(t,T),M=ae.createBuffer(t,C);ae.bindAttribute(t,b,n.a_pos_loc,2),ae.bindAttribute(t,M,n.a_texcoord_loc,2);E=p+1;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_A.getTexture(E)),t.drawArrays(t.TRIANGLES,0,6)}}a.unbind(),t.enable(t.DEPTH_TEST),t.enable(t.CULL_FACE)},Ro.prototype._calculateFlux=function(){if(!this.voxelizer)return!1;var e=this.soundManager,t=e.magoManager,r=t.getGl(),i=this.simulationMosaicFBO,o=i.extbuffers;i.bind(),r.viewport(0,0,i.width[0],i.height[0]);var n=new So(r),a=e.getQuadBuffer(),s=t.postFxShadersManager.getShader("soundCalculateFlux");t.postFxShadersManager.useProgram(s);var l=this.fluxRFUMosaicTexture3d_HIGH_A;r.uniform1f(s.u_airMaxPressure_loc,e.airMaxPressure),r.uniform1f(s.u_maxFlux_loc,e.maxFlux),r.uniform1f(s.u_airEnvirontmentPressure_loc,e.airEnvirontmentPressure),r.uniform1iv(s.u_mosaicSize_loc,[l.mosaicXCount,l.mosaicYCount,l.finalSlicesCount]),r.uniform1iv(s.u_texSize_loc,[l.texture3DXSize,l.texture3DYSize,l.texture3DZSize]),r.uniform3fv(s.u_voxelSizeMeters_loc,[this.oneVoxelSizeInMeters[0],this.oneVoxelSizeInMeters[1],this.oneVoxelSizeInMeters[2]]),r.uniform1f(s.u_timestep_loc,this.simulationTimeStep),ae.bindAttribute(r,a.posBuffer,s.a_pos_loc,2),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.COLOR_ATTACHMENT2_WEBGL,o.COLOR_ATTACHMENT3_WEBGL,o.COLOR_ATTACHMENT4_WEBGL,o.NONE,o.NONE,o.NONE]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT5_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT6_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT7_WEBGL,r.TEXTURE_2D,null,0),n.clearColor(0,0,0,0);for(var u=this.pressureMosaicTexture3d_A.finalSlicesCount,c=0;c<u;c++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(c),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_A.getTexture(c),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_A.getTexture(c),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_A.getTexture(c),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT4_WEBGL,r.TEXTURE_2D,this.shaderLogTexture.getTexture(c),0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(c)),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_B.getTexture(c)),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this.fluxRFUMosaicTexture3d_LOW_B.getTexture(c)),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_HIGH_B.getTexture(c)),r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,this.fluxLBDMosaicTexture3d_LOW_B.getTexture(c)),r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,this.auxMosaicTexture3d_forFluxCalculation.getTexture(c)),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.drawArrays(r.TRIANGLES,0,6);r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT4_WEBGL,r.TEXTURE_2D,null,0);for(c=0;c<8;c++)r.activeTexture(r.TEXTURE0+c),r.bindTexture(r.TEXTURE_2D,null);i.unbind(),n.restoreAllParameters(),Ro._swapTextures3D(this.fluxRFUMosaicTexture3d_HIGH_A,this.fluxRFUMosaicTexture3d_HIGH_B),Ro._swapTextures3D(this.fluxRFUMosaicTexture3d_LOW_A,this.fluxRFUMosaicTexture3d_LOW_B),Ro._swapTextures3D(this.fluxLBDMosaicTexture3d_HIGH_A,this.fluxLBDMosaicTexture3d_HIGH_B),Ro._swapTextures3D(this.fluxLBDMosaicTexture3d_LOW_A,this.fluxLBDMosaicTexture3d_LOW_B)},Ro.prototype._setEnvirontmentAirPressure=function(){if(!this.voxelizer)return!1;var e=this.soundManager,t=e.magoManager,r=t.getGl(),i=this.simulationMosaicFBO,o=i.extbuffers;i.bind(),r.viewport(0,0,i.width[0],i.height[0]);var n=new So(r),a=e.getQuadBuffer(),s=t.postFxShadersManager.getShader("soundCalculateAirPressure");t.postFxShadersManager.useProgram(s),r.uniform1f(s.u_airMaxPressure_loc,e.airMaxPressure),r.uniform1f(s.u_airEnvirontmentPressure_loc,e.airEnvirontmentPressure),r.uniform1i(s.u_processType_loc,1),ae.bindAttribute(r,a.posBuffer,s.a_pos,2),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.COLOR_ATTACHMENT2_WEBGL,o.COLOR_ATTACHMENT3_WEBGL,o.NONE,o.NONE,o.NONE,o.NONE]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT4_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT5_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT6_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT7_WEBGL,r.TEXTURE_2D,null,0);for(var l=0;l<8;l++)r.activeTexture(r.TEXTURE0+l),r.bindTexture(r.TEXTURE_2D,null);n.clearColor(0,0,0,0);var u=this.pressureMosaicTexture3d_A.finalSlicesCount,c=Math.ceil(u/4);for(l=0;l<c;l++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*l+0),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*l+1),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*l+2),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*l+3),0),r.drawArrays(r.TRIANGLES,0,6);for(l=0;l<c;l++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*l+0),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*l+1),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*l+2),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*l+3),0),r.drawArrays(r.TRIANGLES,0,6);for(l=0;l<8;l++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL+l,r.TEXTURE_2D,null,0);i.unbind(),n.restoreAllParameters(),Ro._swapTextures3D(this.pressureMosaicTexture3d_A,this.pressureMosaicTexture3d_B)},Ro.prototype.drawSimulationVariables=function(){var e=this.soundManager.magoManager,t=e.getObjectLabel().getContext("2d"),r=(e.getGl(),new Kr(100,100));t.clearRect(0,0,t.canvas.width,t.canvas.height);var i=[0,0];t.fillStyle="black",t.strokeStyle="white",t.font="bold 18px Arial";var o="Wave length (m) : "+this.waveLength.toString(10);t.measureText(o).width;t.strokeText(o,r.x,r.y),t.fillText(o,r.x,r.y),i[1]+=30,o="Wave amplitude (Pa) : "+this.waveAmplitude.toString(10),t.measureText(o).width,t.strokeText(o,r.x+i[0],r.y+i[1]),t.fillText(o,r.x+i[0],r.y+i[1]),i[1]+=30,o="Simulation time step (s) : "+this.simulationTimeStep.toFixed(5).toString(10),t.measureText(o).width,t.strokeText(o,r.x+i[0],r.y+i[1]),t.fillText(o,r.x+i[0],r.y+i[1]),i[1]+=30,o="Wave phase : "+this.wavePhase.toFixed(5).toString(10),t.measureText(o).width,t.strokeText(o,r.x+i[0],r.y+i[1]),t.fillText(o,r.x+i[0],r.y+i[1]),i[1]+=30,o="Time (s) : "+this.timeStepAccum.toFixed(5).toString(10),t.measureText(o).width,t.strokeText(o,r.x+i[0],r.y+i[1]),t.fillText(o,r.x+i[0],r.y+i[1]),t.restore(),this.canvasDirty=!0},Ro.prototype._calculateAirPressureFromSoundSource=function(){if(!this.voxelizer)return!1;var e=this.soundManager,t=e.magoManager,r=t.getGl(),i=this.simulationMosaicFBO,o=i.extbuffers;i.bind(),r.viewport(0,0,i.width[0],i.height[0]);var n=new So(r),a=e.getQuadBuffer(),s=t.postFxShadersManager.getShader("soundCalculateAirPressure");t.postFxShadersManager.useProgram(s),this.waveLength=15;var l=320/this.waveLength,u=2*Math.PI*l;this.waveAmplitude=6;e.airEnvirontmentPressure;var c=this.timeStepAccum;this.wavePhase=Math.sin(u*c);var d=this.waveAmplitude*this.wavePhase+this.waveAmplitude;r.uniform1f(s.u_airMaxPressure_loc,e.airMaxPressure),r.uniform1f(s.u_airEnvirontmentPressure_loc,e.airEnvirontmentPressure),r.uniform1f(s.u_airPressureAlternative_loc,d),r.uniform1i(s.u_processType_loc,2),ae.bindAttribute(r,a.posBuffer,s.a_pos,2),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.COLOR_ATTACHMENT2_WEBGL,o.COLOR_ATTACHMENT3_WEBGL,o.NONE,o.NONE,o.NONE,o.NONE]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT4_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT5_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT6_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT7_WEBGL,r.TEXTURE_2D,null,0),n.clearColor(0,0,0,0);for(var h=this.pressureMosaicTexture3d_A.finalSlicesCount,f=Math.ceil(h/4),g=0;g<f;g++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*g+0),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*g+1),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*g+2),0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,this.pressureMosaicTexture3d_A.getTexture(4*g+3),0),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.soundSourceMosaicTexture3d.getTexture(4*g+0)),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.soundSourceMosaicTexture3d.getTexture(4*g+1)),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this.soundSourceMosaicTexture3d.getTexture(4*g+2)),r.activeTexture(r.TEXTURE3),r.bindTexture(r.TEXTURE_2D,this.soundSourceMosaicTexture3d.getTexture(4*g+3)),r.activeTexture(r.TEXTURE4),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*g+0)),r.activeTexture(r.TEXTURE5),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*g+1)),r.activeTexture(r.TEXTURE6),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*g+2)),r.activeTexture(r.TEXTURE7),r.bindTexture(r.TEXTURE_2D,this.pressureMosaicTexture3d_B.getTexture(4*g+3)),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.drawArrays(r.TRIANGLES,0,6);for(g=0;g<8;g++)r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL+g,r.TEXTURE_2D,null,0);for(g=0;g<8;g++)r.activeTexture(r.TEXTURE0+g),r.bindTexture(r.TEXTURE_2D,null);i.unbind(),n.restoreAllParameters(),Ro._swapTextures3D(this.pressureMosaicTexture3d_A,this.pressureMosaicTexture3d_B)},Ro._swapTextures3D=function(e,t){var r=e.texturesArray;e.texturesArray=t.texturesArray,t.texturesArray=r},Ro.prototype._makeQuantizedMeshVbo=function(e){var t=e.qMesh,r=(t._minimumHeight,t._maximumHeight,t._uValues),i=t._vValues,o=t._heightValues;this.indices=t._indices;var n=r.length;this.cartesiansArray=new Uint16Array(3*n);for(var a,s,l,u=0;u<n;u++)a=r[u],s=i[u],l=o[u],this.cartesiansArray[3*u]=a,this.cartesiansArray[3*u+1]=s,this.cartesiansArray[3*u+2]=l;var c=this.soundManager.magoManager.vboMemoryManager;void 0===e.qMeshVboKeyContainer&&(e.qMeshVboKeyContainer=new xt);var d=e.qMeshVboKeyContainer.newVBOVertexIdxCacheKey();d.setDataArrayPos(this.cartesiansArray,c),this.normalsArray&&d.setDataArrayNor(this.normalsArray,c),this.texCoordsArray&&d.setDataArrayTexCoord(this.texCoordsArray,c),d.setDataArrayIdx(this.indices,c)},Ro.prototype.makeDEMTextureByQuantizedMeshes=function(){if(!this.makeDemTextureByQMeshses_processFinished&&this.isPrepared()){this.terrainMinMaxHeights[0]=this.geographicExtent.minGeographicCoord.altitude,this.terrainMinMaxHeights[1]=this.geographicExtent.maxGeographicCoord.altitude;var e=this.tilesArray.length;if(!this.tilesQuantizedMeshVboMade){for(var t=0;t<e;t++){if(!(f=this.tilesArray[t]).qMeshVboKeyContainer){if(f.qMesh&&void 0===f.qMesh._uValues&&(f.qMesh=void 0),!f.qMesh){f.qMesh=ai.makeQuantizedMesh_virtually(2,2,0,void 0)}if(f.qMesh)this._makeQuantizedMeshVbo(f);else;}}this.tilesQuantizedMeshVboMade=!0}var r,i=this.soundManager,o=i.magoManager,n=o.vboMemoryManager,a=o.getGl(),s=this.terrainTexFbo,l=s.extbuffers;if(!this.original_dem_texture){var u=this.terrainTextureSize[0],c=this.terrainTextureSize[1];this.original_dem_texture=i._newTexture(a,u,c)}s.bind(),a.viewport(0,0,s.width[0],s.height[0]),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,this.original_dem_texture.texId,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,null,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.NONE]),a.disable(a.BLEND),a.disable(a.CULL_FACE),a.clearDepth(1),r=o.postFxShadersManager.getShader("depthTexFromQuantizedMesh"),o.postFxShadersManager.useProgram(r),r.bindUniformGenerals(),a.uniform1i(r.colorType_loc_loc,0),a.uniform1i(r.u_terrainHeightEncodingBytes_loc,i.terrainHeightEncodingBytes),a.uniform1i(r.u_flipTexCoordY_loc,!1),a.clear(a.DEPTH_BUFFER_BIT);var d=this.geographicExtent;a.uniform3fv(r.u_totalMinGeoCoord_loc,new Float32Array([d.minGeographicCoord.longitude,d.minGeographicCoord.latitude,d.minGeographicCoord.altitude])),a.uniform3fv(r.u_totalMaxGeoCoord_loc,new Float32Array([d.maxGeographicCoord.longitude,d.maxGeographicCoord.latitude,d.maxGeographicCoord.altitude])),void 0===this.demTextureByQMesh_lastTileIdx&&(this.demTextureByQMesh_lastTileIdx=0);for(t=0;t<50;t++){var h=t+this.demTextureByQMesh_lastTileIdx;if(h>=e){this.original_dem_texture.fileLoadState=I.fileLoadState.BINDING_FINISHED,this.makeDemTextureByQMeshses_processFinished=!0;break}var f,g=(f=this.tilesArray[h]).geoExtent;a.uniform3fv(r.u_currentMinGeoCoord_loc,new Float32Array([g.minGeographicCoord.longitude,g.minGeographicCoord.latitude,f.qMesh._minimumHeight])),a.uniform3fv(r.u_currentMaxGeoCoord_loc,new Float32Array([g.maxGeographicCoord.longitude,g.maxGeographicCoord.latitude,f.qMesh._maximumHeight]));var p=f.qMeshVboKeyContainer.vboCacheKeysArray[0];p.vertexCount;p.vboBufferPos.bindData(r,r.position3_loc,n);var m=p.indicesCount;if(!p.bindDataIndice(r,o.vboMemoryManager))return!1;a.drawElements(a.TRIANGLES,m,a.UNSIGNED_SHORT,0)}this.demTextureByQMesh_lastTileIdx+=50,s.unbind(),a.enable(a.CULL_FACE)}},Ro.prototype.getBoundingSphereWC=function(){if(!this._BSphereWC){var e=this.soundManager.magoManager;this._BSphereWC=Ke.computeSphereExtent(e,this.geographicExtent.minGeographicCoord,this.geographicExtent.maxGeographicCoord,void 0)}return this._BSphereWC},Ro.prototype._isObjectIdDemOverWrited=function(e){return!!this.buildingsId_OverWritedOnDemMap&&this.buildingsId_OverWritedOnDemMap.hasOwnProperty(e)},Ro.prototype.doIntersectedObjectsCulling=function(e,t){if(!this.intersectedObjectsCullingFinished){var r=this.soundManager.magoManager.smartTileManager;this.visibleObjectsControler||(this.visibleObjectsControler=new _t),r.getRenderableObjectsInGeographicExtent(this.geographicExtent,this.visibleObjectsControler),this.visibleObjectsControler.getAllVisibles().length>0&&(this.intersectedObjectsCullingFinished=!0)}return!0},Ro.prototype.getTileOrthographic_mvpMat_zAxisDirection=function(){if(!this.tileOrthoModelViewProjMatrix_zAxisDirection){var e=this.geographicExtent.minGeographicCoord.longitude,t=this.geographicExtent.minGeographicCoord.latitude,r=this.geographicExtent.minGeographicCoord.altitude,i=this.geographicExtent.maxGeographicCoord.longitude,o=this.geographicExtent.maxGeographicCoord.latitude,n=this.geographicExtent.maxGeographicCoord.altitude,a=(e+i)/2,s=(t+o)/2,l=(r+n)/2,u=i-e,c=o-t,d=n-r,h=-u/2,f=u/2,g=-c/2,p=c/2,m=-d/2,v=d/2,x=new Ne;x._floatArrays=glMatrix.mat4.ortho(x._floatArrays,h,f,g,p,1*m,1*v);var _=new Ne;_.setTranslation(a,s,l);var y=new Ne;y._floatArrays=glMatrix.mat4.invert(y._floatArrays,_._floatArrays),this.tileOrthoModelViewProjMatrix_zAxisDirection=new Ne,this.tileOrthoModelViewProjMatrix_zAxisDirection=y.getMultipliedByMatrix(x,this.tileOrthoModelViewProjMatrix_zAxisDirection)}return this.tileOrthoModelViewProjMatrix_zAxisDirection},Ro.prototype.getTileOrthographic_mvpMat_yAxisDirection=function(){if(!this.tileOrthoModelViewProjMatrix_yAxisDirection){var e=this.geographicExtent.minGeographicCoord.longitude,t=this.geographicExtent.minGeographicCoord.latitude,r=this.geographicExtent.minGeographicCoord.altitude,i=this.geographicExtent.maxGeographicCoord.longitude,o=this.geographicExtent.maxGeographicCoord.latitude,n=this.geographicExtent.maxGeographicCoord.altitude,a=(e+i)/2,s=(t+o)/2,l=(r+n)/2,u=i-e,c=o-t,d=n-r,h=-u/2,f=u/2,g=-d/2,p=d/2,m=-c/2,v=c/2,x=new Ne;x._floatArrays=glMatrix.mat4.ortho(x._floatArrays,h,f,g,p,1*m,1*v);var _=new Ne;_.setTranslation(a,s,l);var y=new Ne;y.rotationAxisAngDeg(90,1,0,0);var T=new Ne;T=y.getMultipliedByMatrix(_,T);var C=new Ne;C._floatArrays=glMatrix.mat4.invert(C._floatArrays,T._floatArrays),this.tileOrthoModelViewProjMatrix_yAxisDirection=new Ne,this.tileOrthoModelViewProjMatrix_yAxisDirection=C.getMultipliedByMatrix(x,this.tileOrthoModelViewProjMatrix_yAxisDirection)}return this.tileOrthoModelViewProjMatrix_yAxisDirection},Ro.prototype.getTileOrthographic_mvpMat_xAxisDirection=function(){if(!this.tileOrthoModelViewProjMatrix_xAxisDirection){var e=this.geographicExtent.minGeographicCoord.longitude,t=this.geographicExtent.minGeographicCoord.latitude,r=this.geographicExtent.minGeographicCoord.altitude,i=this.geographicExtent.maxGeographicCoord.longitude,o=this.geographicExtent.maxGeographicCoord.latitude,n=this.geographicExtent.maxGeographicCoord.altitude,a=(e+i)/2,s=(t+o)/2,l=(r+n)/2,u=i-e,c=o-t,d=n-r,h=-c/2,f=c/2,g=-d/2,p=d/2,m=-u/2,v=u/2,x=new Ne;x._floatArrays=glMatrix.mat4.ortho(x._floatArrays,h,f,g,p,1*m,1*v);var _=new Ne;_.setTranslation(a,s,l);var y=new Ne;y.rotationAxisAngDeg(-90,0,0,1);var T=new Ne;T.rotationAxisAngDeg(90,1,0,0);var C=new Ne;C=T.getMultipliedByMatrix(y,C);var b=new Ne;b=C.getMultipliedByMatrix(_,b);var M=new Ne;M._floatArrays=glMatrix.mat4.invert(M._floatArrays,b._floatArrays),this.tileOrthoModelViewProjMatrix_xAxisDirection=new Ne,this.tileOrthoModelViewProjMatrix_xAxisDirection=M.getMultipliedByMatrix(x,this.tileOrthoModelViewProjMatrix_xAxisDirection)}return this.tileOrthoModelViewProjMatrix_xAxisDirection},Ro.prototype.getTileOrthographic_mvpMat=function(){if(!this.tileOrthoModelViewProjMatrix){var e=this.geographicExtent.minGeographicCoord.longitude,t=this.geographicExtent.minGeographicCoord.latitude,r=this.geographicExtent.minGeographicCoord.altitude,i=this.geographicExtent.maxGeographicCoord.longitude,o=this.geographicExtent.maxGeographicCoord.latitude,n=this.geographicExtent.maxGeographicCoord.altitude,a=(e+i)/2,s=(t+o)/2,l=(r+n)/2,u=i-e,c=o-t,d=n-r,h=-u/2,f=u/2,g=-c/2,p=c/2,m=-d/2,v=d/2,x=new Ne;x._floatArrays=glMatrix.mat4.ortho(x._floatArrays,h,f,g,p,1*m,1*v);var _=new Ne;_.setTranslation(a,s,l);var y=new Ne;y._floatArrays=glMatrix.mat4.invert(y._floatArrays,_._floatArrays),this.tileOrthoModelViewProjMatrix=new Ne,this.tileOrthoModelViewProjMatrix=y.getMultipliedByMatrix(x,this.tileOrthoModelViewProjMatrix)}return this.tileOrthoModelViewProjMatrix},Ro.prototype.copyTexture=function(e,t,r,i){var o=this.soundManager.magoManager,n=this.soundManager.getQuadBuffer(),a=o.getGl();i||(i=this.fbo);var s,l=i.extbuffers,u=t[0];i.bind(),a.viewport(0,0,i.width[0],i.height[0]),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,u.texId,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,null,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.NONE]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,e.texId),a.disable(a.BLEND),s=o.postFxShadersManager.getShader("waterCopyTexture"),o.postFxShadersManager.useProgram(s),s.bindUniformGenerals(),a.uniform1i(s.u_textureFlipYAxis_loc,r),ae.bindAttribute(a,n.posBuffer,s.attribLocations.a_pos,2),a.drawArrays(a.TRIANGLES,0,6),a.enable(a.BLEND),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),i.unbind()},Ro.prototype._renderVisibleObjects=function(e,t){var r=this.visibleObjectsControler.currentVisibles0.length,i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length;this.buildingsId_OverWritedOnDemMap||(this.buildingsId_OverWritedOnDemMap={});var n=-1;this.overWriteDEMWithObjectsFinished=!0;for(var a=0;a<r;a++){var s=this.visibleObjectsControler.currentVisibles0[a];(void 0===(n=s.renderContent(t,e,0,0))||n<0)&&(this.overWriteDEMWithObjectsFinished=!1),this.buildingsId_OverWritedOnDemMap[s._guid]=s}for(i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,a=0;a<i;a++){if("contaminationGenerator"!==(u=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray[a]).name&&"excavationObject"!==u.name&&"waterGenerator"!==u.name){void 0===u.attributes&&(u.attributes={});var l=u.attributes.doubleFace;void 0!==u.attributes.doubleFace&&!1!==u.attributes.doubleFace||(u.attributes.doubleFace=!0),u.render(t,e,0,void 0),this.buildingsId_OverWritedOnDemMap[u._guid]=u,u.attributes.doubleFace=l}}for(o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,a=0;a<o;a++){var u;if("contaminationGenerator"!==(u=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray[a]).name&&"excavationObject"!==u.name&&"waterGenerator"!==u.name){void 0===u.attributes&&(u.attributes={});l=u.attributes.doubleFace;void 0!==u.attributes.doubleFace&&!1!==u.attributes.doubleFace||(u.attributes.doubleFace=!0),u.render(t,e,0,void 0),this.buildingsId_OverWritedOnDemMap[u._guid]=u,u.attributes.doubleFace=l}}},Ro.prototype.overWriteDEMWithObjects=function(e,t){if(this.overWriteDEMWithObjectsFinished)return!0;if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;if(!this.original_dem_texture)return!1;var r=this.visibleObjectsControler.currentVisibles0.length,i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,n=this.getTileOrthographic_mvpMat(),a=this.soundManager,s=t.getGl(),l=this.fbo,u=l.extbuffers;if(!this.demWithBuildingsTex_isPrepared){this.copyTexture(this.original_dem_texture,[this.demWithBuildingsTex],!1),this.demWithBuildingsTex_isPrepared=!0}if(r+i+o!==0){l.bind(),s.viewport(0,0,l.width[0],l.height[0]),s.framebufferTexture2D(s.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,s.TEXTURE_2D,this.demWithBuildingsTex.texId,0),s.framebufferTexture2D(s.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,s.TEXTURE_2D,null,0),s.framebufferTexture2D(s.FRAMEBUFFER,u.COLOR_ATTACHMENT2_WEBGL,s.TEXTURE_2D,null,0),s.framebufferTexture2D(s.FRAMEBUFFER,u.COLOR_ATTACHMENT3_WEBGL,s.TEXTURE_2D,null,0),u.drawBuffersWEBGL([u.COLOR_ATTACHMENT0_WEBGL,u.NONE,u.NONE,u.NONE]),s.disable(s.BLEND),s.clearDepth(1),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.original_dem_texture.texId),e=t.postFxShadersManager.getShader("waterOrthogonalDepthRender"),t.postFxShadersManager.useProgram(e),e.bindUniformGenerals();var c=this.geographicExtent;s.uniformMatrix4fv(e.u_modelViewProjectionMatrix_loc,!1,n._floatArrays),s.uniform3fv(e.aditionalMov_loc,[0,0,0]),s.uniform4fv(e.u_color4_loc,[1,0,0,1]),s.uniform2fv(e.u_heightMap_MinMax_loc,[c.minGeographicCoord.altitude,c.maxGeographicCoord.altitude]),s.uniform2fv(e.u_simulationTextureSize_loc,this.simulationTextureSize),s.uniform1i(e.u_terrainHeightEncodingBytes_loc,a.terrainHeightEncodingBytes),s.uniform1i(e.u_processType_loc,0),s.uniform3fv(e.u_quantizedVolume_MinMax_loc,[0,0,0,1,1,1]),s.clear(s.DEPTH_BUFFER_BIT),this.overWriteDEMWithObjectsFinished=!0,s.enable(s.CULL_FACE),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.frontFace(s.CCW)}}},Ro.prototype._voxelizeInYDirection=function(e){if(!this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray||0===this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray.length)return!1;if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;if(!this.original_dem_texture)return!1;var t,r=this.visibleObjectsControler.currentVisibles0.length,i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,n=this.soundManager,a=e.getGl();if(r+i+o!==0){var s=this.simulationTextureSize[0],l=this.simulationTextureSize[1],u=this.texturesNumSlices;if(!this.fbo_yAxisDirection){var c=s,d=u,h=e.postFxShadersManager.bUseMultiRenderTarget;this.fbo_yAxisDirection=new ae(a,c,d,{matchCanvasSize:!1,multiRenderTarget:h,numColorBuffers:8})}if(!this.auxTex3d_yDirection){var f={};f.texture3DXSize=s,f.texture3DYSize=u,f.texture3DZSize=8,this.auxTex3d_yDirection=new Do(f),this.auxTex3d_yDirection.createTextures(a)}var g=this.fbo_yAxisDirection,p=g.extbuffers;a.clearColor(0,0,0,0),a.clearDepth(1);for(var m=0,v=1,x=Math.ceil(l/8),_=1/x,y=0;y<x;y++){p=(g=this.fbo_yAxisDirection).extbuffers,g.bind(),a.viewport(0,0,g.width[0],g.height[0]),p.drawBuffersWEBGL([p.COLOR_ATTACHMENT0_WEBGL,p.COLOR_ATTACHMENT1_WEBGL,p.COLOR_ATTACHMENT2_WEBGL,p.COLOR_ATTACHMENT3_WEBGL,p.COLOR_ATTACHMENT4_WEBGL,p.COLOR_ATTACHMENT5_WEBGL,p.COLOR_ATTACHMENT6_WEBGL,p.COLOR_ATTACHMENT7_WEBGL]),t=e.postFxShadersManager.getShader("orthogonalVoxelizationRender_MRT"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals();var T=this.getTileOrthographic_mvpMat_yAxisDirection();a.uniformMatrix4fv(t.u_modelViewProjectionMatrix_loc,!1,T._floatArrays),a.uniform1i(t.u_processType_loc,2),v=(m=y*_)+_,a.uniform3fv(t.u_quantizedVolume_MinMax_loc,[0,0,m,1,1,v]),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,this.auxTex3d_yDirection.getTexture(0),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,this.auxTex3d_yDirection.getTexture(1),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,this.auxTex3d_yDirection.getTexture(2),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,this.auxTex3d_yDirection.getTexture(3),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT4_WEBGL,a.TEXTURE_2D,this.auxTex3d_yDirection.getTexture(4),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT5_WEBGL,a.TEXTURE_2D,this.auxTex3d_yDirection.getTexture(5),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT6_WEBGL,a.TEXTURE_2D,this.auxTex3d_yDirection.getTexture(6),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT7_WEBGL,a.TEXTURE_2D,this.auxTex3d_yDirection.getTexture(7),0),a.clear(a.DEPTH_BUFFER_BIT|a.COLOR_BUFFER_BIT),a.disable(a.CULL_FACE),this._renderVisibleObjects(t,e),this.mosaic_partial_ydirection=this.voxelizer.makeMosaicTexture3DFromRealTexture3D(e,this.auxTex3d_yDirection,this.mosaic_partial_ydirection),p=(g=this.simulationMosaicFBO).extbuffers,g.bind(),a.viewport(0,0,g.width[0],g.height[0]),p.drawBuffersWEBGL([p.COLOR_ATTACHMENT0_WEBGL,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE]);t=e.postFxShadersManager.getShader("voxelizeFromPartialYDirectionTexture3D"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals();var C=this.fluxRFUMosaicTexture3d_HIGH_A;a.uniform1iv(t.u_texSize_loc,[C.texture3DXSize,C.texture3DYSize,C.texture3DZSize]),a.uniform1iv(t.u_mosaicTexSize_loc,[C.finalTextureXSize,C.finalTextureYSize,C.finalSlicesCount]),a.uniform1iv(t.u_mosaicSize_loc,[C.mosaicXCount,C.mosaicYCount,C.finalSlicesCount]),a.uniform1iv(t.u_yDirMosaicSize_loc,[this.mosaic_partial_ydirection.mosaicXCount,this.mosaic_partial_ydirection.mosaicYCount,this.mosaic_partial_ydirection.finalSlicesCount]),a.uniform1iv(t.u_yDirTextureSize_loc,[this.mosaic_partial_ydirection.texture3DXSize,this.mosaic_partial_ydirection.texture3DYSize,this.mosaic_partial_ydirection.texture3DZSize]);var b=new Int32Array([8*y]);a.uniform1i(t.u_lowestYDirMosaicSliceIndex_loc,b[0]);var M=n.getQuadBuffer();ae.bindAttribute(a,M.posBuffer,t.a_pos,2),a.disable(a.DEPTH_TEST);for(var A=this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray.length,E=0;E<A;E++)a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(E),0),a.uniform1i(t.u_lowestMosaicSliceIndex_loc,E),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_B.getTexture(E)),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.mosaic_partial_ydirection.getTexture(0)),a.drawArrays(a.TRIANGLES,0,6);a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,null),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,null,0),g.unbind(),a.enable(a.DEPTH_TEST),Ro._swapTextures3D(this.fluxRFUMosaicTexture3d_HIGH_A,this.fluxRFUMosaicTexture3d_HIGH_B)}g.unbind(),a.clearColor(0,0,0,1),a.enable(a.CULL_FACE),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.frontFace(a.CCW)}}},Ro.prototype._voxelizeInZDirection=function(e){if(!this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray||0===this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray.length)return!1;if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;if(!this.original_dem_texture)return!1;var t,r=this.visibleObjectsControler.currentVisibles0.length,i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,n=this.soundManager,a=e.getGl();if(r+i+o!==0){var s=this.simulationTextureSize[0],l=this.simulationTextureSize[1],u=this.texturesNumSlices;if(!this.fbo_zAxisDirection){var c=s,d=l,h=e.postFxShadersManager.bUseMultiRenderTarget;this.fbo_zAxisDirection=new ae(a,c,d,{matchCanvasSize:!1,multiRenderTarget:h,numColorBuffers:8})}if(!this.auxTex3d_zDirection){var f={};f.texture3DXSize=s,f.texture3DYSize=l,f.texture3DZSize=8,this.auxTex3d_zDirection=new Do(f),this.auxTex3d_zDirection.createTextures(a)}var g=this.fbo_zAxisDirection,p=g.extbuffers;a.clearColor(0,0,0,0),a.clearDepth(1);for(var m=0,v=1,x=Math.ceil(u/8),_=1/x,y=0;y<x;y++){p=(g=this.fbo_zAxisDirection).extbuffers,g.bind(),a.viewport(0,0,g.width[0],g.height[0]),p.drawBuffersWEBGL([p.COLOR_ATTACHMENT0_WEBGL,p.COLOR_ATTACHMENT1_WEBGL,p.COLOR_ATTACHMENT2_WEBGL,p.COLOR_ATTACHMENT3_WEBGL,p.COLOR_ATTACHMENT4_WEBGL,p.COLOR_ATTACHMENT5_WEBGL,p.COLOR_ATTACHMENT6_WEBGL,p.COLOR_ATTACHMENT7_WEBGL]),t=e.postFxShadersManager.getShader("orthogonalVoxelizationRender_MRT"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals();var T=this.getTileOrthographic_mvpMat_zAxisDirection();a.uniformMatrix4fv(t.u_modelViewProjectionMatrix_loc,!1,T._floatArrays),a.uniform1i(t.u_processType_loc,2),v=(m=y*_)+_,a.uniform3fv(t.u_quantizedVolume_MinMax_loc,[0,0,m,1,1,v]),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,this.auxTex3d_zDirection.getTexture(0),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,this.auxTex3d_zDirection.getTexture(1),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,this.auxTex3d_zDirection.getTexture(2),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,this.auxTex3d_zDirection.getTexture(3),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT4_WEBGL,a.TEXTURE_2D,this.auxTex3d_zDirection.getTexture(4),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT5_WEBGL,a.TEXTURE_2D,this.auxTex3d_zDirection.getTexture(5),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT6_WEBGL,a.TEXTURE_2D,this.auxTex3d_zDirection.getTexture(6),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT7_WEBGL,a.TEXTURE_2D,this.auxTex3d_zDirection.getTexture(7),0),a.clear(a.DEPTH_BUFFER_BIT|a.COLOR_BUFFER_BIT),a.disable(a.CULL_FACE),this._renderVisibleObjects(t,e),this.mosaic_partial_zdirection=this.voxelizer.makeMosaicTexture3DFromRealTexture3D(e,this.auxTex3d_zDirection,this.mosaic_partial_zdirection),p=(g=this.simulationMosaicFBO).extbuffers,g.bind(),a.viewport(0,0,g.width[0],g.height[0]),p.drawBuffersWEBGL([p.COLOR_ATTACHMENT0_WEBGL,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE]);t=e.postFxShadersManager.getShader("voxelizeFromPartialZDirectionTexture3D"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals();var C=this.fluxRFUMosaicTexture3d_HIGH_A;a.uniform1iv(t.u_texSize_loc,[C.texture3DXSize,C.texture3DYSize,C.texture3DZSize]),a.uniform1iv(t.u_mosaicTexSize_loc,[C.finalTextureXSize,C.finalTextureYSize,C.finalSlicesCount]),a.uniform1iv(t.u_mosaicSize_loc,[C.mosaicXCount,C.mosaicYCount,C.finalSlicesCount]),a.uniform1iv(t.u_zDirMosaicSize_loc,[this.mosaic_partial_zdirection.mosaicXCount,this.mosaic_partial_zdirection.mosaicYCount,this.mosaic_partial_zdirection.finalSlicesCount]),a.uniform1iv(t.u_zDirTextureSize_loc,[this.mosaic_partial_zdirection.texture3DXSize,this.mosaic_partial_zdirection.texture3DYSize,this.mosaic_partial_zdirection.texture3DZSize]);var b=new Int32Array([8*y]);a.uniform1i(t.u_lowestZDirMosaicSliceIndex_loc,b[0]);var M=n.getQuadBuffer();ae.bindAttribute(a,M.posBuffer,t.a_pos,2),a.disable(a.DEPTH_TEST);for(var A=this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray.length,E=0;E<A;E++)a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(E),0),a.uniform1i(t.u_lowestMosaicSliceIndex_loc,E),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_B.getTexture(E)),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.mosaic_partial_zdirection.getTexture(0)),a.drawArrays(a.TRIANGLES,0,6);a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,null),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,null,0),g.unbind(),a.enable(a.DEPTH_TEST),Ro._swapTextures3D(this.fluxRFUMosaicTexture3d_HIGH_A,this.fluxRFUMosaicTexture3d_HIGH_B)}g.unbind(),a.clearColor(0,0,0,1),a.enable(a.CULL_FACE),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.frontFace(a.CCW)}}},Ro.prototype._voxelizeInXDirection=function(e){if(!this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray||0===this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray.length)return!1;if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;if(!this.original_dem_texture)return!1;var t,r=this.visibleObjectsControler.currentVisibles0.length,i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,n=this.soundManager,a=e.getGl();if(r+i+o!==0){var s=this.simulationTextureSize[0],l=this.simulationTextureSize[1],u=this.texturesNumSlices;if(!this.fbo_xAxisDirection){var c=l,d=u,h=e.postFxShadersManager.bUseMultiRenderTarget;this.fbo_xAxisDirection=new ae(a,c,d,{matchCanvasSize:!1,multiRenderTarget:h,numColorBuffers:8})}if(!this.auxTex3d_xDirection){var f={};f.texture3DXSize=l,f.texture3DYSize=u,f.texture3DZSize=8,this.auxTex3d_xDirection=new Do(f),this.auxTex3d_xDirection.createTextures(a)}var g=this.fbo_xAxisDirection,p=g.extbuffers;a.clearColor(0,0,0,0),a.clearDepth(1);for(var m=0,v=1,x=Math.ceil(s/8),_=1/x,y=0;y<x;y++){p=(g=this.fbo_xAxisDirection).extbuffers,g.bind(),a.viewport(0,0,g.width[0],g.height[0]),p.drawBuffersWEBGL([p.COLOR_ATTACHMENT0_WEBGL,p.COLOR_ATTACHMENT1_WEBGL,p.COLOR_ATTACHMENT2_WEBGL,p.COLOR_ATTACHMENT3_WEBGL,p.COLOR_ATTACHMENT4_WEBGL,p.COLOR_ATTACHMENT5_WEBGL,p.COLOR_ATTACHMENT6_WEBGL,p.COLOR_ATTACHMENT7_WEBGL]),t=e.postFxShadersManager.getShader("orthogonalVoxelizationRender_MRT"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals();var T=this.getTileOrthographic_mvpMat_xAxisDirection();a.uniformMatrix4fv(t.u_modelViewProjectionMatrix_loc,!1,T._floatArrays),a.uniform1i(t.u_processType_loc,2),v=(m=y*_)+_,a.uniform3fv(t.u_quantizedVolume_MinMax_loc,[0,0,m,1,1,v]),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,this.auxTex3d_xDirection.getTexture(0),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,this.auxTex3d_xDirection.getTexture(1),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,this.auxTex3d_xDirection.getTexture(2),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,this.auxTex3d_xDirection.getTexture(3),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT4_WEBGL,a.TEXTURE_2D,this.auxTex3d_xDirection.getTexture(4),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT5_WEBGL,a.TEXTURE_2D,this.auxTex3d_xDirection.getTexture(5),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT6_WEBGL,a.TEXTURE_2D,this.auxTex3d_xDirection.getTexture(6),0),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT7_WEBGL,a.TEXTURE_2D,this.auxTex3d_xDirection.getTexture(7),0),a.clear(a.DEPTH_BUFFER_BIT|a.COLOR_BUFFER_BIT),a.disable(a.CULL_FACE),this._renderVisibleObjects(t,e),this.mosaic_partial_xdirection=this.voxelizer.makeMosaicTexture3DFromRealTexture3D(e,this.auxTex3d_xDirection,this.mosaic_partial_xdirection),p=(g=this.simulationMosaicFBO).extbuffers,g.bind(),a.viewport(0,0,g.width[0],g.height[0]),p.drawBuffersWEBGL([p.COLOR_ATTACHMENT0_WEBGL,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE,p.NONE]);t=e.postFxShadersManager.getShader("voxelizeFromPartialXDirectionTexture3D"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals();var C=this.fluxRFUMosaicTexture3d_HIGH_A;a.uniform1iv(t.u_texSize_loc,[C.texture3DXSize,C.texture3DYSize,C.texture3DZSize]),a.uniform1iv(t.u_mosaicTexSize_loc,[C.finalTextureXSize,C.finalTextureYSize,C.finalSlicesCount]),a.uniform1iv(t.u_mosaicSize_loc,[C.mosaicXCount,C.mosaicYCount,C.finalSlicesCount]),a.uniform1iv(t.u_xDirMosaicSize_loc,[this.mosaic_partial_xdirection.mosaicXCount,this.mosaic_partial_xdirection.mosaicYCount,this.mosaic_partial_xdirection.finalSlicesCount]),a.uniform1iv(t.u_xDirTextureSize_loc,[this.mosaic_partial_xdirection.texture3DXSize,this.mosaic_partial_xdirection.texture3DYSize,this.mosaic_partial_xdirection.texture3DZSize]);var b=new Int32Array([8*y]);a.uniform1i(t.u_lowestXDirMosaicSliceIndex_loc,b[0]);var M=n.getQuadBuffer();ae.bindAttribute(a,M.posBuffer,t.a_pos,2),a.disable(a.DEPTH_TEST);for(var A=this.fluxRFUMosaicTexture3d_HIGH_B.texturesArray.length,E=0;E<A;E++)a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_A.getTexture(E),0),a.uniform1i(t.u_lowestMosaicSliceIndex_loc,E),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,this.fluxRFUMosaicTexture3d_HIGH_B.getTexture(E)),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,this.mosaic_partial_xdirection.getTexture(0)),a.drawArrays(a.TRIANGLES,0,6);a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.activeTexture(a.TEXTURE1),a.bindTexture(a.TEXTURE_2D,null),a.framebufferTexture2D(a.FRAMEBUFFER,p.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,null,0),g.unbind(),a.enable(a.DEPTH_TEST),Ro._swapTextures3D(this.fluxRFUMosaicTexture3d_HIGH_A,this.fluxRFUMosaicTexture3d_HIGH_B)}g.unbind(),a.clearColor(0,0,0,1),a.enable(a.CULL_FACE),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.frontFace(a.CCW)}}};var Po=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.soundLayersArray=[],this.magoManager=t,this.maxSimulationSize=500,this.simulationTextureSize=new Float32Array([this.maxSimulationSize,this.maxSimulationSize]),this.bSsimulateSound=!1,this.terrainTextureSize=new Float32Array([this.maxSimulationSize,this.maxSimulationSize]),this.terrainHeightEncodingBytes=1,this.airMaxPressure=20,this.airEnvirontmentPressure=1,this.maxFlux=200,this.airMaxVelocity=200,this.terrainDemSourceType="QUANTIZEDMESH",this.terrainProvider=this.magoManager.scene.globe.terrainProvider,this.fbo,this.init()};Po.prototype.init=function(){this.magoManager;var e=this.magoManager.getGl();if(!this.fbo){var t=this.simulationTextureSize[0],r=this.simulationTextureSize[1],i=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.fbo=new ae(e,t,r,{matchCanvasSize:!1,multiRenderTarget:i,numColorBuffers:3})}if(!this.terrainTexFbo){t=this.terrainTextureSize[0],r=this.terrainTextureSize[1],i=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.terrainTexFbo=new ae(e,t,r,{matchCanvasSize:!1,multiRenderTarget:i,numColorBuffers:3})}this.createDefaultShaders()},Po.prototype.doSimulation=function(){var e=this.magoManager,t=this.soundLayersArray.length;if(0===this.magoManager.currentFrustumIdx)for(var r=0;r<t;r++)this.soundLayersArray[r].doSimulationSteps(e)},Po.prototype.overWriteDEMWithObjects=function(){for(var e=this.soundLayersArray.length,t=this.magoManager,r=0;r<e;r++)this.soundLayersArray[r].overWriteDEMWithObjects(void 0,t)},Po.prototype._renderSoundLayers=function(){for(var e=this.magoManager,t=this.soundLayersArray.length,r=0;r<t;r++)this.soundLayersArray[r].renderWave(e)},Po.prototype.render=function(){this.testStarted||this._test_sound_withoutQMesh();var e=this.magoManager;this.overWriteDEMWithObjects(),e.isCameraMoving||e.mouseLeftDown||e.mouseMiddleDown||this.doSimulation(),this._renderSoundLayers();var t=e.getGl(),r=e.sceneState;e.bindMainFramebuffer(),t.viewport(0,0,r.drawingBufferWidth[0],r.drawingBufferHeight[0])},Po.prototype.newSoundLayer=function(e){var t=new Ro(this,e);return this.soundLayersArray.push(t),t},Po.prototype.doIntersectedObjectsCulling=function(e,t){this.magoManager.isFarestFrustum();for(var r=this.soundLayersArray.length,i=0;i<r;i++)this.soundLayersArray[i].doIntersectedObjectsCulling(e,t);this.intersectedObjectsCullingFinished=!0},Po.prototype._test_sound=function(){var e=new xe(127.23596,36.50977,60,127.23915,36.51229,140),t={geographicExtent:e};this.newSoundLayer(t);if(this.simulationBox=e.getRenderableObject(this.magoManager),this.simulationBox.setOneColor(0,146/255,203/255,.3),this.simulationBox.attributes.isMovable=!1,this.simulationBox.attributes.isSelectable=!1,this.simulationBox.attributes.name="soundSimulationSpaceBox",this.simulationBox.attributes.doubleFace=!0,this.simulationBox.attributes.selectedColor4=new J(1,0,0,0),void 0===this.simulationBox.options&&(this.simulationBox.options={}),this.simulationBox.options.renderWireframe=!0,this.simulationBox.objectsArray&&this.simulationBox.objectsArray.length>0){var r=this.simulationBox.objectsArray[0];r.thickness=2.5;var i=r.getSurfacesCount();r.setColor(0,146/255,203/255,.3),r.getSurface(i-2).setColor(0,146/255,203/255,0),r.getSurface(i-1).setColor(0,146/255,203/255,0)}this.simulationBox.options.renderShaded=!0,this.simulationBox.options.depthMask=!1;this.testStarted=!0},Po.prototype._test_sound_withoutQMesh=function(){var e=new xe(126.88525,35.15373,-5,126.88799,35.15686,40),t={geographicExtent:e};this.newSoundLayer(t);if(this.simulationBox=e.getRenderableObject(this.magoManager),this.simulationBox.setOneColor(0,146/255,203/255,.3),this.simulationBox.attributes.isMovable=!1,this.simulationBox.attributes.isSelectable=!1,this.simulationBox.attributes.name="soundSimulationSpaceBox",this.simulationBox.attributes.doubleFace=!0,this.simulationBox.attributes.selectedColor4=new J(1,0,0,0),void 0===this.simulationBox.options&&(this.simulationBox.options={}),this.simulationBox.options.renderWireframe=!0,this.simulationBox.objectsArray&&this.simulationBox.objectsArray.length>0){var r=this.simulationBox.objectsArray[0];r.thickness=2.5;var i=r.getSurfacesCount();r.setColor(0,146/255,203/255,.3),r.getSurface(i-2).setColor(0,146/255,203/255,0),r.getSurface(i-1).setColor(0,146/255,203/255,0)}this.simulationBox.options.renderShaded=!0,this.simulationBox.options.depthMask=!1;this.testStarted=!0},Po.prototype._newTexture=function(e,t,r){var i=new Uint8Array(t*r*4),o=e.NEAREST,n=it.createTexture(e,o,i,t,r),a=new it;return a.texId=n,a.fileLoadState=I.fileLoadState.BINDING_FINISHED,a.imageWidth=t,a.imageHeight=r,a},Po.prototype.getQuadBuffer=function(){if(!this.screenQuad){var e=this.magoManager.getGl(),t=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r=ae.createBuffer(e,t);this.screenQuad={posBuffer:r}}return this.screenQuad},Po.prototype.createDefaultShaders=function(){var e=this.magoManager,t=e.getGl(),r="USE_LINEAR_DEPTH",i="NO_USE_MULTI_RENDER_TARGET";t.getParameter(t.VERSION);e.isCesiumGlobe()||(t.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&t.getExtension("EXT_frag_depth"),e.EXTENSIONS_init=!0,r="USE_LOGARITHMIC_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!0);if(e.postFxShadersManager.bUseMultiRenderTarget=!1,t.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){t.getExtension("WEBGL_draw_buffers");e.postFxShadersManager.bUseMultiRenderTarget=!0,i="USE_MULTI_RENDER_TARGET"}window.navigator.userAgent.indexOf("Trident")>-1&&(r="USE_LINEAR_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!1);var o="depthTexFromQuantizedMesh",n=Bo.waterQuantizedMeshVS,a=Bo.waterDEMTexFromQuantizedMeshFS;a=(a=a.replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i);var s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager);s.position3_loc=t.getAttribLocation(s.program,"a_pos"),s.color4_loc=t.getAttribLocation(s.program,"color4"),s.u_minMaxHeights_loc=t.getUniformLocation(s.program,"u_minMaxHeights"),s.colorType_loc=t.getUniformLocation(s.program,"colorType"),s.u_oneColor4_loc=t.getUniformLocation(s.program,"u_oneColor4"),s.u_terrainHeightEncodingBytes_loc=t.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_flipTexCoordY_loc=t.getUniformLocation(s.program,"u_flipTexCoordY"),s.u_totalMinGeoCoord_loc=t.getUniformLocation(s.program,"u_totalMinGeoCoord"),s.u_totalMaxGeoCoord_loc=t.getUniformLocation(s.program,"u_totalMaxGeoCoord"),s.u_currentMinGeoCoord_loc=t.getUniformLocation(s.program,"u_currentMinGeoCoord"),s.u_currentMaxGeoCoord_loc=t.getUniformLocation(s.program,"u_currentMaxGeoCoord"),e.postFxShadersManager.useProgram(s),o="waterOrthogonalDepthRender",n=Bo.WaterOrthogonalDepthShaderVS,a=(a=(a=Bo.WaterOrthogonalDepthShaderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=t.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=t.getUniformLocation(s.program,"u_color4"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainHeightEncodingBytes_loc=t.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_processType_loc=t.getUniformLocation(s.program,"u_processType"),s.currDEMTex_loc=t.getUniformLocation(s.program,"currDEMTex"),s.u_quantizedVolume_MinMax_loc=t.getUniformLocation(s.program,"u_quantizedVolume_MinMax"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.currDEMTex_loc,0),o="orthogonalVoxelizationRender_MRT",n=Bo.OrthogonalVoxelizationShaderVS_MRT,a=(a=(a=Bo.OrthogonalVoxelizationShaderFS_MRT).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=t.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=t.getUniformLocation(s.program,"u_color4"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainHeightEncodingBytes_loc=t.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_processType_loc=t.getUniformLocation(s.program,"u_processType"),s.currDEMTex_loc=t.getUniformLocation(s.program,"currDEMTex"),s.u_quantizedVolume_MinMax_loc=t.getUniformLocation(s.program,"u_quantizedVolume_MinMax"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.currDEMTex_loc,0),o="waterCopyTexture",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCopyFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).texToCopy_loc=t.getUniformLocation(s.program,"texToCopy"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.texToCopy_loc,0),o="voxelize",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterVoxelizeFromDepthTexFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).a_pos=t.getAttribLocation(s.program,"a_pos"),s.depthTex_loc=t.getUniformLocation(s.program,"depthTex"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_mosaicTexSize_loc=t.getUniformLocation(s.program,"u_mosaicTexSize"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_lowestMosaicSliceIndex_loc=t.getUniformLocation(s.program,"u_lowestMosaicSliceIndex"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_realTex3d_minMaxAltitudes_loc=t.getUniformLocation(s.program,"u_realTex3d_minMaxAltitudes"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.depthTex_loc,0),o="voxelizeFromPartialYDirectionTexture3D",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterVoxelizeFromPartialYDirectionTexture3DFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).a_pos=t.getAttribLocation(s.program,"a_pos"),s.currentSceneVoxelizedMosaicTex_loc=t.getUniformLocation(s.program,"currentSceneVoxelizedMosaicTex"),s.partialYDirectionMosaicTex_loc=t.getUniformLocation(s.program,"partialYDirectionMosaicTex"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_mosaicTexSize_loc=t.getUniformLocation(s.program,"u_mosaicTexSize"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_lowestMosaicSliceIndex_loc=t.getUniformLocation(s.program,"u_lowestMosaicSliceIndex"),s.u_lowestYDirMosaicSliceIndex_loc=t.getUniformLocation(s.program,"u_lowestYDirMosaicSliceIndex"),s.u_yDirMosaicSize_loc=t.getUniformLocation(s.program,"u_yDirMosaicSize"),s.u_yDirTextureSize_loc=t.getUniformLocation(s.program,"u_yDirTextureSize"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.currentSceneVoxelizedMosaicTex_loc,0),t.uniform1i(s.partialYDirectionMosaicTex_loc,1),o="voxelizeFromPartialXDirectionTexture3D",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterVoxelizeFromPartialXDirectionTexture3DFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).a_pos=t.getAttribLocation(s.program,"a_pos"),s.currentSceneVoxelizedMosaicTex_loc=t.getUniformLocation(s.program,"currentSceneVoxelizedMosaicTex"),s.partialXDirectionMosaicTex_loc=t.getUniformLocation(s.program,"partialXDirectionMosaicTex"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_mosaicTexSize_loc=t.getUniformLocation(s.program,"u_mosaicTexSize"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_lowestMosaicSliceIndex_loc=t.getUniformLocation(s.program,"u_lowestMosaicSliceIndex"),s.u_lowestXDirMosaicSliceIndex_loc=t.getUniformLocation(s.program,"u_lowestXDirMosaicSliceIndex"),s.u_xDirMosaicSize_loc=t.getUniformLocation(s.program,"u_xDirMosaicSize"),s.u_xDirTextureSize_loc=t.getUniformLocation(s.program,"u_xDirTextureSize"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.currentSceneVoxelizedMosaicTex_loc,0),t.uniform1i(s.partialXDirectionMosaicTex_loc,1),o="voxelizeFromPartialZDirectionTexture3D",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterVoxelizeFromPartialZDirectionTexture3DFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).a_pos=t.getAttribLocation(s.program,"a_pos"),s.currentSceneVoxelizedMosaicTex_loc=t.getUniformLocation(s.program,"currentSceneVoxelizedMosaicTex"),s.partialZDirectionMosaicTex_loc=t.getUniformLocation(s.program,"partialZDirectionMosaicTex"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_mosaicTexSize_loc=t.getUniformLocation(s.program,"u_mosaicTexSize"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_lowestMosaicSliceIndex_loc=t.getUniformLocation(s.program,"u_lowestMosaicSliceIndex"),s.u_lowestZDirMosaicSliceIndex_loc=t.getUniformLocation(s.program,"u_lowestZDirMosaicSliceIndex"),s.u_zDirMosaicSize_loc=t.getUniformLocation(s.program,"u_zDirMosaicSize"),s.u_zDirTextureSize_loc=t.getUniformLocation(s.program,"u_zDirTextureSize"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.currentSceneVoxelizedMosaicTex_loc,0),t.uniform1i(s.partialZDirectionMosaicTex_loc,1),o="renderOrthogonalToMagoTexture3D",n=Bo.WaterOrthogonalDepthShaderVS,a=(a=(a=Bo.WaterOrthogonalMagoTexture3DFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=t.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=t.getUniformLocation(s.program,"u_color4"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_lowestTex3DSliceIndex_loc=t.getUniformLocation(s.program,"u_lowestTex3DSliceIndex"),s.u_airMaxPressure_loc=t.getUniformLocation(s.program,"u_airMaxPressure"),s.u_currAirPressure_loc=t.getUniformLocation(s.program,"u_currAirPressure"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.currDEMTex_loc,0),o="copyTextureIntoMosaic",n=Bo.quadVertTexCoordVS,a=(a=(a=Bo.soundCopyFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.a_texcoord_loc=t.getAttribLocation(s.program,"a_texcoord"),s.texToCopy_loc=t.getUniformLocation(s.program,"texToCopy"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.texToCopy_loc,0),o="soundCalculateAirPressure",n=Bo.waterQuadVertVS,a=(a=(a=Bo.soundCalculatePressureFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).a_pos=t.getAttribLocation(s.program,"a_pos"),s.u_airMaxPressure_loc=t.getUniformLocation(s.program,"u_airMaxPressure"),s.u_airEnvirontmentPressure_loc=t.getUniformLocation(s.program,"u_airEnvirontmentPressure"),s.u_processType_loc=t.getUniformLocation(s.program,"u_processType"),s.u_airPressureAlternative_loc=t.getUniformLocation(s.program,"u_airPressureAlternative"),s.soundSourceTex_0_loc=t.getUniformLocation(s.program,"soundSourceTex_0"),s.soundSourceTex_1_loc=t.getUniformLocation(s.program,"soundSourceTex_1"),s.soundSourceTex_2_loc=t.getUniformLocation(s.program,"soundSourceTex_2"),s.soundSourceTex_3_loc=t.getUniformLocation(s.program,"soundSourceTex_3"),s.currAirPressureTex_0_loc=t.getUniformLocation(s.program,"currAirPressureTex_0"),s.currAirPressureTex_1_loc=t.getUniformLocation(s.program,"currAirPressureTex_1"),s.currAirPressureTex_2_loc=t.getUniformLocation(s.program,"currAirPressureTex_2"),s.currAirPressureTex_3_loc=t.getUniformLocation(s.program,"currAirPressureTex_3"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.soundSourceTex_0_loc,0),t.uniform1i(s.soundSourceTex_1_loc,1),t.uniform1i(s.soundSourceTex_2_loc,2),t.uniform1i(s.soundSourceTex_3_loc,3),t.uniform1i(s.currAirPressureTex_0_loc,4),t.uniform1i(s.currAirPressureTex_1_loc,5),t.uniform1i(s.currAirPressureTex_2_loc,6),t.uniform1i(s.currAirPressureTex_3_loc,7),o="copyTexturePartially",n=Bo.quadVertTexCoordVS,a=(a=(a=Bo.soundCopyPartiallyFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).texToCopy_0_loc=t.getUniformLocation(s.program,"texToCopy_0"),s.texToCopy_1_loc=t.getUniformLocation(s.program,"texToCopy_1"),s.texToCopy_2_loc=t.getUniformLocation(s.program,"texToCopy_2"),s.texToCopy_3_loc=t.getUniformLocation(s.program,"texToCopy_3"),s.texToCopy_4_loc=t.getUniformLocation(s.program,"texToCopy_4"),s.texToCopy_5_loc=t.getUniformLocation(s.program,"texToCopy_5"),s.texToCopy_6_loc=t.getUniformLocation(s.program,"texToCopy_6"),s.texToCopy_7_loc=t.getUniformLocation(s.program,"texToCopy_7"),s.a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.a_texcoord_loc=t.getAttribLocation(s.program,"a_texcoord"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.texToCopy_0_loc,0),t.uniform1i(s.texToCopy_1_loc,0),t.uniform1i(s.texToCopy_2_loc,1),t.uniform1i(s.texToCopy_3_loc,2),t.uniform1i(s.texToCopy_4_loc,3),t.uniform1i(s.texToCopy_5_loc,4),t.uniform1i(s.texToCopy_6_loc,5),t.uniform1i(s.texToCopy_7_loc,6),t.uniform1i(s.texToCopy_8_loc,7),o="soundCalculateFlux",n=Bo.waterQuadVertVS,a=(a=(a=Bo.soundCalculateFluxFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).airPressureMosaicTex_loc=t.getUniformLocation(s.program,"airPressureMosaicTex"),s.flux_RFU_MosaicTex_HIGH_loc=t.getUniformLocation(s.program,"flux_RFU_MosaicTex_HIGH"),s.flux_RFU_MosaicTex_LOW_loc=t.getUniformLocation(s.program,"flux_RFU_MosaicTex_LOW"),s.flux_LBD_MosaicTex_HIGH_loc=t.getUniformLocation(s.program,"flux_LBD_MosaicTex_HIGH"),s.flux_LBD_MosaicTex_LOW_loc=t.getUniformLocation(s.program,"flux_LBD_MosaicTex_LOW"),s.auxMosaicTex_loc=t.getUniformLocation(s.program,"auxMosaicTex"),s.a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.u_airMaxPressure_loc=t.getUniformLocation(s.program,"u_airMaxPressure"),s.u_airEnvirontmentPressure_loc=t.getUniformLocation(s.program,"u_airEnvirontmentPressure"),s.u_maxFlux_loc=t.getUniformLocation(s.program,"u_maxFlux"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_voxelSizeMeters_loc=t.getUniformLocation(s.program,"u_voxelSizeMeters"),s.u_timestep_loc=t.getUniformLocation(s.program,"u_timestep"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.airPressureMosaicTex_loc,0),t.uniform1i(s.flux_RFU_MosaicTex_HIGH_loc,1),t.uniform1i(s.flux_RFU_MosaicTex_LOW_loc,2),t.uniform1i(s.flux_LBD_MosaicTex_HIGH_loc,3),t.uniform1i(s.flux_LBD_MosaicTex_LOW_loc,4),t.uniform1i(s.auxMosaicTex_loc,5),o="soundCalculateVelocity",n=Bo.waterQuadVertVS,a=(a=(a=Bo.soundCalculateVelocityFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).airPressureMosaicTex_loc=t.getUniformLocation(s.program,"airPressureMosaicTex"),s.flux_RFU_MosaicTex_HIGH_loc=t.getUniformLocation(s.program,"flux_RFU_MosaicTex_HIGH"),s.flux_RFU_MosaicTex_LOW_loc=t.getUniformLocation(s.program,"flux_RFU_MosaicTex_LOW"),s.flux_LBD_MosaicTex_HIGH_loc=t.getUniformLocation(s.program,"flux_LBD_MosaicTex_HIGH"),s.flux_LBD_MosaicTex_LOW_loc=t.getUniformLocation(s.program,"flux_LBD_MosaicTex_LOW"),s.auxMosaicTex_loc=t.getUniformLocation(s.program,"auxMosaicTex"),s.maxPressureMosaicTex_loc=t.getUniformLocation(s.program,"maxPressureMosaicTex"),s.a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.u_airMaxPressure_loc=t.getUniformLocation(s.program,"u_airMaxPressure"),s.u_airEnvirontmentPressure_loc=t.getUniformLocation(s.program,"u_airEnvirontmentPressure"),s.u_maxFlux_loc=t.getUniformLocation(s.program,"u_maxFlux"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_voxelSizeMeters_loc=t.getUniformLocation(s.program,"u_voxelSizeMeters"),s.u_timestep_loc=t.getUniformLocation(s.program,"u_timestep"),s.u_maxVelocity_loc=t.getUniformLocation(s.program,"u_maxVelocity"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.airPressureMosaicTex_loc,0),t.uniform1i(s.flux_RFU_MosaicTex_HIGH_loc,1),t.uniform1i(s.flux_RFU_MosaicTex_LOW_loc,2),t.uniform1i(s.flux_LBD_MosaicTex_HIGH_loc,3),t.uniform1i(s.flux_LBD_MosaicTex_LOW_loc,4),t.uniform1i(s.auxMosaicTex_loc,5),t.uniform1i(s.maxPressureMosaicTex_loc,6),o="volumetricWaves",n=Bo.waterQuadVertVS,a=(a=(a=Bo.soundVolumetricFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).simulationBoxDoubleDepthTex_loc=t.getUniformLocation(s.program,"simulationBoxDoubleDepthTex"),s.simulationBoxDoubleNormalTex_loc=t.getUniformLocation(s.program,"simulationBoxDoubleNormalTex"),s.airPressureMosaicTex_loc=t.getUniformLocation(s.program,"airPressureMosaicTex"),s.sceneDepthTex_loc=t.getUniformLocation(s.program,"sceneDepthTex"),s.sceneNormalTex_loc=t.getUniformLocation(s.program,"sceneNormalTex"),s.airVelocityTex_loc=t.getUniformLocation(s.program,"airVelocityTex"),s.maxPressureMosaicTex_loc=t.getUniformLocation(s.program,"maxPressureMosaicTex"),s.a_pos_loc=t.getAttribLocation(s.program,"a_pos"),s.u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.uNearFarArray_loc=t.getUniformLocation(s.program,"uNearFarArray"),s.tangentOfHalfFovy_loc=t.getUniformLocation(s.program,"tangentOfHalfFovy"),s.aspectRatio_loc=t.getUniformLocation(s.program,"aspectRatio"),s.modelViewMatrixRelToEyeInv_loc=t.getUniformLocation(s.program,"modelViewMatrixRelToEyeInv"),s.u_texSize_loc=t.getUniformLocation(s.program,"u_texSize"),s.u_mosaicTexSize_loc=t.getUniformLocation(s.program,"u_mosaicTexSize"),s.u_mosaicSize_loc=t.getUniformLocation(s.program,"u_mosaicSize"),s.u_airMaxPressure_loc=t.getUniformLocation(s.program,"u_airMaxPressure"),s.u_airEnvirontmentPressure_loc=t.getUniformLocation(s.program,"u_airEnvirontmentPressure"),s.u_maxVelocity_loc=t.getUniformLocation(s.program,"u_maxVelocity"),s.u_voxelSizeMeters_loc=t.getUniformLocation(s.program,"u_voxelSizeMeters"),s.u_simulBoxTMat_loc=t.getUniformLocation(s.program,"u_simulBoxTMat"),s.u_simulBoxTMatInv_loc=t.getUniformLocation(s.program,"u_simulBoxTMatInv"),s.u_simulBoxPosHigh_loc=t.getUniformLocation(s.program,"u_simulBoxPosHigh"),s.u_simulBoxPosLow_loc=t.getUniformLocation(s.program,"u_simulBoxPosLow"),s.u_simulBoxMinPosLC_loc=t.getUniformLocation(s.program,"u_simulBoxMinPosLC"),s.u_simulBoxMaxPosLC_loc=t.getUniformLocation(s.program,"u_simulBoxMaxPosLC"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.simulationBoxDoubleDepthTex_loc,0),t.uniform1i(s.simulationBoxDoubleNormalTex_loc,1),t.uniform1i(s.airPressureMosaicTex_loc,2),t.uniform1i(s.sceneDepthTex_loc,3),t.uniform1i(s.sceneNormalTex_loc,4),t.uniform1i(s.airVelocityTex_loc,5),t.uniform1i(s.maxPressureMosaicTex_loc,6),e.postFxShadersManager.useProgram(null)},(Pi=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.voxelXSize=1024,this.voxelYSize=1024,this.voxelZSize=128,this.magoTexture3d,void 0!==t&&(void 0!==t.voxelXSize&&(this.voxelXSize=t.voxelXSize),void 0!==t.voxelYSize&&(this.voxelYSize=t.voxelYSize),void 0!==t.voxelZSize&&(this.voxelZSize=t.voxelZSize))}).prototype.makeMosaicTexture3DFromRealTexture3D=function(e,t,r){var i=e.getGl(),o=t.texture3DXSize,n=t.texture3DYSize,a=t.texture3DZSize;r||((v=Math.floor(16e3/o))*(x=Math.floor(16e3/n))>a&&(v=Math.ceil(Math.sqrt(a)),x=Math.ceil(a/v)),(r=new Do({texture3DXSize:o,texture3DYSize:n,texture3DZSize:a,mosaicXCount:v,mosaicYCount:x})).createTextures(i));var s=r.finalTextureXSize,l=r.finalTextureYSize;if(!this.fbo){var u=s,c=l,d=e.postFxShadersManager.bUseMultiRenderTarget;this.fbo=new ae(i,u,c,{matchCanvasSize:!1,multiRenderTarget:d,numColorBuffers:8})}var h,f=this.fbo,g=f.extbuffers;if(f.bind(),i.viewport(0,0,f.width[0],f.height[0]),g.drawBuffersWEBGL([g.COLOR_ATTACHMENT0_WEBGL,g.NONE,g.NONE,g.NONE,g.NONE,g.NONE,g.NONE,g.NONE]),h=e.postFxShadersManager.getShader("copyTextureIntoMosaic"),e.postFxShadersManager.useProgram(h),h.bindUniformGenerals(),i.uniform1i(h.u_textureFlipYAxis_loc,!1),!this.screenQuad){var p=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),m=ae.createBuffer(i,p);this.screenQuad={posBuffer:m}}ae.bindAttribute(i,this.screenQuad.posBuffer,h.a_pos,2),i.uniform1iv(h.u_texSize_loc,[r.texture3DXSize,r.texture3DYSize,r.texture3DZSize]),i.uniform1iv(h.u_mosaicTexSize_loc,[r.finalTextureXSize,r.finalTextureYSize,r.finalSlicesCount]),i.uniform1iv(h.u_mosaicSize_loc,[r.mosaicXCount,r.mosaicYCount,r.finalSlicesCount]),i.disable(i.DEPTH_TEST);for(var v,x,_=1/(v=r.mosaicXCount),y=1/(x=r.mosaicYCount),T=v*x,C=r.finalSlicesCount,b=0;b<C;b++){i.framebufferTexture2D(i.FRAMEBUFFER,g.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,r.getTexture(b),0);for(var M=0;M<v;M++)for(var A=0;A<x;A++){var E=M*_,L=A*y,w=E+_,S=L+y,D=(p=new Float32Array([E,L,w,L,E,S,E,S,w,L,w,S]),new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1])),R=(m=ae.createBuffer(i,p),ae.createBuffer(i,D));ae.bindAttribute(i,m,h.a_pos_loc,2),ae.bindAttribute(i,R,h.a_texcoord_loc,2);var P=T*b+A*v+M,I=t.getTexture(P);i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,I),i.drawArrays(i.TRIANGLES,0,6)}}return f.unbind(),i.enable(i.DEPTH_TEST),this.fbo.deleteObjects(i),this.fbo=void 0,r},Pi.prototype.renderToMagoTexture3D=function(e,t,r,i,o){var n=e.magoManager,a=n.getGl();if(!this.fboRealTex3d){var s=t.finalTextureXSize,l=t.finalTextureYSize,u=n.postFxShadersManager.bUseMultiRenderTarget;this.fboRealTex3d=new ae(a,s,l,{matchCanvasSize:!1,multiRenderTarget:u,numColorBuffers:8})}var c,d=this.fboRealTex3d,h=d.extbuffers;d.bind(),a.viewport(0,0,d.width[0],d.height[0]),h.drawBuffersWEBGL([h.COLOR_ATTACHMENT0_WEBGL,h.COLOR_ATTACHMENT1_WEBGL,h.COLOR_ATTACHMENT2_WEBGL,h.COLOR_ATTACHMENT3_WEBGL,h.COLOR_ATTACHMENT4_WEBGL,h.COLOR_ATTACHMENT5_WEBGL,h.COLOR_ATTACHMENT6_WEBGL,h.COLOR_ATTACHMENT7_WEBGL]),c=n.postFxShadersManager.getShader("renderOrthogonalToMagoTexture3D"),n.postFxShadersManager.useProgram(c),c.bindUniformGenerals(),a.uniformMatrix4fv(c.u_modelViewProjectionMatrix_loc,!1,i._floatArrays),a.uniform3fv(c.aditionalMov_loc,[0,0,0]),a.uniform4fv(c.u_color4_loc,[1,0,0,1]),a.uniform1iv(c.u_texSize_loc,[t.texture3DXSize,t.texture3DYSize,t.texture3DZSize]),a.uniform1f(c.u_airMaxPressure_loc,e.airMaxPressure);a.uniform1f(c.u_currAirPressure_loc,4),a.disable(a.CULL_FACE),a.disable(a.DEPTH_TEST),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),a.frontFace(a.CCW);for(var f=t.finalSlicesCount,g=Math.ceil(f/8),p=0;p<g;p++){c=n.postFxShadersManager.getShader("renderOrthogonalToMagoTexture3D"),n.postFxShadersManager.useProgram(c),a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,t.getTexture(8*p+0),0),a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,t.getTexture(8*p+1),0),a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,t.getTexture(8*p+2),0),a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,t.getTexture(8*p+3),0),a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT4_WEBGL,a.TEXTURE_2D,t.getTexture(8*p+4),0),a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT5_WEBGL,a.TEXTURE_2D,t.getTexture(8*p+5),0),a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT6_WEBGL,a.TEXTURE_2D,t.getTexture(8*p+6),0),a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT7_WEBGL,a.TEXTURE_2D,t.getTexture(8*p+7),0),a.uniform1i(c.u_lowestTex3DSliceIndex_loc,8*p);for(var m=o.length,v=0;v<m;v++){var x=o[v];if(x instanceof pe)x.renderPoint(n,c,a);else if(x instanceof Tr){for(var _=0;!(x.isPrepared(n)||(_+=1)>10););x.renderableCurve||(x._makeRenderableCurve(n),n.modeler.addObject(x.renderableCurve));x.renderThicknessOne(n,c,0,!0)}}}for(p=0;p<8;p++)a.framebufferTexture2D(a.FRAMEBUFFER,h.COLOR_ATTACHMENT0_WEBGL+p,a.TEXTURE_2D,null,0);d.unbind(),a.enable(a.DEPTH_TEST),a.enable(a.CULL_FACE),this.fboRealTex3d.deleteObjects(a),this.fboRealTex3d=void 0},Pi.getMosaicColumnsAndRows=function(e,t,r){var i=Math.floor(16e3/e),o=Math.floor(16e3/t);return i*o>r&&(i=Math.ceil(Math.sqrt(r)),o=Math.ceil(r/i)),{numColumns:i,numRows:o}},Pi.prototype.voxelizeByDepthTexture=function(e,t,r,i,o,n,a){var s=e.getGl();if(!a){var l=Pi.getMosaicColumnsAndRows(r,i,o),u=l.numColumns,c=l.numRows;(a=new Do({texture3DXSize:r,texture3DYSize:i,texture3DZSize:o,mosaicXCount:u,mosaicYCount:c})).createTextures(s)}var d=a.finalTextureXSize,h=a.finalTextureYSize;if(!this.fbo){var f=d,g=h,p=e.postFxShadersManager.bUseMultiRenderTarget;this.fbo=new ae(s,f,g,{matchCanvasSize:!1,multiRenderTarget:p,numColorBuffers:8})}var m,v=n.geographicExtent,x=v.getMinAltitude(),_=v.getMaxAltitude(),y=this.fbo,T=y.extbuffers;if(y.bind(),s.viewport(0,0,y.width[0],y.height[0]),T.drawBuffersWEBGL([T.COLOR_ATTACHMENT0_WEBGL,T.COLOR_ATTACHMENT1_WEBGL,T.COLOR_ATTACHMENT2_WEBGL,T.COLOR_ATTACHMENT3_WEBGL,T.COLOR_ATTACHMENT4_WEBGL,T.COLOR_ATTACHMENT5_WEBGL,T.COLOR_ATTACHMENT6_WEBGL,T.COLOR_ATTACHMENT7_WEBGL]),m=e.postFxShadersManager.getShader("voxelize"),e.postFxShadersManager.useProgram(m),m.bindUniformGenerals(),s.uniform1i(m.u_textureFlipYAxis_loc,!1),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,t.texId),!this.screenQuad){var C=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),b=ae.createBuffer(s,C);this.screenQuad={posBuffer:b}}ae.bindAttribute(s,this.screenQuad.posBuffer,m.a_pos,2),s.uniform1iv(m.u_texSize_loc,[a.texture3DXSize,a.texture3DYSize,a.texture3DZSize]),s.uniform1iv(m.u_mosaicTexSize_loc,[a.finalTextureXSize,a.finalTextureYSize,a.finalSlicesCount]),s.uniform1iv(m.u_mosaicSize_loc,[a.mosaicXCount,a.mosaicYCount,a.finalSlicesCount]),s.uniform2fv(m.u_heightMap_MinMax_loc,[x,_]),s.disable(s.DEPTH_TEST);for(var M=a.finalSlicesCount,A=Math.ceil(M/8),E=0;E<A;E++)s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT0_WEBGL,s.TEXTURE_2D,a.getTexture(8*E+0),0),s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT1_WEBGL,s.TEXTURE_2D,a.getTexture(8*E+1),0),s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT2_WEBGL,s.TEXTURE_2D,a.getTexture(8*E+2),0),s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT3_WEBGL,s.TEXTURE_2D,a.getTexture(8*E+3),0),s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT4_WEBGL,s.TEXTURE_2D,a.getTexture(8*E+4),0),s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT5_WEBGL,s.TEXTURE_2D,a.getTexture(8*E+5),0),s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT6_WEBGL,s.TEXTURE_2D,a.getTexture(8*E+6),0),s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT7_WEBGL,s.TEXTURE_2D,a.getTexture(8*E+7),0),s.uniform1i(m.u_lowestMosaicSliceIndex_loc,8*E),s.uniform2fv(m.u_realTex3d_minMaxAltitudes_loc,[x,_]),s.drawArrays(s.TRIANGLES,0,6);for(E=0;E<8;E++)s.framebufferTexture2D(s.FRAMEBUFFER,T.COLOR_ATTACHMENT0_WEBGL+E,s.TEXTURE_2D,null,0);return y.unbind(),s.enable(s.DEPTH_TEST),this.fbo.deleteObjects(s),this.fbo=void 0,a};var Io=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.attribLocationEnabled=!1},Fo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl=t,this.name,this.map_name_location={},this.attribLocationCacheObj={},this.uniformsArrayGeneral=[],this.uniformsMapGeneral={},this.uniformsArrayLocal=[],this.uniformsMapLocal={},this.camera,this.program,this.shader_vertex,this.shader_fragment,this.last_tex_id,this.last_isAditionalMovedZero=!1,this.lastVboKeyBindedMap={},this.attribLocationStateArray=[],this.shaderManager};Fo.prototype.getName=function(){return this.name},Fo.createShader=function(e,t,r){var i=e.createShader(t);if(e.shaderSource(i,r),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(i));return i},Fo.createProgram=function(e,t,r){var i=e.createProgram(),o=Fo.createShader(e,e.VERTEX_SHADER,t),n=Fo.createShader(e,e.FRAGMENT_SHADER,r);if(e.attachShader(i,o),e.attachShader(i,n),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(i));for(var a={program:i},s=e.getProgramParameter(i,e.ACTIVE_ATTRIBUTES),l=0;l<s;l++){var u=e.getActiveAttrib(i,l);a[u.name]=e.getAttribLocation(i,u.name)}var c=e.getProgramParameter(i,e.ACTIVE_UNIFORMS);for(l=0;l<c;l++){var d=e.getActiveUniform(i,l);a[d.name]=e.getUniformLocation(i,d.name)}return map_name_locationper},Fo.prototype.resetLastBuffersBinded=function(){if(this.last_tex_id=void 0,this.last_isAditionalMovedZero=!1,this.lastVboKeyBindedMap={},this.disableVertexAttribArrayAll(),this.attribLocationStateArray){for(var e=this.attribLocationStateArray.length,t=0;t<e;t++){var r=this.attribLocationStateArray[t];void 0!==r&&(r.attribLocationEnabled=void 0,this.attribLocationStateArray[t]=void 0)}this.attribLocationStateArray.length=0}},Fo.prototype.enableVertexAttribArray=function(e){if(void 0===e||e<0)return!1;var t=this.attribLocationStateArray[e];return void 0===t&&(t=new Io,this.attribLocationStateArray[e]=t,t.attribLocationEnabled=!1),t.attribLocationEnabled||(this.gl.enableVertexAttribArray(e),t.attribLocationEnabled=!0),!0},Fo.prototype.disableTextureImagesUnitsAll=function(){for(var e=this.gl,t=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),r=0;r<t;r++)e.activeTexture(e.TEXTURE0+r),e.bindTexture(e.TEXTURE_2D,null)},Fo.prototype.disableVertexAttribArrayAll=function(){for(var e=this.gl,t=e.getParameter(e.MAX_VERTEX_ATTRIBS),r=0;r<t;r++)e.disableVertexAttribArray(r)},Fo.prototype.disableVertexAttribArray=function(e){if(!(void 0===e||e<0)){var t=this.attribLocationStateArray[e];void 0===t&&(t=new Io,this.attribLocationStateArray[e]=t,t.attribLocationEnabled=!0),t.attribLocationEnabled&&(this.gl.disableVertexAttribArray(e),t.attribLocationEnabled=!1)}},Fo.prototype.useProgram=function(){var e=this.gl;e.getParameter(e.CURRENT_PROGRAM)!==this.program&&(e.useProgram(this.program),this.shaderManager.currentShaderUsing=this),this.resetLastBuffersBinded()},Fo.prototype.bindUniformGenerals=function(){if(void 0!==this.uniformsArrayGeneral){for(var e=this.uniformsArrayGeneral.length,t=0;t<e;t++)this.uniformsArrayGeneral[t].bindUniform();this.camera&&this.camera.bindUniforms(this.gl,this)}},Fo.prototype.getUniformDataPair=function(e){return this.uniformsMapGeneral[e]},Fo.prototype.newUniformDataPair=function(e,t){var r;return"Matrix4fv"===e?(r=new Go(this.gl,t),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[t]=r):"Vec4fv"===e?(r=new Vo(this.gl,t),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[t]=r):"Vec3fv"===e?(r=new Ho(this.gl,t),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[t]=r):"Vec2fv"===e?(r=new zo(this.gl,t),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[t]=r):"1f"===e?(r=new No(this.gl,t),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[t]=r):"1i"===e&&(r=new Uo(this.gl,t),this.uniformsArrayGeneral.push(r),this.uniformsMapGeneral[t]=r),r},Fo.prototype.newUniformDataPairLocal=function(e,t){var r;return"Matrix4fv"===e?(r=new Go(this.gl,t),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[t]=r):"Vec4fv"===e?(r=new Vo(this.gl,t),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[t]=r):"Vec3fv"===e?(r=new Ho(this.gl,t),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[t]=r):"Vec2fv"===e?(r=new zo(this.gl,t),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[t]=r):"1f"===e?(r=new No(this.gl,t),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[t]=r):"1i"===e&&(r=new Uo(this.gl,t),this.uniformsArrayLocal.push(r),this.uniformsMapLocal[t]=r),r},Fo.prototype.createUniformGenerals=function(e,t,r){var i,o;if(null!==(o=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"))&&void 0!==o&&((i=t.newUniformDataPair("Matrix4fv","mvpMat4RelToEye")).uniformLocation=o,i.matrix4fv=r.modelViewProjRelToEyeMatrix._floatArrays),null!==(o=e.getUniformLocation(t.program,"ModelViewProjectionMatrix"))&&void 0!==o&&((i=t.newUniformDataPair("Matrix4fv","mvpMat4")).uniformLocation=o,i.matrix4fv=r.modelViewProjMatrix._floatArrays),null!==(o=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"))&&void 0!==o&&((i=t.newUniformDataPair("Matrix4fv","mvMat4RelToEye")).uniformLocation=o,i.matrix4fv=r.modelViewRelToEyeMatrix._floatArrays),null!==(o=e.getUniformLocation(t.program,"modelViewMatrix"))&&void 0!==o&&((i=t.newUniformDataPair("Matrix4fv","modelViewMatrix")).uniformLocation=o,i.matrix4fv=r.modelViewMatrix._floatArrays),null!==(o=e.getUniformLocation(t.program,"modelViewMatrixInv"))&&void 0!==o){(i=t.newUniformDataPair("Matrix4fv","modelViewMatrixInv")).uniformLocation=o;var n=r.getModelViewMatrixInv();i.matrix4fv=n._floatArrays}null!==(o=e.getUniformLocation(t.program,"projectionMatrix"))&&void 0!==o&&((i=t.newUniformDataPair("Matrix4fv","pMat4")).uniformLocation=o,i.matrix4fv=r.projectionMatrix._floatArrays),null!==(o=e.getUniformLocation(t.program,"normalMatrix4"))&&void 0!==o&&((i=t.newUniformDataPair("Matrix4fv","normalMat4")).uniformLocation=o,i.matrix4fv=r.normalMatrix4._floatArrays),null!==(o=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"))&&void 0!==o&&((i=t.newUniformDataPair("Vec3fv","encodedCamPosHigh")).uniformLocation=o,i.vec3fv=r.encodedCamPosHigh),null!==(o=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"))&&void 0!==o&&((i=t.newUniformDataPair("Vec3fv","encodedCamPosLow")).uniformLocation=o,i.vec3fv=r.encodedCamPosLow),null!==(o=e.getUniformLocation(t.program,"fov"))&&void 0!==o&&((i=t.newUniformDataPair("1f","fovyRad")).uniformLocation=o,i.floatValue=r.camera.frustum.fovyRad),null!==(o=e.getUniformLocation(t.program,"tangentOfHalfFovy"))&&void 0!==o&&((i=t.newUniformDataPair("1f","tangentOfHalfFovy")).uniformLocation=o,i.floatValue=r.camera.frustum.tangentOfHalfFovy),null!==(o=e.getUniformLocation(t.program,"aspectRatio"))&&void 0!==o&&((i=t.newUniformDataPair("1f","aspectRatio")).uniformLocation=o,i.floatValue=r.camera.frustum.aspectRatio),null!==(o=e.getUniformLocation(t.program,"screenWidth"))&&void 0!==o&&((i=t.newUniformDataPair("1f","drawBuffWidht")).uniformLocation=o,i.floatValue=r.drawingBufferWidth),null!==(o=e.getUniformLocation(t.program,"screenHeight"))&&void 0!==o&&((i=t.newUniformDataPair("1f","drawBuffHeight")).uniformLocation=o,i.floatValue=r.drawingBufferHeight),null!==(o=e.getUniformLocation(t.program,"depthTex"))&&void 0!==o&&((i=t.newUniformDataPair("1i","depthTex")).uniformLocation=o,i.intValue=0),null!==(o=e.getUniformLocation(t.program,"noiseTex"))&&void 0!==o&&((i=t.newUniformDataPair("1i","noiseTex")).uniformLocation=o,i.intValue=1),null!==(o=e.getUniformLocation(t.program,"diffuseTex"))&&void 0!==o&&((i=t.newUniformDataPair("1i","diffuseTex")).uniformLocation=o,i.intValue=2),null!==(o=e.getUniformLocation(t.program,"shadowMapTex"))&&void 0!==o&&((i=t.newUniformDataPair("1i","shadowMapTex")).uniformLocation=o,i.intValue=3),null!==(o=e.getUniformLocation(t.program,"shadowMapTex2"))&&void 0!==o&&((i=t.newUniformDataPair("1i","shadowMapTex2")).uniformLocation=o,i.intValue=4),null!==(o=e.getUniformLocation(t.program,"ssaoFromDepthTex"))&&void 0!==o&&((i=t.newUniformDataPair("1i","ssaoFromDepthTex")).uniformLocation=o,i.intValue=5),null!==(o=e.getUniformLocation(t.program,"specularColor"))&&void 0!==o&&((i=t.newUniformDataPair("Vec3fv","specularColor")).uniformLocation=o,i.vec3fv=r.specularColor),null!==(o=e.getUniformLocation(t.program,"ambientColor"))&&void 0!==o&&((i=t.newUniformDataPair("Vec3fv","ambientColor")).uniformLocation=o,i.vec3fv=r.ambientColor),null!==(o=e.getUniformLocation(t.program,"radius"))&&void 0!==o&&((i=t.newUniformDataPair("1f","radius")).uniformLocation=o,i.floatValue=r.ssaoRadius),null!==(o=e.getUniformLocation(t.program,"ambientReflectionCoef"))&&void 0!==o&&((i=t.newUniformDataPair("1f","ambientReflectionCoef")).uniformLocation=o,i.floatValue=r.ambientReflectionCoef),null!==(o=e.getUniformLocation(t.program,"diffuseReflectionCoef"))&&void 0!==o&&((i=t.newUniformDataPair("1f","diffuseReflectionCoef")).uniformLocation=o,i.floatValue=r.diffuseReflectionCoef),null!==(o=e.getUniformLocation(t.program,"specularReflectionCoef"))&&void 0!==o&&((i=t.newUniformDataPair("1f","specularReflectionCoef")).uniformLocation=o,i.floatValue=r.specularReflectionCoef),null!==(o=e.getUniformLocation(t.program,"shininessValue"))&&void 0!==o&&((i=t.newUniformDataPair("1f","shininessValue")).uniformLocation=o,i.floatValue=r.shininessValue),null!==(o=e.getUniformLocation(t.program,"noiseScale"))&&void 0!==o&&((i=t.newUniformDataPair("Vec2fv","ssaoNoiseScale2")).uniformLocation=o,i.vec2fv=r.ssaoNoiseScale2),null!==(o=e.getUniformLocation(t.program,"kernel"))&&void 0!==o&&((i=t.newUniformDataPair("Vec3fv","ssaoKernel16")).uniformLocation=o,i.vec3fv=r.ssaoKernel16),this.camera=r.camera},Fo.prototype.getAttribLocation=function(e){return this._attribLocMap?this._attribLocMap[e]:-1},Fo.prototype.bindAttribLocations=function(e,t){e.bindAttribLocation(t.program,0,"position"),e.bindAttribLocation(t.program,1,"normal"),e.bindAttribLocation(t.program,2,"texCoord"),e.bindAttribLocation(t.program,3,"color4")},Fo.prototype.createUniformLocals=function(e,t,r){t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.sunMatrix_loc=e.getUniformLocation(t.program,"sunMatrix"),t.refMatrixType_loc=e.getUniformLocation(t.program,"refMatrixType"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.refTranslationVec_loc=e.getUniformLocation(t.program,"refTranslationVec"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.hasTexture_loc=e.getUniformLocation(t.program,"hasTexture"),t.textureFlipYAxis_loc=e.getUniformLocation(t.program,"textureFlipYAxis"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.sunPosHigh_loc=e.getUniformLocation(t.program,"sunPosHIGH"),t.sunPosLow_loc=e.getUniformLocation(t.program,"sunPosLOW"),t.shadowMapWidth_loc=e.getUniformLocation(t.program,"shadowMapWidth"),t.shadowMapHeight_loc=e.getUniformLocation(t.program,"shadowMapHeight"),t.sunDirWC_loc=e.getUniformLocation(t.program,"sunDirWC"),t.sunDirCC_loc=e.getUniformLocation(t.program,"sunDirCC"),t.sunIdx_loc=e.getUniformLocation(t.program,"sunIdx"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.texCoord2_loc=e.getAttribLocation(t.program,"texCoord"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.color4_loc=e.getAttribLocation(t.program,"color4"),t.bUse1Color_loc=e.getUniformLocation(t.program,"bUse1Color"),t.oneColor4_loc=e.getUniformLocation(t.program,"oneColor4"),t.bApplySsao_loc=e.getUniformLocation(t.program,"bApplySsao"),t.bApplyMagoShadow_loc=e.getUniformLocation(t.program,"bApplyMagoShadow"),t.bApplyShadow_loc=e.getUniformLocation(t.program,"bApplyShadow"),t.bSilhouette_loc=e.getUniformLocation(t.program,"bSilhouette"),t.bFxaa_loc=e.getUniformLocation(t.program,"bFxaa"),t.bScreenCopy_loc=e.getUniformLocation(t.program,"bScreenCopy"),t.bApplyClippingPlanes_loc=e.getUniformLocation(t.program,"bApplyClippingPlanes"),t.clippingPlanesCount_loc=e.getUniformLocation(t.program,"clippingPlanesCount"),t.clippingPlanes_loc=e.getUniformLocation(t.program,"clippingPlanes"),t.posDataByteSize_loc=e.getUniformLocation(t.program,"posDataByteSize"),t.texCoordByteSize_loc=e.getUniformLocation(t.program,"texCoordByteSize"),t.compressionMaxPoint_loc=e.getUniformLocation(t.program,"compressionMaxPoint"),t.compressionMinPoint_loc=e.getUniformLocation(t.program,"compressionMinPoint"),t.bApplySpecularLighting_loc=e.getUniformLocation(t.program,"bApplySpecularLighting"),t.colorType_loc=e.getUniformLocation(t.program,"colorType"),t.externalAlpha_loc=e.getUniformLocation(t.program,"externalAlpha"),t.fixPointSize_loc=e.getUniformLocation(t.program,"fixPointSize"),t.bUseFixPointSize_loc=e.getUniformLocation(t.program,"bUseFixPointSize"),t.frustumNear_loc=e.getUniformLocation(t.program,"near"),t.frustumFar_loc=e.getUniformLocation(t.program,"far"),t.bHasTexture_loc=e.getUniformLocation(t.program,"bHasTexture"),t.diffuseTex_loc=e.getUniformLocation(t.program,"diffuseTex"),t.scaleLC_loc=e.getUniformLocation(t.program,"scaleLC"),t.colorMultiplier_loc=e.getUniformLocation(t.program,"colorMultiplier"),t.modelViewProjectionMatrixInv_loc=e.getUniformLocation(t.program,"modelViewProjectionMatrixInv"),t.projectionMatrixInv_loc=e.getUniformLocation(t.program,"projectionMatrixInv"),t.modelViewMatrixRelToEyeInv_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEyeInv"),t.uRenderType_loc=e.getUniformLocation(t.program,"uRenderType"),t.uTime_loc=e.getUniformLocation(t.program,"uTime"),t.clippingPolygon2dPoints_loc=e.getUniformLocation(t.program,"clippingPolygon2dPoints"),t.clippingConvexPolygon2dPointsIndices_loc=e.getUniformLocation(t.program,"clippingConvexPolygon2dPointsIndices"),t.clippingType_loc=e.getUniformLocation(t.program,"clippingType"),t.limitationInfringedColor4_loc=e.getUniformLocation(t.program,"limitationInfringedColor4"),t.limitationHeights_loc=e.getUniformLocation(t.program,"limitationHeights")};var Oo=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.magoManager=t,this.gl,this.pFx_shaders_array=[],this.shadersMap={},this.modelRefShader,this.modelRefSilhouetteShader,this.lodBuildingShader,this.currentShaderUsing=void 0,this.bUseLogarithmicDepth=!1,this.bUseMultiRenderTarget=!1,r&&r.useLogarithmicDepth&&(this.bUseLogarithmicDepth=r.useLogarithmicDepth)};Oo.prototype.getUseLogarithmicDepth=function(){return this.bUseLogarithmicDepth},Oo.prototype.newShader=function(e){var t=new Fo(this.gl);return t.name=e,t.shaderManager=this,this.shadersMap[e]=t,t},Oo.prototype.getCurrentShader=function(){return this.currentShaderUsing},Oo.prototype.isCurrentShader=function(e){return this.currentShaderUsing===e},Oo.prototype.useProgram=function(e){void 0===e||null===e?(this.gl.useProgram(null),this.currentShaderUsing=null):this.isCurrentShader(e)||(e.useProgram(),this.currentShaderUsing=e)},Oo.prototype._get_useMultiRenderTarget_string=function(){return this.bUseMultiRenderTarget?"USE_MULTI_RENDER_TARGET":"NO_USE_MULTI_RENDER_TARGET"},Oo.prototype._get_useLinearOrLogarithmicDepth_string=function(){return this.bUseLogarithmicDepth?"USE_LOGARITHMIC_DEPTH":"USE_LINEAR_DEPTH"},Oo.prototype._createShader_gBuffer=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.GBufferVS,o=Bo.GBufferFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"gBuffer",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),n._attribLocMap={POSITION3:r.getAttribLocation(n.program,"position"),NORMAL3:r.getAttribLocation(n.program,"normal"),COLOR4:r.getAttribLocation(n.program,"color4"),TEXCOORD2:r.getAttribLocation(n.program,"texCoord")},this.shadersMap.gBuffer=n,n},Oo.prototype._createShader_gBufferORT=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this.gl,r=Bo.GBufferVS,i=Bo.GBufferORTFS;i=i.replace(/%USE_LOGARITHMIC_DEPTH%/g,e);var o=this.createShaderProgram(t,r,i,"gBufferORT",this.magoManager);return o.bUseLogarithmicDepth_loc=t.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=t.getUniformLocation(o.program,"uFCoef_logDepth"),o.uFrustumIdx_loc=t.getUniformLocation(o.program,"uFrustumIdx"),o.bUseMultiRenderTarget_loc=t.getUniformLocation(o.program,"bUseMultiRenderTarget"),o.uSelColor4_loc=t.getUniformLocation(o.program,"uSelColor4"),o.u_outputTarget_loc=t.getUniformLocation(o.program,"u_outputTarget"),this.shadersMap.gBufferORT=o,o},Oo.prototype._createShader_lBuffer=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.LBufferVS,o=Bo.LBufferFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"lBuffer",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.bApplyShadows_loc=r.getUniformLocation(n.program,"bApplyShadows"),n.lightDirWC_loc=r.getUniformLocation(n.program,"lightDirWC"),n.uNearFarArray_loc=r.getUniformLocation(n.program,"uNearFarArray"),n.uLightColorAndBrightness_loc=r.getUniformLocation(n.program,"uLightColorAndBrightness"),n.ModelViewProjectionMatrixRelToEye_loc=r.getUniformLocation(n.program,"ModelViewProjectionMatrixRelToEye"),n.buildingRotMatrixInv_loc=r.getUniformLocation(n.program,"buildingRotMatrixInv"),n.u_processType_loc=r.getUniformLocation(n.program,"u_processType"),n.uLightParameters_loc=r.getUniformLocation(n.program,"uLightParameters"),n.uLightIntensity_loc=r.getUniformLocation(n.program,"uLightIntensity"),n.normalTex_loc=r.getUniformLocation(n.program,"normalTex"),n.light_depthCubeMap_loc=r.getUniformLocation(n.program,"light_depthCubeMap"),this.useProgram(n),r.uniform1i(n.normalTex_loc,1),r.uniform1i(n.light_depthCubeMap_loc,2),this.shadersMap.lBuffer=n,n},Oo.prototype._createShader_screenQuad=function(){this._get_useLinearOrLogarithmicDepth_string();var e=this._get_useMultiRenderTarget_string(),t=this.gl,r=Bo.ScreenQuadVS,i=Bo.ScreenQuadFS;i=i.replace(/%USE_MULTI_RENDER_TARGET%/g,e);var o=this.createShaderProgram(t,r,i,"screenQuad",this.magoManager);return o.ssaoTex_loc=t.getUniformLocation(o.program,"ssaoTex"),o.normalTex_loc=t.getUniformLocation(o.program,"normalTex"),o.albedoTex_loc=t.getUniformLocation(o.program,"albedoTex"),o.silhouetteDepthTex_loc=t.getUniformLocation(o.program,"silhouetteDepthTex"),o.diffuseLightTex_loc=t.getUniformLocation(o.program,"diffuseLightTex"),o.specularLightTex_loc=t.getUniformLocation(o.program,"specularLightTex"),o.uBrightnessContrastSaturation_loc=t.getUniformLocation(o.program,"uBrightnessContrastSaturation"),o.uBrightnessContrastType_loc=t.getUniformLocation(o.program,"uBrightnessContrastType"),o.ussaoTexSize_loc=t.getUniformLocation(o.program,"ussaoTexSize"),this.useProgram(o),t.uniform1i(o.ssaoTex_loc,5),t.uniform1i(o.normalTex_loc,1),t.uniform1i(o.albedoTex_loc,2),t.uniform1i(o.diffuseLightTex_loc,6),t.uniform1i(o.specularLightTex_loc,7),t.uniform1i(o.silhouetteDepthTex_loc,8),o.uNearFarArray_loc=t.getUniformLocation(o.program,"uNearFarArray"),o.bUseLogarithmicDepth_loc=t.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=t.getUniformLocation(o.program,"uFCoef_logDepth"),o.uSceneDayNightLightingFactor_loc=t.getUniformLocation(o.program,"uSceneDayNightLightingFactor"),o.uAmbientLight_loc=t.getUniformLocation(o.program,"uAmbientLight"),this.shadersMap.screenQuad=o,o},Oo.prototype._createShader_screenCopyQuad=function(){this._get_useLinearOrLogarithmicDepth_string();var e=this._get_useMultiRenderTarget_string(),t=this.gl,r=Bo.ScreenQuadVS,i=Bo.ScreenCopyQuadFS;i=(i=i.replace(/%USE_GL_EXT_FRAGDEPTH%/g,"USE_GL_EXT_FRAGDEPTH")).replace(/%USE_MULTI_RENDER_TARGET%/g,e);var o=this.createShaderProgram(t,r,i,"screenCopyQuad",this.magoManager);return o.albedoTex_loc=t.getUniformLocation(o.program,"albedoTex"),o.u_textureTypeToCopy_loc=t.getUniformLocation(o.program,"u_textureTypeToCopy"),this.useProgram(o),t.uniform1i(o.normalTex_loc,1),t.uniform1i(o.albedoTex_loc,2),o.uNearFarArray_loc=t.getUniformLocation(o.program,"uNearFarArray"),o.bUseLogarithmicDepth_loc=t.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=t.getUniformLocation(o.program,"uFCoef_logDepth"),o.uFrustumIdx_loc=t.getUniformLocation(o.program,"uFrustumIdx"),this.shadersMap.screenCopyQuad=o,o},Oo.prototype._createShader_screenQuad2=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.ScreenQuadVS,r=Bo.ScreenQuad2FS,i=this.createShaderProgram(e,t,r,"screenQuad2",this.magoManager);return i.depthTex_loc=e.getUniformLocation(i.program,"depthTex"),i.normalTex_loc=e.getUniformLocation(i.program,"normalTex"),i.lightFogTex_loc=e.getUniformLocation(i.program,"lightFogTex"),i.shadedColorTex_loc=e.getUniformLocation(i.program,"shadedColorTex"),i.brightColorTex_loc=e.getUniformLocation(i.program,"brightColorTex"),i.screenSpaceObjectsTex_loc=e.getUniformLocation(i.program,"screenSpaceObjectsTex"),i.volumetricTex_loc=e.getUniformLocation(i.program,"volumetricTex"),i.uAmbientLight_loc=e.getUniformLocation(i.program,"uAmbientLight"),this.useProgram(i),e.uniform1i(i.depthTex_loc,0),e.uniform1i(i.normalTex_loc,1),e.uniform1i(i.lightFogTex_loc,2),e.uniform1i(i.screenSpaceObjectsTex_loc,3),e.uniform1i(i.shadedColorTex_loc,4),e.uniform1i(i.brightColorTex_loc,5),e.uniform1i(i.volumetricTex_loc,6),i.uNearFarArray_loc=e.getUniformLocation(i.program,"uNearFarArray"),i.bUseLogarithmicDepth_loc=e.getUniformLocation(i.program,"bUseLogarithmicDepth"),i.uFCoef_logDepth_loc=e.getUniformLocation(i.program,"uFCoef_logDepth"),i.uSceneDayNightLightingFactor_loc=e.getUniformLocation(i.program,"uSceneDayNightLightingFactor"),i.u_activeTex_loc=e.getUniformLocation(i.program,"u_activeTex"),this.shadersMap.screenQuad2=i,i},Oo.prototype._createShader_gaussianBlur=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.ScreenQuadVS,r=Bo.ScreenQuadGaussianBlurFS,i=this.createShaderProgram(e,t,r,"gaussianBlur",this.magoManager);return i.u_bHorizontal_loc=e.getUniformLocation(i.program,"u_bHorizontal"),i.screenWidth_loc=e.getUniformLocation(i.program,"screenWidth"),i.screenHeight_loc=e.getUniformLocation(i.program,"screenHeight"),i.uImageSize_loc=e.getUniformLocation(i.program,"uImageSize"),i.imageTex_loc=e.getUniformLocation(i.program,"image"),this.useProgram(i),e.uniform1i(i.imageTex_loc,0),this.shadersMap.gaussianBlur=i,i},Oo.prototype._createShader_screenQuadBlur=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.ScreenQuadVS,r=Bo.ScreenQuadBlurFS,i=this.createShaderProgram(e,t,r,"screenQuadBlur",this.magoManager);return i.u_bHorizontal_loc=e.getUniformLocation(i.program,"u_bHorizontal"),i.uImageSize_loc=e.getUniformLocation(i.program,"uImageSize"),i.imageTex_loc=e.getUniformLocation(i.program,"image"),this.useProgram(i),e.uniform1i(i.imageTex_loc,0),this.shadersMap.screenQuadBlur=i,i},Oo.prototype._createShader_modelRefSsao=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.ModelRefSsaoVS,o=Bo.ModelRefSsaoFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"modelRefSsao",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uModelOpacity_loc=r.getUniformLocation(n.program,"uModelOpacity"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),this.shadersMap.modelRefSsao=n,n},Oo.prototype._createShader_pollution=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.PollutionVS,o=Bo.PollutionFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"pollution",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uModelOpacity_loc=r.getUniformLocation(n.program,"uModelOpacity"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),n.uInterpolationFactor_loc=r.getUniformLocation(n.program,"uInterpolationFactor"),n.uMinMaxQuantizedValues_tex0_loc=r.getUniformLocation(n.program,"uMinMaxQuantizedValues_tex0"),n.uMinMaxQuantizedValues_tex1_loc=r.getUniformLocation(n.program,"uMinMaxQuantizedValues_tex1"),n.uMinMaxValues_loc=r.getUniformLocation(n.program,"uMinMaxValues"),n.texture_0_loc=r.getUniformLocation(n.program,"texture_0"),n.texture_1_loc=r.getUniformLocation(n.program,"texture_1"),this.useProgram(n),r.uniform1i(n.texture_0_loc,0),r.uniform1i(n.texture_1_loc,1),this.shadersMap.pollution=n,n},Oo.prototype._createShader_soundSurface=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.SoundSurfaceVS,o=Bo.SoundSurfaceFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"soundSurface",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uModelOpacity_loc=r.getUniformLocation(n.program,"uModelOpacity"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),n.uInterpolationFactor_loc=r.getUniformLocation(n.program,"uInterpolationFactor"),n.uMinMaxValue_loc=r.getUniformLocation(n.program,"uMinMaxValue"),n.uLegendColors_loc=r.getUniformLocation(n.program,"uLegendColors"),n.uLegendValues_loc=r.getUniformLocation(n.program,"uLegendValues"),n.position3_loc=r.getAttribLocation(n.program,"position"),n.value_loc=r.getAttribLocation(n.program,"value"),n.texture_0_loc=r.getUniformLocation(n.program,"texture_0"),n.texture_1_loc=r.getUniformLocation(n.program,"texture_1"),this.useProgram(n),r.uniform1i(n.texture_0_loc,0),r.uniform1i(n.texture_1_loc,1),this.shadersMap.soundSurface=n,n},Oo.prototype._createShader_electroMagnetismSurface=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.ElectroMagnetismSurfaceVS,o=Bo.ElectroMagnetismSurfaceFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"electroMagnetismSurface",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uModelOpacity_loc=r.getUniformLocation(n.program,"uModelOpacity"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),n.uInterpolationFactor_loc=r.getUniformLocation(n.program,"uInterpolationFactor"),n.uMinMaxValue_loc=r.getUniformLocation(n.program,"uMinMaxValue"),n.uLegendColors_loc=r.getUniformLocation(n.program,"uLegendColors"),n.uLegendValues_loc=r.getUniformLocation(n.program,"uLegendValues"),n.uBaseColor4_loc=r.getUniformLocation(n.program,"uBaseColor4"),n.position3_loc=r.getAttribLocation(n.program,"position"),n.value_loc=r.getAttribLocation(n.program,"value"),n.texture_0_loc=r.getUniformLocation(n.program,"texture_0"),n.texture_1_loc=r.getUniformLocation(n.program,"texture_1"),this.useProgram(n),r.uniform1i(n.texture_0_loc,0),r.uniform1i(n.texture_1_loc,1),this.shadersMap.electroMagnetismSurface=n,n},Oo.prototype._createShader_modelRefDepth=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.RenderShowDepthVS,o=Bo.RenderShowDepthFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"modelRefDepth",this.magoManager);return n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.mvpRelToEyeMatrix_loc=r.getUniformLocation(n.program,"ModelViewProjectionMatrixRelToEye"),n.mvRelToEyeMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrixRelToEye"),n.normalMatrix_loc=r.getUniformLocation(n.program,"normalMatrix4"),n.encodedCameraPositionMCHigh_loc=r.getUniformLocation(n.program,"encodedCameraPositionMCHigh"),n.encodedCameraPositionMCLow_loc=r.getUniformLocation(n.program,"encodedCameraPositionMCLow"),this.shadersMap.modelRefDepth=n,n},Oo.prototype._createShader_tinTerrain=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.TinTerrainVS,o=Bo.TinTerrainFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n,a,s=this.createShaderProgram(r,i,o,"tinTerrain",this.magoManager);return s.bIsMakingDepth_loc=r.getUniformLocation(s.program,"bIsMakingDepth"),s.bExistAltitudes_loc=r.getUniformLocation(s.program,"bExistAltitudes"),s.uMinMaxAltitudes_loc=r.getUniformLocation(s.program,"uMinMaxAltitudes"),s.uTileDepth_loc=r.getUniformLocation(s.program,"uTileDepth"),s.altitude_loc=r.getAttribLocation(s.program,"altitude"),s.uSeaOrTerrainType_loc=r.getUniformLocation(s.program,"uSeaOrTerrainType"),s.bUseLogarithmicDepth_loc=r.getUniformLocation(s.program,"bUseLogarithmicDepth"),s.bApplyCaustics_loc=r.getUniformLocation(s.program,"bApplyCaustics"),s.uFCoef_logDepth_loc=r.getUniformLocation(s.program,"uFCoef_logDepth"),s.uTileGeoExtent_loc=r.getUniformLocation(s.program,"uTileGeoExtent"),s.uGeoRectangles_loc=r.getUniformLocation(s.program,"uGeoRectangles"),s.uGeoRectanglesCount_loc=r.getUniformLocation(s.program,"uGeoRectanglesCount"),s.uTileGeoExtent_loc=r.getUniformLocation(s.program,"uTileGeoExtent"),s.uTileDepthOfBindedTextures_loc=r.getUniformLocation(s.program,"uTileDepthOfBindedTextures"),s.uTileGeoExtentOfBindedTextures_loc=r.getUniformLocation(s.program,"uTileGeoExtentOfBindedTextures"),s.uDebug_texCorrectionFactor_loc=r.getUniformLocation(s.program,"uDebug_texCorrectionFactor"),s.uActiveTextures_loc=r.getUniformLocation(s.program,"uActiveTextures"),s.externalAlphasArray_loc=r.getUniformLocation(s.program,"externalAlphasArray"),(a=s.getUniformDataPair("diffuseTex")).intValue=2,null!==(n=r.getUniformLocation(s.program,"diffuseTex_1"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_1")).uniformLocation=n,a.intValue=3),null!==(n=r.getUniformLocation(s.program,"diffuseTex_2"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_2")).uniformLocation=n,a.intValue=4),null!==(n=r.getUniformLocation(s.program,"diffuseTex_3"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_3")).uniformLocation=n,a.intValue=5),null!==(n=r.getUniformLocation(s.program,"diffuseTex_4"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_4")).uniformLocation=n,a.intValue=6),null!==(n=r.getUniformLocation(s.program,"diffuseTex_5"))&&void 0!==n&&((a=s.newUniformDataPair("1i","diffuseTex_5")).uniformLocation=n,a.intValue=7),this.shadersMap.tinTerrain=s,s},Oo.prototype._createShader_tinTerrainAltitudes=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl;shaderName="tinTerrainAltitudes",ssao_vs_source=Bo.TinTerrainAltitudesVS,ssao_fs_source=Bo.TinTerrainAltitudesFS;var t=this.createShaderProgram(e,ssao_vs_source,ssao_fs_source,shaderName,this.magoManager);return this.shadersMap[shaderName]=t,t},Oo.prototype._createShader_qMeshRenderTEST=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.waterQuantizedMeshVS_3D_TEST,o=Bo.waterQuantizedMeshFS_3D_TEST;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"qMeshRenderTEST",this.magoManager);return n.u_screen_loc=r.getUniformLocation(n.program,"u_screen"),n.u_opacity_loc=r.getUniformLocation(n.program,"u_opacity"),n.colorType_loc=r.getUniformLocation(n.program,"colorType"),n.u_oneColor4_loc=r.getUniformLocation(n.program,"u_oneColor4"),this.useProgram(n),r.uniform1i(n.u_screen_loc,0),this.shadersMap.qMeshRenderTEST=n,n},Oo.prototype._createShader_pointsCloud=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=(this._get_useMultiRenderTarget_string(),this.gl),r=Bo.PointCloudVS,i=Bo.PointCloudFS;i=i.replace(/%USE_LOGARITHMIC_DEPTH%/g,e);var o=this.createShaderProgram(t,r,i,"pointsCloud",this.magoManager);return o.bPositionCompressed_loc=t.getUniformLocation(o.program,"bPositionCompressed"),o.minPosition_loc=t.getUniformLocation(o.program,"minPosition"),o.bboxSize_loc=t.getUniformLocation(o.program,"bboxSize"),o.maxPointSize_loc=t.getUniformLocation(o.program,"maxPointSize"),o.minPointSize_loc=t.getUniformLocation(o.program,"minPointSize"),o.pendentPointSize_loc=t.getUniformLocation(o.program,"pendentPointSize"),o.uStrokeColor_loc=t.getUniformLocation(o.program,"uStrokeColor"),o.uStrokeSize_loc=t.getUniformLocation(o.program,"uStrokeSize"),o.bUseLogarithmicDepth_loc=t.getUniformLocation(o.program,"bUseLogarithmicDepth"),this.shadersMap.pointsCloud=o,o},Oo.prototype._createShader_testQuad=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.Test_QuadVS,r=Bo.Test_QuadFS,i=this.createShaderProgram(e,t,r,"testQuad",this.magoManager);return this.shadersMap.testQuad=i,i},Oo.prototype._createShader_pointsCloudSsao=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.PointCloudVS,o=Bo.PointCloudSsaoFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"pointsCloudSsao",this.magoManager);return n.normalTex_loc=r.getUniformLocation(n.program,"normalTex"),this.useProgram(n),r.uniform1i(n.normalTex_loc,6),n.uNearFarArray_loc=r.getUniformLocation(n.program,"uNearFarArray"),n.bPositionCompressed_loc=r.getUniformLocation(n.program,"bPositionCompressed"),n.minPosition_loc=r.getUniformLocation(n.program,"minPosition"),n.bboxSize_loc=r.getUniformLocation(n.program,"bboxSize"),n.maxPointSize_loc=r.getUniformLocation(n.program,"maxPointSize"),n.minPointSize_loc=r.getUniformLocation(n.program,"minPointSize"),n.pendentPointSize_loc=r.getUniformLocation(n.program,"pendentPointSize"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uSelColor4_loc=r.getUniformLocation(n.program,"uSelColor4"),this.shadersMap.pointsCloudSsao=n,n},Oo.prototype._createShader_pointsCloudSsao_rainbow=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.PointCloudVS_rainbow,r=Bo.PointCloudSsaoFS_rainbow,i=this.createShaderProgram(e,t,r,"pointsCloudSsao_rainbow",this.magoManager);return i.bPositionCompressed_loc=e.getUniformLocation(i.program,"bPositionCompressed"),i.minPosition_loc=e.getUniformLocation(i.program,"minPosition"),i.bboxSize_loc=e.getUniformLocation(i.program,"bboxSize"),i.bUseColorCodingByHeight_loc=e.getUniformLocation(i.program,"bUseColorCodingByHeight"),i.minHeight_rainbow_loc=e.getUniformLocation(i.program,"minHeight_rainbow"),i.maxHeight_rainbow_loc=e.getUniformLocation(i.program,"maxHeight_rainbow"),i.maxPointSize_loc=e.getUniformLocation(i.program,"maxPointSize"),i.minPointSize_loc=e.getUniformLocation(i.program,"minPointSize"),i.pendentPointSize_loc=e.getUniformLocation(i.program,"pendentPointSize"),i.bUseLogarithmicDepth_loc=e.getUniformLocation(i.program,"bUseLogarithmicDepth"),this.shadersMap.pointsCloudSsao_rainbow=i,i},Oo.prototype._createShader_atmosphere=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.atmosphereVS,r=Bo.atmosphereFS,i=this.createShaderProgram(e,t,r,"atmosphere",this.magoManager);return i.bIsMakingDepth_loc=e.getUniformLocation(i.program,"bIsMakingDepth"),i.equatorialRadius_loc=e.getUniformLocation(i.program,"equatorialRadius"),i.getUniformDataPair("mvpMat4RelToEye").matrix4fv=this.sceneState.modelViewProjRelToEyeMatrixSky._floatArrays,this.shadersMap.atmosphere=i,i},Oo.prototype._createShader_imageViewerRectangle=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.ImageViewerRectangleShaderVS,r=Bo.ImageViewerRectangleShaderFS,i=this.createShaderProgram(e,t,r,"imageViewerRectangle",this.magoManager);return this.shadersMap.imageViewerRectangle=i,i},Oo.prototype._createShader_orthogonalDepth=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.OrthogonalDepthShaderVS,r=Bo.OrthogonalDepthShaderFS,i=this.createShaderProgram(e,t,r,"orthogonalDepth",this.magoManager);return i.modelViewProjectionMatrixRelToEye_loc=e.getUniformLocation(i.program,"ModelViewProjectionMatrixRelToEye"),i.modelViewMatrixRelToEye_loc=e.getUniformLocation(i.program,"modelViewMatrixRelToEye"),i.encodedCameraPositionMCHigh_loc=e.getUniformLocation(i.program,"encodedCameraPositionMCHigh"),i.encodedCameraPositionMCLow_loc=e.getUniformLocation(i.program,"encodedCameraPositionMCLow"),i.fov_loc=e.getUniformLocation(i.program,"fov"),i.aspectRatio_loc=e.getUniformLocation(i.program,"aspectRatio"),i.screenWidth_loc=e.getUniformLocation(i.program,"screenWidth"),i.screenHeight_loc=e.getUniformLocation(i.program,"screenHeight"),this.shadersMap.orthogonalDepth=i,i},Oo.prototype._createShader_thickLine=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.thickLineVS,o=Bo.thickLineFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"thickLine",this.magoManager);return n.projectionMatrix_loc=r.getUniformLocation(n.program,"projectionMatrix"),n.modelViewMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrix"),n.viewport_loc=r.getUniformLocation(n.program,"viewport"),n.thickness_loc=r.getUniformLocation(n.program,"thickness"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.bUseOutline_loc=r.getUniformLocation(n.program,"bUseOutline"),r.bindAttribLocation(n.program,0,"prev"),r.bindAttribLocation(n.program,1,"current"),r.bindAttribLocation(n.program,2,"next"),r.bindAttribLocation(n.program,3,"color4"),n.prev_loc=0,n.current_loc=1,n.next_loc=2,n.color4_loc=3,this.shadersMap.thickLine=n,n},Oo.prototype._createShader_windStreamThickLine=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.windStreamThickLineVS,o=Bo.windStreamThickLineFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"windStreamThickLine",this.magoManager);return n.projectionMatrix_loc=r.getUniformLocation(n.program,"projectionMatrix"),n.modelViewMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrix"),n.viewport_loc=r.getUniformLocation(n.program,"viewport"),n.thickness_loc=r.getUniformLocation(n.program,"thickness"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uElemIndex_loc=r.getUniformLocation(n.program,"uElemIndex"),n.uTotalPointsCount_loc=r.getUniformLocation(n.program,"uTotalPointsCount"),r.bindAttribLocation(n.program,0,"prev"),r.bindAttribLocation(n.program,1,"current"),r.bindAttribLocation(n.program,2,"next"),r.bindAttribLocation(n.program,3,"color4"),r.bindAttribLocation(n.program,4,"index"),n.prev_loc=0,n.current_loc=1,n.next_loc=2,n.color4_loc=3,n.index_loc=4,this.shadersMap.windStreamThickLine=n,n},Oo.prototype._createShader_windStreamThickLineRAD=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.windStreamThickLineRAD_VS,o=Bo.windStreamThickLineRAD_FS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"windStreamThickLineRAD",this.magoManager);return n.projectionMatrix_loc=r.getUniformLocation(n.program,"projectionMatrix"),n.modelViewMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrix"),n.viewport_loc=r.getUniformLocation(n.program,"viewport"),n.thickness_loc=r.getUniformLocation(n.program,"thickness"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),n.uFrustumIdx_loc=r.getUniformLocation(n.program,"uFrustumIdx"),n.uElemIndex_loc=r.getUniformLocation(n.program,"uElemIndex"),n.uTotalPointsCount_loc=r.getUniformLocation(n.program,"uTotalPointsCount"),r.bindAttribLocation(n.program,0,"prev"),r.bindAttribLocation(n.program,1,"current"),r.bindAttribLocation(n.program,2,"next"),r.bindAttribLocation(n.program,3,"color4"),r.bindAttribLocation(n.program,4,"index"),n.prev_loc=0,n.current_loc=1,n.next_loc=2,n.color4_loc=3,n.index_loc=4,this.shadersMap.windStreamThickLineRAD=n,n},Oo.prototype._createShader_thickLineExtruded=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.thickLineExtrudedVS,o=Bo.thickLineFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"thickLineExtruded",this.magoManager);return n.projectionMatrix_loc=r.getUniformLocation(n.program,"projectionMatrix"),n.modelViewMatrix_loc=r.getUniformLocation(n.program,"modelViewMatrix"),n.viewport_loc=r.getUniformLocation(n.program,"viewport"),n.thickness_loc=r.getUniformLocation(n.program,"thickness"),n.bUseLogarithmicDepth_loc=r.getUniformLocation(n.program,"bUseLogarithmicDepth"),n.uFCoef_logDepth_loc=r.getUniformLocation(n.program,"uFCoef_logDepth"),n.bUseMultiRenderTarget_loc=r.getUniformLocation(n.program,"bUseMultiRenderTarget"),r.bindAttribLocation(n.program,0,"prev"),r.bindAttribLocation(n.program,1,"current"),r.bindAttribLocation(n.program,2,"next"),r.bindAttribLocation(n.program,3,"color4"),n.prev_loc=0,n.current_loc=1,n.next_loc=2,n.color4_loc=3,this.shadersMap.thickLineExtruded=n,n},Oo.prototype._createShader_pin=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=this._get_useMultiRenderTarget_string(),r=this.gl,i=Bo.PngImageVS,o=Bo.PngImageFS;o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,e)).replace(/%USE_MULTI_RENDER_TARGET%/g,t);var n=this.createShaderProgram(r,i,o,"pin",this.magoManager);return n.position4_loc=r.getAttribLocation(n.program,"position"),n.texCoord2_loc=r.getAttribLocation(n.program,"texCoord"),n.scale2d_loc=r.getUniformLocation(n.program,"scale2d"),n.size2d_loc=r.getUniformLocation(n.program,"size2d"),n.imageSize_loc=r.getUniformLocation(n.program,"imageSize"),n.bUseOriginalImageSize_loc=r.getUniformLocation(n.program,"bUseOriginalImageSize"),n.aditionalOffset_loc=r.getUniformLocation(n.program,"aditionalOffset"),n.screenWidth_loc=r.getUniformLocation(n.program,"screenWidth"),n.screenHeight_loc=r.getUniformLocation(n.program,"screenHeight"),this.shadersMap.pin=n,n},Oo.prototype._createShader_texturesMerger=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.texturesMergerVS,r=Bo.texturesMergerFS,i=this.createShaderProgram(e,t,r,"texturesMerger",this.magoManager);return i.position2_loc=e.getAttribLocation(i.program,"a_pos"),i.uActiveTextures_loc=e.getUniformLocation(i.program,"uActiveTextures"),i.externalAlphasArray_loc=e.getUniformLocation(i.program,"externalAlphasArray"),i.uExternalTexCoordsArray_loc=e.getUniformLocation(i.program,"uExternalTexCoordsArray"),i.uMinMaxAltitudes_loc=e.getUniformLocation(i.program,"uMinMaxAltitudes"),i.uMinMaxAltitudesBathymetryToGradient_loc=e.getUniformLocation(i.program,"uMinMaxAltitudesBathymetryToGradient"),i.uGradientSteps_loc=e.getUniformLocation(i.program,"uGradientSteps"),i.uGradientStepsCount_loc=e.getUniformLocation(i.program,"uGradientStepsCount"),i.tex_0_loc=e.getUniformLocation(i.program,"texture_0"),i.tex_1_loc=e.getUniformLocation(i.program,"texture_1"),i.tex_2_loc=e.getUniformLocation(i.program,"texture_2"),i.tex_3_loc=e.getUniformLocation(i.program,"texture_3"),i.tex_4_loc=e.getUniformLocation(i.program,"texture_4"),i.tex_5_loc=e.getUniformLocation(i.program,"texture_5"),i.tex_6_loc=e.getUniformLocation(i.program,"texture_6"),i.tex_7_loc=e.getUniformLocation(i.program,"texture_7"),this.useProgram(i),e.uniform1i(i.tex_0_loc,0),e.uniform1i(i.tex_1_loc,1),e.uniform1i(i.tex_2_loc,2),e.uniform1i(i.tex_3_loc,3),e.uniform1i(i.tex_4_loc,4),e.uniform1i(i.tex_5_loc,5),e.uniform1i(i.tex_6_loc,6),e.uniform1i(i.tex_7_loc,7),this.shadersMap.texturesMerger=i,i},Oo.prototype._createShader_copyTexture=function(){var e=this._get_useMultiRenderTarget_string(),t=this.gl,r=Bo.textureCopyVS,i=Bo.textureCopyFS;i=i.replace(/%USE_MULTI_RENDER_TARGET%/g,e);var o=this.createShaderProgram(t,r,i,"textureCopy",this.magoManager);return o.position2_loc=t.getAttribLocation(o.program,"position"),o.texToCopy_loc=t.getUniformLocation(o.program,"texToCopy"),o.u_textureFlipYAxis_loc=t.getUniformLocation(o.program,"u_textureFlipYAxis"),o.u_textureFlipXAxis_loc=t.getUniformLocation(o.program,"u_textureFlipXAxis"),this.useProgram(o),t.uniform1i(o.texToCopy_loc,0),this.shadersMap.textureCopy=o,o},Oo.prototype._createShader_rectangleScreen=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.rectangleScreenVS,r=Bo.rectangleScreenFS,i=this.createShaderProgram(e,t,r,"rectangleScreen",this.magoManager);return i.position2_loc=e.getAttribLocation(i.program,"a_pos"),i.normal3_loc=e.getAttribLocation(i.program,"a_nor"),i.texCoord2_loc=e.getAttribLocation(i.program,"a_tex"),i.tex_0_loc=e.getUniformLocation(i.program,"texture_0"),i.texture_cube_loc=e.getUniformLocation(i.program,"texture_cube"),i.uTextureType_loc=e.getUniformLocation(i.program,"uTextureType"),this.useProgram(i),e.uniform1i(i.tex_0_loc,0),e.uniform1i(i.texture_cube_loc,1),this.shadersMap.rectangleScreen=i,i},Oo.prototype._createShader_rectangleScreenMosaic=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.rectangleScreenVS,r=Bo.rectangleScreenMosaicFS,i=this.createShaderProgram(e,t,r,"rectangleScreenMosaic",this.magoManager);return i.position2_loc=e.getAttribLocation(i.program,"a_pos"),i.normal3_loc=e.getAttribLocation(i.program,"a_nor"),i.texCoord2_loc=e.getAttribLocation(i.program,"a_tex"),i.tex_0_loc=e.getUniformLocation(i.program,"texture_0"),i.tex_1_loc=e.getUniformLocation(i.program,"texture_1"),i.tex_0_loc=e.getUniformLocation(i.program,"texture_2"),i.tex_1_loc=e.getUniformLocation(i.program,"texture_3"),i.uTextureType_loc=e.getUniformLocation(i.program,"uTextureType"),i.uSliceIdx_loc=e.getUniformLocation(i.program,"uSliceIdx"),i.u_mosaicSize_loc=e.getUniformLocation(i.program,"u_mosaicSize"),i.u_maxFlux_loc=e.getUniformLocation(i.program,"u_maxFlux"),this.useProgram(i),e.uniform1i(i.tex_0_loc,0),e.uniform1i(i.tex_1_loc,1),e.uniform1i(i.tex_2_loc,2),e.uniform1i(i.tex_3_loc,3),this.shadersMap.rectangleScreenMosaic=i,i},Oo.prototype._createShader_ssaoFromDepth=function(){this._get_useLinearOrLogarithmicDepth_string(),this._get_useMultiRenderTarget_string();var e=this.gl,t=Bo.ScreenQuadVS,r=Bo.ssaoFromDepthFS,i=this.createShaderProgram(e,t,r,"ssaoFromDepth",this.magoManager);return i.bUseLogarithmicDepth_loc=e.getUniformLocation(i.program,"bUseLogarithmicDepth"),i.uFCoef_logDepth_loc=e.getUniformLocation(i.program,"uFCoef_logDepth"),i.uNumFrustums_loc=e.getUniformLocation(i.program,"uNumFrustums"),i.uNearFarArray_loc=e.getUniformLocation(i.program,"uNearFarArray"),i.screenWidth_loc=e.getUniformLocation(i.program,"screenWidth"),i.screenHeight_loc=e.getUniformLocation(i.program,"screenHeight"),i.depthTex_loc=e.getUniformLocation(i.program,"depthTex"),i.noiseTex_loc=e.getUniformLocation(i.program,"noiseTex"),i.normalTex_loc=e.getUniformLocation(i.program,"normalTex"),this.useProgram(i),e.uniform1i(i.depthTex_loc,0),e.uniform1i(i.noiseTex_loc,1),e.uniform1i(i.normalTex_loc,3),this.shadersMap.ssaoFromDepth=i,i},Oo.prototype._createShader_thickLineClampToTerrain=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=(this._get_useMultiRenderTarget_string(),this.gl),r=Bo.vectorMeshClampToTerrainVS,i=Bo.vectorMeshClampToTerrainFS;i=i.replace(/%USE_LOGARITHMIC_DEPTH%/g,e);var o=this.createShaderProgram(t,r,i,"thickLineClampToTerrain",this.magoManager);return o.projectionMatrix_loc=t.getUniformLocation(o.program,"projectionMatrix"),o.modelViewMatrix_loc=t.getUniformLocation(o.program,"modelViewMatrix"),o.viewport_loc=t.getUniformLocation(o.program,"viewport"),o.thickness_loc=t.getUniformLocation(o.program,"thickness"),o.bUseLogarithmicDepth_loc=t.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=t.getUniformLocation(o.program,"uFCoef_logDepth"),t.bindAttribLocation(o.program,0,"prev"),t.bindAttribLocation(o.program,1,"current"),t.bindAttribLocation(o.program,2,"next"),t.bindAttribLocation(o.program,3,"color4"),o.prev_loc=0,o.current_loc=1,o.next_loc=2,o.color4_loc=3,this.shadersMap.thickLineClampToTerrain=o,o},Oo.prototype._createShader_groundStencilPrimitives=function(){var e=this._get_useLinearOrLogarithmicDepth_string(),t=(this._get_useMultiRenderTarget_string(),this.gl),r=Bo.GroundStencilPrimitivesVS,i=Bo.GroundStencilPrimitivesFS;i=i.replace(/%USE_LOGARITHMIC_DEPTH%/g,e);var o=this.createShaderProgram(t,r,i,"groundStencilPrimitives",this.magoManager);return o.bUseLogarithmicDepth_loc=t.getUniformLocation(o.program,"bUseLogarithmicDepth"),o.uFCoef_logDepth_loc=t.getUniformLocation(o.program,"uFCoef_logDepth"),this.shadersMap.groundStencilPrimitives=o,o},Oo.prototype._createShaderByName=function(e){switch(e){case"gBuffer":this._createShader_gBuffer();break;case"gBufferORT":this._createShader_gBufferORT();break;case"lBuffer":this._createShader_lBuffer();break;case"screenQuad":this._createShader_screenQuad();break;case"screenCopyQuad":this._createShader_screenCopyQuad();break;case"screenQuad2":this._createShader_screenQuad2();break;case"modelRefSsao":this._createShader_modelRefSsao();break;case"modelRefDepth":this._createShader_modelRefDepth();break;case"tinTerrain":this._createShader_tinTerrain();break;case"tinTerrainAltitudes":this._createShader_tinTerrainAltitudes();break;case"pointsCloud":this._createShader_pointsCloud();break;case"testQuad":this._createShader_testQuad();break;case"pointsCloudSsao":this._createShader_pointsCloudSsao();break;case"pointsCloudSsao_rainbow":this._createShader_pointsCloudSsao_rainbow();break;case"atmosphere":this._createShader_atmosphere();break;case"imageViewerRectangle":this._createShader_imageViewerRectangle();break;case"orthogonalDepth":this._createShader_orthogonalDepth();break;case"thickLine":this._createShader_thickLine();break;case"windStreamThickLine":this._createShader_windStreamThickLine();case"windStreamThickLineRAD":this._createShader_windStreamThickLineRAD();break;case"thickLineExtruded":this._createShader_thickLineExtruded();break;case"pin":this._createShader_pin();break;case"texturesMerger":this._createShader_texturesMerger();break;case"rectangleScreen":this._createShader_rectangleScreen();break;case"ssaoFromDepth":this._createShader_ssaoFromDepth();break;case"thickLineClampToTerrain":this._createShader_thickLineClampToTerrain();break;case"groundStencilPrimitives":this._createShader_groundStencilPrimitives();break;case"textureCopy":this._createShader_copyTexture();break;case"gaussianBlur":this._createShader_gaussianBlur();break;case"screenQuadBlur":this._createShader_screenQuadBlur();break;case"qMeshRenderTEST":this._createShader_qMeshRenderTEST();break;case"rectangleScreenMosaic":this._createShader_rectangleScreenMosaic();break;case"pollution":this._createShader_pollution();break;case"soundSurface":this._createShader_soundSurface();break;case"electroMagnetismSurface":this._createShader_electroMagnetismSurface()}},Oo.prototype.getShader=function(e){return this.shadersMap[e]||this._createShaderByName(e),this.shadersMap[e]},Oo.prototype.createShaderProgram=function(e,t,r,i,o){var n=this.newShader(i);n.program=e.createProgram(),n.shader_vertex=this.createShader(e,t,e.VERTEX_SHADER,"VERTEX"),n.shader_fragment=this.createShader(e,r,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(n.program,n.shader_vertex),e.attachShader(n.program,n.shader_fragment),n.bindAttribLocations(e,n),e.linkProgram(n.program),n.createUniformGenerals(e,n,o.sceneState),n.createUniformLocals(e,n,o.sceneState),n.attribLocations||(n.attribLocations={});for(var a=e.getProgramParameter(n.program,e.ACTIVE_ATTRIBUTES),s=0;s<a;s++){var l=e.getActiveAttrib(n.program,s);n.attribLocations[l.name]=e.getAttribLocation(n.program,l.name)}n.uniformsLocations||(n.uniformsLocations={});var u=e.getProgramParameter(n.program,e.ACTIVE_UNIFORMS);for(s=0;s<u;s++){var c=e.getActiveUniform(n.program,s);n.uniformsLocations[c.name]=e.getUniformLocation(n.program,c.name)}return n},Oo.prototype.createShader=function(e,t,r,i){var o=e.createShader(r);return e.shaderSource(o,t),e.compileShader(o),e.getShaderParameter(o,e.COMPILE_STATUS)?o:(alert("ERROR IN "+i+" SHADER : "+e.getShaderInfoLog(o)),!1)},Oo.prototype.createDefaultShaders=function(e,t){this.modelRefSilhouetteShader=this.createSilhouetteShaderModelRef(e),this.dustParticleShader=this.createDustParticlesShader(e),this.dustTextureModeShader=this.createDustTextureModeShader(e)},Oo.prototype.getModelRefSilhouetteShader=function(){return this.modelRefSilhouetteShader},Oo.prototype.getTriPolyhedronDepthShader=function(){return this.triPolyhedronDepthShader},Oo.prototype.getUnitaryBBoxShader=function(e){return this.triPolyhedronShader||(this.triPolyhedronShader=this.createSsaoShaderBox(e)),this.triPolyhedronShader},Oo.prototype.getInvertedBoxShader=function(){return this.invertedBoxShader},Oo.prototype.createSilhouetteShaderModelRef=function(e){var t=new Fo(this.gl);t.name="SilhouetteShaderModelRef",this.pFx_shaders_array.push(void 0);var r=Bo.SilhouetteVS,i=Bo.SilhouetteFS;return t.program=e.createProgram(),t.shader_vertex=this.createShader(e,r,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,i,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),t.bindAttribLocations(e,t),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.refMatrixType_loc=e.getUniformLocation(t.program,"refMatrixType"),t.refTranslationVec_loc=e.getUniformLocation(t.program,"refTranslationVec"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux"),t.camSpacePixelTranslation_loc=e.getUniformLocation(t.program,"camSpacePixelTranslation"),t.screenSize_loc=e.getUniformLocation(t.program,"screenSize"),t.ProjectionMatrix_loc=e.getUniformLocation(t.program,"ProjectionMatrix"),t.ModelViewMatrixRelToEye_loc=e.getUniformLocation(t.program,"ModelViewMatrixRelToEye"),t},Oo.prototype.createDustParticlesShader=function(e){var t=this._get_useMultiRenderTarget_string();if(e.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){e.getExtension("WEBGL_draw_buffers");this.bUseMultiRenderTarget=!0,t="USE_MULTI_RENDER_TARGET"}var r=new Fo(this.gl);r.shaderManager=this,this.pFx_shaders_array.push(r);var i=Bo.dustParticleVS,o=Bo.dustParticleFS;return o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,"USE_LINEAR_DEPTH")).replace(/%USE_MULTI_RENDER_TARGET%/g,t),r.program=e.createProgram(),r.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),r.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(r.program,r.shader_vertex),e.attachShader(r.program,r.shader_fragment),r.bindAttribLocations(e,r),e.linkProgram(r.program),r.cameraPosHIGH_loc=e.getUniformLocation(r.program,"encodedCameraPositionMCHigh"),r.cameraPosLOW_loc=e.getUniformLocation(r.program,"encodedCameraPositionMCLow"),r.buildingPosHIGH_loc=e.getUniformLocation(r.program,"buildingPosHIGH"),r.buildingPosLOW_loc=e.getUniformLocation(r.program,"buildingPosLOW"),r.uNear_loc=e.getUniformLocation(r.program,"near"),r.uFar_loc=e.getUniformLocation(r.program,"far"),r.modelViewMatrix4RelToEye_loc=e.getUniformLocation(r.program,"modelViewMatrixRelToEye"),r.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(r.program,"ModelViewProjectionMatrixRelToEye"),r.normalMatrix4_loc=e.getUniformLocation(r.program,"normalMatrix4"),r.projectionMatrix4_loc=e.getUniformLocation(r.program,"projectionMatrix"),r.modelViewMatrix4_loc=e.getUniformLocation(r.program,"modelViewMatrix"),r.buildingRotMatrix_loc=e.getUniformLocation(r.program,"buildingRotMatrix"),r.bUse1Color_loc=e.getUniformLocation(r.program,"bUse1Color"),r.oneColor4_loc=e.getUniformLocation(r.program,"oneColor4"),r.bUseNormal_loc=e.getUniformLocation(r.program,"bUseNormal"),r.bScale_loc=e.getUniformLocation(r.program,"bScale"),r.scale_loc=e.getUniformLocation(r.program,"scale"),r.uDustConcentration_loc=e.getUniformLocation(r.program,"uDustConcentration"),r.uDustConcentMinMax_loc=e.getUniformLocation(r.program,"uDustConcentMinMax"),e.bindAttribLocation(r.program,0,"position"),e.bindAttribLocation(r.program,1,"normal"),e.bindAttribLocation(r.program,2,"texCoord"),e.bindAttribLocation(r.program,3,"color4"),r.position3_loc=e.getAttribLocation(r.program,"position"),r.normal3_loc=e.getAttribLocation(r.program,"normal"),r.color4_loc=e.getAttribLocation(r.program,"color4"),r.attribLocationCacheObj.position=e.getAttribLocation(r.program,"position"),r.attribLocationCacheObj.normal=e.getAttribLocation(r.program,"normal"),r.attribLocationCacheObj.color4=e.getAttribLocation(r.program,"color4"),r.bUseLogarithmicDepth_loc=e.getUniformLocation(r.program,"bUseLogarithmicDepth"),r.uFCoef_logDepth_loc=e.getUniformLocation(r.program,"uFCoef_logDepth"),r.uFrustumIdx_loc=e.getUniformLocation(r.program,"uFrustumIdx"),r.smokeTex_loc=e.getUniformLocation(r.program,"smokeTex"),this.useProgram(r),e.uniform1i(r.smokeTex_loc,0),r},Oo.prototype.createDustTextureModeShader=function(e){var t=this._get_useMultiRenderTarget_string();if(e.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){e.getExtension("WEBGL_draw_buffers");this.bUseMultiRenderTarget=!0,t="USE_MULTI_RENDER_TARGET"}var r=new Fo(this.gl);r.shaderManager=this,this.pFx_shaders_array.push(r);var i=Bo.dustTextureModeVS,o=Bo.dustTextureModeFS;return o=(o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,"USE_LINEAR_DEPTH")).replace(/%USE_MULTI_RENDER_TARGET%/g,t),r.program=e.createProgram(),r.shader_vertex=this.createShader(e,i,e.VERTEX_SHADER,"VERTEX"),r.shader_fragment=this.createShader(e,o,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(r.program,r.shader_vertex),e.attachShader(r.program,r.shader_fragment),r.bindAttribLocations(e,r),e.linkProgram(r.program),r.cameraPosHIGH_loc=e.getUniformLocation(r.program,"encodedCameraPositionMCHigh"),r.cameraPosLOW_loc=e.getUniformLocation(r.program,"encodedCameraPositionMCLow"),r.buildingPosHIGH_loc=e.getUniformLocation(r.program,"buildingPosHIGH"),r.buildingPosLOW_loc=e.getUniformLocation(r.program,"buildingPosLOW"),r.uNear_loc=e.getUniformLocation(r.program,"near"),r.uFar_loc=e.getUniformLocation(r.program,"far"),r.modelViewMatrix4RelToEye_loc=e.getUniformLocation(r.program,"modelViewMatrixRelToEye"),r.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(r.program,"ModelViewProjectionMatrixRelToEye"),r.normalMatrix4_loc=e.getUniformLocation(r.program,"normalMatrix4"),r.projectionMatrix4_loc=e.getUniformLocation(r.program,"projectionMatrix"),r.modelViewMatrix4_loc=e.getUniformLocation(r.program,"modelViewMatrix"),r.buildingRotMatrix_loc=e.getUniformLocation(r.program,"buildingRotMatrix"),r.bUse1Color_loc=e.getUniformLocation(r.program,"bUse1Color"),r.oneColor4_loc=e.getUniformLocation(r.program,"oneColor4"),r.bUseNormal_loc=e.getUniformLocation(r.program,"bUseNormal"),r.bScale_loc=e.getUniformLocation(r.program,"bScale"),r.scale_loc=e.getUniformLocation(r.program,"scale"),r.uDustConcentration_loc=e.getUniformLocation(r.program,"uDustConcentration"),r.uDustConcentMinMax_up_loc=e.getUniformLocation(r.program,"uDustConcentMinMax_up"),r.uDustConcentMinMax_down_loc=e.getUniformLocation(r.program,"uDustConcentMinMax_down"),e.bindAttribLocation(r.program,0,"position"),e.bindAttribLocation(r.program,1,"normal"),e.bindAttribLocation(r.program,2,"texCoord"),e.bindAttribLocation(r.program,3,"color4"),r.position3_loc=e.getAttribLocation(r.program,"position"),r.texCoord2_loc=e.getAttribLocation(r.program,"texCoord"),r.normal3_loc=e.getAttribLocation(r.program,"normal"),r.color4_loc=e.getAttribLocation(r.program,"color4"),r.attribLocationCacheObj.position=e.getAttribLocation(r.program,"position"),r.attribLocationCacheObj.normal=e.getAttribLocation(r.program,"normal"),r.attribLocationCacheObj.color4=e.getAttribLocation(r.program,"color4"),r.bUseLogarithmicDepth_loc=e.getUniformLocation(r.program,"bUseLogarithmicDepth"),r.uFCoef_logDepth_loc=e.getUniformLocation(r.program,"uFCoef_logDepth"),r.uFrustumIdx_loc=e.getUniformLocation(r.program,"uFrustumIdx"),r.u_tex_res_loc=e.getUniformLocation(r.program,"u_tex_res"),r.uZFactor_loc=e.getUniformLocation(r.program,"uZFactor"),r.texUp_loc=e.getUniformLocation(r.program,"texUp"),r.texDown_loc=e.getUniformLocation(r.program,"texDown"),this.useProgram(r),e.uniform1i(r.texDown_loc,0),e.uniform1i(r.texUp_loc,1),r},Oo.prototype.createSsaoShaderBox=function(e){e.postFxShadersManager.bUseMultiRenderTarget=!0;var t=e.getGl(),r=new Fo(this.gl);r.shaderManager=this,this.pFx_shaders_array.push(r);var i=Bo.BoxSsaoVS,o=Bo.BoxSsaoFS;return o=o.replace(/%USE_MULTI_RENDER_TARGET%/g,"USE_MULTI_RENDER_TARGET"),r.program=t.createProgram(),r.shader_vertex=this.createShader(t,i,t.VERTEX_SHADER,"VERTEX"),r.shader_fragment=this.createShader(t,o,t.FRAGMENT_SHADER,"FRAGMENT"),t.attachShader(r.program,r.shader_vertex),t.attachShader(r.program,r.shader_fragment),r.bindAttribLocations(t,r),t.linkProgram(r.program),r.cameraPosHIGH_loc=t.getUniformLocation(r.program,"encodedCameraPositionMCHigh"),r.cameraPosLOW_loc=t.getUniformLocation(r.program,"encodedCameraPositionMCLow"),r.buildingPosHIGH_loc=t.getUniformLocation(r.program,"buildingPosHIGH"),r.buildingPosLOW_loc=t.getUniformLocation(r.program,"buildingPosLOW"),r.modelViewMatrix4RelToEye_loc=t.getUniformLocation(r.program,"modelViewMatrixRelToEye"),r.modelViewProjectionMatrix4RelToEye_loc=t.getUniformLocation(r.program,"ModelViewProjectionMatrixRelToEye"),r.normalMatrix4_loc=t.getUniformLocation(r.program,"normalMatrix4"),r.projectionMatrix4_loc=t.getUniformLocation(r.program,"projectionMatrix"),r.modelViewMatrix4_loc=t.getUniformLocation(r.program,"modelViewMatrix"),r.buildingRotMatrix_loc=t.getUniformLocation(r.program,"buildingRotMatrix"),r.bUse1Color_loc=t.getUniformLocation(r.program,"bUse1Color"),r.oneColor4_loc=t.getUniformLocation(r.program,"oneColor4"),r.bUseNormal_loc=t.getUniformLocation(r.program,"bUseNormal"),r.bScale_loc=t.getUniformLocation(r.program,"bScale"),r.scale_loc=t.getUniformLocation(r.program,"scale"),t.bindAttribLocation(r.program,0,"position"),t.bindAttribLocation(r.program,1,"normal"),t.bindAttribLocation(r.program,2,"texCoord"),t.bindAttribLocation(r.program,3,"color4"),r.position3_loc=t.getAttribLocation(r.program,"position"),r.normal3_loc=t.getAttribLocation(r.program,"normal"),r.color4_loc=t.getAttribLocation(r.program,"color4"),r.attribLocationCacheObj.position=t.getAttribLocation(r.program,"position"),r.attribLocationCacheObj.normal=t.getAttribLocation(r.program,"normal"),r.attribLocationCacheObj.color4=t.getAttribLocation(r.program,"color4"),r.aditionalMov_loc=t.getUniformLocation(r.program,"aditionalPosition"),r},Oo.prototype.createInvertedBoxShader=function(e){var t=new Fo(this.gl);this.pFx_shaders_array.push(void 0);var r=Bo.InvertedBoxVS,i=Bo.InvertedBoxFS;return t.program=e.createProgram(),t.shader_vertex=this.createShader(e,r,e.VERTEX_SHADER,"VERTEX"),t.shader_fragment=this.createShader(e,i,e.FRAGMENT_SHADER,"FRAGMENT"),e.attachShader(t.program,t.shader_vertex),e.attachShader(t.program,t.shader_fragment),t.bindAttribLocations(e,t),e.linkProgram(t.program),t.cameraPosHIGH_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCHigh"),t.cameraPosLOW_loc=e.getUniformLocation(t.program,"encodedCameraPositionMCLow"),t.buildingPosHIGH_loc=e.getUniformLocation(t.program,"buildingPosHIGH"),t.buildingPosLOW_loc=e.getUniformLocation(t.program,"buildingPosLOW"),t.modelViewMatrix4RelToEye_loc=e.getUniformLocation(t.program,"modelViewMatrixRelToEye"),t.modelViewProjectionMatrix4RelToEye_loc=e.getUniformLocation(t.program,"ModelViewProjectionMatrixRelToEye"),t.normalMatrix4_loc=e.getUniformLocation(t.program,"normalMatrix4"),t.projectionMatrix4_loc=e.getUniformLocation(t.program,"projectionMatrix"),t.refMatrix_loc=e.getUniformLocation(t.program,"RefTransfMatrix"),t.buildingRotMatrix_loc=e.getUniformLocation(t.program,"buildingRotMatrix"),t.refMatrixType_loc=e.getUniformLocation(t.program,"refMatrixType"),t.refTranslationVec_loc=e.getUniformLocation(t.program,"refTranslationVec"),t.position3_loc=e.getAttribLocation(t.program,"position"),t.texCoord2_loc=e.getAttribLocation(t.program,"texCoord"),t.normal3_loc=e.getAttribLocation(t.program,"normal"),t.attribLocationCacheObj.position=e.getAttribLocation(t.program,"position"),t.attribLocationCacheObj.texCoord=e.getAttribLocation(t.program,"texCoord"),t.attribLocationCacheObj.normal=e.getAttribLocation(t.program,"normal"),t.aditionalMov_loc=e.getUniformLocation(t.program,"aditionalPosition"),t.noiseScale2_loc=e.getUniformLocation(t.program,"noiseScale"),t.kernel16_loc=e.getUniformLocation(t.program,"kernel"),t.near_loc=e.getUniformLocation(t.program,"near"),t.far_loc=e.getUniformLocation(t.program,"far"),t.fov_loc=e.getUniformLocation(t.program,"fov"),t.aspectRatio_loc=e.getUniformLocation(t.program,"aspectRatio"),t.screenWidth_loc=e.getUniformLocation(t.program,"screenWidth"),t.screenHeight_loc=e.getUniformLocation(t.program,"screenHeight"),t.shininessValue_loc=e.getUniformLocation(t.program,"shininessValue"),t.hasTexture_loc=e.getUniformLocation(t.program,"hasTexture"),t.color4Aux_loc=e.getUniformLocation(t.program,"vColor4Aux"),t.textureFlipYAxis_loc=e.getUniformLocation(t.program,"textureFlipYAxis"),t.depthTex_loc=e.getUniformLocation(t.program,"depthTex"),t.noiseTex_loc=e.getUniformLocation(t.program,"noiseTex"),t.diffuseTex_loc=e.getUniformLocation(t.program,"diffuseTex"),t.specularColor_loc=e.getUniformLocation(t.program,"specularColor"),t.ssaoRadius_loc=e.getUniformLocation(t.program,"radius"),t.ambientReflectionCoef_loc=e.getUniformLocation(t.program,"ambientReflectionCoef"),t.diffuseReflectionCoef_loc=e.getUniformLocation(t.program,"diffuseReflectionCoef"),t.specularReflectionCoef_loc=e.getUniformLocation(t.program,"specularReflectionCoef"),t};var Bo={airPollutionVolumRenderFS:'//#version 300 es\n\n#ifdef GL_ES\n    //precision lowp float;\n    //precision lowp int;\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n// https://draemm.li/various/volumeRendering/webgl2/\n\n    //*********************************************************\n    // R= right, F= front, U= up, L= left, B= back, D= down.\n    // RFU = x, y, z.\n    // LBD = -x, -y, -z.\n    //*********************************************************\n\n    //      +-----------------+\n\t//      |                 |          \n\t//      |   screen size   |  \n\t//      |                 | \n\t//      +-----------------+\n\t//      +-----------------+----------------+\n\t//      |                 |                | \n\t//      |   front depth   |   rear depth   |\n\t//      |                 |                |\n\t//      +-----------------+----------------+\n\t\nuniform sampler2D simulationBoxDoubleDepthTex;\nuniform sampler2D simulationBoxDoubleNormalTex; // used to calculate the current frustum idx.***\nuniform sampler2D pollutionMosaicTex; // pollutionTex. (from chemical accident).***\nuniform sampler2D sceneDepthTex; // scene depth texture.***\nuniform sampler2D sceneNormalTex; // scene normal texture.***\n\nuniform int u_texSize[3]; // The original texture3D size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform vec3 u_voxelSizeMeters;\n\nvarying vec2 v_tex_pos;\n\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform vec2 u_minMaxPollutionValues;\nuniform float u_airEnvirontmentPressure;\nuniform vec2 u_screenSize;\nuniform vec2 uNearFarArray[4];\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\nuniform vec2 uMinMaxAltitudeSlices[32]; // limited to 32 slices.***\n\nuniform mat4 u_simulBoxTMat;\nuniform mat4 u_simulBoxTMatInv;\nuniform vec3 u_simulBoxPosHigh;\nuniform vec3 u_simulBoxPosLow;\nuniform vec3 u_simulBoxMinPosLC;\nuniform vec3 u_simulBoxMaxPosLC;\n\n\n\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getDepth(vec2 coord)\n{\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t//\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t//\t// flogz = 1.0 + gl_Position.z*0.0001;\n    //    float Fcoef_half = uFCoef_logDepth/2.0;\n\t//\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t//\tfloat z = (flogzAux - 1.0);\n\t//\tlinearDepth = z/(far);\n\t//\treturn linearDepth;\n\t//}\n\t//else{\n\t\treturn unpackDepth(texture2D(sceneDepthTex, coord.xy));\n\t//}\n}\n\nfloat getDepth_simulationBox(vec2 coord)\n{\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t//\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t//\t// flogz = 1.0 + gl_Position.z*0.0001;\n    //    float Fcoef_half = uFCoef_logDepth/2.0;\n\t//\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t//\tfloat z = (flogzAux - 1.0);\n\t//\tlinearDepth = z/(far);\n\t//\treturn linearDepth;\n\t//}\n\t//else{\n\t\treturn unpackDepth(texture2D(simulationBoxDoubleDepthTex, coord.xy));\n\t//}\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(sceneNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\n\nvec4 getNormal_simulationBox(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(simulationBoxDoubleNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvoid get_FrontAndRear_depthTexCoords(in vec2 texCoord, inout vec2 frontTexCoord, inout vec2 rearTexCoord)\n{\n    //      +-----------------+\n\t//      |                 |          \n\t//      |   screen size   |  \n\t//      |                 | \n\t//      +-----------------+\n\t//      +-----------------+----------------+\n\t//      |                 |                | \n\t//      |   front depth   |   rear depth   |\n\t//      |                 |                |\n\t//      +-----------------+----------------+\n    vec2 normalTexSize = vec2(u_screenSize.x * 2.0, u_screenSize.y); // the normal tex width is double of the screen size width.***\n    //vec2 frontNormalFragCoord = vec2(gl_FragCoord.x, gl_FragCoord.y);\n    //vec2 rearNormalFragCoord = vec2(gl_FragCoord.x + u_screenSize.x, gl_FragCoord.y);\n    float windows_x = texCoord.x * u_screenSize.x;\n    float windows_y = texCoord.y * u_screenSize.y;\n    vec2 frontNormalFragCoord = vec2(windows_x, windows_y);\n    vec2 rearNormalFragCoord = vec2(windows_x + u_screenSize.x, windows_y);\n\n    frontTexCoord = vec2(frontNormalFragCoord.x / normalTexSize.x, frontNormalFragCoord.y / normalTexSize.y);\n    rearTexCoord = vec2(rearNormalFragCoord.x / normalTexSize.x, rearNormalFragCoord.y / normalTexSize.y);\n}\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nvoid get_FrontAndRear_posCC(in vec2 screenPos, in float currFar_rear, in float currFar_front, inout vec3 frontPosCC, inout vec3 rearPosCC)\n{\n    vec2 frontTexCoord;\n    vec2 rearTexCoord;\n    get_FrontAndRear_depthTexCoords(screenPos, frontTexCoord, rearTexCoord);\n\n    // If the linear depth is 1, then, take the camPos as the position, so, pos = (0.0, 0.0, 0.0).***\n    //vec4 depthColor4 = texture2D(simulationBoxDoubleDepthTex, screenPos);\n    //float depthColLength = length(depthColor4);\n\n    // Front posCC.***\n    float frontLinearDepth = getDepth_simulationBox(frontTexCoord);\n    if(frontLinearDepth < 1e-8)\n    {\n        frontPosCC = vec3(0.0);\n    }\n    else\n    {\n        float front_zDist = frontLinearDepth * currFar_front; \n        frontPosCC = getViewRay(screenPos, front_zDist);\n    }\n    \n\n    // Rear posCC.***\n    float rearLinearDepth = getDepth_simulationBox(rearTexCoord);\n    if(rearLinearDepth < 1e-8)\n    {\n        rearPosCC = vec3(0.0);\n    }\n    else\n    {\n        float rear_zDist = rearLinearDepth * currFar_rear; \n        rearPosCC = getViewRay(screenPos, rear_zDist);\n    }\n    \n\n}\n\nvoid posWCRelToEye_to_posLC(in vec4 posWC_relToEye, in mat4 local_mat4Inv, in vec3 localPosHIGH, in vec3 localPosLOW, inout vec3 posLC)\n{\n    vec3 highDifferenceSun = -localPosHIGH.xyz + encodedCameraPositionMCHigh;\n\tvec3 lowDifferenceSun = posWC_relToEye.xyz -localPosLOW.xyz + encodedCameraPositionMCLow;\n\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\tvec4 vPosRelToLight = local_mat4Inv * pos4Sun;\n\n\tposLC = vPosRelToLight.xyz / vPosRelToLight.w;\n}\n\nvoid checkTexCoordRange(inout vec2 texCoord)\n{\n    float error = 0.0;\n    if(texCoord.x < 0.0)\n    {\n        texCoord.x = 0.0 + error;\n    }\n    else if(texCoord.x > 1.0)\n    {\n        texCoord.x = 1.0 - error;\n    }\n\n    if(texCoord.y < 0.0)\n    {\n        texCoord.y = 0.0 + error;\n    }\n    else if(texCoord.y > 1.0)\n    {\n        texCoord.y = 1.0 - error;\n    }\n}\n\nvoid checkTexCoord3DRange(inout vec3 texCoord)\n{\n    float error = 0.0;\n    if(texCoord.x < 0.0)\n    {\n        texCoord.x = 0.0 + error;\n    }\n    else if(texCoord.x > 1.0)\n    {\n        texCoord.x = 1.0 - error;\n    }\n\n    if(texCoord.y < 0.0)\n    {\n        texCoord.y = 0.0 + error;\n    }\n    else if(texCoord.y > 1.0)\n    {\n        texCoord.y = 1.0 - error;\n    }\n\n    if(texCoord.z < 0.0)\n    {\n        texCoord.z = 0.0 + error;\n    }\n    else if(texCoord.z > 1.0)\n    {\n        texCoord.z = 1.0 - error;\n    }\n}\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col_mosaic, in int row_mosaic)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    checkTexCoordRange(subTexCoord);\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    float s = float(col_mosaic) * sRange + subTexCoord.x * sRange;\n    float t = float(row_mosaic) * tRange + subTexCoord.y * tRange;\n\n    // must check if the texCoord_tl is boundary in x & y.***************************************************************************\n    float mosaicTexSize_x = float(u_texSize[0] * u_mosaicSize[0]); // for example : 150 pixels * 3 columns = 450 pixels.***\n    float mosaicTexSize_y = float(u_texSize[1] * u_mosaicSize[1]); // for example : 150 pixels * 3 rows = 450 pixels.***\n\n    float currMosaicStart_x = float(col_mosaic * u_texSize[0]);\n    float currMosaicStart_y = float(row_mosaic * u_texSize[1]);\n    float currMosaicEnd_x = currMosaicStart_x + float(u_texSize[0]);\n    float currMosaicEnd_y = currMosaicStart_y + float(u_texSize[1]);\n\n    float pixel_x = s * mosaicTexSize_x;\n    float pixel_y = t * mosaicTexSize_y;\n\n    if(pixel_x < currMosaicStart_x + 1.0)\n    {\n        pixel_x = currMosaicStart_x + 1.0;\n    }\n    else if(pixel_x > currMosaicEnd_x - 1.0)\n    {\n        pixel_x = currMosaicEnd_x - 1.0;\n    }\n\n    if(pixel_y < currMosaicStart_y + 1.0)\n    {\n        pixel_y = currMosaicStart_y + 1.0;\n    }\n    else if(pixel_y > currMosaicEnd_y - 1.0)\n    {\n        pixel_y = currMosaicEnd_y - 1.0;\n    }\n\n    s = pixel_x / mosaicTexSize_x;\n    t = pixel_y / mosaicTexSize_y;\n\n\n    vec2 resultTexCoord = vec2(s, t);\n\n    return resultTexCoord;\n}\n\n\n\nfloat getPollution_inMosaicTexture(in vec2 texCoord)\n{\n    checkTexCoordRange(texCoord);\n    vec4 color4;\n    color4 = texture2D(pollutionMosaicTex, texCoord);\n    float decoded = unpackDepth(color4); // 32bit.\n    float pollution = decoded * u_minMaxPollutionValues.y;\n\n    return pollution;\n}\n\nfloat _getPollution_triLinearInterpolation(in vec2 subTexCoord2d, in int col_mosaic, in int row_mosaic)\n{\n    // This function : given a subTexture2d(real texCoord.xy of a realTex3D), \n    // and the col & row into the mosaic texture, returns a trilinear interpolation of the pressure.***\n\n    //************************************************************************************\n    // u_texSize[3]; // The original texture3D size.***\n    // mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    //------------------------------------------------------------------------------------\n\n    checkTexCoordRange(subTexCoord2d);\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec2 px = 1.0 / sim_res3d.xy;\n    vec2 vc = (floor(subTexCoord2d * sim_res3d.xy)) * px;\n    vec2 f = fract(subTexCoord2d * sim_res3d.xy);\n    vec2 texCoord_tl = vec2(vc);\n\n    \n    \n\n    vec2 texCoord_tr = vec2(vc + vec2(px.x, 0));\n    vec2 texCoord_bl = vec2(vc + vec2(0, px.y));\n    vec2 texCoord_br = vec2(vc + vec2(px.x, px.y));\n\n    checkTexCoordRange(texCoord_tl);\n    checkTexCoordRange(texCoord_tr);\n    checkTexCoordRange(texCoord_bl);\n    checkTexCoordRange(texCoord_br);\n    vec2 mosaicTexCoord_tl = subTexCoord_to_texCoord(texCoord_tl, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_tr = subTexCoord_to_texCoord(texCoord_tr, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_bl = subTexCoord_to_texCoord(texCoord_bl, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_br = subTexCoord_to_texCoord(texCoord_br, col_mosaic, row_mosaic);\n\n    // vec2 mosaicTexCoord_tl = subTexCoord_to_texCoord(texCoord_tl, col_mosaic, row_mosaic);\n    // vec2 mosaicTexCoord_tr = vec2(mosaicTexCoord_tl + vec2(px.x, 0));\n    // vec2 mosaicTexCoord_bl = vec2(mosaicTexCoord_tl + vec2(0, px.y));\n    // vec2 mosaicTexCoord_br = vec2(mosaicTexCoord_tl + vec2(px.x, px.y));\n\n\n    float ap_tl = getPollution_inMosaicTexture(mosaicTexCoord_tl);\n    float ap_tr = getPollution_inMosaicTexture(mosaicTexCoord_tr);\n    float ap_bl = getPollution_inMosaicTexture(mosaicTexCoord_bl);\n    float ap_br = getPollution_inMosaicTexture(mosaicTexCoord_br);\n\n    float airPressure = mix(mix(ap_tl, ap_tr, f.x), mix(ap_bl, ap_br, f.x), f.y);\n\n    return airPressure;\n}\n\n\nfloat _getPollution_nearest(in vec2 subTexCoord2d, in int col_mosaic, in int row_mosaic)\n{\n    // This function : given a subTexture2d(real texCoord.xy of a realTex3D), \n    // and the col & row into the mosaic texture, returns a nearest interpolation of the pressure.***\n    checkTexCoordRange(subTexCoord2d);\n    vec2 mosaicTexCoord = subTexCoord_to_texCoord(subTexCoord2d, col_mosaic, row_mosaic);\n    float ap = getPollution_inMosaicTexture(mosaicTexCoord);\n    return ap;\n}\n\nbool getUpDownSlicesIdx(in vec3 posLC, inout int sliceDownIdx, inout int sliceUpIdx, inout float distUp, inout float distDown)\n{\n    // uMinMaxAltitudeSlices[32]; // limited to 32 slices.***\n    // u_texSize[3] =  The original texture3D size.***\n    float altitude = posLC.z;\n    int currSliceIdx = -1;\n    for(int i=0; i<32; i++)\n    {\n        if(altitude >= uMinMaxAltitudeSlices[i].x && altitude < uMinMaxAltitudeSlices[i].y)\n        {\n            currSliceIdx = i;\n            break;\n        }\n    }\n\n    if(currSliceIdx < 0)\n    {\n        return false;\n    }\n\n    if(currSliceIdx == 0)\n    {\n        sliceDownIdx = currSliceIdx;\n        sliceUpIdx = currSliceIdx;\n    }\n    else\n    {\n        sliceDownIdx = currSliceIdx-1;\n        sliceUpIdx = currSliceIdx;\n    }\n\n    if(sliceUpIdx > u_texSize[2] - 1)\n    {\n        sliceUpIdx = u_texSize[2] - 1;\n    }\n\n    // +------------------------------+ <- sliceUp\n    //                 |\n    //                 |\n    //                 |  distUp\n    //                 |\n    //                 * <- posL.z\n    //                 |\n    //                 |  distDown\n    // +------------------------------+ <- sliceDown\n    float sliceUpAltitude = 0.0;\n    float sliceDownAltitude = 0.0;\n    for(int i=0; i<32; i++)\n    {\n        if(sliceUpIdx == i)\n        {\n            sliceUpAltitude = uMinMaxAltitudeSlices[i].y;\n            sliceDownAltitude = uMinMaxAltitudeSlices[i].x;\n            break;\n        }\n    }\n\n    distUp = abs(sliceUpAltitude - altitude);\n    distDown = abs(altitude - sliceDownAltitude);\n\n    return true;\n}\n\nbool getUpDownSlicesIdx_FAST(in vec3 posLC, inout int sliceDownIdx, inout int sliceUpIdx)\n{\n    // uMinMaxAltitudeSlices[32]; // limited to 32 slices.***\n    // u_texSize[3] =  The original texture3D size.***\n    float altitude = posLC.z;\n    int currSliceIdx = -1;\n    for(int i=0; i<32; i++)\n    {\n        if(altitude >= uMinMaxAltitudeSlices[i].x && altitude < uMinMaxAltitudeSlices[i].y)\n        {\n            currSliceIdx = i;\n            break;\n        }\n    }\n\n    if(currSliceIdx < 0)\n    {\n        return false;\n    }\n\n    if(currSliceIdx == 0)\n    {\n        sliceDownIdx = currSliceIdx;\n        sliceUpIdx = currSliceIdx;\n    }\n    else\n    {\n        sliceDownIdx = currSliceIdx-1;\n        sliceUpIdx = currSliceIdx;\n    }\n\n    if(sliceUpIdx > u_texSize[2] - 1)\n    {\n        sliceUpIdx = u_texSize[2] - 1;\n    }\n\n    return true;\n}\n\nbool get_pollution_fromTexture3d_triLinearInterpolation_FAST(in vec3 texCoord3d, in vec3 posLC, inout float airPressure)\n{\n    // Here is not important the pollution value. Only need know if the pollution value is zero or not.***\n    // this function is called by "findFirstSamplePosition".***\n    // tex3d : airPressureMosaicTex\n\n    // 1rst, determine the sliceIdx.***\n    int currSliceIdx_down = -1;\n    int currSliceIdx_up = -1;\n    float distUp = 0.0;\n    float distDown = 0.0;\n\n    if(!getUpDownSlicesIdx_FAST(posLC, currSliceIdx_down, currSliceIdx_up))\n    {\n        return false;\n    }\n\n    float distUpAndDown = distUp + distDown;\n    float distUpRatio = distUp / distUpAndDown;\n    float distDownRatio = distDown / distUpAndDown;\n\n    // Down slice.************************************************************\n    int col_down, row_down;\n    //if(currSliceIdx_down <= u_mosaicSize[0])\n    //{\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n    //    row_down = 0;\n    //    col_down = currSliceIdx_down;\n    //}\n    //else\n    {\n        float rowAux = floor(float(currSliceIdx_down) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_down) - (rowAux * float(u_mosaicSize[0]));\n\n        col_down = int(colAux);\n        row_down = int(rowAux);\n    }\n\n    float airPressure_down = _getPollution_nearest(texCoord3d.xy, col_down, row_down);\n\n    if(airPressure_down > 0.0)\n    {\n        airPressure = airPressure_down;\n        return true;\n    }\n\n    // up slice.************************************************************\n    int col_up, row_up;\n    if(currSliceIdx_up <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_up is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row_up = 0;\n        col_up = currSliceIdx_up;\n    }\n    else\n    {\n        float rowAux = floor(float(currSliceIdx_up) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_up) - (rowAux * float(u_mosaicSize[0]));\n\n        col_up = int(colAux);\n        row_up = int(rowAux);\n    }\n\n    // test.***\n    col_up = col_down + 1;\n    row_up = row_down;\n    if(col_up >= u_mosaicSize[0])\n    {\n        col_up = 0;\n        row_up = row_down + 1;\n    }\n\n    if(row_up >= u_mosaicSize[1])\n    {\n        return false;\n    }\n\n    float airPressure_up = _getPollution_nearest(texCoord3d.xy, col_up, row_up);\n    if(airPressure_up > 0.0)\n    {\n        airPressure = airPressure_up;\n        return true;\n    }\n\n\n    return false;\n}\n\nbool get_pollution_fromTexture3d_triLinearInterpolation(in vec3 texCoord3d, in vec3 posLC, inout float airPressure)\n{\n    // tex3d : airPressureMosaicTex\n    // 1rst, check texCoord3d boundary limits.***\n    float error = 0.001;\n    // if(texCoord3d.x < 0.0 + error || texCoord3d.x > 1.0 - error)\n    // {\n    //     return false;\n    // }\n\n    // if(texCoord3d.y < 0.0 + error || texCoord3d.y > 1.0 - error)\n    // {\n    //     return false;\n    // }\n\n    // if(texCoord3d.z < 0.0 + error || texCoord3d.z > 1.0 - error)\n    // {\n    //     return false;\n    // }\n    // 1rst, determine the sliceIdx.***\n    int currSliceIdx_down = -1;\n    int currSliceIdx_up = -1;\n    float distUp = 0.0;\n    float distDown = 0.0;\n\n    if(!getUpDownSlicesIdx(posLC, currSliceIdx_down, currSliceIdx_up, distUp, distDown))\n    {\n        return false;\n    }\n\n    float distUpAndDown = distUp + distDown;\n    float distUpRatio = distUp / distUpAndDown;\n    float distDownRatio = distDown / distUpAndDown;\n\n    // Down slice.************************************************************\n    int col_down, row_down;\n    //if(currSliceIdx_down <= u_mosaicSize[0])\n    //{\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n    //    row_down = 0;\n    //    col_down = currSliceIdx_down;\n    //}\n    //else\n    {\n        float rowAux = floor(float(currSliceIdx_down) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_down) - (rowAux * float(u_mosaicSize[0]));\n\n        col_down = int(colAux);\n        row_down = int(rowAux);\n    }\n\n    float airPressure_down = _getPollution_triLinearInterpolation(texCoord3d.xy, col_down, row_down);\n\n    // up slice.************************************************************\n    int col_up, row_up;\n    if(currSliceIdx_up <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_up is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row_up = 0;\n        col_up = currSliceIdx_up;\n    }\n    else\n    {\n        float rowAux = floor(float(currSliceIdx_up) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_up) - (rowAux * float(u_mosaicSize[0]));\n\n        col_up = int(colAux);\n        row_up = int(rowAux);\n    }\n\n    // test.***\n    col_up = col_down + 1;\n    row_up = row_down;\n    if(col_up >= u_mosaicSize[0])\n    {\n        col_up = 0;\n        row_up = row_down + 1;\n    }\n\n    if(row_up >= u_mosaicSize[1])\n    {\n        return false;\n    }\n\n    float airPressure_up = _getPollution_triLinearInterpolation(texCoord3d.xy, col_up, row_up);\n\n    airPressure = mix(airPressure_down, airPressure_up, distDownRatio);\n    //airPressure = mix(airPressure_down, airPressure_up, 0.5);\n\n    return true;\n}\n\nbool get_pollution_fromTexture3d_triLinearInterpolation_original(in vec3 texCoord3d, inout float airPressure)\n{\n    // This function is used if all slices of the texture3d has same altitude differences.***\n    //---------------------------------------------------------------------------------------\n    // tex3d : airPressureMosaicTex\n    // 1rst, check texCoord3d boundary limits.***\n    if(texCoord3d.x < 0.0 || texCoord3d.x > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.y < 0.0 || texCoord3d.y > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.z < 0.0 || texCoord3d.z > 1.0)\n    {\n        return false;\n    }\n    // 1rst, determine the sliceIdx.***\n    // u_texSize[3]; // The original texture3D size.***\n    int slicesCount = u_texSize[2];\n\n    float currSliceIdx_float = texCoord3d.z * float(slicesCount - 1);\n    int currSliceIdx_down = int(floor(currSliceIdx_float));\n    int currSliceIdx_up = currSliceIdx_down + 1;\n\n    if(currSliceIdx_up >= u_texSize[2])\n    {\n        return false;\n    }\n\n    // now, calculate the mod.***\n    //float remain = currSliceIdx_float -  floor(currSliceIdx_float);\n    float remain = fract(currSliceIdx_float);\n\n    // Now, calculate the "col" & "row" in the mosaic texture3d.***\n    // u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n\n    // Down slice.************************************************************\n    int col_down, row_down;\n    //if(currSliceIdx_down <= u_mosaicSize[0])\n    //{\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n    //    row_down = 0;\n    //    col_down = currSliceIdx_down;\n   // }\n    //else\n    {\n        float rowAux = floor(float(currSliceIdx_down) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_down) - (rowAux * float(u_mosaicSize[0]));\n\n        col_down = int(colAux);\n        row_down = int(rowAux);\n    }\n\n    // now, must calculate the mosaicTexCoord.***\n    vec2 mosaicTexCoord_down = subTexCoord_to_texCoord(texCoord3d.xy, col_down, row_down);\n    \n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec2 px = 1.0 / sim_res3d.xy;\n    vec2 vc = (floor(texCoord3d.xy * sim_res3d.xy)) * px;\n    vec3 f = fract(texCoord3d * sim_res3d);\n\n    float airPressure_down = _getPollution_triLinearInterpolation(texCoord3d.xy, col_down, row_down);\n\n    // up slice.************************************************************\n    int col_up, row_up;\n    if(currSliceIdx_up <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_up is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row_up = 0;\n        col_up = currSliceIdx_up;\n    }\n    else\n    {\n        float rowAux = floor(float(currSliceIdx_up) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_up) - (rowAux * float(u_mosaicSize[0]));\n\n        col_up = int(colAux);\n        row_up = int(rowAux);\n    }\n\n    // test.***\n    col_up = col_down + 1;\n    row_up = row_down;\n    if(col_up >= u_mosaicSize[0])\n    {\n        col_up = 0;\n        row_up = row_down + 1;\n    }\n\n    if(row_up >= u_mosaicSize[1])\n    {\n        return false;\n    }\n\n    float airPressure_up = _getPollution_triLinearInterpolation(texCoord3d.xy, col_up, row_up);\n\n    airPressure = mix(airPressure_down, airPressure_up, f.z);\n    //airPressure = airPressure_down; // test delete.***\n    return true;\n}\n\nbool get_pollution_fromTexture3d_nearest(in vec3 texCoord3d, inout float airPressure)\n{\n    // tex3d : airPressureMosaicTex\n    // 1rst, check texCoord3d boundary limits.***\n    if(texCoord3d.x < 0.0 || texCoord3d.x > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.y < 0.0 || texCoord3d.y > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.z < 0.0 || texCoord3d.z > 1.0)\n    {\n        return false;\n    }\n    // 1rst, determine the sliceIdx.***\n    int slicesCount = u_texSize[2];\n\n    float currSliceIdx_float = texCoord3d.z * float(slicesCount -  1);\n    int currSliceIdx_down = int(floor(currSliceIdx_float));\n    int currSliceIdx_up = currSliceIdx_down + 1;\n    int currSliceIdx = currSliceIdx_down;\n\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    //vec2 px = 1.0 / sim_res3d.xy;\n    //vec2 vc = (floor(texCoord3d.xy * sim_res3d.xy)) * px;\n    vec3 f = fract(texCoord3d * sim_res3d);\n\n    if(f.z > 0.5)\n    {\n        currSliceIdx = currSliceIdx_up;\n    }\n\n    if(currSliceIdx >= u_texSize[2])\n    {\n        return false;\n    }\n\n    // ************************************************************\n    int col, row;\n    //if(currSliceIdx <= u_mosaicSize[0])\n    //{\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n    //    row = 0;\n   //     col = currSliceIdx;\n   /// }\n    //else\n    {\n        float mosaicSize_x = float(u_mosaicSize[0]);\n        float rowAux = floor(float(currSliceIdx) / mosaicSize_x);\n        float colAux = float(currSliceIdx) - (rowAux * mosaicSize_x);\n\n        col = int(colAux);\n        row = int(rowAux);\n    }\n\n    // now, must calculate the mosaicTexCoord.***\n\n    airPressure = _getPollution_nearest(texCoord3d.xy, col, row);\n\n    return true;\n}\n\nvec4 getRainbowColor_byHeight(in float height, in float minHeight_rainbow, in float maxHeight_rainbow, bool hotToCold)\n{\n    \n    float gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\n    float value = gray * 4.0;\n    float h = floor(value);\n    float f = fract(value);\n\n    // test.***\n    if(gray > 0.0000001)\n    {\n        //gray = 0.95;\n    }\n\n    vec4 resultColor = vec4(0.0, 0.0, 0.0, (gray));\n\n    if(hotToCold)\n    {\n        // HOT to COLD.***\n        resultColor.rgb = vec3(1.0, 0.0, 0.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix red & yellow.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(red, yellow, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix yellow & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, green, f);\n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & cyan.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(green, cyan, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix cyan & blue.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, blue, f);\n        }\n    }\n    else\n    {\n        // COLD to HOT.***\n        resultColor.rgb = vec3(0.0, 0.0, 1.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix blue & cyan.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(blue, cyan, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix cyan & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, green, f);  \n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & yellow.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(green, yellow, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix yellow & red.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, red, f);\n        }\n    }\n\n    return resultColor;\n}\n\nvec3 getRainbowColor_byHeight_original(in float height, in float minHeight_rainbow, in float maxHeight_rainbow)\n{\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\n// https://www.willusher.io/webgl/2019/01/13/volume-rendering-with-webgl\n// The transfer function specifies what color and opacity value should be assigned for a given value sampled from the volume. \n//--------------------------------------------------------------------------------------------------------------------------\n\n// https://developer.nvidia.com/gpugems/gpugems/part-vi-beyond-triangles/chapter-39-volume-rendering-techniques\n//--------------------------------------------------------------------------------------------------------------------------\n\n/*\n// https://martinopilia.com/posts/2018/09/17/volume-raycasting.html\n// Estimate the normal from a finite difference approximation of the gradient\nvec3 normal(vec3 position, float intensity)\n{\n    float d = step_length;\n    float dx = texture(volume, position + vec3(d,0,0)).r - intensity;\n    float dy = texture(volume, position + vec3(0,d,0)).r - intensity;\n    float dz = texture(volume, position + vec3(0,0,d)).r - intensity;\n    return -normalize(NormalMatrix * vec3(dx, dy, dz));\n}*/\n\nbool normalLC(vec3 texCoord3d, in vec3 posLC, inout vec3 result_normal)\n{\n    // Estimate the normal from a finite difference approximation of the gradient\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec3 pix = 1.0 / sim_res3d;\n\n    checkTexCoord3DRange(texCoord3d);\n\n    vec3 vc = texCoord3d;\n\n    // dx.*************************************************\n    float airPressure_dx = 0.0;\n    vec3 velocity_dx;\n    vec3 texCoord3d_dx = vec3(vc + vec3(pix.x, 0.0, 0.0));\n    bool succes_dx =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dx, posLC, airPressure_dx);\n    if(!succes_dx)return false;\n\n    float airPressure_dx_neg = 0.0;\n    vec3 velocity_dx_neg;\n    vec3 texCoord3d_dx_neg = vec3(vc - vec3(pix.x, 0.0, 0.0));\n    bool succes_dx_neg =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dx_neg, posLC, airPressure_dx_neg);\n    if(!succes_dx_neg)return false;\n\n    // dy.*************************************************\n    float airPressure_dy = 0.0;\n    vec3 velocity_dy;\n    vec3 texCoord3d_dy = vec3(vc + vec3(0.0, pix.y, 0.0));\n    bool succes_dy =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dy, posLC, airPressure_dy);\n    if(!succes_dy)return false;\n\n    float airPressure_dy_neg = 0.0;\n    vec3 velocity_dy_neg;\n    vec3 texCoord3d_dy_neg = vec3(vc - vec3(0.0, pix.y, 0.0));\n    bool succes_dy_neg =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dy_neg, posLC, airPressure_dy_neg);\n    if(!succes_dy_neg)return false;\n\n    // dz.*************************************************\n    float airPressure_dz = 0.0;\n    vec3 velocity_dz;\n    vec3 texCoord3d_dz = vec3(vc + vec3(0.0, 0.0, pix.z));\n    bool succes_dz =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dz, posLC, airPressure_dz);\n    if(!succes_dz)return false;\n\n    float airPressure_dz_neg = 0.0;\n    vec3 velocity_dz_neg;\n    vec3 texCoord3d_dz_neg = vec3(vc - vec3(0.0, 0.0, pix.z));\n    bool succes_dz_neg =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dz_neg, posLC, airPressure_dz_neg);\n    if(!succes_dz_neg)return false;\n\n    //result_normal = normalize(vec3(airPressure_dx - pressure, airPressure_dy - pressure, airPressure_dz - pressure));\n    result_normal = normalize(vec3(airPressure_dx - airPressure_dx_neg, airPressure_dy - airPressure_dy_neg, airPressure_dz - airPressure_dz_neg));\n\n    if(abs(result_normal.x) > 0.0 || abs(result_normal.y) > 0.0 || abs(result_normal.z) > 0.0 )\n    {\n        return true;\n    }\n    else return false;\n\n    return true;\n}\n\nvec4 transfer_fnc(in float pressure)\n{\n    // The transfer function specifies what color and opacity value should be assigned for a given value sampled from the volume. \n    //float maxPressureRef = 1.05;\n    //float minPressureRef = u_airEnvirontmentPressure;\n    float maxPressureRef = u_minMaxPollutionValues.y; // test.***\n    float minPressureRef = u_minMaxPollutionValues.x; // test.***\n    bool bHotToCold = false; // we want coldToHot (blue = min to red = max).***\n    vec4 rainbowCol3 = getRainbowColor_byHeight(pressure, minPressureRef, maxPressureRef, bHotToCold);\n\n    return rainbowCol3;\n}\n\nbool isSimulationBoxEdge(vec2 screenPos)\n{\n    // This function is used to render the simulation box edges.***\n    // check the normals.***\n    vec2 frontTexCoord;\n    vec2 rearTexCoord;\n    get_FrontAndRear_depthTexCoords(screenPos, frontTexCoord, rearTexCoord);\n    float pixelSize_x = 1.0 / (u_screenSize.x * 2.0);\n    float pixelSize_y = 1.0 / u_screenSize.y;\n    \n    // check front.***\n    vec4 normal4front = getNormal_simulationBox(frontTexCoord);\n    vec4 normal4front_up = getNormal_simulationBox(vec2(frontTexCoord.x, frontTexCoord.y + pixelSize_y));\n\n    if(dot(normal4front.xyz, normal4front_up.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4front_left = getNormal_simulationBox(vec2(frontTexCoord.x - pixelSize_x, frontTexCoord.y));    \n    if(dot(normal4front.xyz, normal4front_left.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4front_down = getNormal_simulationBox(vec2(frontTexCoord.x, frontTexCoord.y - pixelSize_y));    \n    if(dot(normal4front.xyz, normal4front_down.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4front_rigth = getNormal_simulationBox(vec2(frontTexCoord.x + pixelSize_x, frontTexCoord.y));    \n    if(dot(normal4front.xyz, normal4front_rigth.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    // now, check the rear normals.***\n    vec4 normal4rear = getNormal_simulationBox(rearTexCoord);\n    vec4 normal4rear_up = getNormal_simulationBox(vec2(rearTexCoord.x, rearTexCoord.y + pixelSize_y));\n\n    if(dot(normal4rear.xyz, normal4rear_up.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4rear_left = getNormal_simulationBox(vec2(rearTexCoord.x - pixelSize_x, rearTexCoord.y));    \n    if(dot(normal4rear.xyz, normal4rear_left.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4rear_down = getNormal_simulationBox(vec2(rearTexCoord.x, rearTexCoord.y - pixelSize_y));    \n    if(dot(normal4rear.xyz, normal4rear_down.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4rear_rigth = getNormal_simulationBox(vec2(rearTexCoord.x + pixelSize_x, rearTexCoord.y));    \n    if(dot(normal4rear.xyz, normal4rear_rigth.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    return false;\n}\n\nbool findFirstSamplePosition(in vec3 frontPosLC, in vec3 rearPosLC, in vec3 samplingDirLC, in float increLength, in vec3 simulBoxRange, inout vec3 result_samplePos, inout int iteration)\n{\n    // This function finds the first sample position.***\n    // Here is not important the pollution value. Only need know if the pollution value is zero or not.***\n    float contaminationSample = 0.0;\n    vec3 samplePosLC;\n    vec3 samplePosLC_prev;\n    for(int i=0; i<30; i++)\n    {\n        // Note : for each smple, must depth check with the scene depthTexure.***\n        float dist = float(i) * increLength;\n        samplePosLC = frontPosLC + samplingDirLC * dist;\n        iteration = i;\n\n        if(i == 0)\n        {\n            samplePosLC_prev = samplePosLC;\n        }\n\n        contaminationSample = 0.0;\n        vec3 sampleTexCoord3d = vec3((samplePosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (samplePosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (samplePosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n        checkTexCoord3DRange(sampleTexCoord3d);\n\n        if(get_pollution_fromTexture3d_triLinearInterpolation_FAST(sampleTexCoord3d, samplePosLC, contaminationSample))\n        {\n            if(contaminationSample > u_minMaxPollutionValues[0])\n            {\n                if(i > 0)\n                {\n                    // check the prev semiPos.***\n                    vec3 samplePosLC_semiPrev = samplePosLC - samplingDirLC * increLength * 0.5;\n                    if(get_pollution_fromTexture3d_triLinearInterpolation_FAST(sampleTexCoord3d, samplePosLC_semiPrev, contaminationSample))\n                    {\n                        if(contaminationSample > u_minMaxPollutionValues[0])\n                        {\n                            result_samplePos = samplePosLC_prev;\n                            return true;\n                        }\n                        else\n                        {\n                            //result_samplePos = (samplePosLC + samplePosLC_prev) * 0.5;\n                            result_samplePos = samplePosLC_semiPrev;\n                            return true;\n                        }\n                    }\n                }\n\n                //result_samplePos = (samplePosLC + samplePosLC_prev) * 0.5;\n                result_samplePos = samplePosLC_prev;\n                return true;\n            }\n        }\n        //currSamplePosLC += step_vector_LC;\n        samplePosLC_prev = samplePosLC;\n    }\n\n    return false;\n}\n\nvoid main(){\n\n    // 1rst, read front depth & rear depth and check if exist rear depth.***\n    // If no exist rear depth, then discard.***\n    //vec2 screenPos = vec2(gl_FragCoord.x / u_screenSize.x, gl_FragCoord.y / u_screenSize.y); // \n    vec2 screenPos = v_tex_pos;\n\n    if(isSimulationBoxEdge(screenPos))\n    {\n        vec4 edgeColor = vec4(0.25, 0.5, 0.99, 1.0);\n        gl_FragData[0] = edgeColor;\n\n        #ifdef USE_MULTI_RENDER_TARGET\n            gl_FragData[1] = edgeColor;\n            gl_FragData[2] = edgeColor;\n            gl_FragData[3] = edgeColor;\n        #endif\n        return;\n    }\n\n    // read normal in rear depth. If no exist normal, then, discard.***\n    // calculate the texCoord for rear normal:\n    vec2 frontTexCoord;\n    vec2 rearTexCoord;\n    get_FrontAndRear_depthTexCoords(screenPos, frontTexCoord, rearTexCoord);\n\n    vec4 encodedNormal = texture2D(simulationBoxDoubleNormalTex, frontTexCoord);\n\tif(length(encodedNormal.xyz) < 0.1)\n    {\n        vec4 encodedNormal_rear = texture2D(simulationBoxDoubleNormalTex, rearTexCoord);\n        if(length(encodedNormal_rear.xyz) < 0.1)\n        {\n            discard;\n        }\n        //discard;\n    }\n\n    vec4 normal4rear = getNormal_simulationBox(rearTexCoord);\n    vec4 normal4front = getNormal_simulationBox(frontTexCoord);\n\tvec3 normal = normal4front.xyz;\n\n    // 1rst, know the scene depth.***\n    vec4 normal4scene = getNormal(v_tex_pos);\n    int estimatedFrustumIdx = int(floor(normal4scene.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_scene = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear_scene = nearFar_scene.x; // no used in this shader.***\n\tfloat currFar_scene = nearFar_scene.y;\n    float sceneLinearDepth = getDepth(v_tex_pos);\n    float distToCam = sceneLinearDepth * currFar_scene;\n    vec3 sceneDepthPosCC = getViewRay(v_tex_pos, distToCam - 1.0);\n\n    \n\n    // Now, calculate the positions with the simulation box, front & rear.***\n    // rear.***\n\testimatedFrustumIdx = int(floor(normal4rear.w * 100.0));\n\tdataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tcurrFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_rear = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear_rear = nearFar_rear.x; // no used in this shader.***\n\tfloat currFar_rear = nearFar_rear.y;\n\n    // front.***\n    estimatedFrustumIdx = int(floor(normal4front.w * 100.0));\n\tcurrFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_front = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear_front = nearFar_front.x; // no used in this shader.***\n\tfloat currFar_front = nearFar_front.y;\n\n    // Now, calculate the rearPosCC & frontPosCC.***\n    vec3 frontPosCC;\n    vec3 rearPosCC;\n    get_FrontAndRear_posCC(screenPos, currFar_rear, currFar_front, frontPosCC, rearPosCC);\n\n    \n    \n\n    // Now, calculate frontPosWC & rearPosWC.***\n    vec4 frontPosWCRelToEye = modelViewMatrixRelToEyeInv * vec4(frontPosCC.xyz, 1.0);\n    vec4 rearPosWCRelToEye = modelViewMatrixRelToEyeInv * vec4(rearPosCC.xyz, 1.0);\n    //vec4 scenePosWCRelToEye = modelViewMatrixRelToEyeInv * vec4(sceneDepthPosCC.xyz, 1.0);\n\n    // Now, calculate frontPosLC & rearPosLC.***\n    vec3 frontPosLC;\n    vec3 rearPosLC;\n    //vec3 scenePosLC;\n    posWCRelToEye_to_posLC(frontPosWCRelToEye, u_simulBoxTMatInv, u_simulBoxPosHigh, u_simulBoxPosLow, frontPosLC);\n    posWCRelToEye_to_posLC(rearPosWCRelToEye, u_simulBoxTMatInv, u_simulBoxPosHigh, u_simulBoxPosLow, rearPosLC);\n\n    // Now, with "frontPosLC" & "rearPosLC", calculate the frontTexCoord3d & rearTexCoord3d.***\n    vec3 simulBoxRange = vec3(u_simulBoxMaxPosLC.x - u_simulBoxMinPosLC.x, u_simulBoxMaxPosLC.y - u_simulBoxMinPosLC.y, u_simulBoxMaxPosLC.z - u_simulBoxMinPosLC.z);\n\n    float contaminationSample = 0.0;\n    float smplingCount = 0.0;\n    float segmentLength = distance(rearPosLC, frontPosLC);\n    vec3 samplingDirLC = normalize(rearPosLC - frontPosLC);\n    //vec3 samplingDirCC = normalize(rearPosCC - frontPosCC);\n    float samplingsCount = 30.0;\n    float increLength = segmentLength / samplingsCount;\n    if(increLength < u_voxelSizeMeters.x)\n    {\n        //increLength = u_voxelSizeMeters.x;\n    }\n\n    //vec3 camRay = normalize(getViewRay(v_tex_pos, 1.0));\n    vec3 camRay = normalize(sceneDepthPosCC);\n\n    vec4 color4Aux = vec4(0.0, 0.0, 0.0, 0.0);\n\n    vec3 currSamplePosLC = vec3(frontPosLC);\n    vec3 step_vector_LC = samplingDirLC * increLength;\n    vec4 finalColor4 = vec4(0.0);\n    float contaminationAccum = 0.0;\n    // u_minMaxPollutionValues\n\n    vec3 firstPosLC = vec3(frontPosLC);\n    int iteration = 0;\n    if(!findFirstSamplePosition(frontPosLC, rearPosLC, samplingDirLC, increLength, simulBoxRange, firstPosLC, iteration))\n    {\n        \n        // vec4 colorDiscard = vec4(0.3, 0.3, 0.3, 1.0);\n        // gl_FragData[0] = colorDiscard;\n\n        // #ifdef USE_MULTI_RENDER_TARGET\n        //     gl_FragData[1] = colorDiscard;\n        //     gl_FragData[2] = colorDiscard;\n        //     gl_FragData[3] = colorDiscard;\n        // #endif\n        \n        return;\n    }\n    \n\n    // recalculate segmentLength & increLength.***\n    samplingsCount = 30.0;\n    segmentLength = distance(rearPosLC, firstPosLC);\n    increLength = segmentLength / samplingsCount;\n\n    vec4 colorTest = vec4(0.0, 0.0, 0.5, 1.0);\n    colorTest = vec4(firstPosLC.x /u_voxelSizeMeters.x, firstPosLC.y /u_voxelSizeMeters.y, firstPosLC.z /u_voxelSizeMeters.z , 1.0);\n\n    // if(iteration == 0)\n    // {\n    //     colorTest = vec4(1.0, 0.0, 0.0, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    // else if(iteration == 1)\n    // {\n    //     colorTest = vec4(0.0, 1.0, 0.0, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    // else if(iteration == 2)\n    // {\n    //     colorTest = vec4(0.0, 0.0, 1.0, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    // else if(iteration == 3)\n    // {\n    //     colorTest = vec4(1.0, 1.0, 0.0, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    // else if(iteration == 4)\n    // {\n    //     colorTest = vec4(1.0, 0.0, 1.0, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    // else if(iteration == 5)\n    // {\n    //     colorTest = vec4(0.0, 1.0, 1.0, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    // else if(iteration == 6)\n    // {\n    //     colorTest = vec4(0.5, 0.0, 0.0, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    // else if(iteration == 7)\n    // {\n    //     colorTest = vec4(0.0, 0.5, 0.0, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    // else if(iteration == 8)\n    // {\n    //     colorTest = vec4(0.0, 0.0, 0.5, 1.0);\n    //     gl_FragData[0] = colorTest;\n\n    //     #ifdef USE_MULTI_RENDER_TARGET\n    //         gl_FragData[1] = colorTest;\n    //         gl_FragData[2] = colorTest;\n    //         gl_FragData[3] = colorTest;\n    //     #endif\n    //     return;\n    // }\n    \n    // Sampling far to near.***\n    bool normalLC_calculated = true;\n    for(int i=0; i<30; i++)\n    {\n        \n        // Note : for each smple, must depth check with the scene depthTexure.***\n        vec3 samplePosLC = firstPosLC + samplingDirLC * increLength * float(i);\n\n        //vec3 samplePosCC = firstPosLC + samplingDirCC * increLength * float(i);\n        //if(abs(samplePosCC.z) > distToCam)\n        //{\n        //    break;\n        //}\n\n        contaminationSample = 0.0;\n        vec3 sampleTexCoord3d = vec3((samplePosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (samplePosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (samplePosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n        checkTexCoord3DRange(sampleTexCoord3d);\n\n        if(get_pollution_fromTexture3d_triLinearInterpolation(sampleTexCoord3d, samplePosLC, contaminationSample))\n        {\n            vec3 currNormalLC;\n            //if(!normalLC(sampleTexCoord3d, samplePosLC, currNormalLC))\n            //{\n           //     normalLC_calculated = false;\n            //    continue;\n            //}\n\n            vec4 currColor4 = transfer_fnc(contaminationSample);\n            currColor4 = getRainbowColor_byHeight(contaminationSample, u_minMaxPollutionValues.x, u_minMaxPollutionValues.y * 0.3, false);\n            //vec3 normalizedVelocityLC = normalize(velocityLC);\n            //vec4 velocityWC = u_simulBoxTMat * vec4(velocityLC, 1.0);\n            //vec4 velocityDirCC = modelViewMatrixRelToEye * vec4(velocityWC.xyz, 1.0);\n\n            // Now, calculate alpha by normalCC.***\n            /*\n            vec4 currNormalWC = u_simulBoxTMat * vec4(currNormalLC, 1.0);\n            vec4 currNormalCC = modelViewMatrixRelToEye * vec4(currNormalWC.xyz, 1.0);\n            vec3 normalCC = normalize(currNormalCC.xyz);\n            float dotProd = dot(camRay, normalCC);\n\n            // Now, accumulate the color.***\n            if(dotProd < 0.0)\n            {\n                currColor4.rgb *= abs(dotProd);\n            }\n            */\n            \n\n            //vec4 vecAux = abs(vec4(currColor4.rgb, 1.0));\n            //currColor4.r = sampleTexCoord3d.x;\n            //currColor4.g = sampleTexCoord3d.y;\n            //currColor4.b = sampleTexCoord3d.z;\n \n            //if(length(currNormalLC) > 0.0)\n            {\n                // https://www.willusher.io/webgl/2019/01/13/volume-rendering-with-webgl\n                finalColor4.rgb += (1.0 - finalColor4.a) * currColor4.a * currColor4.rgb; // test. render normal color:\n                finalColor4.a += (1.0 - finalColor4.a) * currColor4.a;\n            }\n            \n            smplingCount += 1.0;\n\n            // Optimization: break out of the loop when the color is near opaque\n            if (finalColor4.a >= 0.95) {\n                break;\n            }\n\n            contaminationAccum += contaminationSample;\n            //finalColor4.rgb += vec3(contaminationSample, 0.0, 0.0);\n            //finalColor4.a += contaminationSample;\n            \n        }\n\n\n        currSamplePosLC += step_vector_LC;\n    }\n\n    if(smplingCount < 1.0)\n    {\n        //discard;\n    }\n\n    if(smplingCount < 1.0)\n    {\n        smplingCount = 1.0;\n    }\n    /*\n    if(smplingCount < 10.0)\n    {\n        color4Aux = vec4(1.0, 0.0, 0.0, 0.7);\n    }\n    else if(smplingCount < 20.0)\n    {\n        color4Aux = vec4(0.0, 1.0, 0.0, 0.7);\n    }\n    else if(smplingCount < 30.0)\n    {\n        color4Aux = vec4(0.0, 0.0, 1.0, 0.7);\n    }\n    else if(smplingCount < 40.0)\n    {\n        color4Aux = vec4(1.0, 1.0, 0.0, 0.7);\n    }\n    else\n    {\n        color4Aux = vec4(1.0, 0.0, 1.0, 0.7);\n    }\n    */\n\n    //vec4 rainbowColor = getRainbowColor_byHeight(contaminationAccum/smplingCount, u_minMaxPollutionValues.x, u_minMaxPollutionValues.y, false);\n\n\n    //float finalAlpha = finalColor4.a;\n    //finalAlpha *= 2.0;\n    //if(finalAlpha > 1.0)\n    //{\n    //    finalAlpha = 1.0;\n    //}\n    //finalColor4.a = finalAlpha;\n    color4Aux = finalColor4;\n\n    if(!normalLC_calculated)\n    {\n        //color4Aux = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n\n    gl_FragData[0] = color4Aux;\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = color4Aux;\n        gl_FragData[2] = color4Aux;\n        gl_FragData[3] = color4Aux;\n    #endif\n}\n\n/*\nuniform sampler3D tex;\nuniform sampler3D normals;\nuniform sampler2D colorMap;\n\nuniform mat4 transform;\nuniform int depthSampleCount;\nuniform float zScale;\n\nuniform vec3 lightPosition;\n\nuniform float brightness;\n\n//uniform vec4 opacitySettings;\n// x: minLevel\n// y: maxLevel\n// z: lowNode\n// w: highNode\n\nin vec2 texCoord;\n\n//in vec4 origin;\n//in vec4 direction;\n\nout vec4 color;\n\nvec3 ambientLight = vec3(0.34, 0.32, 0.32);\nvec3 directionalLight = vec3(0.5, 0.5, 0.5);\nvec3 lightVector = normalize(vec3(-1.0, -1.0, 1.0));\nvec3 specularColor = vec3(0.5, 0.5, 0.5);\n\nvec3 aabb[2] = vec3[2](\n\tvec3(0.0, 0.0, 0.0),\n\tvec3(1.0, 1.0, 1.0)\n);\n\nstruct Ray {\n    vec3 origin;\n    vec3 direction;\n    vec3 inv_direction;\n    int sign[3];\n};\n\nRay makeRay(vec3 origin, vec3 direction) {\n    vec3 inv_direction = vec3(1.0) / direction;\n    \n    return Ray(\n        origin,\n        direction,\n        inv_direction,\n        int[3](\n\t\t\t((inv_direction.x < 0.0) ? 1 : 0),\n\t\t\t((inv_direction.y < 0.0) ? 1 : 0),\n\t\t\t((inv_direction.z < 0.0) ? 1 : 0)\n\t\t)\n    );\n}\n\n/*\n\tFrom: https://github.com/hpicgs/cgsee/wiki/Ray-Box-Intersection-on-the-GPU\nvoid intersect(\n    in Ray ray, in vec3 aabb[2],\n    out float tmin, out float tmax\n){\n    float tymin, tymax, tzmin, tzmax;\n    tmin = (aabb[ray.sign[0]].x - ray.origin.x) * ray.inv_direction.x;\n    tmax = (aabb[1-ray.sign[0]].x - ray.origin.x) * ray.inv_direction.x;\n    tymin = (aabb[ray.sign[1]].y - ray.origin.y) * ray.inv_direction.y;\n    tymax = (aabb[1-ray.sign[1]].y - ray.origin.y) * ray.inv_direction.y;\n    tzmin = (aabb[ray.sign[2]].z - ray.origin.z) * ray.inv_direction.z;\n    tzmax = (aabb[1-ray.sign[2]].z - ray.origin.z) * ray.inv_direction.z;\n    tmin = max(max(tmin, tymin), tzmin);\n    tmax = min(min(tmax, tymax), tzmax);\n}\n*/\n\n\n/*\n\nvoid main(){\n\t\n\t//transform = inverse(transform);\n\t\n\tvec4 origin = vec4(0.0, 0.0, 2.0, 1.0);\n\torigin = transform * origin;\n\torigin = origin / origin.w;\n\torigin.z = origin.z / zScale;\n\torigin = origin + 0.5;\n\n\tvec4 image = vec4(texCoord, 4.0, 1.0);\n\timage = transform * image;\n\t//image = image / image.w;\n\timage.z = image.z / zScale;\n\timage = image + 0.5;\n\t//vec4 direction = vec4(0.0, 0.0, 1.0, 0.0);\n\tvec4 direction = normalize(origin-image);\n\t//direction = transform * direction;\n\n\tRay ray = makeRay(origin.xyz, direction.xyz);\n\tfloat tmin = 0.0;\n\tfloat tmax = 0.0;\n\tintersect(ray, aabb, tmin, tmax);\n\n\tvec4 value = vec4(0.0, 0.0, 0.0, 0.0);\n,\n\tif(tmin > tmax){\n\t\tcolor = value;\n\t\tdiscard;\n\t}\n\n\tvec3 start = origin.xyz + tmin*direction.xyz;\n\tvec3 end = origin.xyz + tmax*direction.xyz;\n\t\n\tfloat length = distance(end, start);\n\tint sampleCount = int(float(depthSampleCount)*length);\n\t//vec3 increment = (end-start)/float(sampleCount);\n\t//vec3 originOffset = mod((start-origin.xyz), increment);\n\n\tfloat s = 0.0;\n\tfloat px = 0.0;\n\tvec4 pxColor = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 texCo = vec3(0.0, 0.0, 0.0);\n\tvec3 normal = vec3(0.0, 0.0, 0.0);\n\tvec4 zero = vec4(0.0);\n\t\n\tfor(int count = 0; count < sampleCount; count++){\n\n\t\ttexCo = mix(start, end, float(count)/float(sampleCount));// - originOffset;\n\n\t\t//texCo = start + increment*float(count);\n\t\tpx = texture(tex, texCo).r;\n\n\t\t\n\t\t//px = length(texture(normals, texCo).xyz - 0.5);\n\t\t//px = px * 1.5;\n\t\t\n\t\tpxColor = texture(colorMap, vec2(px, 0.0));\n\t\t\n\t\tnormal = normalize(texture(normals, texCo).xyz - 0.5);\n\t\tfloat directional = clamp(dot(normal, lightVector), 0.0, 1.0);\n\n\t\t//vec3 R = -reflect(lightDirection, surfaceNormal);\n\t\t//return pow(max(0.0, dot(viewDirection, R)), shininess);\n\n\t\tfloat specular = max(dot(direction.xyz, reflect(lightVector, normal)), 0.0);\n\t\tspecular = pow(specular, 3.0);\n\n\t\tpxColor.rgb = ambientLight*pxColor.rgb + directionalLight*directional*pxColor.rgb + pxColor.a*specular*specularColor;\n\t\t\t\n\t\t\n\t\t//value = mix(value, pxColor, px);\n\t\t//value = (1.0-value.a)*pxColor + value;\n\t\t//value = mix(pxColor, zero, value.a) + value;\n\t\t\n\t\tvalue = value + pxColor - pxColor*value.a;\n\t\t\n\t\tif(value.a >= 0.95){\n\t\t\tbreak;\n\t\t}\n\t}\n\tcolor = value*brightness;\n}\n*/\n',AnimatedIconFS:"precision highp float;\n\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nvarying vec2 v_texcoord;\nuniform bool textureFlipYAxis;\nuniform sampler2D u_texture;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform vec4 oneColor4;\n\nuniform vec2 imageSize;\nuniform int uFrustumIdx;\n\n\nvarying vec2 imageSizeInPixels;\nvarying float vDepth;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid make_kernel(inout vec4 n[9], vec2 coord)\n{\n\tfloat w = 1.0 / imageSize.x;\n\tfloat h = 1.0 / imageSize.y;\n\n\tn[0] = texture2D(u_texture, coord + vec2( -w, -h));\n\tn[1] = texture2D(u_texture, coord + vec2(0.0, -h));\n\tn[2] = texture2D(u_texture, coord + vec2(  w, -h));\n\tn[3] = texture2D(u_texture, coord + vec2( -w, 0.0));\n\tn[4] = texture2D(u_texture, coord);\n\tn[5] = texture2D(u_texture, coord + vec2(  w, 0.0));\n\tn[6] = texture2D(u_texture, coord + vec2( -w, h));\n\tn[7] = texture2D(u_texture, coord + vec2(0.0, h));\n\tn[8] = texture2D(u_texture, coord + vec2(  w, h));\n}\n\nvoid main()\n{\n    vec4 textureColor;\n\tvec2 finalTexCoord = v_texcoord;\n\n\t// 1rst, check if the texture.w != 0.\n\tif(textureFlipYAxis)\n\t{\n\t\tfinalTexCoord = vec2(v_texcoord.s, 1.0 - v_texcoord.t);\n\t}\n\t\n\ttextureColor = texture2D(u_texture, finalTexCoord);\n\n\tif(textureColor.w == 0.0)\n\t{\n\t\tdiscard;\n\t}\n\n\t// now, check neibourgh pixels to determine a silhouette.***\n\t//if(textureColor.a == 0.0)\n\t//{\n\t//\tvec4 n[9];\n\t//\tmake_kernel(n, finalTexCoord);\n\t//\n\t//\tfor(int i=0; i<9; i++)\n\t//\t{\n\t//\t\t// check if exist one or more neibourgh pixel with alpha != 0.0.***\n\t//\t\tif(n[i].a > 0.0)\n\t//\t\t{\n\t//\t\t\ttextureColor = vec4(1.0, 1.0, 1.0, 0.5);\n\t//\t\t\tbreak;\n\t//\t\t}\n\t//\t}\n\t//}\n\t\n\n\n\tif(colorType == 2)\n\t{\n\t\t// do nothing.\n\t}\n\telse if( colorType == 0)\n\t{\n\t\ttextureColor = oneColor4;\n\t}\n\n    //gl_FragColor = textureColor;\n\tgl_FragData[0] = textureColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\tgl_FragData[1] = packDepth(0.0);\n\t\t//gl_FragData[1] = packDepth(vDepth);\n\t\t\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.005; // frustum zero.\n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = textureColor; \n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t//}\n\t#endif\n}",AnimatedIconVS:"attribute vec4 position;\nattribute vec2 texCoord;\nuniform mat4 buildingRotMatrix;\nuniform mat4 modelViewMatrixRelToEye;  \nuniform mat4 ModelViewProjectionMatrixRelToEye;  \nuniform mat4 projectionMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec2 scale2d;\nuniform vec2 size2d;\nuniform vec3 aditionalOffset;\nuniform vec2 imageSize;\nuniform float screenWidth;    \nuniform float screenHeight;\nuniform bool bUseOriginalImageSize;\n\nuniform int uMosaicSize[2];\nuniform int uSubImageIdx; // mosaicTex = numCols * numRows = subImagesArray.***\n\nvarying vec2 v_texcoord;\nvarying vec2 imageSizeInPixels;\n\nvoid main()\n{\n    vec4 position2 = vec4(position.xyz, 1.0);\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t//imageSizeInPixels = vec2(imageSize.x, imageSize.y);\n\t\n\tfloat order_w = position.w;\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tvec4 projected = ModelViewProjectionMatrixRelToEye * pos4;\n\t//vec4 projected2 = modelViewMatrixRelToEye * pos4;\n\n\t// Now, calculate the pixelSize in the plane of the projected point.\n\tfloat pixelWidthRatio = 2. / ((screenWidth));// * projectionMatrix[0][0]);\n\t// alternative : float pixelWidthRatio = 2. / (screenHeight * projectionMatrix[1][1]);\n\tfloat pixelWidth = projected.w * pixelWidthRatio;\n\n\t//float pixelHeightRatio = pixelWidthRatio * (screenHeight/screenWidth); // no works correctly.\n\tfloat pixelHeightRatio = 2. / ((screenHeight));\n\tfloat pixelHeight = projected.w * pixelHeightRatio;\n\t\n\tif(projected.w < 5.0)\n\t\tpixelWidth = 5.0 * pixelWidthRatio;\n\n\t//pixelHeight = pixelWidth;\n\t\n\tvec4 offset;\n\tfloat offsetX;\n\tfloat offsetY;\n\tif(bUseOriginalImageSize)\n\t{\n\t\toffsetX = pixelWidth*imageSize.x/2.0;\n\t\toffsetY = pixelHeight*imageSize.y/2.0;\n\t}\n\telse{\n\t\toffsetX = pixelWidth*size2d.x/2.0;\n\t\toffsetY = pixelHeight*size2d.y/2.0;\n\t}\n\t\n\t// Offset our position along the normal\n\tif(orderInt == 1)\n\t{\n\t\toffset = vec4(-offsetX*scale2d.x, 0.0, 0.0, 1.0);\n\t}\n\telse if(orderInt == -1)\n\t{\n\t\toffset = vec4(offsetX*scale2d.x, 0.0, 0.0, 1.0);\n\t}\n\telse if(orderInt == 2)\n\t{\n\t\toffset = vec4(-offsetX*scale2d.x, offsetY*2.0*scale2d.y, 0.0, 1.0);\n\t}\n\telse if(orderInt == -2)\n\t{\n\t\toffset = vec4(offsetX*scale2d.x, offsetY*2.0*scale2d.y, 0.0, 1.0);\n\t}\n\n\tgl_Position = projected + offset + vec4(aditionalOffset.x*pixelWidth, aditionalOffset.y*pixelWidth, aditionalOffset.z*pixelWidth, 0.0); \n\n\t// Now, calculate the texCoords.***\n\t// uMosaicSize = colsCount, rowsCount.***\n\tfloat colsCount = float(uMosaicSize[0]);\n\tfloat rowsCount = float(uMosaicSize[1]);\n\n\t// var idx = col + row * numCols;\n\t// row = floor(idx / numCols).\n\t// col = idx - row * numCols.\n\n\tfloat row = floor((float(uSubImageIdx) + 0.1 )/ colsCount);\n\tfloat col = float(uSubImageIdx) - row * colsCount;\n\n\tvec2 subTexCoordSize = vec2(1.0 / colsCount, 1.0 / rowsCount);\n\n\tv_texcoord = vec2(subTexCoordSize.x * col + texCoord.x * subTexCoordSize.x, \n\t\t\t\t\t\tsubTexCoordSize.y * row + texCoord.y * subTexCoordSize.y);\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",atmosphereFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nvarying vec4 vcolor4;\n\nvoid main()\n{  \n\tgl_FragData[0] = vcolor4; \n}",atmosphereVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec4 color4;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool hasTexture;\nuniform bool bIsMakingDepth;\nuniform float near;\nuniform float far;\n\nvarying vec3 vNormal;\nvarying vec3 v3Pos;\nvarying vec2 vTexCoord;   \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\nvarying vec3 vertexPos;\nvarying float depthValue;\nvarying vec3 camPos;\n\nconst float equatorialRadius = 6378137.0;\nconst float polarRadius = 6356752.3142;\nconst float PI = 3.1415926535897932384626433832795;\nconst float PI_2 = 1.57079632679489661923; \nconst float PI_4 = 0.785398163397448309616;\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\tvNormal = (normalMatrix4 * vec4(normal, 1.0)).xyz;\n\n\tif(bIsMakingDepth)\n\t{\n\t\tdepthValue = (modelViewMatrixRelToEye * pos4).z/far;\n\t}\n\telse\n\t{\n\t\tvTexCoord = texCoord;\n\t}\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tcamPos = encodedCameraPositionMCHigh.xyz + encodedCameraPositionMCLow.xyz;\n\tv3Pos = vec3((modelViewMatrixRelToEye * pos4).xyz);\n\n\t// Calculate color.\n\tfloat distToCam = length(vec3(v3Pos));\n\tvec3 camDir = normalize(vec3(v3Pos.x, v3Pos.y, v3Pos.z));\n\tvec3 normal = vNormal;\n\tfloat angRad = acos(dot(camDir, normal));\n\tfloat angDeg = angRad*180.0/PI;\n\t/*\n\tif(angDeg > 130.0)\n\t\ttextureColor = vec4(1.0, 0.0, 0.0, 1.0);\n\telse if(angDeg > 120.0)\n\t\ttextureColor = vec4(0.0, 1.0, 0.0, 1.0);\n\telse if(angDeg > 110.0)\n\t\ttextureColor = vec4(0.0, 0.0, 1.0, 1.0);\n\telse if(angDeg > 100.0)\n\t\ttextureColor = vec4(1.0, 1.0, 0.0, 1.0);\n\telse if(angDeg > 90.0)\n\t\ttextureColor = vec4(1.0, 0.0, 1.0, 1.0);\n\t\t*/\n\t\t\n\t//textureColor = vec4(vNormal, 1.0);\n\n\t//float maxAngDeg = 100.5;\n\tfloat maxAngDeg = 101.2;\n\tfloat minAngDeg = 90.0;\n\n\tfloat A = 1.0/(maxAngDeg-minAngDeg);\n\tfloat B = -A*minAngDeg;\n\tfloat alphaReal = A*angDeg+B;\n\tfloat alpha2 = alphaReal*alphaReal;\n\tfloat alpha = alpha2*alpha2;\n\tif(alpha < 0.0 )\n\talpha = 0.0;\n\telse if(alpha > 2.0 )\n\talpha = 2.0;\n\t\n\tfloat alphaPlusPerDist = 4.0*(distToCam/equatorialRadius);\n\tif(alphaPlusPerDist > 1.0)\n\talphaPlusPerDist = 1.0;\n\n\tfloat extra = (1.0-alpha);\n\tif(extra < 0.0)\n\textra = 0.0;\n\n\tfloat extraPerDist = (1.0-alphaPlusPerDist); // near -> more blue.\n\n\talpha *= alphaPlusPerDist;\n\tvcolor4 = vec4(alpha*0.75, alpha*0.88 + extra*0.4 + extraPerDist*0.1, alpha + extra*2.5 + extraPerDist*0.8, alpha);\n}",BoxSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n  \nvarying vec4 vcolor4;   \n  \n\nvoid main()\n{ \n\tvec4 textureColor;\n\ttextureColor = vcolor4;  \n\t/*\n\tif(bUseNormal)\n    {\n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n\t\tfloat linearDepth = getDepth(screenPos);          \n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;   \n\t\tvec3 normal2 = vNormal;   \n\t\t\t\t\n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);        \n\t\t\n\t\tfloat occlusion = 0.0;\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t \n\t\t\tvec3 sample = origin + (tbn * kernel[i]) * radius;\n\t\t\tvec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n\t\t\toffset.xy /= offset.w;\n\t\t\toffset.xy = offset.xy * 0.5 + 0.5;        \n\t\t\tfloat sampleDepth = -sample.z/far;\n\t\t\tfloat depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n\t\t\tif (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n\t\t\t{\n\t\t\t\tocclusion +=  1.0;\n\t\t\t}\n\t\t\t\n\t\t}   \n\t\t\t\n\t\tocclusion = 1.0 - occlusion / float(kernelSize);\n\t\t\t\t\t\t\t\t\t\n\t\tvec3 lightPos = vec3(10.0, 10.0, 10.0);\n\t\tvec3 L = normalize(lightPos);\n\t\tfloat DiffuseFactor = dot(normal2, L);\n\t\tfloat NdotL = abs(DiffuseFactor);\n\t\tvec3 diffuse = vec3(NdotL);\n\t\tvec3 ambient = vec3(1.0);\n\t\tgl_FragColor.rgb = vec3((textureColor.xyz)*vLightWeighting * occlusion); \n\t\tgl_FragColor.a = 1.0; \n\t}\n\telse\n\t{\n\t\tgl_FragColor.rgb = vec3(textureColor.xyz); \n\t\tgl_FragColor.a = 1.0; \n\t}\t\n\t*/\n\tgl_FragData[0] = vec4(textureColor.xyz, 1.0);\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tgl_FragData[3] = vec4(textureColor.xyz, 1.0);\n\t#endif\n}\n",BoxSsaoVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\n\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec4 oneColor4;\nuniform bool bUse1Color;\nuniform bool bUseNormal;\nuniform vec3 scale;\nuniform bool bScale;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;  \nvarying vec3 uAmbientColor;\nvarying vec3 vLightWeighting;\nvarying vec4 vcolor4;\n\nvoid main()\n{\t\n    vec4 position2 = vec4(position.xyz, 1.0);\n    if(bScale)\n    {\n        position2.x *= scale.x;\n        position2.y *= scale.y;\n        position2.z *= scale.z;\n    }\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz + aditionalPosition.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    if(bUseNormal)\n    {\n\t\tvec4 rotatedNormal = buildingRotMatrix * vec4(normal.xyz, 1.0);\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8, 0.8, 0.8);\n\t\tvec3 uLightingDirection = vec3(0.5, 0.5, 0.5);\n\t\tvec3 directionalLightColor = vec3(0.6, 0.6, 0.6);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t}\n    if(bUse1Color)\n    {\n        vcolor4 = oneColor4;\n    }\n    else\n    {\n        vcolor4 = color4;\n    }\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",chemicalAccidentVolumRenderFS:'//#version 300 es\n\n#ifdef GL_ES\n    //precision lowp float;\n    //precision lowp int;\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n// https://draemm.li/various/volumeRendering/webgl2/\n\n    //*********************************************************\n    // R= right, F= front, U= up, L= left, B= back, D= down.\n    // RFU = x, y, z.\n    // LBD = -x, -y, -z.\n    //*********************************************************\n\n    //      +-----------------+\n\t//      |                 |          \n\t//      |   screen size   |  \n\t//      |                 | \n\t//      +-----------------+\n\t//      +-----------------+----------------+\n\t//      |                 |                | \n\t//      |   front depth   |   rear depth   |\n\t//      |                 |                |\n\t//      +-----------------+----------------+\n\t\nuniform sampler2D simulationBoxDoubleDepthTex;\nuniform sampler2D simulationBoxDoubleNormalTex; // used to calculate the current frustum idx.***\nuniform sampler2D pollutionMosaicTex; // pollutionTex. (from chemical accident).***\nuniform sampler2D sceneDepthTex; // scene depth texture.***\nuniform sampler2D sceneNormalTex; // scene normal texture.***\nuniform sampler2D cuttingPlaneDepthTex;\nuniform sampler2D cuttingPlaneNormalTex;\n\nuniform int u_texSize[3]; // The original texture3D size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform vec3 u_voxelSizeMeters;\n\nvarying vec2 v_tex_pos;\n\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform vec2 u_minMaxPollutionValues;\nuniform vec2 u_minMaxPollutionValuesToRender;\nuniform float u_airEnvirontmentPressure;\nuniform vec2 u_screenSize;\nuniform vec2 uNearFarArray[4];\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\nuniform vec2 uMinMaxAltitudeSlices[32]; // limited to 32 slices.***\nuniform int u_cuttingPlaneIdx;\nuniform int u_useMinMaxValuesToRender;\nuniform vec4 u_cuttingPlanePosLC;\n\nuniform mat4 u_simulBoxTMat;\nuniform mat4 u_simulBoxTMatInv;\nuniform vec3 u_simulBoxPosHigh;\nuniform vec3 u_simulBoxPosLow;\nuniform vec3 u_simulBoxMinPosLC;\nuniform vec3 u_simulBoxMaxPosLC;\n\n\n\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getDepth(vec2 coord)\n{\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t//\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t//\t// flogz = 1.0 + gl_Position.z*0.0001;\n    //    float Fcoef_half = uFCoef_logDepth/2.0;\n\t//\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t//\tfloat z = (flogzAux - 1.0);\n\t//\tlinearDepth = z/(far);\n\t//\treturn linearDepth;\n\t//}\n\t//else{\n\t\treturn unpackDepth(texture2D(sceneDepthTex, coord.xy));\n\t//}\n}\n\nfloat getDepth_simulationBox(vec2 coord)\n{\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t//\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t//\t// flogz = 1.0 + gl_Position.z*0.0001;\n    //    float Fcoef_half = uFCoef_logDepth/2.0;\n\t//\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t//\tfloat z = (flogzAux - 1.0);\n\t//\tlinearDepth = z/(far);\n\t//\treturn linearDepth;\n\t//}\n\t//else{\n\t\treturn unpackDepth(texture2D(simulationBoxDoubleDepthTex, coord.xy));\n\t//}\n}\n\nfloat getDepth_cuttingPlane(vec2 coord)\n{\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t//\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t//\t// flogz = 1.0 + gl_Position.z*0.0001;\n    //    float Fcoef_half = uFCoef_logDepth/2.0;\n\t//\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t//\tfloat z = (flogzAux - 1.0);\n\t//\tlinearDepth = z/(far);\n\t//\treturn linearDepth;\n\t//}\n\t//else{\n\t\treturn unpackDepth(texture2D(cuttingPlaneDepthTex, coord.xy));\n\t//}\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(sceneNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\n\nvec4 getNormal_simulationBox(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(simulationBoxDoubleNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nvec4 getNormal_cuttingPlane(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(cuttingPlaneNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvoid get_FrontAndRear_depthTexCoords(in vec2 texCoord, inout vec2 frontTexCoord, inout vec2 rearTexCoord)\n{\n    //      +-----------------+\n\t//      |                 |          \n\t//      |   screen size   |  \n\t//      |                 | \n\t//      +-----------------+\n\t//      +-----------------+----------------+\n\t//      |                 |                | \n\t//      |   front depth   |   rear depth   |\n\t//      |                 |                |\n\t//      +-----------------+----------------+\n    vec2 normalTexSize = vec2(u_screenSize.x * 2.0, u_screenSize.y); // the normal tex width is double of the screen size width.***\n    //vec2 frontNormalFragCoord = vec2(gl_FragCoord.x, gl_FragCoord.y);\n    //vec2 rearNormalFragCoord = vec2(gl_FragCoord.x + u_screenSize.x, gl_FragCoord.y);\n    float windows_x = texCoord.x * u_screenSize.x;\n    float windows_y = texCoord.y * u_screenSize.y;\n    vec2 frontNormalFragCoord = vec2(windows_x, windows_y);\n    vec2 rearNormalFragCoord = vec2(windows_x + u_screenSize.x, windows_y);\n\n    frontTexCoord = vec2(frontNormalFragCoord.x / normalTexSize.x, frontNormalFragCoord.y / normalTexSize.y);\n    rearTexCoord = vec2(rearNormalFragCoord.x / normalTexSize.x, rearNormalFragCoord.y / normalTexSize.y);\n}\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nvoid get_FrontAndRear_posCC(in vec2 screenPos, in float currFar_rear, in float currFar_front, inout vec3 frontPosCC, inout vec3 rearPosCC)\n{\n    vec2 frontTexCoord;\n    vec2 rearTexCoord;\n    get_FrontAndRear_depthTexCoords(screenPos, frontTexCoord, rearTexCoord);\n\n    // If the linear depth is 1, then, take the camPos as the position, so, pos = (0.0, 0.0, 0.0).***\n    //vec4 depthColor4 = texture2D(simulationBoxDoubleDepthTex, screenPos);\n    //float depthColLength = length(depthColor4);\n\n    // Front posCC.***\n    float frontLinearDepth = getDepth_simulationBox(frontTexCoord);\n    if(frontLinearDepth < 1e-8)\n    {\n        frontPosCC = vec3(0.0);\n    }\n    else\n    {\n        float front_zDist = frontLinearDepth * currFar_front; \n        frontPosCC = getViewRay(screenPos, front_zDist);\n    }\n\n    // Rear posCC.***\n    float rearLinearDepth = getDepth_simulationBox(rearTexCoord);\n    if(rearLinearDepth < 1e-8)\n    {\n        rearPosCC = vec3(0.0);\n    }\n    else\n    {\n        float rear_zDist = rearLinearDepth * currFar_rear; \n        rearPosCC = getViewRay(screenPos, rear_zDist);\n    }\n}\n\nvoid get_cuttingPlane_posCC(in vec2 screenPos, in float currFar, inout vec3 posCC)\n{\n\n    // posCC.***\n    float frontLinearDepth = getDepth_cuttingPlane(screenPos);\n    if(frontLinearDepth < 1e-8)\n    {\n        posCC = vec3(0.0);\n    }\n    else\n    {\n        float front_zDist = frontLinearDepth * currFar; \n        posCC = getViewRay(screenPos, front_zDist);\n    }\n}\n\nvoid posWCRelToEye_to_posLC(in vec4 posWC_relToEye, in mat4 local_mat4Inv, in vec3 localPosHIGH, in vec3 localPosLOW, inout vec3 posLC)\n{\n    vec3 highDifferenceSun = -localPosHIGH.xyz + encodedCameraPositionMCHigh;\n\tvec3 lowDifferenceSun = posWC_relToEye.xyz -localPosLOW.xyz + encodedCameraPositionMCLow;\n\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\tvec4 vPosRelToLight = local_mat4Inv * pos4Sun;\n\n\tposLC = vPosRelToLight.xyz / vPosRelToLight.w;\n}\n\nvoid checkTexCoordRange(inout vec2 texCoord)\n{\n    float error = 0.0;\n    if(texCoord.x < 0.0)\n    {\n        texCoord.x = 0.0 + error;\n    }\n    else if(texCoord.x > 1.0)\n    {\n        texCoord.x = 1.0 - error;\n    }\n\n    if(texCoord.y < 0.0)\n    {\n        texCoord.y = 0.0 + error;\n    }\n    else if(texCoord.y > 1.0)\n    {\n        texCoord.y = 1.0 - error;\n    }\n}\n\nvoid checkTexCoord3DRange(inout vec3 texCoord)\n{\n    float error = 0.0;\n    if(texCoord.x < 0.0)\n    {\n        texCoord.x = 0.0 + error;\n    }\n    else if(texCoord.x > 1.0)\n    {\n        texCoord.x = 1.0 - error;\n    }\n\n    if(texCoord.y < 0.0)\n    {\n        texCoord.y = 0.0 + error;\n    }\n    else if(texCoord.y > 1.0)\n    {\n        texCoord.y = 1.0 - error;\n    }\n\n    if(texCoord.z < 0.0)\n    {\n        texCoord.z = 0.0 + error;\n    }\n    else if(texCoord.z > 1.0)\n    {\n        texCoord.z = 1.0 - error;\n    }\n}\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col_mosaic, in int row_mosaic)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    checkTexCoordRange(subTexCoord);\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    float s = float(col_mosaic) * sRange + subTexCoord.x * sRange;\n    float t = float(row_mosaic) * tRange + subTexCoord.y * tRange;\n\n    // must check if the texCoord_tl is boundary in x & y.***************************************************************************\n    float mosaicTexSize_x = float(u_texSize[0] * u_mosaicSize[0]); // for example : 150 pixels * 3 columns = 450 pixels.***\n    float mosaicTexSize_y = float(u_texSize[1] * u_mosaicSize[1]); // for example : 150 pixels * 3 rows = 450 pixels.***\n\n    float currMosaicStart_x = float(col_mosaic * u_texSize[0]);\n    float currMosaicStart_y = float(row_mosaic * u_texSize[1]);\n    float currMosaicEnd_x = currMosaicStart_x + float(u_texSize[0]);\n    float currMosaicEnd_y = currMosaicStart_y + float(u_texSize[1]);\n\n    float pixel_x = s * mosaicTexSize_x;\n    float pixel_y = t * mosaicTexSize_y;\n\n    if(pixel_x < currMosaicStart_x + 1.0)\n    {\n        pixel_x = currMosaicStart_x + 1.0;\n    }\n    else if(pixel_x > currMosaicEnd_x - 1.0)\n    {\n        pixel_x = currMosaicEnd_x - 1.0;\n    }\n\n    if(pixel_y < currMosaicStart_y + 1.0)\n    {\n        pixel_y = currMosaicStart_y + 1.0;\n    }\n    else if(pixel_y > currMosaicEnd_y - 1.0)\n    {\n        pixel_y = currMosaicEnd_y - 1.0;\n    }\n\n    s = pixel_x / mosaicTexSize_x;\n    t = pixel_y / mosaicTexSize_y;\n\n\n    vec2 resultTexCoord = vec2(s, t);\n\n    return resultTexCoord;\n}\n\n\n\nfloat getPollution_inMosaicTexture(in vec2 texCoord)\n{\n    checkTexCoordRange(texCoord);\n    vec4 color4;\n    color4 = texture2D(pollutionMosaicTex, texCoord);\n    float decoded = unpackDepth(color4); // 32bit.\n    float pollution = decoded * u_minMaxPollutionValues.y;\n\n    return pollution;\n}\n\nfloat _getPollution_triLinearInterpolation(in vec2 subTexCoord2d, in int col_mosaic, in int row_mosaic)\n{\n    // This function : given a subTexture2d(real texCoord.xy of a realTex3D), \n    // and the col & row into the mosaic texture, returns a trilinear interpolation of the pressure.***\n\n    //************************************************************************************\n    // u_texSize[3]; // The original texture3D size.***\n    // mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    //------------------------------------------------------------------------------------\n\n    checkTexCoordRange(subTexCoord2d);\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec2 px = 1.0 / sim_res3d.xy;\n    vec2 vc = (floor(subTexCoord2d * sim_res3d.xy)) * px;\n    vec2 f = fract(subTexCoord2d * sim_res3d.xy);\n    vec2 texCoord_tl = vec2(vc);\n\n    \n    \n\n    vec2 texCoord_tr = vec2(vc + vec2(px.x, 0));\n    vec2 texCoord_bl = vec2(vc + vec2(0, px.y));\n    vec2 texCoord_br = vec2(vc + vec2(px.x, px.y));\n\n    checkTexCoordRange(texCoord_tl);\n    checkTexCoordRange(texCoord_tr);\n    checkTexCoordRange(texCoord_bl);\n    checkTexCoordRange(texCoord_br);\n    vec2 mosaicTexCoord_tl = subTexCoord_to_texCoord(texCoord_tl, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_tr = subTexCoord_to_texCoord(texCoord_tr, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_bl = subTexCoord_to_texCoord(texCoord_bl, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_br = subTexCoord_to_texCoord(texCoord_br, col_mosaic, row_mosaic);\n\n    // vec2 mosaicTexCoord_tl = subTexCoord_to_texCoord(texCoord_tl, col_mosaic, row_mosaic);\n    // vec2 mosaicTexCoord_tr = vec2(mosaicTexCoord_tl + vec2(px.x, 0));\n    // vec2 mosaicTexCoord_bl = vec2(mosaicTexCoord_tl + vec2(0, px.y));\n    // vec2 mosaicTexCoord_br = vec2(mosaicTexCoord_tl + vec2(px.x, px.y));\n\n\n    float ap_tl = getPollution_inMosaicTexture(mosaicTexCoord_tl);\n    float ap_tr = getPollution_inMosaicTexture(mosaicTexCoord_tr);\n    float ap_bl = getPollution_inMosaicTexture(mosaicTexCoord_bl);\n    float ap_br = getPollution_inMosaicTexture(mosaicTexCoord_br);\n\n    float airPressure = mix(mix(ap_tl, ap_tr, f.x), mix(ap_bl, ap_br, f.x), f.y);\n\n    return airPressure;\n}\n\n\nfloat _getPollution_nearest(in vec2 subTexCoord2d, in int col_mosaic, in int row_mosaic)\n{\n    // This function : given a subTexture2d(real texCoord.xy of a realTex3D), \n    // and the col & row into the mosaic texture, returns a nearest interpolation of the pressure.***\n    checkTexCoordRange(subTexCoord2d);\n    vec2 mosaicTexCoord = subTexCoord_to_texCoord(subTexCoord2d, col_mosaic, row_mosaic);\n    float ap = getPollution_inMosaicTexture(mosaicTexCoord);\n    return ap;\n}\n\nbool getUpDownSlicesIdx(in vec3 posLC, inout int sliceDownIdx, inout int sliceUpIdx, inout float distUp, inout float distDown)\n{\n    // uMinMaxAltitudeSlices[32]; // limited to 32 slices.***\n    // u_texSize[3] =  The original texture3D size.***\n    float altitude = posLC.z;\n    int currSliceIdx = -1;\n    for(int i=0; i<32; i++)\n    {\n        if(altitude >= uMinMaxAltitudeSlices[i].x && altitude < uMinMaxAltitudeSlices[i].y)\n        {\n            currSliceIdx = i;\n            break;\n        }\n    }\n\n    if(currSliceIdx < 0)\n    {\n        return false;\n    }\n\n    if(currSliceIdx == 0)\n    {\n        sliceDownIdx = currSliceIdx;\n        sliceUpIdx = currSliceIdx;\n    }\n    else\n    {\n        sliceDownIdx = currSliceIdx-1;\n        sliceUpIdx = currSliceIdx;\n    }\n\n    if(sliceUpIdx > u_texSize[2] - 1)\n    {\n        sliceUpIdx = u_texSize[2] - 1;\n    }\n\n    // +------------------------------+ <- sliceUp\n    //                 |\n    //                 |\n    //                 |  distUp\n    //                 |\n    //                 * <- posL.z\n    //                 |\n    //                 |  distDown\n    // +------------------------------+ <- sliceDown\n    float sliceUpAltitude = 0.0;\n    float sliceDownAltitude = 0.0;\n    for(int i=0; i<32; i++)\n    {\n        if(sliceUpIdx == i)\n        {\n            sliceUpAltitude = uMinMaxAltitudeSlices[i].y;\n            sliceDownAltitude = uMinMaxAltitudeSlices[i].x;\n            break;\n        }\n    }\n\n    distUp = abs(sliceUpAltitude - altitude);\n    distDown = abs(altitude - sliceDownAltitude);\n\n    return true;\n}\n\nbool getUpDownSlicesIdx_FAST(in vec3 posLC, inout int sliceDownIdx, inout int sliceUpIdx)\n{\n    // uMinMaxAltitudeSlices[32]; // limited to 32 slices.***\n    // u_texSize[3] =  The original texture3D size.***\n    float altitude = posLC.z;\n    int currSliceIdx = -1;\n    for(int i=0; i<32; i++)\n    {\n        if(altitude >= uMinMaxAltitudeSlices[i].x && altitude < uMinMaxAltitudeSlices[i].y)\n        {\n            currSliceIdx = i;\n            break;\n        }\n    }\n\n    if(currSliceIdx < 0)\n    {\n        return false;\n    }\n\n    if(currSliceIdx == 0)\n    {\n        sliceDownIdx = currSliceIdx;\n        sliceUpIdx = currSliceIdx;\n    }\n    else\n    {\n        sliceDownIdx = currSliceIdx-1;\n        sliceUpIdx = currSliceIdx;\n    }\n\n    if(sliceUpIdx > u_texSize[2] - 1)\n    {\n        sliceUpIdx = u_texSize[2] - 1;\n    }\n\n    return true;\n}\n\nbool get_pollution_fromTexture3d_triLinearInterpolation_FAST(in vec3 texCoord3d, in vec3 posLC, inout float airPressure)\n{\n    // Here is not important the pollution value. Only need know if the pollution value is zero or not.***\n    // this function is called by "findFirstSamplePosition".***\n    // tex3d : airPressureMosaicTex\n\n    // 1rst, determine the sliceIdx.***\n    int currSliceIdx_down = -1;\n    int currSliceIdx_up = -1;\n    float distUp = 0.0;\n    float distDown = 0.0;\n\n    if(!getUpDownSlicesIdx_FAST(posLC, currSliceIdx_down, currSliceIdx_up))\n    {\n        return false;\n    }\n\n    float distUpAndDown = distUp + distDown;\n    float distUpRatio = distUp / distUpAndDown;\n    float distDownRatio = distDown / distUpAndDown;\n\n    // Down slice.************************************************************\n    int col_down, row_down;\n    //if(currSliceIdx_down <= u_mosaicSize[0])\n    //{\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n    //    row_down = 0;\n    //    col_down = currSliceIdx_down;\n    //}\n    //else\n    {\n        float rowAux = floor(float(currSliceIdx_down) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_down) - (rowAux * float(u_mosaicSize[0]));\n\n        col_down = int(colAux);\n        row_down = int(rowAux);\n    }\n\n    float airPressure_down = _getPollution_nearest(texCoord3d.xy, col_down, row_down);\n\n    if(airPressure_down > 0.0)\n    {\n        airPressure = airPressure_down;\n        return true;\n    }\n\n    // up slice.************************************************************\n    int col_up, row_up;\n    if(currSliceIdx_up <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_up is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row_up = 0;\n        col_up = currSliceIdx_up;\n    }\n    else\n    {\n        float rowAux = floor(float(currSliceIdx_up) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_up) - (rowAux * float(u_mosaicSize[0]));\n\n        col_up = int(colAux);\n        row_up = int(rowAux);\n    }\n\n    // test.***\n    col_up = col_down + 1;\n    row_up = row_down;\n    if(col_up >= u_mosaicSize[0])\n    {\n        col_up = 0;\n        row_up = row_down + 1;\n    }\n\n    if(row_up >= u_mosaicSize[1])\n    {\n        return false;\n    }\n\n    float airPressure_up = _getPollution_nearest(texCoord3d.xy, col_up, row_up);\n    if(airPressure_up > 0.0)\n    {\n        airPressure = airPressure_up;\n        return true;\n    }\n\n\n    return false;\n}\n\nbool get_pollution_fromTexture3d_triLinearInterpolation(in vec3 texCoord3d, in vec3 posLC, inout float airPressure)\n{\n    // tex3d : airPressureMosaicTex\n    // 1rst, check texCoord3d boundary limits.***\n    float error = 0.001;\n    // if(texCoord3d.x < 0.0 + error || texCoord3d.x > 1.0 - error)\n    // {\n    //     return false;\n    // }\n\n    // if(texCoord3d.y < 0.0 + error || texCoord3d.y > 1.0 - error)\n    // {\n    //     return false;\n    // }\n\n    // if(texCoord3d.z < 0.0 + error || texCoord3d.z > 1.0 - error)\n    // {\n    //     return false;\n    // }\n    // 1rst, determine the sliceIdx.***\n    int currSliceIdx_down = -1;\n    int currSliceIdx_up = -1;\n    float distUp = 0.0;\n    float distDown = 0.0;\n\n    if(!getUpDownSlicesIdx(posLC, currSliceIdx_down, currSliceIdx_up, distUp, distDown))\n    {\n        return false;\n    }\n\n    float distUpAndDown = distUp + distDown;\n    float distUpRatio = distUp / distUpAndDown;\n    float distDownRatio = distDown / distUpAndDown;\n\n    // Down slice.************************************************************\n    int col_down, row_down;\n    //if(currSliceIdx_down <= u_mosaicSize[0])\n    //{\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n    //    row_down = 0;\n    //    col_down = currSliceIdx_down;\n    //}\n    //else\n    {\n        float rowAux = floor(float(currSliceIdx_down) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_down) - (rowAux * float(u_mosaicSize[0]));\n\n        col_down = int(colAux);\n        row_down = int(rowAux);\n    }\n\n    float airPressure_down = _getPollution_triLinearInterpolation(texCoord3d.xy, col_down, row_down);\n\n    // up slice.************************************************************\n    int col_up, row_up;\n    if(currSliceIdx_up <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_up is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row_up = 0;\n        col_up = currSliceIdx_up;\n    }\n    else\n    {\n        float rowAux = floor(float(currSliceIdx_up) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_up) - (rowAux * float(u_mosaicSize[0]));\n\n        col_up = int(colAux);\n        row_up = int(rowAux);\n    }\n\n    // test.***\n    col_up = col_down + 1;\n    row_up = row_down;\n    if(col_up >= u_mosaicSize[0])\n    {\n        col_up = 0;\n        row_up = row_down + 1;\n    }\n\n    if(row_up >= u_mosaicSize[1])\n    {\n        return false;\n    }\n\n    float airPressure_up = _getPollution_triLinearInterpolation(texCoord3d.xy, col_up, row_up);\n\n    airPressure = mix(airPressure_down, airPressure_up, distDownRatio);\n    //airPressure = mix(airPressure_down, airPressure_up, 0.5);\n\n    return true;\n}\n\nbool get_pollution_fromTexture3d_triLinearInterpolation_original(in vec3 texCoord3d, inout float airPressure)\n{\n    // This function is used if all slices of the texture3d has same altitude differences.***\n    //---------------------------------------------------------------------------------------\n    // tex3d : airPressureMosaicTex\n    // 1rst, check texCoord3d boundary limits.***\n    if(texCoord3d.x < 0.0 || texCoord3d.x > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.y < 0.0 || texCoord3d.y > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.z < 0.0 || texCoord3d.z > 1.0)\n    {\n        return false;\n    }\n    // 1rst, determine the sliceIdx.***\n    // u_texSize[3]; // The original texture3D size.***\n    int slicesCount = u_texSize[2];\n\n    float currSliceIdx_float = texCoord3d.z * float(slicesCount - 1);\n    int currSliceIdx_down = int(floor(currSliceIdx_float));\n    int currSliceIdx_up = currSliceIdx_down + 1;\n\n    if(currSliceIdx_up >= u_texSize[2])\n    {\n        return false;\n    }\n\n    // now, calculate the mod.***\n    //float remain = currSliceIdx_float -  floor(currSliceIdx_float);\n    float remain = fract(currSliceIdx_float);\n\n    // Now, calculate the "col" & "row" in the mosaic texture3d.***\n    // u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n\n    // Down slice.************************************************************\n    int col_down, row_down;\n    //if(currSliceIdx_down <= u_mosaicSize[0])\n    //{\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n    //    row_down = 0;\n    //    col_down = currSliceIdx_down;\n   // }\n    //else\n    {\n        float rowAux = floor(float(currSliceIdx_down) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_down) - (rowAux * float(u_mosaicSize[0]));\n\n        col_down = int(colAux);\n        row_down = int(rowAux);\n    }\n\n    // now, must calculate the mosaicTexCoord.***\n    vec2 mosaicTexCoord_down = subTexCoord_to_texCoord(texCoord3d.xy, col_down, row_down);\n    \n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec2 px = 1.0 / sim_res3d.xy;\n    vec2 vc = (floor(texCoord3d.xy * sim_res3d.xy)) * px;\n    vec3 f = fract(texCoord3d * sim_res3d);\n\n    float airPressure_down = _getPollution_triLinearInterpolation(texCoord3d.xy, col_down, row_down);\n\n    // up slice.************************************************************\n    int col_up, row_up;\n    if(currSliceIdx_up <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_up is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row_up = 0;\n        col_up = currSliceIdx_up;\n    }\n    else\n    {\n        float rowAux = floor(float(currSliceIdx_up) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_up) - (rowAux * float(u_mosaicSize[0]));\n\n        col_up = int(colAux);\n        row_up = int(rowAux);\n    }\n\n    // test.***\n    col_up = col_down + 1;\n    row_up = row_down;\n    if(col_up >= u_mosaicSize[0])\n    {\n        col_up = 0;\n        row_up = row_down + 1;\n    }\n\n    if(row_up >= u_mosaicSize[1])\n    {\n        return false;\n    }\n\n    float airPressure_up = _getPollution_triLinearInterpolation(texCoord3d.xy, col_up, row_up);\n\n    airPressure = mix(airPressure_down, airPressure_up, f.z);\n    //airPressure = airPressure_down; // test delete.***\n    return true;\n}\n\nbool get_pollution_fromTexture3d_nearest(in vec3 texCoord3d, inout float airPressure)\n{\n    // tex3d : airPressureMosaicTex\n    // 1rst, check texCoord3d boundary limits.***\n    if(texCoord3d.x < 0.0 || texCoord3d.x > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.y < 0.0 || texCoord3d.y > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.z < 0.0 || texCoord3d.z > 1.0)\n    {\n        return false;\n    }\n    // 1rst, determine the sliceIdx.***\n    int slicesCount = u_texSize[2];\n\n    float currSliceIdx_float = texCoord3d.z * float(slicesCount -  1);\n    int currSliceIdx_down = int(floor(currSliceIdx_float));\n    int currSliceIdx_up = currSliceIdx_down + 1;\n    int currSliceIdx = currSliceIdx_down;\n\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    //vec2 px = 1.0 / sim_res3d.xy;\n    //vec2 vc = (floor(texCoord3d.xy * sim_res3d.xy)) * px;\n    vec3 f = fract(texCoord3d * sim_res3d);\n\n    if(f.z > 0.5)\n    {\n        currSliceIdx = currSliceIdx_up;\n    }\n\n    if(currSliceIdx >= u_texSize[2])\n    {\n        return false;\n    }\n\n    // ************************************************************\n    int col, row;\n    //if(currSliceIdx <= u_mosaicSize[0])\n    //{\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n    //    row = 0;\n   //     col = currSliceIdx;\n   /// }\n    //else\n    {\n        float mosaicSize_x = float(u_mosaicSize[0]);\n        float rowAux = floor(float(currSliceIdx) / mosaicSize_x);\n        float colAux = float(currSliceIdx) - (rowAux * mosaicSize_x);\n\n        col = int(colAux);\n        row = int(rowAux);\n    }\n\n    // now, must calculate the mosaicTexCoord.***\n\n    airPressure = _getPollution_nearest(texCoord3d.xy, col, row);\n\n    return true;\n}\n\nvec4 getRainbowColor_byHeight(in float height, in float minHeight_rainbow, in float maxHeight_rainbow, bool hotToCold)\n{\n    \n    float gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\n    float value = gray * 3.99;\n    float h = floor(value);\n    float f = fract(value);\n\n    // test.***\n    if(gray > 0.0000001)\n    {\n        //gray = 0.95;\n    }\n\n    vec4 resultColor = vec4(0.0, 0.0, 0.0, (gray));\n\n    if(hotToCold)\n    {\n        // HOT to COLD.***\n        resultColor.rgb = vec3(1.0, 0.0, 0.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix red & yellow.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(red, yellow, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix yellow & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, green, f);\n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & cyan.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(green, cyan, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix cyan & blue.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, blue, f);\n        }\n    }\n    else\n    {\n        // COLD to HOT.***\n        resultColor.rgb = vec3(0.0, 0.0, 1.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix blue & cyan.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(blue, cyan, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix cyan & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, green, f);  \n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & yellow.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(green, yellow, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix yellow & red.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, red, f);\n        }\n    }\n\n    return resultColor;\n}\n\n\n// https://www.willusher.io/webgl/2019/01/13/volume-rendering-with-webgl\n// The transfer function specifies what color and opacity value should be assigned for a given value sampled from the volume. \n//--------------------------------------------------------------------------------------------------------------------------\n\n// https://developer.nvidia.com/gpugems/gpugems/part-vi-beyond-triangles/chapter-39-volume-rendering-techniques\n//--------------------------------------------------------------------------------------------------------------------------\n\n/*\n// https://martinopilia.com/posts/2018/09/17/volume-raycasting.html\n// Estimate the normal from a finite difference approximation of the gradient\nvec3 normal(vec3 position, float intensity)\n{\n    float d = step_length;\n    float dx = texture(volume, position + vec3(d,0,0)).r - intensity;\n    float dy = texture(volume, position + vec3(0,d,0)).r - intensity;\n    float dz = texture(volume, position + vec3(0,0,d)).r - intensity;\n    return -normalize(NormalMatrix * vec3(dx, dy, dz));\n}*/\n\nbool normalLC(vec3 texCoord3d, in vec3 posLC, inout vec3 result_normal)\n{\n    // Estimate the normal from a finite difference approximation of the gradient\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec3 pix = 1.0 / sim_res3d;\n\n    checkTexCoord3DRange(texCoord3d);\n\n    vec3 vc = texCoord3d;\n\n    // dx.*************************************************\n    float airPressure_dx = 0.0;\n    vec3 velocity_dx;\n    vec3 texCoord3d_dx = vec3(vc + vec3(pix.x, 0.0, 0.0));\n    bool succes_dx =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dx, posLC, airPressure_dx);\n    if(!succes_dx)return false;\n\n    float airPressure_dx_neg = 0.0;\n    vec3 velocity_dx_neg;\n    vec3 texCoord3d_dx_neg = vec3(vc - vec3(pix.x, 0.0, 0.0));\n    bool succes_dx_neg =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dx_neg, posLC, airPressure_dx_neg);\n    if(!succes_dx_neg)return false;\n\n    // dy.*************************************************\n    float airPressure_dy = 0.0;\n    vec3 velocity_dy;\n    vec3 texCoord3d_dy = vec3(vc + vec3(0.0, pix.y, 0.0));\n    bool succes_dy =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dy, posLC, airPressure_dy);\n    if(!succes_dy)return false;\n\n    float airPressure_dy_neg = 0.0;\n    vec3 velocity_dy_neg;\n    vec3 texCoord3d_dy_neg = vec3(vc - vec3(0.0, pix.y, 0.0));\n    bool succes_dy_neg =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dy_neg, posLC, airPressure_dy_neg);\n    if(!succes_dy_neg)return false;\n\n    // dz.*************************************************\n    float airPressure_dz = 0.0;\n    vec3 velocity_dz;\n    vec3 texCoord3d_dz = vec3(vc + vec3(0.0, 0.0, pix.z));\n    bool succes_dz =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dz, posLC, airPressure_dz);\n    if(!succes_dz)return false;\n\n    float airPressure_dz_neg = 0.0;\n    vec3 velocity_dz_neg;\n    vec3 texCoord3d_dz_neg = vec3(vc - vec3(0.0, 0.0, pix.z));\n    bool succes_dz_neg =  get_pollution_fromTexture3d_triLinearInterpolation(texCoord3d_dz_neg, posLC, airPressure_dz_neg);\n    if(!succes_dz_neg)return false;\n\n    //result_normal = normalize(vec3(airPressure_dx - pressure, airPressure_dy - pressure, airPressure_dz - pressure));\n    result_normal = normalize(vec3(airPressure_dx - airPressure_dx_neg, airPressure_dy - airPressure_dy_neg, airPressure_dz - airPressure_dz_neg));\n\n    if(abs(result_normal.x) > 0.0 || abs(result_normal.y) > 0.0 || abs(result_normal.z) > 0.0 )\n    {\n        return true;\n    }\n    else return false;\n\n    return true;\n}\n\nvec4 transfer_fnc(in float pressure)\n{\n    // The transfer function specifies what color and opacity value should be assigned for a given value sampled from the volume. \n    //float maxPressureRef = 1.05;\n    //float minPressureRef = u_airEnvirontmentPressure;\n    float maxPressureRef = u_minMaxPollutionValues.y; // test.***\n    float minPressureRef = u_minMaxPollutionValues.x; // test.***\n    bool bHotToCold = false; // we want coldToHot (blue = min to red = max).***\n    vec4 rainbowCol3 = getRainbowColor_byHeight(pressure, minPressureRef, maxPressureRef, bHotToCold);\n\n    return rainbowCol3;\n}\n\nbool isSimulationBoxEdge(vec2 screenPos)\n{\n    // This function is used to render the simulation box edges.***\n    // check the normals.***\n    vec2 frontTexCoord;\n    vec2 rearTexCoord;\n    get_FrontAndRear_depthTexCoords(screenPos, frontTexCoord, rearTexCoord);\n    float pixelSize_x = 1.0 / (u_screenSize.x * 2.0);\n    float pixelSize_y = 1.0 / u_screenSize.y;\n    \n    // check front.***\n    vec4 normal4front = getNormal_simulationBox(frontTexCoord);\n    vec4 normal4front_up = getNormal_simulationBox(vec2(frontTexCoord.x, frontTexCoord.y + pixelSize_y));\n\n    if(dot(normal4front.xyz, normal4front_up.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4front_left = getNormal_simulationBox(vec2(frontTexCoord.x - pixelSize_x, frontTexCoord.y));    \n    if(dot(normal4front.xyz, normal4front_left.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4front_down = getNormal_simulationBox(vec2(frontTexCoord.x, frontTexCoord.y - pixelSize_y));    \n    if(dot(normal4front.xyz, normal4front_down.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4front_rigth = getNormal_simulationBox(vec2(frontTexCoord.x + pixelSize_x, frontTexCoord.y));    \n    if(dot(normal4front.xyz, normal4front_rigth.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    // now, check the rear normals.***\n    vec4 normal4rear = getNormal_simulationBox(rearTexCoord);\n    vec4 normal4rear_up = getNormal_simulationBox(vec2(rearTexCoord.x, rearTexCoord.y + pixelSize_y));\n\n    if(dot(normal4rear.xyz, normal4rear_up.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4rear_left = getNormal_simulationBox(vec2(rearTexCoord.x - pixelSize_x, rearTexCoord.y));    \n    if(dot(normal4rear.xyz, normal4rear_left.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4rear_down = getNormal_simulationBox(vec2(rearTexCoord.x, rearTexCoord.y - pixelSize_y));    \n    if(dot(normal4rear.xyz, normal4rear_down.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    vec4 normal4rear_rigth = getNormal_simulationBox(vec2(rearTexCoord.x + pixelSize_x, rearTexCoord.y));    \n    if(dot(normal4rear.xyz, normal4rear_rigth.xyz) < 0.95)\n    {\n        return true; // is edge.***\n    }\n\n    return false;\n}\n\nbool findFirstSamplePosition(in vec3 frontPosLC, in vec3 rearPosLC, in vec3 samplingDirLC, in float increLength, in vec3 simulBoxRange, inout vec3 result_samplePos, inout int iteration)\n{\n    // This function finds the first sample position.***\n    // Here is not important the pollution value. Only need know if the pollution value is zero or not.***\n    float contaminationSample = 0.0;\n    vec3 samplePosLC;\n    vec3 samplePosLC_prev;\n    float minValToConsidereSample = u_minMaxPollutionValues[0]; // original.***\n    //float minValToConsidereSample = (u_minMaxPollutionValues[1] - u_minMaxPollutionValues[0]) * 0.0001;\n    for(int i=0; i<30; i++)\n    {\n        // Note : for each smple, must depth check with the scene depthTexure.***\n        float dist = float(i) * increLength;\n        samplePosLC = frontPosLC + samplingDirLC * dist;\n        iteration = i;\n\n        if(i == 0)\n        {\n            samplePosLC_prev = samplePosLC;\n        }\n\n        contaminationSample = 0.0;\n        vec3 sampleTexCoord3d = vec3((samplePosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (samplePosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (samplePosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n        checkTexCoord3DRange(sampleTexCoord3d);\n\n        if(get_pollution_fromTexture3d_triLinearInterpolation_FAST(sampleTexCoord3d, samplePosLC, contaminationSample))\n        {\n            if(contaminationSample > minValToConsidereSample)\n            {\n                if(i > 0)\n                {\n                    // check the prev semiPos.***\n                    vec3 samplePosLC_semiPrev = samplePosLC - samplingDirLC * increLength * 0.5;\n                    if(get_pollution_fromTexture3d_triLinearInterpolation_FAST(sampleTexCoord3d, samplePosLC_semiPrev, contaminationSample))\n                    {\n                        if(contaminationSample > minValToConsidereSample)\n                        {\n                            result_samplePos = samplePosLC_prev;\n                            return true;\n                        }\n                        else\n                        {\n                            //result_samplePos = (samplePosLC + samplePosLC_prev) * 0.5;\n                            result_samplePos = samplePosLC_semiPrev;\n                            return true;\n                        }\n                    }\n                }\n\n                //result_samplePos = (samplePosLC + samplePosLC_prev) * 0.5;\n                result_samplePos = samplePosLC_prev;\n                return true;\n            }\n        }\n        //currSamplePosLC += step_vector_LC;\n        samplePosLC_prev = samplePosLC;\n    }\n\n    return false;\n}\n\nvoid main(){\n\n    // 1rst, read front depth & rear depth and check if exist rear depth.***\n    // If no exist rear depth, then discard.***\n    //vec2 screenPos = vec2(gl_FragCoord.x / u_screenSize.x, gl_FragCoord.y / u_screenSize.y); // \n    vec2 screenPos = v_tex_pos;\n\n    if(isSimulationBoxEdge(screenPos))\n    {\n        vec4 edgeColor = vec4(0.25, 0.5, 0.99, 1.0);\n        gl_FragData[0] = edgeColor;\n\n        #ifdef USE_MULTI_RENDER_TARGET\n            gl_FragData[1] = edgeColor;\n            gl_FragData[2] = edgeColor;\n            gl_FragData[3] = edgeColor;\n        #endif\n        return;\n    }\n\n    // read normal in rear depth. If no exist normal, then, discard.***\n    // calculate the texCoord for rear normal:\n    vec2 frontTexCoord;\n    vec2 rearTexCoord;\n    get_FrontAndRear_depthTexCoords(screenPos, frontTexCoord, rearTexCoord);\n\n    vec4 encodedNormal = texture2D(simulationBoxDoubleNormalTex, frontTexCoord);\n\tif(length(encodedNormal.xyz) < 0.1)\n    {\n        vec4 encodedNormal_rear = texture2D(simulationBoxDoubleNormalTex, rearTexCoord);\n        if(length(encodedNormal_rear.xyz) < 0.1)\n        {\n            discard;\n        }\n        //discard;\n    }\n\n    vec4 normal4rear = getNormal_simulationBox(rearTexCoord);\n    vec4 normal4front = getNormal_simulationBox(frontTexCoord);\n\t//vec3 normal = normal4front.xyz;\n\n    // 1rst, know the scene depth.***\n    vec4 normal4scene = getNormal(v_tex_pos);\n    int estimatedFrustumIdx = int(floor(normal4scene.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_scene = getNearFar_byFrustumIdx(currFrustumIdx);\n\t//float currNear_scene = nearFar_scene.x; // no used in this shader.***\n\tfloat currFar_scene = nearFar_scene.y;\n    float sceneLinearDepth = getDepth(v_tex_pos);\n    float distToCam = sceneLinearDepth * currFar_scene;\n    //vec3 sceneDepthPosCC = getViewRay(v_tex_pos, distToCam - 1.0);\n\n\n    // Now, calculate the positions with the simulation box, front & rear.***\n    // rear.***\n\testimatedFrustumIdx = int(floor(normal4rear.w * 100.0));\n\tdataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tcurrFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_rear = getNearFar_byFrustumIdx(currFrustumIdx);\n\t//float currNear_rear = nearFar_rear.x; // no used in this shader.***\n\tfloat currFar_rear = nearFar_rear.y;\n\n    // front.***\n    estimatedFrustumIdx = int(floor(normal4front.w * 100.0));\n\tcurrFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_front = getNearFar_byFrustumIdx(currFrustumIdx);\n\t//float currNear_front = nearFar_front.x; // no used in this shader.***\n\tfloat currFar_front = nearFar_front.y;\n\n    // Now, calculate the rearPosCC & frontPosCC.***\n    vec3 frontPosCC;\n    vec3 rearPosCC;\n    get_FrontAndRear_posCC(screenPos, currFar_rear, currFar_front, frontPosCC, rearPosCC);\n\n    // Now check cutting plane if exist.***\n    // u_cuttingPlanePosLC\n    // uniform mat4 modelViewMatrixRelToEyeInv;\n    // uniform vec3 encodedCameraPositionMCHigh;\n    // uniform vec3 encodedCameraPositionMCLow;\n    // u_simulBoxTMatInv\n    vec4 camPosRelToSimBox;\n    vec3 cuttingPosCC;\n    vec3 frontPosLCKeep;\n    if(u_cuttingPlaneIdx == 0 || u_cuttingPlaneIdx == 1 || u_cuttingPlaneIdx == 2)\n    {\n        vec4 encodedNormal4cuttingPlane = texture2D(cuttingPlaneNormalTex, v_tex_pos);\n        if(length(encodedNormal4cuttingPlane.xyz) > 0.1)\n        {\n            vec4 normal4cuttingPlane = getNormal_cuttingPlane(v_tex_pos);\n            estimatedFrustumIdx = int(floor(normal4cuttingPlane.w * 100.0));\n            currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n            vec2 nearFar_cuttingPlane = getNearFar_byFrustumIdx(currFrustumIdx);\n            float currFar_cuttingPlane = nearFar_cuttingPlane.y;\n            \n            get_cuttingPlane_posCC(screenPos, currFar_cuttingPlane, cuttingPosCC);\n\n            // before to change the frontPosCC, must calculate the camPosRelToSimBox.***\n            vec4 frontPosWCRelToEyeKeep = modelViewMatrixRelToEyeInv * vec4(frontPosCC.xyz, 1.0);\n            posWCRelToEye_to_posLC(frontPosWCRelToEyeKeep, u_simulBoxTMatInv, u_simulBoxPosHigh, u_simulBoxPosLow, frontPosLCKeep);\n\n            // now change the frontPosCC.***\n            frontPosCC = cuttingPosCC;\n\n            if(cuttingPosCC.z < rearPosCC.z)\n            {\n                // if cutting plane moves entirely inside of the simulBox, then never enter here.***\n                discard;\n            }\n        }\n\n        // now, calculate camPosRelToSimBox.***\n        vec3 highDiff = encodedCameraPositionMCHigh - u_simulBoxPosHigh;\n        vec3 lowDiff = encodedCameraPositionMCLow - u_simulBoxPosLow;\n        vec3 camPosWC = highDiff + lowDiff;\n        camPosRelToSimBox = u_simulBoxTMatInv * vec4(camPosWC, 1.0);\n    }\n\n    // Now, calculate frontPosWC & rearPosWC.***\n    vec4 frontPosWCRelToEye = modelViewMatrixRelToEyeInv * vec4(frontPosCC.xyz, 1.0);\n    vec4 rearPosWCRelToEye = modelViewMatrixRelToEyeInv * vec4(rearPosCC.xyz, 1.0);\n\n    // Now, calculate frontPosLC & rearPosLC.***\n    vec3 frontPosLC;\n    vec3 rearPosLC;\n    posWCRelToEye_to_posLC(frontPosWCRelToEye, u_simulBoxTMatInv, u_simulBoxPosHigh, u_simulBoxPosLow, frontPosLC);\n    posWCRelToEye_to_posLC(rearPosWCRelToEye, u_simulBoxTMatInv, u_simulBoxPosHigh, u_simulBoxPosLow, rearPosLC);\n\n    if(u_cuttingPlaneIdx == 0) // x-axis\n    {\n        float error = 10.0;\n        if(camPosRelToSimBox.x >= u_cuttingPlanePosLC.x)\n        {\n            if(frontPosLC.x - error > u_cuttingPlanePosLC.x)// || rearPosLC.y > u_cuttingPlanePosLC.y)\n            {\n                discard;\n            }\n        }\n        else\n        {\n            if(frontPosLC.x + error < u_cuttingPlanePosLC.x)// || rearPosLC.y < u_cuttingPlanePosLC.y)\n            {\n                discard;\n            }\n        }\n    }\n    else if(u_cuttingPlaneIdx == 1) // y-axis\n    {\n        float error = 10.0;\n        if(camPosRelToSimBox.y >= u_cuttingPlanePosLC.y)\n        {\n            if(frontPosLC.y - error > u_cuttingPlanePosLC.y)// || rearPosLC.y > u_cuttingPlanePosLC.y)\n            {\n                discard;\n            }\n        }\n        else\n        {\n            if(frontPosLC.y + error < u_cuttingPlanePosLC.y)// || rearPosLC.y < u_cuttingPlanePosLC.y)\n            {\n                discard;\n            }\n        }\n    }\n    else if(u_cuttingPlaneIdx == 2) // z-axis\n    {\n        float error = 10.0;\n        if(camPosRelToSimBox.z >= u_cuttingPlanePosLC.z)\n        {\n            if(frontPosLC.z - error > u_cuttingPlanePosLC.z)// || rearPosLC.y > u_cuttingPlanePosLC.y)\n            {\n                // vec4 colorDiscard = vec4(1.0, 0.3, 0.3, 1.0);\n                // gl_FragData[0] = colorDiscard;\n                // #ifdef USE_MULTI_RENDER_TARGET\n                //     gl_FragData[1] = colorDiscard;\n                //     gl_FragData[2] = colorDiscard;\n                //     gl_FragData[3] = colorDiscard;\n                // #endif\n                // return;\n                discard;\n            }\n        }\n        else\n        {\n            if(frontPosLC.z + error < u_cuttingPlanePosLC.z)// || rearPosLC.y < u_cuttingPlanePosLC.y)\n            {\n                // vec4 colorDiscard = vec4(0.3, 1.0, 0.3, 1.0);\n                // gl_FragData[0] = colorDiscard;\n                // #ifdef USE_MULTI_RENDER_TARGET\n                //     gl_FragData[1] = colorDiscard;\n                //     gl_FragData[2] = colorDiscard;\n                //     gl_FragData[3] = colorDiscard;\n                // #endif\n                // return;\n                discard;\n            }\n        }\n    }\n\n    // Now, with "frontPosLC" & "rearPosLC", calculate the frontTexCoord3d & rearTexCoord3d.***\n    vec3 simulBoxRange = vec3(u_simulBoxMaxPosLC.x - u_simulBoxMinPosLC.x, u_simulBoxMaxPosLC.y - u_simulBoxMinPosLC.y, u_simulBoxMaxPosLC.z - u_simulBoxMinPosLC.z);\n\n    float contaminationSample = 0.0;\n    float smplingCount = 0.0;\n    float segmentLength = distance(rearPosLC, frontPosLC);\n    vec3 samplingDirLC = normalize(rearPosLC - frontPosLC);\n    //vec3 samplingDirCC = normalize(rearPosCC - frontPosCC);\n    float samplingsCount = 30.0;\n    float increLength = segmentLength / samplingsCount;\n    if(increLength < u_voxelSizeMeters.x)\n    {\n        //increLength = u_voxelSizeMeters.x;\n    }\n\n    vec4 color4Aux = vec4(0.0, 0.0, 0.0, 0.0);\n\n    vec4 finalColor4 = vec4(0.0);\n    float contaminationAccum = 0.0;\n    // u_minMaxPollutionValues\n\n    vec3 firstPosLC = vec3(frontPosLC);\n    int iteration = 0;\n    if(!findFirstSamplePosition(frontPosLC, rearPosLC, samplingDirLC, increLength, simulBoxRange, firstPosLC, iteration))\n    {\n        // vec4 colorDiscard = vec4(0.3, 0.3, 0.3, 1.0);\n        // gl_FragData[0] = colorDiscard;\n        // #ifdef USE_MULTI_RENDER_TARGET\n        //     gl_FragData[1] = colorDiscard;\n        //     gl_FragData[2] = colorDiscard;\n        //     gl_FragData[3] = colorDiscard;\n        // #endif\n        \n        return;\n    }\n    \n    // recalculate segmentLength & increLength.***\n    samplingsCount = 30.0;\n    segmentLength = distance(rearPosLC, firstPosLC);\n    increLength = segmentLength / samplingsCount;\n\n    vec4 colorTest = vec4(0.0, 0.0, 0.5, 1.0);\n    colorTest = vec4(firstPosLC.x /u_voxelSizeMeters.x, firstPosLC.y /u_voxelSizeMeters.y, firstPosLC.z /u_voxelSizeMeters.z , 1.0);\n    \n    // Sampling far to near.***\n    bool normalLC_calculated = true;\n\n    float contaminationSamples[30];\n    int samplesCount = 0;\n    for(int i=0; i<30; i++)\n    {\n        // Note : for each smple, must depth check with the scene depthTexure.***\n        vec3 samplePosLC = firstPosLC + samplingDirLC * increLength * float(i);\n\n        //vec3 samplePosCC = firstPosLC + samplingDirCC * increLength * float(i);\n        //if(abs(samplePosCC.z) > distToCam)\n        //{\n        //    break;\n        //}\n\n        contaminationSample = 0.0;\n        vec3 sampleTexCoord3d = vec3((samplePosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (samplePosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (samplePosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n        checkTexCoord3DRange(sampleTexCoord3d);\n\n        if(get_pollution_fromTexture3d_triLinearInterpolation(sampleTexCoord3d, samplePosLC, contaminationSample))\n        {\n            contaminationSamples[i] = contaminationSample;\n            samplesCount += 1;\n            // vec3 currNormalLC;\n            // // if(!normalLC(sampleTexCoord3d, samplePosLC, currNormalLC))\n            // // {\n            // //    normalLC_calculated = false;\n            // //    continue;\n            // // }\n\n            // //vec4 currColor4 = transfer_fnc(contaminationSample);\n            // vec4 currColor4 = getRainbowColor_byHeight(contaminationSample, u_minMaxPollutionValues.x, u_minMaxPollutionValues.y * 0.3, false);\n            // //float unitaryContaminationSample = (contaminationSample - u_minMaxPollutionValues.x) / (u_minMaxPollutionValues.y - u_minMaxPollutionValues.x);\n \n            // //if(length(currNormalLC) > 0.0)\n            // {\n            //     // https://www.willusher.io/webgl/2019/01/13/volume-rendering-with-webgl\n            //     finalColor4.rgb += (1.0 - finalColor4.a) * currColor4.a * currColor4.rgb; \n            //     finalColor4.a += (1.0 - finalColor4.a) * currColor4.a;\n            // }\n\n            // smplingCount += 1.0;\n\n            // // Optimization: break out of the loop when the color is near opaque\n            // if (finalColor4.a >= 0.95) {\n            //     break;\n            // }\n\n            // contaminationAccum += contaminationSample;\n            \n        }\n        else{\n            contaminationSamples[i] = 0.0;\n        }\n    }\n\n    int samplesCount2 = 0;\n    for(int i=0; i<30; i++)\n    {\n        contaminationSample = contaminationSamples[i];\n        if(contaminationSample > 0.0)\n        {\n            vec4 currColor4 = getRainbowColor_byHeight(contaminationSample, u_minMaxPollutionValues.x, u_minMaxPollutionValues.y * 0.3, false);\n\n            if(u_useMinMaxValuesToRender == 1)\n            {\n                float targetValue = u_minMaxPollutionValuesToRender.y;\n                \n                //targetValue = u_minMaxPollutionValues.y;\n                //currColor4.a = contaminationSample / targetValue;\n                if(currColor4.a > 1.0)\n                {\n                    currColor4.a = 1.0;\n                }\n\n                //currColor4.a *= smoothstep(0.0, targetValue, contaminationSample);\n                currColor4.a = smoothstep(0.0, targetValue, contaminationSample);\n            }\n\n            // https://www.willusher.io/webgl/2019/01/13/volume-rendering-with-webgl\n            finalColor4.rgb += (1.0 - finalColor4.a) * currColor4.a * currColor4.rgb; \n            finalColor4.a += (1.0 - finalColor4.a) * currColor4.a;\n            samplesCount2 += 1;\n\n            contaminationAccum += contaminationSample;\n        }\n\n        // Optimization: break out of the loop when the color is near opaque\n        if (finalColor4.a >= 0.95) {\n            break;\n        }\n\n        // if(samplesCount2 >= samplesCount)\n        // {\n        //     break;\n        // }\n    }\n\n    // contaminationAccum /= float(samplesCount2);\n    // finalColor4 = getRainbowColor_byHeight(contaminationAccum, u_minMaxPollutionValues.x, u_minMaxPollutionValues.y * 0.3, false);\n    // finalColor4.a *= 10.0;\n\n    if(smplingCount < 1.0)\n    {\n        //discard;\n    }\n\n    if(smplingCount < 1.0)\n    {\n        smplingCount = 1.0;\n    }\n\n    color4Aux = finalColor4;\n\n    if(!normalLC_calculated)\n    {\n        //color4Aux = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n\n    gl_FragData[0] = color4Aux;\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = color4Aux;\n        gl_FragData[2] = color4Aux;\n        gl_FragData[3] = color4Aux;\n    #endif\n}\n',depthBufferUtils:"\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} ",depthTexturesMergerFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D depthTexture_0;  \nuniform sampler2D normalTexture_0;\nuniform sampler2D depthTexture_1;  \nuniform sampler2D normalTexture_1;\nuniform sampler2D depthTexture_2;  \nuniform sampler2D normalTexture_2;\nuniform sampler2D depthTexture_3;  \nuniform sampler2D normalTexture_3;\n\nuniform int uNumFrustums;\n\nvarying vec2 v_tex_pos;\n\nfloat getMinValue(float a, float b, float c)\n{\n    float x = min(a, b);\n    return min(x, c);\n}\n\nfloat getMaxValue(float a, float b, float c)\n{\n    float x = max(a, b);\n    return max(x, c);\n}\n\nbool isNan(float val)\n{\n  return (val <= 0.0 || 0.0 <= val) ? false : true;\n}\n\nvec4 getDepth(in int frustumIdx, in vec2 texCoord)\n{\n    vec4 color4;\n\n    if(frustumIdx == 0)\n    {\n        color4 = texture2D(depthTexture_0, texCoord);\n    }\n    else if(frustumIdx == 1)\n    {\n        color4 = texture2D(depthTexture_1, texCoord);\n    }\n    else if(frustumIdx == 2)\n    {\n        color4 = texture2D(depthTexture_2, texCoord);\n    }\n    else if(frustumIdx == 3)\n    {\n        color4 = texture2D(depthTexture_3, texCoord);\n    }\n\n    return color4;\n}\n\nvec4 getNormal(in int frustumIdx, in vec2 texCoord)\n{\n    vec4 color4;\n\n    if(frustumIdx == 0)\n    {\n        color4 = texture2D(normalTexture_0, texCoord);\n    }\n    else if(frustumIdx == 1)\n    {\n        color4 = texture2D(normalTexture_1, texCoord);\n    }\n    else if(frustumIdx == 2)\n    {\n        color4 = texture2D(normalTexture_2, texCoord);\n    }\n    else if(frustumIdx == 3)\n    {\n        color4 = texture2D(normalTexture_3, texCoord);\n    }\n\n    return color4;\n}\n\nvoid main()\n{           \n    vec2 texCoord = vec2(1.0 - v_tex_pos.x, 1.0 - v_tex_pos.y);\n\n    // Take the base color.\n    vec4 textureColor = vec4(0.0, 0.0, 0.0, 0.0);\n    vec4 normalColor = vec4(0.0, 0.0, 0.0, 1.0);\n    bool isValid = false;\n\n    for(int i=0; i<4; i++)\n    {\n        if(i < uNumFrustums)\n        {\n            vec4 normal4 = getNormal(i, texCoord);\n            \n            // check the depth value.***\n            if((abs(normal4.x) + abs(normal4.y) + abs(normal4.z)) > 0.1)\n            {\n                // is valid depth value.***\n                vec4 depthColor4 = getDepth(i, texCoord);\n\n                textureColor = depthColor4;\n                normalColor = normal4;\n                isValid = true;\n                break;\n            }\n        }\n    }\n\n    if(!isValid)\n    {\n        #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(0.0, 0.0, 0.0, 1.0);\n        #endif\n        return;\n    }\n    //discard;\n\n    \n    gl_FragData[0] = textureColor;\n\n    #ifdef USE_MULTI_RENDER_TARGET\n    gl_FragData[1] = normalColor;\n    #endif\n\t\n}",draw_frag:"precision mediump float;\n\nuniform sampler2D u_wind;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\t\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tfloat r = speed_t;\n\t\tgl_FragColor = vec4(r,g,b,1.0);\n\t}\n\telse{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\tgl_FragColor = vec4(intensity,intensity,intensity,1.0);\n\t}\n}\n",draw_frag3D:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D u_wind;\nuniform sampler2D u_depthTex;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\nuniform float u_tailAlpha;\nuniform float u_externAlpha;\nuniform bool bUseLogarithmicDepth;\n\nuniform int uFrustumIdx;\nvarying float vDepth;\n\nvarying vec2 v_particle_pos;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat minHeight_rainbow = 0.0;\n\tfloat maxHeight_rainbow = 1.0;\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\nvec3 getWhiteToBlueColor_byHeight(float height, float minHeight, float maxHeight)\n{\n    // White to Blue in 32 steps.\n    float gray = (height - minHeight)/(maxHeight - minHeight);\n    gray = 1.0 - gray; // invert gray value (white to blue).\n    // calculate r, g, b values by gray.\n\n    float r, g, b;\n\n    // Red.\n    if(gray >= 0.0 && gray < 0.15625) // [1, 5] from 32 divisions.\n    {\n        float minGray = 0.0;\n        float maxGray = 0.15625;\n        //float maxR = 0.859375; // 220/256.\n        float maxR = 1.0;\n        float minR = 0.3515625; // 90/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        r = maxR - relativeGray*(maxR - minR);\n    }\n    else if(gray >= 0.15625 && gray < 0.40625) // [6, 13] from 32 divisions.\n    {\n        float minGray = 0.15625;\n        float maxGray = 0.40625;\n        float maxR = 0.3515625; // 90/256.\n        float minR = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        r = maxR - relativeGray*(maxR - minR);\n    }\n    else  // [14, 32] from 32 divisions.\n    {\n        r = 0.0;\n    }\n\n    // Green.\n    if(gray >= 0.0 && gray < 0.15625) // [1, 5] from 32 divisions.\n    {\n        g = 1.0; // 256.\n    }\n    else if(gray >= 0.15625 && gray < 0.5625) // [6, 18] from 32 divisions.\n    {\n        float minGray = 0.15625;\n        float maxGray = 0.5625;\n        float maxG = 1.0; // 256/256.\n        float minG = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        g = maxG - relativeGray*(maxG - minG);\n    }\n    else  // [18, 32] from 32 divisions.\n    {\n        g = 0.0;\n    }\n\n    // Blue.\n    if(gray < 0.5625)\n    {\n        b = 1.0;\n    }\n    else // gray >= 0.5625 && gray <= 1.0\n    {\n        float minGray = 0.5625;\n        float maxGray = 1.0;\n        float maxB = 1.0; // 256/256.\n        float minB = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        b = maxB - relativeGray*(maxB - minB);\n    }\n\n    return vec3(r, g, b);\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvoid main() {\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tfloat r = pt.x*pt.x+pt.y*pt.y;\n\tif(r > 0.25)\n\t\tdiscard;\n\n\t\n\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\tvec4 albedo4;\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tvec3 col3 = getRainbowColor_byHeight(speed_t);\n\t\t//vec3 col3 = getWhiteToBlueColor_byHeight(speed_t, 0.0, 1.0);\n\t\tfloat r = speed_t;\n\t\talbedo4 = vec4(col3.x, col3.y, col3.z ,u_tailAlpha*u_externAlpha);\n\t}\n\telse{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\talbedo4 = vec4(intensity,intensity,intensity,u_tailAlpha*u_externAlpha);\n\t}\n\n\tgl_FragData[0] = albedo4;\n\t\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\t// save depth, normal, albedo.\n\t\tgl_FragData[1] = packDepth(vDepth); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vec3(0.0, 0.0, 1.0);\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\t#endif\n\t\n\n\t//if(r > 0.16)\n\t//gl_FragData[0] = vec4(1.0, 1.0, 1.0, u_tailAlpha*u_externAlpha);\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",draw_vert:"precision mediump float;\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_particles, vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res));\n\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a);\n\n    gl_PointSize = 1.0;\n    gl_Position = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n}\n",draw_vert3D:"precision highp float;\n\n// This shader draws windParticles in 3d directly from positions on u_particles image.***\nattribute float a_index;\n\nuniform sampler2D u_particles; // channel-1.***\nuniform sampler2D u_particles_next; // channel-2.***\nuniform float u_particles_res;\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 buildingRotMatrix;\nuniform mat4 ModelViewProjectionMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 u_camPosWC;\nuniform vec3 u_geoCoordRadiansMax;\nuniform vec3 u_geoCoordRadiansMin;\nuniform float pendentPointSize;\nuniform float u_tailAlpha;\nuniform float u_layerAltitude;\n\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float far;\n\nvarying vec2 v_particle_pos;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\n\n#define M_PI 3.1415926535897932384626433832795\n\nvec2 splitValue(float value)\n{\n\tfloat doubleHigh;\n\tvec2 resultSplitValue;\n\tif (value >= 0.0) \n\t{\n\t\tdoubleHigh = floor(value / 65536.0) * 65536.0; //unsigned short max\n\t\tresultSplitValue.x = doubleHigh;\n\t\tresultSplitValue.y = value - doubleHigh;\n\t}\n\telse \n\t{\n\t\tdoubleHigh = floor(-value / 65536.0) * 65536.0;\n\t\tresultSplitValue.x = -doubleHigh;\n\t\tresultSplitValue.y = value + doubleHigh;\n\t}\n\t\n\treturn resultSplitValue;\n}\n\t\nvec3 geographicToWorldCoord(float lonRad, float latRad, float alt)\n{\n\t// NO USED.\n\t// defined in the LINZ standard LINZS25000 (Standard for New Zealand Geodetic Datum 2000)\n\t// https://www.linz.govt.nz/data/geodetic-system/coordinate-conversion/geodetic-datum-conversions/equations-used-datum\n\t// a = semi-major axis.\n\t// e2 = firstEccentricitySquared.\n\t// v = a / sqrt(1 - e2 * sin2(lat)).\n\t// x = (v+h)*cos(lat)*cos(lon).\n\t// y = (v+h)*cos(lat)*sin(lon).\n\t// z = [v*(1-e2)+h]*sin(lat).\n\tfloat equatorialRadius = 6378137.0; // meters.\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat cosLon = cos(lonRad);\n\tfloat cosLat = cos(latRad);\n\tfloat sinLon = sin(lonRad);\n\tfloat sinLat = sin(latRad);\n\tfloat a = equatorialRadius;\n\tfloat e2 = firstEccentricitySquared;\n\tfloat v = a/sqrt(1.0 - e2 * sinLat * sinLat);\n\tfloat h = alt;\n\t\n\tfloat x = (v+h)*cosLat*cosLon;\n\tfloat y = (v+h)*cosLat*sinLon;\n\tfloat z = (v*(1.0-e2)+h)*sinLat;\n\n\tvec3 resultCartesian = vec3(x, y, z);\n\t\n\treturn resultCartesian;\n}\n\nvec2 getOffset(vec2 particlePos, float radius)\n{\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\n\tfloat distortion = cos((minLatRad + particlePos.y * latRadRange ));\n\tfloat xOffset = (particlePos.x - 0.5)*distortion * lonRadRange * radius;\n\tfloat yOffset = (0.5 - particlePos.y) * latRadRange * radius;\n\n\treturn vec2(xOffset, yOffset);\n}\n\nvoid main() {\n\tvec2 texCoord = vec2(fract(a_index / u_particles_res), floor(a_index / u_particles_res) / u_particles_res);\n\n\tvec4 color_curr = texture2D(u_particles, texCoord);\n    //vec2 particle_pos_curr = vec2(color_curr.r / 255.0 + color_curr.b, color_curr.g / 255.0 + color_curr.a);\n\n\t//vec4 color_next = texture2D(u_particles_next, texCoord);\n    //vec2 particle_pos_next = vec2(color_next.r / 255.0 + color_next.b, color_next.g / 255.0 + color_next.a);\n\t//v_particle_pos = mix(particle_pos_curr, particle_pos_next, 0.0);\n\n    //vec4 color = texture2D(u_particles, texCoord);\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(color_curr.r / 255.0 + color_curr.b,color_curr.g / 255.0 + color_curr.a); // original.***\n\n\t// calculate the offset at the earth radius.***\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tvec2 offset = getOffset(v_particle_pos, radius);\n\n\tfloat xOffset = offset.x;\n\tfloat yOffset = offset.y;\n\tvec4 rotatedPos = buildingRotMatrix * vec4(xOffset, yOffset, 0.0, 1.0);\n\t\n\t//vec4 posWC = vec4((rotatedPos.xyz + buildingPosLOW) + ( buildingPosHIGH ), 1.0);\n\tvec4 posCC = vec4((rotatedPos.xyz + buildingPosLOW - encodedCameraPositionMCLow) + ( buildingPosHIGH - encodedCameraPositionMCHigh), 1.0);\n\t\n\t// Now calculate the position on camCoord.***\n\t//gl_Position = ModelViewProjectionMatrix * posWC;\n\tgl_Position = ModelViewProjectionMatrixRelToEye * posCC;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * posCC;\n\tvDepth = (-orthoPos.z)/(far); // the correct value.\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n\t\n\t// Now calculate the point size.\n\t//float dist = distance(vec4(u_camPosWC.xyz, 1.0), vec4(posWC.xyz, 1.0));\n\tfloat dist = length(posCC.xyz);\n\tgl_PointSize = (1.0 + pendentPointSize/(dist))*u_tailAlpha; \n\t//gl_PointSize = 3.0*u_tailAlpha; \n\tfloat maxPointSize = 4.0;\n\n\tif(gl_PointSize > maxPointSize)\n\tgl_PointSize = maxPointSize;\n\telse if(gl_PointSize < 2.0)\n\tgl_PointSize = 2.0;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",dustParticleFS:"precision lowp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D smokeTex;\nuniform vec4 uStrokeColor;\nvarying vec4 vColor;\nvarying float glPointSize;\nuniform int uPointAppereance; // square, circle, romboide,...\nuniform int uStrokeSize;\nuniform bool bUseLogarithmicDepth;\nuniform int uFrustumIdx;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vDustConcent;\nvarying float vDustConcentRel;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\nvoid main()\n{\n\tvec4 textureColor = texture2D(smokeTex, gl_PointCoord);\n\tif(textureColor.a < 0.1)\n\tdiscard;\n\n\tvec4 finalColor = vColor;\n\tfloat alpha = textureColor.a * 2.0;\n\tfloat green = 1.0;\n\n\tfinalColor = vec4(green * 0.5, green, 0.1, alpha);\n\t//finalColor = vec4(1.0, 0.0, 0.0, 1.0);\n\n\tgl_FragData[0] = finalColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\tgl_FragData[1] = packDepth(vDepth);\n\t\t\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = finalColor; \n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",dustParticleVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform float uDustConcentration;\nuniform vec2 uDustConcentMinMax;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float vDepth;\n\nuniform float uFCoef_logDepth;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDustConcent;\nvarying float vDustConcentRel;\n\nvoid main()\n{\n\tvec4 rotatedPos;\n\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor = oneColor4;\n\t}\n\telse\n\t\tvColor = color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tvDepth = -(modelViewMatrixRelToEye * pos).z/far; // original.***\n\n\tfloat minPointSize = 2.0;\n\tfloat maxPointSize = 60.0;\n\tfloat pendentPointSize = 2000.0 * uDustConcentration;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t//if(gl_PointSize > maxPointSize)\n\t//\tgl_PointSize = maxPointSize;\n\t//if(gl_PointSize < 2.0)\n\t//\tgl_PointSize = 2.0;\n\n\tvDustConcentRel = uDustConcentration/uDustConcentMinMax[1];\n\tvDustConcent = uDustConcentration;\n\t//gl_PointSize *= uDustConcentration;\n\tglPointSize = gl_PointSize;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}",dustTextureModeFS:"precision lowp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texUp;\nuniform sampler2D texDown;\nuniform vec2 u_tex_res;\n\nvarying vec4 vColor;\nuniform bool bUseLogarithmicDepth;\nuniform int uFrustumIdx;\nuniform vec2 uDustConcentMinMax_up;\nuniform vec2 uDustConcentMinMax_down;\nuniform float uZFactor;\n\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying vec2 vTexCoord;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\nvec3 getRainbowColor_byHeight(float height)\n{\n\t//float gray = (height - uDustConcentMinMax[0])/(uDustConcentMinMax[1] - uDustConcentMinMax[0]);\n\tfloat gray = height;\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n}   \n\nfloat round(in float value)\n{\n\treturn floor(value + 0.5);\n}\n\nfloat calculateIndex(in float rawConcentration)\n{\n\t//Index index1 = new Index(0, 50, 1);    // 좋음\n\t//Index index2 = new Index(51, 100, 2);  // 보통\n\t//Index index3 = new Index(101, 250, 3); // 나쁨\n\t//Index index4 = new Index(251, 500, 4); // 매우나쁨\n\n\t//pm25.addIndexStep(new IndexStep(index1,  0.0,  15.0));\n\t//pm25.addIndexStep(new IndexStep(index2, 16.0,  35.0));\n\t//pm25.addIndexStep(new IndexStep(index3, 36.0,  75.0));\n\t//pm25.addIndexStep(new IndexStep(index4, 76.0, 500.0));\n\n\t// 1rst, calculate index:\n\tint indexStep;\n\tfloat valueAux = rawConcentration;\n\tif(valueAux >= 0.0 && valueAux <= 15.0)\n\t{\n\t\tindexStep = 1;\n\t}\n\telse if(valueAux > 15.0 && valueAux <= 35.0)\n\t{\n\t\tindexStep = 2;\n\t}\n\telse if(valueAux > 35.0 && valueAux <= 75.0)\n\t{\n\t\tindexStep = 3;\n\t}\n\telse if(valueAux > 75.0 && valueAux <= 500.0)\n\t{\n\t\tindexStep = 4;\n\t}\n\telse\n\t{\n\t\tindexStep = -1;\n\t}\n\n\tfloat iLow, iHigh;\n\tfloat cLow, cHigh;\n\n\tint idx = indexStep;\n\n\tif(idx == 1)\n\t{\n\t\tiLow = 0.0;\n\t\tiHigh = 50.0;\n\t\tcLow = 0.0;\n\t\tcHigh = 15.0;\n\t}\n\telse if(idx == 2)\n\t{\n\t\tiLow = 51.0;\n\t\tiHigh = 100.0;\n\t\tcLow = 16.0;\n\t\tcHigh = 35.0;\n\t}\n\telse if(idx == 3)\n\t{\n\t\tiLow = 101.0;\n\t\tiHigh = 250.0;\n\t\tcLow = 36.0;\n\t\tcHigh = 75.0;\n\t}\n\telse if(idx == 4)\n\t{\n\t\tiLow = 251.0;\n\t\tiHigh = 500.0;\n\t\tcLow = 76.0;\n\t\tcHigh = 500.0;\n\t}\n\n\tfloat rawIndex = (iHigh - iLow) / (cHigh - cLow) * (rawConcentration - cLow) + iLow;\n\t//return int(round(rawIndex));\n\treturn rawIndex;\n}\n\nvec3 getBBCAndYeonHwa_colorCoded(float index)\n{\n\t// 0 = rgb(0.16796875, 0.51171875, 0.7265625)\n\t// 50 = rgb(0.66796875, 0.86328125, 0.640625)\n\t// 100 = rgb(0.99609375, 0.99609375, 0.74609375)\n\t// 250 = rgb(0.98828125, 0.6796875, 0.37890625)\n\t// 500 = rgb(0.83984375, 0.09765625, 0.109375)\n\n\tvec3 result;\n\n\tif(index < 0.0)\n\t{\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t}\n\n\tif(index >= 0.0 && index < 50.0)\n\t{\n\t\tvec3 colorTop = vec3(0.16796875, 0.51171875, 0.7265625);\n\t\tvec3 colorDown = vec3(0.66796875, 0.86328125, 0.640625);\n\t\tfloat indexFactor = (index - 0.0)/(50.0 - 0.0);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(1.0, 0.0, 0.0);\n\t}\n\telse if(index >= 50.0 && index < 100.0)\n\t{\n\t\tvec3 colorTop = vec3(0.66796875, 0.86328125, 0.640625);\n\t\tvec3 colorDown = vec3(0.99609375, 0.99609375, 0.74609375);\n\t\tfloat indexFactor = (index - 50.0)/(100.0 - 50.0);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(0.0, 1.0, 0.0);\n\t}\n\telse if(index >= 100.0 && index < 250.0)\n\t{\n\t\tvec3 colorTop = vec3(0.99609375, 0.99609375, 0.74609375);\n\t\tvec3 colorDown = vec3(0.98828125, 0.6796875, 0.37890625);\n\t\tfloat indexFactor = (index - 100.0)/(250.0 - 100.0);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(0.0, 0.0, 1.0);\n\t}\n\telse if(index >= 250.0 && index < 500.0)\n\t{\n\t\tvec3 colorTop = vec3(0.98828125, 0.6796875, 0.37890625);\n\t\tvec3 colorDown = vec3(0.83984375, 0.09765625, 0.109375);\n\t\tfloat indexFactor = (index - 250.0)/(500.0 - 250.0);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(1.0, 1.0, 0.0);\n\t}\n\telse\n\t{\n\t\treturn vec3(1.0, 0.0, 1.0);\n\t}\n\n\treturn result;\n}\n\nvec3 getBBCAndYeonHwa_colorCoded_tight(float rawConcent)\n{\n\t// 0 = rgb(0.16796875, 0.51171875, 0.7265625)\n\t// 50 = rgb(0.66796875, 0.86328125, 0.640625)\n\t// 100 = rgb(0.99609375, 0.99609375, 0.74609375)\n\t// 250 = rgb(0.98828125, 0.6796875, 0.37890625)\n\t// 500 = rgb(0.83984375, 0.09765625, 0.109375)\n\n\t// Try to exagere index.***\n\t//uDustConcentMinMax[1] - uDustConcentMinMax[0]\n\tfloat maxConcent = uDustConcentMinMax_down[1];\n\tfloat minConcent = uDustConcentMinMax_down[0];\n\tfloat increConcent = maxConcent/4.0;\n\n\tvec3 result;\n\n\tif(rawConcent < 0.0)\n\t{\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t}\n\n\tif(rawConcent >= minConcent && rawConcent < minConcent + increConcent * 1.0)\n\t{\n\t\tvec3 colorTop = vec3(0.16796875, 0.51171875, 0.7265625);\n\t\tvec3 colorDown = vec3(0.66796875, 0.86328125, 0.640625);\n\t\tfloat minValue = minConcent;\n\t\tfloat maxValue = minConcent + increConcent * 1.0;\n\t\tfloat indexFactor = (rawConcent - minValue)/(maxValue - minValue);\n\t\tindexFactor = indexFactor - floor(indexFactor); \n\t\t//result = mix(colorDown, colorTop, indexFactor);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(1.0, 0.0, 0.0);\n\t}\n\telse if(rawConcent >= minConcent + increConcent * 1.0 && rawConcent < minConcent + increConcent * 2.0)\n\t{\n\t\tvec3 colorTop = vec3(0.66796875, 0.86328125, 0.640625);\n\t\tvec3 colorDown = vec3(0.99609375, 0.99609375, 0.74609375);\n\t\tfloat minValue = minConcent + increConcent * 1.0;\n\t\tfloat maxValue = minConcent + increConcent * 2.0;\n\t\tfloat indexFactor = (rawConcent - minValue)/(maxValue - minValue);\n\t\tindexFactor = indexFactor - floor(indexFactor); \n\t\t//result = mix(colorDown, colorTop, indexFactor);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(0.0, 1.0, 0.0);\n\t}\n\telse if(rawConcent >= minConcent + increConcent * 2.0 && rawConcent < minConcent + increConcent * 3.0)\n\t{\n\t\tvec3 colorTop = vec3(0.99609375, 0.99609375, 0.74609375);\n\t\tvec3 colorDown = vec3(0.98828125, 0.6796875, 0.37890625);\n\t\tfloat minValue = minConcent + increConcent * 2.0;\n\t\tfloat maxValue = minConcent + increConcent * 3.0;\n\t\tfloat indexFactor = (rawConcent - minValue)/(maxValue - minValue);\n\t\tindexFactor = indexFactor - floor(indexFactor); \n\t\t//result = mix(colorDown, colorTop, indexFactor);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(0.0, 0.0, 1.0);\n\t}\n\telse if(rawConcent >= minConcent + increConcent * 3.0 && rawConcent < minConcent + increConcent * 4.0)\n\t{\n\t\tvec3 colorTop = vec3(0.98828125, 0.6796875, 0.37890625);\n\t\tvec3 colorDown = vec3(0.83984375, 0.09765625, 0.109375);\n\t\tfloat minValue = minConcent + increConcent * 3.0;\n\t\tfloat maxValue = minConcent + increConcent * 4.0;\n\t\tfloat indexFactor = (rawConcent - minValue)/(maxValue - minValue);\n\t\tindexFactor = indexFactor - floor(indexFactor); \n\t\t//result = mix(colorDown, colorTop, indexFactor);\n\t\tresult = mix(colorTop, colorDown, indexFactor);\n\t\t//return vec3(1.0, 1.0, 0.0);\n\t}\n\telse\n\t{\n\t\treturn vec3(1.0, 0.0, 1.0);\n\t}\n\n\treturn result;\n}\n\nvoid main()\n{\n\tvec4 colorUp = texture2D(texUp, vTexCoord);\n\tvec4 colorDown = texture2D(texDown, vTexCoord);\n\n\t// now, calculate realConcent_up & realConcent_down.***\n\tfloat realConcent_up = colorUp.r * (uDustConcentMinMax_up[1] - uDustConcentMinMax_up[0]) + uDustConcentMinMax_up[0];\n\tfloat realConcent_down = colorDown.r * (uDustConcentMinMax_down[1] - uDustConcentMinMax_down[0]) + uDustConcentMinMax_down[0];\n\tfloat realConcent = mix(realConcent_down, realConcent_up, uZFactor);\n\tfloat concentMin = mix(uDustConcentMinMax_down[0], uDustConcentMinMax_up[0], uZFactor);\n\tfloat concentMax = mix(uDustConcentMinMax_down[1], uDustConcentMinMax_up[1], uZFactor);\n\tvec4 textureColor = mix(colorDown, colorUp, uZFactor);\n\t//vec4 textureColor = texture2D(texDown, vTexCoord);\n\n\tvec4 finalColor = vColor;\n\tfloat alpha = textureColor.a;\n\tfloat concent = textureColor.g;\n\tvec3 rainbowCol = getRainbowColor_byHeight(concent);\n\n\t// BBC & YeonHwa color system.********************************************************************************\n\t// BBC & YeonHwa color system.********************************************************************************\n\t//float realConcent = concent * (uDustConcentMinMax_down[1] - uDustConcentMinMax_down[0]) + uDustConcentMinMax_down[0];\n\tfloat indexMin = calculateIndex(concentMin);\n\tfloat indexMax = calculateIndex(concentMax);\n\tfloat index = calculateIndex(realConcent);\n\n\tfloat scaledIndex = (index - indexMin)/(indexMax - indexMin);\n\tscaledIndex *= 500.0;\n\t//vec3 colorAux = getBBCAndYeonHwa_colorCoded(scaledIndex);\n\tvec3 colorAux = getBBCAndYeonHwa_colorCoded_tight(realConcent);\n\t//-------------------------------------------------------------------------------------------------------------\n\t//-------------------------------------------------------------------------------------------------------------\n\n\t//finalColor = vec4(rainbowCol, alpha);\n\t\n\tif(concent < 0.00001)\n\t{\n\t\tfinalColor = vec4(colorAux, 0.0);\n\t}\n\telse{\n\t\tfinalColor = vec4(colorAux, 0.7);\n\t}\n\t\n\n\n\tgl_FragData[0] = finalColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\tgl_FragData[1] = packDepth(vDepth);\n\t\t\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = finalColor; \n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",dustTextureModeVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform float uDustConcentration;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float vDepth;\n\nuniform float uFCoef_logDepth;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying vec2 vTexCoord;\n\nvoid main()\n{\n\tvec4 rotatedPos;\n\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor = oneColor4;\n\t}\n\telse\n\t\tvColor = color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tvDepth = -(modelViewMatrixRelToEye * pos).z/far; // original.***\n\tvTexCoord = texCoord;\n/*\n\tif(bUseFixPointSize)\n\t{\n\t\tgl_PointSize = fixPointSize;\n\t}\n\telse{\n\t\tfloat z_b = gl_Position.z/gl_Position.w;\n\t\tfloat z_n = 2.0 * z_b - 1.0;\n\t\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\t\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t\tif(gl_PointSize > maxPointSize)\n\t\t\tgl_PointSize = maxPointSize;\n\t\tif(gl_PointSize < 2.0)\n\t\t\tgl_PointSize = 2.0;\n\t}\n\t*/\n\t/*\n\tfloat minPointSize = 2.0;\n\tfloat maxPointSize = 60.0;\n\tfloat pendentPointSize = 2000.0 * uDustConcentration;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t//if(gl_PointSize > maxPointSize)\n\t//\tgl_PointSize = maxPointSize;\n\t//if(gl_PointSize < 2.0)\n\t//\tgl_PointSize = 2.0;\n\n\t//vDustConcentRel = uDustConcentration/uDustConcentMinMax[1];\n\t//glPointSize = gl_PointSize;\n\t*/\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}",ElectroMagnetismSurfaceFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D texture_0; \nuniform sampler2D texture_1;\n\nuniform bool textureFlipYAxis;\n\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \n//uniform float screenWidth;    \n//uniform float screenHeight;     \nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform float externalAlpha; // used by effects.\nuniform bool bUseLogarithmicDepth;\n\nuniform int uFrustumIdx;\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nuniform float uInterpolationFactor;\nuniform float uMinMaxValue[2];\n\n// Legend colors.***\nuniform vec4 uLegendColors[16];\nuniform float uLegendValues[16];\n\n// base color.***\nuniform vec4 uBaseColor4;\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \n\nvarying float vDepth;\nvarying float vSoundValue;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec4 packDepth( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n\treturn enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depthAux = dot(rgba_depth, bit_shift);\n    return depthAux;\n}  \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\n/*\n// unpack depth used for shadow on screen.***\nfloat unpackDepth_A(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n*/\n\nfloat UnpackDepth32( in vec4 pack )\n{\n\tfloat depth = dot( pack, vec4(1.0, 0.00390625, 0.000015258789, 0.000000059605) );\n    return depth * 1.000000059605;// 1.000000059605 = (16777216.0) / (16777216.0 - 1.0);\n}             \n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n\n\nvec4 getRainbowColor_byHeight(in float height, in float minHeight_rainbow, in float maxHeight_rainbow, bool hotToCold)\n{\n    \n    float gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\n    float value = gray * 4.0;\n    value = gray;\n    float h = floor(value);\n    float f = fract(value);\n\n    vec4 resultColor = vec4(0.0, 0.0, 0.0, gray);\n\n    if(hotToCold)\n    {\n        // HOT to COLD.***\n        resultColor.rgb = vec3(1.0, 0.0, 0.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix red & yellow.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(red, yellow, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix yellow & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, green, f);\n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & cyan.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(green, cyan, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix cyan & blue.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, blue, f);\n        }\n    }\n    else\n    {\n        // COLD to HOT.***\n        resultColor.rgb = vec3(0.0, 0.0, 1.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix blue & cyan.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(blue, cyan, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix cyan & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, green, f);  \n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & yellow.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(green, yellow, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix yellow & red.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, red, f);\n        }\n    }\n\n    return resultColor;\n}\n\n\nvoid main()\n{\n\t//bool testBool = false;\n\t//float occlusion = 1.0; // ambient occlusion.***\n\t//vec3 normal2 = vNormal;\t\n\t//float scalarProd = 1.0;\n\t\n\t//vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t//float linearDepth = getDepth(screenPos);   \n\t//vec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t//occlusion = 1.0;\n\tvec4 textureColor;\n\tvec4 textureColor_0;\n\tvec4 textureColor_1;\n\n    if(colorType == 2)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor_0 = texture2D(texture_0, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\ttextureColor_1 = texture2D(texture_1, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor_0 = texture2D(texture_0, vec2(vTexCoord.s, vTexCoord.t));\n\t\t\ttextureColor_1 = texture2D(texture_1, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\n\t\ttextureColor = mix(textureColor_0, textureColor_1, uInterpolationFactor);\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = vColor4;\n    }\n\telse if(colorType == 3)\n\t{\n\t\tbool hotToCold = false;\n\t\tfloat height = vSoundValue;\n\n        textureColor = getRainbowColor_byHeight(height, uMinMaxValue[0], uMinMaxValue[1], hotToCold);\n\n\t\ttextureColor = vec4(textureColor.a, textureColor.a, textureColor.a, textureColor.a);\n    }\n\telse if(colorType == 4)\n\t{\n\t\tfloat height = vSoundValue;\n\t\tfloat q = (height - uMinMaxValue[0]) / (uMinMaxValue[1] - uMinMaxValue[0]);\n\n\t\ttextureColor = vec4(q,q*0.25,q*0.5,q);\n    }\n\telse if(colorType == 5)\n\t{\n\t\t// use an external legend.***\n\t\t//vec4 colorAux = vec4(0.3, 0.3, 0.3, 0.4);\n        vec4 colorAux = uBaseColor4;\n\n\t\t// find legendIdx.***\n\t\tfor(int i=0; i<15; i++)\n\t\t{\n\t\t\tif(vSoundValue > uLegendValues[i] && vSoundValue <= uLegendValues[i + 1])\n\t\t\t{\n\t\t\t\tcolorAux = uLegendColors[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n        if(colorAux.a == 0.0)\n        {\n            discard;\n        }\n\n\t\ttextureColor = colorAux;\n    }\n\t\n    vec4 finalColor;\n\tfinalColor = textureColor;\n\n\tvec4 albedo4 = finalColor;\n\n\t\n    gl_FragData[0] = finalColor; \n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t{\n\t\t// save depth, normal, albedo.\n\t\tfloat depthAux = vDepth;\n\t\tgl_FragData[1] = packDepth(depthAux); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\t}\n\t#endif\n\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}',ElectroMagnetismSurfaceVS:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\tattribute float value;\n\t\n\tuniform mat4 buildingRotMatrix; \n\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying vec3 vertexPosLC;\n\tvarying vec4 vColor4; // color from attributes\n\tvarying vec3 vLightDir; \n\tvarying vec3 vNormalWC; \n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\tvarying float vDepth;\n\tvarying float vSoundValue;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(buildingRotMatrix);\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\t\n\t\t\n\t\tuAmbientColor = vec3(1.0);\n\t\tvNormalWC = rotatedNormal;\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\t\tvLightDir = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tfloat directionalLightWeighting = 1.0;\n\n\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting; // original.***\n\t\t\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\tvertexPos = orthoPos.xyz;\n\t\tvDepth = -orthoPos.z/far;\n\n\t\tvSoundValue = value;\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\n\t\tgl_PointSize = 5.0;\n\t}",GBufferFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;  \nuniform vec4 oneColor4;\n\n//uniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\n\nuniform mat4 modelViewMatrixRelToEye;\n\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes; // old. deprecated.***\nuniform int clippingType; // 0= no clipping. 1= clipping by planes. 2= clipping by localCoord polyline. 3= clip by heights, 4= clip by (2, 3)\nuniform int clippingPlanesCount;\nuniform vec3 clippingBoxSplittedPos[2]; // Box position. posHIGH.xyz & posLOW.xyz.***\nuniform vec3 clippingBoxPlanesPosLC[6]; // planes local position (relative to box).***\nuniform vec3 clippingBoxPlanesNorLC[6]; // planes local normals (relative to box).***\nuniform mat4 clippingBoxRotMatrix;\nuniform vec4 clippingPlanes[6]; // old.\nuniform vec2 clippingPolygon2dPoints[64];\nuniform int clippingConvexPolygon2dPointsIndices[64];\nuniform vec4 limitationInfringedColor4;\nuniform vec2 limitationHeights;\n\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \n\nvarying vec3 vertexPos; // this is the orthoPos.***\nvarying vec3 vertexPosLC;\n\n\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float depth;\n\n\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}            \n\n\nfloat clipVertexByPlane(in vec3 planePos, in vec3 planeNor, in vec3 point)\n{\n\tfloat coef_d = -planeNor.x * planePos.x - planeNor.y * planePos.y - planeNor.z * planePos.z;\n\tfloat dist = planeNor.x * point.x + planeNor.y * point.y + planeNor.z * point.z + coef_d;\n\treturn dist;\n\t//if(dist < 0.0)\n\t//return true;\n\t//else return false;\n}\n\nvec2 getDirection2d(in vec2 startPoint, in vec2 endPoint)\n{\n\t//vec2 vector = endPoint - startPoint;\n\t//float length = length( vector);\n\t//vec2 dir = vec2(vector.x/length, vector.y/length);\n\tvec2 dir = normalize(endPoint - startPoint);\n\treturn dir;\n}\n\nbool intersectionLineToLine(in vec2 line_1_pos, in vec2 line_1_dir,in vec2 line_2_pos, in vec2 line_2_dir, out vec2 intersectionPoint2d)\n{\n\tbool bIntersection = false;\n\n\tfloat zero = 10E-8;\n\tfloat intersectX;\n\tfloat intersectY;\n\n\t// check if 2 lines are parallel.***\n\tfloat dotProd = abs(dot(line_1_dir, line_2_dir));\n\tif(abs(dotProd-1.0) < zero)\n\treturn false;\n\n\tif (abs(line_1_dir.x) < zero)\n\t{\n\t\t// this is a vertical line.\n\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\n\t\tintersectX = line_1_pos.x;\n\t\tintersectY = slope * line_1_pos.x + b;\n\t\tbIntersection = true;\n\t}\n\telse if (abs(line_1_dir.y) < zero)\n\t{\n\t\t// this is a horizontal line.\n\t\t// must check if the "line" is vertical.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (line_1_pos.y - b)/slope;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\t\n\t}\n\telse \n\t{\n\t\t// this is oblique.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = intersectX * mySlope + myB;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\t\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (myB - b)/ (slope - mySlope);\n\t\t\tintersectY = slope * intersectX + b;\n\t\t\tbIntersection = true;\n\t\t}\n\t}\n\n\tintersectionPoint2d.x = intersectX;\n\tintersectionPoint2d.y = intersectY;\n\n\treturn bIntersection;\n}\n\nvec2 getProjectedPoint2dToLine(in vec2 line_point, in vec2 line_dir, in vec2 point)\n{\n\tbool intersection = false;\n\n\t// create a perpendicular left line.***\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\tvec2 lineLeft_point = vec2(point.x, point.y);\n\tvec2 projectedPoint = vec2(0);\n\tintersection = intersectionLineToLine(line_point, line_dir, lineLeft_point, lineLeft_dir, projectedPoint);\n\n\treturn projectedPoint;\n}\n\nint getRelativePositionOfPointToLine(in vec2 line_pos, in vec2 line_dir, vec2 point)\n{\n\t// 0 = coincident. 1= left side. 2= right side.***\n\tint relPos = -1;\n\n\tvec2 projectedPoint = getProjectedPoint2dToLine(line_pos, line_dir, point );\n\tfloat dist = length(point - projectedPoint);\n\n\tif(dist < 1E-8)\n\t{\n\t\trelPos = 0; // the point is coincident to line.***\n\t\treturn relPos;\n\t}\n\n\tvec2 myVector = normalize(point - projectedPoint);\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\n\tfloat dotProd = dot(lineLeft_dir, myVector);\n\n\tif(dotProd > 0.0)\n\t{\n\t\trelPos = 1; // is in left side of the line.***\n\t}\n\telse\n\t{\n\t\trelPos = 2; // is in right side of the line.***\n\t}\n\n\treturn relPos;\n}\n\nbool isPointInsideLimitationConvexPolygon(in vec2 point2d)\n{\n\tbool isInside = true;\n\n\t// Check polygons.***\n\tint startIdx = -1;\n\tint endIdx = -1;\n\tfor(int i=0; i<32; i++)\n\t{\n\t\tstartIdx = clippingConvexPolygon2dPointsIndices[2*i];  // 0\n\t\tendIdx = clippingConvexPolygon2dPointsIndices[2*i+1];\t // 3\n\n\t\tif(startIdx < 0 || endIdx < 0)\n\t\tbreak;\n\n\t\tisInside  = true;\n\t\t\n\t\tisInside = true;\n\t\tvec2 pointStart = clippingPolygon2dPoints[0];\n\t\tfor(int j=0; j<32; j++)\n\t\t{\n\t\t\tif(j > endIdx)\n\t\t\tbreak;\n\n\t\t\tif(j == startIdx)\n\t\t\t\tpointStart = clippingPolygon2dPoints[j];\n\n\t\t\tif(j >= startIdx && j<endIdx)\n\t\t\t{\n\t\t\t\tvec2 point0;\n\t\t\t\tvec2 point1;\n\t\t\t\t\n\t\t\t\tif(j == endIdx)\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = pointStart;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = clippingPolygon2dPoints[j+1];\n\t\t\t\t}\n\n\t\t\t\t// create the line of the segment.***\n\t\t\t\tvec2 dir = getDirection2d(point0, point1);\n\n\t\t\t\t// now, check the relative position of the point with the edge line.***\n\t\t\t\tint relPos = getRelativePositionOfPointToLine(point0, dir, point2d);\n\t\t\t\tif(relPos == 2)\n\t\t\t\t{\n\t\t\t\t\t// the point is in the right side of the edge line, so is out of the polygon.***\n\t\t\t\t\tisInside = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\tif(isInside)\n\t\treturn true;\n\n\t}\n\n\treturn isInside;\n}\n\n\nvoid main()\n{\n\tif(clippingType == 2)\n\t{\n\t\t// clip by limitationPolygon.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 3)\n\t{\n\t\t// check limitation heights.***\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 4)\n\t{\n\t\t// clip by limitationPolygon & heights.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Check if clipping.********************************************\n\tbool discardFrag = false;\n\tif(bApplyClippingPlanes)\n\t{\n\t\t// check gl_FrontFacing. todo.\n\t\tdiscardFrag = true;\n\n\t\tvec3 boxPosHIGH = clippingBoxSplittedPos[0];\n\t\tvec3 boxPosLOW = clippingBoxSplittedPos[1];\n\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\n\t\t\t//vec4 plane = clippingPlanes[i]; // old. delete this.\n\t\t\tvec3 planePosLC = clippingBoxPlanesPosLC[i];\n\t\t\tvec3 planeNorLC = clippingBoxPlanesNorLC[i];\n\n\t\t\t// 1rst, rotate the posLC.***\n\t\t\tvec3 rotatedPos = (clippingBoxRotMatrix * vec4(planePosLC, 1.0)).xyz;\n\t\t\tvec3 planePosHIGH = boxPosHIGH;\n\t\t\tvec3 planePosLOW = boxPosLOW + rotatedPos;\n\t\t\tvec3 highDifference = planePosHIGH.xyz - encodedCameraPositionMCHigh.xyz;\n\t\t\tvec3 lowDifference = planePosLOW.xyz - encodedCameraPositionMCLow.xyz;\n\n\t\t\tvec3 planePosWC = highDifference.xyz + lowDifference.xyz;\n\t\t\tvec4 planePosCC = modelViewMatrixRelToEye * vec4(planePosWC, 1.0);\n\n\t\t\tmat3 rotMat = mat3(clippingBoxRotMatrix);\n\t\t\tvec3 planeNorWC = rotMat * planeNorLC;\n\t\t\tvec4 planeNorCC = modelViewMatrixRelToEye * vec4(planeNorWC, 1.0);\n\n\t\t\t// now check if vertexPos is in front of plane or rear of the plane.\n\t\t\tfloat dist = clipVertexByPlane(planePosCC.xyz, planeNorCC.xyz, vertexPos);\n\t\t\tif(dist > 0.0)\n\t\t\t{\n\t\t\t\tdiscardFrag = false; \n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t}\n\n\t\tif(discardFrag)\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t}\n\t\n\t//----------------------------------------------------------------\n\n\tvec4 textureColor;\n    if(colorType == 2)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\t \n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        //if(textureColor.w == 0.0)\n\t\tif(textureColor.w < 0.01)\n        {\n            discard;\n        }\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = vColor4;\n    }\n\t\n\tfloat depthAux = depth;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tdepthAux = gl_FragDepthEXT; \n\t}\n\t#endif\n\n\tvec4 albedo4 = vec4(textureColor.xyz, 1.0);\n\tgl_FragData[0] = albedo4; // anything.\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\t// save depth, normal, albedo.\n\t\tgl_FragData[1] = packDepth(depthAux); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\n\t\t// debugTex.***\n\t\t//gl_FragData[5] = vec4(0.0, 0.0, depthDebug.z, 1.0); \n\t}\n\t#endif\n\n\n\t\n}',GBufferORTFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;  \nuniform vec4 oneColor4;\n\n//uniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\nuniform int u_outputTarget; // 0 = depth, 1= normal, 2= albedo, 3= selColor.***\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes; // old. deprecated.***\nuniform int clippingType; // 0= no clipping. 1= clipping by planes. 2= clipping by localCoord polyline. 3= clip by heights, 4= clip by (2, 3)\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform vec2 clippingPolygon2dPoints[64];\nuniform int clippingConvexPolygon2dPointsIndices[64];\nuniform vec4 limitationInfringedColor4;\nuniform vec2 limitationHeights;\n\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \n\nvarying vec3 vertexPos; // this is the orthoPos.***\nvarying vec3 vertexPosLC;\n\n\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float depth;\n\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}            \n\n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvec2 getDirection2d(in vec2 startPoint, in vec2 endPoint)\n{\n\t//vec2 vector = endPoint - startPoint;\n\t//float length = length( vector);\n\t//vec2 dir = vec2(vector.x/length, vector.y/length);\n\tvec2 dir = normalize(endPoint - startPoint);\n\treturn dir;\n}\n\nbool intersectionLineToLine(in vec2 line_1_pos, in vec2 line_1_dir,in vec2 line_2_pos, in vec2 line_2_dir, out vec2 intersectionPoint2d)\n{\n\tbool bIntersection = false;\n\n\tfloat zero = 10E-8;\n\tfloat intersectX;\n\tfloat intersectY;\n\n\t// check if 2 lines are parallel.***\n\tfloat dotProd = abs(dot(line_1_dir, line_2_dir));\n\tif(abs(dotProd-1.0) < zero)\n\treturn false;\n\n\tif (abs(line_1_dir.x) < zero)\n\t{\n\t\t// this is a vertical line.\n\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\n\t\tintersectX = line_1_pos.x;\n\t\tintersectY = slope * line_1_pos.x + b;\n\t\tbIntersection = true;\n\t}\n\telse if (abs(line_1_dir.y) < zero)\n\t{\n\t\t// this is a horizontal line.\n\t\t// must check if the "line" is vertical.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (line_1_pos.y - b)/slope;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\t\n\t}\n\telse \n\t{\n\t\t// this is oblique.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = intersectX * mySlope + myB;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\t\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (myB - b)/ (slope - mySlope);\n\t\t\tintersectY = slope * intersectX + b;\n\t\t\tbIntersection = true;\n\t\t}\n\t}\n\n\tintersectionPoint2d.x = intersectX;\n\tintersectionPoint2d.y = intersectY;\n\n\treturn bIntersection;\n}\n\nvec2 getProjectedPoint2dToLine(in vec2 line_point, in vec2 line_dir, in vec2 point)\n{\n\tbool intersection = false;\n\n\t// create a perpendicular left line.***\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\tvec2 lineLeft_point = vec2(point.x, point.y);\n\tvec2 projectedPoint = vec2(0);\n\tintersection = intersectionLineToLine(line_point, line_dir, lineLeft_point, lineLeft_dir, projectedPoint);\n\n\treturn projectedPoint;\n}\n\nint getRelativePositionOfPointToLine(in vec2 line_pos, in vec2 line_dir, vec2 point)\n{\n\t// 0 = coincident. 1= left side. 2= right side.***\n\tint relPos = -1;\n\n\tvec2 projectedPoint = getProjectedPoint2dToLine(line_pos, line_dir, point );\n\tfloat dist = length(point - projectedPoint);\n\n\tif(dist < 1E-8)\n\t{\n\t\trelPos = 0; // the point is coincident to line.***\n\t\treturn relPos;\n\t}\n\n\tvec2 myVector = normalize(point - projectedPoint);\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\n\tfloat dotProd = dot(lineLeft_dir, myVector);\n\n\tif(dotProd > 0.0)\n\t{\n\t\trelPos = 1; // is in left side of the line.***\n\t}\n\telse\n\t{\n\t\trelPos = 2; // is in right side of the line.***\n\t}\n\n\treturn relPos;\n}\n\nbool isPointInsideLimitationConvexPolygon(in vec2 point2d)\n{\n\tbool isInside = true;\n\n\t// Check polygons.***\n\tint startIdx = -1;\n\tint endIdx = -1;\n\tfor(int i=0; i<32; i++)\n\t{\n\t\tstartIdx = clippingConvexPolygon2dPointsIndices[2*i];  // 0\n\t\tendIdx = clippingConvexPolygon2dPointsIndices[2*i+1];\t // 3\n\n\t\tif(startIdx < 0 || endIdx < 0)\n\t\tbreak;\n\n\t\tisInside  = true;\n\t\t\n\t\tisInside = true;\n\t\tvec2 pointStart = clippingPolygon2dPoints[0];\n\t\tfor(int j=0; j<32; j++)\n\t\t{\n\t\t\tif(j > endIdx)\n\t\t\tbreak;\n\n\t\t\tif(j == startIdx)\n\t\t\t\tpointStart = clippingPolygon2dPoints[j];\n\n\t\t\tif(j >= startIdx && j<endIdx)\n\t\t\t{\n\t\t\t\tvec2 point0;\n\t\t\t\tvec2 point1;\n\t\t\t\t\n\t\t\t\tif(j == endIdx)\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = pointStart;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = clippingPolygon2dPoints[j+1];\n\t\t\t\t}\n\n\t\t\t\t// create the line of the segment.***\n\t\t\t\tvec2 dir = getDirection2d(point0, point1);\n\n\t\t\t\t// now, check the relative position of the point with the edge line.***\n\t\t\t\tint relPos = getRelativePositionOfPointToLine(point0, dir, point2d);\n\t\t\t\tif(relPos == 2)\n\t\t\t\t{\n\t\t\t\t\t// the point is in the right side of the edge line, so is out of the polygon.***\n\t\t\t\t\tisInside = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\tif(isInside)\n\t\treturn true;\n\n\t}\n\n\treturn isInside;\n}\n\n\nvoid main()\n{\n\tif(clippingType == 2)\n\t{\n\t\t// clip by limitationPolygon.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 3)\n\t{\n\t\t// check limitation heights.***\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 4)\n\t{\n\t\t// clip by limitationPolygon & heights.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Check if clipping.********************************************\n\t\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = false;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\t\n\t\t\t// calculate any point of the plane.\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false; // false.\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t}\n\t\n\t//----------------------------------------------------------------\n\t\n\tfloat depthAux = depth;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tdepthAux = gl_FragDepthEXT; \n\t}\n\t#endif\n\n\t//u_outputTarget; // 0 = depth, 1= normal, 2= albedo, 3= selColor.***\n\tif(u_outputTarget == 0)\n\t{\n\t\tgl_FragData[0] = packDepth(depthAux); \n\t}\n\telse if(u_outputTarget == 1)\n\t{\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[0] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t}\n\telse if(u_outputTarget == 2)\n\t{\n\t\tvec4 textureColor;\n\t\tif(colorType == 2)\n\t\t{\n\t\t\tif(textureFlipYAxis)\n\t\t\t{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\t\t\n\t\t\t}\n\t\t\telse{\n\t\t\t\ttextureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\t\t\t}\n\t\t\t\n\t\t\tif(textureColor.w == 0.0)\n\t\t\t{\n\t\t\t\tdiscard;\n\t\t\t}\n\t\t}\n\t\telse if(colorType == 0)\n\t\t{\n\t\t\ttextureColor = oneColor4;\n\t\t}\n\t\telse if(colorType == 1)\n\t\t{\n\t\t\ttextureColor = vColor4;\n\t\t}\n\n\t\tvec4 albedo4 = vec4(textureColor.xyz, 1.0);\n\t\tgl_FragData[0] = albedo4; // anything.\n\t}\n\telse if(u_outputTarget == 3)\n\t{\n\t\tgl_FragData[0] = uSelColor4; \n\t}\n\t\n}',GBufferVS:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 vertexPos;\n\tvarying vec3 vertexPosLC;\n\tvarying vec4 vColor4; // color from attributes \n\tvarying float discardFrag;\n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\tvarying float depth;\n\t//varying vec3 depthDebug;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0) // 0= identity, 1= translate, 2= transform\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\t\n\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\tvertexPos = orthoPos.xyz;\n\t\tdepth = (-orthoPos.z)/(far); // the correct value.\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\t//flogz = 1.0 + gl_Position.w;\n\t\t\tflogz = 1.0 - orthoPos.z;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\n\t\t//if(orthoPos.z < 0.0)\n\t\t//aColor4 = vec4(1.0, 0.0, 0.0, 1.0);\n\t\t//else\n\t\t//aColor4 = vec4(0.0, 1.0, 0.0, 1.0);\n\t\tgl_PointSize = 5.0;\n\t}",GroundStencilPrimitivesFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform vec4 oneColor4;\n\nuniform float near;\nuniform float far;\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes;\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform bool bUseLogarithmicDepth;\n\nvarying float depth;  \nvarying vec3 vertexPos;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0); // original.***\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625);  // original.*** \n\t\n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\n\n//vec4 PackDepth32( in float depth )\n//{\n//    depth *= (16777216.0 - 1.0) / (16777216.0);\n//    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n//    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n//}\n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvoid main()\n{     \n\t// 1rst, check if there are clipping planes.\n    /*\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = true;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t\tif(discardFrag)\n\t\tdiscard;\n\t}\n    */\n\t//if(!bUseLogarithmicDepth)\n    //\tgl_FragData[0] = packDepth(-depth);\n\ngl_FragColor = oneColor4; \n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\t//gl_FragData[0] = packDepth(gl_FragDepthEXT);\n\t}\n\t#endif\n\n    \n}",GroundStencilPrimitivesVS:'attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 scaleLC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying float depth;\nvarying vec3 vertexPos;\n  \nvoid main()\n{\t\n\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n    depth = orthoPos.z/far; // original.***\n\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//-----------------------------------------------------------------------------------\n\t\t//float C = 0.0001;\n\t\tflogz = 1.0 + gl_Position.w; // use "z" instead "w" for fast decoding.***\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n\n\tvertexPos = orthoPos.xyz;\n}',ImageViewerRectangleShaderFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nvarying vec4 aColor4; // color from attributes\nuniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nvarying float applySpecLighting;\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}  \n\nfloat UnpackDepth32( in vec4 pack )\n{\n    float depth = dot( pack, 1.0 / vec4(1.0, 256.0, 256.0*256.0, 16777216.0) ); // 256.0*256.0*256.0 = 16777216.0\n    return depth * (16777216.0) / (16777216.0 - 1.0);\n}              \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return UnpackDepth32(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{\n\tvec4 textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n\tfloat alfa = externalAlpha;\n\tfloat depth = UnpackDepth32(textureColor);\n\t\n    vec4 finalColor;\n\tfinalColor = vec4(depth, depth, depth, alfa);\n\n\t//finalColor = vec4(vNormal, 1.0); // test to render normal color coded.***\n    gl_FragColor = finalColor; \n}",ImageViewerRectangleShaderVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying float applySpecLighting;\n\tvarying vec4 aColor4; // color from attributes\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\t//vertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\t\n\t\tif(colorType == 1)\n\t\t\taColor4 = color4;\n\t}",InvertedBoxFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D diffuseTex;\nuniform bool hasTexture;\nuniform bool textureFlipYAxis;\nvarying vec3 vNormal;\nuniform mat4 projectionMatrix;\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 vColor4Aux;\n\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying vec3 vertexPos;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}    \n\nvoid main()\n{          \n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\t\t                 \n    float linearDepth = getDepth(screenPos);          \n    vec3 origin = getViewRay(screenPos) * linearDepth;   \n\n    vec3 normal2 = vNormal;\n            \n    vec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n    vec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n    vec3 bitangent = cross(normal2, tangent);\n    mat3 tbn = mat3(tangent, bitangent, normal2);        \n    \n    float occlusion = 0.0;\n    for(int i = 0; i < kernelSize; ++i)\n    {    \t \n        vec3 sample = origin + (tbn * kernel[i]) * radius;\n        vec4 offset = projectionMatrix * vec4(sample, 1.0);\t\t\n        offset.xy /= offset.w;\n        offset.xy = offset.xy * 0.5 + 0.5;        \n        float sampleDepth = -sample.z/far;\n\t\tif(sampleDepth > 0.49)\n\t\t\tcontinue;\n        float depthBufferValue = getDepth(offset.xy);\t\t\t\t              \n        float range_check = abs(linearDepth - depthBufferValue)+radius*0.998;\n        if (range_check < radius*1.001 && depthBufferValue <= sampleDepth)\n        {\n            occlusion +=  1.0;\n        }\n    }   \n        \n    occlusion = 1.0 - occlusion / float(kernelSize);\n\n    vec3 lightPos = vec3(20.0, 60.0, 20.0);\n    vec3 L = normalize(lightPos - vertexPos);\n    float lambertian = max(dot(normal2, L), 0.0);\n    float specular = 0.0;\n    if(lambertian > 0.0)\n    {\n        vec3 R = reflect(-L, normal2);      // Reflected light vector\n        vec3 V = normalize(-vertexPos); // Vector to viewer\n        \n        // Compute the specular term\n        float specAngle = max(dot(R, V), 0.0);\n        specular = pow(specAngle, shininessValue);\n    }\n\t\n\tif(lambertian < 0.5)\n    {\n\t\tlambertian = 0.5;\n\t}\n\n    vec4 textureColor;\n    if(hasTexture)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else{\n        textureColor = vColor4Aux;\n    }\n\t\n\tvec3 ambientColor = vec3(textureColor.x, textureColor.y, textureColor.z);\n\n    gl_FragColor = vec4((ambientReflectionCoef * ambientColor + diffuseReflectionCoef * lambertian * textureColor.xyz + specularReflectionCoef * specular * specularColor)*vLightWeighting * occlusion, 1.0); \n}\n",InvertedBoxVS:"\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\t\n\tvoid main()\n    {\t\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n\t\tvertexPos = vec3(modelViewMatrixRelToEye * pos4);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\tvLightWeighting = vec3(1.0, 1.0, 1.0);\n\t\tuAmbientColor = vec3(0.8);\n\t\tvec3 uLightingDirection = vec3(0.6, 0.6, 0.6);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tvNormal = (normalMatrix4 * vec4(rotatedNormal.x, rotatedNormal.y, rotatedNormal.z, 1.0)).xyz;\n\t\tvTexCoord = texCoord;\n\t\tfloat directionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t}\n",LBufferFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D depthTex;\nuniform sampler2D normalTex;\nuniform samplerCube light_depthCubeMap;\n\nuniform mat4 projectionMatrixInv;\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform mat4 buildingRotMatrixInv;\n\n// Light parameters.\nuniform float uLightParameters[4]; // 0= lightDist, 1= lightFalloffDist, 2= maxSpotDot, 3= falloffSpotDot.\n\nuniform float near;\nuniform float far;            \nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;     \n\nuniform vec3 uLightColorAndBrightness;\nuniform float uLightIntensity;\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform bool bApplyShadows;\nuniform vec2 uNearFarArray[4];\nuniform int u_processType; // 1= light pass. 2= lightFog pass.\n\nvarying vec3 vNormal;\nvarying vec3 vLightDirCC;\nvarying vec3 vLightPosCC; \nvarying vec3 vertexPosLC;\nvarying vec4 vertexPosCC;\nvarying float vDotProdLight;\nvarying vec3 vCrossProdLight;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}  \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(normalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}                   \n        \nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t\t/*\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z*0.0001;\n        float Fcoef_half = uFCoef_logDepth/2.0;\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = (flogzAux - 1.0);\n\t\tlinearDepth = z/(far);\n\t\t*/\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n} \n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 getPosCC(in vec2 screenPosition, inout int dataType, inout vec4 normal4)\n{\n\tnormal4 = getNormal(screenPosition);\n\tint estimatedFrustumIdx = int(floor(100.0*normal4.w));\n\tdataType = 0; // 0= general geometry. 1= tinTerrain. 2= PointsCloud.\n\n\t// Check the type of the data.******************\n\t// dataType = 0 -> general geometry data.\n\t// dataType = 1 -> tinTerrain data.\n\t// dataType = 2 -> points cloud data.\n\t//----------------------------------------------\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\n\tvec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear = nearFar.x;\n\tfloat currFar = nearFar.y;\n\tfloat linearDepth = getDepth(screenPosition);\n\n\t// calculate the real pos of origin.\n\tfloat origin_zDist = linearDepth * currFar; // original.\n\tvec3 origin_real = getViewRay(screenPosition, origin_zDist);\n\n\treturn origin_real;\n}\n\nint getFaceIdx(in vec3 normalRelToLight, inout vec2 faceTexCoord, inout vec3 faceDir)\n{\n\tint faceIdx = -1;\n\n\t// Note: the "faceTexCoord" is 1- to 1 range.\n\n\tfloat x = normalRelToLight.x;\n\tfloat y = normalRelToLight.y;\n\tfloat z = normalRelToLight.z;\n\n\tfloat absX = abs(x);\n\tfloat absY = abs(y);\n\tfloat absZ = abs(normalRelToLight.z);\n\n\tbool isXPositive = true;\n\tbool isYPositive = true;\n\tbool isZPositive = true;\n\n\tif(x < 0.0)\n\tisXPositive = false;\n\n\tif(y < 0.0)\n\tisYPositive = false;\n\n\tif(z < 0.0)\n\tisZPositive = false;\n\n\t// xPositive.\n\tif(isXPositive && absX >= absY && absX >= absZ)\n\t{\n\t\tfaceIdx = 0;\n\t\tfaceTexCoord = vec2(y, z);\n\t\tfaceDir = vec3(1.0, 0.0, 0.0);\n\t}\n\n\t// xNegative.\n\telse if(!isXPositive && absX >= absY && absX >= absZ)\n\t{\n\t\tfaceIdx = 1;\n\t\tfaceTexCoord = vec2(y, z);\n\t\tfaceDir = vec3(-1.0, 0.0, 0.0);\n\t}\n\n\t// yPositive.\n\telse if(isYPositive && absY >= absX && absY >= absZ)\n\t{\n\t\tfaceIdx = 2;\n\t\tfaceTexCoord = vec2(x, z);\n\t\tfaceDir = vec3(0.0, 1.0, 0.0);\n\t}\n\n\t// yNegative.\n\telse if(!isYPositive && absY >= absX && absY >= absZ)\n\t{\n\t\tfaceIdx = 3;\n\t\tfaceTexCoord = vec2(x, z);\n\t\tfaceDir = vec3(0.0, -1.0, 0.0);\n\t}\n\n\t// zPositive.\n\telse if(isZPositive && absZ >= absX && absZ >= absY)\n\t{\n\t\tfaceIdx = 4;\n\t\tfaceTexCoord = vec2(x, y);\n\t\tfaceDir = vec3(0.0, 0.0, 1.0);\n\t}\n\n\t// zNegative.\n\telse if(!isZPositive && absZ >= absX && absZ >= absY)\n\t{\n\t\tfaceIdx = 5;\n\t\tfaceTexCoord = vec2(x, y);\n\t\tfaceDir = vec3(0.0, 0.0, -1.0);\n\t}\n\n\treturn faceIdx;\n}\n\nfloat getDepthFromLight(in vec3 lightDirCC, inout float spotDotAux)\n{\n\t// Note : input must be a direction in cameraCoords.\n\t// 1rst, transform "lightDirToPointCC" to "lightDirToPointWC".\n\t// 2nd, transform "lightDirToPointWC" to "lightDirToPointLC" ( lightCoord );\n\tvec4 lightDirToPointWC = modelViewMatrixRelToEyeInv * vec4(lightDirCC, 1.0);\n\tvec3 lightDirToPointWCNormalized = normalize(lightDirToPointWC.xyz);\n\tvec4 lightDirToPointLC = buildingRotMatrixInv * vec4(lightDirToPointWCNormalized, 1.0);\n\tvec3 lightDirToPointLC_norm = normalize(lightDirToPointLC.xyz);\n\tvec4 depthCube = textureCube(light_depthCubeMap, lightDirToPointLC_norm); // original\n\n\t// Now, try to calculate the zone of the our pixel.\n\tvec2 faceTexCoord;\n\tvec3 faceDir;\n\tgetFaceIdx(lightDirToPointLC_norm, faceTexCoord, faceDir);\n\tspotDotAux = dot(lightDirToPointLC_norm, faceDir);\n\tfloat depthFromLight = unpackDepth(depthCube);\n\n\treturn depthFromLight;\n}\n\nvoid main()\n{\n\t//#ifdef USE_LOGARITHMIC_DEPTH\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t//}\n\t//#endif\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\tif(u_processType == 1) // light pass.\n\t\t{\n\t\t\t// Diffuse lighting.\n\t\t\tint dataType = 0;\n\t\t\tvec4 normal4;\n\t\t\tvec3 posCC = getPosCC(screenPos, dataType, normal4);\n\n\t\t\t// vector light-point.\n\t\t\tvec3 vecLightToPointCC = posCC - vLightPosCC;\n\t\t\tvec3 lightDirToPointCC = normalize(posCC - vLightPosCC);\n\t\t\tfloat distToLight = length(vecLightToPointCC);\n\n\t\t\tfloat lightHotDistance = uLightParameters[0];\n\t\t\tfloat lightFalloffLightDist = uLightParameters[1];\n\t\t\tfloat factorByDist = 1.0;\n\n\t\t\t// Calculate the lightFog intensity (case spotLight).***************************************************************************************************************************\n\t\t\tfloat lightFogIntensity = 0.0;\n\t\t\t\n\t\t\t// Calculate how centered is the pixel relative to lightDir, so calculate the crossProduct of "vertexPosLC" to "vLightDirCC".\n\t\t\tvec3 vectorToVertexCC = vertexPosCC.xyz - vLightPosCC;\n\t\t\tfloat dist_vertexCC_toLight = length(vectorToVertexCC);\n\n\t\t\tvec3 dir_camToLight = normalize(vLightPosCC);\n\t\t\tfloat dot_dirCamToLight_lightDir = dot(dir_camToLight, vLightDirCC);\n\n\n\t\t\tfloat factorByDist2 = 1.0 - dist_vertexCC_toLight/(lightFalloffLightDist);\n\t\t\tlightFogIntensity = factorByDist2 * factorByDist2 * abs(dot_dirCamToLight_lightDir * dot_dirCamToLight_lightDir);\n\t\t\tlightFogIntensity *= 0.8;\n\n\t\t\t// DepthTest.\n\t\t\tif(-vertexPosCC.z > -posCC.z)\n\t\t\t{\n\t\t\t\tif(posCC.z < 0.0) // in sky, posCC.z > 0.0\n\t\t\t\tlightFogIntensity = 0.0;\n\t\t\t}\n\n\t\t\tgl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\t\t\t// End fog calculating.------------------------------------------------------------------------------------------------------------------------------------------------------------\n\t\t\t\n\t\t\tif(distToLight > lightFalloffLightDist)\n\t\t\t{\n\t\t\t\t// Apply only lightFog.***\n\t\t\t\t// in final screenQuadPass, use posLC to determine the light-fog.\n\t\t\t\treturn;\n\t\t\t}\n\t\t\telse if(distToLight > lightHotDistance)\n\t\t\t{\n\t\t\t\tfactorByDist = 1.0 - (distToLight - lightHotDistance)/(lightFalloffLightDist - lightHotDistance);\n\t\t\t}\n\n\t\t\tvec3 normal3 = normal4.xyz;\n\t\t\tfloat diffuseDot = dot(-lightDirToPointCC, vec3(normal3));\n\n\t\t\tif(diffuseDot < 0.0)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Check SPOT ANGLES.*****************************************************************************************************************************************\n\t\t\tfloat hotSpotDot = uLightParameters[2];\n\t\t\tfloat falloffSpotDot = uLightParameters[3];\n\n\t\t\tfloat spotDot = dot(vLightDirCC, lightDirToPointCC);\n\t\t\tfloat factorBySpot = 1.0;\n\t\t\tif(spotDot < falloffSpotDot) \n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\telse if(spotDot < hotSpotDot)\n\t\t\t{\n\t\t\t\tfactorBySpot = 1.0 - (hotSpotDot - spotDot)/(hotSpotDot - falloffSpotDot);\n\t\t\t}\n\n\t\t\tif(bApplyShadows)\n\t\t\t{\n\n\t\t\t\t// Now, try to calculate the zone of the our pixel.\n\t\t\t\tfloat spotDotAux;\n\t\t\t\tfloat depthFromLight = getDepthFromLight(lightDirToPointCC, spotDotAux);\n\t\t\t\tdepthFromLight *= lightFalloffLightDist/spotDotAux;\n\n\t\t\t\tfloat depthTolerance = 0.06;\n\t\t\t\tif(distToLight > depthFromLight + depthTolerance)\n\t\t\t\t{\n\t\t\t\t\t// we are in shadow, so do not lighting.\n\t\t\t\t\tgl_FragData[2] = vec4(0.0); // save fog.***\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\n\t\t\t//float fogIntensity = length(vertexPosLC)/lightHotDistance;\n\t\t\tfloat atenuation = 0.4; // intern variable to adjust light intensity.\n\t\t\tdiffuseDot *= factorByDist;\n\t\t\tspotDot *= factorBySpot;\n\t\t\tfloat finalFactor = uLightIntensity * diffuseDot * spotDot * atenuation;\n\t\t\tgl_FragData[0] = vec4(uLightColorAndBrightness.x * finalFactor, \n\t\t\t\t\t\t\t\tuLightColorAndBrightness.y * finalFactor, \n\t\t\t\t\t\t\t\tuLightColorAndBrightness.z * finalFactor, 1.0); \n\n\t\t\t// Specular lighting.\n\t\t\tgl_FragData[1] = vec4(0.0, 0.0, 0.0, 1.0); // save specular.***\n\n\t\t\t//// Light fog.\n\t\t\t////gl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\n\t\t}\n\t\telse if(u_processType == 2) // lightFog pass.\n\t\t{\n\t\t\t// Diffuse lighting.\n\t\t\tint dataType = 0;\n\t\t\tvec4 normal4;\n\t\t\tvec3 posCC = getPosCC(screenPos, dataType, normal4);\n\n\t\t\tfloat lightHotDistance = uLightParameters[0];\n\t\t\tfloat lightFalloffLightDist = uLightParameters[1];\n\n\t\t\t// Calculate the lightFog intensity (case spotLight).***************************************************************************************************************************\n\t\t\tfloat lightFogIntensity = 0.0;\n\t\t\tvec3 dir_camToVertex = normalize(vertexPosCC.xyz);\n\t\t\tvec3 dir_camToLight = normalize(vLightPosCC);\n\t\t\tfloat dist_camToLight = length(vLightPosCC);\n\t\t\tvec3 vertexPP = dir_camToVertex * dist_camToLight;\n\t\t\tfloat dist_vertexPP_toLight = length(vertexPP - vLightPosCC);\n\n\t\t\t// calculate light-to-vertexPP direction.\n\t\t\tvec3 dir_light_toVertexPP = normalize(vertexPP - vLightPosCC);\n\n\t\t\t// calculate dotProd of lightDir & dir_light_toVertexPP. If dot is negative, means that the vertex is rear of light.\n\t\t\tfloat dot_lightDir_lightToVertexPPDir = dot(vLightDirCC, dir_light_toVertexPP);\n\t\t\tfloat dot_dirCamToLight_lightDir = dot(dir_camToLight, vLightDirCC);\n\n\t\t\t// Calculate how centered is the pixel relative to lightDir, so calculate the crossProduct of "vertexPosLC" to "vLightDirCC".\n\t\t\tvec3 vectorLightToVertexCC = vertexPosCC.xyz - vLightPosCC;\n\t\t\tvec3 dirLightToVertexCC = normalize(vectorLightToVertexCC);\n\t\t\tfloat dist_vertexCC_toLight = length(vectorLightToVertexCC);\n\t\t\tvec3 crossProd = cross( dirLightToVertexCC, vLightDirCC );\n\t\t\tvec3 camToVertexCC = normalize(vertexPosCC.xyz);\n\t\t\tfloat dotLightDir = dot(normalize(crossProd), camToVertexCC); // indicates how centered is the point to lightDir.\n\n\t\t\t// Calculate fog by dist to light & try to eliminate the rear-light fog.\n\t\t\tfloat factorByDistFog = 1.0 - dist_vertexPP_toLight / (lightFalloffLightDist * 1.1);\n\t\t\tfactorByDistFog *= abs(dot_lightDir_lightToVertexPPDir);\n\n\t\t\tif(dot_lightDir_lightToVertexPPDir < 0.1)\n\t\t\t{\n\t\t\t\t// we are rear of the light.\n\t\t\t\tfloat factorByRearLight = 1.0 + dot_lightDir_lightToVertexPPDir; \n\t\t\t\tfactorByDistFog *= (factorByRearLight * factorByRearLight);\n\t\t\t}\n\n\t\t\tfloat intensityFactor = 1.0 - abs(dotLightDir);\n\t\t\tlightFogIntensity = intensityFactor * factorByDistFog * 0.5;\n\n\t\t\tfloat camDir_lightDir_factor = dot_dirCamToLight_lightDir * (1.0 - dist_vertexPP_toLight/(lightFalloffLightDist));\n\t\t\tlightFogIntensity += camDir_lightDir_factor * camDir_lightDir_factor * 0.5; // when look with the same direction that lightDir, add aureola.\n\t\t\t// End calculate the lightFog intensity (case spotLight).-----------------------------------------------------------------------------------------------------------------------\n\n\t\t\t// DepthTest.\n\t\t\tif(-vertexPosCC.z > -posCC.z)\n\t\t\t{\n\t\t\t\tif(posCC.z < 0.0) // in sky, posCC.z > 0.0\n\t\t\t\tlightFogIntensity = 0.0;\n\t\t\t\tgl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tgl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\n\t\t\tif(bApplyShadows)\n\t\t\t{\n\t\t\t\t// Now, try to calculate the zone of the our pixel.\n\t\t\t\tfloat spotDotAux;\n\t\t\t\tfloat depthTolerance = 1.5; // high tolerance.\n\t\t\t\tfloat depthFromLight2 = getDepthFromLight(dirLightToVertexCC, spotDotAux);\n\t\t\t\tdepthFromLight2 *= lightFalloffLightDist/spotDotAux;\n\n\t\t\t\tif(dist_vertexCC_toLight > depthFromLight2 + depthTolerance)\n\t\t\t\t{\n\t\t\t\t\t// we are in shadow, so do not lighting.\n\t\t\t\t\tgl_FragData[2] = vec4(0.0);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t// Light fog.\n\t\t\tgl_FragData[2] = vec4(uLightColorAndBrightness.x, uLightColorAndBrightness.y, uLightColorAndBrightness.z, lightFogIntensity); // save fog.***\n\t\t}\n\n\t}\n\t#endif\n\n\n\t\n}',LBufferVS:'\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord; // delete this. lights has no texCoords.\n\tattribute vec4 color4;\n\t\n\tuniform mat4 projectionMatrix;\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\n\t// Light position & direction.\n\tuniform vec3 buildingPosHIGH; // this is the lightPosition high.\n\tuniform vec3 buildingPosLOW; // this is the lightPosition low.\n\tuniform vec3 lightDirWC; // this is the lightDirection (in case of the spotLight type).\n\n\tuniform vec3 scaleLC;\n\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 vertexPosLC;\n\tvarying vec4 vertexPosCC;\n\tvarying float applySpecLighting;\n\tvarying vec4 vColor4; // color from attributes\n\n\tvarying vec3 vLightDirCC; \n\tvarying vec3 vLightPosCC; \n\tvarying float vDotProdLight;\n\tvarying vec3 vCrossProdLight;\n\n  \n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\n\t\t// calculate the light position CC.*****************************************\n\t\tvec3 lightPosHighDiff = buildingPosHIGH - encodedCameraPositionMCHigh;\n\t\tvec3 lightPosLowDiff = buildingPosLOW - encodedCameraPositionMCLow;\n\t\tvec4 lightPosWC = vec4(lightPosHighDiff + lightPosLowDiff, 1.0);\n\t\tvec4 lightPosCC_aux = modelViewMatrixRelToEye * lightPosWC;\n\t\tvLightPosCC = lightPosCC_aux.xyz;\n\t\t//--------------------------------------------------------------------------\n\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\n\t\t// calculate lightDirection in cameraCoord.\n\t\tvLightDirCC = normalize((normalMatrix4 * vec4(lightDirWC, 1.0)).xyz); // original.***\n\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n\t\tvec4 posPP = ModelViewProjectionMatrixRelToEye * pos4;\n        gl_Position = posPP; // posProjected.\n\t\tvertexPosCC = modelViewMatrixRelToEye * pos4;\n\t\t\n\t\t// Calculate the lightFog intensity (case spotLight).*****************************************\n\t\t/*\n\t\tvec3 vectorToVertexCC = vertexPosCC.xyz - vLightPosCC;\n\t\tvec3 dirToVertexCCProjected = normalize(vectorToVertexCC);\n\t\tdirToVertexCCProjected.z = 0.0;\n\t\tvec3 lightDirCCProjected = vec3(vLightDirCC.x, vLightDirCC.y, 0.0);\n\t\tvDotProdLight = dot(dirToVertexCCProjected, lightDirCCProjected);\n\t\t// Calculate how centered is the pixel relative to lightDir, so calculate the crossProduct of "vertexPosLC" to "vLightDirCC".\n\t\tvCrossProdLight = cross( dirToVertexCCProjected, lightDirCCProjected );\n\t\t*/\n\n\t\t// End calculate the lightFog intensity (case spotLight).-------------------------------------\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\t//flogz = 1.0 + gl_Position.w;\n\t\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\t\tflogz = 1.0 - orthoPos.z;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\t}',ModelRefSsaoFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D depthTex; \nuniform sampler2D diffuseTex;\nuniform sampler2D shadowMapTex;\nuniform sampler2D shadowMapTex2;\nuniform sampler2D ssaoFromDepthTex;\nuniform bool textureFlipYAxis;\nuniform mat4 projectionMatrix;\nuniform mat4 projectionMatrixInv;\nuniform mat4 modelViewMatrixRelToEyeInv;\n\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform mat4 m;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;   \nuniform float shadowMapWidth;    \nuniform float shadowMapHeight; \nuniform float shininessValue;\nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\n\nuniform bool bApplyScpecularLighting;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform vec3 specularColor;\nuniform vec3 ambientColor;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform float ambientReflectionCoef;\nuniform float diffuseReflectionCoef;  \nuniform float specularReflectionCoef; \nuniform bool bApplySsao;\nuniform bool bApplyShadow;\nuniform float externalAlpha; // used by effects.\nuniform float uModelOpacity; // this is model\'s alpha.\nuniform vec4 colorMultiplier;\nuniform bool bUseLogarithmicDepth;\n\n// clipping planes.***\nuniform mat4 clippingPlanesRotMatrix; \nuniform vec3 clippingPlanesPosHIGH;\nuniform vec3 clippingPlanesPosLOW;\nuniform bool bApplyClippingPlanes; // old. deprecated.***\nuniform int clippingType; // 0= no clipping. 1= clipping by planes. 2= clipping by localCoord polyline. 3= clip by heights, 4= clip by (2, 3)\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform vec2 clippingPolygon2dPoints[64];\nuniform int clippingConvexPolygon2dPointsIndices[64];\nuniform vec4 limitationInfringedColor4;\nuniform vec2 limitationHeights;\n\nuniform int uFrustumIdx;\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \nvarying vec3 vLightWeighting;\nvarying vec3 diffuseColor;\nvarying vec3 vertexPos; // this is the orthoPos.***\nvarying vec3 vertexPosLC;\nvarying float applySpecLighting;\nvarying vec4 vPosRelToLight; \nvarying vec3 vLightDir; \nvarying vec3 vNormalWC;\nvarying float currSunIdx; \nvarying float vDepth;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depthAux = dot(rgba_depth, bit_shift);\n    return depthAux;\n}  \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\n/*\n// unpack depth used for shadow on screen.***\nfloat unpackDepth_A(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n*/\n\nfloat UnpackDepth32( in vec4 pack )\n{\n\tfloat depth = dot( pack, vec4(1.0, 0.00390625, 0.000015258789, 0.000000059605) );\n    return depth * 1.000000059605;// 1.000000059605 = (16777216.0) / (16777216.0 - 1.0);\n}             \n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nfloat getDepthShadowMap(vec2 coord)\n{\n\t// currSunIdx\n\tif(currSunIdx > 0.0 && currSunIdx < 1.0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex, coord.xy));\n\t}\n    else if(currSunIdx > 1.0 && currSunIdx < 2.0)\n\t{\n\t\treturn UnpackDepth32(texture2D(shadowMapTex2, coord.xy));\n\t}\n\telse\n\t\treturn -1.0;\n}  \n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvec2 getDirection2d(in vec2 startPoint, in vec2 endPoint)\n{\n\t//vec2 vector = endPoint - startPoint;\n\t//float length = length( vector);\n\t//vec2 dir = vec2(vector.x/length, vector.y/length);\n\tvec2 dir = normalize(endPoint - startPoint);\n\treturn dir;\n}\n\nbool intersectionLineToLine(in vec2 line_1_pos, in vec2 line_1_dir,in vec2 line_2_pos, in vec2 line_2_dir, out vec2 intersectionPoint2d)\n{\n\tbool bIntersection = false;\n\n\tfloat zero = 10E-8;\n\tfloat intersectX;\n\tfloat intersectY;\n\n\t// check if 2 lines are parallel.***\n\tfloat dotProd = abs(dot(line_1_dir, line_2_dir));\n\tif(abs(dotProd-1.0) < zero)\n\treturn false;\n\n\tif (abs(line_1_dir.x) < zero)\n\t{\n\t\t// this is a vertical line.\n\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\n\t\tintersectX = line_1_pos.x;\n\t\tintersectY = slope * line_1_pos.x + b;\n\t\tbIntersection = true;\n\t}\n\telse if (abs(line_1_dir.y) < zero)\n\t{\n\t\t// this is a horizontal line.\n\t\t// must check if the "line" is vertical.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (line_1_pos.y - b)/slope;\n\t\t\tintersectY = line_1_pos.y;\n\t\t\tbIntersection = true;\n\t\t}\t\n\t}\n\telse \n\t{\n\t\t// this is oblique.\n\t\tif (abs(line_2_dir.x) < zero)\n\t\t{\n\t\t\t// "line" is vertical.\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\tintersectX = line_2_pos.x;\n\t\t\tintersectY = intersectX * mySlope + myB;\n\t\t\tbIntersection = true;\n\t\t}\n\t\telse \n\t\t{\n\t\t\tfloat mySlope = line_1_dir.y / line_1_dir.x;\n\t\t\tfloat myB = line_1_pos.y - mySlope * line_1_pos.x;\n\t\t\t\n\t\t\tfloat slope = line_2_dir.y / line_2_dir.x;\n\t\t\tfloat b = line_2_pos.y - slope * line_2_pos.x;\n\t\t\t\n\t\t\tintersectX = (myB - b)/ (slope - mySlope);\n\t\t\tintersectY = slope * intersectX + b;\n\t\t\tbIntersection = true;\n\t\t}\n\t}\n\n\tintersectionPoint2d.x = intersectX;\n\tintersectionPoint2d.y = intersectY;\n\n\treturn bIntersection;\n}\n\nvec2 getProjectedPoint2dToLine(in vec2 line_point, in vec2 line_dir, in vec2 point)\n{\n\tbool intersection = false;\n\n\t// create a perpendicular left line.***\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\tvec2 lineLeft_point = vec2(point.x, point.y);\n\tvec2 projectedPoint = vec2(0);\n\tintersection = intersectionLineToLine(line_point, line_dir, lineLeft_point, lineLeft_dir, projectedPoint);\n\n\treturn projectedPoint;\n}\n\nint getRelativePositionOfPointToLine(in vec2 line_pos, in vec2 line_dir, vec2 point)\n{\n\t// 0 = coincident. 1= left side. 2= right side.***\n\tint relPos = -1;\n\n\tvec2 projectedPoint = getProjectedPoint2dToLine(line_pos, line_dir, point );\n\tfloat dist = length(point - projectedPoint);\n\n\tif(dist < 1E-8)\n\t{\n\t\trelPos = 0; // the point is coincident to line.***\n\t\treturn relPos;\n\t}\n\n\tvec2 myVector = normalize(point - projectedPoint);\n\tvec2 lineLeft_dir = vec2(-line_dir.y, line_dir.x);\n\n\tfloat dotProd = dot(lineLeft_dir, myVector);\n\n\tif(dotProd > 0.0)\n\t{\n\t\trelPos = 1; // is in left side of the line.***\n\t}\n\telse\n\t{\n\t\trelPos = 2; // is in right side of the line.***\n\t}\n\n\treturn relPos;\n}\n\nbool isPointInsideLimitationConvexPolygon(in vec2 point2d)\n{\n\tbool isInside = true;\n\n\t// Check polygons.***\n\tint startIdx = -1;\n\tint endIdx = -1;\n\tfor(int i=0; i<32; i++)\n\t{\n\t\tstartIdx = clippingConvexPolygon2dPointsIndices[2*i];  // 0\n\t\tendIdx = clippingConvexPolygon2dPointsIndices[2*i+1];\t // 3\n\n\t\tif(startIdx < 0 || endIdx < 0)\n\t\tbreak;\n\n\t\tisInside  = true;\n\t\t\n\t\tisInside = true;\n\t\tvec2 pointStart = clippingPolygon2dPoints[0];\n\t\tfor(int j=0; j<32; j++)\n\t\t{\n\t\t\tif(j > endIdx)\n\t\t\tbreak;\n\n\t\t\tif(j == startIdx)\n\t\t\t\tpointStart = clippingPolygon2dPoints[j];\n\n\t\t\tif(j >= startIdx && j<endIdx)\n\t\t\t{\n\t\t\t\tvec2 point0;\n\t\t\t\tvec2 point1;\n\t\t\t\t\n\t\t\t\tif(j == endIdx)\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = pointStart;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tpoint0 = clippingPolygon2dPoints[j];\n\t\t\t\t\tpoint1 = clippingPolygon2dPoints[j+1];\n\t\t\t\t}\n\n\t\t\t\t// create the line of the segment.***\n\t\t\t\tvec2 dir = getDirection2d(point0, point1);\n\n\t\t\t\t// now, check the relative position of the point with the edge line.***\n\t\t\t\tint relPos = getRelativePositionOfPointToLine(point0, dir, point2d);\n\t\t\t\tif(relPos == 2)\n\t\t\t\t{\n\t\t\t\t\t// the point is in the right side of the edge line, so is out of the polygon.***\n\t\t\t\t\tisInside = false;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t}\n\t\t\n\n\t\tif(isInside)\n\t\treturn true;\n\n\t}\n\n\treturn isInside;\n}\n\n\n\n/*\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/screenWidth;\n    float pixelSizeY = 1.0/screenHeight;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<1.0; i++)\n\t{\n\t\tdepthA += getDepth(texCoord + offset1*(1.0+i));\n\t\tdepthB += getDepth(texCoord + offset2*(1.0+i));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*1.0, depthA/1.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*1.0, depthB/1.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n\nmat3 sx = mat3( \n    1.0, 2.0, 1.0, \n    0.0, 0.0, 0.0, \n    -1.0, -2.0, -1.0 \n);\nmat3 sy = mat3( \n    1.0, 0.0, -1.0, \n    2.0, 0.0, -2.0, \n    1.0, 0.0, -1.0 \n);\n\nbool isEdge()\n{\n\tvec3 I[3];\n\tvec2 screenPos = vec2((gl_FragCoord.x) / screenWidth, (gl_FragCoord.y) / screenHeight);\n\tfloat linearDepth = getDepth(screenPos);\n\tvec3 normal = normal_from_depth(linearDepth, screenPos);\n\n    for (int i=0; i<3; i++) {\n        //vec3 norm1 = texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,-1), 0 ).rgb * 2.0f - 1.0f;\n        //vec3 norm2 =  texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,0), 0 ).rgb * 2.0f - 1.0f;\n        //vec3 norm3 = texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,1), 0 ).rgb * 2.0f - 1.0f;\n\t\tvec2 screenPos1 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y-1.0) / screenHeight);\n\t\tfloat linearDepth1 = getDepth(screenPos1);  \n\n\t\tvec2 screenPos2 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y-0.0) / screenHeight);\n\t\tfloat linearDepth2 = getDepth(screenPos2);  \n\n\t\tvec2 screenPos3 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y+1.0) / screenHeight);\n\t\tfloat linearDepth3 = getDepth(screenPos1);  \n\n\t\tvec3 norm1 = normal_from_depth(linearDepth1, screenPos1);\n        vec3 norm2 =  normal_from_depth(linearDepth2, screenPos2);\n        vec3 norm3 = normal_from_depth(linearDepth3, screenPos3);\n        float sampleValLeft  = dot(normal, norm1);\n        float sampleValMiddle  = dot(normal, norm2);\n        float sampleValRight  = dot(normal, norm3);\n        I[i] = vec3(sampleValLeft, sampleValMiddle, sampleValRight);\n    }\n\n    float gx = dot(sx[0], I[0]) + dot(sx[1], I[1]) + dot(sx[2], I[2]); \n    float gy = dot(sy[0], I[0]) + dot(sy[1], I[1]) + dot(sy[2], I[2]);\n\n    if((gx < 0.0 && gy < 0.0) || (gy < 0.0 && gx < 0.0) ) \n        return false;\n\tfloat g = sqrt(pow(gx, 2.0)+pow(gy, 2.0));\n\n    if(g > 0.2) {\n        return true;\n    } \n\treturn false;\n}\n*/\n\n\nvoid main()\n{\n\t//gl_FragData = vColor4; \n\t//return;\n\n\tif(clippingType == 2)\n\t{\n\t\t// clip by limitationPolygon.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 3)\n\t{\n\t\t// check limitation heights.***\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\telse if(clippingType == 4)\n\t{\n\t\t// clip by limitationPolygon & heights.***\n\t\tvec2 pointLC = vec2(vertexPosLC.x, vertexPosLC.y);\n\t\tif(!isPointInsideLimitationConvexPolygon(pointLC))\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t\tif(vertexPosLC.z < limitationHeights.x || vertexPosLC.z > limitationHeights.y)\n\t\t{\n\t\t\tgl_FragData[0] = limitationInfringedColor4; \n\t\t\treturn;\n\t\t}\n\t}\n\n\t// Check if clipping.********************************************\n\t\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = false;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\t\n\t\t\t// calculate any point of the plane.\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false; // false.\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t}\n\t\n\t//----------------------------------------------------------------\n\n\t//bool testBool = false;\n\tfloat occlusion = 1.0; // ambient occlusion.***\n\tfloat shadow_occlusion = 1.0;\n\tvec3 normal2 = vNormal;\t\n\tfloat scalarProd = 1.0;\n\t\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t//float linearDepth = getDepth(screenPos);   \n\tvec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\tscalarProd = abs(dot(normal2, normalize(-ray)));\n\t//scalarProd *= scalarProd;\n\tscalarProd *= 0.6;\n\tscalarProd += 0.4;\n\n\tocclusion = 1.0;\n\n\tvec4 textureColor;\n    if(colorType == 2)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = vColor4;\n    }\n\t\n    // Do specular lighting.***\n\tfloat lambertian = 1.0;\n\tfloat specular = 0.0;\n\n\t//if((textureColor.r < 0.5 && textureColor.b > 0.5) || textureColor.a < 1.0)\n\n\tlambertian = 1.0;\n\t\n\tif(bApplyShadow)\n\t{\n\t\tif(currSunIdx > 0.0)\n\t\t{\n\t\t\tfloat ligthAngle = dot(vLightDir, vNormalWC);\n\t\t\tif(ligthAngle > 0.0)\n\t\t\t{\n\t\t\t\t// The angle between the light direction & face normal is less than 90 degree, so, the face is in shadow.***\n\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvec3 posRelToLight = vPosRelToLight.xyz / vPosRelToLight.w;\n\t\t\t\tfloat tolerance = 0.9963;\n\t\t\t\tposRelToLight = posRelToLight * 0.5 + 0.5; // transform to [0,1] range\n\t\t\t\tif(posRelToLight.x >= 0.0 && posRelToLight.x <= 1.0)\n\t\t\t\t{\n\t\t\t\t\tif(posRelToLight.y >= 0.0 && posRelToLight.y <= 1.0)\n\t\t\t\t\t{\n\t\t\t\t\t\tfloat depthRelToLight = getDepthShadowMap(posRelToLight.xy);\n\t\t\t\t\t\tif(posRelToLight.z > depthRelToLight*tolerance )\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// test. Calculate the zone inside the pixel.************************************\n\t\t\t\t//https://docs.microsoft.com/ko-kr/windows/win32/dxtecharts/cascaded-shadow-maps\n\t\t\t}\n\t\t}\n\t}\n\n\t\n\t// New lighting.***********************************************************************************************\n\tvec3 ambientColor = vec3(0.6);\n\tvec3 directionalLightColor = vec3(0.9, 0.9, 0.9);\n\tvec3 lightingDirection = normalize(vec3(0.6, 0.6, 0.6));\n\tfloat directionalLightWeighting = max(dot(vNormal, lightingDirection), 0.0);\n\tvec3 lightWeighting = ambientColor + directionalLightColor * directionalLightWeighting; // original.***\n\t// End lighting.-------------------------------------------------------------------------------------------------\n\t\n\t\n\tfloat alfa = textureColor.w * externalAlpha * uModelOpacity;\n    vec4 finalColor;\n\tfinalColor = vec4(textureColor.r, textureColor.g, textureColor.b, alfa);\n\tfinalColor *= vec4(lightWeighting, 1.0) ;\n\tfinalColor *= colorMultiplier;\n\n\tvec4 albedo4 = finalColor;\n    gl_FragData[0] = finalColor; \n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t{\n\t\t// save depth, normal, albedo.\n\t\tfloat depthAux = vDepth;\n\t\tgl_FragData[1] = packDepth(depthAux); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\t}\n\t#endif\n\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}',ModelRefSsaoVS:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 projectionMatrix;  \n\tuniform mat4 modelViewMatrix;\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform mat4 sunMatrix[2]; \n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 sunPosHIGH[2];\n\tuniform vec3 sunPosLOW[2];\n\tuniform int sunIdx;\n\tuniform vec3 sunDirWC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform bool bApplySpecularLighting;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bApplyShadow;\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying vec3 vertexPosLC;\n\tvarying float applySpecLighting;\n\tvarying vec4 vColor4; // color from attributes\n\tvarying vec4 vPosRelToLight; // sun lighting.\n\tvarying vec3 vLightDir; \n\tvarying vec3 vNormalWC; \n\tvarying float currSunIdx;  \n\tvarying float discardFrag;\n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\tvarying float vDepth;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\tif(refMatrixType == 0)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 1)\n\t\t{\n\t\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t\t}\n\t\telse if(refMatrixType == 2)\n\t\t{\n\t\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t\t}\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\t\n\t\t\n\t\t\n\t\tvec3 uLightingDirection = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496); \n\t\tuAmbientColor = vec3(1.0);\n\t\tvNormalWC = rotatedNormal;\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\t\tvLightDir = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tfloat directionalLightWeighting = 1.0;\n\t\t\n\t\tcurrSunIdx = -1.0; // initially no apply shadow.\n\t\tif(bApplyShadow)\n\t\t{\n\t\t\t//vLightDir = normalize(vec3(normalMatrix4 * vec4(sunDirWC.xyz, 1.0)).xyz); // test.***\n\t\t\tvLightDir = sunDirWC;\n\t\t\tvNormalWC = rotatedNormal;\n\t\t\t\t\t\t\n\t\t\t// the sun lights count are 2.\n\t\t\t\n\t\t\tvec3 currSunPosLOW;\n\t\t\tvec3 currSunPosHIGH;\n\t\t\tmat4 currSunMatrix;\n\t\t\tif(sunIdx == 0)\n\t\t\t{\n\t\t\t\tcurrSunPosLOW = sunPosLOW[0];\n\t\t\t\tcurrSunPosHIGH = sunPosHIGH[0];\n\t\t\t\tcurrSunMatrix = sunMatrix[0];\n\t\t\t\tcurrSunIdx = 0.5;\n\t\t\t}\n\t\t\telse if(sunIdx == 1)\n\t\t\t{\n\t\t\t\tcurrSunPosLOW = sunPosLOW[1];\n\t\t\t\tcurrSunPosHIGH = sunPosHIGH[1];\n\t\t\t\tcurrSunMatrix = sunMatrix[1];\n\t\t\t\tcurrSunIdx = 1.5;\n\t\t\t}\n\t\t\t\n\t\t\t// Calculate the vertex relative to light.***\n\t\t\tvec3 highDifferenceSun = objPosHigh.xyz - currSunPosHIGH.xyz;\n\t\t\tvec3 lowDifferenceSun = objPosLow.xyz - currSunPosLOW.xyz;\n\t\t\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\t\t\tvPosRelToLight = currSunMatrix * pos4Sun;\n\t\t\t\n\t\t\tuLightingDirection = sunDirWC; \n\t\t\t//directionalLightColor = vec3(0.9, 0.9, 0.9);\n\t\t\tdirectionalLightWeighting = max(dot(rotatedNormal, -sunDirWC), 0.0);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tuAmbientColor = vec3(0.8);\n\t\t\tuLightingDirection = normalize(vec3(0.6, 0.6, 0.6));\n\t\t\t//uLightingDirection = normalize(vec3(0.2, 0.6, 1.0));\n\t\t\tdirectionalLightWeighting = max(dot(vNormal, uLightingDirection), 0.0);\n\t\t}\n\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting; // original.***\n\t\t\n\t\tif(bApplySpecularLighting)\n\t\t\tapplySpecLighting = 1.0;\n\t\telse\n\t\t\tapplySpecLighting = -1.0;\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\tvertexPos = orthoPos.xyz;\n\t\tvDepth = -orthoPos.z/far;\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\n\t\t//if(orthoPos.z < 0.0)\n\t\t//aColor4 = vec4(1.0, 0.0, 0.0, 1.0);\n\t\t//else\n\t\t//aColor4 = vec4(0.0, 1.0, 0.0, 1.0);\n\t\tgl_PointSize = 5.0;\n\t}",OrthogonalDepthShaderFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform sampler2D diffuseTex;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform bool textureFlipYAxis;  \n\nvarying float depth;\nvarying vec2 vTexCoord;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvec4 PackDepth32( in float depth )\n{\n    depth *= (16777216.0 - 1.0) / (16777216.0);\n    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n}\n\nvoid main()\n{     \n    if(colorType == 2)\n    {\n        vec4 textureColor;\n        if(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\t\n        if(textureColor.w == 0.0)\n        {\n            discard;\n        }\n    }\n    gl_FragData[0] = PackDepth32(depth);\n\t//gl_FragData[0] = packDepth(-depth);\n}",OrthogonalDepthShaderVS:"attribute vec3 position;\nattribute vec2 texCoord;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nvarying float depth;\nvarying vec2 vTexCoord;\n  \nvoid main()\n{\t\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n    //depth = (modelViewMatrixRelToEye * pos4).z/far; // original.***\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tdepth = gl_Position.z*0.5+0.5;\n\tvTexCoord = texCoord;\n}\n",OrthogonalVoxelizationShaderFS_MRT:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D currDEMTex;\n\nuniform vec2 u_heightMap_MinMax; // terrain min max heights. \nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec3 u_quantizedVolume_MinMax[2]; // the minimum is [0,0,0], and the maximum is [1,1,1].***\nuniform int u_terrainHeightEncodingBytes;\n\n\nvarying float vDepth;\nvarying float vAltitude;\nvarying vec3 vNormal3;\nvarying vec4 glPos;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\n\n\nvoid main()\n{     \n    //vec2 screenPos = vec2(gl_FragCoord.x / u_simulationTextureSize.x, gl_FragCoord.y / u_simulationTextureSize.y);\n\n    // Check if the current fragment is inside of the u_quantizedVolume_MinMax.***\n    vec3 quantizedVolumeMin = u_quantizedVolume_MinMax[0];\n    vec3 quantizedVolumeMax = u_quantizedVolume_MinMax[1];\n    vec3 quantizedPos = glPos.xyz * 0.5 + 0.5;\n    \n    if(quantizedPos.x < quantizedVolumeMin.x || quantizedPos.x > quantizedVolumeMax.x)\n    {\n        discard;\n    }\n    else if(quantizedPos.y < quantizedVolumeMin.y || quantizedPos.y > quantizedVolumeMax.y)\n    {\n        discard;\n    }\n    else if(quantizedPos.z < quantizedVolumeMin.z || quantizedPos.z > quantizedVolumeMax.z)\n    {\n        discard;\n    }\n\n    // Calculate the zDepth ranges for each MRT texture.***\n    // Note : consider that there are 8 output textures.***\n    float zDepthRangeTotal = quantizedVolumeMax.z - quantizedVolumeMin.z;\n    float zDepthOneSlice = zDepthRangeTotal / 8.0;\n    vec4 zeroColor4 = vec4(0.0); // original.***\n    vec4 solidColor4 = vec4(1.0, 1.0, 1.0, 1.0);\n\n    float qPosZ = quantizedPos.z;\n    solidColor4 = vec4(qPosZ, qPosZ, qPosZ, 1.0);\n\n    float factor = 0.6; // original.***\n\n    // Now, for each output texture, calculate if intersects the quantizedPos.***\n    // gl_FragData[0] - is the nearest slice.***\n    gl_FragData[0] = zeroColor4;\n    float slice_minZ = quantizedVolumeMin.z;\n    float slice_maxZ = quantizedVolumeMin.z + zDepthOneSlice;\n    slice_minZ -= zDepthOneSlice * factor;\n    slice_maxZ += zDepthOneSlice * factor;\n    if(qPosZ >= slice_minZ && qPosZ < slice_maxZ)\n    {\n        // the current fragment intersects.***\n        gl_FragData[0] = solidColor4;\n    }\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        // gl_FragData[1] - is the 2nd nearest slice.***\n        gl_FragData[1] = zeroColor4; \n        \n        slice_minZ = quantizedVolumeMin.z + zDepthOneSlice;\n        slice_maxZ = quantizedVolumeMin.z + zDepthOneSlice * 2.0;\n        slice_minZ -= zDepthOneSlice * factor;\n        slice_maxZ += zDepthOneSlice * factor;\n        if(qPosZ >= slice_minZ && qPosZ < slice_maxZ)\n        {\n            // the current fragment intersects.***\n            gl_FragData[1] = solidColor4;\n        }\n\n        // gl_FragData[2].***\n        gl_FragData[2] = zeroColor4; \n        slice_minZ = quantizedVolumeMin.z + zDepthOneSlice*2.0;\n        slice_maxZ = quantizedVolumeMin.z + zDepthOneSlice*3.0;\n        slice_minZ -= zDepthOneSlice * factor;\n        slice_maxZ += zDepthOneSlice * factor;\n        if(qPosZ >= slice_minZ && qPosZ < slice_maxZ)\n        {\n            // the current fragment intersects.***\n            gl_FragData[2] = solidColor4;\n        }\n\n        // gl_FragData[3].***\n        gl_FragData[3] = zeroColor4; \n        slice_minZ = quantizedVolumeMin.z + zDepthOneSlice*3.0;\n        slice_maxZ = quantizedVolumeMin.z + zDepthOneSlice*4.0;\n        slice_minZ -= zDepthOneSlice * factor;\n        slice_maxZ += zDepthOneSlice * factor;\n        if(qPosZ >= slice_minZ && qPosZ < slice_maxZ)\n        {\n            // the current fragment intersects.***\n            gl_FragData[3] = solidColor4;\n        }\n\n        // gl_FragData[4].***\n        gl_FragData[4] = zeroColor4; \n        slice_minZ = quantizedVolumeMin.z + zDepthOneSlice*4.0;\n        slice_maxZ = quantizedVolumeMin.z + zDepthOneSlice*5.0;\n        slice_minZ -= zDepthOneSlice * factor;\n        slice_maxZ += zDepthOneSlice * factor;\n        if(qPosZ >= slice_minZ && qPosZ < slice_maxZ)\n        {\n            // the current fragment intersects.***\n            gl_FragData[4] = solidColor4;\n        }\n\n        // gl_FragData[5].***\n        gl_FragData[5] = zeroColor4; \n        slice_minZ = quantizedVolumeMin.z + zDepthOneSlice*5.0;\n        slice_maxZ = quantizedVolumeMin.z + zDepthOneSlice*6.0;\n        slice_minZ -= zDepthOneSlice * factor;\n        slice_maxZ += zDepthOneSlice * factor;\n        if(qPosZ >= slice_minZ && qPosZ < slice_maxZ)\n        {\n            // the current fragment intersects.***\n            gl_FragData[5] = solidColor4;\n        }\n\n        // gl_FragData[6].***\n        gl_FragData[6] = zeroColor4; \n        slice_minZ = quantizedVolumeMin.z + zDepthOneSlice*6.0;\n        slice_maxZ = quantizedVolumeMin.z + zDepthOneSlice*7.0;\n        slice_minZ -= zDepthOneSlice * factor;\n        slice_maxZ += zDepthOneSlice * factor;\n        if(qPosZ >= slice_minZ && qPosZ < slice_maxZ)\n        {\n            // the current fragment intersects.***\n            gl_FragData[6] = solidColor4;\n        }\n\n        // gl_FragData[7] - is the farest slice.***\n        gl_FragData[7] = zeroColor4; \n        slice_minZ = quantizedVolumeMin.z + zDepthOneSlice*7.0;\n        slice_maxZ = quantizedVolumeMin.z + zDepthOneSlice*8.0;\n        slice_minZ -= zDepthOneSlice * factor;\n        slice_maxZ += zDepthOneSlice * factor;\n        if(qPosZ >= slice_minZ && qPosZ < slice_maxZ)\n        {\n            // the current fragment intersects.***\n            gl_FragData[7] = solidColor4;\n        }\n\n \n    #endif\n}",OrthogonalVoxelizationShaderVS_MRT:'precision highp float;\n\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\n\nuniform mat4 buildingRotMatrix;  \nuniform mat4 RefTransfMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nuniform vec4 u_color4;\nvarying float vDepth;\nvarying float vAltitude;\nvarying vec4 vColor4;\nvarying vec3 vNormal3;\nvarying vec4 glPos;\n\n#define M_PI 3.1415926535897932384626433832795\n\nfloat cbrt(in float val)\n{\n\tif (val < 0.0) {\n \n        return -pow(-val, 1.0 / 3.0);\n    }\n \n    else {\n \n        return pow(val, 1.0 / 3.0);\n    }\n}\n\nfloat atanHP_getConstant(in int j) \n{\n\tfloat constant = 0.0;\n\n\t// https://studylib.net/doc/18241330/high-precision-calculation-of-arcsin-x--arceos-x--and-arctan\n\t// The constants tan(j*PI/24), (j = 1, 2, • • • , 11) and PI/2 are:\n\t// j = 1 -> tan(PI/24) =     0.13165 24975 87395 85347 2\n\t// j = 2 -> tan(PI/12) =     0.26794 91924 31122 70647 3\n\t// j = 3 -> tan(PI/8) =      0.41421 35623 73095 04880 2\n\t// j = 4 -> tan(PI/6) =      0.57735 02691 89625 76450 9\n\t// j = 5 -> tan(5*PI/24) =   0.76732 69879 78960 34292 3\n\t// j = 6 -> tan(PI/4) =      1.00000 00000 00000 00000 0\n\t// j = 7 -> tan(7*PI/24) =   1.30322 53728 41205 75586 8\n\t// j = 8 -> tan(PI/3) =      1.73205 08075 68877 29352 7\n\t// j = 9 -> tan(3*PI/8) =    2.41421 35623 73095 04880 2\n\t// j = 10 -> tan(5*PI/12) =  3.73205 08075 68877 29352 7\n\t// j = 11 -> tan(11*PI/24) = 7.59575 41127 25150 44052 6\n\t// PI/2 =                    1.57079 63267 94896 61923 1\n\n\tif(j == 1)\n\t{\n\t\tconstant = 0.131652497587395853472;\n\t}\n\telse if(j == 2)\n\t{\n\t\tconstant = 0.267949192431122706473;\n\t}\n\telse if(j == 3)\n\t{\n\t\tconstant = 0.414213562373095048802;\n\t}\n\telse if(j == 4)\n\t{\n\t\tconstant = 0.577350269189625764509;\n\t}\n\telse if(j == 5)\n\t{\n\t\tconstant = 0.767326987978960342923;\n\t}\n\telse if(j == 6)\n\t{\n\t\tconstant = 1.000000000000000000000;\n\t}\n\telse if(j == 7)\n\t{\n\t\tconstant = 1.303225372841205755868;\n\t}\n\telse if(j == 8)\n\t{\n\t\tconstant = 1.732050807568877293527;\n\t}\n\telse if(j == 9)\n\t{\n\t\tconstant = 2.414213562373095048802;\n\t}\n\telse if(j == 10)\n\t{\n\t\tconstant = 3.732050807568877293527;\n\t}\n\telse if(j == 11)\n\t{\n\t\tconstant = 7.595754112725150440526;\n\t}\n\telse if(j == 12)\n\t{\n\t\tconstant = 1.570796326794896619231;\n\t}\n\n\treturn constant;\n}\n\nint atanHP_getInterval(in float x) \n{\n\t// Subdivide the interval (0, infinite ) into seven intervals as follows:\n\t// 0 <= u < tan(PI/24)\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(11PI/24) <= u < infinite.\n\t//------------------------------------------------------------------------\n\tfloat u = abs(x);\n\tint interval = -1;\n\n\t// check if is interval = 0.******************************************************************\n\t// 0 <= u < tan(PI/24)\n\tfloat tan_PIdiv24 = atanHP_getConstant(1);\n\tif(u < tan_PIdiv24)\n\t{\n\t\treturn 0;\n\t}\n\n\t// check if is interval = 1: (j = interval + 1), so j = 2.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(PI/24) <= u < tan(PI/8)\n\tfloat min = atanHP_getConstant(1);\n\tfloat max = atanHP_getConstant(3);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 1;\n\t}\n\t\n\t// check if is interval = 2: (j = interval + 1), so j = 3.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(PI/8) <= u < tan(5*PI/24)\n\tmin = atanHP_getConstant(3);\n\tmax = atanHP_getConstant(5);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 2;\n\t}\n\n\t// check if is interval = 3: (j = interval + 1), so j = 4.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(5*PI/24) <= u < tan(7*PI/24)\n\tmin = atanHP_getConstant(5);\n\tmax = atanHP_getConstant(7);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 3;\n\t}\n\n\t// check if is interval = 4: (j = interval + 1), so j = 5.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(7*PI/24) <= u < tan(3*PI/8)\n\tmin = atanHP_getConstant(7);\n\tmax = atanHP_getConstant(9);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 4;\n\t}\n\n\t// check if is interval = 5: (j = interval + 1), so j = 6.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(3*PI/8) <= u < tan(11*PI/24)\n\tmin = atanHP_getConstant(9);\n\tmax = atanHP_getConstant(11);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 5;\n\t}\n\n\t// check if is interval = 6: (j = interval + 1), so j = 6.***********************************\n\t// tan(11PI/24) <= u < infinite.\n\tmin = atanHP_getConstant(11);\n\tif(u >= min)\n\t{\n\t\treturn 6;\n\t}\n\n\n\treturn interval;\n}\n\nfloat atanHP_polynomialApproximation(in float x) \n{\n\t// P(x) = a1*x + a3*pow(x, 3) + ... + a17*pow(x, 17)\n\tfloat result_atan = -1.0;\n\n\tfloat a1 = 1.0;\n\tfloat a3 = -0.333333333333333331607;\n\tfloat a5 = 0.199999999999998244448;\n\tfloat a7 = -0.142857142856331306529;\n\tfloat a9 = 0.111111110907793967393;\n\tfloat a11 = -0.0909090609633677637073;\n\tfloat a13 = 0.0769204073249154081320;\n\tfloat a15 = -0.0665248229413108277905;\n\tfloat a17 = 0.0546721009395938806941;\n\n\tresult_atan = a1*x + a3*pow(x, 3.0) + a5*pow(x, 5.0) +  a7*pow(x, 7.0) +  a9*pow(x, 9.0) +  a11*pow(x, 11.0) +  a13*pow(x, 13.0) +  a15*pow(x, 15.0) +  a17*pow(x, 17.0);\n\n\treturn result_atan;\n}\n\nfloat atanHP(in float x) // atan High Precision.\n{\n\t// https://studylib.net/doc/18241330/high-precision-calculation-of-arcsin-x--arceos-x--and-arctan\n\t//-----------------------------------------------------------------------------------------------\n\n\t// Obtain the interval.\n\tint interval = atanHP_getInterval(x);\n\n\tif(interval == 0)\n\t{\n\t\t// use polynomial approximation.\n\t\treturn atanHP_polynomialApproximation(x);\n\t}\n\telse if(interval >= 1 && interval <6)\n\t{\n\t\t// use Arctan|x| = (j*PI/12) + Arctan(tj),\n\t\t// where tj = A / B, where\n\t\t// A = |x| - tan(j*PI/12)\n\t\t// B = 1 + |x| * tan(j*PI/12).\n\t\tfloat tan_jPIdiv12;\n\t\tfloat j = float(interval);\n\t\tif(interval == 1)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(2);\n\t\t}\n\t\telse if(interval == 2)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(4);\n\t\t}\n\t\telse if(interval == 3)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(6);\n\t\t}\n\t\telse if(interval == 4)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(8);\n\t\t}\n\t\telse if(interval == 5)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(10);\n\t\t}\n\n\t\tfloat A = abs(x) - tan_jPIdiv12;\n\t\tfloat B = 1.0 + abs(x) * tan_jPIdiv12;\n\t\tfloat tj = A/B;\n\t\tfloat arctan_tj = atanHP_polynomialApproximation(tj);\n\t\tfloat arctan = (j*M_PI/12.0) + arctan_tj;\n\t\treturn arctan;\n\t}\n\telse\n\t{\n\t\t// the interval = 6 (the last interval).\n\t\t// In this case,\n\t\t// Arctan|x| = PI/2 - Arctan(1/|x|).\n\t\tfloat pi_div2 = atanHP_getConstant(12);\n\t\tfloat arctan = pi_div2 - atan(1.0/abs(x));\n\t\treturn arctan;\n\t}\n\n\treturn -1.0;\n}\n\nfloat atan2(in float y, in float x) \n{\n\tif (x > 0.0)\n\t{\n\t\treturn atanHP(y/x);\n\t}\n\telse if (x < 0.0)\n\t{\n\t\tif (y >= 0.0)\n\t\t{\n\t\t\treturn atanHP(y/x) + M_PI;\n\t\t}\n\t\telse \n\t\t{\n\t\t\treturn atanHP(y/x) - M_PI;\n\t\t}\n\t}\n\telse if (x == 0.0)\n\t{\n\t\tif (y>0.0)\n\t\t{\n\t\t\treturn M_PI/2.0;\n\t\t}\n\t\telse if (y<0.0)\n\t\t{\n\t\t\treturn -M_PI/2.0;\n\t\t}\n\t\telse \n\t\t{\n\t\t\treturn 0.0; // return undefined.\n\t\t}\n\t}\n}\n\nvec3 CartesianToGeographicWgs84(vec3 posWC, inout float inoutAux)\n{\n\tvec3 geoCoord;\n\n\t// From WebWorldWind.\n\t// According to H. Vermeille, "An analytical method to transform geocentric into geodetic coordinates"\n\t// http://www.springerlink.com/content/3t6837t27t351227/fulltext.pdf\n\t// Journal of Geodesy, accepted 10/2010, not yet published\n\t\n\t\n\t//// equatorialRadius = 6378137.0; // meters.\n\t//// polarRadius = 6356752.3142; // meters.\n\t//// firstEccentricitySquared = 6.69437999014E-3;\n\t//// secondEccentricitySquared = 6.73949674228E-3;\n\t//// degToRadFactor = Math.PI/180.0;\n\t\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat equatorialRadius = 6378137.0;\n\n\tfloat X = posWC.x;\n\tfloat Y = posWC.y;\n\tfloat Z = posWC.z;\n\n\tfloat XXpYY = X * X + Y * Y;\n\tfloat sqrtXXpYY = sqrt(XXpYY);\n\tfloat a = equatorialRadius;\n\tfloat ra2 = 1.0 / (a * a);\n\tfloat e2 = firstEccentricitySquared;\n\tfloat e4 = e2 * e2;\n\tfloat p = XXpYY * ra2;\n\tfloat q = Z * Z * (1.0 - e2) * ra2;\n\tfloat r = (p + q - e4) / 6.0;\n\tfloat h;\n\tfloat phi;\n\tfloat u;\n\tfloat evoluteBorderTest = 8.0 * r * r * r + e4 * p * q;\n\tfloat rad1;\n\tfloat rad2;\n\tfloat rad3;\n\tfloat atan_son;\n\tfloat v;\n\tfloat w;\n\tfloat k;\n\tfloat D;\n\tfloat sqrtDDpZZ;\n\tfloat e;\n\tfloat lambda;\n\tfloat s2;\n\n\t\n\n\tif (evoluteBorderTest > 0.0 || q != 0.0) \n\t{\n\t\tif (evoluteBorderTest > 0.0) \n\t\t{\n\t\t\t// Step 2: general case\n\t\t\trad1 = sqrt(evoluteBorderTest);\n\t\t\trad2 = sqrt(e4 * p * q);\n\n\t\t\t// 10*e2 is my arbitrary decision of what Vermeille means by "near... the cusps of the evolute".\n\t\t\tif (evoluteBorderTest > 10.0 * e2) \n\t\t\t{\n\t\t\t\trad3 = cbrt((rad1 + rad2) * (rad1 + rad2));\n\t\t\t\tu = r + 0.5 * rad3 + 2.0 * r * r / rad3;\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tu = r + 0.5 * cbrt((rad1 + rad2) * (rad1 + rad2))\n\t\t\t\t\t+ 0.5 * cbrt((rad1 - rad2) * (rad1 - rad2));\n\t\t\t}\n\t\t}\n\t\telse \n\t\t{\n\t\t\t// Step 3: near evolute\n\t\t\trad1 = sqrt(-evoluteBorderTest);\n\t\t\trad2 = sqrt(-8.0 * r * r * r);\n\t\t\trad3 = sqrt(e4 * p * q);\n\t\t\tatan_son = 2.0 * atan2(rad3, rad1 + rad2) / 3.0;\n\n\t\t\tu = -4.0 * r * sin(atan_son) * cos(M_PI / 6.0 + atan_son);\n\t\t}\n\n\t\tv = sqrt(u * u + e4 * q);\n\t\tw = e2 * (u + v - q) / (2.0 * v);\n\t\tk = (u + v) / (sqrt(w * w + u + v) + w);\n\t\tD = k * sqrtXXpYY / (k + e2);\n\t\tfloat D_scaled = D/10000.0;\n\t\tfloat Z_scaled = Z/10000.0;\n\t\tsqrtDDpZZ = sqrt(D_scaled * D_scaled + Z_scaled * Z_scaled) * 10000.0; // more precision.\n\t\t//sqrtDDpZZ = sqrt(D * D + Z * Z);\n\n\t\th = (k + e2 - 1.0) * sqrtDDpZZ / k;\n\t\tphi = 2.0 * atan2(Z, (sqrtDDpZZ + D));\n\t\t\n\t}\n\telse \n\t{\n\t\t// Step 4: singular disk\n\t\trad1 = sqrt(1.0 - e2);\n\t\trad2 = sqrt(e2 - p);\n\t\te = sqrt(e2);\n\n\t\th = -a * rad1 * rad2 / e;\n\t\tphi = rad2 / (e * rad2 + rad1 * sqrt(p));\n\t}\n\n\n\t// Compute lambda\n\ts2 = sqrt(2.0);\n\tif ((s2 - 1.0) * Y < sqrtXXpYY + X) \n\t{\n\t\t// case 1 - -135deg < lambda < 135deg\n\t\tlambda = 2.0 * atan2(Y, sqrtXXpYY + X);\n\t}\n\telse if (sqrtXXpYY + Y < (s2 + 1.0) * X) \n\t{\n\t\t// case 2 - -225deg < lambda < 45deg\n\t\tlambda = -M_PI * 0.5 + 2.0 * atan2(X, sqrtXXpYY - Y);\n\t}\n\telse \n\t{\n\t\t// if (sqrtXXpYY-Y<(s2=1)*X) {  // is the test, if needed, but it\'s not\n\t\t// case 3: - -45deg < lambda < 225deg\n\t\tlambda = M_PI * 0.5 - 2.0 * atan2(X, sqrtXXpYY + Y);\n\t}\n\n\tfloat factor = 180.0 / M_PI;\n\tgeoCoord = vec3(factor * lambda, factor * phi, h);\n\n\treturn geoCoord;\n}\n\nfloat rand(vec2 co){\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nbool aproxEqual(float valA, float valB, float error)\n{\n\tbool areEquals = false;\n\n\tif(abs(valA - valB) < error)\n\t{\n\t\tareEquals = true;\n\t}\n\telse{\n\t\tareEquals = false;\n\t}\n\n\treturn areEquals;\n}\n  \nvoid main()\n{\t\n\t// Function for overWrite waterSystem DEM texture.\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz; // - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz; // - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0); // world position.\n\n\tfloat inoutAux = 0.0;\n\tvec3 geoCoord = CartesianToGeographicWgs84(pos4.xyz, inoutAux);\n\n\t////gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tgl_Position = modelViewProjectionMatrix * vec4(geoCoord, 1.0);\n\tgl_PointSize = 2.0;\n\n\tvDepth = gl_Position.z * 0.5 + 0.5;\n\tglPos = gl_Position;\n\tvAltitude = geoCoord.z;\n\tvColor4 = u_color4; // used for "waterCalculateHeightContaminationFS".***\n\n}\n',PngImageFS:"precision highp float;\n\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nvarying vec2 v_texcoord;\nuniform bool textureFlipYAxis;\nuniform sampler2D u_texture;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform vec4 oneColor4;\n\n\nvarying vec2 imageSizeInPixels;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main()\n{\n    vec4 textureColor;\n\n\t// 1rst, check if the texture.w != 0.\n\tif(textureFlipYAxis)\n\t{\n\t\ttextureColor = texture2D(u_texture, vec2(v_texcoord.s, 1.0 - v_texcoord.t));\n\t}\n\telse\n\t{\n\t\ttextureColor = texture2D(u_texture, v_texcoord);\n\t}\n\t\n\tif(textureColor.w < 0.5)\n\t{\n\t\t//discard;\n\t}\n\n\n\tif(colorType == 2)\n\t{\n\t\t// do nothing.\n\t}\n\telse if( colorType == 0)\n\t{\n\t\ttextureColor = oneColor4;\n\t}\n\n    //gl_FragColor = textureColor;\n\tgl_FragData[0] = textureColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\t//gl_FragData[1] = packDepth(vDepth);\n\t\tgl_FragData[1] = packDepth(0.0);\n\t\t\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.005; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\t//if(uFrustumIdx == 0)\n\t\t//frustumIdx = 0.005; // frustumIdx = 20.***\n\t\t//else if(uFrustumIdx == 1)\n\t\t//frustumIdx = 0.015; // frustumIdx = 21.***\n\t\t//else if(uFrustumIdx == 2)\n\t\t//frustumIdx = 0.025; // frustumIdx = 22.***\n\t\t//else if(uFrustumIdx == 3)\n\t\t//frustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = textureColor; \n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t//}\n\t#endif\n}",PngImageVS:"attribute vec4 position;\nattribute vec2 texCoord;\nuniform mat4 buildingRotMatrix;\nuniform mat4 modelViewMatrixRelToEye;  \nuniform mat4 ModelViewProjectionMatrixRelToEye;  \nuniform mat4 projectionMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec2 scale2d;\nuniform vec2 size2d;\nuniform vec3 aditionalOffset;\nuniform vec2 imageSize;\nuniform float screenWidth;    \nuniform float screenHeight;\nuniform bool bUseOriginalImageSize;\nvarying vec2 v_texcoord;\nvarying vec2 imageSizeInPixels;\n\nvoid main()\n{\n    vec4 position2 = vec4(position.xyz, 1.0);\n    vec4 rotatedPos = buildingRotMatrix * vec4(position2.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t//imageSizeInPixels = vec2(imageSize.x, imageSize.y);\n\t\n\tfloat order_w = position.w;\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n    v_texcoord = texCoord;\n\tvec4 projected = ModelViewProjectionMatrixRelToEye * pos4;\n\t//vec4 projected2 = modelViewMatrixRelToEye * pos4;\n\n\t// Now, calculate the pixelSize in the plane of the projected point.\n\tfloat pixelWidthRatio = 2. / ((screenWidth));// * projectionMatrix[0][0]);\n\t// alternative : float pixelWidthRatio = 2. / (screenHeight * projectionMatrix[1][1]);\n\tfloat pixelWidth = projected.w * pixelWidthRatio;\n\n\t//float pixelHeightRatio = pixelWidthRatio * (screenHeight/screenWidth); // no works correctly.\n\tfloat pixelHeightRatio = 2. / ((screenHeight));\n\tfloat pixelHeight = projected.w * pixelHeightRatio;\n\t\n\tif(projected.w < 5.0)\n\t\tpixelWidth = 5.0 * pixelWidthRatio;\n\n\t//pixelHeight = pixelWidth;\n\t\n\tvec4 offset;\n\tfloat offsetX;\n\tfloat offsetY;\n\tif(bUseOriginalImageSize)\n\t{\n\t\toffsetX = pixelWidth*imageSize.x/2.0;\n\t\toffsetY = pixelHeight*imageSize.y/2.0;\n\t}\n\telse{\n\t\toffsetX = pixelWidth*size2d.x/2.0;\n\t\toffsetY = pixelHeight*size2d.y/2.0;\n\t}\n\t\n\t// Offset our position along the normal\n\tif(orderInt == 1)\n\t{\n\t\toffset = vec4(-offsetX*scale2d.x, 0.0, 0.0, 1.0);\n\t}\n\telse if(orderInt == -1)\n\t{\n\t\toffset = vec4(offsetX*scale2d.x, 0.0, 0.0, 1.0);\n\t}\n\telse if(orderInt == 2)\n\t{\n\t\toffset = vec4(-offsetX*scale2d.x, offsetY*2.0*scale2d.y, 0.0, 1.0);\n\t}\n\telse if(orderInt == -2)\n\t{\n\t\toffset = vec4(offsetX*scale2d.x, offsetY*2.0*scale2d.y, 0.0, 1.0);\n\t}\n\n\tgl_Position = projected + offset + vec4(aditionalOffset.x*pixelWidth, aditionalOffset.y*pixelWidth, aditionalOffset.z*pixelWidth, 0.0); \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",PointCloudFS:"precision lowp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform vec4 uStrokeColor;\nvarying vec4 vColor;\nvarying float glPointSize;\nuniform int uPointAppereance; // square, circle, romboide,...\nuniform int uStrokeSize;\nuniform bool bUseLogarithmicDepth;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvoid main()\n{\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tfloat distSquared = pt.x*pt.x+pt.y*pt.y;\n\tif(distSquared > 0.25)\n\t\tdiscard;\n\n\tvec4 finalColor = vColor;\n\tfloat strokeDist = 0.1;\n\tif(glPointSize > 10.0)\n\tstrokeDist = 0.15;\n\n\tif(uStrokeSize > 0)\n\t{\n\t\tif(distSquared >= strokeDist)\n\t\t{\n\t\t\tfinalColor = uStrokeColor;\n\t\t}\n\t}\n\tgl_FragData[0] = finalColor;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",PointCloudSsaoFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D normalTex;\nuniform mat4 projectionMatrix;\nuniform float tangentOfHalfFovy;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nvarying vec4 aColor4; // color from attributes\n\nvarying vec4 vColor;\nvarying float glPointSize;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nuniform bool bUseLogarithmicDepth;\nuniform vec2 uNearFarArray[4];\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float depth;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main()\n{\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tif(pt.x*pt.x+pt.y*pt.y > 0.25)\n\t{\n\t\tdiscard;\n\t}\n\t\n\tfloat occlusion = 1.0;\n\tfloat lighting = 0.0;\n\tbool testBool = false;\n\tvec4 colorAux = vec4(1.0, 1.0, 1.0, 1.0);\n\n\tif(lighting < 0.5)\n\tlighting = 0.0;\n\n\t//vec3 fogColor = vec3(1.0, 1.0, 1.0);\n\tvec3 fogColor = vec3(0.0, 0.0, 0.0);\n\tvec3 finalFogColor = mix(vColor.xyz, fogColor, 0.0);\n\n    vec4 finalColor;\n\tfinalColor = vec4(finalFogColor * occlusion, externalAlpha);\n\n    gl_FragData[0] = finalColor; // original.***\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\t//if(!bUseLogarithmicDepth)\n\t\t//{\n\t\t\tgl_FragData[1] = packDepth(depth);\n\t\t//}\n\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.205; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.215; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.225; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.235; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = vColor; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\t}\n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n\n}",PointCloudSsaoFS_rainbow:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform mat4 projectionMatrix;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;    \nuniform vec3 kernel[16];   \nuniform vec4 oneColor4;\nuniform bool bUseColorCodingByHeight;\nuniform float minHeight_rainbow;   \nuniform float maxHeight_rainbow;  \nvarying vec4 aColor4; // color from attributes\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float realHeigh;\n\nconst int kernelSize = 16;  \nuniform float radius;      \n\nuniform bool bApplySsao;\nuniform float externalAlpha;\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}                \n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n    return unpackDepth(texture2D(depthTex, coord.xy));\n}  \n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n}   \n\nvoid main()\n{\n\tfloat occlusion = 0.0;\n\tif(bApplySsao)\n\t{          \n\t\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t\tfloat linearDepth = getDepth(screenPos);\n\t\tvec3 origin = getViewRay(screenPos) * linearDepth;\n\t\tfloat radiusAux = glPointSize/1.9;\n\t\tradiusAux = 1.5;\n\t\tvec2 screenPosAdjacent;\n\t\t\n\t\tfor(int j = 0; j < 1; ++j)\n\t\t{\n\t\t\tradiusAux = 1.5 *(float(j)+1.0);\n\t\t\tfor(int i = 0; i < 8; ++i)\n\t\t\t{    \t \n\t\t\t\tif(i == 0)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 1)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 2)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n\t\t\t\telse if(i == 3)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\telse if(i == 4)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 5)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 6)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n\t\t\t\telse if(i == 7)\n\t\t\t\t\tscreenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\t\t\t\tfloat depthBufferValue = getDepth(screenPosAdjacent);\n\t\t\t\tfloat range_check = abs(linearDepth - depthBufferValue)*far;\n\t\t\t\tif (range_check > 1.5 && depthBufferValue > linearDepth)\n\t\t\t\t{\n\t\t\t\t\tif (range_check < 20.0)\n\t\t\t\t\t\tocclusion +=  1.0;\n\t\t\t\t}\n\t\t\t}   \n\t\t}   \n\t\t\t\n\t\tif(occlusion > 6.0)\n\t\t\tocclusion = 8.0;\n\t\t//else occlusion = 0.0;\n\t\tocclusion = 1.0 - occlusion / 8.0;\n\t}\n\telse{\n\t\tocclusion = 1.0;\n\t}\n\n    vec4 finalColor;\n\tif(bUseColorCodingByHeight)\n\t{\n\t\tfloat rainbow = 0.5;\n\t\tfloat texCol = 0.5;\n\t\tvec3 rainbowColor3 = getRainbowColor_byHeight(realHeigh);\n\t\tvec3 blendedColor3 = vec3(vColor.x * texCol + rainbowColor3.r * rainbow, vColor.y * texCol + rainbowColor3.g * rainbow, vColor.z * texCol + rainbowColor3.b * rainbow);\n\t\tfinalColor = vec4(blendedColor3 * occlusion, externalAlpha);\n\t}\n\telse\n\t\tfinalColor = vec4((vColor.xyz) * occlusion, externalAlpha);\n\t//finalColor = vec4(vec3(0.8, 0.8, 0.8) * occlusion, externalAlpha);\n    gl_FragColor = finalColor; \n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n",PointCloudVS:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nuniform bool bUseColorCodingByHeight;\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float depth;\n\nuniform float uFCoef_logDepth;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\t//float maxShort = 65535.0;\n\t\t//maxShort = 1.0;\n\t\t//realPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t\trealPos = vec3(position.x * bboxSize.x + minPosition.x, position.y * bboxSize.y + minPosition.y, position.z * bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor = oneColor4;\n\t}\n\telse\n\t\tvColor = color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tdepth = -(modelViewMatrixRelToEye * pos).z/far; // original.***\n\n\tif(bUseFixPointSize)\n\t{\n\t\tgl_PointSize = fixPointSize;\n\t}\n\telse{\n\t\tfloat z_b = gl_Position.z/gl_Position.w;\n\t\tfloat z_n = 2.0 * z_b - 1.0;\n\t\tfloat z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n\t\tgl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n\t\tif(gl_PointSize > maxPointSize)\n\t\t\tgl_PointSize = maxPointSize;\n\t\tif(gl_PointSize < 2.0)\n\t\t\tgl_PointSize = 2.0;\n\t}\n\tglPointSize = gl_PointSize;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}",PointCloudVS_rainbow:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform mat4 buildingRotMatrix;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform bool bPositionCompressed;\nuniform vec3 minPosition;\nuniform vec3 bboxSize;\nuniform bool bUse1Color;\nuniform vec4 oneColor4;\nuniform float fixPointSize;\nuniform float maxPointSize;\nuniform float minPointSize;\nuniform float pendentPointSize;\nuniform bool bUseFixPointSize;\nvarying vec4 vColor;\nvarying float glPointSize;\nvarying float realHeigh;\n\nvoid main()\n{\n\tvec3 realPos;\n\tvec4 rotatedPos;\n\tif(bPositionCompressed)\n\t{\n\t\t//float maxShort = 65535.0;\n\t\t//maxShort = 1.0;\n\t\t//realPos = vec3(float(position.x)/maxShort*bboxSize.x + minPosition.x, float(position.y)/maxShort*bboxSize.y + minPosition.y, float(position.z)/maxShort*bboxSize.z + minPosition.z);\n\t\trealPos = vec3(position.x * bboxSize.x + minPosition.x, position.y * bboxSize.y + minPosition.y, position.z * bboxSize.z + minPosition.z);\n\t}\n\telse\n\t{\n\t\trealPos = position;\n\t}\n\trealHeigh = realPos.z;\n\trotatedPos = buildingRotMatrix * vec4(realPos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    if(bUse1Color)\n\t{\n\t\tvColor=oneColor4;\n\t}\n\telse\n\t\tvColor=color4;\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n\tfloat z_b = gl_Position.z/gl_Position.w;\n\tfloat z_n = 2.0 * z_b - 1.0;\n    float z_e = 2.0 * near * far / (far + near - z_n * (far - near));\n    gl_PointSize = minPointSize + pendentPointSize/z_e; // Original.***\n    if(gl_PointSize > maxPointSize)\n        gl_PointSize = maxPointSize;\n    if(gl_PointSize < 2.0)\n        gl_PointSize = 2.0;\n        \n    glPointSize = gl_PointSize;\n}\n",PollutionFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D texture_0; \nuniform sampler2D texture_1;\n\nuniform bool textureFlipYAxis;\n\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \n//uniform float screenWidth;    \n//uniform float screenHeight;     \nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform float externalAlpha; // used by effects.\nuniform bool bUseLogarithmicDepth;\n\nuniform int uFrustumIdx;\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nuniform float uInterpolationFactor;\nuniform vec2 uMinMaxQuantizedValues_tex0;\nuniform vec2 uMinMaxQuantizedValues_tex1;\nuniform vec2 uMinMaxValues;\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \n\nvarying float vDepth;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec4 packDepth( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n\treturn enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depthAux = dot(rgba_depth, bit_shift);\n    return depthAux;\n}  \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\n/*\n// unpack depth used for shadow on screen.***\nfloat unpackDepth_A(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n*/\n\nfloat UnpackDepth32( in vec4 pack )\n{\n\tfloat depth = dot( pack, vec4(1.0, 0.00390625, 0.000015258789, 0.000000059605) );\n    return depth * 1.000000059605;// 1.000000059605 = (16777216.0) / (16777216.0 - 1.0);\n}             \n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n\n\n/*\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/screenWidth;\n    float pixelSizeY = 1.0/screenHeight;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<1.0; i++)\n\t{\n\t\tdepthA += getDepth(texCoord + offset1*(1.0+i));\n\t\tdepthB += getDepth(texCoord + offset2*(1.0+i));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*1.0, depthA/1.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*1.0, depthB/1.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n\nmat3 sx = mat3( \n    1.0, 2.0, 1.0, \n    0.0, 0.0, 0.0, \n    -1.0, -2.0, -1.0 \n);\nmat3 sy = mat3( \n    1.0, 0.0, -1.0, \n    2.0, 0.0, -2.0, \n    1.0, 0.0, -1.0 \n);\n\nbool isEdge()\n{\n\tvec3 I[3];\n\tvec2 screenPos = vec2((gl_FragCoord.x) / screenWidth, (gl_FragCoord.y) / screenHeight);\n\tfloat linearDepth = getDepth(screenPos);\n\tvec3 normal = normal_from_depth(linearDepth, screenPos);\n\n    for (int i=0; i<3; i++) {\n        //vec3 norm1 = texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,-1), 0 ).rgb * 2.0f - 1.0f;\n        //vec3 norm2 =  texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,0), 0 ).rgb * 2.0f - 1.0f;\n        //vec3 norm3 = texelFetch(normalTexture, ivec2(gl_FragCoord) + ivec2(i-1,1), 0 ).rgb * 2.0f - 1.0f;\n\t\tvec2 screenPos1 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y-1.0) / screenHeight);\n\t\tfloat linearDepth1 = getDepth(screenPos1);  \n\n\t\tvec2 screenPos2 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y-0.0) / screenHeight);\n\t\tfloat linearDepth2 = getDepth(screenPos2);  \n\n\t\tvec2 screenPos3 = vec2((gl_FragCoord.x+float(i-1)) / screenWidth, (gl_FragCoord.y+1.0) / screenHeight);\n\t\tfloat linearDepth3 = getDepth(screenPos1);  \n\n\t\tvec3 norm1 = normal_from_depth(linearDepth1, screenPos1);\n        vec3 norm2 =  normal_from_depth(linearDepth2, screenPos2);\n        vec3 norm3 = normal_from_depth(linearDepth3, screenPos3);\n        float sampleValLeft  = dot(normal, norm1);\n        float sampleValMiddle  = dot(normal, norm2);\n        float sampleValRight  = dot(normal, norm3);\n        I[i] = vec3(sampleValLeft, sampleValMiddle, sampleValRight);\n    }\n\n    float gx = dot(sx[0], I[0]) + dot(sx[1], I[1]) + dot(sx[2], I[2]); \n    float gy = dot(sy[0], I[0]) + dot(sy[1], I[1]) + dot(sy[2], I[2]);\n\n    if((gx < 0.0 && gy < 0.0) || (gy < 0.0 && gx < 0.0) ) \n        return false;\n\tfloat g = sqrt(pow(gx, 2.0)+pow(gy, 2.0));\n\n    if(g > 0.2) {\n        return true;\n    } \n\treturn false;\n}\n*/\n\nfloat unQuantize(float quantizedValue, float minVal, float maxVal)\n{\n\tfloat unquantizedValue = quantizedValue * (maxVal - minVal) + minVal;\n\treturn unquantizedValue;\n}\n\nvec4 getRainbowColor_byHeight(in float height, in float minHeight_rainbow, in float maxHeight_rainbow, bool hotToCold)\n{\n    \n    float gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 0.9999; }\n\telse if (gray<0.0){ gray = 0.0; }\n\n    float value = gray * 4.0;\n    float h = floor(value);\n    float f = fract(value);\n\n    vec4 resultColor = vec4(0.0, 0.0, 0.0, gray);\n\n    if(hotToCold)\n    {\n        // HOT to COLD.***\n        resultColor.rgb = vec3(1.0, 0.0, 0.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix red & yellow.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(red, yellow, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix yellow & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, green, f);\n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & cyan.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(green, cyan, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix cyan & blue.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, blue, f);\n        }\n    }\n    else\n    {\n        // COLD to HOT.***\n        resultColor.rgb = vec3(0.0, 0.0, 1.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix blue & cyan.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(blue, cyan, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix cyan & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, green, f);  \n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & yellow.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(green, yellow, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix yellow & red.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, red, f);\n        }\n    }\n\n    return resultColor;\n}\n\nvoid main()\n{\n\t//bool testBool = false;\n\t//float occlusion = 1.0; // ambient occlusion.***\n\t//vec3 normal2 = vNormal;\t\n\t//float scalarProd = 1.0;\n\t\n\t//vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t//float linearDepth = getDepth(screenPos);   \n\t//vec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t//occlusion = 1.0;\n\tvec4 textureColor;\n\tvec4 textureColor_0;\n\tvec4 textureColor_1;\n\n\tfloat realPollutionVal_0 = 0.0;\n\tfloat realPollutionVal_1 = 0.0;\n\n\tvec2 finalTexCoord = vTexCoord;\n\tif(textureFlipYAxis)\n\t{\n\t\tfinalTexCoord = vec2(vTexCoord.s, 1.0 - vTexCoord.t);\n\t}\n\n    if(colorType == 2)\n    {\n        textureColor_0 = texture2D(texture_0, finalTexCoord);\n\t\ttextureColor_1 = texture2D(texture_1, finalTexCoord);\n\n\t\tfloat quantized_0 = UnpackDepth32(textureColor_0);\n\t\tfloat quantized_1 = UnpackDepth32(textureColor_1);\n\n\t\trealPollutionVal_0 = unQuantize(quantized_0, uMinMaxQuantizedValues_tex0.x, uMinMaxQuantizedValues_tex0.y);\n\t\trealPollutionVal_1 = unQuantize(quantized_1, uMinMaxQuantizedValues_tex1.x, uMinMaxQuantizedValues_tex1.y);\n\n\t\t//textureColor = mix(textureColor_0, textureColor_1, uInterpolationFactor); // no.***\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = vColor4;\n    }\n\t\n    vec4 finalColor;\n\tfloat realPollutionValue = mix(realPollutionVal_0, realPollutionVal_1, uInterpolationFactor);\n\tfloat realPollutionQuantized = (realPollutionValue - uMinMaxValues.x) / (uMinMaxValues.y - uMinMaxValues.x);\n\tfloat pollutionValue = realPollutionQuantized;\n\n\tbool hotToCold = false;\n\tvec4 rainbowColor4 = getRainbowColor_byHeight(realPollutionQuantized, 0.0, 1.0, hotToCold);\n\t\n\t//vec4 intensity4 = vec4(1.0 - pollutionValue, 1.0 - pollutionValue, 1.0 - pollutionValue, pollutionValue * 10.0);\n\tvec4 intensity4 = vec4(pollutionValue, 1.0 - pollutionValue, pollutionValue, pollutionValue * 10.0);\n\t//vec4 pollutionColor = vec4(0.5, 1.0, 0.1, 1.0); // original green.***\n\tvec4 pollutionColor = vec4(rainbowColor4.rgb, 1.0);\n\tfinalColor = mix(intensity4, pollutionColor, pollutionValue);\n\n    // test.***\n    finalColor = vec4(rainbowColor4.rgb, rainbowColor4.a * 15.0);\n\n    if(finalTexCoord.x < 0.005 || finalTexCoord.x > 0.995 || finalTexCoord.y < 0.005 || finalTexCoord.y > 0.995) \n    {\n        finalColor = vec4(0.25, 0.5, 0.99, 0.6);\n    }\n\n    gl_FragData[0] = finalColor; \n\n\tvec4 albedo4 = finalColor;\n\n    \n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t{\n\t\t// save depth, normal, albedo.\n\t\tfloat depthAux = vDepth;\n\t\tgl_FragData[1] = packDepth(depthAux); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\t}\n\t#endif\n\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}',PollutionVS:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying vec3 vertexPosLC;\n\tvarying vec4 vColor4; // color from attributes\n\tvarying vec3 vLightDir; \n\tvarying vec3 vNormalWC; \n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\tvarying float vDepth;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(buildingRotMatrix);\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\t\n\t\t\n\t\tuAmbientColor = vec3(1.0);\n\t\tvNormalWC = rotatedNormal;\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\t\tvLightDir = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tfloat directionalLightWeighting = 1.0;\n\n\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting; // original.***\n\t\t\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\tvertexPos = orthoPos.xyz;\n\t\tvDepth = -orthoPos.z/far;\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\n\t\tgl_PointSize = 5.0;\n\t}",quadVertTexCoordVS:"//precision mediump float;\n\nattribute vec2 a_pos;\nattribute vec2 a_texcoord;\n\nvarying vec2 vTexCoord;\n\nvoid main() {\n    vTexCoord = a_texcoord;\n    gl_Position = vec4(-1.0 + 2.0 * a_pos, 0.0, 1.0);\n}",quad_vert:"precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}\n",rectangleScreenFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D texture_0;  \nuniform samplerCube texture_cube;\n\nuniform int uTextureType;\n\nvarying vec2 v_tex_pos;\nvarying vec3 v_normal; // use for cubeMap.\n\nint faceIndex(in vec2 texCoord)\n{\n    int faceIndex = -1;\n\n    float tx = texCoord.x;\n    float ty = texCoord.y;\n\n    if(tx >= 0.0 && tx < 0.25)\n    {\n        if(ty >= 0.0 && ty < 1.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n        else if(ty >= 1.0/3.0 && ty < 2.0/3.0)\n        {\n            faceIndex = 1;\n        }\n        else if(ty >= 2.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n    }\n    else if(tx >= 0.25 && tx < 0.5)\n    {\n        if(ty >= 0.0 && ty < 1.0/3.0)\n        {\n            faceIndex = 3;\n        }\n        else if(ty >= 1.0/3.0 && ty < 2.0/3.0)\n        {\n            faceIndex = 4;\n        }\n        else if(ty >= 2.0/3.0)\n        {\n            faceIndex = 2;\n        }\n    }\n    else if(tx >= 0.5 && tx < 0.75)\n    {\n        if(ty >= 0.0 && ty < 1.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n        else if(ty >= 1.0/3.0 && ty < 2.0/3.0)\n        {\n            faceIndex = 0;\n        }\n        else if(ty >= 2.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n    }\n    else if(tx >= 0.75)\n    {\n        if(ty >= 0.0 && ty < 1.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n        else if(ty >= 1.0/3.0 && ty < 2.0/3.0)\n        {\n            faceIndex = 5;\n        }\n        else if(ty >= 2.0/3.0)\n        {\n            // is no cubeMap zone.\n        }\n    }\n\n    return faceIndex;\n}\n\nbool cubeMapNormal(in vec2 texCoord, inout vec3 normal)\n{\n    int faceIdx = faceIndex(texCoord);\n\n    if(faceIdx == -1)\n    {\n        return false;\n    }\n\n    bool isCubeMapZone = true;\n\n    // convert range 0 to 1 to -1 to 1\n    float uc = 2.0 * texCoord.x - 1.0;\n    float vc = 2.0 * texCoord.y - 1.0;\n    float x, y, z;\n\n    if(faceIdx == 0)\n    { \n        x =  1.0; \n        y =   vc; \n        z =  -uc; // POSITIVE X\n    }\n    else if(faceIdx == 1)\n    {\n        x = -1.0; \n        y =   vc; \n        z =   uc; // NEGATIVE X\n    }\n    else if(faceIdx == 2)\n    {\n        x =   uc; \n        y =  1.0; \n        z =  -vc; // POSITIVE Y\n    }\n    else if(faceIdx == 3)\n    {\n        x =   uc; \n        y = -1.0; \n        z =   vc; // NEGATIVE Y\n    }\n    else if(faceIdx == 4)\n    {\n        x =   uc; \n        y =   vc; \n        z =  1.0; // POSITIVE Z\n    }\n    else if(faceIdx == 5)\n    {\n        x =  -uc; \n        y =   vc; \n        z = -1.0; // NEGATIVE Z\n    }\n    \n    normal = vec3(x, y, z);\n    return isCubeMapZone;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvec3 decodeVelocity(in vec3 encodedVel)\n{\n\treturn vec3(encodedVel * 2.0 - 1.0);\n}\n\nvoid main()\n{           \n    vec2 texCoord = vec2(1.0 - v_tex_pos.x, 1.0 - v_tex_pos.y); // original.\n\n    // Take the base color.\n    vec4 textureColor = vec4(1.0,1.0,1.0, 0.0);\n    if(uTextureType == 0)\n    {\n        textureColor = texture2D(texture_0, texCoord);\n\n        // Test debug:\n        //if(textureColor.r > 0.0 || textureColor.g > 0.0)\n        //{\n        //    textureColor = vec4(1.0, 1.0, 0.5, 1.0);\n        //}\n    }\n    else if(uTextureType == 1)\n    {\n        // CUBE_TEXTURE.***\n        // To see the value of 4byte encoded color4.***\n        textureColor = textureCube(texture_cube, v_normal);\n        float linearDepth = unpackDepth(textureColor); // original.\n        textureColor = vec4(linearDepth, linearDepth, linearDepth, 1.0);\n    }\n    else if(uTextureType == 2)\n    {\n        // To see only alpha component.***\n        vec4 textureColorAux = texture2D(texture_0, texCoord);\n        textureColor = vec4(textureColorAux.a, 0.0, 0.0, textureColorAux.a);\n    }\n    else if(uTextureType == 3)\n    {\n        // Test debug:\n        vec4 textureColorAux = texture2D(texture_0, texCoord);\n        if(textureColorAux.r + textureColorAux.g + textureColorAux.b > 0.0)\n        {\n            textureColor = vec4(0.2, 0.5, 1.0, 1.0);\n        }\n        else\n        {\n            textureColor = textureColorAux;\n        }\n    }\n    else if(uTextureType == 4)\n    {\n        // To see the value of 4byte encoded color4.***\n        textureColor = texture2D(texture_0, texCoord);\n        float linearDepth = unpackDepth(textureColor); // original.\n        textureColor = vec4(linearDepth, linearDepth, linearDepth, 1.0);\n    }\n    else if(uTextureType == 5)\n    {\n        // To see velocity.***\n        textureColor = texture2D(texture_0, texCoord);\n        vec3 vel = decodeVelocity(textureColor.rgb);\n        vec3 normalizedVel = normalize(vel);\n        textureColor = vec4(normalizedVel.rgb, 1.0);\n    }\n    \n    gl_FragColor = textureColor;\n\t\n}",rectangleScreenMosaicFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D texture_0;  // HIGH_A\nuniform sampler2D texture_1;  // LOW_A\nuniform sampler2D texture_2;  // HIGH_B\nuniform sampler2D texture_3;  // LOW_B\n\nuniform int uTextureType;\nuniform int uSliceIdx; // the slice idx that to be render.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform float u_maxFlux;\n\nvarying vec2 v_tex_pos;\nvarying vec3 v_normal; // use for cubeMap.\n\n\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvec3 decodeVelocity(in vec3 encodedVel)\n{\n\treturn vec3(encodedVel * 2.0 - 1.0);\n}\n\nvec2 getColRow_ofSliceIdx(in int sliceIdx, in int mosaicColsCount)\n{\n    // Given a sliceIdx, mosaicColumnsCount & mosaicRowsCount, this function returns the column & row of the sliceIdx.***\n    float row = floor(float(sliceIdx)/float(mosaicColsCount));\n    //float col = mod(float(sliceIdx), float(mosaicColsCount)); // mod = float(sliceIdx) - float(mosaicColsCount) * row;\n    float col = float(sliceIdx) - float(mosaicColsCount) * row;\n    vec2 colRow = vec2(col, row);\n    return colRow;\n}\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col, in int row, in int mosaicNumCols, in int mosaicNumRows)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(mosaicNumCols);\n    float tRange = 1.0 / float(mosaicNumRows);\n\n    float s = float(col) * sRange + subTexCoord.x * sRange;\n    float t = float(row) * tRange + subTexCoord.y * tRange;\n\n    vec2 resultTexCoord = vec2(s, t);\n    return resultTexCoord;\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvoid getFlux(in vec2 texCoord, inout vec3 flux_RFU, inout vec3 flux_LBD)\n{\n    // This function returns Outing flux.***\n    vec4 color4_RFU_HIGH = texture2D(texture_0, texCoord);\n    vec4 color4_RFU_LOW = texture2D(texture_1, texCoord);\n    vec4 color4_LBD_HIGH = texture2D(texture_2, texCoord);\n    vec4 color4_LBD_LOW = texture2D(texture_3, texCoord);\n\n    // now, decode all fluxes.***\n    flux_RFU.r = decodeRG(vec2(color4_RFU_HIGH.r, color4_RFU_LOW.r)) * u_maxFlux; // flux_R.\n    flux_RFU.g = decodeRG(vec2(color4_RFU_HIGH.g, color4_RFU_LOW.g)) * u_maxFlux; // flux_F.\n    flux_RFU.b = decodeRG(vec2(color4_RFU_HIGH.b, color4_RFU_LOW.b)) * u_maxFlux; // flux_U.\n\n    flux_LBD.r = decodeRG(vec2(color4_LBD_HIGH.r, color4_LBD_LOW.r)) * u_maxFlux; // flux_L.\n    flux_LBD.g = decodeRG(vec2(color4_LBD_HIGH.g, color4_LBD_LOW.g)) * u_maxFlux; // flux_B.\n    flux_LBD.b = decodeRG(vec2(color4_LBD_HIGH.b, color4_LBD_LOW.b)) * u_maxFlux; // flux_D.\n}\n\nvoid main()\n{           \n    vec2 texCoord = vec2(1.0 - v_tex_pos.x, 1.0 - v_tex_pos.y); // original.\n\n    // now, find the col & row of the mosaic.***\n    vec2 colRow = getColRow_ofSliceIdx(uSliceIdx, u_mosaicSize[0]);\n    int col = int(colRow.x);\n    int row = int(colRow.y);\n\n\n    // now, calculate the texCoord of the mosaic.***\n    vec2 texCoordMosaic = subTexCoord_to_texCoord(texCoord, col, row, u_mosaicSize[0], u_mosaicSize[1]);\n\n    // reassign the texCoord.***\n    texCoord = vec2(texCoordMosaic.x, texCoordMosaic.y);\n\n    // Take the base color.\n    vec4 textureColor = vec4(1.0, 1.0, 1.0, 0.0);\n    if(uTextureType == 0)\n    {\n        textureColor = texture2D(texture_0, texCoord);\n    }\n    else if(uTextureType == 1)\n    {\n        // Encoded in 2 textures.***\n        vec3 flux_RFU;\n        vec3 flux_LBD;\n        getFlux(texCoord, flux_RFU, flux_LBD);\n\n        // Now, calculate the total flux for each axis.***\n        //textureColor = vec4(flux_RFU.x - flux_LBD.x, flux_RFU.y - flux_LBD.y, flux_RFU.z - flux_LBD.z, 1.0);\n        //textureColor = vec4(flux_RFU, 1.0);\n        textureColor = vec4(flux_LBD, 1.0);\n\n    }\n    else if(uTextureType == 2)\n    {\n        // To see only alpha component.***\n        vec4 textureColorAux = texture2D(texture_0, texCoord);\n        textureColor = vec4(textureColorAux.a, 0.0, 0.0, textureColorAux.a);\n    }\n    else if(uTextureType == 3)\n    {\n        // Test debug:\n        vec4 textureColorAux = texture2D(texture_0, texCoord);\n        if(textureColorAux.r + textureColorAux.g + textureColorAux.b > 0.0)\n        {\n            textureColor = vec4(0.2, 0.5, 1.0, 1.0);\n        }\n        else\n        {\n            textureColor = textureColorAux;\n        }\n    }\n    else if(uTextureType == 4)\n    {\n        // To see the value of 4byte encoded color4.***\n        textureColor = texture2D(texture_0, texCoord);\n        float linearDepth = unpackDepth(textureColor); // original.\n        textureColor = vec4(linearDepth, linearDepth, linearDepth, 1.0);\n    }\n    else if(uTextureType == 5)\n    {\n        // To see velocity.***\n        textureColor = texture2D(texture_0, texCoord);\n        vec3 vel = decodeVelocity(textureColor.rgb);\n        //float speed = length(vel); // test\n        vec3 normalizedVel = normalize(vel.rgb);\n        textureColor = vec4(normalizedVel.rgb, 1.0);\n        //textureColor = vec4(speed, speed, speed, 1.0); // test\n    }\n    else if(uTextureType == 6)\n    {\n        // To see normalized.***\n        textureColor = texture2D(texture_0, texCoord);\n        vec3 normalizedVel = normalize(textureColor.rgb);\n        textureColor = vec4(normalizedVel.rgb, 1.0);\n    }\n    \n    gl_FragColor = textureColor;\n\t\n}',rectangleScreenVS:"precision mediump float;\n\nattribute vec2 a_pos;\nattribute vec3 a_nor;\nattribute vec2 a_tex;\n\nvarying vec2 v_tex_pos;\nvarying vec3 v_normal;\n\nvoid main() {\n    v_tex_pos = a_tex;\n    v_normal = a_nor;\n    \n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}",RenderShowDepthFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D diffuseTex; // used only if texture is PNG, that has pixels with alpha = 0.0.***\nuniform bool bHasTexture; // indicates if texture is PNG, that has pixels with alpha = 0.0.***\nvarying vec2 vTexCoord; // used only if texture is PNG, that has pixels with alpha = 0.0.***\nuniform bool textureFlipYAxis;\n\nuniform float near;\nuniform float far;\n\n// clipping planes.***\nuniform bool bApplyClippingPlanes;\nuniform int clippingPlanesCount;\nuniform vec4 clippingPlanes[6];\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\n\nvarying float depth;  \nvarying vec3 vertexPos;\nvarying vec3 vNormal;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vFrustumIdx;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nbool clipVertexByPlane(in vec4 plane, in vec3 point)\n{\n\tfloat dist = plane.x * point.x + plane.y * point.y + plane.z * point.z + plane.w;\n\t\n\tif(dist < 0.0)\n\treturn true;\n\telse return false;\n}\n\nvoid main()\n{     \n\t// 1rst, check if there are clipping planes.\n\tif(bApplyClippingPlanes)\n\t{\n\t\tbool discardFrag = true;\n\t\tfor(int i=0; i<6; i++)\n\t\t{\n\t\t\tvec4 plane = clippingPlanes[i];\n\t\t\tif(!clipVertexByPlane(plane, vertexPos))\n\t\t\t{\n\t\t\t\tdiscardFrag = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(i >= clippingPlanesCount)\n\t\t\tbreak;\n\t\t}\n\t\t\n\t\tif(discardFrag)\n\t\tdiscard;\n\t}\n\n\t// check if is a pixel with alpha zero.***\n\tif(bHasTexture)\n\t{\n\t\tvec4 textureColor;\n\t\tif(textureFlipYAxis)\n        {\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\t\tif(textureColor.a < 0.4)\n\t\tdiscard;\n\t}\n\t\n\n\tif(!bUseLogarithmicDepth)\n\t{\n\t\tgl_FragData[0] = packDepth(depth); \n\t}\n\n\tfloat frustumIdx = 1.0;\n\tif(uFrustumIdx == 0)\n\tfrustumIdx = 0.005;\n\telse if(uFrustumIdx == 1)\n\tfrustumIdx = 0.015;\n\telse if(uFrustumIdx == 2)\n\tfrustumIdx = 0.025;\n\telse if(uFrustumIdx == 3)\n\tfrustumIdx = 0.035;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tvec3 normal = vNormal;\n\t\tif(normal.z < 0.0)\n\t\tnormal *= -1.0;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[1] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t}\n\t#endif\n\t\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tgl_FragData[0] = packDepth(gl_FragDepthEXT);\n\t}\n\t#endif\n}",RenderShowDepthVS:'attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\n\nuniform mat4 buildingRotMatrix; \n//uniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 RefTransfMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 scaleLC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nuniform bool bHasTexture; // indicates if texture is PNG, that has pixels with alpha = 0.0.***\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying float depth;\nvarying vec3 vertexPos;\nvarying vec2 vTexCoord; // used only if texture is PNG, that has pixels with alpha = 0.0.***\nvarying vec3 vNormal;\n  \nvoid main()\n{\t\n\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\tvec4 rotatedPos;\n\n\tmat3 currentTMat;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(buildingRotMatrix);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(RefTransfMatrix);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    \n    //linear depth in camera space (0..far)\n\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\tdepth = (-orthoPos.z)/(far); // the correct value.\n\t\n\t// Calculate normalCC.***\n\tvec3 rotatedNormal = currentTMat * normal;\n\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\n\t// When render with cull_face disabled, must correct the faces normal.\n\t//if(vNormal.z < 0.0) // but, do this in fragment shader.\n\t//vNormal *= -1.0; // but, do this in fragment shader.\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//-----------------------------------------------------------------------------------\n\t\t//float C = 0.0001;\n\t\tflogz = 1.0 + gl_Position.z; // use "z" instead "w" for fast decoding.***\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n\n\tvertexPos = orthoPos.xyz;\n\n\tif(bHasTexture)\n\t{\n\t\tvTexCoord = texCoord;\n\t}\n}',ScreenCopyQuadFS:"\n\n#define M_PI 3.1415926535897932384626433832795\n\n#define %USE_GL_EXT_FRAGDEPTH%\n#ifdef USE_GL_EXT_FRAGDEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n//#ifdef GL_ES\n    precision highp float;\n//#endif\n\nuniform sampler2D depthTex; // 0\nuniform sampler2D normalTex; // 1\nuniform sampler2D albedoTex; // 2\n\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform mat4 projectionMatrixInv;\nuniform mat4 normalMatrix4;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float near;\nuniform float far; \n\nuniform float screenWidth;    \nuniform float screenHeight;  \nuniform int uFrustumIdx;\n\n// This shader is used only to copy depth, normal  or albedo of Cesium.***\n// A uniform to use if is NO MRT.***************************************************\n// If we are in NO MRT, then, must choose what type of texture we are going to copy:\nuniform int u_textureTypeToCopy; // 0 = depth. 1 = normal. 2 = color.\n//----------------------------------------------------------------------------------\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n} \n\nfloat getDepthFrom_ZWindow(float zWindow, vec2 screenPos, inout vec4 posWC)\n{\n\tfloat depth = 0.0;\n\n\t// https://stackoverflow.com/questions/11277501/how-to-recover-view-space-position-given-view-space-depth-value-and-ndc-xy\n\tfloat depthRange_near = 0.0;\n\tfloat depthRange_far = 1.0;\n\tfloat x_ndc = 2.0 * screenPos.x - 1.0;\n\tfloat y_ndc = 2.0 * screenPos.y - 1.0;\n\tfloat z_ndc = (2.0 * zWindow - depthRange_near - depthRange_far) / (depthRange_far - depthRange_near);\n\t// Note: NDC range = (-1,-1,-1) to (1,1,1).***\n\t\n\tvec4 viewPosH = projectionMatrixInv * vec4(x_ndc, y_ndc, z_ndc, 1.0);\n\tvec3 posCC = viewPosH.xyz/viewPosH.w;\n\tposWC = modelViewMatrixRelToEyeInv * vec4(posCC.xyz, 1.0) + vec4((encodedCameraPositionMCHigh + encodedCameraPositionMCLow).xyz, 1.0);\n\t//------------------------------------------------------------------------------------------------------------------------------\n\n\tdepth = -posCC.z/far;\n\n\treturn depth;\n}\n\nvoid main()\n{\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\n\t\tvec4 albedo = texture2D(albedoTex, screenPos.xy);\n\n\t\t// in this case, do not other process.\n\t\t// 1rst, calculate the pixelPosWC.\n\t\tvec4 depthColor4 = texture2D(depthTex, screenPos.xy);\n\t\tfloat z_window  = unpackDepth(depthColor4); // z_window  is [-1.0, 1.0] range depth, but only uses [0.0, 1.0] range.***\n\n\t\tvec4 posWC;\n\t\tfloat depth = getDepthFrom_ZWindow(z_window, screenPos, posWC);\n\n\t\t//if(z_window >= 1.0) {\n\t\t//\tdiscard;\n\t\t//}\n\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.105;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.115;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.125;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.135;\n\n\t\tbool bDiscard = false;\n\n\t\t//************************\n\t\t// z_window = 1.0 -> near\n\t\t// z_window = 0.0 -> far\n\t\t//------------------------\n\n\t\tif(z_window <= 0.0 && uFrustumIdx < 2) {\n\t\t\t// frustum =2 & 3 -> renders sky, so dont discard.\n\t\t\tdiscard;\n\t\t}\n\n\t\tgl_FragData[0] = packDepth(depth); // depth.\n\t\t\t\t\t\n\n\t\t//#ifdef USE_GL_EXT_FRAGDEPTH\n\t\t\t//gl_FragDepthEXT = z_window;\n\t\t//#endif\n\t\t\n\n\t\tif(z_window > 0.0)\n\t\t{\n\t\t\tvec4 normal4WC = vec4(normalize(posWC.xyz), 1.0);\n\t\t\tvec4 normal4 = normalMatrix4 * normal4WC;\n\t\t\tvec3 encodedNormal = encodeNormal(normal4.xyz);\n\t\t\tgl_FragData[1] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t\t}\n\t\telse\n\t\t{\n\t\t\tvec3 encodedNormal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\t\tgl_FragData[1] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t\t}\n\n\t\t// Now, save the albedo.\n\t\tgl_FragData[2] = albedo; // copy albedo.\n\t\t\n\n\t\n\t#else\n\t\t// We are in ORT (one rendering target).\n\t\tif(u_textureTypeToCopy == 0)\n\t\t{\n\t\t\t// Depth.***\n\t\t\tvec4 depthColor4 = texture2D(depthTex, screenPos.xy);\n\t\t\tfloat z_window  = unpackDepth(depthColor4); // z_window  is [-1.0, 1.0] range depth.\n\n\t\t\tif(z_window >= 1.0) {\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tif(z_window <= 0.0 && uFrustumIdx < 2) {\n\t\t\t\t// frustum =2 & 3 -> renders sky, so dont discard.\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tvec4 posWC;\n\t\t\tfloat depth = getDepthFrom_ZWindow(z_window, screenPos, posWC);\n\t\t\tgl_FragData[0] = packDepth(depth); // depth.\n\t\t}\n\t\telse if ( u_textureTypeToCopy == 1)\n\t\t{\n\t\t\tvec4 depthColor4 = texture2D(depthTex, screenPos.xy);\n\t\t\tfloat z_window  = unpackDepth(depthColor4); // z_window  is [-1.0, 1.0] range depth.\n\n\t\t\tif(z_window >= 1.0) {\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tif(z_window <= 0.0 && uFrustumIdx < 2) {\n\t\t\t\t// frustum =2 & 3 -> renders sky, so dont discard.\n\t\t\t\tdiscard;\n\t\t\t}\n\n\t\t\tvec4 posWC;\n\t\t\tfloat depth = getDepthFrom_ZWindow(z_window, screenPos, posWC);\n\t\t\t\n\t\t\t// Normal.***\n\t\t\tfloat frustumIdx = 1.0;\n\t\t\tif(uFrustumIdx == 0)\n\t\t\tfrustumIdx = 0.105;\n\t\t\telse if(uFrustumIdx == 1)\n\t\t\tfrustumIdx = 0.115;\n\t\t\telse if(uFrustumIdx == 2)\n\t\t\tfrustumIdx = 0.125;\n\t\t\telse if(uFrustumIdx == 3)\n\t\t\tfrustumIdx = 0.135;\n\n\t\t\tif(z_window > 0.0)\n\t\t\t{\n\t\t\t\tvec4 normal4WC = vec4(normalize(posWC.xyz), 1.0);\n\t\t\t\tvec4 normal4 = normalMatrix4 * normal4WC;\n\t\t\t\tvec3 encodedNormal = encodeNormal(normal4.xyz);\n\t\t\t\tgl_FragData[0] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvec3 encodedNormal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\t\t\tgl_FragData[0] = vec4(encodedNormal, frustumIdx); // save normal.***\n\t\t\t}\n\t\t}\n\t\telse if(u_textureTypeToCopy == 2)\n\t\t{\n\t\t\t// Albedo.***\n\t\t\tvec4 albedo = texture2D(albedoTex, screenPos.xy);\n\t\t\tgl_FragData[0] = albedo;\n\t\t}\n\t\t\n\t#endif\n\n\treturn;\n\n}",ScreenQuad2FS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define M_PI 3.1415926535897932384626433832795\n\nuniform sampler2D depthTex; // 0\nuniform sampler2D normalTex; // 1\nuniform sampler2D lightFogTex; // 2\nuniform sampler2D screenSpaceObjectsTex; // 3\nuniform sampler2D shadedColorTex; // 4\nuniform sampler2D brightColorTex; // 5\nuniform sampler2D volumetricTex; // 6\n\nuniform float near;\nuniform float far; \nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \n\nuniform float screenWidth;    \nuniform float screenHeight;  \nuniform vec2 uNearFarArray[4];\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float uSceneDayNightLightingFactor; // day -> 1.0; night -> 0.0\n\nuniform vec3 uAmbientLight;\n\nuniform bool u_activeTex[8];\n\n#ifndef FXAA_REDUCE_MIN\n    #define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#endif\n#ifndef FXAA_REDUCE_MUL\n    #define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#endif\n#ifndef FXAA_SPAN_MAX\n    #define FXAA_SPAN_MAX     8.0\n#endif\n\n// Tutorial for bloom effect : https://learnopengl.com/Advanced-Lighting/Bloom\n\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n\t\n    return ray;                      \n} \n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(normalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nbool isEdge(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y, inout float edgeRatio)\n{\n\tbool bIsEdge = false;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y)).xyz;\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y)).xyz;\n\tvec3 normal_down = getNormal(vec2(screenPos.x, screenPos.y - pixelSize_y)).xyz;\n\tvec3 normal_left = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y)).xyz;\n\n\tfloat minDot = 0.3;\n    edgeRatio = 0.0;\n\n\tif(dot(normal, normal_up) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_right) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_down) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_left) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\t// Now, check by depth.***\n    if(edgeRatio > 0.0)\n    bIsEdge = true;\n\n    edgeRatio /= 4.0;\n\n\treturn bIsEdge;\n}\n\nbool isEdge_3x3(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y, inout float edgeRatio)\n{\n\tbool bIsEdge = false;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y)).xyz;\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y)).xyz;\n\tvec3 normal_down = getNormal(vec2(screenPos.x, screenPos.y - pixelSize_y)).xyz;\n\tvec3 normal_left = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y)).xyz;\n\n    vec3 normal_upRight = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y)).xyz;\n\tvec3 normal_upLeft = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y + pixelSize_y)).xyz;\n\tvec3 normal_downRight = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y - pixelSize_y)).xyz;\n\tvec3 normal_downLeft = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y - pixelSize_y)).xyz;\n\n\tfloat minDot = 0.3;\n    edgeRatio = 0.0;\n\n\tif(dot(normal, normal_up) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_right) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_down) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_left) < minDot)\n\t{ edgeRatio += 1.0; }\n\n    if(dot(normal, normal_upRight) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_upLeft) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_downRight) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_downLeft) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\t// Now, check by depth.***\n    if(edgeRatio > 0.0)\n    bIsEdge = true;\n\n    edgeRatio /= 8.0;\n\n\treturn bIsEdge;\n}\n\nbool isEdge_original(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y, inout float edgeRatio)\n{\n\tbool bIsEdge = false;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y*1.0)).xyz;\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x*1.0, screenPos.y)).xyz;\n\tvec3 normal_upRight = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y)).xyz;\n\n\tfloat minDot = 0.3;\n    edgeRatio = 0.0;\n\n\tif(dot(normal, normal_up) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_right) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\tif(dot(normal, normal_upRight) < minDot)\n\t{ edgeRatio += 1.0; }\n\n\t// Now, check by depth.***\n    if(edgeRatio > 0.0)\n    bIsEdge = true;\n\n    edgeRatio /= 3.0;\n\n\treturn bIsEdge;\n}\n\nvec4 getShadedAlbedo(vec2 screenPos)\n{\n\treturn texture2D(shadedColorTex, screenPos);\n}\n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z*0.0001;\n        float Fcoef_half = uFCoef_logDepth/2.0;\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = (flogzAux - 1.0);\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nfloat getRealDepth(in vec2 coord, in vec2 nearFar)\n{\n\treturn getDepth(coord) * nearFar.y;\n}\n\nfloat getZDist(in vec2 coord)\n{\n\t// This function is equivalent to "getRealDepth", but this is used when unknown the "far".***\n\tvec4 normal4 = getNormal(coord);\n\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\tvec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\t//float currFar = nearFar.y;\n\treturn getRealDepth(coord, nearFar);\n}\n\nbool _isEdge_byDepth(in float curZDist, vec2 screenPos)\n{\n    float minDist = 1.0;\n    float adjacentZDist = getZDist(screenPos);\n\tfloat diff = abs(curZDist - adjacentZDist);\n\tif(diff / curZDist > 0.01 && diff > minDist)\n\t{ return true; }\n    else{\n        return false;\n    }\n}\n\nbool isEdge_byDepth(vec2 screenPos, float pixelSize_x, float pixelSize_y)\n{\n\tfloat curZDist = getZDist(screenPos);\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x, screenPos.y + pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y + pixelSize_y*1.0)))\n    { return true; }\n\n    return false;\n}\n\nvoid make_kernel(inout vec4 n[9], vec2 coord)\n{\n\tfloat w = 1.0 / screenWidth;\n\tfloat h = 1.0 / screenHeight;\n\n\tn[0] = texture2D(normalTex, coord + vec2( -w, -h));\n\tn[1] = texture2D(normalTex, coord + vec2(0.0, -h));\n\tn[2] = texture2D(normalTex, coord + vec2(  w, -h));\n\tn[3] = texture2D(normalTex, coord + vec2( -w, 0.0));\n\tn[4] = texture2D(normalTex, coord);\n\tn[5] = texture2D(normalTex, coord + vec2(  w, 0.0));\n\tn[6] = texture2D(normalTex, coord + vec2( -w, h));\n\tn[7] = texture2D(normalTex, coord + vec2(0.0, h));\n\tn[8] = texture2D(normalTex, coord + vec2(  w, h));\n}\n\nvec4 fxaa(vec2 fragCoord, vec2 resolution,\n            vec2 v_rgbNW, vec2 v_rgbNE, \n            vec2 v_rgbSW, vec2 v_rgbSE, \n            vec2 v_rgbM) {\n    vec4 color;\n    mediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\n    vec3 rgbNW = texture2D(shadedColorTex, v_rgbNW).xyz;\n    vec3 rgbNE = texture2D(shadedColorTex, v_rgbNE).xyz;\n    vec3 rgbSW = texture2D(shadedColorTex, v_rgbSW).xyz;\n    vec3 rgbSE = texture2D(shadedColorTex, v_rgbSE).xyz;\n    vec4 texColor = texture2D(shadedColorTex, v_rgbM);\n    vec3 rgbM  = texColor.xyz;\n    vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(rgbNW, luma);\n    float lumaNE = dot(rgbNE, luma);\n    float lumaSW = dot(rgbSW, luma);\n    float lumaSE = dot(rgbSE, luma);\n    float lumaM  = dot(rgbM,  luma);\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n    \n    mediump vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n    \n    float dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n                          (0.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n    \n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX),\n              max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n              dir * rcpDirMin)) * inverseVP;\n    \n    vec3 rgbA = 0.5 * (\n        texture2D(shadedColorTex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\n        texture2D(shadedColorTex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n        texture2D(shadedColorTex, fragCoord * inverseVP + dir * -0.5).xyz +\n        texture2D(shadedColorTex, fragCoord * inverseVP + dir * 0.5).xyz);\n\n    float lumaB = dot(rgbB, luma);\n    if ((lumaB < lumaMin) || (lumaB > lumaMax))\n        color = vec4(rgbA, texColor.a);\n    else\n        color = vec4(rgbB, texColor.a);\n    return color;\n}\n\nvoid main()\n{\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n    float pixelSize_x = 1.0/screenWidth;\n\tfloat pixelSize_y = 1.0/screenHeight;\n\n    // check for "screenSpaceObjectsTex".\n    vec4 screenSpaceColor4;\n    if(u_activeTex[1])\n    {\n        screenSpaceColor4 = texture2D(screenSpaceObjectsTex, screenPos);\n        gl_FragColor = screenSpaceColor4;\n\n        //if(screenSpaceColor4.a > 0.0)\n        //return;\n    }\n\n\tvec4 shadedColor = texture2D(shadedColorTex, screenPos);\n\n    // Calculate if isEdge by sobel.***\n\tbool bIsEdge = false;\n\n\tvec4 n[9];\n    make_kernel(n, screenPos);\n    vec4 sobel_edge_h = n[2] + (2.0*n[5]) + n[8] - (n[0] + (2.0*n[3]) + n[6]);\n\tvec4 sobel_edge_v = n[0] + (2.0*n[1]) + n[2] - (n[6] + (2.0*n[7]) + n[8]);\n\tvec4 sobel = sqrt((sobel_edge_h * sobel_edge_h) + (sobel_edge_v * sobel_edge_v));\n\tfloat sobelModul = length(sobel.rgb);\n\t\n\tif(sobelModul > 0.001)\n\t{\n\t\tbIsEdge = true;\n\t}\n    else\n    {\n        // check if edge by depth range.***\n        bIsEdge = isEdge_byDepth(screenPos, pixelSize_x, pixelSize_y);\n    }\n\n\tif(bIsEdge)\n\t{\n\t\t// fxaa.*********************************************************************************************************\n\t\t// https://www.programmersought.com/article/75321121466/\n\t\tvec2 uv_nw = vec2(screenPos.x - pixelSize_x, screenPos.y + pixelSize_y);\n\t\tvec2 uv_ne = vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y);\n\t\tvec2 uv_sw = vec2(screenPos.x - pixelSize_x, screenPos.y - pixelSize_y);\n\t\tvec2 uv_se = vec2(screenPos.x + pixelSize_x, screenPos.y - pixelSize_y);\n\t\tvec4 colorFxaa = fxaa(gl_FragCoord.xy, vec2(screenWidth, screenHeight), uv_nw, uv_ne, uv_sw, uv_se, screenPos);\n\t\tshadedColor = colorFxaa;\n\t\t//---------------------------------------------------------------------------------------------------------------\n\t}\n\n    // Do bloom effect if exist.************************************\n    // https://www.nutty.ca/?page_id=352&link=glow\n    int BlendMode = 1;\n    vec4 brightColor = texture2D(brightColorTex, screenPos);\n    vec4 src = vec4(brightColor.rgba);\n    vec4 dst = vec4(shadedColor.rgba);\n    if ( BlendMode == 0 )\n\t{\n\t\t// Additive blending (strong result, high overexposure)\n\t\tshadedColor = min(src + dst, 1.0);\n\t}\n\telse if ( BlendMode == 1 )\n\t{\n\t\t// Screen blending (mild result, medium overexposure)\n\t\tshadedColor = clamp((src + dst) - (src * dst), 0.0, 1.0);\n\t\tshadedColor.w = 1.0;\n\t}\n\telse if ( BlendMode == 2 )\n\t{\n\t\t// Softlight blending (light result, no overexposure)\n\t\t// Due to the nature of soft lighting, we need to bump the black region of the glowmap\n\t\t// to 0.5, otherwise the blended result will be dark (black soft lighting will darken\n\t\t// the image).\n\t\tsrc = (src * 0.5) + 0.5;\n\t\t\n\t\tshadedColor.xyz = vec3((src.x <= 0.5) ? (dst.x - (1.0 - 2.0 * src.x) * dst.x * (1.0 - dst.x)) : (((src.x > 0.5) && (dst.x <= 0.25)) ? (dst.x + (2.0 * src.x - 1.0) * (4.0 * dst.x * (4.0 * dst.x + 1.0) * (dst.x - 1.0) + 7.0 * dst.x)) : (dst.x + (2.0 * src.x - 1.0) * (sqrt(dst.x) - dst.x))),\n\t\t\t\t\t(src.y <= 0.5) ? (dst.y - (1.0 - 2.0 * src.y) * dst.y * (1.0 - dst.y)) : (((src.y > 0.5) && (dst.y <= 0.25)) ? (dst.y + (2.0 * src.y - 1.0) * (4.0 * dst.y * (4.0 * dst.y + 1.0) * (dst.y - 1.0) + 7.0 * dst.y)) : (dst.y + (2.0 * src.y - 1.0) * (sqrt(dst.y) - dst.y))),\n\t\t\t\t\t(src.z <= 0.5) ? (dst.z - (1.0 - 2.0 * src.z) * dst.z * (1.0 - dst.z)) : (((src.z > 0.5) && (dst.z <= 0.25)) ? (dst.z + (2.0 * src.z - 1.0) * (4.0 * dst.z * (4.0 * dst.z + 1.0) * (dst.z - 1.0) + 7.0 * dst.z)) : (dst.z + (2.0 * src.z - 1.0) * (sqrt(dst.z) - dst.z))));\n\t\tshadedColor.w = 1.0;\n\t}\n\telse\n\t{\n\t\t// Show just the glow map\n\t\tshadedColor = src;\n\t}\n    // End bloom effect.--------------------------------------------\n\n    vec4 finalColor = shadedColor;\n\n    // Check for light fog.\n    if(u_activeTex[0])\n    {\n        vec4 lightFog4 = texture2D(lightFogTex, screenPos);\n        float alpha = lightFog4.w;\n        if(alpha > 0.6)\n        alpha = 0.6;\n        finalColor = mix(shadedColor, lightFog4, alpha);\n    }\n\n    // Check for volumetricTex.***\n    if(u_activeTex[6])\n    {\n        vec4 volumCol4 = texture2D(volumetricTex, screenPos);\n        float alpha = volumCol4.w;\n        //if(alpha > 0.6)\n        //alpha = 0.6;\n        finalColor = mix(shadedColor, volumCol4, alpha);\n    }\n    \n    gl_FragColor = finalColor; // original.***\n}',ScreenQuadBlurFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D image; // 0\nuniform vec2 uImageSize;\n\nvoid main()\n{\n    vec2 TexCoords = vec2(gl_FragCoord.x / uImageSize.x, gl_FragCoord.y / uImageSize.y);\n    vec2 texelSize = 1.0 / uImageSize;\n    vec4 result = vec4(0.0);\n    for (int x = -2; x < 2; ++x) \n    {\n        for (int y = -2; y < 2; ++y) \n        {\n            vec2 offset = vec2(float(x), float(y)) * texelSize;\n            result += texture2D(image, TexCoords + offset);\n        }\n    }\n    gl_FragData[0] = result / (4.0 * 4.0);\n}",ScreenQuadFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n#define M_PI 3.1415926535897932384626433832795\n\nuniform sampler2D depthTex; // 0\nuniform sampler2D normalTex; // 1\nuniform sampler2D albedoTex; // 2\nuniform sampler2D shadowMapTex; // 3\nuniform sampler2D shadowMapTex2; // 4\nuniform sampler2D ssaoTex; // 5\nuniform sampler2D diffuseLightTex; // 6\nuniform sampler2D specularLightTex; // 7\n\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform mat4 projectionMatrixInv;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float near;\nuniform float far; \nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \n\nuniform bool bApplyShadow; // sun shadows on cesium terrain.\nuniform bool bApplyMagoShadow;\nuniform bool bSilhouette;\nuniform bool bFxaa;\nuniform bool bApplySsao;\n\nuniform mat4 sunMatrix[2]; \nuniform vec3 sunPosHIGH[2];\nuniform vec3 sunPosLOW[2];\nuniform vec3 sunDirCC;\nuniform vec3 sunDirWC;\nuniform float screenWidth;    \nuniform float screenHeight;  \nuniform vec2 ussaoTexSize;\nuniform vec2 uNearFarArray[4];\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float uSceneDayNightLightingFactor; // day -> 1.0; night -> 0.0\nuniform vec3 uBrightnessContrastSaturation;\nuniform int uBrightnessContrastType; // 0= only f4d, 1= f4d & terrain.\n\nuniform vec3 uAmbientLight;\n\nconst float Epsilon = 1e-10;\n\n// https://ndotl.wordpress.com/2018/08/29/baking-artifact-free-lightmaps/\n// voxel ilum : https://publications.lib.chalmers.se/records/fulltext/256137/256137.pdf\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(normalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n\t\n    return ray;                      \n} \n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nbool isInShadow(vec4 pointCC, int currSunIdx, inout bool isUnderSun)\n{\n\tbool inShadow = false;\n\tvec3 currSunPosLOW;\n\tvec3 currSunPosHIGH;\n\tmat4 currSunMatrix;\n\tif(currSunIdx == 0)\n\t{\n\t\tcurrSunPosLOW = sunPosLOW[0];\n\t\tcurrSunPosHIGH = sunPosHIGH[0];\n\t\tcurrSunMatrix = sunMatrix[0];\n\t}\n\telse if(currSunIdx == 1)\n\t{\n\t\tcurrSunPosLOW = sunPosLOW[1];\n\t\tcurrSunPosHIGH = sunPosHIGH[1];\n\t\tcurrSunMatrix = sunMatrix[1];\n\t}\n\telse\n\treturn false;\n\n\t\n\tvec3 highDifferenceSun = -currSunPosHIGH.xyz + encodedCameraPositionMCHigh;\n\tvec3 lowDifferenceSun = pointCC.xyz -currSunPosLOW.xyz + encodedCameraPositionMCLow;\n\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\tvec4 vPosRelToLight = currSunMatrix * pos4Sun;\n\n\tvec3 posRelToLight = vPosRelToLight.xyz / vPosRelToLight.w;\n\tfloat tolerance = 0.9963;\n\ttolerance = 0.9967; // test.\n\tposRelToLight = posRelToLight * 0.5 + 0.5; // transform to [0,1] range\n\tif(posRelToLight.x >= 0.0 && posRelToLight.x <= 1.0)\n\t{\n\t\tif(posRelToLight.y >= 0.0 && posRelToLight.y <= 1.0)\n\t\t{\n\t\t\tfloat depthRelToLight;\n\t\t\tif(currSunIdx == 0)\n\t\t\t{\n\t\t\t\tdepthRelToLight = unpackDepth(texture2D(shadowMapTex, posRelToLight.xy));\n\t\t\t}\n\t\t\telse if(currSunIdx == 1)\n\t\t\t{\n\t\t\t\tdepthRelToLight = unpackDepth(texture2D(shadowMapTex2, posRelToLight.xy));\n\t\t\t}\n\n\t\t\t//if(depthRelToLight < 0.1)\n\t\t\t//return false;\n\n\t\t\tif(posRelToLight.z > depthRelToLight*tolerance )\n\t\t\t{\n\t\t\t\tinShadow = true;\n\t\t\t}\n\n\t\t\tisUnderSun = true;\n\t\t}\n\t}\n\t\n\treturn inShadow;\n}\n\n/*\nvoid make_kernel(inout vec4 n[9], vec2 coord)\n{\n\t// We cannot use depthTex bcos there are multiple frustums.***\n\t//------------------------------------------------------------\n\tfloat w = 1.0 / screenWidth;\n\tfloat h = 1.0 / screenHeight;\n\n\tn[0] = texture2D(depthTex, coord + vec2( -w, -h));\n\tn[1] = texture2D(depthTex, coord + vec2(0.0, -h));\n\tn[2] = texture2D(depthTex, coord + vec2(  w, -h));\n\tn[3] = texture2D(depthTex, coord + vec2( -w, 0.0));\n\tn[4] = texture2D(depthTex, coord);\n\tn[5] = texture2D(depthTex, coord + vec2(  w, 0.0));\n\tn[6] = texture2D(depthTex, coord + vec2( -w, h));\n\tn[7] = texture2D(depthTex, coord + vec2(0.0, h));\n\tn[8] = texture2D(depthTex, coord + vec2(  w, h));\n}\n*/\n\nvoid make_kernel(inout vec4 n[9], vec2 coord)\n{\n\tfloat w = 1.0 / screenWidth;\n\tfloat h = 1.0 / screenHeight;\n\n\tn[0] = texture2D(normalTex, coord + vec2( -w, -h));\n\tn[1] = texture2D(normalTex, coord + vec2(0.0, -h));\n\tn[2] = texture2D(normalTex, coord + vec2(  w, -h));\n\tn[3] = texture2D(normalTex, coord + vec2( -w, 0.0));\n\tn[4] = texture2D(normalTex, coord);\n\tn[5] = texture2D(normalTex, coord + vec2(  w, 0.0));\n\tn[6] = texture2D(normalTex, coord + vec2( -w, h));\n\tn[7] = texture2D(normalTex, coord + vec2(0.0, h));\n\tn[8] = texture2D(normalTex, coord + vec2(  w, h));\n}\n\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n    if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z*0.0001;\n        float Fcoef_half = uFCoef_logDepth/2.0;\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = (flogzAux - 1.0);\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nfloat getRealDepth(in vec2 coord, in vec2 nearFar)\n{\n\treturn getDepth(coord) * (nearFar.y);\n}\n\nfloat getZDist(in vec2 coord)\n{\n\t// This function is equivalent to "getRealDepth", but this is used when unknown the "far".***\n\tvec4 normal4 = getNormal(coord);\n\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\tvec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\t//float currFar = nearFar.y;\n\treturn getRealDepth(coord, nearFar);\n}\n\nbool isEdge(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y)\n{\n\tbool bIsEdge = false;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y*1.0)).xyz;\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x*1.0, screenPos.y)).xyz;\n\tvec3 normal_down = getNormal(vec2(screenPos.x, screenPos.y - pixelSize_y)).xyz;\n\tvec3 normal_left = getNormal(vec2(screenPos.x - pixelSize_x, screenPos.y)).xyz;\n\n\tfloat minDot = 0.3;\n\n\tif(dot(normal, normal_up) < minDot)\n\t{ return true; }\n\n\tif(dot(normal, normal_right) < minDot)\n\t{ return true; }\n\n\tif(dot(normal, normal_down) < minDot)\n\t{ return true; }\n\n\tif(dot(normal, normal_left) < minDot)\n\t{ return true; }\n\n\t// Now, check by depth.***\n\n\n\treturn bIsEdge;\n}\n\nbool isEdge_byNormals(vec2 screenPos, vec3 normal, float pixelSize_x, float pixelSize_y)\n{\n\tbool bIsEdge = false;\n\n\tfloat minDot = 0.3;\n\n\t// 1rst, check by normals.***\n\tvec3 normal_up = getNormal(vec2(screenPos.x, screenPos.y + pixelSize_y*1.0)).xyz;\n\tif(dot(normal, normal_up) < minDot)\n\t{ return true; }\n\n\tvec3 normal_right = getNormal(vec2(screenPos.x + pixelSize_x*1.0, screenPos.y)).xyz;\n\tif(dot(normal, normal_right) < minDot)\n\t{ return true; }\n\n\tvec3 normal_upRight = getNormal(vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y)).xyz;\n\tif(dot(normal, normal_upRight) < minDot)\n\t{ return true; }\n\n\treturn bIsEdge;\n}\n\nbool _isEdge_byDepth(in float curZDist, vec2 screenPos)\n{\n\tfloat minDist = 1.0;\n    float adjacentZDist = getZDist(screenPos);\n\tfloat diff = abs(curZDist - adjacentZDist);\n\tif(diff / curZDist > 0.01 && diff > minDist)\n\t{ return true; }\n    else{\n        return false;\n    }\n}\n\nbool isEdge_byDepth(vec2 screenPos, float pixelSize_x, float pixelSize_y)\n{\n\tfloat curZDist = getZDist(screenPos);\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x, screenPos.y + pixelSize_y*1.0))) // up.\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y + pixelSize_y*1.0))) // up-right.\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y))) // right.\n    { return true; }\n\t/*\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x + pixelSize_x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y - pixelSize_y*1.0)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y)))\n    { return true; }\n\n    if(_isEdge_byDepth(curZDist, vec2(screenPos.x - pixelSize_x, screenPos.y + pixelSize_y*1.0)))\n    { return true; }\n\t*/\n    return false;\n}\n\nvec4 getShadedAlbedo(vec2 screenPos, vec3 lightingDirection, vec3 ambientColor, vec3 directionalLightColor)\n{\n\tvec4 albedo = texture2D(albedoTex, screenPos);\n\t//vec4 diffuseLight = texture2D(diffuseLightTex, screenPos) + vec4(uSceneDayNightLightingFactor);\n\tvec4 normal = getNormal(screenPos);\n\n\tfloat directionalLightWeighting = max(dot(normal.xyz, lightingDirection), 0.0);\n\t\n\tvec3 lightWeighting = ambientColor + directionalLightColor * directionalLightWeighting; // original.***\n\tvec4 shadedAlbedo = albedo * vec4(lightWeighting, 1.0);\n\n\treturn shadedAlbedo;\n}\n\nvec3 RGBtoHSV(in vec3 RGB)\n{\n    vec4  P   = (RGB.g < RGB.b) ? vec4(RGB.bg, -1.0, 2.0/3.0) : vec4(RGB.gb, 0.0, -1.0/3.0);\n    vec4  Q   = (RGB.r < P.x) ? vec4(P.xyw, RGB.r) : vec4(RGB.r, P.yzx);\n    float C   = Q.x - min(Q.w, Q.y);\n    float H   = abs((Q.w - Q.y) / (6.0 * C + Epsilon) + Q.z);\n    vec3  HCV = vec3(H, C, Q.x);\n    float S   = HCV.y / (HCV.z + Epsilon);\n    return vec3(HCV.x, S, HCV.z);\n}\n\nvec3 HSVtoRGB(in vec3 HSV)\n{\n    float H   = HSV.x;\n    float R   = abs(H * 6.0 - 3.0) - 1.0;\n    float G   = 2.0 - abs(H * 6.0 - 2.0);\n    float B   = 2.0 - abs(H * 6.0 - 4.0);\n    vec3  RGB = clamp( vec3(R,G,B), 0.0, 1.0 );\n    return ((RGB - 1.0) * HSV.y + 1.0) * HSV.z;\n}\n\n\nvec4 HueSatBright_color(vec4 color4, float saturation)\n{\n\t// https://stackoverflow.com/questions/53879537/increase-the-intensity-of-texture-in-shader-code-opengl\n\tvec4 color = color4;\n\tvec3 hsv = RGBtoHSV(color.rgb);\n\n\t// saturation range : -1.0 to 1.0\n\t/*\n\tsaturation is a value in the range [0.0, 1.0]. 0.5 means that the image is kept as it is. \n\tIt saturation is greater 0.5 the image is saturated and if it is less than 0.5 the image is bleached\n\t*/\n\tfloat sat = saturation + 0.5;\n\thsv.y *= (sat * 2.0);\n\n\tcolor.rgb = HSVtoRGB(hsv);\n\n    // Save the result\n    return color;\n}\n\nvec3 brightnessContrast(vec3 value, float brightness, float contrast)\n{\n\t// contrast range : -1.0 to 1.0\n\t// brightness range : -1.0 to 1.0\n\tfloat internContrast = contrast + 1.0;\n    return (value - 0.5) * internContrast + 0.5 + brightness;\n}\n\nvec3 Gamma(vec3 value, float param)\n{\n    return vec3(pow(abs(value.r), param),pow(abs(value.g), param),pow(abs(value.b), param));\n}\n\nvoid getNormal_dataType_andFar(in vec2 coord, inout vec3 normal, inout int dataType, inout vec2 nearFar)\n{\n\tvec4 normal4 = getNormal(coord);\n\tnormal = normal4.xyz;\n\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\tdataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\tnearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n}\n\n\nvoid main()\n{\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\n\t// 1rst, check if this is silhouette rendering.\n\tif(bSilhouette)\n\t{\n\t\t// Check the adjacent pixels to decide if this is silhouette.\n\t\t// Analize a 5x5 rectangle of the depthTexture: if there are objectDepth & backgroundDepth => is silhouette.\n\t\tfloat pixelSizeW = 1.0/screenWidth;\n\t\tfloat pixelSizeH = 1.0/screenHeight;\n\t\tint objectDepthCount = 0;\n\t\tint backgroundDepthCount = 0;\n\t\tfloat tolerance = 0.9963;\n\t\ttolerance = 0.9963;\n\n\t\tfloat origin_z_window  = unpackDepth(texture2D(depthTex, screenPos.xy)); // z_window  is [0.0, 1.0] range depth.\n\t\tif(origin_z_window > tolerance)\n\t\t{\n\t\t\n\t\t\tvec2 screenPos_LD = vec2(screenPos.x - pixelSizeW*2.5, screenPos.y - pixelSizeH*2.5); // left-down corner.\n\t\t\t\n\t\t\tfor(int w = -10; w<15; w+= 4)\n\t\t\t{\n\t\t\t\tfor(int h=-10; h<15; h+= 4)\n\t\t\t\t{\n\t\t\t\t\tvec2 screenPosAux = vec2(screenPos_LD.x + pixelSizeW*float(w), screenPos_LD.y + pixelSizeH*float(h));\n\t\t\t\t\tfloat z_window  = unpackDepth(texture2D(depthTex, screenPosAux.xy)); // z_window  is [0.0, 1.0] range depth.\n\n\t\t\t\t\tif(z_window > tolerance)\n\t\t\t\t\t{\n\t\t\t\t\t\t// is background.\n\t\t\t\t\t\tbackgroundDepthCount += 1;\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\t// is object.\n\t\t\t\t\t\tobjectDepthCount += 1;\n\t\t\t\t\t}\n\n\t\t\t\t\t//if(backgroundDepthCount > 0 && objectDepthCount > 0)\n\t\t\t\t\t//{\n\t\t\t\t\t\t// is silhouette.\n\t\t\t\t\t\t//gl_FragData[0] = vec4(0.2, 1.0, 0.3, 1.0);\n\t\t\t\t\t\t//return;\n\t\t\t\t\t//}\n\t\t\t\t\t\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif(backgroundDepthCount > 0 && objectDepthCount > 0)\n\t\t\t{\n\t\t\t\t// is silhouette.\n\t\t\t\tfloat countsDif = abs(float(objectDepthCount)/16.0);\n\t\t\t\t//gl_FragData[0] = vec4(0.2, 1.0, 0.3, countsDif);\n\t\t\t\tvec3 silhouetteCol3 = vec3(51.0/255.0, 206.0/255.0, 255.0/255.0);\n\t\t\t\tgl_FragData[0] = vec4(silhouetteCol3, countsDif);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// New:\n\t\t// Try to use a xCross pixels sampling data. TODO:\n\t\treturn;\n\t}\n\t\n\tfloat shadow_occlusion = 1.0;\n\tfloat alpha = 0.0;\n\tvec4 finalColor;\n\tfinalColor = vec4(0.2, 0.2, 0.2, 0.8);\n\n\tvec4 normal4 = getNormal(screenPos);\n\tvec3 normal = normal4.xyz;\n\tif(length(normal) < 0.1)\n\tdiscard;\n\n\n\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\tvec2 nearFar_origin = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear_origin = nearFar_origin.x;\n\tfloat currFar_origin = nearFar_origin.y;\n\t\n\tvec3 ambientColor = vec3(0.0);\n\tvec3 directionalLightColor = vec3(0.9, 0.9, 0.9);\n\tfloat directionalLightWeighting = 1.0;\n\n\t// sunShadow vars.***\n\tbool pointIsinShadow = false;\n\tbool isUnderSun = false;\n\tbool sunInAntipodas = false;\n\tif(bApplyMagoShadow)\n\t{\n\t\t// 1rst, check normal vs sunDirCC.\n\t\tfloat dotAux = dot(sunDirCC, normal);\n\t\tif(dotAux > -0.1)\n\t\t{\n\t\t\tsunInAntipodas = true;\n\t\t\tshadow_occlusion = 0.5;\n\t\t}\n\n\t\tif(!sunInAntipodas)\n\t\t{\n\t\t\tfloat linearDepth = getDepth(screenPos);\n\t\t\t// calculate the real pos of origin.\n\t\t\tfloat origin_zDist = linearDepth * currFar_origin; // original.\n\t\t\tvec3 posCC = getViewRay(screenPos, origin_zDist);\n\t\t\tvec4 posWCRelToEye = modelViewMatrixRelToEyeInv * vec4(posCC.xyz, 1.0);\n\t\t\t//posWC += vec4((encodedCameraPositionMCHigh + encodedCameraPositionMCLow).xyz, 0.0);\n\t\t\t//------------------------------------------------------------------------------------------------------------------------------\n\t\t\t// 2nd, calculate the vertex relative to light.***\n\t\t\t// 1rst, try with the closest sun. sunIdx = 0.\n\t\t\t\n\t\t\tpointIsinShadow = isInShadow(posWCRelToEye, 0, isUnderSun);\n\t\t\tif(!isUnderSun)\n\t\t\t{\n\t\t\t\tpointIsinShadow = isInShadow(posWCRelToEye, 1, isUnderSun);\n\t\t\t}\n\n\t\t\tif(isUnderSun)\n\t\t\t{\n\t\t\t\tif(pointIsinShadow)\n\t\t\t\t{\n\t\t\t\t\tshadow_occlusion = 0.5;\n\t\t\t\t\talpha = 0.5;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t\n\t\t// calculate sunDirCC.\n\t\t//vec4 sunDirCC = modelViewMatrixRelToEyeInv * vec4(sunDirWC, 1.0);\n\t\t//directionalLightWeighting = max(dot(normal, -sunDirCC.xyz), 0.0);\n\t}\n\t\n\tambientColor = uAmbientLight;\n\t// https://learnopengl.com/Lighting/Basic-Lighting\n\tvec3 lightingDirection = normalize(vec3(0.6, 0.6, 0.6));\n\t//vec3 lightingDirection = normalize(vec3(0.0, 0.0, 1.0)); // lightDir = camDir.***\n\tdirectionalLightWeighting = max(dot(normal, lightingDirection), 0.0);\n\t\n\t// 1rst, take the albedo.\n\tvec4 albedo = texture2D(albedoTex, screenPos);\n\n\t// Color correction.**********************************************************************************\n\tif(uBrightnessContrastType == 0) // apply brightness & contrast for f4d objects.\n\t{\n\t\tif(dataType == 0)\n\t\t{\n\t\t\tfloat brightness = uBrightnessContrastSaturation.x; // range [0.0, 1.0].\n\t\t\tfloat contrast = uBrightnessContrastSaturation.y; // range [0.0, 1.0].\n\t\t\tfloat saturation = uBrightnessContrastSaturation.z; // range [0.0, 1.0].\n\t\t\talbedo.rgb = brightnessContrast(albedo.rgb, brightness, contrast);\n\t\t\talbedo = HueSatBright_color(albedo, saturation);\n\n\t\t\t//albedo.rgb = Gamma(albedo.rgb, 1.1);\n\t\t}\n\t}\n\telse if(uBrightnessContrastType == 1) // apply brightness & contrast for f4d objects and terrain\n\t{\n\t\tfloat brightness = uBrightnessContrastSaturation.x; // range [0.0, 1.0].\n\t\tfloat contrast = uBrightnessContrastSaturation.y; // range [0.0, 1.0].\n\t\tfloat saturation = uBrightnessContrastSaturation.z; // range [0.0, 1.0].\n\t\talbedo.rgb = brightnessContrast(albedo.rgb, brightness, contrast);\n\t\talbedo = HueSatBright_color(albedo, saturation);\n\n\t\t//albedo.rgb = Gamma(albedo.rgb, 1.1);\n\t}\n\t// End color correction.---------------------------------------------------------------------------\n\n\tvec4 diffuseLight = texture2D(diffuseLightTex, screenPos);\n\tfloat diffuseLightModul = length(diffuseLight.xyz);\n\n\t//vec3 ray = getViewRay(screenPos, 1.0); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t//float scalarProd = abs(dot(normal, normalize(-ray)));\n\n\t\n\tvec3 lightWeighting = ambientColor + directionalLightColor * directionalLightWeighting; // original.***\n\n\t//lightWeighting += diffuseLight.xyz;\n\tif(dataType != 1)\n\t{\n\t\talbedo *= vec4(lightWeighting, 1.0) ;\n\t}\n\telse\n\t{\n\t\t// This is terrain. provisionally do nothing.\n\t\t//albedo *= vec4(lightWeighting, 1.0);\n\t}\n\n\tfinalColor = albedo;\n\t\n\tif(bApplySsao)\n\t{\n\t\t// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\n\t\t//ssaoFromDepthTex\n\t\tfloat pixelSize_x = 1.0/screenWidth;\n\t\tfloat pixelSize_y = 1.0/screenHeight;\n\t\tfloat pixelSizeSsaoTex_x = 1.0/ussaoTexSize.x;\n\t\tfloat pixelSizeSsaoTex_y = 1.0/ussaoTexSize.y;\n\t\tvec4 occlFromDepth = vec4(0.0);\n\t\t\n\t\tfor(int i=0; i<4; i++)\n\t\t{\n\t\t\tfor(int j=0; j<4; j++)\n\t\t\t{\n\t\t\t\tvec2 texCoord = vec2(screenPos.x + pixelSizeSsaoTex_x*float(i-2), screenPos.y + pixelSizeSsaoTex_y*float(j-2)); \n\t\t\t\tvec4 color = texture2D(ssaoTex, texCoord);\n\t\t\t\tocclFromDepth += color;\n\t\t\t}\n\t\t}\n\t\tocclFromDepth /= 16.0;\n\t\t\n\n\t\tfloat attenuation = 0.45;\n\t\t//vec4 color = texture2D(ssaoTex, screenPos);\n\t\t//occlFromDepth = color;\n\n\t\t// Aditive methode.***************************\n\t\t//occlFromDepth *= attenuation; // attenuation.\n\t\t//float occlusionInverseAdd = (1.0 - occlFromDepth.r) + (1.0 -  occlFromDepth.g) + (1.0 - occlFromDepth.b) + (1.0 - occlFromDepth.a); // original.***\n\n\t\t// Multiplicative methode.********************\n\t\tattenuation = 0.6;\n\t\tocclFromDepth *= attenuation; // attenuation.\n\t\tfloat occlusionInverseMult = (1.0 - occlFromDepth.r) * (1.0 -  occlFromDepth.g) * (1.0 - occlFromDepth.b) * (1.0 - occlFromDepth.a); // original.***\n\n\t\tfloat occlInv = occlusionInverseMult;\n\n\t\t//float lightFactorAux = uSceneDayNightLightingFactor + diffuseLightModul;\n\t\tvec3 diffuseLight3 = diffuseLight.xyz + vec3(uSceneDayNightLightingFactor);\n\n\t\t// Light factor.***\n\t\tshadow_occlusion += diffuseLightModul * 0.3;\n\t\tif(shadow_occlusion > 1.0)\n\t\tshadow_occlusion = 1.0;\n\n\t\tocclInv *= (shadow_occlusion);\n\t\tbool isTransparentObject = false;\n\t\tif(albedo.a < 1.0)\n\t\t{\n\t\t\t// This is transparent object (rendered in transparent pass), so atenuate occInv.\n\t\t\tisTransparentObject = true;\n\t\t\tocclInv *= 3.0;\n\t\t\tif(occlInv > 1.0)\n\t\t\tocclInv = 1.0;\n\t\t}\n\n\t\tif(bApplyMagoShadow && !pointIsinShadow && !sunInAntipodas)\n\t\t{\n\t\t\tif(occlInv < 1.0)\n\t\t\t{\n\t\t\t\tocclInv = min(occlInv * 1.5, 1.0);\n\t\t\t}\n\t\t\t\n\t\t}\n\n\t\tfinalColor = vec4(albedo.r * occlInv * diffuseLight3.x, \n\t\t\t\t\t\t\talbedo.g * occlInv * diffuseLight3.y, \n\t\t\t\t\t\t\talbedo.b * occlInv * diffuseLight3.z, albedo.a);\n\n\t\tgl_FragData[0] = finalColor;\n\n\t\t// EDGES.****************************************************************\n\t\tif(dataType == 0 || dataType == 1)// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\t\t{\n\t\t\t\n\t\t\tbool bIsEdge = isEdge_byNormals(screenPos, normal, pixelSize_x, pixelSize_y); // original.***\n\n\t\t\tif(!bIsEdge && dataType == 0)\n\t\t\t{\n\t\t\t\t// Check if is edge by depth range.***\n\t\t\t\tbIsEdge = isEdge_byDepth(screenPos, pixelSize_x, pixelSize_y);\n\t\t\t}\n\t\t\t\n\t\t\tif(bIsEdge)\n\t\t\t{\t\t\t\t\n\t\t\t\tvec4 edgeColor = finalColor * 0.7;\n\t\t\t\tif(isTransparentObject)\n\t\t\t\t\tedgeColor *= 1.5;\n\n\t\t\t\tfinalColor = vec4(edgeColor.rgb, 1.0);\n\n\t\t\t\tgl_FragData[0] = finalColor;\n\t\t\t\t\n\t\t\t}\n\n\t\t\t// shade terrain : TODO.***\n\t\t\tif(dataType == 1)\n\t\t\t{\n\t\t\t\t// TODO :\n\t\t\t\t// Calculate normal by depth texture.***\n\t\t\t\t//vec4 normal4 = getNormal(screenPos);\n\t\t\t\t//vec3 normal = normal4.xyz;\n\t\t\t\t//int estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\t\t\t\t//int dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\t\t\t\t//int currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\t\t\t\t//vec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\t\t\t\t//float currNear = nearFar.x;\n\t\t\t\t//float currFar = nearFar.y;\n\t\t\t\t//float realDepth = getRealDepth(screenPos, currFar);\n\t\t\t\t//---------------------------------------------------------\n\t\t\t\t\n\t\t\t}\n\t\t\t\n\t\t}\n\t\telse if(dataType == 2)// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\t\t{\n\t\t\t// this is pointCloud data.\n\t\t\t// Check depth values around the pixel to find a silhouette.\n\t\t\tfloat pixelSize_x = 1.0/screenWidth;\n\t\t\tfloat pixelSize_y = 1.0/screenHeight;\n\t\t\tfloat myLinearDepth = getDepth(screenPos);\n\n\t\t\tfloat myDepth = myLinearDepth * currFar_origin;\n\t\t\tfloat log2Deoth = log2(myDepth);\n\t\t\t// Apply Eye-Dom-Lighting (EDL).***\n\t\t\t\n\t\t\tfloat coordScale = 1.5;\n\n\t\t\t// top.***\n\t\t\tvec2 texCoord_top = vec2(screenPos.x, screenPos.y + pixelSize_y*coordScale);\n\t\t\tvec3 normal_top;\n\t\t\tint dataType_top;\n\t\t\tvec2 nearfar_top;\n\t\t\tgetNormal_dataType_andFar(texCoord_top, normal_top, dataType_top, nearfar_top);\n\t\t\tfloat realDepth_top = getRealDepth(texCoord_top, nearfar_top);\n\n\t\t\t// left.***\n\t\t\tvec2 texCoord_left = vec2(screenPos.x - pixelSize_x * coordScale, screenPos.y);\n\t\t\tvec3 normal_left;\n\t\t\tint dataType_left;\n\t\t\tvec2 nearfar_left;\n\t\t\tgetNormal_dataType_andFar(texCoord_left, normal_left, dataType_left, nearfar_left);\n\t\t\tfloat realDepth_left = getRealDepth(texCoord_left, nearfar_left);\n\n\t\t\t// bottom.***\n\t\t\tvec2 texCoord_bottom = vec2(screenPos.x, screenPos.y - pixelSize_y*coordScale);\n\t\t\tvec3 normal_bottom;\n\t\t\tint dataType_bottom;\n\t\t\tvec2 nearfar_bottom;\n\t\t\tgetNormal_dataType_andFar(texCoord_bottom, normal_bottom, dataType_bottom, nearfar_bottom);\n\t\t\tfloat realDepth_bottom = getRealDepth(texCoord_bottom, nearfar_bottom);\n\n\t\t\t// right.***\n\t\t\tvec2 texCoord_right = vec2(screenPos.x + pixelSize_x * coordScale, screenPos.y);\n\t\t\tvec3 normal_right;\n\t\t\tint dataType_right;\n\t\t\tvec2 nearfar_right;\n\t\t\tgetNormal_dataType_andFar(texCoord_right, normal_right, dataType_right, nearfar_right);\n\t\t\tfloat realDepth_right = getRealDepth(texCoord_right, nearfar_right);\n\n\t\t\tfloat response = (max(0.0, log2Deoth - log2(realDepth_top)) + max(0.0, log2Deoth - log2(realDepth_left)) + max(0.0, log2Deoth - log2(realDepth_bottom)) + max(0.0, log2Deoth - log2(realDepth_right))) / 4.0;\n\t\t\tfloat edlStrength = 2.0;\n\t\t\tfloat shade = exp(-response * 300.0 * edlStrength);\n\n\t\t\tvec4 finalColorPC = vec4(albedo.rgb * shade, albedo.a);\n\t\t\t//finalColorPC = vec4(1.0, 0.0, 0.0, albedo.a);\n\n\t\t\tgl_FragData[0] = finalColorPC;\n\n\t\t}\n\t\t\n\t}\n\n\t// fog.*****************************************************************\n\t//bool bApplyFog = true;\n\t//if(bApplyFog)\n\t//{\n\t//\tfloat zDist = getZDist(screenPos);\n\t//\tfloat fogFactor = min(zDist / 2000.0, 0.4);\n\t//\tvec4 finalColor2 = mix(finalColor, vec4(1.0, 1.0, 1.0, 1.0), fogFactor);\n\t//\tgl_FragData[0] = vec4(finalColor2);\n\t//}\n\t\n\t// End fog.---------------------------------------------------------------\n\n\t// Finally check for brightColor (for bloom effect, if exist).***\n\tfloat brightness = dot(finalColor.rgb, vec3(0.2126, 0.7152, 0.0722));\n\tvec4 brightColor;\n\tif(brightness > 1.0)\n        brightColor = vec4(finalColor.rgb, 1.0);\n    else\n        brightColor = vec4(0.0, 0.0, 0.0, 1.0);\n\tgl_FragData[1] = brightColor;\n\n\t// debugTex.***\n\t//float pixelSize_x_ = 1.0/screenWidth;\n\t//float pixelSize_y_ = 1.0/screenHeight;\n\t//float zDist = getZDist(screenPos);// - nearFar_origin.x);\n\t//bool isEdgeTest = _isEdge_byDepth(zDist, screenPos);\n\t//float zDist_top = getZDist(vec2(screenPos.x, screenPos.y + pixelSize_y_));// - nearFar_origin.x);\n\t//if(isEdgeTest)\n\t//{\n\t//\tgl_FragData[2] = vec4(1.0, 0.0, 0.0, 1.0);\n\t//}\n\t//else gl_FragData[2] = vec4(zDist/1200.0, zDist/1200.0, zDist/1200.0, 1.0);\n}',ScreenQuadGaussianBlurFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D image; // 0\n\nuniform bool u_bHorizontal;\nuniform vec2 uImageSize;\n\n\n// Tutorial for bloom effect : https://learnopengl.com/Advanced-Lighting/Bloom\n\nvoid main()\n{\n    //float weight[5] = float[5] (0.227027, 0.1945946, 0.1216216, 0.054054, 0.016216);   \n    float weight[5];   \n    weight[0] = 0.227027;\n    weight[1] = 0.1945946;\n    weight[2] = 0.1216216;\n    weight[3] = 0.054054;\n    weight[4] = 0.016216;\n\n    vec2 TexCoords = vec2(gl_FragCoord.x / uImageSize.x, gl_FragCoord.y / uImageSize.y);\n    float pixelSize_x = 1.0/uImageSize.x;\n\tfloat pixelSize_y = 1.0/uImageSize.y;\n\n    vec4 result = texture2D(image, TexCoords) * weight[0]; // current fragment's contribution\n    if(u_bHorizontal)\n    {\n        for(int i = 1; i < 4; ++i)\n        {\n            result += texture2D(image, TexCoords + vec2(pixelSize_x * float(i), 0.0)) * weight[i];\n            result += texture2D(image, TexCoords - vec2(pixelSize_x * float(i), 0.0)) * weight[i];\n        }\n    }\n    else\n    {\n        for(int i = 1; i < 4; ++i)\n        {\n            result += texture2D(image, TexCoords + vec2(0.0, pixelSize_y * float(i))) * weight[i];\n            result += texture2D(image, TexCoords - vec2(0.0, pixelSize_y * float(i))) * weight[i];\n        }\n    }\n    gl_FragData[0] = result;\n}",ScreenQuadVS:"//precision mediump float;\n\nattribute vec2 position;\nvarying vec4 vColor; \nvarying vec2 vTexCoord;\n\nvoid main() {\n\tvColor = vec4(0.2, 0.2, 0.2, 0.5);\n    gl_Position = vec4(1.0 - 2.0 * position, 0.0, 1.0);\n    vTexCoord = gl_Position.xy;\n}",screen_frag:"precision mediump float;\n\nuniform sampler2D u_screen;\nuniform float u_opacity;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_screen, 1.0 - v_tex_pos);\n    // a hack to guarantee opacity fade out even with a value close to 1.0\n    gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n}\n",SilhouetteFS:"precision highp float;\nuniform vec4 vColor4Aux;\n\nvoid main()\n{          \n    gl_FragColor = vColor4Aux;\n}",SilhouetteVS:"attribute vec3 position;\n\nuniform mat4 buildingRotMatrix; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 ModelViewMatrixRelToEye;\nuniform mat4 ProjectionMatrix;\nuniform mat4 RefTransfMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\nuniform vec2 camSpacePixelTranslation;\nuniform vec2 screenSize;   \nvarying vec2 camSpaceTranslation;\n\nvoid main()\n{    \n    vec4 rotatedPos;\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 camSpacePos = ModelViewMatrixRelToEye * pos4;\n    vec4 translationVec = ProjectionMatrix * vec4(camSpacePixelTranslation.x*(-camSpacePos.z), camSpacePixelTranslation.y*(-camSpacePos.z), 0.0, 1.0);\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n    gl_Position += translationVec;  \n}",soundCalculateFluxFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n    //*********************************************************\n    // R= right, F= front, U= up, L= left, B= back, D= down.\n    // RFU = x, y, z.\n    // LBD = -x, -y, -z.\n    //*********************************************************\n\nuniform sampler2D airPressureMosaicTex;\nuniform sampler2D flux_RFU_MosaicTex_HIGH; // Inside here, there are the voxelization of the scene (in alpha channel).***\nuniform sampler2D flux_RFU_MosaicTex_LOW;\nuniform sampler2D flux_LBD_MosaicTex_HIGH;\nuniform sampler2D flux_LBD_MosaicTex_LOW;\nuniform sampler2D auxMosaicTex; // here, contains :\n\t// tex_0 = prev airPressureTex\n\t// tex_1 = next airPressureTex\n\t// tex_2 = prev flux_RFU_HIGH\n\t// tex_3 = next flux_RFU_HIGH\n\t// tex_4 = prev flux_RFU_LOW\n\t// tex_5 = next flux_RFU_LOW\n\t// tex_6 = prev flux_LBD_HIGH\n\t// tex_7 = next flux_LBD_HIGH\n\t// tex_8 = prev flux_LBD_LOW\n\t// tex_9 = next flux_LBD_LOW\n\n\t//  \n\t//      +-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |     \n\t//      |   tex_8   |   tex_9   |  nothing  |  nothing  |\n\t//      |           |           |           |           | \n\t//      +-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           | \n\t//      |   tex_4   |   tex_5   |   tex_6   |   tex_7   |\n\t//      |           |           |           |           |\n\t//      +-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |    \n\t//      |   tex_0   |   tex_1   |   tex_2   |   tex_3   | \n\t//      |           |           |           |           |\n\t//      +-----------+-----------+-----------+-----------+\n\nuniform int u_texSize[3]; // The original texture3D size.***\nuniform int u_mosaicTexSize[3]; // The mosaic texture size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_lowestMosaicSliceIndex;\n\nvarying vec2 v_tex_pos;\n\nuniform float u_timestep;\n\n//uniform vec2 u_tileSize; // tile size in meters.\nuniform vec3 u_voxelSizeMeters;\nuniform float u_airMaxPressure;\nuniform float u_maxFlux;\nuniform float u_airEnvirontmentPressure;\n//uniform vec2 u_heightMap_MinMax;\n\n//uniform vec2 u_simulationTextureSize;\n//uniform vec2 u_terrainTextureSize;\n//uniform int u_terrainHeightEncodingBytes;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col, in int row)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    float s = float(col) * sRange + subTexCoord.x * sRange;\n    float t = float(row) * tRange + subTexCoord.y * tRange;\n\n    vec2 resultTexCoord = vec2(s, t);\n    return resultTexCoord;\n}\n\nvec2 getColRow_and_subTexCoord(in vec2 texCoord, inout vec2 subTexCoord)\n{\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    // Determine the [col, row] of the mosaic.***\n    vec2 resultColRow = vec2(floor(texCoord.x / sRange), floor(texCoord.y / tRange));\n\n    // determine the subTexCoord.***\n    float col_mod = texCoord.x - resultColRow.x * sRange;\n    float row_mod = texCoord.y - resultColRow.y * tRange;\n    float s = col_mod / sRange;\n    float t = row_mod / tRange;\n    subTexCoord = vec2(s, t);\n\n    return resultColRow;\n}\n\nfloat getAirPressure_inMosaicTexture(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(airPressureMosaicTex, texCoord);\n    float decoded = unpackDepth(color4); // 32bit.\n    float airPressure = decoded * u_airMaxPressure;\n\n    return airPressure;\n}\n\nfloat getAirPressure_inAuxMosaicTexture(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(auxMosaicTex, texCoord);\n    float decoded = unpackDepth(color4); // 32bit.\n    float airPressure = decoded * u_airMaxPressure;\n\n    return airPressure;\n}\n\nbool getPrevSubTextureColRow(in int col, in int row, inout int prev_col, inout int prev_row)\n{\n    // u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    prev_row = row;\n    if(col == 0)\n    {\n        prev_col = u_mosaicSize[0] - 1;\n        prev_row = row - 1;\n\n        // now, check if the prev_row is inside of the boundary.***\n        if(prev_row < 0)\n        {\n            // we are outside of the tex3d boundary.***\n            return false;\n        }\n    }\n    else\n    {\n        prev_col = col - 1;\n    }\n    return true;\n}\n\nbool getNextSubTextureColRow(in int col, in int row, inout int next_col, inout int next_row)\n{\n    // u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    next_row = row;\n    if(col == u_mosaicSize[0] - 1)\n    {\n        next_col = 0;\n        next_row = row + 1;\n\n        // now, check if the next_row is inside of the boundary.***\n        if(next_row > u_mosaicSize[1] - 1)\n        {\n            // we are outside of the tex3d boundary.***\n            return false;\n        }\n    }\n    else\n    {\n        next_col = col + 1;\n    }\n\n    // Must check : some times, no all textures of the last row is used.***\n    int sliceIdx = next_row * u_mosaicSize[0] + next_col;\n    if(sliceIdx > u_texSize[2]-1)\n    {\n        return false;\n    }\n\n    return true;\n}\n\nfloat getAirPressure(in vec2 texCoord, inout vec3 airPressure_RFU, inout vec3 airPressure_LBD, inout vec3 voxelSpaceType_RFU, inout vec3 voxelSpaceType_LBD)\n{\n    // **********************************************************************\n    // Note : this function returns the airPressure of all 6 Neighbor too.***\n    // **********************************************************************\n    vec2 subTexCoord;\n    vec2 colRow = getColRow_and_subTexCoord(texCoord, subTexCoord);\n\n    float col = colRow.x;\n    float row = colRow.y;\n    int col_int = int(col);\n    int row_int = int(row);\n\n    float divSubX = 1.0 / float(u_texSize[0]); // divX for subTexture.***\n    float divSubY = 1.0 / float(u_texSize[1]); // divX for subTexture.***\n\n    // airPressure_curr.*********************************************************************\n    float airPressure_curr = getAirPressure_inMosaicTexture(texCoord);\n\n    // airPressure_R.************************************************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_R = subTexCoord + vec2(divSubX, 0.0);\n    if(subTexCoord_R.x > 1.0)\n    {\n        // is out of simulation boundary.***\n        airPressure_RFU.x = u_airEnvirontmentPressure;\n\n        // the voxelSpaceType is 0 (void).***\n        voxelSpaceType_RFU.x = 0.0;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_R:\n        vec2 mosaicTexCoord_R = subTexCoord_to_texCoord(subTexCoord_R, col_int, row_int);\n        airPressure_RFU.x = getAirPressure_inMosaicTexture(mosaicTexCoord_R);\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, mosaicTexCoord_R);\n        voxelSpaceType_RFU.x = color4_RFU_HIGH.a;\n    }\n\n    // airPressure_F.************************************************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_F = subTexCoord + vec2(0.0, divSubY);\n    if(subTexCoord_F.y > 1.0)\n    {\n        // is out of simulation boundary.***\n        airPressure_RFU.y = u_airEnvirontmentPressure;\n\n        // the voxelSpaceType is 0 (void).***\n        voxelSpaceType_RFU.y = 0.0;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_F:\n        vec2 mosaicTexCoord_F = subTexCoord_to_texCoord(subTexCoord_F, col_int, row_int);\n        airPressure_RFU.y = getAirPressure_inMosaicTexture(mosaicTexCoord_F);\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, mosaicTexCoord_F);\n        voxelSpaceType_RFU.y = color4_RFU_HIGH.a;\n    }\n\n    // airPressure_U.************************************************************************\n    // To calculate the airPressure_U, must know the UP_subTexrure (NEXT subTexure).***\n    // But, if the current subTexture is in right_up_corner, then must use the "auxMosaicTex".***\n    // use the next subTexture.***\n    int next_col;\n    int next_row;\n    if(getNextSubTextureColRow(col_int, row_int, next_col, next_row))\n    {\n        // must recalcuate the mosaicTexCoord.***\n        vec2 newMosaicTexCoord = subTexCoord_to_texCoord(subTexCoord, next_col, next_row);\n        airPressure_RFU.z = getAirPressure_inMosaicTexture(newMosaicTexCoord); \n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, newMosaicTexCoord);\n        voxelSpaceType_RFU.z = color4_RFU_HIGH.a;\n    }\n    else\n    {\n        // Is out of this slice.***\n        // Must use the "auxMosaicTex". This is a [4, 3] mosaic texture.***\n        // tex_1 = next airPressureTex. this in [col 1, row 0] into "auxMosaicTex".***\n        // Must calculate the texCoords of auxMosaicTex.***\n\n        float sRange_aux = 1.0 / 4.0;\n        float tRange_aux = 1.0 / 3.0;\n\n        float col_aux = 1.0;\n        float row_aux = 0.0;\n\n        float s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        float t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        vec2 texCoord_auxMosaicTex = vec2(s, t);\n        //airPressure_RFU.z = getAirPressure_inAuxMosaicTexture(texCoord_auxMosaicTex);\n        airPressure_RFU.z = u_airEnvirontmentPressure; // test delete.***\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, texCoord_auxMosaicTex); // error! Cannot use "texCoord_auxMosaicTex" in "flux_RFU_MosaicTex_HIGH" texture!!!\n        //voxelSpaceType_RFU.z = color4_RFU_HIGH.a;\n        voxelSpaceType_RFU.z = 0.0;\n        \n    }\n    //--------------------------------------------------------------------------------------------------------------\n    //--------------------------------------------------------------------------------------------------------------\n\n    // airPressure_L.************************************************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_L = subTexCoord + vec2(-divSubX, 0.0);\n    if(subTexCoord_L.x < 0.0)\n    {\n        // is out of simulation boundary.***\n        airPressure_LBD.x = u_airEnvirontmentPressure;\n\n        // the voxelSpaceType is 0 (void).***\n        voxelSpaceType_LBD.x = 0.0;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_L:\n        vec2 mosaicTexCoord_L = subTexCoord_to_texCoord(subTexCoord_L, col_int, row_int);\n        airPressure_LBD.x = getAirPressure_inMosaicTexture(mosaicTexCoord_L);\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, mosaicTexCoord_L);\n        voxelSpaceType_LBD.x = color4_RFU_HIGH.a;\n    }\n\n    // airPressure_B.************************************************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_B = subTexCoord + vec2(0.0, -divSubY);\n    if(subTexCoord_B.y < 0.0)\n    {\n        // is out of simulation boundary.***\n        airPressure_LBD.y = u_airEnvirontmentPressure;\n\n        // the voxelSpaceType is 0 (void).***\n        voxelSpaceType_LBD.y = 0.0;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_B:\n        vec2 mosaicTexCoord_B = subTexCoord_to_texCoord(subTexCoord_B, col_int, row_int);\n        airPressure_LBD.y = getAirPressure_inMosaicTexture(mosaicTexCoord_B);\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, mosaicTexCoord_B);\n        voxelSpaceType_LBD.y = color4_RFU_HIGH.a;\n    }\n\n    // airPressure_D.************************************************************************\n    // To calculate the airPressure_D, must know the UP_subTexrure (PREV subTexure).***\n    // But, if the current subTexture is in left_down_corner, then must use the "auxMosaicTex".***\n    // use the next subTexture.***\n    int prev_col;\n    int prev_row;\n    if(getPrevSubTextureColRow(col_int, row_int, prev_col, prev_row))\n    {\n        // must recalcuate the mosaicTexCoord.***\n        vec2 newMosaicTexCoord = subTexCoord_to_texCoord(subTexCoord, prev_col, prev_row);\n        airPressure_LBD.z = getAirPressure_inMosaicTexture(newMosaicTexCoord); \n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, newMosaicTexCoord);\n        voxelSpaceType_LBD.z = color4_RFU_HIGH.a;\n    }\n    else\n    {\n        // Is out of simulation boundary.***\n        // Must use the "auxMosaicTex". This is a [4, 3] mosaic texture.***\n        // tex_1 = next airPressureTex. this in [col 0, row 0] into "auxMosaicTex".***\n        // Must calculate the texCoords of auxMosaicTex.***\n\n        float sRange_aux = 1.0 / 4.0;\n        float tRange_aux = 1.0 / 3.0;\n\n        float col_aux = 0.0;\n        float row_aux = 0.0;\n\n        float s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        float t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        vec2 texCoord_auxMosaicTex = vec2(s, t);\n        //airPressure_LBD.z = getAirPressure_inAuxMosaicTexture(texCoord_auxMosaicTex);\n        airPressure_LBD.z = u_airEnvirontmentPressure; // test delete.***\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        //vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, texCoord_auxMosaicTex); // error! Cannot use "texCoord_auxMosaicTex" in "flux_RFU_MosaicTex_HIGH" texture!!!\n        //voxelSpaceType_LBD.z = color4_RFU_HIGH.a;\n        voxelSpaceType_LBD.z = 0.0;\n        \n    }\n    //--------------------------------------------------------------------------------------------------------------\n    //--------------------------------------------------------------------------------------------------------------\n\n    return airPressure_curr;\n}\n\nvoid encodeFlux(in vec3 flux, inout vec3 flux_HIGH, inout vec3 flux_LOW)\n{\n    vec2 encoded_a_flux = encodeRG(flux.x);\n    vec2 encoded_b_flux = encodeRG(flux.y);\n    vec2 encoded_c_flux = encodeRG(flux.z);\n\n    flux_HIGH = vec3(encoded_a_flux.x, encoded_b_flux.x, encoded_c_flux.x);\n    flux_LOW = vec3(encoded_a_flux.y, encoded_b_flux.y, encoded_c_flux.y);\n}\n\nvoid getFlux(in vec2 texCoord, inout vec3 flux_RFU, inout vec3 flux_LBD)\n{\n    // This function returns Outing flux.***\n    vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, texCoord);\n    vec4 color4_RFU_LOW = texture2D(flux_RFU_MosaicTex_LOW, texCoord);\n    vec4 color4_LBD_HIGH = texture2D(flux_LBD_MosaicTex_HIGH, texCoord);\n    vec4 color4_LBD_LOW = texture2D(flux_LBD_MosaicTex_LOW, texCoord);\n\n    // now, decode all fluxes.***\n    flux_RFU.r = decodeRG(vec2(color4_RFU_HIGH.r, color4_RFU_LOW.r)) * u_maxFlux; // flux_R.\n    flux_RFU.g = decodeRG(vec2(color4_RFU_HIGH.g, color4_RFU_LOW.g)) * u_maxFlux; // flux_F.\n    flux_RFU.b = decodeRG(vec2(color4_RFU_HIGH.b, color4_RFU_LOW.b)) * u_maxFlux; // flux_U.\n\n    flux_LBD.r = decodeRG(vec2(color4_LBD_HIGH.r, color4_LBD_LOW.r)) * u_maxFlux; // flux_L.\n    flux_LBD.g = decodeRG(vec2(color4_LBD_HIGH.g, color4_LBD_LOW.g)) * u_maxFlux; // flux_B.\n    flux_LBD.b = decodeRG(vec2(color4_LBD_HIGH.b, color4_LBD_LOW.b)) * u_maxFlux; // flux_D.\n}\n\nfloat getVoxelSpaceValue(in vec2 texCoord)\n{\n    // The scene voxelMatrix is into flux_RFU_MosaicTex_HIGH, in alpha channel.***\n    vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, texCoord);\n    return color4_RFU_HIGH.a;\n}\n\nfloat getAirMass_kg(in float P_Atm, in float V_m3, in float T_Kelvin)\n{\n    // Remembering.*************************************************************************************************************************\n    // "ecuacion propagacion sonido" => https://openstax.org/books/f%C3%ADsica-universitaria-volumen-1/pages/17-2-velocidad-del-sonido\n    // https://en.wikipedia.org/wiki/Density_of_air#:~:text=At%20101.325%20kPa%20(abs)%20and,International%20Standard%20Atmosphere%20(ISA).\n    // P1 * V1 = P2 * V2.***\n    // airDensity ro = ρ = 1.225 [kg/m3]\n    // airMolarMass = 0.02897 [Kg/mol]\n    // universalGasConstant R = 8.31446261815324 [J/(K*mol)], [m3*Pa/(K*mol)], [Kg*m2/(s2*K*mol)]\n    // airPressure at sea level = 101325 Pa = 101.325 kPa = 1013.25 hPa ≈ 1 bar\n    // Standard temperature at sea level is T = 288.15K\n    // Number of Avogadro n = 6.022 * 10E23\n    // Masa molar air = 29kg/kmol\n    // -------------------------------------------------------------------------------------------------------------------------------------\n\n    // P = pressure(Atm), V = volume (m3), T = temperature (K).***\n    float atmToPa = 101325.0;// 1 atm = 101325 Pa.***\n    float P_Pa = P_Atm * atmToPa; \n    float R = 8.31446261815324;\n    float n = P_Pa * V_m3 / (R * T_Kelvin); // number of air mols.***\n    float molarMassAir = 29.0; // kg/kmol.\n    float airMass = n/1000.0 * molarMassAir; // kg.***\n    return airMass;\n}\n\n\n\nvoid main()\n{\n    // The objective is to determine the outFlux of the current fragment.***\n    // There are 6 directions outFluxing (R, F, U, L, B, D) = (x, y, z, -x, -y, -z) = (Right, Front, Up, Left, Back, Down)\n    //-----------------------------------------------------------------------\n    float voxelSpaceValue = getVoxelSpaceValue(v_tex_pos);\n    if(voxelSpaceValue > 0.0)\n    {\n        // This is a solid space, so, do nothing. All values are zero.***\n        // Do NOT discard bcos must write the voxelSpaceValue.***\n        /*\n        vec3 outFlux_RFU = vec3(0.0);\n        vec3 outFlux_LBD = vec3(0.0);\n\n        vec3 encodedOutFlux_RFU_HIGH;\n        vec3 encodedOutFlux_RFU_LOW;\n        vec3 encodedOutFlux_LBD_HIGH;\n        vec3 encodedOutFlux_LBD_LOW;\n        encodeFlux(outFlux_RFU, encodedOutFlux_RFU_HIGH, encodedOutFlux_RFU_LOW);\n        encodeFlux(outFlux_LBD, encodedOutFlux_LBD_HIGH, encodedOutFlux_LBD_LOW);\n        */\n        vec3 zerovec = vec3(0.0);\n        gl_FragData[0] = vec4(zerovec, voxelSpaceValue);  // RFU flux high.\n\n        #ifdef USE_MULTI_RENDER_TARGET\n            gl_FragData[1] = vec4(zerovec, voxelSpaceValue); // RFU flux low.\n            gl_FragData[2] = vec4(zerovec, voxelSpaceValue);  // LBD flux high.\n            gl_FragData[3] = vec4(zerovec, voxelSpaceValue);  // LBD flux low.\n            gl_FragData[4] = vec4(0.0, 1.0, 0.0, 1.0);  // shader log.\n        #endif\n        return;\n        \n    }\n\n    // Determine the airPressure of the 6 fragment that is around of current fragment.***\n    // pressure unit [Atm].***\n    vec3 airPressure_RFU;\n    vec3 airPressure_LBD;\n    vec3 voxelSpaceType_RFU;\n    vec3 voxelSpaceType_LBD;\n    float airPressure_curr = getAirPressure(v_tex_pos, airPressure_RFU, airPressure_LBD, voxelSpaceType_RFU, voxelSpaceType_LBD); // pressure unit [Atm].***\n\n    vec3 currFlux_RFU;\n    vec3 currFlux_LBD;\n    getFlux(v_tex_pos, currFlux_RFU, currFlux_LBD);\n\n    // Calculate deltaPressure.***\n    // Check the pressure difference with the neighbor voxels.***\n    float R_out = airPressure_curr - airPressure_RFU.x;\n    float F_out = airPressure_curr - airPressure_RFU.y;\n    float U_out = airPressure_curr - airPressure_RFU.z;\n    float L_out = airPressure_curr - airPressure_LBD.x;\n    float B_out = airPressure_curr - airPressure_LBD.y;\n    float D_out = airPressure_curr - airPressure_LBD.z;\n    \n    if(voxelSpaceType_RFU.x > 0.0)\n    {\n        R_out = 0.0;\n        currFlux_RFU.x = 0.0;\n    }\n\n    if(voxelSpaceType_RFU.y > 0.0)\n    {\n        F_out = 0.0;\n        currFlux_RFU.y = 0.0;\n    }\n\n    if(voxelSpaceType_RFU.z > 0.0)\n    {\n        U_out = 0.0;\n        currFlux_RFU.z = 0.0;\n    }\n\n    if(voxelSpaceType_LBD.x > 0.0)\n    {\n        L_out = 0.0;\n        currFlux_LBD.x = 0.0;\n    }\n\n    if(voxelSpaceType_LBD.y > 0.0)\n    {\n        B_out = 0.0;\n        currFlux_LBD.y = 0.0;\n    }\n\n    if(voxelSpaceType_LBD.z > 0.0)\n    {\n        D_out = 0.0;\n        currFlux_LBD.z = 0.0;\n    }\n    \n\n    vec3 deltaP_RFU = vec3(R_out, F_out, U_out);\n    vec3 deltaP_LBD = vec3(L_out, B_out, D_out);\n\n    // At 101.325 kPa (abs) and 15 °C, air has a density of approximately 1.225 kg/m3\n\n    //vec3 airAccel_RFU = vec3(R_out / (airDensity * u_voxelSizeMeters.x), F_out / (airDensity * u_voxelSizeMeters.y), U_out / (airDensity * u_voxelSizeMeters.z)); // original.***\n    //vec3 airAccel_LBD = vec3(L_out / (airDensity * u_voxelSizeMeters.x), B_out / (airDensity * u_voxelSizeMeters.y), D_out / (airDensity * u_voxelSizeMeters.z)); // original.***\n\n    // calculate the new flux (m3/s).***\n    float timeStep = u_timestep;\n\n    //float pipeArea = 2.0 * u_voxelSizeMeters.x * u_voxelSizeMeters.y * u_voxelSizeMeters.z;\n    float pipeArea = u_voxelSizeMeters.x * u_voxelSizeMeters.y;\n    float cellVolume = u_voxelSizeMeters.x * u_voxelSizeMeters.y * u_voxelSizeMeters.z ;\n\n    // Now, calculate acceleration.***\n    // Example in "x" direction : \n    // m = ρ*V = ρ*dx*dy*dz\n    // m*a = -dp*dy*dz\n    // a = -(dp*dy*dz)/m = -(dp*dy*dz)/(ρ*dx*dy*dz) = -dp/(ρ*dx)\n    // -------------------------------------------------------------\n\n    // Calculate the air density.\n    float T = 288.15; // Kelvins.***\n    float P_Atm = airPressure_curr;\n    float curr_airMass_kg = getAirMass_kg(P_Atm, cellVolume, T);\n\n    float atmToPa = 101325.0;// 1 atm = 101325 Pa.***\n\n    float ro = curr_airMass_kg / cellVolume; // air density.***\n    vec3 airAccel_RFU = deltaP_RFU * atmToPa / (ro * u_voxelSizeMeters); // m/s2. \n    vec3 airAccel_LBD = deltaP_LBD * atmToPa / (ro * u_voxelSizeMeters); // m/s2.\n\n\n    ////vec3 airAccel_RFU = deltaP_RFU / (ro * u_voxelSizeMeters); // m/s2. \n    ////vec3 airAccel_LBD = deltaP_LBD / (ro * u_voxelSizeMeters); // m/s2.\n\n    vec3 newFlux_RFU = timeStep * pipeArea * airAccel_RFU; // m3/s\n    vec3 newFlux_LBD = timeStep * pipeArea * airAccel_LBD; // m3/s\n\n    // Now, calculate massFlux.***\n    //vec3 currMassFlux_RFU = currFlux_RFU * ro; // kg/s\n    //vec3 currMassFlux_LBD = currFlux_LBD * ro; // kg/s\n\n    // total outFlux.\n    float cushionFactor = 0.9999; // esmorteiment.\n    float output_R = max(0.0, currFlux_RFU.x + newFlux_RFU.x) * cushionFactor;\n    float output_F = max(0.0, currFlux_RFU.y + newFlux_RFU.y) * cushionFactor;\n    float output_U = max(0.0, currFlux_RFU.z + newFlux_RFU.z) * cushionFactor;\n\n    float output_L = max(0.0, currFlux_LBD.x + newFlux_LBD.x) * cushionFactor;\n    float output_B = max(0.0, currFlux_LBD.y + newFlux_LBD.y) * cushionFactor;\n    float output_D = max(0.0, currFlux_LBD.z + newFlux_LBD.z) * cushionFactor;\n\n    // calculate vOut & currVolum.\n    float vOut = timeStep * (output_R + output_F + output_U + output_L + output_B + output_D); \n    float massOut = vOut * ro;\n\n    float currAirVol = cellVolume; \n    float currMass = currAirVol * ro;\n\n    vec4 shaderLog = vec4(0.0);\n    if(vOut > currAirVol)\n    //if(massOut > currMass)\n    {\n        //rescale outflow readFlux so that outflow don\'t exceed current water volume\n        float factor = (currAirVol / vOut);\n        //float factor = (currMass / massOut);\n        output_R *= factor;\n        output_F *= factor;\n        output_U *= factor;\n\n        output_L *= factor;\n        output_B *= factor;\n        output_D *= factor;\n        shaderLog = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n\n    // Test debug:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::\n    if(output_R > u_maxFlux || output_F > u_maxFlux || output_U > u_maxFlux || output_L > u_maxFlux || output_B > u_maxFlux || output_D > u_maxFlux )\n    {\n        shaderLog = vec4(0.0, 0.0, 1.0, 1.0);\n    }\n    //shaderLog = vec4(1.0, 0.0, 0.0, 1.0);\n\n    //shaderLog = vec4(voxelSpaceValue*100.0, voxelSpaceValue*100.0, voxelSpaceValue*100.0, 1.0);\n\n    //shaderLog = vec4(normalize(newFlux_LBD), 1.0);\n\n    \n    \n    // End test debug.-------------------------------------------------------------------------------------------------------------------------------------------\n\n    vec3 outFlux_RFU = vec3(output_R, output_F, output_U) / u_maxFlux;\n    vec3 outFlux_LBD = vec3(output_L, output_B, output_D) / u_maxFlux;\n\n    vec3 encodedOutFlux_RFU_HIGH;\n    vec3 encodedOutFlux_RFU_LOW;\n    vec3 encodedOutFlux_LBD_HIGH;\n    vec3 encodedOutFlux_LBD_LOW;\n    encodeFlux(outFlux_RFU, encodedOutFlux_RFU_HIGH, encodedOutFlux_RFU_LOW);\n    encodeFlux(outFlux_LBD, encodedOutFlux_LBD_HIGH, encodedOutFlux_LBD_LOW);\n\n    // shaderLog:\n    //shaderLog = vec4((outFlux_RFU.x + outFlux_LBD.x)*2.0, (outFlux_RFU.y + outFlux_LBD.y)*2.0, (outFlux_RFU.z + outFlux_LBD.z)*2.0, 1.0);\n    float valueAux = newFlux_RFU.x;\n    if(valueAux < 0.5)\n    {\n        shaderLog = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    else if(valueAux > 0.5 && valueAux < 1.0)\n    {\n        shaderLog = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n    else if(valueAux > 1.0 && valueAux < 1.5)\n    {\n        shaderLog = vec4(0.0, 0.0, 1.0, 1.0);\n    }\n    else if(valueAux > 1.5)// && ro < 1.5)\n    {\n        shaderLog = vec4(1.0, 1.0, 0.0, 1.0);\n    }\n    else\n    {\n        shaderLog = vec4(1.0, 0.0, 1.0, 1.0);\n    }\n\n\n    gl_FragData[0] = vec4(encodedOutFlux_RFU_HIGH, voxelSpaceValue);  // RFU flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(encodedOutFlux_RFU_LOW, voxelSpaceValue); // RFU flux low.\n        gl_FragData[2] = vec4(encodedOutFlux_LBD_HIGH, voxelSpaceValue);  // LBD flux high.\n        gl_FragData[3] = vec4(encodedOutFlux_LBD_LOW, voxelSpaceValue);  // LBD flux low.\n        gl_FragData[4] = shaderLog;  // shader log.\n    #endif\n\n}',soundCalculatePressureFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D soundSourceTex_0;\nuniform sampler2D soundSourceTex_1;\nuniform sampler2D soundSourceTex_2;\nuniform sampler2D soundSourceTex_3;\nuniform sampler2D currAirPressureTex_0;\nuniform sampler2D currAirPressureTex_1;\nuniform sampler2D currAirPressureTex_2;\nuniform sampler2D currAirPressureTex_3;\n\nuniform float u_airMaxPressure;\nuniform float u_airEnvirontmentPressure;\nuniform float u_airPressureAlternative;\nuniform int u_processType; // 0= pressure from pressure soyrce. 1= setting air environtment pressure.***\n\nvarying vec2 v_tex_pos;\n\nvec4 packDepth( float v ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nvec4 getFinalAirPressureEncoded(vec4 encodedCurrAirPressure, vec4 encodedSoundSource)\n{\n    float decodedCurrAirPressure = unpackDepth(encodedCurrAirPressure) * u_airMaxPressure;\n    float decodedSourceAirPressure = unpackDepth(encodedSoundSource) * u_airMaxPressure;\n    float finalAirPressure = decodedSourceAirPressure; // init value.***\n    if(finalAirPressure < decodedCurrAirPressure)\n    {\n        finalAirPressure = decodedCurrAirPressure;\n    }\n    vec4 finalAirPressureEncoded = packDepth(finalAirPressure / u_airMaxPressure);\n\n    return finalAirPressureEncoded;\n}\n\nvec4 getFinalAirPressureEncoded_test(vec4 encodedCurrAirPressure, vec4 encodedSoundSource)\n{\n    float decodedCurrAirPressure = unpackDepth(encodedCurrAirPressure) * u_airMaxPressure;\n    float decodedSourceAirPressure = unpackDepth(encodedSoundSource) * u_airMaxPressure;\n    float finalAirPressure = decodedCurrAirPressure; // init value.***\n    if(decodedCurrAirPressure < u_airEnvirontmentPressure)\n    {\n        finalAirPressure = decodedSourceAirPressure;\n    }\n    vec4 finalAirPressureEncoded = packDepth(finalAirPressure / u_airMaxPressure);\n\n    return finalAirPressureEncoded;\n}\n\nvoid main()\n{\n    // 1rst, take the water source.\n    // u_processType == 0= pressure from pressure soyrce. \n    // u_processType == 1= setting air environtment pressure.***\n    if(u_processType == 0)\n    {\n        vec4 currAirPressure = texture2D(currAirPressureTex_0, v_tex_pos);\n        vec4 soundSource = texture2D(soundSourceTex_0, v_tex_pos);\n        gl_FragData[0] = getFinalAirPressureEncoded(currAirPressure, soundSource);\n\n        #ifdef USE_MULTI_RENDER_TARGET\n            currAirPressure = texture2D(currAirPressureTex_1, v_tex_pos);\n            soundSource = texture2D(soundSourceTex_1, v_tex_pos);\n            gl_FragData[1] = getFinalAirPressureEncoded(currAirPressure, soundSource);\n\n            currAirPressure = texture2D(currAirPressureTex_2, v_tex_pos);\n            soundSource = texture2D(soundSourceTex_2, v_tex_pos);\n            gl_FragData[2] = getFinalAirPressureEncoded(currAirPressure, soundSource);\n\n            currAirPressure = texture2D(currAirPressureTex_3, v_tex_pos);\n            soundSource = texture2D(soundSourceTex_3, v_tex_pos);\n            gl_FragData[3] = getFinalAirPressureEncoded(currAirPressure, soundSource);\n        #endif\n    }\n    if(u_processType == 1)\n    {\n        vec4 finalAirPressureEncoded = packDepth(u_airEnvirontmentPressure / u_airMaxPressure);\n        gl_FragData[0] = finalAirPressureEncoded;\n\n        #ifdef USE_MULTI_RENDER_TARGET\n            gl_FragData[1] = finalAirPressureEncoded;\n            gl_FragData[2] = finalAirPressureEncoded;\n            gl_FragData[3] = finalAirPressureEncoded;\n        #endif\n    }\n    if(u_processType == 2)\n    {\n        vec4 currAirPressure = texture2D(currAirPressureTex_0, v_tex_pos);\n        vec4 soundSource = texture2D(soundSourceTex_0, v_tex_pos);\n\n        float decodedCurrAirPressure = unpackDepth(currAirPressure) * u_airMaxPressure;\n        float finalAirPressure = decodedCurrAirPressure;\n        if(soundSource.r > 0.0 || soundSource.g > 0.0 || soundSource.b > 0.0 || soundSource.a > 0.0)\n        {\n            finalAirPressure = u_airPressureAlternative;\n        }\n\n        vec4 finalAirPressureEncoded = packDepth(finalAirPressure / u_airMaxPressure);\n        gl_FragData[0] = finalAirPressureEncoded;\n\n        #ifdef USE_MULTI_RENDER_TARGET\n            gl_FragData[1] = finalAirPressureEncoded;\n            gl_FragData[2] = finalAirPressureEncoded;\n            gl_FragData[3] = finalAirPressureEncoded;\n        #endif\n    }\n    \n}",soundCalculateVelocityFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D airPressureMosaicTex;\nuniform sampler2D flux_RFU_MosaicTex_HIGH; // Inside here, there are the voxelization of the scene (in alpha channel).***\nuniform sampler2D flux_RFU_MosaicTex_LOW;\nuniform sampler2D flux_LBD_MosaicTex_HIGH;\nuniform sampler2D flux_LBD_MosaicTex_LOW;\nuniform sampler2D auxMosaicTex; // here, contains :\n\t// tex_0 = prev airPressureTex\n\t// tex_1 = next airPressureTex\n\t// tex_2 = prev flux_RFU_HIGH\n\t// tex_3 = next flux_RFU_HIGH\n\t// tex_4 = prev flux_RFU_LOW\n\t// tex_5 = next flux_RFU_LOW\n\t// tex_6 = prev flux_LBD_HIGH\n\t// tex_7 = next flux_LBD_HIGH\n\t// tex_8 = prev flux_LBD_LOW\n\t// tex_9 = next flux_LBD_LOW\n\n\t//  \n\t//      +-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |     \n\t//      |   tex_8   |   tex_9   |  nothing  |  nothing  |\n\t//      |           |           |           |           | \n\t//      +-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           | \n\t//      |   tex_4   |   tex_5   |   tex_6   |   tex_7   |\n\t//      |           |           |           |           |\n\t//      +-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |    \n\t//      |   tex_0   |   tex_1   |   tex_2   |   tex_3   | \n\t//      |           |           |           |           |\n\t//      +-----------+-----------+-----------+-----------+\nuniform sampler2D maxPressureMosaicTex;\n\nuniform int u_texSize[3]; // The original texture3D size.***\nuniform int u_mosaicTexSize[3]; // The mosaic texture size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_lowestMosaicSliceIndex;\n\nvarying vec2 v_tex_pos;\n\nuniform float u_timestep;\n\n//uniform vec2 u_tileSize; // tile size in meters.\nuniform vec3 u_voxelSizeMeters;\nuniform float u_airMaxPressure;\nuniform float u_airEnvirontmentPressure;\nuniform float u_maxFlux;\nuniform float u_maxVelocity;\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\n\nvec3 encodeVelocity(in vec3 vel)\n{\n\treturn vel*0.5 + 0.5;\n}\n\nvec3 decodeVelocity(in vec3 encodedVel)\n{\n\treturn vec3(encodedVel * 2.0 - 1.0);\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col, in int row)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    float s = float(col) * sRange + subTexCoord.x * sRange;\n    float t = float(row) * tRange + subTexCoord.y * tRange;\n\n    vec2 resultTexCoord = vec2(s, t);\n    return resultTexCoord;\n}\n\nvec2 getColRow_and_subTexCoord(in vec2 texCoord, inout vec2 subTexCoord)\n{\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    // Determine the [col, row] of the mosaic.***\n    vec2 resultColRow = vec2(floor(texCoord.x / sRange), floor(texCoord.y / tRange));\n\n    // determine the subTexCoord.***\n    float col_mod = texCoord.x - resultColRow.x * sRange;\n    float row_mod = texCoord.y - resultColRow.y * tRange;\n    float s = col_mod / sRange;\n    float t = row_mod / tRange;\n    subTexCoord = vec2(s, t);\n\n    return resultColRow;\n}\n\nfloat getAirPressure_inMosaicTexture(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(airPressureMosaicTex, texCoord);\n    float decoded = unpackDepth(color4); // 32bit.\n    float airPressure = decoded * u_airMaxPressure;\n\n    return airPressure;\n}\n\nfloat getAirPressure_inMaxPressureMosaicTexture(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(maxPressureMosaicTex, texCoord);\n    float decoded = unpackDepth(color4); // 32bit.\n    float airPressure = decoded * u_airMaxPressure;\n\n    return airPressure;\n}\n\nfloat getAirPressure_inAuxMosaicTexture(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(auxMosaicTex, texCoord);\n    float decoded = unpackDepth(color4); // 32bit.\n    float airPressure = decoded * u_airMaxPressure;\n\n    return airPressure;\n}\n\nbool getPrevSubTextureColRow(in int col, in int row, inout int prev_col, inout int prev_row)\n{\n    // u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    prev_row = row;\n    if(col == 0)\n    {\n        prev_col = u_mosaicSize[0] - 1;\n        prev_row = row - 1;\n\n        // now, check if the prev_row is inside of the boundary.***\n        if(prev_row < 0)\n        {\n            // we are outside of the tex3d boundary.***\n            return false;\n        }\n    }\n    else\n    {\n        prev_col = col - 1;\n    }\n    return true;\n}\n\nbool getNextSubTextureColRow(in int col, in int row, inout int next_col, inout int next_row)\n{\n    // u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    next_row = row;\n    if(col == u_mosaicSize[0] - 1) // is last column.***\n    {\n        next_col = 0;\n        next_row = row + 1;\n\n        // now, check if the next_row is inside of the boundary.***\n        if(next_row > u_mosaicSize[1] - 1) // is greater than last row.***\n        {\n            // we are outside of the tex3d boundary.***\n            return false;\n        }\n    }\n    else\n    {\n        next_col = col + 1;\n    }\n\n    // Must check : some times, no all textures of the last row is used.***\n    int sliceIdx = next_row * u_mosaicSize[0] + next_col;\n    if(sliceIdx > u_texSize[2]-1)\n    {\n        return false;\n    }\n\n    return true;\n}\n\nfloat getAirPressure(in vec2 texCoord, inout vec3 airPressure_RFU, inout vec3 airPressure_LBD, inout vec3 voxelSpaceType_RFU, inout vec3 voxelSpaceType_LBD)\n{\n    // **********************************************************************\n    // Note : this function returns the airPressure of all 6 Neighbor too.***\n    // **********************************************************************\n    vec2 subTexCoord;\n    vec2 colRow = getColRow_and_subTexCoord(texCoord, subTexCoord);\n\n    float col = colRow.x;\n    float row = colRow.y;\n    int col_int = int(col);\n    int row_int = int(row);\n\n    float divSubX = 1.0 / float(u_texSize[0]); // divX for subTexture.***\n    float divSubY = 1.0 / float(u_texSize[1]); // divX for subTexture.***\n\n    // airPressure_curr.*********************************************************************\n    float airPressure_curr = getAirPressure_inMosaicTexture(texCoord);\n\n    // airPressure_R.************************************************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_R = subTexCoord + vec2(divSubX, 0.0);\n    if(subTexCoord_R.x > 1.0)\n    {\n        // is out of simulation boundary.***\n        airPressure_RFU.x = u_airEnvirontmentPressure;\n\n        // the voxelSpaceType is 0 (void).***\n        voxelSpaceType_RFU.x = 0.0;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_R:\n        vec2 mosaicTexCoord_R = subTexCoord_to_texCoord(subTexCoord_R, col_int, row_int);\n        airPressure_RFU.x = getAirPressure_inMosaicTexture(mosaicTexCoord_R);\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, mosaicTexCoord_R);\n        voxelSpaceType_RFU.x = color4_RFU_HIGH.a;\n    }\n\n    // airPressure_F.************************************************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_F = subTexCoord + vec2(0.0, divSubY);\n    if(subTexCoord_F.y > 1.0)\n    {\n        // is out of simulation boundary.***\n        airPressure_RFU.y = u_airEnvirontmentPressure;\n\n        // the voxelSpaceType is 0 (void).***\n        voxelSpaceType_RFU.y = 0.0;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_F:\n        vec2 mosaicTexCoord_F = subTexCoord_to_texCoord(subTexCoord_F, col_int, row_int);\n        airPressure_RFU.y = getAirPressure_inMosaicTexture(mosaicTexCoord_F);\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, mosaicTexCoord_F);\n        voxelSpaceType_RFU.y = color4_RFU_HIGH.a;\n    }\n\n    // airPressure_U.************************************************************************\n    // To calculate the airPressure_U, must know the UP_subTexrure (NEXT subTexure).***\n    // But, if the current subTexture is in right_up_corner, then must use the "auxMosaicTex".***\n    // use the next subTexture.***\n    int next_col;\n    int next_row;\n    if(getNextSubTextureColRow(col_int, row_int, next_col, next_row))\n    {\n        // must recalcuate the mosaicTexCoord.***\n        vec2 newMosaicTexCoord = subTexCoord_to_texCoord(subTexCoord, next_col, next_row);\n        airPressure_RFU.z = getAirPressure_inMosaicTexture(newMosaicTexCoord); \n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, newMosaicTexCoord);\n        voxelSpaceType_RFU.z = color4_RFU_HIGH.a;\n    }\n    else\n    {\n        // Is out of this slice.***\n        // Must use the "auxMosaicTex". This is a [4, 3] mosaic texture.***\n        // tex_1 = next airPressureTex. this in [col 1, row 0] into "auxMosaicTex".***\n        // Must calculate the texCoords of auxMosaicTex.***\n\n        float sRange_aux = 1.0 / 4.0;\n        float tRange_aux = 1.0 / 3.0;\n\n        float col_aux = 1.0;\n        float row_aux = 0.0;\n\n        float s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        float t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        vec2 texCoord_auxMosaicTex = vec2(s, t);\n        //airPressure_RFU.z = getAirPressure_inAuxMosaicTexture(texCoord_auxMosaicTex);\n        airPressure_RFU.z = u_airEnvirontmentPressure; // test delete.***\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        //vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, texCoord_auxMosaicTex); // error! Cannot use "texCoord_auxMosaicTex" in "flux_RFU_MosaicTex_HIGH" texture!!!\n        //voxelSpaceType_RFU.z = color4_RFU_HIGH.a;\n        voxelSpaceType_RFU.z = 0.0;\n        \n    }\n    //--------------------------------------------------------------------------------------------------------------\n    //--------------------------------------------------------------------------------------------------------------\n\n    // airPressure_L.************************************************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_L = subTexCoord + vec2(-divSubX, 0.0);\n    if(subTexCoord_L.x < 0.0)\n    {\n        // is out of simulation boundary.***\n        airPressure_LBD.x = u_airEnvirontmentPressure;\n\n        // the voxelSpaceType is 0 (void).***\n        voxelSpaceType_LBD.x = 0.0;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_L:\n        vec2 mosaicTexCoord_L = subTexCoord_to_texCoord(subTexCoord_L, col_int, row_int);\n        airPressure_LBD.x = getAirPressure_inMosaicTexture(mosaicTexCoord_L);\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, mosaicTexCoord_L);\n        voxelSpaceType_LBD.x = color4_RFU_HIGH.a;\n    }\n\n    // airPressure_B.************************************************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_B = subTexCoord + vec2(0.0, -divSubY);\n    if(subTexCoord_B.y < 0.0)\n    {\n        // is out of simulation boundary.***\n        airPressure_LBD.y = u_airEnvirontmentPressure;\n\n        // the voxelSpaceType is 0 (void).***\n        voxelSpaceType_LBD.y = 0.0;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_B:\n        vec2 mosaicTexCoord_B = subTexCoord_to_texCoord(subTexCoord_B, col_int, row_int);\n        airPressure_LBD.y = getAirPressure_inMosaicTexture(mosaicTexCoord_B);\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, mosaicTexCoord_B);\n        voxelSpaceType_LBD.y = color4_RFU_HIGH.a;\n    }\n\n    // airPressure_D.************************************************************************\n    // To calculate the airPressure_D, must know the UP_subTexrure (PREV subTexure).***\n    // But, if the current subTexture is in left_down_corner, then must use the "auxMosaicTex".***\n    // use the next subTexture.***\n    int prev_col;\n    int prev_row;\n    if(getPrevSubTextureColRow(col_int, row_int, prev_col, prev_row))\n    {\n        // must recalcuate the mosaicTexCoord.***\n        vec2 newMosaicTexCoord = subTexCoord_to_texCoord(subTexCoord, prev_col, prev_row);\n        airPressure_LBD.z = getAirPressure_inMosaicTexture(newMosaicTexCoord); \n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, newMosaicTexCoord);\n        voxelSpaceType_LBD.z = color4_RFU_HIGH.a;\n    }\n    else\n    {\n        // Is out of simulation boundary.***\n        // Must use the "auxMosaicTex". This is a [4, 3] mosaic texture.***\n        // tex_1 = next airPressureTex. this in [col 0, row 0] into "auxMosaicTex".***\n        // Must calculate the texCoords of auxMosaicTex.***\n\n        float sRange_aux = 1.0 / 4.0;\n        float tRange_aux = 1.0 / 3.0;\n\n        float col_aux = 0.0;\n        float row_aux = 0.0;\n\n        float s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        float t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        vec2 texCoord_auxMosaicTex = vec2(s, t);\n        //airPressure_LBD.z = getAirPressure_inAuxMosaicTexture(texCoord_auxMosaicTex);\n        airPressure_LBD.z = u_airEnvirontmentPressure; // test delete.***\n\n        // Now, read flux_RFU_HIGH to calculate the voxelSpaceType.***\n        //vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, texCoord_auxMosaicTex); // error! Cannot use "texCoord_auxMosaicTex" in "flux_RFU_MosaicTex_HIGH" texture!!!\n        //voxelSpaceType_LBD.z = color4_RFU_HIGH.a;\n        voxelSpaceType_LBD.z = 0.0;\n        \n    }\n    //--------------------------------------------------------------------------------------------------------------\n    //--------------------------------------------------------------------------------------------------------------\n\n    return airPressure_curr;\n}\n\n\nvoid encodeFlux(in vec3 flux, inout vec3 flux_HIGH, inout vec3 flux_LOW)\n{\n    vec2 encoded_a_flux = encodeRG(flux.x);\n    vec2 encoded_b_flux = encodeRG(flux.y);\n    vec2 encoded_c_flux = encodeRG(flux.z);\n\n    flux_HIGH = vec3(encoded_a_flux.x, encoded_b_flux.x, encoded_c_flux.x);\n    flux_LOW = vec3(encoded_a_flux.y, encoded_b_flux.y, encoded_c_flux.y);\n}\n\nvoid getFlux(in vec2 texCoord, inout vec3 flux_RFU, inout vec3 flux_LBD)\n{\n    // This function returns Outing flux.***\n    vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, texCoord);\n    vec4 color4_RFU_LOW = texture2D(flux_RFU_MosaicTex_LOW, texCoord);\n    vec4 color4_LBD_HIGH = texture2D(flux_LBD_MosaicTex_HIGH, texCoord);\n    vec4 color4_LBD_LOW = texture2D(flux_LBD_MosaicTex_LOW, texCoord);\n\n    // now, decode all fluxes.***\n    flux_RFU.r = decodeRG(vec2(color4_RFU_HIGH.r, color4_RFU_LOW.r)) * u_maxFlux; // flux_R.\n    flux_RFU.g = decodeRG(vec2(color4_RFU_HIGH.g, color4_RFU_LOW.g)) * u_maxFlux; // flux_F.\n    flux_RFU.b = decodeRG(vec2(color4_RFU_HIGH.b, color4_RFU_LOW.b)) * u_maxFlux; // flux_U.\n\n    flux_LBD.r = decodeRG(vec2(color4_LBD_HIGH.r, color4_LBD_LOW.r)) * u_maxFlux; // flux_L.\n    flux_LBD.g = decodeRG(vec2(color4_LBD_HIGH.g, color4_LBD_LOW.g)) * u_maxFlux; // flux_B.\n    flux_LBD.b = decodeRG(vec2(color4_LBD_HIGH.b, color4_LBD_LOW.b)) * u_maxFlux; // flux_D.\n}\n\nvoid getFlux_ofAll6Neighbor(in vec2 texCoord, inout vec3 flux_neighbor_R_RFU, inout vec3 flux_neighbor_R_LBD, \n                                                inout vec3 flux_neighbor_F_RFU, inout vec3 flux_neighbor_F_LBD, \n                                                inout vec3 flux_neighbor_U_RFU, inout vec3 flux_neighbor_U_LBD,\n\n                                                inout vec3 flux_neighbor_L_RFU, inout vec3 flux_neighbor_L_LBD, \n                                                inout vec3 flux_neighbor_B_RFU, inout vec3 flux_neighbor_B_LBD, \n                                                inout vec3 flux_neighbor_D_RFU, inout vec3 flux_neighbor_D_LBD)\n{\n    // this function returns the flux of all 6 neighbor pixels.****\n    vec2 subTexCoord;\n    vec2 colRow = getColRow_and_subTexCoord(texCoord, subTexCoord);\n\n    float col = colRow.x;\n    float row = colRow.y;\n    int col_int = int(col);\n    int row_int = int(row);\n\n    float divSubX = 1.0 / float(u_texSize[0]); // divX for subTexture.***\n    float divSubY = 1.0 / float(u_texSize[1]); // divX for subTexture.***\n    //----------------------------------------------------------------------------------\n\n    vec3 colorZero = vec3(0.0); // original.***\n\n    // flux_R. This is the flux of the right pixel.***********************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_R = subTexCoord + vec2(divSubX, 0.0);\n    if(subTexCoord_R.x > 1.0)\n    {\n        // is out of simulation boundary.***\n        flux_neighbor_R_RFU = colorZero;\n        flux_neighbor_R_LBD = colorZero;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_R:\n        vec2 mosaicTexCoord_R = subTexCoord_to_texCoord(subTexCoord_R, col_int, row_int);\n        getFlux(mosaicTexCoord_R, flux_neighbor_R_RFU, flux_neighbor_R_LBD);\n    }\n\n    // flux_F. This is the flux of the front pixel.************************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_F = subTexCoord + vec2(0.0, divSubY);\n    if(subTexCoord_F.y > 1.0)\n    {\n        // is out of simulation boundary.***\n        flux_neighbor_F_RFU = colorZero;\n        flux_neighbor_F_LBD = colorZero;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_F:\n        vec2 mosaicTexCoord_F = subTexCoord_to_texCoord(subTexCoord_F, col_int, row_int);\n        getFlux(mosaicTexCoord_F, flux_neighbor_F_RFU, flux_neighbor_F_LBD);\n    }\n\n    // flux_U. This is the flux of the up pixel.****************************************\n    // To calculate the flux_U, must know the UP_subTexrure (NEXT subTexure).***\n    // But, if the current subTexture is in right_up_corner, then must use the "auxMosaicTex".***\n    // use the next subTexture.***\n    int next_col;\n    int next_row;\n    if(getNextSubTextureColRow(col_int, row_int, next_col, next_row))\n    {\n        // must recalcuate the mosaicTexCoord.***\n        vec2 newMosaicTexCoord = subTexCoord_to_texCoord(subTexCoord, next_col, next_row);\n        getFlux(newMosaicTexCoord, flux_neighbor_U_RFU, flux_neighbor_U_LBD);\n    }\n    else\n    {\n        \t// tex_0 = prev airPressureTex\n            // tex_1 = next airPressureTex\n            // tex_2 = prev flux_RFU_HIGH\n            // tex_3 = next flux_RFU_HIGH\n            // tex_4 = prev flux_RFU_LOW\n            // tex_5 = next flux_RFU_LOW\n            // tex_6 = prev flux_LBD_HIGH\n            // tex_7 = next flux_LBD_HIGH\n            // tex_8 = prev flux_LBD_LOW\n            // tex_9 = next flux_LBD_LOW\n\n            //  \n            //      +-----------+-----------+-----------+-----------+\n            //      |           |           |           |           |     \n            //      |   tex_8   |   tex_9   |  nothing  |  nothing  |\n            //      |           |           |           |           | \n            //      +-----------+-----------+-----------+-----------+\n            //      |           |           |           |           | \n            //      |   tex_4   |   tex_5   |   tex_6   |   tex_7   |\n            //      |           |           |           |           |\n            //      +-----------+-----------+-----------+-----------+\n            //      |           |           |           |           |    \n            //      |   tex_0   |   tex_1   |   tex_2   |   tex_3   | \n            //      |           |           |           |           |\n            //      +-----------+-----------+-----------+-----------+\n\n        // Is out of simulation boundary.***\n        // Must use the "auxMosaicTex". This is a [4, 3] mosaic texture.***\n        // tex_3 = next flux_RFU_HIGH. this in [col 3, row 0] into "auxMosaicTex".***\n        // tex_5 = next flux_RFU_LOW. this in [col 1, row 1] into "auxMosaicTex".***\n        // tex_7 = next flux_LBD_HIGH. this in [col 3, row 1] into "auxMosaicTex".***\n        // tex_9 = next flux_LBD_LOW. this in [col 1, row 2] into "auxMosaicTex".***\n        // Must calculate the texCoords of auxMosaicTex.***\n\n        float sRange_aux = 1.0 / 4.0;\n        float tRange_aux = 1.0 / 3.0;\n\n        // tex_3 = next flux_RFU_HIGH.***\n        float col_aux = 3.0;\n        float row_aux = 0.0;\n\n        float s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        float t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        vec2 texCoord_auxMosaicTex = vec2(s, t);\n        vec4 color4_RFU_HIGH = texture2D(auxMosaicTex, texCoord_auxMosaicTex);\n\n        // tex_5 = next flux_RFU_LOW.***\n        col_aux = 1.0;\n        row_aux = 1.0;\n\n        s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        texCoord_auxMosaicTex = vec2(s, t);\n        vec4 color4_RFU_LOW = texture2D(auxMosaicTex, texCoord_auxMosaicTex);\n        \n        // tex_7 = next flux_LBD_HIGH.***\n        col_aux = 3.0;\n        row_aux = 1.0;\n\n        s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        texCoord_auxMosaicTex = vec2(s, t);\n        vec4 color4_LBD_HIGH = texture2D(auxMosaicTex, texCoord_auxMosaicTex);\n\n        // tex_9 = next flux_LBD_LOW.***\n        col_aux = 1.0;\n        row_aux = 2.0;\n\n        s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        texCoord_auxMosaicTex = vec2(s, t);\n        vec4 color4_LBD_LOW = texture2D(auxMosaicTex, texCoord_auxMosaicTex);\n\n        // Now, with the 4 color4, decode the flux.***\n        flux_neighbor_U_RFU.r = decodeRG(vec2(color4_RFU_HIGH.r, color4_RFU_LOW.r)) * u_maxFlux; // flux_R.\n        flux_neighbor_U_RFU.g = decodeRG(vec2(color4_RFU_HIGH.g, color4_RFU_LOW.g)) * u_maxFlux; // flux_F.\n        flux_neighbor_U_RFU.b = decodeRG(vec2(color4_RFU_HIGH.b, color4_RFU_LOW.b)) * u_maxFlux; // flux_U.\n\n        flux_neighbor_U_LBD.r = decodeRG(vec2(color4_LBD_HIGH.r, color4_LBD_LOW.r)) * u_maxFlux; // flux_L.\n        flux_neighbor_U_LBD.g = decodeRG(vec2(color4_LBD_HIGH.g, color4_LBD_LOW.g)) * u_maxFlux; // flux_B.\n        flux_neighbor_U_LBD.b = decodeRG(vec2(color4_LBD_HIGH.b, color4_LBD_LOW.b)) * u_maxFlux; // flux_D.\n\n        ////flux_neighbor_U_RFU.r = 0.0; // flux_R.\n        ////flux_neighbor_U_RFU.g = 0.0; // flux_F.\n        ////flux_neighbor_U_RFU.b = 0.0; // flux_U.\n\n        ////flux_neighbor_U_LBD.r = 0.0; // flux_L.\n        ////flux_neighbor_U_LBD.g = 0.0; // flux_B.\n        ////flux_neighbor_U_LBD.b = 0.0; // flux_D.\n    }\n    //--------------------------------------------------------------------------------------------------------------\n    //--------------------------------------------------------------------------------------------------------------\n\n    // flux_L. This is the flux of the left pixel**********************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_L = subTexCoord + vec2(-divSubX, 0.0);\n    if(subTexCoord_L.x < 0.0)\n    {\n        // is out of simulation boundary.***\n        flux_neighbor_L_RFU = colorZero;\n        flux_neighbor_L_LBD = colorZero;\n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_L:\n        vec2 mosaicTexCoord_L = subTexCoord_to_texCoord(subTexCoord_L, col_int, row_int);\n        getFlux(mosaicTexCoord_L, flux_neighbor_L_RFU, flux_neighbor_L_LBD);\n    }\n\n    // flux_B. This is the flux of the back pixel.********************************\n    // calculate the subTexCoord to check boundary conditions.***\n    vec2 subTexCoord_B = subTexCoord + vec2(0.0, -divSubY);\n    if(subTexCoord_B.y < 0.0)\n    {\n        // is out of simulation boundary.***\n        flux_neighbor_B_RFU = colorZero;\n        flux_neighbor_B_LBD = colorZero;\n        \n    }\n    else\n    {\n        // calculate the mosaicTexCoord of the subTexCoord_B:\n        vec2 mosaicTexCoord_B = subTexCoord_to_texCoord(subTexCoord_B, col_int, row_int);\n        getFlux(mosaicTexCoord_B, flux_neighbor_B_RFU, flux_neighbor_B_LBD);\n    }\n\n    // flux_D. This is the flux of the down pixel.*************************************\n    // To calculate the flux_D, must know the UP_subTexrure (PREV subTexure).***\n    // But, if the current subTexture is in left_down_corner, then must use the "auxMosaicTex".***\n    // use the next subTexture.***\n    int prev_col;\n    int prev_row;\n    if(getPrevSubTextureColRow(col_int, row_int, prev_col, prev_row))\n    {\n        // must recalcuate the mosaicTexCoord.***\n        vec2 newMosaicTexCoord = subTexCoord_to_texCoord(subTexCoord, prev_col, prev_row);\n        getFlux(newMosaicTexCoord, flux_neighbor_D_RFU, flux_neighbor_D_LBD);\n    }\n    else\n    {\n        // tex_0 = prev airPressureTex\n        // tex_1 = next airPressureTex\n        // tex_2 = prev flux_RFU_HIGH\n        // tex_3 = next flux_RFU_HIGH\n        // tex_4 = prev flux_RFU_LOW\n        // tex_5 = next flux_RFU_LOW\n        // tex_6 = prev flux_LBD_HIGH\n        // tex_7 = next flux_LBD_HIGH\n        // tex_8 = prev flux_LBD_LOW\n        // tex_9 = next flux_LBD_LOW\n\n        //  \n        //      +-----------+-----------+-----------+-----------+\n        //      |           |           |           |           |     \n        //      |   tex_8   |   tex_9   |  nothing  |  nothing  |\n        //      |           |           |           |           | \n        //      +-----------+-----------+-----------+-----------+\n        //      |           |           |           |           | \n        //      |   tex_4   |   tex_5   |   tex_6   |   tex_7   |\n        //      |           |           |           |           |\n        //      +-----------+-----------+-----------+-----------+\n        //      |           |           |           |           |    \n        //      |   tex_0   |   tex_1   |   tex_2   |   tex_3   | \n        //      |           |           |           |           |\n        //      +-----------+-----------+-----------+-----------+\n\n        // Is out of simulation boundary.***\n        // Must use the "auxMosaicTex". This is a [4, 3] mosaic texture.***\n        // tex_2 = prev flux_RFU_HIGH. this in [col 2, row 0] into "auxMosaicTex".***\n        // tex_4 = prev flux_RFU_LOW. this in [col 0, row 1] into "auxMosaicTex".***\n        // tex_6 = prev flux_LBD_HIGH. this in [col 2, row 1] into "auxMosaicTex".***\n        // tex_8 = prev flux_LBD_LOW. this in [col 0, row 2] into "auxMosaicTex".***\n        // Must calculate the texCoords of auxMosaicTex.***\n\n        float sRange_aux = 1.0 / 4.0;\n        float tRange_aux = 1.0 / 3.0;\n\n        // tex_2 = prev flux_RFU_HIGH.***\n        float col_aux = 2.0;\n        float row_aux = 0.0;\n\n        float s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        float t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        vec2 texCoord_auxMosaicTex = vec2(s, t);\n        vec4 color4_RFU_HIGH = texture2D(auxMosaicTex, texCoord_auxMosaicTex);\n\n        // tex_4 = prev flux_RFU_LOW.***\n        col_aux = 0.0;\n        row_aux = 1.0;\n\n        s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        texCoord_auxMosaicTex = vec2(s, t);\n        vec4 color4_RFU_LOW = texture2D(auxMosaicTex, texCoord_auxMosaicTex);\n        \n        // tex_6 = prev flux_LBD_HIGH.***\n        col_aux = 2.0;\n        row_aux = 1.0;\n\n        s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        texCoord_auxMosaicTex = vec2(s, t);\n        vec4 color4_LBD_HIGH = texture2D(auxMosaicTex, texCoord_auxMosaicTex);\n\n        // tex_8 = prev flux_LBD_LOW.***\n        col_aux = 0.0;\n        row_aux = 2.0;\n\n        s = col_aux * sRange_aux + subTexCoord.x * sRange_aux;\n        t = row_aux * tRange_aux + subTexCoord.y * tRange_aux;\n\n        texCoord_auxMosaicTex = vec2(s, t);\n        vec4 color4_LBD_LOW = texture2D(auxMosaicTex, texCoord_auxMosaicTex);\n\n        // Now, with the 4 color4, decode the flux.***\n        flux_neighbor_D_RFU.r = decodeRG(vec2(color4_RFU_HIGH.r, color4_RFU_LOW.r)) * u_maxFlux; // flux_R.\n        flux_neighbor_D_RFU.g = decodeRG(vec2(color4_RFU_HIGH.g, color4_RFU_LOW.g)) * u_maxFlux; // flux_F.\n        flux_neighbor_D_RFU.b = decodeRG(vec2(color4_RFU_HIGH.b, color4_RFU_LOW.b)) * u_maxFlux; // flux_U.\n\n        flux_neighbor_D_LBD.r = decodeRG(vec2(color4_LBD_HIGH.r, color4_LBD_LOW.r)) * u_maxFlux; // flux_L.\n        flux_neighbor_D_LBD.g = decodeRG(vec2(color4_LBD_HIGH.g, color4_LBD_LOW.g)) * u_maxFlux; // flux_B.\n        flux_neighbor_D_LBD.b = decodeRG(vec2(color4_LBD_HIGH.b, color4_LBD_LOW.b)) * u_maxFlux; // flux_D.\n\n        ////flux_neighbor_D_RFU.r = 0.0; // flux_R.\n        ////flux_neighbor_D_RFU.g = 0.0; // flux_F.\n        ////flux_neighbor_D_RFU.b = 0.0; // flux_U.\n\n        ////flux_neighbor_D_LBD.r = 0.0; // flux_L.\n        ////flux_neighbor_D_LBD.g = 0.0; // flux_B.\n        ////flux_neighbor_D_LBD.b = 0.0; // flux_D.\n    }\n    //--------------------------------------------------------------------------------------------------------------\n    //--------------------------------------------------------------------------------------------------------------\n}\n\nvoid getInputFlux(in vec2 texCoord, inout vec3 input_flux_RFU, inout vec3 input_flux_LBD)\n{\n    // 1rst, must find all 6 neighbor fluxes.***\n    vec3 flux_neighbor_R_RFU, flux_neighbor_R_LBD;\n    vec3 flux_neighbor_F_RFU, flux_neighbor_F_LBD; \n    vec3 flux_neighbor_U_RFU, flux_neighbor_U_LBD;\n\n    vec3 flux_neighbor_L_RFU, flux_neighbor_L_LBD; \n    vec3 flux_neighbor_B_RFU, flux_neighbor_B_LBD; \n    vec3 flux_neighbor_D_RFU, flux_neighbor_D_LBD;\n\n    getFlux_ofAll6Neighbor(texCoord, flux_neighbor_R_RFU, flux_neighbor_R_LBD, \n                                    flux_neighbor_F_RFU, flux_neighbor_F_LBD, \n                                    flux_neighbor_U_RFU, flux_neighbor_U_LBD,\n\n                                    flux_neighbor_L_RFU, flux_neighbor_L_LBD, \n                                    flux_neighbor_B_RFU, flux_neighbor_B_LBD, \n                                    flux_neighbor_D_RFU, flux_neighbor_D_LBD);\n\n    // Now, for each flux, take only the flux that incomes to me.***\n    input_flux_LBD.x = flux_neighbor_L_RFU.x;\n    input_flux_LBD.y = flux_neighbor_B_RFU.y;\n    input_flux_LBD.z = flux_neighbor_D_RFU.z;\n\n    input_flux_RFU.x = flux_neighbor_R_LBD.x;\n    input_flux_RFU.y = flux_neighbor_F_LBD.y;\n    input_flux_RFU.z = flux_neighbor_U_LBD.z;\n\n}\n\nfloat getVoxelSpaceValue(in vec2 texCoord)\n{\n    // The scene voxelMatrix is into flux_RFU_MosaicTex_HIGH, in alpha channel.***\n    vec4 color4_RFU_HIGH = texture2D(flux_RFU_MosaicTex_HIGH, texCoord);\n    return color4_RFU_HIGH.a;\n}\n\nfloat getAirMass_kg(in float P_Atm, in float V_m3, in float T_Kelvin)\n{\n    // Remembering.*************************************************************************************************************************\n    // "ecuacion propagacion sonido" => https://openstax.org/books/f%C3%ADsica-universitaria-volumen-1/pages/17-2-velocidad-del-sonido\n    // https://en.wikipedia.org/wiki/Density_of_air#:~:text=At%20101.325%20kPa%20(abs)%20and,International%20Standard%20Atmosphere%20(ISA).\n    // P1 * V1 = P2 * V2.***\n    // airDensity ro = ρ = 1.225 [kg/m3]\n    // airMolarMass = 0.02897 [Kg/mol]\n    // universalGasConstant R = 8.31446261815324 [J/(K*mol)], [m3*Pa/(K*mol)], [Kg*m2/(s2*K*mol)]\n    // airPressure at sea level = 101325 Pa = 101.325 kPa = 1013.25 hPa ≈ 1 bar\n    // Standard temperature at sea level is T = 288.15K\n    // Number of Avogadro n = 6.022 * 10E23\n    // Masa molar air = 29kg/kmol\n    // -------------------------------------------------------------------------------------------------------------------------------------\n\n    // P = pressure(Atm), V = volume (m3), T = temperature (K).***\n    float atmToPa = 101325.0;// 1 atm = 101325 Pa.***\n    float P_Pa = P_Atm * atmToPa; \n    float R = 8.31446261815324;\n    float n = P_Pa * V_m3 / (R * T_Kelvin); // number of air mols.***\n    float molarMassAir = 29.0; // kg/kmol.\n    float airMass = n/1000.0 * molarMassAir; // kg.***\n    return airMass;\n}\n\n//float getAirPressure_Atm(in float airDensity_kgm3, in float V_m3, in float T_Kelvin)\n//{\n\n//}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n\n    // check if this is solid voxel.***\n    float voxelSpaceValue = getVoxelSpaceValue(v_tex_pos);\n    if(voxelSpaceValue > 0.0)\n    {\n        // This is solid voxel.***\n        gl_FragData[0] = vec4(0.0);  // air pressure. Original.***\n\n        #ifdef USE_MULTI_RENDER_TARGET\n            gl_FragData[1] = vec4(0.0); // velocity\n            gl_FragData[2] = vec4(0.0);  // shader log.\n        #endif\n        return;\n    }\n\n    // Determine the airPressure of the 6 fragment that is around of current fragment.***\n    vec3 voxelSpaceType_RFU;\n    vec3 voxelSpaceType_LBD;\n    vec3 airPressure_RFU;\n    vec3 airPressure_LBD;\n    float airPressure_curr = getAirPressure(v_tex_pos, airPressure_RFU, airPressure_LBD, voxelSpaceType_RFU, voxelSpaceType_LBD);\n\n    vec3 currFlux_RFU;\n    vec3 currFlux_LBD;\n    getFlux(v_tex_pos, currFlux_RFU, currFlux_LBD); // this is output flux.***\n\n    // calculate the input flux.***\n    vec3 input_flux_RFU, input_flux_LBD;\n    getInputFlux(v_tex_pos, input_flux_RFU, input_flux_LBD);\n\n    if(voxelSpaceType_RFU.x > 0.0)\n    {\n        input_flux_RFU.x = 0.0;\n        currFlux_RFU.x = 0.0;\n    }\n\n    if(voxelSpaceType_RFU.y > 0.0)\n    {\n        input_flux_RFU.y = 0.0;\n        currFlux_RFU.y = 0.0;\n    }\n\n    if(voxelSpaceType_RFU.z > 0.0)\n    {\n        input_flux_RFU.z = 0.0;\n        currFlux_RFU.z = 0.0;\n    }\n\n    if(voxelSpaceType_LBD.x > 0.0)\n    {\n        input_flux_LBD.x = 0.0;\n        currFlux_LBD.x = 0.0;\n    }\n\n    if(voxelSpaceType_LBD.y > 0.0)\n    {\n        input_flux_LBD.y = 0.0;\n        currFlux_LBD.y = 0.0;\n    }\n\n    if(voxelSpaceType_LBD.z > 0.0)\n    {\n        input_flux_LBD.z = 0.0;\n        currFlux_LBD.z = 0.0;\n    }\n\n    // Now, calculate the input pressure.***\n    float voxelFaceArea = u_voxelSizeMeters.x * u_voxelSizeMeters.y;\n    float cellVolume = u_voxelSizeMeters.x * u_voxelSizeMeters.y * u_voxelSizeMeters.z ;\n    float timeStep_divCellArea = u_timestep / voxelFaceArea;\n\n    // calculate the curr density & RFULBD densities, then calculate the delta_air_kg & then can calculate the new air pressure.***\n    float T = 288.15; // Kelvins.***\n    float P_Atm = airPressure_curr;\n    float curr_airMass_kg = getAirMass_kg(P_Atm, cellVolume, T);\n    float curr_ro = curr_airMass_kg / cellVolume;\n\n    float P_Atm_R = airPressure_RFU.x;\n    float airMass_kg_R = getAirMass_kg(P_Atm_R, cellVolume, T);\n    float ro_R = airMass_kg_R / cellVolume;\n\n    float P_Atm_F = airPressure_RFU.y;\n    float airMass_kg_F = getAirMass_kg(P_Atm_F, cellVolume, T);\n    float ro_F = airMass_kg_F / cellVolume;\n\n    float P_Atm_U = airPressure_RFU.z;\n    float airMass_kg_U = getAirMass_kg(P_Atm_U, cellVolume, T);\n    float ro_U = airMass_kg_U / cellVolume;\n\n    float P_Atm_L = airPressure_LBD.x;\n    float airMass_kg_L = getAirMass_kg(P_Atm_L, cellVolume, T);\n    float ro_L = airMass_kg_L / cellVolume;\n\n    float P_Atm_B = airPressure_LBD.y;\n    float airMass_kg_B = getAirMass_kg(P_Atm_B, cellVolume, T);\n    float ro_B = airMass_kg_B / cellVolume;\n\n    float P_Atm_D = airPressure_LBD.z;\n    float airMass_kg_D = getAirMass_kg(P_Atm_D, cellVolume, T);\n    float ro_D = airMass_kg_D / cellVolume;\n\n    ////vec3 input_air_RFU = input_flux_RFU * timeStep_divCellArea;\n    ////vec3 input_air_LBD = input_flux_LBD * timeStep_divCellArea;\n    ////vec3 output_air_RFU = currFlux_RFU * timeStep_divCellArea;\n    ////vec3 output_air_LBD = currFlux_LBD * timeStep_divCellArea;\n\n    vec3 input_air_RFU = input_flux_RFU * u_timestep; // [m3]\n    vec3 input_air_LBD = input_flux_LBD * u_timestep; // [m3]\n    vec3 output_air_RFU = currFlux_RFU * u_timestep; // [m3]\n    vec3 output_air_LBD = currFlux_LBD * u_timestep; // [m3]\n    \n\n    // calculate inputTotal & outputTotal [m3].***\n    float outputTotal_air = (output_air_RFU.x + output_air_RFU.y + output_air_RFU.z + output_air_LBD.x + output_air_LBD.y + output_air_LBD.z) * curr_ro;\n    float inputTotal_air = input_air_RFU.x * ro_R + input_air_RFU.y * ro_F + input_air_RFU.z * ro_U + input_air_LBD.x * ro_L + input_air_LBD.y * ro_B + input_air_LBD.z * ro_D;\n\n    // calculate delta_air.***\n    float delta_air = inputTotal_air - outputTotal_air; // [kg]\n\n    // Now, add delta_air to current air_mass.***\n    float total_air_mass = curr_airMass_kg + delta_air;\n\n    // Now, calculate the number of Avogadro.***\n    // Masa molar air = 29kg/kmol\n    float air_molar_mass = 29.0; // kg/kmol\n    float n = total_air_mass / air_molar_mass; // kmol.\n    float R = 8.31446261815324;\n    float newPressure_Pa = n * 1000.0 * R * T / cellVolume; // Pa.\n    float atmToPa = 101325.0;// 1 atm = 101325 Pa.***\n    float newPressure_Atm = newPressure_Pa / atmToPa;\n\n    // calculate velocity.*****************************************************************************************************************************\n    // velocity = sqrt(dp/dρ).\n    \n    float d1 = airPressure_curr;\n    //float d2 = d1 + delta_air;\n    float d2 = newPressure_Atm;\n    float da = (d1 + d2)/2.0;\n\n    vec4 shaderLog = vec4(0.0);\n\n    float vel_x = currFlux_RFU.x - currFlux_LBD.x + input_flux_LBD.x - input_flux_RFU.x;\n    float vel_y = currFlux_RFU.y - currFlux_LBD.y + input_flux_LBD.y - input_flux_RFU.y;\n    float vel_z = currFlux_RFU.z - currFlux_LBD.z + input_flux_LBD.z - input_flux_RFU.z;\n\n    //vec3 velocity = vec3(vel_x, vel_y, vel_z)/2.0;\n    vec3 velocity = vec3(vel_x, vel_y, vel_z);\n\n    if(da <= 1e-8) //\n    {\n        velocity = vec3(0.0);\n    }\n    else\n    {\n        ////veloci = veloci/(da * u_PipeLen);\n        ////veloci = veloci/(da * vec2(cellSize_y, cellSize_x)); // original.***\n        velocity = velocity / (da * u_voxelSizeMeters);\n        \n    }\n    // End calculating velocity.-------------------------------------------------------------------------------------------------------------------------\n    //float unitaryDeltaAir  = delta_air / u_airMaxPressure * 1000.0;\n    //shaderLog = vec4(unitaryDeltaAir, unitaryDeltaAir, unitaryDeltaAir, 1.0);\n\n    vec3 encodedVelocity = encodeVelocity(velocity/u_maxVelocity);\n    vec4 writeVel = vec4(encodedVelocity, 1.0);\n\n    //float airPressure = max(airPressure_curr + delta_air, 0.0); // old.***\n    float airPressure = max(newPressure_Atm, 0.0);\n    vec4 encodedAirPressure = packDepth(airPressure / u_airMaxPressure);\n\n    gl_FragData[0] = encodedAirPressure;  // air pressure. Original.***\n\n    // Now, register the max pressure.***\n    float currMaxPressure = getAirPressure_inMaxPressureMosaicTexture(v_tex_pos);\n    float maxPressure = currMaxPressure;\n    if(airPressure > currMaxPressure)\n    {\n        maxPressure = airPressure;\n    }\n    vec4 encodedMaxAirPressure = packDepth(maxPressure / u_airMaxPressure);\n\n    // shaderLog.***\n    if(velocity.x > u_maxVelocity || velocity.y > u_maxVelocity || velocity.z > u_maxVelocity)\n    {\n        shaderLog = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    else{\n        shaderLog = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = writeVel; // velocity\n        gl_FragData[2] = encodedMaxAirPressure;  // max pressure record.\n        gl_FragData[3] = shaderLog;  // shader log.\n    #endif\n\n    \n\n}',soundCopyFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texToCopy;\nuniform bool u_textureFlipYAxis;\nvarying vec2 vTexCoord;\n\nvoid main()\n{\n    vec4 finalCol4;\n    if(u_textureFlipYAxis)\n    {\n        finalCol4 = texture2D(texToCopy, vec2(vTexCoord.x, 1.0 - vTexCoord.y));\n    }\n    else\n    {\n        finalCol4 = texture2D(texToCopy, vec2(vTexCoord.x, vTexCoord.y));\n    }\n    \n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = finalCol4; // depth\n        gl_FragData[2] = finalCol4; // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = finalCol4; // selection color\n    #endif\n\n}",soundCopyPartiallyFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texToCopy_0;\nuniform sampler2D texToCopy_1;\nuniform sampler2D texToCopy_2;\nuniform sampler2D texToCopy_3;\nuniform sampler2D texToCopy_4;\nuniform sampler2D texToCopy_5;\nuniform sampler2D texToCopy_6;\nuniform sampler2D texToCopy_7;\n\nuniform bool u_textureFlipYAxis;\nvarying vec2 vTexCoord;\n\nvoid main()\n{\n    vec4 finalCol4;\n    vec2 finalTexCoord = vTexCoord;\n    if(u_textureFlipYAxis)\n    {\n        finalTexCoord = vec2(vTexCoord.x, 1.0 - vTexCoord.y);\n    }\n\n    finalCol4 = texture2D(texToCopy_0, finalTexCoord);\n    gl_FragData[0] = finalCol4;  \n\n    #ifdef USE_MULTI_RENDER_TARGET\n        finalCol4 = texture2D(texToCopy_1, finalTexCoord);\n        gl_FragData[1] = finalCol4; \n\n        finalCol4 = texture2D(texToCopy_2, finalTexCoord);\n        gl_FragData[2] = finalCol4; \n\n        finalCol4 = texture2D(texToCopy_3, finalTexCoord);\n        gl_FragData[3] = finalCol4; \n\n        finalCol4 = texture2D(texToCopy_4, finalTexCoord);\n        gl_FragData[4] = finalCol4; \n\n        finalCol4 = texture2D(texToCopy_5, finalTexCoord);\n        gl_FragData[5] = finalCol4; \n\n        finalCol4 = texture2D(texToCopy_6, finalTexCoord);\n        gl_FragData[6] = finalCol4; \n\n        finalCol4 = texture2D(texToCopy_7, finalTexCoord);\n        gl_FragData[7] = finalCol4; \n\n    #endif\n\n}",SoundSurfaceFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D texture_0; \nuniform sampler2D texture_1;\n\nuniform bool textureFlipYAxis;\n\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \n//uniform float screenWidth;    \n//uniform float screenHeight;     \nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform float externalAlpha; // used by effects.\nuniform bool bUseLogarithmicDepth;\n\nuniform int uFrustumIdx;\n// Code color for selection:\nuniform vec4 uSelColor4;\n\nuniform float uInterpolationFactor;\nuniform float uMinMaxValue[2];\n\n// Legend colors.***\nuniform vec4 uLegendColors[16];\nuniform float uLegendValues[16];\n\nvarying vec3 vNormal;\nvarying vec4 vColor4; // color from attributes\nvarying vec2 vTexCoord;   \n\nvarying float vDepth;\nvarying float vSoundValue;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvec4 packDepth( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n\treturn enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depthAux = dot(rgba_depth, bit_shift);\n    return depthAux;\n}  \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\n/*\n// unpack depth used for shadow on screen.***\nfloat unpackDepth_A(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n*/\n\nfloat UnpackDepth32( in vec4 pack )\n{\n\tfloat depth = dot( pack, vec4(1.0, 0.00390625, 0.000015258789, 0.000000059605) );\n    return depth * 1.000000059605;// 1.000000059605 = (16777216.0) / (16777216.0 - 1.0);\n}             \n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}         \n            \n\n\nvec4 getRainbowColor_byHeight(in float height, in float minHeight_rainbow, in float maxHeight_rainbow, bool hotToCold)\n{\n    \n    float gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\n    float value = gray * 4.0;\n    float h = floor(value);\n    float f = fract(value);\n\n    vec4 resultColor = vec4(0.0, 0.0, 0.0, gray);\n\n    if(hotToCold)\n    {\n        // HOT to COLD.***\n        resultColor.rgb = vec3(1.0, 0.0, 0.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix red & yellow.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(red, yellow, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix yellow & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, green, f);\n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & cyan.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(green, cyan, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix cyan & blue.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, blue, f);\n        }\n    }\n    else\n    {\n        // COLD to HOT.***\n        resultColor.rgb = vec3(0.0, 0.0, 1.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix blue & cyan.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(blue, cyan, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix cyan & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, green, f);  \n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & yellow.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(green, yellow, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix yellow & red.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, red, f);\n        }\n    }\n\n    return resultColor;\n}\n\n\nvoid main()\n{\n\t//bool testBool = false;\n\t//float occlusion = 1.0; // ambient occlusion.***\n\t//vec3 normal2 = vNormal;\t\n\t//float scalarProd = 1.0;\n\t\n\t//vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\t//float linearDepth = getDepth(screenPos);   \n\t//vec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t//occlusion = 1.0;\n\tvec4 textureColor;\n\tvec4 textureColor_0;\n\tvec4 textureColor_1;\n\n    if(colorType == 2)\n    {\n        if(textureFlipYAxis)\n        {\n            textureColor_0 = texture2D(texture_0, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n\t\t\ttextureColor_1 = texture2D(texture_1, vec2(vTexCoord.s, 1.0 - vTexCoord.t));\n        }\n        else{\n            textureColor_0 = texture2D(texture_0, vec2(vTexCoord.s, vTexCoord.t));\n\t\t\ttextureColor_1 = texture2D(texture_1, vec2(vTexCoord.s, vTexCoord.t));\n        }\n\n\t\ttextureColor = mix(textureColor_0, textureColor_1, uInterpolationFactor);\n    }\n    else if(colorType == 0)\n\t{\n        textureColor = oneColor4;\n    }\n\telse if(colorType == 1)\n\t{\n        textureColor = vColor4;\n    }\n\telse if(colorType == 3)\n\t{\n\t\tbool hotToCold = false;\n\t\tfloat height = vSoundValue;\n\n        textureColor = getRainbowColor_byHeight(height, uMinMaxValue[0], uMinMaxValue[1], hotToCold);\n\n\t\ttextureColor = vec4(textureColor.a, textureColor.a, textureColor.a, textureColor.a);\n    }\n\telse if(colorType == 4)\n\t{\n\t\tfloat height = vSoundValue;\n\t\tfloat q = (height - uMinMaxValue[0]) / (uMinMaxValue[1] - uMinMaxValue[0]);\n\n\t\ttextureColor = vec4(q,q*0.25,q*0.5,q);\n    }\n\telse if(colorType == 5)\n\t{\n\t\t// use an external legend.***\n\t\tvec4 colorAux = vec4(0.3, 0.3, 0.3, 0.4);\n\n\t\t// find legendIdx.***\n\t\tfor(int i=0; i<15; i++)\n\t\t{\n\t\t\tif(vSoundValue > uLegendValues[i] && vSoundValue <= uLegendValues[i + 1])\n\t\t\t{\n\t\t\t\tcolorAux = uLegendColors[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n        if(colorAux.a == 0.0)\n        {\n            discard;\n        }\n\n\t\ttextureColor = colorAux;\n    }\n\t\n    vec4 finalColor;\n\tfinalColor = textureColor;\n\n\tvec4 albedo4 = finalColor;\n\n\t\n    gl_FragData[0] = finalColor; \n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t{\n\t\t// save depth, normal, albedo.\n\t\tfloat depthAux = vDepth;\n\t\tgl_FragData[1] = packDepth(depthAux); \n\n\t\t// When render with cull_face disabled, must correct the faces normal.\n\t\tfloat frustumIdx = 1.0;\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005;\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015;\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025;\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035;\n\n\t\tvec3 normal = vNormal;\n\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, frustumIdx); // save normal.***\n\n\t\t// albedo.\n\t\tgl_FragData[3] = albedo4; \n\n\t\t// selColor4 (if necessary).\n\t\tgl_FragData[4] = uSelColor4; \n\t}\n\t#endif\n\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}',SoundSurfaceVS:"\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\tattribute float value;\n\t\n\tuniform mat4 buildingRotMatrix; \n\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n\t\n\t\n\n\tvarying vec3 vNormal;\n\tvarying vec2 vTexCoord;  \n\tvarying vec3 uAmbientColor;\n\tvarying vec3 vLightWeighting;\n\tvarying vec3 vertexPos;\n\tvarying vec3 vertexPosLC;\n\tvarying vec4 vColor4; // color from attributes\n\tvarying vec3 vLightDir; \n\tvarying vec3 vNormalWC; \n\tvarying float flogz;\n\tvarying float Fcoef_half;\n\tvarying float vDepth;\n\tvarying float vSoundValue;\n\n\t\n\tvoid main()\n    {\t\n\t\tvertexPosLC = vec3(position.x, position.y, position.z);\n\t\tvec4 scaledPos = vec4(position.x * scaleLC.x, position.y * scaleLC.y, position.z * scaleLC.z, 1.0);\n\t\tvec4 rotatedPos;\n\t\tmat3 currentTMat;\n\t\trotatedPos = buildingRotMatrix * vec4(scaledPos.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t\tcurrentTMat = mat3(buildingRotMatrix);\n\n\t\tvec3 objPosHigh = buildingPosHIGH;\n\t\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\t\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\t\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\t\tvec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\tvec3 rotatedNormal = currentTMat * normal;\n\t\t\n\t\t\n\t\tuAmbientColor = vec3(1.0);\n\t\tvNormalWC = rotatedNormal;\n\t\tvNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n\t\tvTexCoord = texCoord;\n\t\tvLightDir = vec3(-0.1320580393075943, -0.9903827905654907, 0.041261956095695496);\n\t\tvec3 directionalLightColor = vec3(0.7, 0.7, 0.7);\n\t\tfloat directionalLightWeighting = 1.0;\n\n\n\t\tvLightWeighting = uAmbientColor + directionalLightColor * directionalLightWeighting; // original.***\n\t\t\n\n        gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\tvec4 orthoPos = modelViewMatrixRelToEye * pos4;\n\t\tvertexPos = orthoPos.xyz;\n\t\tvDepth = -orthoPos.z/far;\n\n\t\tvSoundValue = value;\n\n\t\tif(bUseLogarithmicDepth)\n\t\t{\n\t\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t\t// flogz = 1.0 + gl_Position.w;\n\t\t\t//---------------------------------------------------------------------------------\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t\t}\n\t\t\n\t\tif(colorType == 1)\n\t\t\tvColor4 = color4;\n\n\t\tgl_PointSize = 5.0;\n\t}",soundVolumetricFS:'//#version 300 es\n\n#ifdef GL_ES\n    //precision lowp float;\n    //precision lowp int;\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n// https://draemm.li/various/volumeRendering/webgl2/\n\n    //*********************************************************\n    // R= right, F= front, U= up, L= left, B= back, D= down.\n    // RFU = x, y, z.\n    // LBD = -x, -y, -z.\n    //*********************************************************\n\n    //      +-----------------+\n\t//      |                 |          \n\t//      |   screen size   |  \n\t//      |                 | \n\t//      +-----------------+\n\t//      +-----------------+----------------+\n\t//      |                 |                | \n\t//      |   front depth   |   rear depth   |\n\t//      |                 |                |\n\t//      +-----------------+----------------+\n\t\nuniform sampler2D simulationBoxDoubleDepthTex;\nuniform sampler2D simulationBoxDoubleNormalTex; // used to calculate the current frustum idx.***\nuniform sampler2D airPressureMosaicTex;\nuniform sampler2D sceneDepthTex; // scene depth texture.***\nuniform sampler2D sceneNormalTex; // scene depth texture.***\nuniform sampler2D airVelocityTex; \nuniform sampler2D maxPressureMosaicTex;\n\nuniform int u_texSize[3]; // The original texture3D size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform vec3 u_voxelSizeMeters;\n\nvarying vec2 v_tex_pos;\n\nuniform mat4 modelViewMatrixRelToEye;\nuniform mat4 modelViewMatrixRelToEyeInv;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float u_airMaxPressure;\nuniform float u_airEnvirontmentPressure;\nuniform float u_maxVelocity;\nuniform vec2 u_screenSize;\nuniform vec2 uNearFarArray[4];\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\n\nuniform mat4 u_simulBoxTMat;\nuniform mat4 u_simulBoxTMatInv;\nuniform vec3 u_simulBoxPosHigh;\nuniform vec3 u_simulBoxPosLow;\nuniform vec3 u_simulBoxMinPosLC;\nuniform vec3 u_simulBoxMaxPosLC;\n\nuniform int u_renderType; // 0 = volumetric (generic), 1 = isosurface.\n\n\n\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getDepth(vec2 coord)\n{\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t//\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t//\t// flogz = 1.0 + gl_Position.z*0.0001;\n    //    float Fcoef_half = uFCoef_logDepth/2.0;\n\t//\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t//\tfloat z = (flogzAux - 1.0);\n\t//\tlinearDepth = z/(far);\n\t//\treturn linearDepth;\n\t//}\n\t//else{\n\t\treturn unpackDepth(texture2D(sceneDepthTex, coord.xy));\n\t//}\n}\n\nfloat getDepth_simulationBox(vec2 coord)\n{\n\t//if(bUseLogarithmicDepth)\n\t//{\n\t//\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t//\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t//\t// flogz = 1.0 + gl_Position.z*0.0001;\n    //    float Fcoef_half = uFCoef_logDepth/2.0;\n\t//\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t//\tfloat z = (flogzAux - 1.0);\n\t//\tlinearDepth = z/(far);\n\t//\treturn linearDepth;\n\t//}\n\t//else{\n\t\treturn unpackDepth(texture2D(simulationBoxDoubleDepthTex, coord.xy));\n\t//}\n}\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(sceneNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nvec3 encodeVelocity(in vec3 vel)\n{\n\treturn vel*0.5 + 0.5;\n}\n\nvec3 decodeVelocity(in vec3 encodedVel)\n{\n\treturn vec3(encodedVel * 2.0 - 1.0);\n}\n\nvec3 getVelocity(in vec2 texCoord)\n{\n    vec4 encodedVel = texture2D(airVelocityTex, texCoord);\n    return decodeVelocity(encodedVel.xyz)*u_maxVelocity;\n}\n\nvec4 getNormal_simulationBox(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(simulationBoxDoubleNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvoid get_FrontAndRear_depthTexCoords(in vec2 texCoord, inout vec2 frontTexCoord, inout vec2 rearTexCoord)\n{\n    //      +-----------------+\n\t//      |                 |          \n\t//      |   screen size   |  \n\t//      |                 | \n\t//      +-----------------+\n\t//      +-----------------+----------------+\n\t//      |                 |                | \n\t//      |   front depth   |   rear depth   |\n\t//      |                 |                |\n\t//      +-----------------+----------------+\n    vec2 normalTexSize = vec2(u_screenSize.x * 2.0, u_screenSize.y); // the normal tex width is double of the screen size width.***\n    //vec2 frontNormalFragCoord = vec2(gl_FragCoord.x, gl_FragCoord.y);\n    //vec2 rearNormalFragCoord = vec2(gl_FragCoord.x + u_screenSize.x, gl_FragCoord.y);\n    float windows_x = texCoord.x * u_screenSize.x;\n    float windows_y = texCoord.y * u_screenSize.y;\n    vec2 frontNormalFragCoord = vec2(windows_x, windows_y);\n    vec2 rearNormalFragCoord = vec2(windows_x + u_screenSize.x, windows_y);\n\n    frontTexCoord = vec2(frontNormalFragCoord.x / normalTexSize.x, frontNormalFragCoord.y / normalTexSize.y);\n    rearTexCoord = vec2(rearNormalFragCoord.x / normalTexSize.x, rearNormalFragCoord.y / normalTexSize.y);\n}\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nvoid get_FrontAndRear_posCC(in vec2 screenPos, in float currFar_rear, in float currFar_front, inout vec3 frontPosCC, inout vec3 rearPosCC)\n{\n    vec2 frontTexCoord;\n    vec2 rearTexCoord;\n    get_FrontAndRear_depthTexCoords(screenPos, frontTexCoord, rearTexCoord);\n\n    // If the linear depth is 1, then, take the camPos as the position, so, pos = (0.0, 0.0, 0.0).***\n    //vec4 depthColor4 = texture2D(simulationBoxDoubleDepthTex, screenPos);\n    //float depthColLength = length(depthColor4);\n\n    // Front posCC.***\n    float frontLinearDepth = getDepth_simulationBox(frontTexCoord);\n    if(frontLinearDepth < 1e-8)\n    {\n        frontPosCC = vec3(0.0);\n    }\n    else\n    {\n        float front_zDist = frontLinearDepth * currFar_front; \n        frontPosCC = getViewRay(screenPos, front_zDist);\n    }\n    \n\n    // Rear posCC.***\n    float rearLinearDepth = getDepth_simulationBox(rearTexCoord);\n    if(rearLinearDepth < 1e-8)\n    {\n        rearPosCC = vec3(0.0);\n    }\n    else\n    {\n        float rear_zDist = rearLinearDepth * currFar_rear; \n        rearPosCC = getViewRay(screenPos, rear_zDist);\n    }\n    \n\n}\n\nvoid posWCRelToEye_to_posLC(in vec4 posWC_relToEye, in mat4 local_mat4Inv, in vec3 localPosHIGH, in vec3 localPosLOW, inout vec3 posLC)\n{\n    vec3 highDifferenceSun = -localPosHIGH.xyz + encodedCameraPositionMCHigh;\n\tvec3 lowDifferenceSun = posWC_relToEye.xyz -localPosLOW.xyz + encodedCameraPositionMCLow;\n\tvec4 pos4Sun = vec4(highDifferenceSun.xyz + lowDifferenceSun.xyz, 1.0);\n\tvec4 vPosRelToLight = local_mat4Inv * pos4Sun;\n\n\tposLC = vPosRelToLight.xyz / vPosRelToLight.w;\n}\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col, in int row)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    float s = float(col) * sRange + subTexCoord.x * sRange;\n    float t = float(row) * tRange + subTexCoord.y * tRange;\n\n    vec2 resultTexCoord = vec2(s, t);\n    return resultTexCoord;\n}\n\nfloat getAirPressure_inMosaicTexture(in vec2 texCoord, in int pressureType)\n{\n    vec4 color4;\n    if(pressureType == 0)\n    {\n        color4 = texture2D(airPressureMosaicTex, texCoord);\n    }\n    else if(pressureType == 1)\n    {\n        color4 = texture2D(maxPressureMosaicTex, texCoord);\n    } \n    float decoded = unpackDepth(color4); // 32bit.\n    float airPressure = decoded * u_airMaxPressure;\n\n    return airPressure;\n}\n\nfloat _getAirPressure_triLinearInterpolation(in vec2 subTexCoord2d, in int col_mosaic, in int row_mosaic, in int pressureType)\n{\n    // This function : given a subTexture2d(real texCoord.xy of a realTex3D), \n    // and the col & row into the mosaic texture, returns a trilinear interpolation of the pressure.***\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec2 px = 1.0 / sim_res3d.xy;\n    vec2 vc = (floor(subTexCoord2d * sim_res3d.xy)) * px;\n    vec2 f = fract(subTexCoord2d * sim_res3d.xy);\n    vec2 texCoord_tl = vec2(vc);\n    vec2 texCoord_tr = vec2(vc + vec2(px.x, 0));\n    vec2 texCoord_bl = vec2(vc + vec2(0, px.y));\n    vec2 texCoord_br = vec2(vc + px);\n    vec2 mosaicTexCoord_tl = subTexCoord_to_texCoord(texCoord_tl, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_tr = subTexCoord_to_texCoord(texCoord_tr, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_bl = subTexCoord_to_texCoord(texCoord_bl, col_mosaic, row_mosaic);\n    vec2 mosaicTexCoord_br = subTexCoord_to_texCoord(texCoord_br, col_mosaic, row_mosaic);\n\n    float ap_tl = getAirPressure_inMosaicTexture(mosaicTexCoord_tl, pressureType);\n    float ap_tr = getAirPressure_inMosaicTexture(mosaicTexCoord_tr, pressureType);\n    float ap_bl = getAirPressure_inMosaicTexture(mosaicTexCoord_bl, pressureType);\n    float ap_br = getAirPressure_inMosaicTexture(mosaicTexCoord_br, pressureType);\n\n    float airPressure = mix(mix(ap_tl, ap_tr, f.x), mix(ap_bl, ap_br, f.x), f.y);\n\n    return airPressure;\n}\n\nfloat _getAirPressure_nearest(in vec2 subTexCoord2d, in int col_mosaic, in int row_mosaic, in int pressureType)\n{\n    // This function : given a subTexture2d(real texCoord.xy of a realTex3D), \n    // and the col & row into the mosaic texture, returns a nearest interpolation of the pressure.***\n    vec2 mosaicTexCoord = subTexCoord_to_texCoord(subTexCoord2d, col_mosaic, row_mosaic);\n    float ap = getAirPressure_inMosaicTexture(mosaicTexCoord, pressureType);\n    return ap;\n}\n\nbool get_airPressure_fromTexture3d_triLinearInterpolation(in vec3 texCoord3d, inout float airPressure, inout vec3 velocity, in int pressureType)\n{\n    // tex3d : airPressureMosaicTex\n    // 1rst, check texCoord3d boundary limits.***\n    if(texCoord3d.x < 0.0 || texCoord3d.x > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.y < 0.0 || texCoord3d.y > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.z < 0.0 || texCoord3d.z > 1.0)\n    {\n        return false;\n    }\n    // 1rst, determine the sliceIdx.***\n    // u_texSize[3]; // The original texture3D size.***\n    int originalTexWidth = u_texSize[0];\n    int originalTexHeight = u_texSize[1];\n    int slicesCount = u_texSize[2];\n\n    //float currSliceIdx_float = texCoord3d.z * float(slicesCount); // original.***\n    float currSliceIdx_float = texCoord3d.z * float(slicesCount - 1); // new, debugging with chemAccident volRender.***\n    int currSliceIdx_down = int(floor(currSliceIdx_float));\n    int currSliceIdx_up = currSliceIdx_down + 1;\n\n    if(currSliceIdx_up >= u_texSize[2])\n    {\n        return false;\n    }\n\n    // now, calculate the mod.***\n    //float remain = currSliceIdx_float -  floor(currSliceIdx_float);\n    float remain = fract(currSliceIdx_float);\n\n    // Now, calculate the "col" & "row" in the mosaic texture3d.***\n    // u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n\n    // Down slice.************************************************************\n    int col_down, row_down;\n    if(currSliceIdx_down <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row_down = 0;\n        col_down = currSliceIdx_down;\n    }\n    else\n    {\n        float rowAux = floor(float(currSliceIdx_down) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_down) - (rowAux * float(u_mosaicSize[0]));\n\n        col_down = int(colAux);\n        row_down = int(rowAux);\n    }\n\n    // now, must calculate the mosaicTexCoord.***\n    vec2 mosaicTexCoord_down = subTexCoord_to_texCoord(texCoord3d.xy, col_down, row_down);\n    \n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec2 px = 1.0 / sim_res3d.xy;\n    vec2 vc = (floor(texCoord3d.xy * sim_res3d.xy)) * px;\n    vec3 f = fract(texCoord3d * sim_res3d);\n\n    float airPressure_down = _getAirPressure_triLinearInterpolation(texCoord3d.xy, col_down, row_down, pressureType);\n\n    vec3 vel_down = getVelocity(mosaicTexCoord_down);\n\n    // up slice.************************************************************\n    int col_up, row_up;\n    if(currSliceIdx_up <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_up is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row_up = 0;\n        col_up = currSliceIdx_up;\n    }\n    else\n    {\n        float rowAux = floor(float(currSliceIdx_up) / float(u_mosaicSize[0]));\n        float colAux = float(currSliceIdx_up) - (rowAux * float(u_mosaicSize[0]));\n\n        col_up = int(colAux);\n        row_up = int(rowAux);\n    }\n\n    // now, must calculate the mosaicTexCoord.***\n    vec2 mosaicTexCoord_up = subTexCoord_to_texCoord(texCoord3d.xy, col_up, row_up);\n\n    float airPressure_up = _getAirPressure_triLinearInterpolation(texCoord3d.xy, col_up, row_up, pressureType);\n\n    vec3 vel_up = getVelocity(mosaicTexCoord_up);\n\n    velocity = mix(vel_down, vel_up, remain);\n\n\n    airPressure = mix(airPressure_down, airPressure_up, f.z);\n    //airPressure = airPressure_down; // test delete.***\n    return true;\n}\n\nbool get_airPressure_fromTexture3d_nearest(in vec3 texCoord3d, inout float airPressure, inout vec3 velocity, in int pressureType)\n{\n    // tex3d : airPressureMosaicTex\n    // 1rst, check texCoord3d boundary limits.***\n    if(texCoord3d.x < 0.0 || texCoord3d.x > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.y < 0.0 || texCoord3d.y > 1.0)\n    {\n        return false;\n    }\n\n    if(texCoord3d.z < 0.0 || texCoord3d.z > 1.0)\n    {\n        return false;\n    }\n    // 1rst, determine the sliceIdx.***\n    int slicesCount = u_texSize[2];\n\n    float currSliceIdx_float = texCoord3d.z * float(slicesCount);\n    int currSliceIdx_down = int(floor(currSliceIdx_float));\n    int currSliceIdx_up = currSliceIdx_down + 1;\n    int currSliceIdx = currSliceIdx_down;\n\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    //vec2 px = 1.0 / sim_res3d.xy;\n    //vec2 vc = (floor(texCoord3d.xy * sim_res3d.xy)) * px;\n    vec3 f = fract(texCoord3d * sim_res3d);\n\n    if(f.z > 0.5)\n    {\n        currSliceIdx = currSliceIdx_up;\n    }\n\n    if(currSliceIdx >= u_texSize[2])\n    {\n        return false;\n    }\n\n    // ************************************************************\n    int col, row;\n    if(currSliceIdx <= u_mosaicSize[0])\n    {\n        // Our current sliceIdx_down is smaller than the columns count of the mosaic, so:\n        // in this case, the row = 0.***\n        row = 0;\n        col = currSliceIdx;\n    }\n    else\n    {\n        float mosaicSize_x = float(u_mosaicSize[0]);\n        float rowAux = floor(float(currSliceIdx) / mosaicSize_x);\n        float colAux = float(currSliceIdx) - (rowAux * mosaicSize_x);\n\n        col = int(colAux);\n        row = int(rowAux);\n    }\n\n    // now, must calculate the mosaicTexCoord.***\n    vec2 mosaicTexCoord = subTexCoord_to_texCoord(texCoord3d.xy, col, row);\n\n    airPressure = _getAirPressure_nearest(texCoord3d.xy, col, row, pressureType);\n    velocity = getVelocity(mosaicTexCoord);\n\n    return true;\n}\n\nvec4 getRainbowColor_byHeight(in float height, in float minHeight_rainbow, in float maxHeight_rainbow, bool hotToCold)\n{\n    \n    float gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\n    float value = gray * 4.0;\n    float h = floor(value);\n    float f = fract(value);\n\n    vec4 resultColor = vec4(0.0, 0.0, 0.0, gray);\n\n    if(hotToCold)\n    {\n        // HOT to COLD.***\n        resultColor.rgb = vec3(1.0, 0.0, 0.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix red & yellow.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(red, yellow, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix yellow & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, green, f);\n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & cyan.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(green, cyan, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix cyan & blue.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, blue, f);\n        }\n    }\n    else\n    {\n        // COLD to HOT.***\n        resultColor.rgb = vec3(0.0, 0.0, 1.0); // init\n        if(h >= 0.0 && h < 1.0)\n        {\n            // mix blue & cyan.***\n            vec3 blue = vec3(0.0, 0.0, 1.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(blue, cyan, f);\n        }\n        else if(h >= 1.0 && h < 2.0)\n        {\n            // mix cyan & green.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 cyan = vec3(0.0, 1.0, 1.0);\n            resultColor.rgb = mix(cyan, green, f);  \n        }\n        else if(h >= 2.0 && h < 3.0)\n        {\n            // mix green & yellow.***\n            vec3 green = vec3(0.0, 1.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(green, yellow, f);\n        }\n        else if(h >= 3.0)\n        {\n            // mix yellow & red.***\n            vec3 red = vec3(1.0, 0.0, 0.0);\n            vec3 yellow = vec3(1.0, 1.0, 0.0);\n            resultColor.rgb = mix(yellow, red, f);\n        }\n    }\n\n    return resultColor;\n}\n\nvec3 getRainbowColor_byHeight_original(in float height, in float minHeight_rainbow, in float maxHeight_rainbow)\n{\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\n// https://www.willusher.io/webgl/2019/01/13/volume-rendering-with-webgl\n// The transfer function specifies what color and opacity value should be assigned for a given value sampled from the volume. \n//--------------------------------------------------------------------------------------------------------------------------\n\n// https://developer.nvidia.com/gpugems/gpugems/part-vi-beyond-triangles/chapter-39-volume-rendering-techniques\n//--------------------------------------------------------------------------------------------------------------------------\n\n/*\n// https://martinopilia.com/posts/2018/09/17/volume-raycasting.html\n// Estimate the normal from a finite difference approximation of the gradient\nvec3 normal(vec3 position, float intensity)\n{\n    float d = step_length;\n    float dx = texture(volume, position + vec3(d,0,0)).r - intensity;\n    float dy = texture(volume, position + vec3(0,d,0)).r - intensity;\n    float dz = texture(volume, position + vec3(0,0,d)).r - intensity;\n    return -normalize(NormalMatrix * vec3(dx, dy, dz));\n}*/\n\nbool normalLC(vec3 texCoord3d, in float pressure, in float step_length, inout vec3 result_normal)\n{\n    // Estimate the normal from a finite difference approximation of the gradient\n    vec3 sim_res3d = vec3(u_texSize[0], u_texSize[1], u_texSize[2]);\n    vec3 pix = 1.0 / sim_res3d;\n\n    vec3 vc = texCoord3d;\n    int pressureType = 0;\n\n    // dx.*************************************************\n    float airPressure_dx = u_airEnvirontmentPressure;\n    vec3 velocity_dx;\n    vec3 texCoord3d_dx = vec3(vc + vec3(pix.x, 0.0, 0.0));\n    bool succes_dx =  get_airPressure_fromTexture3d_nearest(texCoord3d_dx, airPressure_dx, velocity_dx, pressureType);\n    if(!succes_dx)return false;\n\n    float airPressure_dx_neg = u_airEnvirontmentPressure;\n    vec3 velocity_dx_neg;\n    vec3 texCoord3d_dx_neg = vec3(vc - vec3(pix.x, 0.0, 0.0));\n    bool succes_dx_neg =  get_airPressure_fromTexture3d_nearest(texCoord3d_dx_neg, airPressure_dx_neg, velocity_dx_neg, pressureType);\n    if(!succes_dx_neg)return false;\n\n    // dy.*************************************************\n    float airPressure_dy = u_airEnvirontmentPressure;\n    vec3 velocity_dy;\n    vec3 texCoord3d_dy = vec3(vc + vec3(0.0, pix.y, 0.0));\n    bool succes_dy =  get_airPressure_fromTexture3d_nearest(texCoord3d_dy, airPressure_dy, velocity_dy, pressureType);\n    if(!succes_dy)return false;\n\n    float airPressure_dy_neg = u_airEnvirontmentPressure;\n    vec3 velocity_dy_neg;\n    vec3 texCoord3d_dy_neg = vec3(vc - vec3(0.0, pix.y, 0.0));\n    bool succes_dy_neg =  get_airPressure_fromTexture3d_nearest(texCoord3d_dy_neg, airPressure_dy_neg, velocity_dy_neg, pressureType);\n    if(!succes_dy_neg)return false;\n\n    // dz.*************************************************\n    float airPressure_dz = u_airEnvirontmentPressure;\n    vec3 velocity_dz;\n    vec3 texCoord3d_dz = vec3(vc + vec3(0.0, 0.0, pix.z));\n    bool succes_dz =  get_airPressure_fromTexture3d_nearest(texCoord3d_dz, airPressure_dz, velocity_dz, pressureType);\n    if(!succes_dz)return false;\n\n    float airPressure_dz_neg = u_airEnvirontmentPressure;\n    vec3 velocity_dz_neg;\n    vec3 texCoord3d_dz_neg = vec3(vc - vec3(0.0, 0.0, pix.z));\n    bool succes_dz_neg =  get_airPressure_fromTexture3d_nearest(texCoord3d_dz_neg, airPressure_dz_neg, velocity_dz_neg, pressureType);\n    if(!succes_dz_neg)return false;\n\n    //result_normal = normalize(vec3(airPressure_dx - pressure, airPressure_dy - pressure, airPressure_dz - pressure));\n    result_normal = normalize(vec3(airPressure_dx - airPressure_dx_neg, airPressure_dy - airPressure_dy_neg, airPressure_dz - airPressure_dz_neg));\n\n    if(abs(result_normal.x) > 0.0 || abs(result_normal.y) > 0.0 || abs(result_normal.z) > 0.0 )\n    {\n        return true;\n    }\n    else return false;\n\n    return true;\n}\n\nvec4 transfer_fnc(in float pressure)\n{\n    // The transfer function specifies what color and opacity value should be assigned for a given value sampled from the volume. \n    float maxPressureRef = 1.05;\n    float minPressureRef = u_airEnvirontmentPressure;\n    maxPressureRef = 1.005; // test.***\n    minPressureRef = 1.0; // test.***\n    bool bHotToCold = false; // we want coldToHot (blue = min to red = max).***\n    vec4 rainbowCol3 = getRainbowColor_byHeight(pressure, minPressureRef, maxPressureRef, bHotToCold);\n\n    return rainbowCol3;\n}\n\nvoid main(){\n\n    // 1rst, read front depth & rear depth and check if exist rear depth.***\n    // If no exist rear depth, then discard.***\n    //vec2 screenPos = vec2(gl_FragCoord.x / u_screenSize.x, gl_FragCoord.y / u_screenSize.y); // \n    vec2 screenPos = v_tex_pos;\n\n    // read normal in rear depth. If no exist normal, then, discard.***\n    // calculate the texCoord for rear normal:\n    vec2 frontTexCoord;\n    vec2 rearTexCoord;\n    get_FrontAndRear_depthTexCoords(screenPos, frontTexCoord, rearTexCoord);\n\n\n    vec4 normal4rear = getNormal_simulationBox(rearTexCoord);\n    vec4 normal4front = getNormal_simulationBox(frontTexCoord);\n\tvec3 normal = normal4rear.xyz;\n    \n\tvec4 encodedNormal = texture2D(simulationBoxDoubleNormalTex, frontTexCoord);\n\tif(length(encodedNormal.xyz) < 0.1)\n    {\n        discard;\n    }\n\n    // 1rst, know the scene depth.***\n    vec4 normal4scene = getNormal(v_tex_pos);\n    int estimatedFrustumIdx = int(floor(normal4scene.w * 100.0));\n\tint dataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_scene = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear_scene = nearFar_scene.x; // no used in this shader.***\n\tfloat currFar_scene = nearFar_scene.y;\n    float sceneLinearDepth = getDepth(v_tex_pos);\n    float distToCam = sceneLinearDepth * currFar_scene;\n    vec3 sceneDepthPosCC = getViewRay(v_tex_pos, distToCam - 1.0);\n\n    // Now, calculate the positions with the simulation box, front & rear.***\n    // rear.***\n\testimatedFrustumIdx = int(floor(normal4rear.w * 100.0));\n\tdataType = -1;// DATATYPE 0 = objects. 1 = terrain. 2 = pointsCloud.\n\tcurrFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_rear = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear_rear = nearFar_rear.x; // no used in this shader.***\n\tfloat currFar_rear = nearFar_rear.y;\n\n    // front.***\n    estimatedFrustumIdx = int(floor(normal4front.w * 100.0));\n\tcurrFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType); // Note : "dataType" no used in this shader.***\n\tvec2 nearFar_front = getNearFar_byFrustumIdx(currFrustumIdx);\n\tfloat currNear_front = nearFar_front.x; // no used in this shader.***\n\tfloat currFar_front = nearFar_front.y;\n\n    // Now, calculate the rearPosCC & frontPosCC.***\n    vec3 frontPosCC;\n    vec3 rearPosCC;\n    get_FrontAndRear_posCC(screenPos, currFar_rear, currFar_front, frontPosCC, rearPosCC);\n    \n\n    // Now, calculate frontPosWC & rearPosWC.***\n    vec4 frontPosWCRelToEye = modelViewMatrixRelToEyeInv * vec4(frontPosCC.xyz, 1.0);\n    vec4 rearPosWCRelToEye = modelViewMatrixRelToEyeInv * vec4(rearPosCC.xyz, 1.0);\n    //vec4 scenePosWCRelToEye = modelViewMatrixRelToEyeInv * vec4(sceneDepthPosCC.xyz, 1.0);\n\n    // Now, calculate frontPosLC & rearPosLC.***\n    vec3 frontPosLC;\n    vec3 rearPosLC;\n    //vec3 scenePosLC;\n    posWCRelToEye_to_posLC(frontPosWCRelToEye, u_simulBoxTMatInv, u_simulBoxPosHigh, u_simulBoxPosLow, frontPosLC);\n    posWCRelToEye_to_posLC(rearPosWCRelToEye, u_simulBoxTMatInv, u_simulBoxPosHigh, u_simulBoxPosLow, rearPosLC);\n    //posWCRelToEye_to_posLC(scenePosWCRelToEye, u_simulBoxTMatInv, u_simulBoxPosHigh, u_simulBoxPosLow, scenePosLC);\n\n    // Now, with "frontPosLC" & "rearPosLC", calculate the frontTexCoord3d & rearTexCoord3d.***\n    vec3 simulBoxRange = vec3(u_simulBoxMaxPosLC.x - u_simulBoxMinPosLC.x, u_simulBoxMaxPosLC.y - u_simulBoxMinPosLC.y, u_simulBoxMaxPosLC.z - u_simulBoxMinPosLC.z);\n    //vec3 frontTexCoord3d = vec3((frontPosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (frontPosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (frontPosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n    //vec3 rearTexCoord3d = vec3((rearPosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (rearPosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (rearPosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n    //vec3 scenePosTexCoord3d = vec3((scenePosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (scenePosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (scenePosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n\n    \n    //bool testBool = false;\n\n    //float totalAirPressure = 0.0;\n    vec3 totalVelocityLC = vec3(0.0);\n    //float totalDotProdInv = 0.0;\n    float airPressure = 0.0;\n    float smplingCount = 0.0;\n    //float currMaxPressure = 0.0;\n    float segmentLength = length(rearPosLC - frontPosLC);\n    //vec3 samplingDir = normalize(rearTexCoord3d - frontTexCoord3d); // original.***\n    vec3 samplingDirLC = normalize(rearPosLC - frontPosLC);\n    vec3 samplingDirCC = normalize(rearPosCC - frontPosCC);\n    //float increLength = 0.02; // original.***\n    float samplingsCount = 50.0;\n    float increLength = segmentLength / samplingsCount;\n    if(increLength < u_voxelSizeMeters.x)\n    {\n        increLength = u_voxelSizeMeters.x;\n    }\n\n    vec3 velocityLC;\n\n    //vec3 camRay = normalize(getViewRay(v_tex_pos, 1.0));\n    vec3 camRay = normalize(sceneDepthPosCC);\n    //float dotProdAccum = 0.0;\n    vec4 color4Aux = vec4(0.0, 0.0, 0.0, 0.0);\n    //float dotProdFactor = 1.0;\n    int pressureType = 0;\n    vec3 scenePosTexCoord3d_candidate = vec3(-1.0);\n    vec3 currSamplePosLC = vec3(frontPosLC);\n    vec3 step_vector_LC = samplingDirLC * increLength;\n    vec4 finalColor4 = vec4(0.0);\n    \n    // Sampling far to near.***\n    for(int i=0; i<50; i++)\n    {\n        \n        // Note : for each smple, must depth check with the scene depthTexure.***\n        vec3 samplePosLC = frontPosLC + samplingDirLC * increLength * float(i);\n\n        //if(samplePosLC.z > 20.0)\n        //{\n        //    continue;\n        //}\n\n        vec3 samplePosCC = frontPosCC + samplingDirCC * increLength * float(i);\n        if(abs(samplePosCC.z) > distToCam)\n        {\n            break;\n        }\n\n        airPressure = 0.0;\n        vec3 sampleTexCoord3d = vec3((samplePosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (samplePosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (samplePosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n        //vec3 sampleTexCoord3d = vec3((currSamplePosLC.x - u_simulBoxMinPosLC.x)/simulBoxRange.x, (currSamplePosLC.y - u_simulBoxMinPosLC.y)/simulBoxRange.y, (currSamplePosLC.z - u_simulBoxMinPosLC.z)/simulBoxRange.z);\n        scenePosTexCoord3d_candidate = vec3(sampleTexCoord3d);\n        \n\n        if(get_airPressure_fromTexture3d_triLinearInterpolation(sampleTexCoord3d, airPressure, velocityLC, pressureType))\n        {\n            // normalLC(vec3 texCoord3d, in float pressure, in float step_length)\n            vec3 currNormalLC;\n            if(!normalLC(sampleTexCoord3d, airPressure, increLength, currNormalLC))\n            {\n                continue;\n            }\n\n            // test iso surface:\n            //float pressureWanted = 1.02;\n            //float diffAux = abs(pressureWanted - airPressure);\n            //if(diffAux > 0.01)\n            //{\n            //    continue;\n            //}\n\n            vec4 currColor4 = transfer_fnc(airPressure);\n            //vec3 normalizedVelocityLC = normalize(velocityLC);\n            //vec4 velocityWC = u_simulBoxTMat * vec4(velocityLC, 1.0);\n            //vec4 velocityDirCC = modelViewMatrixRelToEye * vec4(velocityWC.xyz, 1.0);\n\n            // Now, calculate alpha by normalCC.***\n            vec4 currNormalWC = u_simulBoxTMat * vec4(currNormalLC, 1.0);\n            vec4 currNormalCC = modelViewMatrixRelToEye * vec4(currNormalWC.xyz, 1.0);\n            vec3 normalCC = normalize(currNormalCC.xyz);\n            float dotProd = dot(camRay, normalCC);\n\n            // Now, accumulate the color.***\n            currColor4.rgb *= abs(dotProd);\n\n            vec4 vecAux = abs(vec4(currColor4.rgb, 1.0));\n \n            //if(length(currNormalLC) > 0.0)\n            {\n                finalColor4.rgb += (1.0 - finalColor4.a) * currColor4.a * vecAux.rgb; // test. render normal color:\n                finalColor4.a += (1.0 - finalColor4.a) * currColor4.a;\n            }\n            \n            totalVelocityLC += velocityLC;\n            smplingCount += 1.0;\n\n            // Optimization: break out of the loop when the color is near opaque\n            if (finalColor4.a >= 0.95) {\n                break;\n            }\n            \n            \n        }\n\n        currSamplePosLC += step_vector_LC;\n    }\n\n    if(smplingCount < 1.0)\n    {\n        smplingCount = 1.0;\n    }\n    \n    //float averageAirPressure = totalAirPressure / smplingCount;\n    //vec3 averageVelocityLC = totalVelocityLC / smplingCount;\n    //float averageDotProd = dotProdAccum / smplingCount;\n    //float averageDotProdInv = totalDotProdInv / smplingCount;\n    //averageDotProdInv /= dotProdFactor;\n\n    \n    //float f = 1.0;\n    //float deltaP = averageAirPressure - u_airEnvirontmentPressure;\n    //float maxPressure_reference = u_airMaxPressure;\n    //vec4 rainbowCol3 = getRainbowColor_byHeight(averageAirPressure * f, u_airEnvirontmentPressure, 1.05, false);//\n\n    //float alpha;\n    //if(deltaP > 0.0)\n    //if(deltaP > 0.00005)\n    {\n        // Test with velocity:\n        //vec4 velocityWC = u_simulBoxTMat * vec4(averageVelocityLC, 1.0);\n        //vec4 velocityDirCC = modelViewMatrixRelToEye * vec4(velocityWC.xyz, 1.0);\n\n        //vec3 lightDirLC = normalize(vec3(0.1, 0.1, -0.9));\n\n        //vec4 lightDirWC = u_simulBoxTMat * vec4(lightDirLC, 1.0);\n        //vec4 lightDirCC = modelViewMatrixRelToEye * vec4(lightDirWC.xyz, 1.0);\n        //float lightDotProd = abs(dot(normalize(lightDirCC.xyz), normalize(velocityDirCC.xyz)));\n        //float lightDotProd = -(dot(normalize(lightDirLC.xyz), normalize(averageVelocityLC.xyz)));\n\n        //float dotProd = abs(dot(camRay, normalize(velocityDirCC.xyz)));\n        //float dotProdInv = 1.0 - abs(dotProd);\n        //finalColor4.rgb *= lightDotProd;\n\n        //float alphaByP = deltaP * 10000.0 / u_airMaxPressure;\n        //alpha = min(averageDotProdInv, alphaByP);\n        //alpha = averageDotProdInv;// * 5.0;\n        //float alpha_final = min(alphaByP, alpha);\n        //color4Aux = vec4(rainbowCol3.rgb * averageDotProd, alphaByP);\n\n        color4Aux = finalColor4;\n    }\n\n    \n\n    // Now, check the max pressure record.***\n    // Must check the "scenePosTexCoord3d".***\n    /*\n    pressureType = 1; // maxPressureRecord.***\n    float sceneAirPressure;\n    vec3 sceneVelocityLC;\n    vec4 color_maxPressure = vec4(0.0);\n\n    if(get_airPressure_fromTexture3d_triLinearInterpolation(scenePosTexCoord3d_candidate, sceneAirPressure, sceneVelocityLC, pressureType))//\n    {\n        if(sceneAirPressure > u_airEnvirontmentPressure + 0.01)\n        {\n            maxPressure_reference = 1.6;\n            //vec3 sceneColor = getRainbowColor_byHeight(sceneAirPressure, 0.8, maxPressure_reference, false);//\n            color4Aux.rgb = getRainbowColor_byHeight(sceneAirPressure, 0.8, maxPressure_reference, false);//\n            color4Aux.a = 0.8;\n        }\n    }\n    */\n\n    gl_FragData[0] = color4Aux;\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = color4Aux;\n        gl_FragData[2] = color4Aux;\n        gl_FragData[3] = color4Aux;\n    #endif\n}\n\n/*\nuniform sampler3D tex;\nuniform sampler3D normals;\nuniform sampler2D colorMap;\n\nuniform mat4 transform;\nuniform int depthSampleCount;\nuniform float zScale;\n\nuniform vec3 lightPosition;\n\nuniform float brightness;\n\n//uniform vec4 opacitySettings;\n// x: minLevel\n// y: maxLevel\n// z: lowNode\n// w: highNode\n\nin vec2 texCoord;\n\n//in vec4 origin;\n//in vec4 direction;\n\nout vec4 color;\n\nvec3 ambientLight = vec3(0.34, 0.32, 0.32);\nvec3 directionalLight = vec3(0.5, 0.5, 0.5);\nvec3 lightVector = normalize(vec3(-1.0, -1.0, 1.0));\nvec3 specularColor = vec3(0.5, 0.5, 0.5);\n\nvec3 aabb[2] = vec3[2](\n\tvec3(0.0, 0.0, 0.0),\n\tvec3(1.0, 1.0, 1.0)\n);\n\nstruct Ray {\n    vec3 origin;\n    vec3 direction;\n    vec3 inv_direction;\n    int sign[3];\n};\n\nRay makeRay(vec3 origin, vec3 direction) {\n    vec3 inv_direction = vec3(1.0) / direction;\n    \n    return Ray(\n        origin,\n        direction,\n        inv_direction,\n        int[3](\n\t\t\t((inv_direction.x < 0.0) ? 1 : 0),\n\t\t\t((inv_direction.y < 0.0) ? 1 : 0),\n\t\t\t((inv_direction.z < 0.0) ? 1 : 0)\n\t\t)\n    );\n}\n\n/*\n\tFrom: https://github.com/hpicgs/cgsee/wiki/Ray-Box-Intersection-on-the-GPU\nvoid intersect(\n    in Ray ray, in vec3 aabb[2],\n    out float tmin, out float tmax\n){\n    float tymin, tymax, tzmin, tzmax;\n    tmin = (aabb[ray.sign[0]].x - ray.origin.x) * ray.inv_direction.x;\n    tmax = (aabb[1-ray.sign[0]].x - ray.origin.x) * ray.inv_direction.x;\n    tymin = (aabb[ray.sign[1]].y - ray.origin.y) * ray.inv_direction.y;\n    tymax = (aabb[1-ray.sign[1]].y - ray.origin.y) * ray.inv_direction.y;\n    tzmin = (aabb[ray.sign[2]].z - ray.origin.z) * ray.inv_direction.z;\n    tzmax = (aabb[1-ray.sign[2]].z - ray.origin.z) * ray.inv_direction.z;\n    tmin = max(max(tmin, tymin), tzmin);\n    tmax = min(min(tmax, tymax), tzmax);\n}\n*/\n\n\n/*\n\nvoid main(){\n\t\n\t//transform = inverse(transform);\n\t\n\tvec4 origin = vec4(0.0, 0.0, 2.0, 1.0);\n\torigin = transform * origin;\n\torigin = origin / origin.w;\n\torigin.z = origin.z / zScale;\n\torigin = origin + 0.5;\n\n\tvec4 image = vec4(texCoord, 4.0, 1.0);\n\timage = transform * image;\n\t//image = image / image.w;\n\timage.z = image.z / zScale;\n\timage = image + 0.5;\n\t//vec4 direction = vec4(0.0, 0.0, 1.0, 0.0);\n\tvec4 direction = normalize(origin-image);\n\t//direction = transform * direction;\n\n\tRay ray = makeRay(origin.xyz, direction.xyz);\n\tfloat tmin = 0.0;\n\tfloat tmax = 0.0;\n\tintersect(ray, aabb, tmin, tmax);\n\n\tvec4 value = vec4(0.0, 0.0, 0.0, 0.0);\n,\n\tif(tmin > tmax){\n\t\tcolor = value;\n\t\tdiscard;\n\t}\n\n\tvec3 start = origin.xyz + tmin*direction.xyz;\n\tvec3 end = origin.xyz + tmax*direction.xyz;\n\t\n\tfloat length = distance(end, start);\n\tint sampleCount = int(float(depthSampleCount)*length);\n\t//vec3 increment = (end-start)/float(sampleCount);\n\t//vec3 originOffset = mod((start-origin.xyz), increment);\n\n\tfloat s = 0.0;\n\tfloat px = 0.0;\n\tvec4 pxColor = vec4(0.0, 0.0, 0.0, 0.0);\n\tvec3 texCo = vec3(0.0, 0.0, 0.0);\n\tvec3 normal = vec3(0.0, 0.0, 0.0);\n\tvec4 zero = vec4(0.0);\n\t\n\tfor(int count = 0; count < sampleCount; count++){\n\n\t\ttexCo = mix(start, end, float(count)/float(sampleCount));// - originOffset;\n\n\t\t//texCo = start + increment*float(count);\n\t\tpx = texture(tex, texCo).r;\n\n\t\t\n\t\t//px = length(texture(normals, texCo).xyz - 0.5);\n\t\t//px = px * 1.5;\n\t\t\n\t\tpxColor = texture(colorMap, vec2(px, 0.0));\n\t\t\n\t\tnormal = normalize(texture(normals, texCo).xyz - 0.5);\n\t\tfloat directional = clamp(dot(normal, lightVector), 0.0, 1.0);\n\n\t\t//vec3 R = -reflect(lightDirection, surfaceNormal);\n\t\t//return pow(max(0.0, dot(viewDirection, R)), shininess);\n\n\t\tfloat specular = max(dot(direction.xyz, reflect(lightVector, normal)), 0.0);\n\t\tspecular = pow(specular, 3.0);\n\n\t\tpxColor.rgb = ambientLight*pxColor.rgb + directionalLight*directional*pxColor.rgb + pxColor.a*specular*specularColor;\n\t\t\t\n\t\t\n\t\t//value = mix(value, pxColor, px);\n\t\t//value = (1.0-value.a)*pxColor + value;\n\t\t//value = mix(pxColor, zero, value.a) + value;\n\t\t\n\t\tvalue = value + pxColor - pxColor*value.a;\n\t\t\n\t\tif(value.a >= 0.95){\n\t\t\tbreak;\n\t\t}\n\t}\n\tcolor = value*brightness;\n}\n*/\n',ssaoFromDepthFS:'\n#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D noiseTex;  \nuniform sampler2D normalTex;\n\nuniform mat4 projectionMatrix;\nuniform mat4 projectionMatrixInv;\n\nuniform float near;\nuniform float far;         \nuniform float fov;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight; \nuniform vec2 noiseScale;\nuniform vec2 uNearFarArray[4];\n\n\nuniform bool bApplySsao;\nuniform vec3 kernel[16]; \n\nconst int kernelSize = 16; \n\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\n\n/*\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n    // mago unpackDepth.***\n    const vec4 bit_shift = vec4(0.000000059605, 0.000015258789, 0.00390625, 1.0);// original.***\n    float depth = dot(rgba_depth, bit_shift);\n    return depth;\n}  \n*/\n\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(normalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n            \n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}         \n            \nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z*0.0001;\n        float Fcoef_half = uFCoef_logDepth/2.0;\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = (flogzAux - 1.0);\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord, inout bool isValid) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/screenWidth;\n    float pixelSizeY = 1.0/screenHeight;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<2.0; i++)\n\t{\n        float depthAux = getDepth(texCoord + offset1*(1.0+i));\n        if(depthAux > 0.996)\n        {\n            depthAux = depth;\n            isValid = false;\n        }\n\t\tdepthA += depthAux;\n\n        depthAux = getDepth(texCoord + offset2*(1.0+i));\n        if(depthAux > 0.996)\n        {\n            depthAux = depth;\n            isValid = false;\n        }\n\t\tdepthB += depth;\n\t}\n    \n\t//vec3 posA = reconstructPosition(texCoord + offset1*2.0, depthA/2.0);\n\t//vec3 posB = reconstructPosition(texCoord + offset2*2.0, depthB/2.0);\n    //vec3 pos0 = reconstructPosition(texCoord, depth);\n    \n    vec3 posA = getViewRay(texCoord + offset1*2.0, far)* depthA/2.0;\n\tvec3 posB = getViewRay(texCoord + offset2*2.0, far)* depthB/2.0;\n    vec3 pos0 = getViewRay(texCoord, far)* depth;\n\n    posA.z *= -1.0;\n    posB.z *= -1.0;\n    pos0.z *= -1.0;\n    \n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n    isValid = true;\n\n    return normalize(normal);\n}\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nfloat getOcclusion(vec3 origin, vec3 rotatedKernel, float radius, int originFrustumIdx)\n{\n    float result_occlusion = 0.0;\n    vec3 sample = origin + rotatedKernel * radius;\n    vec4 offset = projectionMatrix * vec4(sample, 1.0);\t// from view to clip-space\n    vec3 offsetCoord = vec3(offset.xyz);\t\t\t\t\n    offsetCoord.xyz /= offset.w; // perspective divide\n    offsetCoord.xyz = offsetCoord.xyz * 0.5 + 0.5;  // transform to range 0.0 - 1.0  \t\n\n    if(abs(offsetCoord.x) > 1.0 || abs(offsetCoord.y) > 1.0)\n    {\n        return result_occlusion;\n    }\n    vec4 normalRGBA = getNormal(offsetCoord.xy);\n    int estimatedFrustumIdx = int(floor(100.0*normalRGBA.w));\n    //int dataType = 0;\n    //int currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\n    vec2 nearFar = getNearFar_byFrustumIdx(estimatedFrustumIdx);\n    float currNear = nearFar.x;\n    float currFar = nearFar.y;\n    float depthBufferValue = getDepth(offsetCoord.xy);\n    //--------------------------------------------------------\n    // Objective : to compare "sampleZ" with "bufferZ".***\n    //--------------------------------------------------------\n    float sampleZ = -sample.z;\n    float bufferZ = depthBufferValue * currFar;\n    float zDiff = abs(bufferZ - sampleZ);\n    if(zDiff < radius)\n    {\n        //float rangeCheck = smoothstep(0.0, 1.0, radius/zDiff);\n        if (bufferZ < sampleZ)//-tolerance*1.0)\n        {\n            result_occlusion = 1.0;// * rangeCheck;\n        }\n    }\n    return result_occlusion;\n}\n\nfloat getFactorByDist(in float radius, in float realDist)\n{\n    float factorByDist = 1.0;\n    if(realDist < radius*5.0)\n    {\n        factorByDist = smoothstep(0.0, 1.0, realDist/(radius*5.0));\n    }\n    return factorByDist;\n}\n\n\n\nfloat getOcclusion_pointsCloud(vec2 screenPosAdjacent)\n{\n    float result_occlusion = 0.0;\n\n    vec4 normalRGBA_adjacent = getNormal(screenPosAdjacent);\n    int estimatedFrustumIdx = int(floor(100.0*normalRGBA_adjacent.w));\n\n    // check the data type of the pixel.\n    int dataType = -1;\n    int currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\n    vec2 nearFar_adjacent = getNearFar_byFrustumIdx(currFrustumIdx);\n    float currNear_adjacent = nearFar_adjacent.x;\n    float currFar_adjacent = nearFar_adjacent.y;\n\n    float depthBufferValue = getDepth(screenPosAdjacent);\n    //float zDist = currNear_adjacent + depthBufferValue * currFar_adjacent; // correct.\n    float zDist = depthBufferValue * currFar_adjacent;\n\n\n\n    return result_occlusion;\n}\n\n\nvoid main()\n{\n    float occlusion_A = 0.0;\n    float occlusion_B = 0.0;\n    float occlusion_C = 0.0;\n    float occlusion_D = 0.0;\n\n    vec3 normal = vec3(0.0);\n    vec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n    vec4 normalRGBA = getNormal(screenPos);\n    vec3 normal2 = normalRGBA.xyz; // original.***\n\n    // test check.\n    int estimatedFrustumIdx = int(floor(100.0*normalRGBA.w));\n    int dataType = 0; // 0= general geometry. 1= tinTerrain. 2= PointsCloud.\n\n    // Check the type of the data.******************\n    // dataType = 0 -> general geometry data.\n    // dataType = 1 -> tinTerrain data.\n    // dataType = 2 -> points cloud data.\n    //----------------------------------------------\n    int currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\n    // If the data is no generalGeomtry or pointsCloud, then discard.\n    //if(dataType != 0 && dataType != 2)\n    //discard;\n\n    vec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx); \n    float currNear = nearFar.x;\n    float currFar = nearFar.y;\n    float linearDepth = getDepth(screenPos);\n\n    // calculate the real pos of origin.\n    float origin_zDist = linearDepth * currFar;\n    vec3 origin_real = getViewRay(screenPos, origin_zDist);\n\n    float radius_A = 0.5;\n    float radius_B = 5.0;\n    float radius_C = 12.0;\n    float radius_D = 20.0;\n\n    float factorByDist = 1.0;\n    float realDist = -origin_real.z;\n\n    float aux = 30.0;\n    if(realDist < aux)\n    {\n        factorByDist = smoothstep(0.0, 1.0, realDist/(aux));\n    }\n\n    // Test. Variate the radius in function of "origin_zDist".***\n    //radius_A *= factorByDist;\n    //radius_B *= factorByDist;\n    //radius_C *= factorByDist;\n    //radius_D *= factorByDist;\n    // End test.-------------------------------------------------\n\n    // Now, factorByFarDist. When object are in far, no apply ssao.\n    float factorByFarDist = 1.0;\n    factorByFarDist = 1000.0/realDist;\n    if(factorByFarDist > 1.0)\n    factorByFarDist = 1.0;\n\n    factorByDist *= factorByFarDist;\n\n    if(factorByDist < 0.01)\n    discard;\n\n    // General data type.*************************************************************************************\n    if(dataType != 2 && bApplySsao)\n\t{        \n        vec3 origin = origin_real;\n        //vec3 origin = reconstructPosition(screenPos, linearDepth); // used when there are no normal-texture.\n        bool isValid = true;\n        \n        if(length(normal2) < 0.1)\n        isValid = false;\n        if(!isValid)\n        {\n            //gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);\n            //return;\n            discard;\n        }\n        normal = normal2;\n        \n\t\tvec3 rvec = texture2D(noiseTex, screenPos.xy * noiseScale).xyz * 2.0 - 1.0;\n\t\tvec3 tangent = normalize(rvec - normal2 * dot(rvec, normal2));\n\t\tvec3 bitangent = cross(normal2, tangent);\n\t\tmat3 tbn = mat3(tangent, bitangent, normal2);   \n\n\t\tfor(int i = 0; i < kernelSize; ++i)\n\t\t{    \t\n            vec3 rotatedKernel = tbn * vec3(kernel[i].x*1.0, kernel[i].y*1.0, kernel[i].z);\n\n            occlusion_A += getOcclusion(origin, rotatedKernel, radius_A, currFrustumIdx);\n            occlusion_B += getOcclusion(origin, rotatedKernel, radius_B, currFrustumIdx);\n            occlusion_C += getOcclusion(origin, rotatedKernel, radius_C, currFrustumIdx);\n            occlusion_D += getOcclusion(origin, rotatedKernel, radius_D, currFrustumIdx);\n\t\t} \n\n        occlusion_A *= factorByDist;\n        occlusion_B *= factorByDist;\n        occlusion_C *= factorByDist;\n        occlusion_D *= factorByDist;\n\n        float fKernelSize = float(kernelSize);\n\n\t\tocclusion_C = occlusion_C / fKernelSize;\t\n        if(occlusion_C < 0.0)\n        occlusion_C = 0.0;\n        else if(occlusion_C > 1.0)\n        occlusion_C = 1.0;\n\n        occlusion_B = occlusion_B / fKernelSize;\t\n        if(occlusion_B < 0.0)\n        occlusion_B = 0.0;\n        else if(occlusion_B > 1.0)\n        occlusion_B = 1.0;\n\n        occlusion_A = occlusion_A / fKernelSize;\t\n        if(occlusion_A < 0.0)\n        occlusion_A = 0.0;\n        else if(occlusion_A > 1.0)\n        occlusion_A = 1.0;\n\n        occlusion_D = occlusion_D / fKernelSize;\t\n        if(occlusion_D < 0.0)\n        occlusion_D = 0.0;\n        else if(occlusion_D > 1.0)\n        occlusion_D = 1.0;\n\n\t}\n\n    // Points cloud data type.**************************************************************************************\n    /*\n    if(dataType == 2 && bApplySsao)\n\t{        \n\t\tfloat linearDepth = getDepth(screenPos);\n\t\t//vec3 origin = getViewRay(screenPos) * linearDepth;\n\n\n\t\tvec4 normalRGBA = getNormal(screenPos);\n\t\tint currFrustumIdx = int(floor(100.0*normalRGBA.w));\n\n\t\tif(currFrustumIdx >= 10)\n\t\tcurrFrustumIdx -= 20;\n\n\t\tvec2 nearFar = getNearFar_byFrustumIdx(currFrustumIdx);\n\t\tfloat currNear = nearFar.x;\n\t\tfloat currFar = nearFar.y;\n\n\n\t\tfloat myZDist = currNear + linearDepth * currFar;\n\n\t\tfloat radiusAux = glPointSize/1.9; // radius in pixels.\n\t\tfloat radiusFog = glPointSize*3.0; // radius in pixels.\n\t\tvec2 screenPosAdjacent;\n\n\n\n\t\t// calculate the pixelSize in the screenPos.***\n\t\tfloat h = 2.0 * tangentOfHalfFovy * currFar * linearDepth; // height in meters of the screen in the current pixelDepth\n    \tfloat w = h * aspectRatio;     \t\t\t\t\t\t\t   // width in meters of the screen in the current pixelDepth\n\t\t// vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);   \n\n\t\tfloat pixelSize_x = w/screenWidth; // the pixelSize in meters in the x axis.\n\t\tfloat pixelSize_y = h/screenHeight;  // the pixelSize in meters in the y axis.\n\t\t\n\t\tfloat radiusInMeters = 0.20;\n\t\tradiusAux = radiusInMeters / pixelSize_x;\n\t\tfloat radiusFogInMeters = 1.0;\n\t\tradiusFog = radiusFogInMeters / pixelSize_x;\n\n\t\t//radiusAux = 6.0;\n\t\tfloat farFactor = 0.1*sqrt(myZDist);\n\t\t\n\n        //radiusAux = 1.5 *(float(j)+1.0);\n        for(int i = 0; i < 8; ++i)\n        {  \n            // Find occlussion.***  \t \n            if(i == 0)\n                screenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n            else if(i == 1)\n                screenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n            else if(i == 2)\n                screenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y - radiusAux) / screenHeight);\n            else if(i == 3)\n                screenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n            else if(i == 4)\n                screenPosAdjacent = vec2((gl_FragCoord.x + radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n            else if(i == 5)\n                screenPosAdjacent = vec2((gl_FragCoord.x)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n            else if(i == 6)\n                screenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y + radiusAux) / screenHeight);\n            else if(i == 7)\n                screenPosAdjacent = vec2((gl_FragCoord.x - radiusAux)/ screenWidth, (gl_FragCoord.y) / screenHeight);\n\n            vec4 normalRGBA_adjacent = getNormal(screenPosAdjacent);\n            int adjacentFrustumIdx = int(floor(100.0*normalRGBA_adjacent.w));\n\n            if(adjacentFrustumIdx >= 10)\n            adjacentFrustumIdx -= 20;\n\n            vec2 nearFar_adjacent = getNearFar_byFrustumIdx(adjacentFrustumIdx);\n            float currNear_adjacent = nearFar_adjacent.x;\n            float currFar_adjacent = nearFar_adjacent.y;\n\n            float depthBufferValue = getDepth(screenPosAdjacent);\n            float zDist = currNear_adjacent + depthBufferValue * currFar_adjacent;\n            float zDistDiff = abs(myZDist - zDist);\n\n            \n            \n            if(myZDist > zDist)\n            {\n                // My pixel is rear\n                if(zDistDiff > farFactor  &&  zDistDiff < 100.0)\n                occlusion +=  1.0;\n            }\n        }\n\n        float fKernelSize = float(kernelSize);\n\n\t\tocclusion_C = occlusion_C / fKernelSize;\t\n        if(occlusion_C < 0.0)\n        occlusion_C = 0.0;\n        else if(occlusion_C > 1.0)\n        occlusion_C = 1.0;\n\n        occlusion_B = occlusion_B / fKernelSize;\t\n        if(occlusion_B < 0.0)\n        occlusion_B = 0.0;\n        else if(occlusion_B > 1.0)\n        occlusion_B = 1.0;\n\n        occlusion_A = occlusion_A / fKernelSize;\t\n        if(occlusion_A < 0.0)\n        occlusion_A = 0.0;\n        else if(occlusion_A > 1.0)\n        occlusion_A = 1.0;\n\n        occlusion_D = occlusion_D / fKernelSize;\t\n        if(occlusion_D < 0.0)\n        occlusion_D = 0.0;\n        else if(occlusion_D > 1.0)\n        occlusion_D = 1.0;\n\t}\n    */\n\n    \n    // Do lighting.***\n    //float scalarProd = max(0.01, dot(normal, normalize(-ray)));\n   // scalarProd /= 3.0;\n\t//scalarProd += 0.666;\n    //gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0 - scalarProd);\n\n\tgl_FragColor = vec4(occlusion_A, occlusion_B, occlusion_C, occlusion_D);\n    //gl_FragColor = vec4(normal.xyz, 1.0);\n}',Test_QuadFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n \nuniform sampler2D diffuseTex;  \nvarying vec2 vTexCoord; \nvoid main()\n{          \n    vec4 textureColor = texture2D(diffuseTex, vec2(vTexCoord.s, vTexCoord.t));\n    gl_FragColor = textureColor; \n}\n",Test_QuadVS:"attribute vec3 position;\nattribute vec2 texCoord;\n\nuniform sampler2D diffuseTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform mat4 buildingRotMatrix;  \nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \n\nvoid main()\n{\t\n    vec4 rotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n    vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n}\n",textureCopyFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texToCopy;\nuniform bool u_textureFlipXAxis;\nuniform bool u_textureFlipYAxis;\nvarying vec2 v_tex_pos;\n\nvoid main()\n{\n    vec4 finalCol4;\n    float texCoordX, texCoordY;\n    if(u_textureFlipYAxis)\n    {\n        texCoordY =  1.0 - v_tex_pos.y;\n    }\n    else\n    {\n        texCoordY =  v_tex_pos.y;\n    }\n\n    if(u_textureFlipXAxis)\n    {\n        texCoordX =  1.0 - v_tex_pos.x;\n    }\n    else\n    {\n        texCoordX =  v_tex_pos.x;\n    }\n    \n    finalCol4 = texture2D(texToCopy, vec2(texCoordX, texCoordY));\n\n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = finalCol4; // depth\n        gl_FragData[2] = finalCol4; // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = finalCol4; // selection color\n    #endif\n\n}",textureCopyVS:"//precision mediump float;\n\nattribute vec2 position;\nvarying vec4 vColor; \nvarying vec2 v_tex_pos;\n\nvoid main() {\n\tvColor = vec4(0.2, 0.2, 0.2, 0.5);\n    gl_Position = vec4(1.0 - 2.0 * position, 0.0, 1.0);\n    v_tex_pos = position;\n}",TextureFS:"precision mediump float;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nvoid main()\n{\n    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n}",texturesMergerFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\nuniform sampler2D texture_0;  \nuniform sampler2D texture_1;\nuniform sampler2D texture_2;\nuniform sampler2D texture_3;\nuniform sampler2D texture_4;\nuniform sampler2D texture_5;\nuniform sampler2D texture_6;\nuniform sampler2D texture_7;\n\nuniform float externalAlphasArray[8];\nuniform int uActiveTextures[8];\nuniform vec4 uExternalTexCoordsArray[8]; // vec4 (minS, minT, maxS, maxT).\nuniform vec2 uMinMaxAltitudes; // used for altitudes textures as bathymetry.\n//uniform vec2 uMinMaxAltitudesBathymetryToGradient; // used for altitudes textures as bathymetry.\n\n// gradient white-blue vars.***\nuniform float uGradientSteps[16];\nuniform int uGradientStepsCount;\n\nvarying vec2 v_tex_pos;\n\nfloat getMinValue(float a, float b, float c)\n{\n    float x = min(a, b);\n    return min(x, c);\n}\n\nfloat getMaxValue(float a, float b, float c)\n{\n    float x = max(a, b);\n    return max(x, c);\n}\n\nbool isNan(float val)\n{\n  return (val <= 0.0 || 0.0 <= val) ? false : true;\n}\n\nvec3 RGBtoHSV(vec3 color)\n{\n    // https://stackoverflow.com/questions/13806483/increase-or-decrease-color-saturation\n    float r,g,b,h,s,v;\n    r= color.r;\n    g= color.g;\n    b= color.b;\n    float minVal = getMinValue( r, g, b );\n    float maxVal = getMaxValue( r, g, b );\n\n    v = maxVal;\n    float delta = maxVal - minVal;\n    if( maxVal != 0.0 )\n        s = delta / maxVal;        // s\n    else {\n        // r = g = b = 0        // s = 0, v is undefined\n        s = 0.0;\n        h = -1.0;\n        return vec3(h, s, 0.0);\n    }\n    if( r == maxVal )\n        h = ( g - b ) / delta;      // between yellow & magenta\n    else if( g == maxVal )\n        h = 2.0 + ( b - r ) / delta;  // between cyan & yellow\n    else\n        h = 4.0 + ( r - g ) / delta;  // between magenta & cyan\n    h *= 60.0;                // degrees\n    if( h < 0.0 )\n        h += 360.0;\n    if ( isNan(h) )\n        h = 0.0;\n    return vec3(h,s,v);\n}\n\nvec3 HSVtoRGB(vec3 color)\n{\n    int i;\n    float h,s,v,r,g,b;\n    h= color.r;\n    s= color.g;\n    v= color.b;\n    if(s == 0.0 ) {\n        // achromatic (grey)\n        r = g = b = v;\n        return vec3(r,g,b);\n    }\n    h /= 60.0;            // sector 0 to 5\n    i = int(floor( h ));\n    float f = h - float(i);          // factorial part of h\n    float p = v * ( 1.0 - s );\n    float q = v * ( 1.0 - s * f );\n    float t = v * ( 1.0 - s * ( 1.0 - f ) );\n    if( i == 0 ) \n    {\n        r = v;\n        g = t;\n        b = p;\n    }\n    else if(i == 1)\n    {\n        r = q;\n        g = v;\n        b = p;\n    }\n    else if(i == 2)\n    {\n        r = p;\n        g = v;\n        b = t;\n    }\n    else if(i == 3)\n    {\n        r = p;\n        g = q;\n        b = v;\n    }\n    else if(i == 4)\n    {\n        r = t;\n        g = p;\n        b = v;\n    }\n    else\n    {       // case 5:\n        r = v;\n        g = p;\n        b = q;\n    }\n    return vec3(r,g,b);\n}\n\nvec3 getSaturatedColor(vec3 color, float saturation)\n{\n    vec3 hsv = RGBtoHSV(color);\n    hsv.y *= saturation;\n    return HSVtoRGB(hsv);\n}\n\nvec3 getRainbowColor_byHeight(float height, float minHeight, float maxHeight)\n{\n\tfloat minHeight_rainbow = minHeight;\n\tfloat maxHeight_rainbow = maxHeight;\n\t\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\nvec3 getWhiteToBlueColor_byHeight(float height)//, float minHeight, float maxHeight)\n{\n    // White to Blue in 32 steps.\n    float gray = 1.0;\n    //gray = 1.0 - gray; // invert gray value (white to blue).\n    // calculate r, g, b values by gray.\n\n    // Test to quadratic gray scale.***\n    float stepGray = 1.0;\n\n    for(int i=0; i<16-1; i++)\n    {\n        if(i >= uGradientStepsCount-1)\n        break;\n\n        float stepValue = uGradientSteps[i];\n        float stepValue2 = uGradientSteps[i+1];\n\n        // check if is frontier.***\n        if(height >= uGradientSteps[0])\n        {\n            stepGray = 0.0;\n            break;\n        }\n\n        if(height <= stepValue && height > stepValue2)\n        {\n            // calculate decimal.***\n            //float decimal = (height - stepValue)/(stepValue2-stepValue);\n            float decimal = (stepValue - height)/(stepValue-stepValue2);\n            float unit = float (i);\n            float value = unit + decimal;\n            stepGray = value/float(uGradientStepsCount-1);\n            break;\n        }\n    }\n    gray = stepGray;\n\n\n    float r, g, b;\n\n    // Red.\n    if(gray >= 0.0 && gray < 0.15625) // [1, 5] from 32 divisions.\n    {\n        float minGray = 0.0;\n        float maxGray = 0.15625;\n        float maxR = 1.0;\n        float minR = 0.3515625; // 90/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        r = maxR - relativeGray*(maxR - minR);\n    }\n    else if(gray >= 0.15625 && gray < 0.40625) // [6, 13] from 32 divisions.\n    {\n        float minGray = 0.15625;\n        float maxGray = 0.40625;\n        float maxR = 0.3515625; // 90/256.\n        float minR = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        r = maxR - relativeGray*(maxR - minR);\n    }\n    else  // [14, 32] from 32 divisions.\n    {\n        r = 0.0;\n    }\n\n    // Green.\n    if(gray >= 0.0 && gray < 0.15625) // [1, 5] from 32 divisions.\n    {\n        g = 1.0; // 256.\n    }\n    else if(gray >= 0.15625 && gray < 0.5625) // [6, 18] from 32 divisions.\n    {\n        float minGray = 0.15625;\n        float maxGray = 0.5625;\n        float maxG = 1.0; // 256/256.\n        float minG = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        g = maxG - relativeGray*(maxG - minG);\n    }\n    else  // [18, 32] from 32 divisions.\n    {\n        g = 0.0;\n    }\n\n    // Blue.\n    if(gray < 0.5625)\n    {\n        b = 1.0;\n    }\n    else // gray >= 0.5625 && gray <= 1.0\n    {\n        float minGray = 0.5625;\n        float maxGray = 1.0;\n        float maxB = 1.0; // 256/256.\n        float minB = 0.0; // 0/256.\n        float relativeGray = (gray- minGray)/(maxGray - minGray);\n        b = maxB - relativeGray*(maxB - minB);\n    }\n\n    return vec3(r, g, b);\n}\n\n//vec4 mixColor(sampler2D tex)\nbool intersects(vec2 texCoord, vec4 extension)\n{\n    bool bIntersects = true;\n    float minS = extension.x;\n    float minT = extension.y;\n    float maxS = extension.z;\n    float maxT = extension.w;\n\n    if(texCoord.x < minS || texCoord.x > maxS)\n    return false;\n    else if(texCoord.y < minT || texCoord.y > maxT)\n    return false;\n\n    return bIntersects;\n}\n\nvoid getTextureColor(in int activeNumber, in vec4 currColor4, in vec2 texCoord,  inout bool victory, in float externalAlpha, in vec4 externalTexCoords, inout vec4 resultTextureColor)\n{\n    if(activeNumber == 1 || activeNumber == 2)\n    {\n        if(currColor4.w > 0.0 && externalAlpha > 0.0)\n        {\n            if(victory)\n            {\n                resultTextureColor = mix(resultTextureColor, currColor4, currColor4.w*externalAlpha);\n            }\n            else{\n                currColor4.w *= externalAlpha;\n                resultTextureColor = currColor4;\n            }\n            \n            victory = true;\n\n            // debug.\n            //resultTextureColor = mix(resultTextureColor, vec4(1.0, 1.0, 1.0, 1.0), 0.4);\n        }\n    }\n    else if(activeNumber == 10)\n    {\n        // Bathymetry texture.\n        float altitude = 1000000.0;\n        if(currColor4.w > 0.0)\n        {\n            // decode the grayScale.***\n\n            float r = currColor4.r * 256.0;\n            float g = currColor4.g;\n            float b = currColor4.b;\n\n            float height = currColor4.r;\n            float maxHeight;\n            float minHeight;\n            float numDivs;\n            float increHeight;\n\t\t\t\t\n\t\t\t\tif(r < 0.0001)\n\t\t\t\t{\n\t\t\t\t\t// considering r=0.\n\t\t\t\t\tminHeight = -2796.0;\n\t\t\t\t\tmaxHeight = -1000.0;\n\t\t\t\t\tnumDivs = 2.0;\n                    increHeight = (maxHeight - minHeight)/(numDivs);\n                    height = (256.0*g + b)/(128.0);\n\n                    //resultTextureColor.r = 1.0;\n                    //resultTextureColor.g = 0.0;\n                    //resultTextureColor.b = 0.0;\n                    //return;\n\t\t\t\t}\n\t\t\t\telse if(r > 0.5 && r < 1.5)\n\t\t\t\t{\n\t\t\t\t\t// considering r=1.\n\t\t\t\t\tminHeight = -1000.0;\n\t\t\t\t\tmaxHeight = -200.0;\n\t\t\t\t\tnumDivs = 2.0;\n                    increHeight = (maxHeight - minHeight)/(numDivs);\n                    height = (256.0*g + b)/(128.0);\n\n                    //resultTextureColor.r = 0.0;\n                    //resultTextureColor.g = 1.0;\n                    //resultTextureColor.b = 0.0;\n                    //return;\n\t\t\t\t}\n\t\t\t\telse if(r > 1.5 && r < 2.5)\n\t\t\t\t{\n\t\t\t\t\t// considering r=2.\n\t\t\t\t\tminHeight = -200.0;\n\t\t\t\t\tmaxHeight = 1.0;\n\t\t\t\t\tnumDivs = 123.0;\n                    increHeight = (maxHeight - minHeight)/(numDivs);\n                    height = (256.0*g + b)/(128.0);\n\t\t\t\t}\n\n\n\n\t\t\t\t//height = (256.0*g + b)/(128.0);\n                height = (256.0*g + b)/(numDivs);\n               // height = (256.0*g*increHeight + b*increHeight)- minHeight;\n            \n            //altitude = uMinMaxAltitudes.x + height * (uMinMaxAltitudes.y - uMinMaxAltitudes.x);\n\t\t    altitude = minHeight + height * (maxHeight -minHeight);\n            //altitude = height;\n            if(altitude < 0.0)\n            {\n                /*\n                float minHeight_rainbow = uMinMaxAltitudes.x;\n                float maxHeight_rainbow = 0.0;\n                float gray = (altitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n                vec4 seaColor;\n\n                float red = gray + 0.1;//float red = gray + 0.2;\n                float green = gray + 0.5;//float green = gray + 0.6;\n                float blue = gray*2.0 + 2.0;\n                seaColor = vec4(red, green, blue, 1.0);\n                */\n\n                vec3 seaColorRGB = getWhiteToBlueColor_byHeight(altitude);\n                vec4 seaColor = vec4(seaColorRGB, 1.0);\n\n                resultTextureColor = mix(resultTextureColor, seaColor, 0.99); \n            }\n\n        }\n    }\n}\n\nvoid main()\n{           \n    // Debug.\n    /*\n    if((v_tex_pos.x < 0.006 || v_tex_pos.x > 0.994) || (v_tex_pos.y < 0.006 || v_tex_pos.y > 0.994))\n    {\n        gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n        return;\n    }\n    */\n\n    vec2 texCoord = vec2(1.0 - v_tex_pos.x, 1.0 - v_tex_pos.y);\n\n    // Take the base color.\n    vec4 textureColor = vec4(0.0, 0.0, 0.0, 0.0);\n    bool victory = false;\n\n    if(uActiveTextures[0] > 0)\n    {\n        if(uActiveTextures[0] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[0];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[0], texture2D(texture_0, texCoord), texCoord,  victory, externalAlphasArray[0], uExternalTexCoordsArray[0], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[0], texture2D(texture_0, texCoord), texCoord,  victory, externalAlphasArray[0], uExternalTexCoordsArray[0], textureColor);\n        \n    }\n    if(uActiveTextures[1] > 0)\n    {\n        if(uActiveTextures[1] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[1];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[1], texture2D(texture_1, texCoord), texCoord,  victory, externalAlphasArray[1], uExternalTexCoordsArray[1], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[1], texture2D(texture_1, texCoord), texCoord,  victory, externalAlphasArray[1], uExternalTexCoordsArray[1], textureColor);\n    }\n    if(uActiveTextures[2] > 0)\n    {\n        if(uActiveTextures[2] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[2];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[2], texture2D(texture_2, texCoord), texCoord,  victory, externalAlphasArray[2], uExternalTexCoordsArray[2], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[2], texture2D(texture_2, texCoord), texCoord,  victory, externalAlphasArray[2], uExternalTexCoordsArray[2], textureColor);\n    }\n    if(uActiveTextures[3] > 0)\n    {\n        if(uActiveTextures[3] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[3];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[3], texture2D(texture_3, texCoord), texCoord,  victory, externalAlphasArray[3], uExternalTexCoordsArray[3], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[3], texture2D(texture_3, texCoord), texCoord,  victory, externalAlphasArray[3], uExternalTexCoordsArray[3], textureColor);\n    }\n    if(uActiveTextures[4] > 0)\n    {\n        if(uActiveTextures[4] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[4];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[4], texture2D(texture_4, texCoord), texCoord,  victory, externalAlphasArray[4], uExternalTexCoordsArray[4], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[4], texture2D(texture_4, texCoord), texCoord,  victory, externalAlphasArray[4], uExternalTexCoordsArray[4], textureColor);\n    }\n    if(uActiveTextures[5] > 0)\n    {\n        if(uActiveTextures[5] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[5];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[5], texture2D(texture_5, texCoord), texCoord,  victory, externalAlphasArray[5], uExternalTexCoordsArray[5], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[5], texture2D(texture_5, texCoord), texCoord,  victory, externalAlphasArray[5], uExternalTexCoordsArray[5], textureColor);\n    }\n    if(uActiveTextures[6] > 0)\n    {\n        if(uActiveTextures[6] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[6];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[6], texture2D(texture_6, texCoord), texCoord,  victory, externalAlphasArray[6], uExternalTexCoordsArray[6], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[6], texture2D(texture_6, texCoord), texCoord,  victory, externalAlphasArray[6], uExternalTexCoordsArray[6], textureColor);\n    }\n    if(uActiveTextures[7] > 0)\n    {\n        if(uActiveTextures[7] == 2)\n        {\n            // CustomImage. Must recalculate texCoords.\n            vec4 externalTexCoord = uExternalTexCoordsArray[7];\n            \n            // check if intersects.\n            vec2 texCoordAux = vec2(texCoord.x, 1.0-texCoord.y);\n            if(intersects(texCoordAux, externalTexCoord))\n            {\n                // convert myTexCoord to customImageTexCoord.\n                vec2 minTexCoord = vec2(externalTexCoord.x, externalTexCoord.y);\n                vec2 maxTexCoord = vec2(externalTexCoord.z, externalTexCoord.w);\n\n                texCoord.x = (texCoordAux.x - minTexCoord.x)/(maxTexCoord.x - minTexCoord.x);\n                texCoord.y = (texCoordAux.y - minTexCoord.y)/(maxTexCoord.y - minTexCoord.y);\n\n                texCoord.y = 1.0 - texCoord.y;\n                getTextureColor(uActiveTextures[7], texture2D(texture_7, texCoord), texCoord,  victory, externalAlphasArray[7], uExternalTexCoordsArray[7], textureColor);\n            }\n        }\n        else\n            getTextureColor(uActiveTextures[7], texture2D(texture_7, texCoord), texCoord,  victory, externalAlphasArray[7], uExternalTexCoordsArray[7], textureColor);\n    }\n    \n    if(!victory)\n    discard;\n    \n    gl_FragColor = textureColor;\n\t\n}",texturesMergerVS:"precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    //vec2 pos = a_pos*0.5;\n    gl_Position = vec4(1.0 - 2.0 * a_pos, 0, 1);\n}",TextureVS:"attribute vec3 position;\nattribute vec4 aVertexColor;\nattribute vec2 aTextureCoord;\nuniform mat4 Mmatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nvarying vec4 vColor;\nvarying vec2 vTextureCoord;\n\nvoid main()\n{\n    vec4 rotatedPos = Mmatrix * vec4(position.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\n    vColor=aVertexColor;\n    vTextureCoord = aTextureCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos;\n    \n}",thickLineExtrudedVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float uExtrudeHeight;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\n//                                   Bottom                                      Top\n//       \n//                        (1)                    (2)                  (3)                    (4)\n//                         +-----------------------+                   +-----------------------+ \n//                         |                       |                   |                       |\n//                         |                       |                   |                       |\n//                         *----------------------\x3e*                   *----------------------\x3e*\n//                         |                       |                   |                       |\n//                         |                       |                   |                       |\n//                         +-----------------------+                   +-----------------------+\n//                         (-1)                    (-2)                (-3)                    (-4)\n\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointWC(in vec3 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\treturn vec4(objPosHigh.xyz + objPosLow.xyz, 1.0);\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main()\n{\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\n    float currW = current.w;\n    float prevW = prev.w;\n    float nextW = next.w;\n\n    vec4 rotatedCurr = buildingRotMatrix * vec4(current.xyz, 1.0);\n    vec4 rotatedPrev = buildingRotMatrix * vec4(prev.xyz, 1.0);\n    vec4 rotatedNext = buildingRotMatrix * vec4(next.xyz, 1.0);\n\n\tfloat sense = 1.0;\n\tint orderInt = int(floor(currW + 0.1));\n    int orderIntPrev = int(floor(prevW + 0.1));\n    int orderIntNext = int(floor(nextW + 0.1));\n\n    float absOrderCurr = currW > 0.0? currW : currW*-1.0;\n    float absOrderPrev = prevW > 0.0? prevW : prevW*-1.0;\n    float absOrderNext = nextW > 0.0? nextW : nextW*-1.0;\n\n    float provisionalExtrudeHeght = 500.0; // provisional for debug.\n\n\n\n    // calculate the triangle's normal. To do it, calculate prevDir & currDir.\n    vec3 rotatedUp = normalize(vec3(( rotatedCurr.xyz + buildingPosLOW ) + buildingPosHIGH)); \n    vec3 rotatedPrevDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz));\n    vec3 rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n\n    // check if any dir is vertical.\n    //float dotPrev = abs(dot(rotatedUp, rotatedPrevDir));\n    //float dotCurr = abs(dot(rotatedUp, rotatedNextDir));\n    vec3 rotatedDir;\n    vec3 rotatedLeft;\n\n    \n    int faceType = 0; // 0= bottom, 1= rear, 2= top, 3= front, 4= left, 5= right.\n    int faceTypeNext = 0;\n\n    if(orderInt == 1)\n    {\n        //rotatedDir\n    }\n    else if(orderInt == -1)\n    {\n\n    }\n    else if(orderInt == 2)\n    {\n        \n    }\n    else if(orderInt == -2)\n    {\n        \n    }\n\n\n\n    vec4 rotatedOffSet;\n\n    \n    //////////////////////////////////////////////////////////////////////////////////////////////////\n\t//float aspect = viewport.x / viewport.y;\n\t//vec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\n    vec4 rotatedPos = vec4(rotatedCurr.xyz + rotatedOffSet.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\tvec4 posCC =  vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 finalPosProjected = ModelViewProjectionMatrixRelToEye * posCC;\n\tgl_Position = finalPosProjected; \n\n    vec4 orthoPos = modelViewMatrixRelToEye * posCC;\n\tvDepth = -orthoPos.z/far;\n\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n\n     // test.***\n    if(orderInt == 1 || orderInt == 11 || orderInt == 21 || orderInt == 31)\n    {\n        vColor = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    else if(orderInt == -1 || orderInt == -11 || orderInt == -21 || orderInt == -31)\n    {\n        vColor = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n    else if(orderInt == 2 || orderInt == 12 || orderInt == 22 || orderInt == 32)\n    {\n        vColor = vec4(0.0, 1.0, 1.0, 1.0);\n    }\n    else if(orderInt == -2 || orderInt == -12 || orderInt == -22 || orderInt == -32)\n    {\n        vColor = vec4(1.0, 1.0, 0.0, 1.0);\n    }\n\n    //if(isRear )\n    //{\n    //    vColor = vec4(1.0, 0.0, 1.0, 1.0);\n    //}\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",thickLineExtrudedVS__original:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\nuniform float uExtrudeHeight;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\n//                                   Bottom                                      Top\n//       \n//                        (1)                    (2)                  (3)                    (4)\n//                         +-----------------------+                   +-----------------------+ \n//                         |                       |                   |                       |\n//                         |                       |                   |                       |\n//                         *----------------------\x3e*                   *----------------------\x3e*\n//                         |                       |                   |                       |\n//                         |                       |                   |                       |\n//                         +-----------------------+                   +-----------------------+\n//                         (-1)                    (-2)                (-3)                    (-4)\n\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointWC(in vec3 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\treturn vec4(objPosHigh.xyz + objPosLow.xyz, 1.0);\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main()\n{\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\n    float currW = current.w;\n    float prevW = prev.w;\n    float nextW = next.w;\n\n    vec4 rotatedCurr = buildingRotMatrix * vec4(current.xyz, 1.0);\n    vec4 rotatedPrev = buildingRotMatrix * vec4(prev.xyz, 1.0);\n    vec4 rotatedNext = buildingRotMatrix * vec4(next.xyz, 1.0);\n\n\tfloat sense = 1.0;\n\tint orderInt = int(floor(currW + 0.1));\n    int orderIntPrev = int(floor(prevW + 0.1));\n    int orderIntNext = int(floor(nextW + 0.1));\n\n    float absOrderCurr = currW > 0.0? currW : currW*-1.0;\n    float absOrderPrev = prevW > 0.0? prevW : prevW*-1.0;\n    float absOrderNext = nextW > 0.0? nextW : nextW*-1.0;\n\n    float provisionalExtrudeHeght = 500.0; // provisional for debug.\n\n\n\n    // calculate the triangle's normal. To do it, calculate prevDir & currDir.\n    vec3 rotatedUp = normalize(vec3(( rotatedCurr.xyz + buildingPosLOW ) + buildingPosHIGH)); \n    vec3 rotatedPrevDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz));\n    vec3 rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n\n    // check if any dir is vertical.\n    //float dotPrev = abs(dot(rotatedUp, rotatedPrevDir));\n    //float dotCurr = abs(dot(rotatedUp, rotatedNextDir));\n    vec3 rotatedDir;\n    vec3 rotatedLeft;\n\n    \n    int faceType = 0; // 0= bottom, 1= rear, 2= top, 3= front, 4= left, 5= right.\n    int faceTypeNext = 0;\n\n    // Check current faceType.************************************************************\n    if(absOrderCurr > 10.0 && absOrderCurr < 20.0)\n    {\n        faceType = 1; // rear.\n\n        // so, add height to nextPoint.\n        rotatedCurr += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n    }\n    else if(absOrderCurr > 20.0 && absOrderCurr < 30.0)\n    {\n        faceType = 2; // top.\n\n        // so, add height to nextPoint.\n        rotatedCurr += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n    }\n    else if(absOrderCurr > 30.0 && absOrderCurr < 40.0)\n    {\n        faceType = 3; // front.\n\n        // so, add height to nextPoint.\n        //rotatedCurr += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n    }\n    else if(absOrderCurr > 40.0 && absOrderCurr < 50.0)\n    {\n        faceType = 4; // left.\n\n        // in this case, must check the orderType to decide add height value into upDirection.\n        if(orderInt == 41)\n        {\n            // is bottom point.\n        }\n        else if(orderInt == -41)\n        {\n            // is top point.\n\n        }\n    }\n\n    // Check next faceType.***************************************************************\n    if(absOrderNext > 10.0 && absOrderNext < 20.0)\n    {\n        faceTypeNext = 1;// rear.\n\n        // so, add height to nextPoint.\n        rotatedNext += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n        rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n    }\n    else if(absOrderNext > 20.0 && absOrderNext < 30.0)\n    {\n        faceTypeNext = 2;// top.\n\n        // so, add height to nextPoint.\n        rotatedNext += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n        rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n    }\n    else if(absOrderNext > 30.0 && absOrderNext < 40.0)\n    {\n        faceTypeNext = 3;// front.\n\n        // so, add height to nextPoint.\n        //rotatedNext += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n        //rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n    }\n    else if(absOrderNext > 40.0 && absOrderNext < 50.0)\n    {\n        faceTypeNext = 4;// left.\n\n        // so, add height to nextPoint.\n        //rotatedNext += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n        //rotatedNextDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n    }\n\n    vec4 rotatedOffSet;\n\n    if(faceType == 0)\n    {\n        // bottom.\n        if(orderInt == 1 || orderInt == -1)\n        {\n            rotatedDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz));\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n        else // currOrderInt = 2 || currOrderInt = -2\n        {\n            // check if nextPoint is vertical.\n            if(faceTypeNext == 1)\n            {\n                // next face is rear, so is vertical.\n                //rotatedDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n                rotatedDir = normalize(vec3(rotatedNext.xyz - rotatedPrev.xyz)); // in this case use prevDir.\n                rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            }\n            else\n            {\n                rotatedDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n                rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            }\n        }\n\n        if(orderInt > 0)\n        {\n            // do left.\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else\n        {\n            // do right.\n            rotatedOffSet = vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n        \n    }\n    else if(faceType == 1)\n    {\n        // rear.\n        if(orderInt == 11 || orderInt == -11)\n        {\n            rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n        else // orderInt == 12 || -12\n        {\n            rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n\n        if(orderInt > 0)\n        {\n            // do left.\n            rotatedOffSet = vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else\n        {\n            // do right.\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n    }\n    else if(faceType == 2)\n    {\n        // top.\n        if(orderInt == 21 || orderInt == -21)\n        {\n            rotatedDir = rotatedPrevDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n        else // orderInt == 22 || -22\n        {\n            // check if nextPoint is vertical.\n            if(faceTypeNext == 3) // front.\n            {\n                // next face is front, so is vertical.\n                rotatedDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz)); // in this case use prevDir.\n                rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            }\n            else\n            {\n                rotatedDir = normalize(vec3(rotatedNext.xyz - rotatedCurr.xyz));\n                rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            }\n            //rotatedDir = rotatedNextDir;\n            //rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n\n        if(orderInt > 0)\n        {\n            // do left.\n            rotatedOffSet = vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else\n        {\n            // do right.\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n    }\n    else if(faceType == 3)\n    {\n        // front.\n        if(orderInt == 31 || orderInt == -31)\n        {\n            rotatedDir = rotatedNextDir;\n            rotatedDir = normalize(vec3(rotatedCurr.xyz - rotatedPrev.xyz));\n            //rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            rotatedLeft = normalize(cross(rotatedUp, rotatedNextDir));\n        }\n        else // orderInt == 32 || -32\n        {\n            rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n        }\n\n        if(orderInt > 0)\n        {\n            // do left.\n            rotatedOffSet = vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else\n        {\n            // do right.\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n    }\n    else if(faceType == 4)\n    {\n        // left.\n        if(orderInt == 41 || orderInt == -41)\n        {\n            rotatedDir = rotatedPrevDir;\n            //rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedNextDir));\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n        else \n        {\n            //rotatedDir = rotatedPrevDir;\n            rotatedDir = rotatedNextDir;\n            rotatedLeft = normalize(cross(rotatedUp, rotatedDir));\n            rotatedOffSet = vec4(-rotatedLeft * thickness * 50.0, 1.0);\n        }\n\n        \n\n        if(orderInt < 0)\n        {\n            // add height.\n            rotatedOffSet += vec4(rotatedUp * provisionalExtrudeHeght, 0.0);\n            //rotatedOffSet += vec4(rotatedLeft * thickness * 50.0, 1.0);\n        }\n\n    }\n\n    \n    //////////////////////////////////////////////////////////////////////////////////////////////////\n\t//float aspect = viewport.x / viewport.y;\n\t//vec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\n    vec4 rotatedPos = vec4(rotatedCurr.xyz + rotatedOffSet.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\tvec4 posCC =  vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    vec4 finalPosProjected = ModelViewProjectionMatrixRelToEye * posCC;\n\tgl_Position = finalPosProjected; \n\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n\n     // test.***\n    if(orderInt == 1 || orderInt == 11 || orderInt == 21 || orderInt == 31)\n    {\n        vColor = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n    else if(orderInt == -1 || orderInt == -11 || orderInt == -21 || orderInt == -31)\n    {\n        vColor = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n    else if(orderInt == 2 || orderInt == 12 || orderInt == 22 || orderInt == 32)\n    {\n        vColor = vec4(0.0, 1.0, 1.0, 1.0);\n    }\n    else if(orderInt == -2 || orderInt == -12 || orderInt == -22 || orderInt == -32)\n    {\n        vColor = vec4(1.0, 1.0, 0.0, 1.0);\n    }\n\n    //if(isRear )\n    //{\n    //    vColor = vec4(1.0, 0.0, 1.0, 1.0);\n    //}\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",thickLineFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform bool bUseOutline;\nuniform int uFrustumIdx;\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vOrder;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main() {\n\tvec4 finalCol4 = vColor;\n\t\n\tif(vOrder <= 0.3 || vOrder >= 0.7)\n\t{\n\t\tfloat factor = 1.0;\n\t\tif(vOrder <= 0.3)\n\t\t{\n\t\t\tfactor = (0.3 - vOrder) / (0.3);\n\t\t}\n\t\telse if(vOrder >= 0.7)\n\t\t{\n\t\t\tfactor = (vOrder - 0.7) / (0.3);\n\t\t}\n\n\t\tif(bUseOutline)\n\t\t{\n\t\t\tvec4 outLineCol = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\tfinalCol4 = mix(vColor, outLineCol, factor);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfinalCol4 = vColor;\n\t\t}\n\t\t\n\t}\n\n\tgl_FragData[0] = finalCol4;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\tgl_FragData[1] = packDepth(vDepth);\n\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\t// original.***\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = finalCol4; \n\t\t\n\t}\n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",thickLineVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vOrder;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\t// Positive order.***\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\t// Negative order.***\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\n\t// To render outline : vOrder.********************************************************\n\t// In the outLine zone, the vOrder is near to zero or near to 1, so in fragment shader\n\t// use this information to render outline.***\n\tif(orderInt == 1 || orderInt == 2)\n\t{\n\t\tvOrder = 0.0;\n\t}\n\telse if(orderInt == -1 || orderInt == -2)\n\t{\n\t\tvOrder = 1.0;\n\t}\n\t//--------------------------------------------------------------------------------------\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * vCurrent;\n\tvDepth = -orthoPos.z/far;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1) // original.***\n\t{\n\t\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\t\tif(previousProjected.w > 0.0)\n\t\t{\n\t\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x); // left perpendicular.***\n\t\t}\n\t\telse\n\t\t{\n\t\t\tnormal = vec2(tangentPrev.y, -tangentPrev.x); // right perpendicular.***\n\t\t}\n\t}\n\telse\n\t{\n\t\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\t\tif(nextProjected.w > 0.0)\n\t\t{\n\t\t\tnormal = vec2(-tangentNext.y, tangentNext.x); // left perpendicular.***\n\t\t}\n\t\telse\n\t\t{\n\t\t\tnormal = vec2(tangentNext.y, -tangentNext.x); // right perpendicular.***\n\t\t}\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat direction = (thickness * sense * projectedDepth) / 1000.0;\n\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * direction, 0.0, 0.0);\n\tgl_Position = currentProjected + offset; \n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; \n\telse\n\t{\n\t\t// use this else to test.***\n\t\tvColor = oneColor4;\n\n\t\t// test debug::::\n\t\tif(orderInt == 1)\n\t\t{\n\t\t\tvColor = vec4(1.0, 0.0, 0.0, 1.0);\n\t\t}\n\t\telse if(orderInt == -1)\n\t\t{\n\t\t\tvColor = vec4(0.0, 1.0, 0.0, 1.0);\n\t\t}\n\t\telse if(orderInt == 2)\n\t\t{\n\t\t\tvColor = vec4(0.0, 0.0, 1.0, 1.0);\n\t\t}\n\t\telse if(orderInt == -2)\n\t\t{\n\t\t\tvColor = vec4(1.0, 1.0, 0.0, 1.0);\n\t\t}\n\t}\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",TinTerrainAltitudesFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nvarying float vAltitude;  \n\nvec4 packDepth(const in float depth)\n{\n    const vec4 bit_shift = vec4(16777216.0, 65536.0, 256.0, 1.0);\n    const vec4 bit_mask  = vec4(0.0, 0.00390625, 0.00390625, 0.00390625); \n    //vec4 res = fract(depth * bit_shift); // Is not precise.\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255); // Is better.\n    res -= res.xxyz * bit_mask;\n    return res;  \n}\n\nvec4 PackDepth32( in float depth )\n{\n    depth *= (16777216.0 - 1.0) / (16777216.0);\n    vec4 encode = fract( depth * vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return vec4( encode.xyz - encode.yzw / 256.0, encode.w ) + 1.0/512.0;\n}\n\nvoid main()\n{     \n    gl_FragData[0] = PackDepth32(vAltitude);\n\t//gl_FragData[0] = packDepth(-depth);\n}",TinTerrainAltitudesVS:"attribute vec3 position;\nuniform mat4 ModelViewProjectionMatrix;\n\nvarying float vAltitude;\n  \nvoid main()\n{\t\n    vec4 pos4 = vec4(position.xyz, 1.0);\n\tgl_Position = ModelViewProjectionMatrix * pos4;\n\tvAltitude = position.z;\n}\n",TinTerrainFS:'#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n  \nuniform sampler2D diffuseTex;  // 2\nuniform sampler2D diffuseTex_1;// 3\nuniform sampler2D diffuseTex_2;// 4\nuniform sampler2D diffuseTex_3;// 5\nuniform sampler2D diffuseTex_4;// 6\nuniform sampler2D diffuseTex_5;// 7\nuniform bool textureFlipYAxis;\nuniform bool bIsMakingDepth;\nuniform bool bExistAltitudes;\nuniform bool bApplyCaustics;\nuniform mat4 projectionMatrix;\nuniform mat4 projectionMatrixInv;\nuniform vec2 noiseScale;\nuniform float near;\nuniform float far;            \nuniform float fov;\nuniform float aspectRatio;    \nuniform float screenWidth;    \nuniform float screenHeight;      \nuniform int uActiveTextures[8];\nuniform float externalAlphasArray[8];\nuniform vec2 uMinMaxAltitudes;\n\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nvarying vec2 vTexCoord;   \n\nvarying vec3 diffuseColor;\nuniform vec3 specularColor;\nvarying float depthValue; // z buffer depth.\n    \nuniform float uTime;  \n\nuniform float externalAlpha;\nuniform bool bUseLogarithmicDepth;\nvarying vec3 vNormal;\nvarying float currSunIdx;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\n// Texture\'s vars.***\nvarying float vTileDepth;\n\n\nfloat unpackDepth(vec4 packedDepth)\n{\n\t// See Aras Pranckevičius\' post Encoding Floats to RGBA\n\t// http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/\n\t//vec4 packDepth( float v ) // function to packDepth.***\n\t//{\n\t//\tvec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n\t//\tenc = fract(enc);\n\t//\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\t//\treturn enc;\n\t//}\n\treturn dot(packedDepth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat UnpackDepth32( in vec4 pack )\n{\n    float depth = dot( pack, 1.0 / vec4(1.0, 256.0, 256.0*256.0, 16777216.0) );// 256.0*256.0*256.0 = 16777216.0\n    return depth * (16777216.0) / (16777216.0 - 1.0);\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n  return enc;\n}   \n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec3 getViewRay(vec2 tc)\n{\n    float hfar = 2.0 * tan(fov/2.0) * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n}\n\n//linear view space depth\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(diffuseTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\t// in this shader the depthTex is "diffuseTex"\n\t\treturn unpackDepth(texture2D(diffuseTex, coord.xy));\n\t}\n}\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/screenWidth;\n    float pixelSizeY = 1.0/screenHeight;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tvec2 origin = vec2(texCoord.x - pixelSizeX, texCoord.y - pixelSizeY);\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<3.0; i++)\n\t{\n\t\tdepthA += getDepth(origin + offset1*(1.0+i*2.0));\n\t\tdepthB += getDepth(origin + offset2*(1.0+i*2.0));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*2.0, depthA/3.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*2.0, depthB/3.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n\n\nvec3 getRainbowColor_byHeight(float height)\n{\n\tfloat minHeight_rainbow = -200.0;\n\tfloat maxHeight_rainbow = 0.0;\n\t\n\tfloat gray = (height - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\t\n\tif(gray < 0.16666)\n\t{\n\t\tb = 0.0;\n\t\tg = gray*6.0;\n\t\tr = 1.0;\n\t}\n\telse if(gray >= 0.16666 && gray < 0.33333)\n\t{\n\t\tb = 0.0;\n\t\tg = 1.0;\n\t\tr = 2.0 - gray*6.0;\n\t}\n\telse if(gray >= 0.33333 && gray < 0.5)\n\t{\n\t\tb = -2.0 + gray*6.0;\n\t\tg = 1.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.5 && gray < 0.66666)\n\t{\n\t\tb = 1.0;\n\t\tg = 4.0 - gray*6.0;\n\t\tr = 0.0;\n\t}\n\telse if(gray >= 0.66666 && gray < 0.83333)\n\t{\n\t\tb = 1.0;\n\t\tg = 0.0;\n\t\tr = -4.0 + gray*6.0;\n\t}\n\telse if(gray >= 0.83333)\n\t{\n\t\tb = 6.0 - gray*6.0;\n\t\tg = 0.0;\n\t\tr = 1.0;\n\t}\n\t\n\tfloat aux = r;\n\tr = b;\n\tb = aux;\n\t\n\t//b = -gray + 1.0;\n\t//if (gray > 0.5)\n\t//{\n\t//\tg = -gray*2.0 + 2.0; \n\t//}\n\t//else \n\t//{\n\t//\tg = gray*2.0;\n\t//}\n\t//r = gray;\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\n//#define SHOW_TILING\n#define TAU 6.28318530718 // https://www.shadertoy.com/view/4sXfDj\n#define MAX_ITER 5 // https://www.shadertoy.com/view/4sXfDj\n\n// Water Caustics with BCC-Noise :https://www.shadertoy.com/view/wlc3zr\n\nvec3 causticColor(vec2 texCoord)\n{\n\t// To avoid mosaic repetitions.******************\n\tfloat uPlus = texCoord.x - 1.0;\n\tfloat vPlus = texCoord.y - 1.0;\n\t//float timePlus = max(uPlus, vPlus);\n\tfloat timePlus = uPlus + vPlus;\n\tif(timePlus < 0.0)\n\ttimePlus = 0.0;\n\t// End avoid mosaic repetitions.-------------------------\n\t\n\t// Water turbulence effect by joltz0r 2013-07-04, improved 2013-07-07\n\tfloat time = (uTime+timePlus) * .5+23.0;\n    // uv should be the 0-1 uv of texture...\n\n\t\n\n\tvec2 uv = texCoord;\n    \n#ifdef SHOW_TILING\n\tvec2 p = mod(uv*TAU*2.0, TAU)-250.0;\n#else\n    vec2 p = mod(uv*TAU, TAU)-250.0;\n#endif\n\tvec2 i = vec2(p);\n\tfloat c = 1.0;\n\tfloat inten = .005;\n\n\tfor (int n = 0; n < MAX_ITER; n++) \n\t{\n\t\tfloat t = time * (1.0 - (3.5 / float(n+1)));\n\t\ti = p + vec2(cos(t - i.x) + sin(t + i.y), sin(t - i.y) + cos(t + i.x));\n\t\tc += 1.0/length(vec2(p.x / (sin(i.x+t)/inten),p.y / (cos(i.y+t)/inten)));\n\t}\n\tc /= float(MAX_ITER);\n\tc = 1.17-pow(c, 1.4);\n\tvec3 colour = vec3(pow(abs(c), 8.0));\n    colour = clamp(colour + vec3(0.0, 0.35, 0.5), 0.0, 1.0);\n\n\t#ifdef SHOW_TILING\n\t// Flash tile borders...\n\tvec2 pixel = 2.0 / vec2(screenWidth, screenHeight);//iResolution.xy;\n\tuv *= 2.0;\n\n\tfloat f = floor(mod(time*.5, 2.0)); \t// Flash value.\n\tvec2 first = step(pixel, uv) * f;\t\t   \t// Rule out first screen pixels and flash.\n\tuv  = step(fract(uv), pixel);\t\t\t\t// Add one line of pixels per tile.\n\tcolour = mix(colour, vec3(1.0, 1.0, 0.0), (uv.x + uv.y) * first.x * first.y); // Yellow line\n\t\n\t#endif\n\n\treturn colour;\n}\n\nvoid getTextureColor(in int activeNumber, in vec4 currColor4, in vec2 texCoord,  inout bool victory, in float externalAlpha, inout vec4 resultTextureColor)\n{\n    if(activeNumber == 1)\n    {\n        if(currColor4.w > 0.0 && externalAlpha > 0.0)\n        {\n            if(victory)\n            {\n                resultTextureColor = mix(resultTextureColor, currColor4, currColor4.w*externalAlpha);\n            }\n            else{\n                currColor4.w *= externalAlpha;\n                resultTextureColor = currColor4;\n            }\n            \n            victory = true;\n        }\n    }\n    else if(activeNumber == 2)\n    {\n        // custom image.\n        // Check uExternalTexCoordsArray.\n        \n    }\n}\n\n\n#define M_PI 3.1415926535897932384626433832795\n\nvoid main()\n{    \n\tfloat depthAux = -depthValue;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half; //flogz = 1.0 + gl_Position.z;\n\t\tdepthAux = gl_FragDepthEXT;\n\t}\n\t#endif\n\n\tvec2 texCoord;\n\n\tvec4 textureColor = vec4(0.0);\n\n\tif(colorType == 2) // texture color.\n\t{\n\t\t// Check if the texture is from a different depth tile texture.***\n\t\tvec2 finalTexCoord = vTexCoord;\n\t\t\n\t\tif(textureFlipYAxis)\n\t\t{\n\t\t\ttexCoord = vec2(finalTexCoord.s, 1.0 - finalTexCoord.t);\n\t\t}\n\t\telse{\n\t\t\ttexCoord = vec2(finalTexCoord.s, finalTexCoord.t);\n\t\t}\n\n\t\tbool firstColorSetted = false;\n\n\t\tif(uActiveTextures[2] > 0 && uActiveTextures[2] != 10)\n\t\t\tgetTextureColor(uActiveTextures[2], texture2D(diffuseTex, texCoord), texCoord,  firstColorSetted, externalAlphasArray[2], textureColor);\n\t\tif(uActiveTextures[3] > 0 && uActiveTextures[3] != 10)\n\t\t\tgetTextureColor(uActiveTextures[3], texture2D(diffuseTex_1, texCoord), texCoord,  firstColorSetted, externalAlphasArray[3], textureColor);\n\t\tif(uActiveTextures[4] > 0 && uActiveTextures[4] != 10)\n\t\t\tgetTextureColor(uActiveTextures[4], texture2D(diffuseTex_2, texCoord), texCoord,  firstColorSetted, externalAlphasArray[4], textureColor);\n\t\tif(uActiveTextures[5] > 0 && uActiveTextures[5] != 10)\n\t\t\tgetTextureColor(uActiveTextures[5], texture2D(diffuseTex_3, texCoord), texCoord,  firstColorSetted, externalAlphasArray[5], textureColor);\n\t\tif(uActiveTextures[6] > 0 && uActiveTextures[6] != 10)\n\t\t\tgetTextureColor(uActiveTextures[6], texture2D(diffuseTex_4, texCoord), texCoord,  firstColorSetted, externalAlphasArray[6], textureColor);\n\t\tif(uActiveTextures[7] > 0 && uActiveTextures[7] != 10)\n\t\t\tgetTextureColor(uActiveTextures[7], texture2D(diffuseTex_5, texCoord), texCoord,  firstColorSetted, externalAlphasArray[7], textureColor);\n\n\t\tif(textureColor.w == 0.0)\n\t\t{\n\t\t\tdiscard;\n\t\t\t//textureColor = vec4(1.0, 0.0, 1.0, 1.0); // test.\n\t\t}\n\n\t}\n\telse{\n\t\ttextureColor = oneColor4;\n\t}\n\n\ttextureColor.w = externalAlpha;\n\tvec4 fogColor = vec4(0.9, 0.9, 0.9, 1.0);\n\t\n\t\n\t// Dem image.***************************************************************************************************************\n\tfloat altitude = 1000000.0;\n\tif(uActiveTextures[5] == 10)\n\t{\n\t\t// Bathymetry.***\n\t\tvec4 layersTextureColor = texture2D(diffuseTex_3, texCoord);\n\t\t//if(layersTextureColor.w > 0.0)\n\t\t{\n\t\t\t// decode the grayScale.***\n\t\t\tfloat sumAux = layersTextureColor.r;// + layersTextureColor.g + layersTextureColor.b;// + layersTextureColor.w;\n\n\t\t\tfloat r = layersTextureColor.r*256.0;;\n\t\t\tfloat g = layersTextureColor.g;\n\t\t\tfloat b = layersTextureColor.b;\n\n\t\t\tfloat maxHeight;\n\t\t\tfloat minHeight;\n\t\t\tfloat numDivs;\n\t\t\tfloat increHeight;\n\t\t\tfloat height;\n\t\t\t\n\t\t\tif(r < 0.0001)\n\t\t\t{\n\t\t\t\t// considering r=0.\n\t\t\t\tminHeight = -2796.0;\n\t\t\t\tmaxHeight = -1000.0;\n\t\t\t\tnumDivs = 2.0;\n\t\t\t\tincreHeight = (maxHeight - minHeight)/(numDivs);\n\t\t\t\theight = (256.0*g + b)/(128.0);\n\t\t\t}\n\t\t\telse if(r > 0.5 && r < 1.5)\n\t\t\t{\n\t\t\t\t// considering r=1.\n\t\t\t\tminHeight = -1000.0;\n\t\t\t\tmaxHeight = -200.0;\n\t\t\t\tnumDivs = 2.0;\n\t\t\t\tincreHeight = (maxHeight - minHeight)/(numDivs);\n\t\t\t\theight = (256.0*g + b)/(128.0);\n\t\t\t}\n\t\t\telse if(r > 1.5 && r < 2.5)\n\t\t\t{\n\t\t\t\t// considering r=2.\n\t\t\t\tminHeight = -200.0;\n\t\t\t\tmaxHeight = 1.0;\n\t\t\t\tnumDivs = 123.0;\n\t\t\t\tincreHeight = (maxHeight - minHeight)/(numDivs);\n\t\t\t\theight = (256.0*g + b)/(128.0);\n\t\t\t}\n\n\t\t\theight = (256.0*g + b)/(numDivs);\n\t\t\taltitude = minHeight + height * (maxHeight -minHeight);\n\t\t}\n\t}\n\telse if(uActiveTextures[5] == 20)\n\t{\n\t\t// waterMarkByAlpha.***\n\t\t// Check only alpha component.\n\t\tvec4 layersTextureColor = texture2D(diffuseTex_3, texCoord);\n\t\tfloat alpha = layersTextureColor.a;\n\t\tif(alpha > 0.0)\n\t\t{\n\t\t\taltitude = -100.0;\n\t\t}\n\t\telse\n\t\t{\n\t\t\taltitude = 100.0;\n\t\t}\n\t}\n\n\t// End Dem image.------------------------------------------------------------------------------------------------------------\n\tfloat linearDepthAux = 1.0;\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\n\tvec3 ray = getViewRay(screenPos); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\n\tfloat linearDepth = getDepth(screenPos);  \n\tlinearDepthAux = linearDepth;\n\n\tvec3 normalFromDepth = vec3(0.0, 0.0, 1.0);\n\t//vec3 normalFromDepth = normal_from_depth(linearDepthAux, screenPos); // normal from depthTex.***\n\t//vec2 screenPosAux = vec2(0.5, 0.5);\n\n\t//vec3 rayAux = getViewRay(screenPosAux); // The "far" for depthTextures if fixed in "RenderShowDepthVS" shader.\n\t//float scalarProd = dot(normalFromDepth, normalize(-rayAux));\n\t//scalarProd /= 3.0;\n\t//scalarProd += 0.666;\n\n\t////scalarProd /= 2.0;\n\t////scalarProd += 0.5;\n\n\tfloat scalarProd = 1.0;\n\t\n\tif(altitude < 0.0)\n\t{\n\t\tfloat minHeight_rainbow = -100.0;\n\t\tfloat maxHeight_rainbow = 0.0;\n\t\tminHeight_rainbow = uMinMaxAltitudes.x;\n\t\tmaxHeight_rainbow = uMinMaxAltitudes.y;\n\t\t\n\t\tfloat gray = (altitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\t\t//float gray = (vAltitude - minHeight_rainbow)/(maxHeight_rainbow - minHeight_rainbow);\n\t\t//vec3 rainbowColor = getRainbowColor_byHeight(altitude);\n\n\t\t// caustics.*********************\n\t\tif(bApplyCaustics)\n\t\t{\n\t\t\tint tileDepth = int(floor(vTileDepth + 0.1));\n\t\t\tif(uTime > 0.0 && tileDepth > 6 && gray > 0.0)//&& altitude > -120.0)\n\t\t\t{\n\t\t\t\t// Active this code if want same size caustic effects for different tileDepths.***\n\t\t\t\t// Take tileDepth 14 as the unitary tile depth.\n\t\t\t\t//float tileDethDiff = float(16 - tileDepth);\n\t\t\t\t//vec2 cauticsTexCoord = texCoord*pow(2.0, tileDethDiff);\n\t\t\t\t//-----------------------------------------------------------------------\n\t\t\t\tvec2 cauticsTexCoord = texCoord;\n\t\t\t\tvec3 causticColor = causticColor(cauticsTexCoord)*gray*0.3;\n\t\t\t\ttextureColor = vec4(textureColor.r+ causticColor.x, textureColor.g+ causticColor.y, textureColor.b+ causticColor.z, 1.0);\n\t\t\t}\n\t\t}\n\t\t// End caustics.--------------------------\n\t\t\n\t\tif(gray < 0.05)\n\t\tgray = 0.05;\n\t\tfloat red = gray + 0.2;\n\t\tfloat green = gray + 0.6;\n\t\tfloat blue = gray*2.0 + 2.0;\n\t\tfogColor = vec4(red, green, blue, 1.0);\n\n\t\t// Something like to HillShade .*********************************************************************************\n\t\tvec3 lightDir = normalize(vec3(1.0, 1.0, 0.0));\n\t\tfloat scalarProd_2d = dot(lightDir, normalFromDepth);\n\t\t\n\t\tscalarProd_2d /= 2.0;\n\t\tscalarProd_2d += 0.8;\n\n\t\t//scalarProd_2d *= scalarProd_2d;\n\t\ttextureColor *= vec4(textureColor.r*scalarProd_2d, textureColor.g*scalarProd_2d, textureColor.b, textureColor.a);\n\t\t// End Something like to HillShade.---------------------------------------------------------------------------------\n\t\t\n\t\t// End test drawing grid.---\n\t\t//float specularReflectionCoef = 0.6;\n\t\t//vec3 specularColor = vec3(0.8, 0.8, 0.8);\n\t\t//textureColor = mix(textureColor, fogColor, 0.2); \n\t\t//gl_FragData[0] = vec4(finalColor.xyz + specularReflectionCoef * specular * specularColor , 1.0); // with specular.***\n\t\tgl_FragData[0] = vec4(textureColor.xyz * scalarProd, 1.0); // original.***\n\n\t\treturn;\n\t}\n\t//else{\n\t\t\n\t\t//if(uSeaOrTerrainType == 1)\n\t\t//discard;\n\t//}\n\t\n\t//vec4 finalColor = mix(textureColor, fogColor, vFogAmount); \n\n\t//gl_FragData[0] = vec4(finalColor.xyz * scalarProd, 1.0); // original.***\n\t//gl_FragData[0] = textureColor; // test.***\n\t//gl_FragData[0] = vec4(vNormal.xyz, 1.0); // test.***\n\tgl_FragData[0] = packDepth(depthAux);  // anything.\n\n\t\n\t#ifdef USE_MULTI_RENDER_TARGET\n\t\tgl_FragData[1] = packDepth(depthAux);  // depth.\n\t\tvec3 normal = vNormal;\n\t\tif(normal.z < 0.0)\n\t\tnormal *= -1.0;\n\t\tvec3 encodedNormal = encodeNormal(normal);\n\t\tgl_FragData[2] = vec4(encodedNormal, 0.005); // normal.***\n\t\t//gl_FragData[2] = vec4(0.0, 0.0, 1.0, 1.0); // normal.***\n\t\tgl_FragData[3] = vec4(textureColor); // albedo.***\n\t#endif\n\t\n}',TinTerrainVS:"\n\nattribute vec3 position;\nattribute vec3 normal;\n//attribute vec4 color4;\nattribute vec2 texCoord;\nattribute float altitude;\n\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\n\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 sunDirWC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float near;\nuniform float far;\nuniform bool bApplySpecularLighting;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\n// geographic.\nuniform int uTileDepth;\nuniform vec4 uTileGeoExtent; // (minLon, minLat, maxLon, maxLat).\nuniform int uTileDepthOfBindedTextures; // The depth of the tileTexture binded. Normally uTileDepth = uTileDepthOfBindedTextures, but if current tile has no texturesPrepared, then bind ownerTexture and change texCoords.\nuniform vec4 uTileGeoExtentOfBindedTextures; // (minLon, minLat, maxLon, maxLat).\n\nvarying vec3 vNormal;\nvarying vec2 vTexCoord;   \nvarying vec3 v3Pos;\nvarying float depthValue;\nvarying float vFogAmount;\n\nvarying vec3 vLightDir; \nvarying float vAltitude;\nvarying float flogz;\nvarying float Fcoef_half;\n\n// Texture's vars.***\nvarying float vTileDepth;\nvarying float vTexTileDepth;\n\n#define M_PI 3.1415926535897932384626433832795\n#define M_E 2.7182818284590452353602875\n\nfloat roundCustom(float number)\n{\n\tfloat numberResult = sign(number)*floor(abs(number)+0.5);\n\treturn numberResult;\n}\n\nfloat LatitudeRad_fromTexCoordY(float t, float minLatitudeRad, int tileDepth)\n{\n\t// No used. Is not precise.\n\tfloat PI_DIV_4 = M_PI/4.0;\n\tfloat tileDepthFloat = float(tileDepth);\n\tfloat aConst = (1.0/(2.0*M_PI))*pow(2.0, tileDepthFloat);\n\n\tfloat minT = roundCustom( aConst*(M_PI-log(tan(PI_DIV_4+minLatitudeRad/2.0))) );\n\tminT = 1.0 - minT;\n\n\tfloat tAux = t + minT;\n\ttAux = 1.0 - tAux;\n\tfloat latRad = 2.0*(atan(exp(M_PI-tAux/aConst))-PI_DIV_4);\n\t\n\treturn latRad;\n}\n\nfloat TexCoordY_fromLatitudeRad(float latitudeRad, float minLatitudeRad, int tileDepth, float aConst)\n{\n\tfloat PI_DIV_4 = M_PI/4.0;\n\tfloat minTTex = roundCustom(aConst*(M_PI-log(tan(PI_DIV_4+minLatitudeRad/2.0))));\n\tminTTex = 1.0 - minTTex;\n\n\tfloat newT = aConst*(M_PI-log(tan(PI_DIV_4+latitudeRad/2.0)));\n\tnewT = 1.0 - newT;\n\tnewT -= minTTex;\n\n\treturn newT;\n}\n\nvoid main()\n{\t\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\tvNormal = normalize((normalMatrix4 * vec4(normal.x, normal.y, normal.z, 1.0)).xyz); // original.***\n\tvLightDir = vec3(normalMatrix4*vec4(sunDirWC.xyz, 1.0)).xyz;\n\tvAltitude = altitude;\n\n\tvTileDepth = float(uTileDepth);\n\tvTexTileDepth = float(uTileDepthOfBindedTextures);\n\t/*\n\tif(bApplySpecularLighting)\n\t{\n\t\tapplySpecLighting = 1.0;\n\t}\n\telse{\n\t\tapplySpecLighting = -1.0;\n\t}\n\t*/\n\tv3Pos = (modelViewMatrixRelToEye * pos4).xyz;\n\tdepthValue = v3Pos.z/far;\n\n\t\tvTexCoord = texCoord;\n\n\n\t\t// ckeck if the texture is for this tile.\n\t\tif(uTileDepth != uTileDepthOfBindedTextures)\n\t\t{\n\t\t\tfloat thisMinLon = uTileGeoExtent.x;\n\t\t\tfloat thisMinLat = uTileGeoExtent.y;\n\t\t\tfloat thisMaxLon = uTileGeoExtent.z;\n\t\t\tfloat thisMaxLat = uTileGeoExtent.w;\n\t\t\tfloat thisLonRange = (thisMaxLon - thisMinLon);\n\n\t\t\tfloat thisMinLatRad = thisMinLat * M_PI/180.0;\n\t\t\tfloat thisMaxLatRad = thisMaxLat * M_PI/180.0;\n\n\t\t\tfloat texMinLon = uTileGeoExtentOfBindedTextures.x;\n\t\t\tfloat texMinLat = uTileGeoExtentOfBindedTextures.y;\n\t\t\tfloat texMaxLon = uTileGeoExtentOfBindedTextures.z;\n\n\t\t\tfloat texLonRange = (texMaxLon - texMinLon);\n\t\t\tfloat texMinLatRad = texMinLat * M_PI/180.0;\n\n\n\t\t\tfloat currLon = thisMinLon + texCoord.x * thisLonRange;\n\t\t\tfloat newS = (currLon - texMinLon) / texLonRange; // [0..1] range\n\n\t\t\tfloat aConstTex = (1.0/(2.0*M_PI))*pow(2.0, float(uTileDepthOfBindedTextures));\n\n\t\t\tfloat minT = TexCoordY_fromLatitudeRad(thisMinLatRad, texMinLatRad, uTileDepthOfBindedTextures, aConstTex); // [0..1] range\n\t\t\tfloat maxT = TexCoordY_fromLatitudeRad(thisMaxLatRad, texMinLatRad, uTileDepthOfBindedTextures, aConstTex); // [0..1] range\n\t\t\tfloat scaleT = maxT - minT;\n\t\t\tfloat newT = minT + texCoord.y * scaleT;\n\n\t\t\tvTexCoord = vec2(newS, newT);\n\t\t\t\n\n\t\t\t/*\n\t\t\t// CRS84.**************************************************\n\t\t\t// need know longitude & latitude of my texCoord.\n\t\t\tfloat currLon = thisMinLon + texCoord.x * thisLonRange;\n\t\t\tfloat currLat = thisMinLat + texCoord.y * thisLatRange;\n\n\t\t\t// calculate my minLon relative to texture.***\n\t\t\tfloat s = (currLon - texMinLon) / texLonRange; // [0..1] range\n\t\t\tfloat t = (currLat - texMinLat) / texLatRange; // [0..1] range\n\n\t\t\tvTexCoord = vec2(s, t);\n\t\t\t*/\n\t\t}\n\t\t\n\t\t\n\t\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\t\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://www.gamasutra.com/blogs/BranoKemen/20090812/85207/Logarithmic_Depth_Buffer.php\n\t\t// z = log(C*z + 1) / log(C*Far + 1) * w\n\t\t// https://android.developreference.com/article/21119961/Logarithmic+Depth+Buffer+OpenGL\n\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//---------------------------------------------------------------------------------\n\n\t\tflogz = 1.0 - v3Pos.z;\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n\n\t// calculate fog amount.\n\tfloat fogParam = 1.15 * v3Pos.z/(far - 10000.0);\n\tfloat fogParam2 = fogParam*fogParam;\n\tvFogAmount = fogParam2*fogParam2;\n\n\tif(vFogAmount < 0.0)\n\tvFogAmount = 0.0;\n\telse if(vFogAmount > 1.0)\n\tvFogAmount = 1.0;\n\t//vFogAmount = ((-v3Pos.z))/(far);\n}",update_frag:'precision highp float;\n\nuniform sampler2D u_particles;\nuniform sampler2D u_wind;\nuniform sampler2D u_windGlobeDepthTex;\nuniform sampler2D u_windGlobeNormalTex;\n\nuniform mat4 modelViewMatrixInv;\n\nuniform vec2 u_wind_res;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform vec3 u_geoCoordRadiansMax;\nuniform vec3 u_geoCoordRadiansMin;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_interpolation;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\nuniform bool u_flipTexCoordY_windMap;\nuniform vec4 u_visibleTilesRanges[16];\nuniform int u_visibleTilesRangesCount;\n\nuniform float tangentOfHalfFovy;\nuniform float far;            \nuniform float aspectRatio; \n\n// new uniforms test.\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 buildingRotMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 buildingRotMatrixInv;\nuniform vec2 uNearFarArray[4];\n\n#define M_PI 3.1415926535897932384626433832795\n\nvarying vec2 v_tex_pos;\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\n// wind speed lookup; use manual bilinear filtering based on 4 adjacent pixels for smooth interpolation\nvec2 lookup_wind(const vec2 uv) {\n    //return texture2D(u_wind, uv).rg; // lower-res hardware filtering\n\t\n    vec2 px = 1.0 / u_wind_res;\n    vec2 vc = (floor(uv * u_wind_res)) * px;\n    vec2 f = fract(uv * u_wind_res);\n    vec2 tl = texture2D(u_wind, vc).rg;\n    vec2 tr = texture2D(u_wind, vc + vec2(px.x, 0)).rg;\n    vec2 bl = texture2D(u_wind, vc + vec2(0, px.y)).rg;\n    vec2 br = texture2D(u_wind, vc + px).rg;\n    return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n\t\n}\n\n\nvec2 getOffset(vec2 particlePos, float radius)\n{\n\t// "particlePos" is a unitary position.\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\n\tfloat distortion = cos((minLatRad + particlePos.y * latRadRange ));\n\tfloat xOffset = (particlePos.x - 0.5)*distortion * lonRadRange * radius;\n\tfloat yOffset = (0.5 - particlePos.y) * latRadRange * radius;\n\n\treturn vec2(xOffset, yOffset);\n}\n/*\nvec3 get_NDCCoord(in vec2 pos)\n{\n\t// calculate the offset at the earth radius.***\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tvec2 offset = getOffset(pos, radius);\n\n\tfloat xOffset = offset.x;\n\tfloat yOffset = offset.y;\n\tvec4 rotatedPos = buildingRotMatrix * vec4(xOffset, yOffset, 0.0, 1.0);\n\t\n\tvec4 position = vec4((rotatedPos.xyz + buildingPosLOW - encodedCameraPositionMCLow) + ( buildingPosHIGH - encodedCameraPositionMCHigh), 1.0);\n\t\n\t// Now calculate the position on camCoord.***\n\tvec4 posCC = ModelViewProjectionMatrixRelToEye * position;\n\tvec3 ndc_coord = vec3(posCC.xyz/posCC.w);\n\n\treturn ndc_coord;\n}\n*/\n\nbool is_NDCCoord_InsideOfFrustum(in vec3 ndc_coord)\n{\n\tbool pointIsInside = true;\n\n\tfloat ndc_x = ndc_coord.x;\n\tfloat ndc_y = ndc_coord.y;\n\n\tif(ndc_x < -1.0)\n\t\treturn false;\n\telse if(ndc_x > 1.0)\n\t\treturn false;\n\telse if(ndc_y < -1.0)\n\t\treturn false;\n\telse if(ndc_y > 1.0)\n\t\treturn false;\n\t\n\treturn pointIsInside;\n}\n\nbool isPointInsideOfFrustum(in vec2 pos)\n{\n\tbool pointIsInside = true;\n\t\n\t// calculate the offset at the earth radius.***\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tvec2 offset = getOffset(pos, radius);\n\n\tfloat xOffset = offset.x;\n\tfloat yOffset = offset.y;\n\tvec4 rotatedPos = buildingRotMatrix * vec4(xOffset, yOffset, 0.0, 1.0);\n\t\n\tvec4 position = vec4(( rotatedPos.xyz + buildingPosLOW - encodedCameraPositionMCLow ) + ( buildingPosHIGH - encodedCameraPositionMCHigh ), 1.0);\n\t\n\t// Now calculate the position on camCoord.***\n\tvec4 posCC = ModelViewProjectionMatrixRelToEye * position;\n\tvec3 ndc_pos = vec3(posCC.xyz/posCC.w);\n\n\treturn is_NDCCoord_InsideOfFrustum(ndc_pos);\n}\n\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n    return ray;                      \n} \n\nvec4 decodeNormal(in vec4 normal)\n{\n\treturn vec4(normal.xyz * 2.0 - 1.0, normal.w);\n}\n\nvec4 getNormal(in vec2 texCoord)\n{\n    vec4 encodedNormal = texture2D(u_windGlobeNormalTex, texCoord);\n    return decodeNormal(encodedNormal);\n}\n\nint getRealFrustumIdx(in int estimatedFrustumIdx, inout int dataType)\n{\n    // Check the type of the data.******************\n    // frustumIdx 0 .. 3 -> general geometry data.\n    // frustumIdx 10 .. 13 -> tinTerrain data.\n    // frustumIdx 20 .. 23 -> points cloud data.\n    //----------------------------------------------\n    int realFrustumIdx = -1;\n    \n     if(estimatedFrustumIdx >= 10)\n    {\n        estimatedFrustumIdx -= 10;\n        if(estimatedFrustumIdx >= 10)\n        {\n            // points cloud data.\n            estimatedFrustumIdx -= 10;\n            dataType = 2;\n        }\n        else\n        {\n            // tinTerrain data.\n            dataType = 1;\n        }\n    }\n    else\n    {\n        // general geomtry.\n        dataType = 0;\n    }\n\n    realFrustumIdx = estimatedFrustumIdx;\n    return realFrustumIdx;\n}\n\nvec2 getNearFar_byFrustumIdx(in int frustumIdx)\n{\n    vec2 nearFar;\n    if(frustumIdx == 0)\n    {\n        nearFar = uNearFarArray[0];\n    }\n    else if(frustumIdx == 1)\n    {\n        nearFar = uNearFarArray[1];\n    }\n    else if(frustumIdx == 2)\n    {\n        nearFar = uNearFarArray[2];\n    }\n    else if(frustumIdx == 3)\n    {\n        nearFar = uNearFarArray[3];\n    }\n\n    return nearFar;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nvoid main() {\n    vec4 color = texture2D(u_particles, v_tex_pos);\n    vec2 pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a); // decode particle position from pixel RGBA\n\tvec2 windMapTexCoord = pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n    vec2 velocity = mix(u_wind_min, u_wind_max, lookup_wind(windMapTexCoord));\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\t// Calculate pixelSizes.**************************************************************************************************\n\t\n\tvec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\tfloat radius = length(buildingPos);\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\n\tfloat distortion = cos((minLatRad + pos.y * latRadRange ));\n\n\tfloat meterToLon = 1.0/(radius * distortion);\n\tfloat meterToLat = 1.0 / radius;\n\n\tfloat xSpeedFactor = meterToLon / lonRadRange;\n\tfloat ySpeedFactor = meterToLat / latRadRange;\n\n\txSpeedFactor *= 3.0 * u_speed_factor;\n\tySpeedFactor *= 3.0 * u_speed_factor;\n\n\tvec2 offset = vec2(velocity.x / distortion * xSpeedFactor, -velocity.y * ySpeedFactor);\n\n\t// End ******************************************************************************************************************\n\n\t\n\n    // update particle position, wrapping around the date line\n    pos = fract(1.0 + pos + offset);\n\n\n    // drop rate is a chance a particle will restart at random position, to avoid degeneration\n\tfloat drop = 0.0;\n\n\t//if(u_interpolation < 0.99) // 0.9\n\t//{\n\t//\tdrop = 0.0;\n\t//}\n\t//else\n\t{\n\t\t// a random seed to use for the particle drop\n\t\tvec2 seed = (pos + v_tex_pos) * u_rand_seed;\n\t\tfloat drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n\t\tdrop = step(1.0 - drop_rate, rand(seed));\n\t}\n\t/*\n\tif(drop > 0.5) // 0.01\n\t{\n\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\tfloat randomValue = (u_rand_seed);\n\t\tint index = int(floor(float(u_visibleTilesRangesCount+1)*(randomValue)));\n\t\tfor(int i=0; i<32; i++)\n\t\t{\n\t\t\tif(i >= u_visibleTilesRangesCount)\n\t\t\tbreak;\n\t\t\n\t\t\tif(i == index)\n\t\t\t{\n\t\t\t\tvec4 posAux4 = u_visibleTilesRanges[i];\n\t\t\t\tfloat width = (posAux4.z-posAux4.x);\n\t\t\t\tfloat height = (posAux4.w-posAux4.y);\n\t\t\t\tfloat scaledX = posAux4.x + random_pos.x*width;\n\t\t\t\tfloat scaledY = posAux4.y + random_pos.y*height;\n\t\t\t\trandom_pos = vec2(scaledX, 1.0-scaledY);\n\t\t\t\tpos = random_pos;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\t*/\n\tif(drop > 0.01)\n\t{\n\t\t// Intersection ray with globe mode:\n\t\tvec2 random_screenPos = vec2( rand(pos), rand(v_tex_pos) );\n\t\tvec4 normal4 = getNormal(random_screenPos);\n\t\tvec3 normal = normal4.xyz;\n\t\tif(length(normal) < 0.1)\n\t\t{\n\t\t\t// do nothing.\n\t\t}\n\t\telse\n\t\t{\n\t\t\tint estimatedFrustumIdx = int(floor(normal4.w * 100.0));\n\t\t\tint dataType = -1;\n\t\t\tint currFrustumIdx = getRealFrustumIdx(estimatedFrustumIdx, dataType);\n\t\t\tvec2 nearFar_origin = getNearFar_byFrustumIdx(currFrustumIdx);\n\t\t\tfloat currNear_origin = nearFar_origin.x;\n\t\t\tfloat currFar_origin = nearFar_origin.y;\n\n\t\t\tvec4 depth4 = texture2D(u_windGlobeDepthTex, random_screenPos);\n\t\t\tfloat linearDepth = unpackDepth(depth4);\n\t\t\tfloat relativeFar = linearDepth * currFar_origin;\n\t\t\tvec3 posCC = getViewRay(random_screenPos, relativeFar);  \n\t\t\tvec4 posWC = modelViewMatrixInv * vec4(posCC, 1.0);\n\n\t\t\t// convert nearP(wc) to local coord.\n\t\t\tposWC.x -= (buildingPosHIGH.x + buildingPosLOW.x);\n\t\t\tposWC.y -= (buildingPosHIGH.y + buildingPosLOW.y);\n\t\t\tposWC.z -= (buildingPosHIGH.z + buildingPosLOW.z);\n\n\t\t\tvec4 posLC = buildingRotMatrixInv * vec4(posWC.xyz, 1.0);\n\n\t\t\t// now, convert localPos to unitary-offset position.\n\t\t\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\t\t\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\t\t\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\t\t\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\t\t\tfloat lonRadRange = maxLonRad - minLonRad;\n\t\t\tfloat latRadRange = maxLatRad - minLatRad;\n\n\t\t\t// Calculate the inverse of xOffset & yOffset.****************************************\n\t\t\t// Remember : float xOffset = (particlePos.x - 0.5)*distortion * lonRadRange * radius;\n\t\t\t// Remember : float yOffset = (0.5 - particlePos.y) * latRadRange * radius;\n\t\t\t//------------------------------------------------------------------------------------\n\t\t\t\n\t\t\tfloat unitaryOffset_y = 0.5 - (posLC.y / (latRadRange * radius));\n\t\t\tfloat distortion = cos((minLatRad + unitaryOffset_y * latRadRange ));\n\t\t\tfloat unitaryOffset_x = (posLC.x /(distortion * lonRadRange * radius)) + 0.5;\n\n\t\t\tpos = vec2(unitaryOffset_x, unitaryOffset_y);\n\t\t}\n\t}\n\t\n\t/*\n\tif(drop > 0.01)\n\t{\n\t\t// Methode 2:\n\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\t\n\t\t// New version:\n\t\t// try to born inside of the camera\'s frustum.\n\n\t\tvec2 posA = vec2(pos);\n\t\tvec2 posB = vec2(v_tex_pos);\n\t\tbool isInsideOfFrustum = false;\n\t\tfor(int i=0; i<30; i++)\n\t\t{\n\t\t\tif(isPointInsideOfFrustum(random_pos))\n\t\t\t{\n\t\t\t\tisInsideOfFrustum = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tposA.x = random_pos.y;\n\t\t\t\tposA.y = random_pos.x;\n\n\t\t\t\tposB.x = random_pos.x;\n\t\t\t\tposB.y = random_pos.y;\n\n\t\t\t\trandom_pos = vec2( rand(posA), rand(posB) );\n\t\t\t}\n\t\t}\n\n\t\tpos = random_pos;\n\t}\n\t*/\n\n    // encode the new particle position back into RGBA\n    gl_FragColor = vec4(\n        fract(pos * 255.0),\n        floor(pos * 255.0) / 255.0);\n}',vectorMeshClampToTerrainFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\nuniform bool bUseLogarithmicDepth;\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\n\nvoid main() {\n\tgl_FragColor = vColor;\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",vectorMeshClampToTerrainVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth; // no use.\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\t//float order_w = float(order);\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1)\n\t{\n\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x);\n\t}\n\telse{\n\t\tnormal = vec2(-tangentNext.y, tangentNext.x);\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat direction = (thickness*sense*projectedDepth)/1000.0;\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * direction, 0.0, 1.0);\n\tgl_Position = currentProjected + offset; \n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\t\t//gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\t\tflogz = 1.0 + gl_Position.w;\n\t\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",waterCalculateContaminationFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainHeightTex;\nuniform sampler2D currWaterFluxTex_HIGH;\nuniform sampler2D currWaterFluxTex_LOW;\nuniform sampler2D contaminantHeightTex;\n\nvarying vec2 v_tex_pos; // texCoords.\n#define PI 3.1415926\n\nuniform float u_SimRes;\nuniform float u_PipeLen; // pipeLen = cellSizeX = cellSizeY.\nuniform float u_timestep;\nuniform float u_PipeArea;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_heightMap_MinMax;\nuniform float u_waterMaxHeigh;\nuniform float u_waterMaxFlux;\nuniform float u_waterMaxVelocity;\nuniform float u_contaminantMaxHeigh;\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\n\nvec2 encodeVelocity(in vec2 vel)\n{\n\treturn vel*0.5 + 0.5;\n}\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    float decoded = unpackDepth(color4);\n    float contaminHeight = decoded * u_contaminantMaxHeigh;\n    return contaminHeight;\n}\n\nvec4 getWaterFlux(in vec2 texCoord)\n{\n    vec4 color4_HIGH = texture2D(currWaterFluxTex_HIGH, texCoord);\n    vec4 color4_LOW = texture2D(currWaterFluxTex_LOW, texCoord);\n\n    float flux_top = decodeRG(vec2(color4_HIGH.r, color4_LOW.r));\n    float flux_right = decodeRG(vec2(color4_HIGH.g, color4_LOW.g));\n    float flux_bottom = decodeRG(vec2(color4_HIGH.b, color4_LOW.b));\n    float flux_left = decodeRG(vec2(color4_HIGH.a, color4_LOW.a));\n\n    vec4 flux = vec4(flux_top, flux_right, flux_bottom, flux_left) * u_waterMaxFlux;\n    return flux; \n}\n\nvoid encodeWaterFlux(vec4 flux, inout vec4 flux_high, inout vec4 flux_low)\n{\n    vec2 encoded_top_flux = encodeRG(flux.r);\n    vec2 encoded_right_flux = encodeRG(flux.g);\n    vec2 encoded_bottom_flux = encodeRG(flux.b);\n    vec2 encoded_left_flux = encodeRG(flux.a);\n\n    flux_high = vec4(encoded_top_flux.r, encoded_right_flux.r, encoded_bottom_flux.r, encoded_left_flux.r);\n    flux_low = vec4(encoded_top_flux.g, encoded_right_flux.g, encoded_bottom_flux.g, encoded_left_flux.g);\n}\n\nvoid main()\n{\n    vec2 curuv = vec2(v_tex_pos.x, v_tex_pos.y);\n    curuv = v_tex_pos;\n\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n    float cellArea = cellSize_x * cellSize_y;\n\n    vec4 topflux = getWaterFlux(curuv + vec2(0.0, divY));\n    vec4 rightflux = getWaterFlux(curuv + vec2(divX, 0.0));\n    vec4 bottomflux = getWaterFlux(curuv + vec2(0.0, -divY));\n    vec4 leftflux = getWaterFlux(curuv + vec2(-divX, 0.0));\n    vec4 curflux = getWaterFlux(curuv);\n    //vec4 curT = texture2D(terrainHeightTex, vec2(v_tex_pos.x, v_tex_pos.y));\n    //curT = u_heightMap_MinMax.x + curT * u_heightMap_MinMax.y;\n    float topWH = getWaterHeight(curuv + vec2(0.0, divY));\n    float rightWH = getWaterHeight(curuv + vec2(divX, 0.0));\n    float bottomWH = getWaterHeight(curuv + vec2(0.0, -divY));\n    float leftWH = getWaterHeight(curuv + vec2(-divX, 0.0));\n    float currWH = getWaterHeight(curuv);\n    \n    float topContaminHeight = getContaminantHeight(curuv + vec2(0.0, divY));\n    float rightContaminHeight = getContaminantHeight(curuv + vec2(divX, 0.0));\n    float bottomContaminHeight = getContaminantHeight(curuv + vec2(0.0, -divY));\n    float leftContaminHeight = getContaminantHeight(curuv + vec2(-divX, 0.0));\n    float currContaminHeight = getContaminantHeight(curuv);\n\n    \n    \n    //out flow flux\n    float ftopout = curflux.x;\n    float frightout = curflux.y;\n    float fbottomout = curflux.z;\n    float fleftout = curflux.w;\n\n    vec4 outputflux = curflux;\n    vec4 inputflux = vec4(topflux.z, rightflux.w, bottomflux.x, leftflux.y);\n\n    float fout = ftopout + frightout + fbottomout + fleftout;\n    float fin = inputflux.x + inputflux.y + inputflux.z + inputflux.w;\n\n    \n\n    float deltaH = u_timestep * (fin - fout) / cellArea; \n    //---------------------------------------------------------------------------------\n    // do contaminant flux interchange.\n    // Top.***\n    float topOutContaminH = (curflux.x * u_timestep / cellArea) * (currContaminHeight / currWH);\n    float topInContaminH = (topflux.z * u_timestep / cellArea) * (topContaminHeight / topWH);\n    float topContaminDelta = topInContaminH - topOutContaminH;\n\n    // Right.***\n    float rightOutContaminH = (curflux.y * u_timestep / cellArea) * (currContaminHeight / currWH);\n    float rightInContaminH = (rightflux.w * u_timestep / cellArea) * (rightContaminHeight / rightWH);\n    float rightContaminDelta = rightInContaminH - rightOutContaminH;\n\n    // Bottom.***\n    float bottomOutContaminH = (curflux.z * u_timestep / cellArea) * (currContaminHeight / currWH);\n    float bottomInContaminH = (bottomflux.x * u_timestep / cellArea) * (bottomContaminHeight / bottomWH);\n    float bottomContaminDelta = bottomInContaminH - bottomOutContaminH;\n\n    // Left.***\n    float leftOutContaminH = (curflux.w * u_timestep / cellArea) * (currContaminHeight / currWH);\n    float leftInContaminH = (leftflux.y * u_timestep / cellArea) * (leftContaminHeight / leftWH);\n    float leftContaminDelta = leftInContaminH - leftOutContaminH;\n\n    float newContaminantHeight = max(0.0, topContaminDelta + rightContaminDelta + bottomContaminDelta + leftContaminDelta);\n    //----------------------------------------------------------------------------------\n\n    //float d1 = cur.y + curs.x; // original. (waterH + sedimentH).\n    float d1 = currWH;\n    float d2 = d1 + deltaH;\n    float da = (d1 + d2)/2.0;\n\n    vec2 veloci = vec2(inputflux.w - outputflux.w + outputflux.y - inputflux.y, inputflux.z - outputflux.z + outputflux.x - inputflux.x) / 2.0;\n\n    vec4 shaderLogColor4 = vec4(0.0);\n\n    if(da <= 1e-8) \n    {\n        veloci = vec2(0.0);\n    }\n    else\n    {\n        //veloci = veloci/(da * u_PipeLen);\n        veloci = veloci/(da * vec2(cellSize_y, cellSize_x));\n    }\n\n    if(curuv.x <= divX) { deltaH = 0.0; veloci = vec2(0.0); }\n    if(curuv.x >= 1.0 - 2.0 * divX) { deltaH = 0.0; veloci = vec2(0.0); }\n    if(curuv.y <= divY) { deltaH = 0.0; veloci = vec2(0.0); }\n    if(curuv.y >= 1.0 - 2.0 * divY) { deltaH = 0.0; veloci = vec2(0.0); }\n\n    //  float absx = abs(veloci.x);\n    //  float absy = abs(veloci.y);\n    //  float maxxy = max(absx, absy);\n    //  float minxy = min(absx, absy);\n    //  float tantheta = minxy / maxxy;\n    //  float scale = cos(45.0 * PI / 180.0 - atan(tantheta));\n    //  float divtheta = (1.0/sqrt(2.0)) / scale;\n    //  float divs = min(abs(veloci.x), abs(veloci.y))/max(abs(veloci.x), abs(veloci.y));\n    //  if((divs) > 20.0){\n    //    veloci /= 20.0;\n    //  }\n\n    \n\n    vec2 encodedVelocity = encodeVelocity(veloci/u_waterMaxVelocity);\n    vec4 writeVel = vec4(encodedVelocity, 0.0, 1.0);\n    //vec4 writeWaterHeight = vec4(cur.x,max(cur.y+deltavol, 0.0),cur.z,cur.w); // original.***\n\n    // test debug:\n    //if(abs(veloci.x) > 40.0 || abs(veloci.y) > 40.0)\n    {\n        shaderLogColor4 = vec4(encodedVelocity, 0.0, 1.0);\n    }\n\n    float waterHeight = max(currWH + deltaH, 0.0); // original.***\n    waterHeight /= u_waterMaxHeigh; // original.***\n\n    vec4 encodedWH = packDepth(waterHeight);\n    gl_FragData[0] = encodedWH;  // water height.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = writeVel; // velocity\n        gl_FragData[2] = shaderLogColor4; // \n        gl_FragData[3] = vec4(0.0); // \n        gl_FragData[4] = vec4(0.0); // \n    #endif\n\n}",waterCalculateFluxFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainHeightTex;\nuniform sampler2D contaminantHeightTex;\nuniform sampler2D currWaterFluxTex_HIGH;\nuniform sampler2D currWaterFluxTex_LOW;\n\nvarying vec2 v_tex_pos;\n\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform float u_waterMaxHeigh;\nuniform float u_waterMaxFlux;\nuniform vec2 u_heightMap_MinMax;\nuniform float u_contaminantMaxHeigh; // if "u_contaminantMaxHeigh" < 0.0 -> no exist contaminant.\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\nuniform int u_terrainHeightEncodingBytes;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_waterMaxHeigh;\n\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_contaminantMaxHeigh;\n\n    return waterHeight;\n}\n\nvec4 getWaterFlux(in vec2 texCoord)\n{\n    vec4 color4_HIGH = texture2D(currWaterFluxTex_HIGH, texCoord);\n    vec4 color4_LOW = texture2D(currWaterFluxTex_LOW, texCoord);\n\n    float flux_top = decodeRG(vec2(color4_HIGH.r, color4_LOW.r));\n    float flux_right = decodeRG(vec2(color4_HIGH.g, color4_LOW.g));\n    float flux_bottom = decodeRG(vec2(color4_HIGH.b, color4_LOW.b));\n    float flux_left = decodeRG(vec2(color4_HIGH.a, color4_LOW.a));\n\n    vec4 flux = vec4(flux_top, flux_right, flux_bottom, flux_left) * u_waterMaxFlux;\n    return flux; \n}\n\nvoid encodeWaterFlux(vec4 flux, inout vec4 flux_high, inout vec4 flux_low)\n{\n    vec2 encoded_top_flux = encodeRG(flux.r);\n    vec2 encoded_right_flux = encodeRG(flux.g);\n    vec2 encoded_bottom_flux = encodeRG(flux.b);\n    vec2 encoded_left_flux = encodeRG(flux.a);\n\n    flux_high = vec4(encoded_top_flux.r, encoded_right_flux.r, encoded_bottom_flux.r, encoded_left_flux.r);\n    flux_low = vec4(encoded_top_flux.g, encoded_right_flux.g, encoded_bottom_flux.g, encoded_left_flux.g);\n}\n\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    if(u_terrainHeightEncodingBytes == 1)\n    {\n        float terainHeight = texture2D(terrainHeightTex, texCoord).r;\n        terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n        return terainHeight;\n    }\n    else if(u_terrainHeightEncodingBytes == 2)\n    {\n        // 4byte mode.***\n        vec4 terrainEncoded = texture2D(terrainHeightTex, texCoord);\n        float terainHeight = decodeRG(terrainEncoded.rg);\n        terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n        return terainHeight;\n    }\n    else if(u_terrainHeightEncodingBytes == 4)\n    {\n        // 4byte mode.***\n        vec4 terrainEncoded = texture2D(terrainHeightTex, texCoord);\n        float terainHeight = unpackDepth(terrainEncoded);\n        terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n        return terainHeight;\n    }\n}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n\n    // Terrain & water heights.**************************************************************************************************\n    // read terrain heights.\n    float topTH = getTerrainHeight(curuv + vec2(0.0, divY));\n    float rightTH = getTerrainHeight(curuv + vec2(divX, 0.0));\n    float bottomTH = getTerrainHeight(curuv + vec2(0.0, -divY));\n    float leftTH = getTerrainHeight(curuv + vec2(-divX, 0.0));\n    float curTH = getTerrainHeight(curuv);\n\n    // read water heights.\n    float topWH = getWaterHeight(curuv + vec2(0.0, divY));\n    float rightWH = getWaterHeight(curuv + vec2(divX, 0.0));\n    float bottomWH = getWaterHeight(curuv + vec2(0.0, -divY));\n    float leftWH = getWaterHeight(curuv + vec2(-divX, 0.0));\n    float curWH = getWaterHeight(curuv);\n\n    float topCH = 0.0;\n    float rightCH = 0.0;\n    float bottomCH = 0.0;\n    float leftCH = 0.0;\n    float curCH = 0.0;\n\n    // Check if exist contaminant.\n    if(u_contaminantMaxHeigh > 0.0)\n    {\n        // exist contaminant.\n        topCH = getContaminantHeight(curuv + vec2(0.0, divY));\n        rightCH = getContaminantHeight(curuv + vec2(divX, 0.0));\n        bottomCH = getContaminantHeight(curuv + vec2(0.0, -divY));\n        leftCH = getContaminantHeight(curuv + vec2(-divX, 0.0));\n        curCH = getContaminantHeight(curuv);\n    }\n\n    // End terrain & water heights.-----------------------------------------------------------------------------------------------\n\n    // Calculate deltaPresure: deltaP_ij(x,y) = ro*g* deltaH_ij(x,y).*************************************************************\n    // calculate deltaH.***\n    // Provisionally considere contaminant density equal to water density.\n    float curTotalH = curTH + curWH + curCH;\n    float HTopOut = curTotalH - (topTH + topWH + topCH);\n    float HRightOut = curTotalH - (rightTH + rightWH + rightCH);\n    float HBottomOut = curTotalH - (bottomTH + bottomWH + bottomCH);\n    float HLeftOut = curTotalH - (leftTH + leftWH + leftCH);\n    float gravity = 9.8;\n    float waterDensity = 997.0; // 997kg/m3.\n    vec4 deltaP = vec4(waterDensity * gravity * HTopOut, \n                        waterDensity * gravity * HRightOut, \n                        waterDensity * gravity * HBottomOut, \n                        waterDensity * gravity * HLeftOut ); // deltaP = kg/(m*s2) = Pa.\n\n    // calculate water acceleration.*********************************************************************************************\n    vec4 waterAccel = vec4(deltaP.x/(waterDensity * cellSize_x),\n                            deltaP.y/(waterDensity * cellSize_y),\n                            deltaP.z/(waterDensity * cellSize_x),\n                            deltaP.w/(waterDensity * cellSize_y));\n\n    // read flux.\n    vec4 curFlux = getWaterFlux(curuv);\n\n    // calculate the new flux.\n    float pipeArea = cellSize_x * cellSize_y;\n    vec4 newFlux = u_timestep * pipeArea * waterAccel;\n\n    // total outFlux.\n    float cushionFactor = 0.9999; // esmorteiment.\n    float ftopout = max(0.0, curFlux.x + newFlux.x) * cushionFactor;\n    float frightout = max(0.0, curFlux.y + newFlux.y) * cushionFactor;\n    float fbottomout = max(0.0, curFlux.z + newFlux.z) * cushionFactor;\n    float fleftout = max(0.0, curFlux.w + newFlux.w) * cushionFactor;\n\n    vec4 shaderLogFluxColor4 = vec4(0.0); // test var. delete after use.\n\n    // calculate vOut & currVolum.\n    float vOut = u_timestep * (ftopout + frightout + fbottomout + fleftout); \n\n    float currWaterVol = (curWH + curCH) * pipeArea;\n\n    if(vOut > currWaterVol)\n    {\n        //rescale outflow readFlux so that outflow don\'t exceed current water volume\n        float factor = (currWaterVol / vOut);\n        ftopout *= factor;\n        frightout *= factor;\n        fbottomout *= factor;\n        fleftout *= factor;\n    }\n\n    \n    /*\n    //boundary conditions\n    if(curuv.x <= div) fleftout = 0.0;\n    if(curuv.x >= 1.0 - 2.0 * div) frightout = 0.0;\n    if(curuv.y <= div) ftopout = 0.0;\n    if(curuv.y >= 1.0 - 2.0 * div) fbottomout = 0.0;\n\n    if(curuv.x <= div || (curuv.x >= 1.0 - 2.0 * div) || (curuv.y <= div) || (curuv.y >= 1.0 - 2.0 * div) ){\n        ftopout = 0.0;\n        frightout = 0.0;\n        fbottomout = 0.0;\n        fleftout = 0.0;\n    }\n    */\n\n    vec4 outFlux = vec4(ftopout, frightout, fbottomout, fleftout) / u_waterMaxFlux;\n    vec4 flux_high;\n    vec4 flux_low;\n    encodeWaterFlux(outFlux, flux_high, flux_low);\n\n    gl_FragData[0] = flux_high;  // water flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = flux_low; // water flux low.\n        gl_FragData[2] = shaderLogFluxColor4; // shader log. delete after use.\n        gl_FragData[3] = shaderLogFluxColor4; // albedo\n        gl_FragData[4] = shaderLogFluxColor4; // selection color\n    #endif\n\n}',waterCalculateHeightContaminationFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D waterSourceTex;\nuniform sampler2D rainTex; // if exist.\nuniform sampler2D currWaterHeightTex;\nuniform sampler2D currContaminationHeightTex;\nuniform sampler2D contaminantSourceTex;\n\nuniform bool u_existRain;\nuniform float u_waterMaxHeigh;\nuniform float u_contaminantMaxHeigh;\nuniform float u_fluidMaxHeigh;\nuniform float u_fluidHeigh;\nuniform float u_timestep;\n\nvarying vec2 v_tex_pos;\nvarying vec4 vColor4;\n\nvec4 packDepth( float v ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n/*\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(currWaterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n*/\n\nvoid main()\n{\n    float unitaryHeight = u_fluidHeigh / u_fluidMaxHeigh;\n    vec4 encodedHeight = packDepth(unitaryHeight);\n    gl_FragData[0] = encodedHeight;\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0, 0.0, 0.5, 1.0); // water source\n        gl_FragData[2] = vec4(1.0, 0.0, 0.5, 1.0); // normal\n        gl_FragData[3] = vec4(1.0, 0.0, 0.5, 1.0); // albedo\n        gl_FragData[4] = vec4(1.0, 0.0, 0.5, 1.0); // selection color\n    #endif\n}",waterCalculateHeightFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\n\nuniform sampler2D waterSourceTex;\nuniform sampler2D rainTex; // if exist.\nuniform sampler2D currWaterHeightTex;\nuniform sampler2D currContaminationHeightTex;\nuniform sampler2D contaminantSourceTex;\nuniform sampler2D waterAditionTex;\n\nuniform bool u_existRain;\nuniform int u_rainType; // 0= rain value (mm/h), 1= rain texture.\nuniform float u_rainValue_mmHour;\nuniform float u_waterMaxHeigh;\nuniform float u_contaminantMaxHeigh;\nuniform float u_increTimeSeconds;\n\nvarying vec2 v_tex_pos;\n\nvec4 packDepth( float v ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n/*\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(currWaterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n*/\n\nvoid main()\n{\n    // 1rst, take the water source.\n    vec4 currWaterHeight = texture2D(currWaterHeightTex, v_tex_pos);\n    vec4 waterSource = texture2D(waterSourceTex, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n    //vec4 waterSource = vec4(0.0, 0.0, 0.0, 0.01);\n\n    float decodedCurrWaterHeight = unpackDepth(currWaterHeight) * u_waterMaxHeigh;\n    float decodedSourceWaterHeight = unpackDepth(waterSource) * u_waterMaxHeigh;\n\n    float finalWaterHeight = decodedSourceWaterHeight; // init value.***\n    //finalWaterHeight = 0.0;\n\n    vec4 shaderLogColor4 = vec4(0.0, 0.0, 0.0, 1.0);\n\n    if(finalWaterHeight < 0.0)\n    {\n        shaderLogColor4 = vec4(1.0, 0.0, 1.0, 1.0);\n    }\n\n    if(finalWaterHeight < decodedCurrWaterHeight)\n    {\n        finalWaterHeight = decodedCurrWaterHeight;\n        shaderLogColor4 = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n\n\n    // add rain.\n    if(u_existRain)\n    {\n        // rain : mm/h.***\n        vec4 rain = texture2D(rainTex, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n        float rainHeight = unpackDepth(rain) * u_waterMaxHeigh;\n        finalWaterHeight += rainHeight;\n    }\n\n    if(u_rainType == 0)\n    {\n        float rain_mm = (u_rainValue_mmHour/ 3600.0) * u_increTimeSeconds;\n        finalWaterHeight += rain_mm / 1000.0;\n    }\n\n    vec4 waterAdition = texture2D(waterAditionTex, vec2(v_tex_pos.x, v_tex_pos.y));\n    float waterAditionHeight = unpackDepth(waterAdition) * u_waterMaxHeigh;\n    finalWaterHeight += waterAditionHeight;\n\n    if(finalWaterHeight > u_waterMaxHeigh)\n    {\n        shaderLogColor4 = vec4(0.0, 1.0, 0.5, 1.0);\n    }\n    \n\n    vec4 finalWaterHeight4 = packDepth(finalWaterHeight / u_waterMaxHeigh);\n\n    // Contamination Height.********************************************************************************\n    vec4 contaminSourceHeight = vec4(0.0);\n    if(u_contaminantMaxHeigh > 0.0)\n    {\n        // check if exist contaminant.\n        contaminSourceHeight = texture2D(contaminantSourceTex, v_tex_pos);\n        vec4 currContaminHeight = texture2D(currContaminationHeightTex, v_tex_pos);\n\n        float decodedSourceContaminHeight = unpackDepth(contaminSourceHeight);\n        float decodedCurrContaminHeight = unpackDepth(currContaminHeight);\n        if(decodedSourceContaminHeight < decodedCurrContaminHeight)\n        {\n            contaminSourceHeight = currContaminHeight;\n        }\n    }\n\n    \n    gl_FragData[0] = finalWaterHeight4;  // waterHeight.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = contaminSourceHeight; // contamination\n        gl_FragData[2] = shaderLogColor4; // normal\n        gl_FragData[3] = vec4(1.0, 0.0, 0.5, 1.0); // albedo\n        gl_FragData[4] = vec4(1.0, 0.0, 0.5, 1.0); // selection color\n    #endif\n}",waterCalculateSedimentFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainHeightTex;\nuniform sampler2D currWaterFluxTex;\nuniform sampler2D sedimentHeightTex;\n\nvarying vec2 v_tex_pos; // texCoords.\n#define PI 3.1415926\n\nuniform float u_SimRes;\nuniform float u_PipeLen;\nuniform float u_Ks;\nuniform float u_Kc;\nuniform float u_Kd;\nuniform float u_timestep;\n\nuniform float u_PipeArea;\nuniform vec2 u_heightMap_MinMax;\nuniform float u_waterMaxHeigh;\n\n/*\nvec3 calnor(vec2 uv){\n  float eps = 1.f/u_SimRes;\n  vec4 cur = texture(readTerrain,uv);\n  vec4 r = texture(readTerrain,uv+vec2(eps,0.f));\n  vec4 t = texture(readTerrain,uv+vec2(0.f,eps));\n  vec4 b = texture(readTerrain,uv+vec2(0.f,-eps));\n  vec4 l = texture(readTerrain,uv+vec2(-eps,0.f));\n\n  vec3 nor = vec3(l.x - r.x, 2.0, t.x - b.x);\n  nor = normalize(nor);\n  return nor;\n}\n*/\n\nvoid main()\n{\n    vec2 curuv = vec2(v_tex_pos.x, v_tex_pos.y);\n    curuv = v_tex_pos;\n\n\n\n    gl_FragData[0] = vec4(0.0);  // water flux.\n\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(0.0); // velocity\n        gl_FragData[2] = vec4(0.0); // \n        gl_FragData[3] = vec4(0.0); // \n        gl_FragData[4] = vec4(0.0); // \n    #endif\n\n}",waterCalculateTerrainFluxFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D terrainHeightTex;\nuniform sampler2D terrainMaxSlippageTex;\n\nvarying vec2 v_tex_pos;\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform float u_terrainMaxFlux;\nuniform vec2 u_heightMap_MinMax; // terrain min-max heights.\nuniform float u_contaminantMaxHeigh; // if "u_contaminantMaxHeigh" < 0.0 -> no exist contaminant.\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainHeightTex, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nfloat getMaxSlippage(in vec2 texCoord)\n{\n    // Note : for maxSlippage use "u_heightMap_MinMax.y" as quantizer.\n    vec4 encoded = texture2D(terrainMaxSlippageTex, texCoord);\n    float decoded = unpackDepth(encoded);\n    decoded = decoded * u_heightMap_MinMax.y;\n    return decoded;\n}\n\nvoid encodeFlux(vec4 flux, inout vec4 flux_high, inout vec4 flux_low)\n{\n    vec2 encoded_top_flux = encodeRG(flux.r);\n    vec2 encoded_right_flux = encodeRG(flux.g);\n    vec2 encoded_bottom_flux = encodeRG(flux.b);\n    vec2 encoded_left_flux = encodeRG(flux.a);\n\n    flux_high = vec4(encoded_top_flux.r, encoded_right_flux.r, encoded_bottom_flux.r, encoded_left_flux.r);\n    flux_low = vec4(encoded_top_flux.g, encoded_right_flux.g, encoded_bottom_flux.g, encoded_left_flux.g);\n}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n    vec4 shaderLogFluxColor4 = vec4(0.0); // test var. delete after use.\n\n    // Terrain heights.**************************************************************************************************\n    float topTH = getTerrainHeight(curuv + vec2(0.0, divY));\n    float rightTH = getTerrainHeight(curuv + vec2(divX, 0.0));\n    float bottomTH = getTerrainHeight(curuv + vec2(0.0, -divY));\n    float leftTH = getTerrainHeight(curuv + vec2(-divX, 0.0));\n    float curTH = getTerrainHeight(curuv);\n    // End terrain heights.-----------------------------------------------------------------------------------------------\n\n    // MaxSlippges.******************************************************************************************************\n    float topSlip = getMaxSlippage(curuv + vec2(0.0, divY));\n    float rightSlip = getMaxSlippage(curuv + vec2(divX, 0.0));\n    float bottomSlip = getMaxSlippage(curuv + vec2(0.0, -divY));\n    float leftSlip = getMaxSlippage(curuv + vec2(-divX, 0.0));\n    float curSlip = getMaxSlippage(curuv);\n    // End max slippages.-------------------------------------------------------------------------------------------------\n\n\n    vec4 diff;\n    diff.x = curTH - topTH - (curSlip + topSlip) * 0.5;\n    diff.y = curTH - rightTH - (curSlip + rightSlip) * 0.5;\n    diff.z = curTH - bottomTH - (curSlip + bottomSlip) * 0.5;\n    diff.w = curTH - leftTH - (curSlip + leftSlip) * 0.5;\n\n    diff = max(vec4(0.0), diff);\n\n    //vec4 newFlow = diff * 0.2;\n    vec4 newFlow = diff;\n\n    float outfactor = (newFlow.x + newFlow.y + newFlow.z + newFlow.w)*u_timestep;\n\n    if(outfactor > 1e-5){\n        outfactor = curTH / outfactor;\n        if(outfactor > 1.0) outfactor = 1.0;\n        newFlow = newFlow * outfactor;\n    \n        shaderLogFluxColor4 = vec4(1.0, 0.5, 0.25, 1.0);\n    }\n\n    /*\n    if(outfactor > curTH){\n        float factor = (curTH / outfactor);\n        newFlow *= factor;\n        shaderLogFluxColor4 = vec4(1.0, 0.5, 0.25, 1.0);\n    }\n    */\n    \n\n    /*\n    if(vOut > currWaterVol)\n    {\n        //rescale outflow readFlux so that outflow don\'t exceed current water volume\n        float factor = (currWaterVol / vOut);\n        ftopout *= factor;\n        frightout *= factor;\n        fbottomout *= factor;\n        fleftout *= factor;\n    }\n\n    \n    /*\n    //boundary conditions\n    if(curuv.x <= div) fleftout = 0.0;\n    if(curuv.x >= 1.0 - 2.0 * div) frightout = 0.0;\n    if(curuv.y <= div) ftopout = 0.0;\n    if(curuv.y >= 1.0 - 2.0 * div) fbottomout = 0.0;\n\n    if(curuv.x <= div || (curuv.x >= 1.0 - 2.0 * div) || (curuv.y <= div) || (curuv.y >= 1.0 - 2.0 * div) ){\n        ftopout = 0.0;\n        frightout = 0.0;\n        fbottomout = 0.0;\n        fleftout = 0.0;\n    }\n    */\n\n    vec4 outFlux = newFlow / u_terrainMaxFlux;\n    vec4 flux_high;\n    vec4 flux_low;\n    encodeFlux(outFlux, flux_high, flux_low);\n\n    shaderLogFluxColor4 = outFlux;\n\n    gl_FragData[0] = flux_high;  // water flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = flux_low; // water flux low.\n        gl_FragData[2] = shaderLogFluxColor4; // shader log. delete after use.\n        gl_FragData[3] = shaderLogFluxColor4; // albedo\n        gl_FragData[4] = shaderLogFluxColor4; // selection color\n    #endif\n\n}',waterCalculateTerrainHeightByFluxFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D terrainHeightTex;\nuniform sampler2D terrainFluxTex_HIGH;\nuniform sampler2D terrainFluxTex_LOW;\n\nvarying vec2 v_tex_pos;\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_heightMap_MinMax; // terrain min-max heights.\nuniform float u_terrainMaxFlux;\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainHeightTex, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nvec4 getTerrainFlux(in vec2 texCoord)\n{\n    vec4 color4_HIGH = texture2D(terrainFluxTex_HIGH, texCoord);\n    vec4 color4_LOW = texture2D(terrainFluxTex_LOW, texCoord);\n\n    float flux_top = decodeRG(vec2(color4_HIGH.r, color4_LOW.r));\n    float flux_right = decodeRG(vec2(color4_HIGH.g, color4_LOW.g));\n    float flux_bottom = decodeRG(vec2(color4_HIGH.b, color4_LOW.b));\n    float flux_left = decodeRG(vec2(color4_HIGH.a, color4_LOW.a));\n\n    vec4 flux = vec4(flux_top, flux_right, flux_bottom, flux_left) * u_terrainMaxFlux;\n    return flux; \n}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n    vec4 shaderLogFluxColor4 = vec4(0.0); // test var. delete after use.\n\n    // Terrain height.\n    float curTH = getTerrainHeight(curuv);\n\n    // Terrain fluxes.\n    vec4 topFlux = getTerrainFlux(curuv + vec2(0.0, divY));\n    vec4 rightFlux = getTerrainFlux(curuv + vec2(divX, 0.0));\n    vec4 bottomFlux = getTerrainFlux(curuv + vec2(0.0, -divY));\n    vec4 leftFlux = getTerrainFlux(curuv + vec2(-divX, 0.0));\n\n    vec4 outFlux = getTerrainFlux(curuv);\n    vec4 inputFlux = vec4(topFlux.z, rightFlux.w, bottomFlux.x, leftFlux.y);\n\n    float vol = inputFlux.x + inputFlux.y + inputFlux.z + inputFlux.w - outFlux.x - outFlux.y - outFlux.z - outFlux.w;\n\n    float thermalErosionScale = 2.6;\n    thermalErosionScale = 1.0;\n    //float tdelta = min(10.0, u_timestep * thermalErosionScale) * vol; // original.\n    float tdelta = (u_timestep * thermalErosionScale) * vol;\n    float newTerrainHeight = curTH + tdelta;\n    newTerrainHeight = (newTerrainHeight - u_heightMap_MinMax.x) / (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    vec4 newTH4 = vec4(newTerrainHeight, newTerrainHeight, newTerrainHeight, 1.0);\n\n    shaderLogFluxColor4 = outFlux;\n\n    gl_FragData[0] = newTH4;  // water flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = shaderLogFluxColor4; // water flux low.\n        gl_FragData[2] = shaderLogFluxColor4; // shader log. delete after use.\n        gl_FragData[3] = shaderLogFluxColor4; // albedo\n        gl_FragData[4] = shaderLogFluxColor4; // selection color\n    #endif\n\n}",waterCalculateTerrainMaxSlippageFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D terrainHeightTex;\n\nvarying vec2 v_tex_pos;\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_heightMap_MinMax; // terrain min-max heights.\n\nuniform vec2 u_simulationTextureSize;\nuniform vec2 u_terrainTextureSize;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainHeightTex, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nvoid main()\n{\n    vec2 curuv = v_tex_pos;\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    //float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    //float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n    vec4 shaderLogFluxColor4 = vec4(0.0); // test var. delete after use.\n\n    // Terrain heights.**************************************************************************************************\n    float topTH = getTerrainHeight(curuv + vec2(0.0, divY));\n    float rightTH = getTerrainHeight(curuv + vec2(divX, 0.0));\n    float bottomTH = getTerrainHeight(curuv + vec2(0.0, -divY));\n    float leftTH = getTerrainHeight(curuv + vec2(-divX, 0.0));\n    float curTH = getTerrainHeight(curuv);\n    // End terrain heights.-----------------------------------------------------------------------------------------------\n\n    // Calculate maxSlippge.***\n    float _maxHeightDiff = 3.0;\n    //float maxLocalDiff = _maxHeightDiff * 0.01; // original.**\n    float maxLocalDiff = _maxHeightDiff * 0.01;\n    float avgDiff = (topTH + rightTH + bottomTH + leftTH) * 0.25 - curTH;\n    //avgDiff = 10.0 * max(abs(avgDiff) - maxLocalDiff, 0.0); // original.\n    avgDiff = 1.0 * max(abs(avgDiff) - maxLocalDiff, 0.0);\n\n    float maxSlippage = max(_maxHeightDiff - avgDiff, 0.0);\n\n    // now, encode the maxSlippage value.\n    // Note : for maxSlippage use "u_heightMap_MinMax.y" as quantizer.\n    maxSlippage = maxSlippage / u_heightMap_MinMax.y;\n    //maxSlippage *= 100.0; // test.\n    //maxSlippage *= 10.0; // test.\n    shaderLogFluxColor4 = vec4(maxSlippage, 0.0, 0.0, 1.0);\n\n\n    vec4 maxslippage4 = packDepth(maxSlippage);\n    //vec4 maxslippage4 = vec4(maxSlippage, 0.0, 0.0, 1.0); // test.***\n\n    gl_FragData[0] = maxslippage4;  // water flux high.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = shaderLogFluxColor4; // water flux low.\n        gl_FragData[2] = shaderLogFluxColor4; // shader log. delete after use.\n        gl_FragData[3] = shaderLogFluxColor4; // albedo\n        gl_FragData[4] = shaderLogFluxColor4; // selection color\n    #endif\n\n}',waterCalculateVelocityFS:"#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainHeightTex;\nuniform sampler2D currWaterFluxTex_HIGH;\nuniform sampler2D currWaterFluxTex_LOW;\nuniform sampler2D contaminantHeightTex;\n\nvarying vec2 v_tex_pos; // texCoords.\n#define PI 3.1415926\n\nuniform float u_timestep;\n\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_heightMap_MinMax; // terrain min max heights. no used.\nuniform float u_waterMaxHeigh;\nuniform float u_waterMaxFlux;\nuniform float u_waterMaxVelocity;\nuniform float u_contaminantMaxHeigh;\n\nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec2 u_terrainTextureSize;\n\nvec2 encodeVelocity(in vec2 vel)\n{\n\treturn vel*0.5 + 0.5;\n}\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_contaminantMaxHeigh;\n\n    return waterHeight;\n}\n\nvec4 getWaterFlux(in vec2 texCoord)\n{\n    vec4 color4_HIGH = texture2D(currWaterFluxTex_HIGH, texCoord);\n    vec4 color4_LOW = texture2D(currWaterFluxTex_LOW, texCoord);\n\n    float flux_top = decodeRG(vec2(color4_HIGH.r, color4_LOW.r));\n    float flux_right = decodeRG(vec2(color4_HIGH.g, color4_LOW.g));\n    float flux_bottom = decodeRG(vec2(color4_HIGH.b, color4_LOW.b));\n    float flux_left = decodeRG(vec2(color4_HIGH.a, color4_LOW.a));\n\n    vec4 flux = vec4(flux_top, flux_right, flux_bottom, flux_left) * u_waterMaxFlux;\n    return flux; \n}\n\nvoid encodeWaterFlux(vec4 flux, inout vec4 flux_high, inout vec4 flux_low)\n{\n    vec2 encoded_top_flux = encodeRG(flux.r);\n    vec2 encoded_right_flux = encodeRG(flux.g);\n    vec2 encoded_bottom_flux = encodeRG(flux.b);\n    vec2 encoded_left_flux = encodeRG(flux.a);\n\n    flux_high = vec4(encoded_top_flux.r, encoded_right_flux.r, encoded_bottom_flux.r, encoded_left_flux.r);\n    flux_low = vec4(encoded_top_flux.g, encoded_right_flux.g, encoded_bottom_flux.g, encoded_left_flux.g);\n}\n\nvoid main()\n{\n    vec2 curuv = vec2(v_tex_pos.x, v_tex_pos.y);\n    curuv = v_tex_pos;\n\n    float divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n    float cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n\n    float cellArea = cellSize_x * cellSize_y;\n    float timeStep_divCellArea = u_timestep / cellArea;;\n\n    vec4 topflux = getWaterFlux(curuv + vec2(0.0, divY));\n    vec4 rightflux = getWaterFlux(curuv + vec2(divX, 0.0));\n    vec4 bottomflux = getWaterFlux(curuv + vec2(0.0, -divY));\n    vec4 leftflux = getWaterFlux(curuv + vec2(-divX, 0.0));\n    vec4 curflux = getWaterFlux(curuv);\n\n    //out flow flux\n    float ftopout = curflux.x;\n    float frightout = curflux.y;\n    float fbottomout = curflux.z;\n    float fleftout = curflux.w;\n\n    vec4 outputflux = curflux;\n    vec4 inputflux = vec4(topflux.z, rightflux.w, bottomflux.x, leftflux.y);\n\n    // Now, calculate the contamination trasference.**************************************************\n    // read water heights.\n\n    float topWH = getWaterHeight(curuv + vec2(0.0, divY));\n    float rightWH = getWaterHeight(curuv + vec2(divX, 0.0));\n    float bottomWH = getWaterHeight(curuv + vec2(0.0, -divY));\n    float leftWH = getWaterHeight(curuv + vec2(-divX, 0.0));\n    float curWH = getWaterHeight(curuv);\n\n    float topCH = 0.0;\n    float rightCH = 0.0;\n    float bottomCH = 0.0;\n    float leftCH = 0.0;\n    float curCH = 0.0;\n\n    // Check if exist contaminant.\n    if(u_contaminantMaxHeigh > 0.0)\n    {\n        // exist contaminant.\n        topCH = getContaminantHeight(curuv + vec2(0.0, divY));\n        rightCH = getContaminantHeight(curuv + vec2(divX, 0.0));\n        bottomCH = getContaminantHeight(curuv + vec2(0.0, -divY));\n        leftCH = getContaminantHeight(curuv + vec2(-divX, 0.0));\n        curCH = getContaminantHeight(curuv);\n    }\n\n    // calculate contaminat ratio.\n    float topContaminPerUnit = topCH / (topCH + topWH);\n    float rightContaminPerUnit = rightCH / (rightCH + rightWH);\n    float bottomContaminPerUnit = bottomCH / (bottomCH + bottomWH);\n    float leftContaminPerUnit = leftCH / (leftCH + leftWH);\n\n    // calculate input waterHeight & contaminHeight.\n    float inputTopTotalH = inputflux.x * timeStep_divCellArea;\n    float inputRightTotalH = inputflux.y * timeStep_divCellArea;\n    float inputBottomTotalH = inputflux.z * timeStep_divCellArea;\n    float inputLeftTotalH = inputflux.w * timeStep_divCellArea;\n\n    float inputTopCH = inputTopTotalH * topContaminPerUnit;\n    float inputRightCH = inputRightTotalH * rightContaminPerUnit;\n    float inputBottomCH = inputBottomTotalH * bottomContaminPerUnit;\n    float inputLeftCH = inputLeftTotalH * leftContaminPerUnit;\n\n    float inputTopWH = inputTopTotalH - inputTopCH;\n    float inputRightWH = inputRightTotalH - inputRightCH;\n    float inputBottomWH = inputBottomTotalH - inputBottomCH;\n    float inputLeftWH = inputLeftTotalH - inputLeftCH;\n\n    // Now, calculate outputs.\n    float currContaminPerUnit = curCH / (curCH + curWH);\n    float outputTotalH = (ftopout + frightout + fbottomout + fleftout) * timeStep_divCellArea;\n    float outputCH = outputTotalH * currContaminPerUnit;\n    float outputWH = outputTotalH - outputCH;\n\n    // Now, calculate delt-water-H & delta-contaminant-H.\n    float deltaWH = inputTopWH + inputRightWH + inputBottomWH + inputLeftWH - outputWH;\n    float deltaCH = inputTopCH + inputRightCH + inputBottomCH + inputLeftCH - outputCH;\n    float deltaH = deltaWH + deltaCH;\n    //------------------------------------------------------------------------------------------------\n\n    //vec4 curT = texture2D(terrainHeightTex, vec2(v_tex_pos.x, v_tex_pos.y));\n    //curT = u_heightMap_MinMax.x + curT * u_heightMap_MinMax.y;\n\n    float fout = ftopout + frightout + fbottomout + fleftout;\n    float fin = inputflux.x + inputflux.y + inputflux.z + inputflux.w;\n\n    //float deltaH = u_timestep * (fin - fout) / cellArea; \n    //---------------------------------------------------------------------------------\n\n    \n\n    //float d1 = cur.y + curs.x; // original. (waterH + sedimentH).\n    float d1 = curWH + curCH;\n    float d2 = d1 + deltaH;\n    float da = (d1 + d2)/2.0;\n\n    vec2 veloci = vec2(inputflux.w - outputflux.w + outputflux.y - inputflux.y, inputflux.z - outputflux.z + outputflux.x - inputflux.x) / 2.0;\n\n    vec4 shaderLogColor4 = vec4(0.0);\n\n    //if(da <= 1e-8) // original.***\n    if(da <= 1e-8) //\n    {\n        veloci = vec2(0.0);\n    }\n    else\n    {\n        ////veloci = veloci/(da * u_PipeLen);\n        veloci = veloci/(da * vec2(cellSize_y, cellSize_x)); // original.***\n    }\n\n    if(curuv.x <= divX) \n    { \n        deltaWH = 0.0; \n        deltaCH = 0.0; \n        veloci = vec2(0.0); \n    }\n    if(curuv.x >= 1.0 - 2.0 * divX) \n    { \n        deltaWH = 0.0; \n        deltaCH = 0.0; \n        veloci = vec2(0.0); \n    }\n    if(curuv.y <= divY) \n    { \n        deltaWH = 0.0; \n        deltaCH = 0.0; \n        veloci = vec2(0.0); \n    }\n    if(curuv.y >= 1.0 - 2.0 * divY) \n    { \n        deltaWH = 0.0; \n        deltaCH = 0.0; \n        veloci = vec2(0.0); \n    }\n\n    //  float absx = abs(veloci.x);\n    //  float absy = abs(veloci.y);\n    //  float maxxy = max(absx, absy);\n    //  float minxy = min(absx, absy);\n    //  float tantheta = minxy / maxxy;\n    //  float scale = cos(45.0 * PI / 180.0 - atan(tantheta));\n    //  float divtheta = (1.0/sqrt(2.0)) / scale;\n    //  float divs = min(abs(veloci.x), abs(veloci.y))/max(abs(veloci.x), abs(veloci.y));\n    //  if((divs) > 20.0){\n    //    veloci /= 20.0;\n    //  }\n\n    \n    // test debug::::::::::::::\n    //veloci = vec2(0.0); // delete this.***\n\n    vec2 encodedVelocity = encodeVelocity(veloci/u_waterMaxVelocity);\n    vec4 writeVel = vec4(encodedVelocity, 0.0, 1.0);\n    //vec4 writeWaterHeight = vec4(cur.x,max(cur.y+deltavol, 0.0),cur.z,cur.w); // original.***\n\n    // test debug:\n    //if(abs(veloci.x) > 40.0 || abs(veloci.y) > 40.0)\n    {\n        shaderLogColor4 = vec4(encodedVelocity, 0.0, 1.0);\n    }\n\n    float waterHeight = max(curWH + deltaWH, 0.0); // original.***\n    vec4 encodedWH = packDepth(waterHeight / u_waterMaxHeigh);\n    gl_FragData[0] = encodedWH;  // water height.\n\n    vec4 encodedCH = vec4(0.0);\n    if(u_contaminantMaxHeigh > 0.0)\n    {\n        float contaminantHeight = max(curCH + deltaCH, 0.0);\n        encodedCH = packDepth(contaminantHeight / u_contaminantMaxHeigh);\n    }\n\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = writeVel; // velocity\n        gl_FragData[2] = encodedCH; // contaminatHeight if exist.\n        gl_FragData[3] = vec4(0.0); // \n        gl_FragData[4] = vec4(0.0); // \n    #endif\n\n    \n\n}",waterCopyFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texToCopy;\nuniform bool u_textureFlipYAxis;\nvarying vec2 v_tex_pos;\n\nvoid main()\n{\n    vec4 finalCol4;\n    if(u_textureFlipYAxis)\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n    }\n    else\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, v_tex_pos.y));\n    }\n    \n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = finalCol4; // depth\n        gl_FragData[2] = finalCol4; // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = finalCol4; // selection color\n    #endif\n\n}",waterDEMTexFromQuantizedMeshFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform vec2 u_minMaxHeights;\nuniform int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform vec4 u_oneColor4;\nuniform int u_terrainHeightEncodingBytes;\n\nvarying vec3 vPos;\nvarying vec4 vColor4;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvoid main()\n{\n    vec4 finalCol4 = vec4(vPos.z, vPos.z, vPos.z, 1.0); // original.***\n    if(u_terrainHeightEncodingBytes == 1)\n    {\n        finalCol4 = vec4(vPos.z, vPos.z, vPos.z, 1.0); \n    }\n    else if(u_terrainHeightEncodingBytes == 2)\n    {\n        finalCol4 = vec4(encodeRG(vPos.z), 0.0, 1.0); // 2byte height.\n    }\n    else if(u_terrainHeightEncodingBytes == 4)\n    {\n        finalCol4 = packDepth(vPos.z); \n    }\n\n    if(colorType == 1)\n    {\n        //finalCol4 = vColor4;\n        finalCol4 = u_oneColor4;\n    }\n\n    //-------------------------------------------------------------------------------------------------------------\n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0); // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n\n}",waterDepthRenderFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform vec2 u_PlanePos; // Our location in the virtual world displayed by the plane\n\n//in vec3 fs_Pos;\n//in vec4 fs_Nor;\n//in vec4 fs_Col;\n\nuniform sampler2D hightmap;\nuniform sampler2D normap;\nuniform sampler2D sceneDepth;\nuniform sampler2D colorReflection;\nuniform sampler2D sedimap;\n\n//in float fs_Sine;\n//in vec2 fs_Uv;\n//layout (location = 0) out vec4 out_Col; // This is the final output color that you will see on your\n//layout (location = 1) out vec4 col_reflect;\n                  // screen for the pixel that is currently being processed.\nuniform vec3 u_Eye, u_Ref, u_Up;\n\n\nuniform int u_TerrainType;\nuniform float u_WaterTransparency;\nuniform float u_SimRes;\nuniform vec2 u_Dimensions;\nuniform vec3 unif_LightPos;\nuniform float u_far;\nuniform float u_near;\n\nvarying vec4 vColorAuxTest;\nvarying float vWaterHeight;\nvarying float depth;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n/*\nvec3 calnor(vec2 uv){\n    float eps = 1.0/u_SimRes;\n    vec4 cur = texture(hightmap,uv);\n    vec4 r = texture(hightmap,uv+vec2(eps,0.f));\n    vec4 t = texture(hightmap,uv+vec2(0.f,eps));\n\n    vec3 n1 = normalize(vec3(-1.0, cur.y + cur.x - r.y - r.x, 0.f));\n    vec3 n2 = normalize(vec3(-1.0, t.x + t.y - r.y - r.x, 1.0));\n\n    vec3 nor = -cross(n1,n2);\n    nor = normalize(nor);\n    return nor;\n}\n\nvec3 sky(in vec3 rd){\n    return mix(vec3(0.6,0.6,0.6),vec3(0.3,0.5,0.9),clamp(rd.y,0.f,1.f));\n}\n\nfloat linearDepth(float depthSample)\n{\n    depthSample = 2.0 * depthSample - 1.0;\n    float zLinear = 2.0 * u_near * u_far / (u_far + u_near - depthSample * (u_far - u_near));\n    return zLinear;\n}\n*/\nvoid main()\n{\n    if(vWaterHeight < 0.0001)\n    {\n        discard;\n    }\n\n    float depthAux = depth;\n\n    #ifdef USE_LOGARITHMIC_DEPTH\n\t//if(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tdepthAux = gl_FragDepthEXT; \n\t}\n\t#endif\n\n    vec4 finalCol4 = vec4(vColorAuxTest);\n    \n    // save depth, normal, albedo.\n    vec4 encodedDepth = packDepth(depthAux); \n\tgl_FragData[0] = encodedDepth; \n\n    //gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = encodedDepth; // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = vec4(1.0); // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n    /*\n    vec2 uv = vec2(gl_FragCoord.xy/u_Dimensions);\n    float terrainDepth = texture(sceneDepth,uv).x;\n    float sediment = texture(sedimap,fs_Uv).x;\n    float waterDepth = gl_FragCoord.z;\n\n    terrainDepth = linearDepth(terrainDepth);\n    waterDepth = linearDepth(waterDepth);\n\n    float dpVal = 180.0 * max(0.0,terrainDepth - waterDepth);\n    dpVal = clamp(dpVal, 0.0,4.0);\n    //dpVal = pow(dpVal, 0.1);\n\n\n    float fbias = 0.2;\n    float fscale = 0.2;\n    float fpow = 22.0;\n    vec3 sundir = unif_LightPos;\n\n    sundir = normalize(sundir);\n\n    vec3 nor = -calnor(fs_Uv);\n    vec3 viewdir = normalize(u_Eye - fs_Pos);\n    vec3 lightdir = normalize(sundir);\n    vec3 halfway = normalize(lightdir + viewdir);\n    vec3 reflectedSky = sky(halfway);\n    float spec = pow(max(dot(nor, halfway), 0.0), 333.0);\n\n\n    float R = max(0.0, min(1.0, fbias + fscale * pow(1.0 + dot(viewdir, -nor), fpow)));\n\n    //lamb =1.f;\n\n    float yval = texture(hightmap,fs_Uv).x * 4.0;\n    float wval = texture(hightmap,fs_Uv).y;\n    wval /= 1.0;\n\n\n\n    vec3 watercolor = mix(vec3(0.8,0.0,0.0), vec3(0.0,0.0,0.8), sediment * 2.0);\n    vec3 watercolorspec = vec3(1.0);\n    watercolorspec *= spec;\n\n\n\n    out_Col = vec4(vec3(0.0,0.2,0.5) + R * reflectedSky + watercolorspec  , (.5 + spec) * u_WaterTransparency * dpVal);\n    col_reflect = vec4(1.0);\n    */\n}",waterDepthRenderVS:"\n//#version 300 es\n\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; \n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n    \nuniform mat4 u_Model;\nuniform mat4 u_ModelInvTr;\nuniform mat4 u_ViewProj;\nuniform vec2 u_PlanePos; // Our location in the virtual world displayed by the plane\n\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainmap;\nuniform sampler2D contaminantHeightTex;\n\nuniform vec2 u_heightMap_MinMax;\nuniform float u_waterMaxHeigh;\nuniform float u_contaminantMaxHeigh;\n\n\nvarying vec4 vColorAuxTest;\nvarying float vWaterHeight;\nvarying float depth;\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_contaminantMaxHeigh;\n    return waterHeight;\n}\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainmap, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * u_heightMap_MinMax.y;\n    return terainHeight;\n}\n\nvoid main()\n{\n\t// read the altitude from hightmap.\n\tfloat waterHeight = getWaterHeight(vec2(texCoord.x, texCoord.y));\n\n\tfloat contaminantHeight = 0.0;\n\t// check if exist contaminat.\n\tif(u_contaminantMaxHeigh > 0.0)\n\t{\n\t\t// exist contaminant.\n\t\tcontaminantHeight = getContaminantHeight(texCoord);\n\t}\n\n\tfloat terrainHeight = getTerrainHeight(texCoord);\n\tfloat height = terrainHeight + waterHeight + contaminantHeight;\n\n\tvWaterHeight = waterHeight + contaminantHeight; // needed to discard if waterHeight is small.\n\n\tvec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t// calculate the up direction:\n\tvec4 posWC = vec4(objPosLow + objPosHigh, 1.0);\n\tvec3 upDir = normalize(posWC.xyz);\n\n\tvec4 finalPos4 =  vec4(pos4.x + upDir.x * height, pos4.y + upDir.y * height, pos4.z + upDir.z * height, 1.0);\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * finalPos4;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * finalPos4;\n\tdepth = (-orthoPos.z)/(far); // the correct value.\n\t\n}\n",WaterOrthogonalDepthShaderFS:'#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D currDEMTex;\n\nuniform vec2 u_heightMap_MinMax; // terrain min max heights. \nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec3 u_quantizedVolume_MinMax[2]; // the minimum is [0,0,0], and the maximum is [1,1,1].***\nuniform int u_terrainHeightEncodingBytes;\n\n//******************************************\n// u_processType = 0 -> overWriteDEM.\n// u_processType = 1 -> excavation.\n// u_processType = 2 -> overWrite but only partially, limited by "u_quantizedVolume_MinMax".\n//                      if a fragment is out of "u_quantizedVolume_MinMax", then discard.***\n//                      This mode is developed to use when render in sound simulation, with camera in yAxis direction.***\nuniform int u_processType;\n//------------------------------------------\n\n\nvarying float vDepth;\nvarying float vAltitude;\nvarying vec4 glPos;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(currDEMTex, texCoord).r;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nvoid main()\n{     \n    vec2 screenPos = vec2(gl_FragCoord.x / u_simulationTextureSize.x, gl_FragCoord.y / u_simulationTextureSize.y);\n\n    // read the currentDEM depth.\n    float curTerrainHeght = texture2D(currDEMTex, screenPos).r;\n    float newTerrainHeght = ((vAltitude - u_heightMap_MinMax.x)/(u_heightMap_MinMax.y - u_heightMap_MinMax.x));\n\n    //******************************************\n    // u_processType = 0 -> overWriteDEM.\n    // u_processType = 1 -> excavation.\n    //------------------------------------------\n\n    if(u_processType == 0)\n    {\n        // if u_processType = 0 -> overWriteDEM.\n        if(newTerrainHeght < curTerrainHeght)\n        {\n            discard;\n        }\n    }\n    else if(u_processType == 1)\n    {\n        // if u_processType = 1 -> excavation.\n        // in this process, the meshses must be rendered in frontFace = CW.***\n        if(newTerrainHeght > curTerrainHeght)\n        {\n            discard;\n        }\n    }\n    else if(u_processType == 2)\n    {\n        // if u_processType = 1 ->  overWrite but only partially, limited by "u_quantizedVolume_MinMax".\n        // Check if the current fragment is inside of the u_quantizedVolume_MinMax.***\n        vec3 quantizedVolumeMin = u_quantizedVolume_MinMax[0];\n        vec3 quantizedVolumeMax = u_quantizedVolume_MinMax[1];\n        vec3 quantizedPos = glPos.xyz * 0.5 + 0.5;\n\n        if(quantizedPos.x < quantizedVolumeMin.x || quantizedPos.x > quantizedVolumeMax.x)\n        {\n            discard;\n        }\n        else if(quantizedPos.y < quantizedVolumeMin.y || quantizedPos.y > quantizedVolumeMax.y)\n        {\n            discard;\n        }\n        else if(quantizedPos.z < quantizedVolumeMin.z || quantizedPos.z > quantizedVolumeMax.z)\n        {\n            discard;\n        }\n    }\n    \n    vec4 depthColor4 = vec4(newTerrainHeght, newTerrainHeght, newTerrainHeght, 1.0); // 1byte height.\n    if(u_terrainHeightEncodingBytes == 1)\n    {\n        depthColor4 = vec4(newTerrainHeght, newTerrainHeght, newTerrainHeght, 1.0); // 1byte height.\n    }\n    else if(u_terrainHeightEncodingBytes == 2)\n    {\n        depthColor4 = vec4(encodeRG(newTerrainHeght), 0.0, 1.0); // 2byte height.\n    }\n    else if(u_terrainHeightEncodingBytes == 4)\n    {\n        depthColor4 = packDepth(newTerrainHeght); // 4byte height.\n    }\n\n    gl_FragData[0] = depthColor4;\n\n    vec4 shaderLogColor4 = vec4(0.0);\n    if(vAltitude < u_heightMap_MinMax.x)\n    {\n        shaderLogColor4 = vec4(0.0, 1.0, 0.0, 1.0);\n    }\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = shaderLogColor4; // depth\n        gl_FragData[2] = shaderLogColor4; // normal\n        gl_FragData[3] = vec4(1.0); // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n}',WaterOrthogonalDepthShaderVS:'precision highp float;\n\nattribute vec3 position;\nattribute vec2 texCoord;\n\nuniform mat4 buildingRotMatrix;  \nuniform mat4 RefTransfMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform float near;\nuniform float far;\nuniform vec3 aditionalPosition;\nuniform vec3 refTranslationVec;\nuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\nuniform vec4 u_color4;\nvarying float vDepth;\nvarying float vAltitude;\nvarying vec4 vColor4;\nvarying vec4 glPos;\n\n#define M_PI 3.1415926535897932384626433832795\n\nfloat cbrt(in float val)\n{\n\tif (val < 0.0) {\n \n        return -pow(-val, 1.0 / 3.0);\n    }\n \n    else {\n \n        return pow(val, 1.0 / 3.0);\n    }\n}\n\nfloat atanHP_getConstant(in int j) \n{\n\tfloat constant = 0.0;\n\n\t// https://studylib.net/doc/18241330/high-precision-calculation-of-arcsin-x--arceos-x--and-arctan\n\t// The constants tan(j*PI/24), (j = 1, 2, • • • , 11) and PI/2 are:\n\t// j = 1 -> tan(PI/24) =     0.13165 24975 87395 85347 2\n\t// j = 2 -> tan(PI/12) =     0.26794 91924 31122 70647 3\n\t// j = 3 -> tan(PI/8) =      0.41421 35623 73095 04880 2\n\t// j = 4 -> tan(PI/6) =      0.57735 02691 89625 76450 9\n\t// j = 5 -> tan(5*PI/24) =   0.76732 69879 78960 34292 3\n\t// j = 6 -> tan(PI/4) =      1.00000 00000 00000 00000 0\n\t// j = 7 -> tan(7*PI/24) =   1.30322 53728 41205 75586 8\n\t// j = 8 -> tan(PI/3) =      1.73205 08075 68877 29352 7\n\t// j = 9 -> tan(3*PI/8) =    2.41421 35623 73095 04880 2\n\t// j = 10 -> tan(5*PI/12) =  3.73205 08075 68877 29352 7\n\t// j = 11 -> tan(11*PI/24) = 7.59575 41127 25150 44052 6\n\t// PI/2 =                    1.57079 63267 94896 61923 1\n\n\tif(j == 1)\n\t{\n\t\tconstant = 0.131652497587395853472;\n\t}\n\telse if(j == 2)\n\t{\n\t\tconstant = 0.267949192431122706473;\n\t}\n\telse if(j == 3)\n\t{\n\t\tconstant = 0.414213562373095048802;\n\t}\n\telse if(j == 4)\n\t{\n\t\tconstant = 0.577350269189625764509;\n\t}\n\telse if(j == 5)\n\t{\n\t\tconstant = 0.767326987978960342923;\n\t}\n\telse if(j == 6)\n\t{\n\t\tconstant = 1.000000000000000000000;\n\t}\n\telse if(j == 7)\n\t{\n\t\tconstant = 1.303225372841205755868;\n\t}\n\telse if(j == 8)\n\t{\n\t\tconstant = 1.732050807568877293527;\n\t}\n\telse if(j == 9)\n\t{\n\t\tconstant = 2.414213562373095048802;\n\t}\n\telse if(j == 10)\n\t{\n\t\tconstant = 3.732050807568877293527;\n\t}\n\telse if(j == 11)\n\t{\n\t\tconstant = 7.595754112725150440526;\n\t}\n\telse if(j == 12)\n\t{\n\t\tconstant = 1.570796326794896619231;\n\t}\n\n\treturn constant;\n}\n\nint atanHP_getInterval(in float x) \n{\n\t// Subdivide the interval (0, infinite ) into seven intervals as follows:\n\t// 0 <= u < tan(PI/24)\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(11PI/24) <= u < infinite.\n\t//------------------------------------------------------------------------\n\tfloat u = abs(x);\n\tint interval = -1;\n\n\t// check if is interval = 0.******************************************************************\n\t// 0 <= u < tan(PI/24)\n\tfloat tan_PIdiv24 = atanHP_getConstant(1);\n\tif(u < tan_PIdiv24)\n\t{\n\t\treturn 0;\n\t}\n\n\t// check if is interval = 1: (j = interval + 1), so j = 2.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(PI/24) <= u < tan(PI/8)\n\tfloat min = atanHP_getConstant(1);\n\tfloat max = atanHP_getConstant(3);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 1;\n\t}\n\t\n\t// check if is interval = 2: (j = interval + 1), so j = 3.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(PI/8) <= u < tan(5*PI/24)\n\tmin = atanHP_getConstant(3);\n\tmax = atanHP_getConstant(5);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 2;\n\t}\n\n\t// check if is interval = 3: (j = interval + 1), so j = 4.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(5*PI/24) <= u < tan(7*PI/24)\n\tmin = atanHP_getConstant(5);\n\tmax = atanHP_getConstant(7);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 3;\n\t}\n\n\t// check if is interval = 4: (j = interval + 1), so j = 5.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(7*PI/24) <= u < tan(3*PI/8)\n\tmin = atanHP_getConstant(7);\n\tmax = atanHP_getConstant(9);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 4;\n\t}\n\n\t// check if is interval = 5: (j = interval + 1), so j = 6.***********************************\n\t// tan[(2j - 3)*PI/24] <= u < tan[(2j - 1)*PI/24] for j = 2, 3, 4, 5, 6\n\t// tan(3*PI/8) <= u < tan(11*PI/24)\n\tmin = atanHP_getConstant(9);\n\tmax = atanHP_getConstant(11);\n\tif(u >= min && u < max)\n\t{\n\t\treturn 5;\n\t}\n\n\t// check if is interval = 6: (j = interval + 1), so j = 6.***********************************\n\t// tan(11PI/24) <= u < infinite.\n\tmin = atanHP_getConstant(11);\n\tif(u >= min)\n\t{\n\t\treturn 6;\n\t}\n\n\n\treturn interval;\n}\n\nfloat atanHP_polynomialApproximation(in float x) \n{\n\t// P(x) = a1*x + a3*pow(x, 3) + ... + a17*pow(x, 17)\n\tfloat result_atan = -1.0;\n\n\tfloat a1 = 1.0;\n\tfloat a3 = -0.333333333333333331607;\n\tfloat a5 = 0.199999999999998244448;\n\tfloat a7 = -0.142857142856331306529;\n\tfloat a9 = 0.111111110907793967393;\n\tfloat a11 = -0.0909090609633677637073;\n\tfloat a13 = 0.0769204073249154081320;\n\tfloat a15 = -0.0665248229413108277905;\n\tfloat a17 = 0.0546721009395938806941;\n\n\tresult_atan = a1*x + a3*pow(x, 3.0) + a5*pow(x, 5.0) +  a7*pow(x, 7.0) +  a9*pow(x, 9.0) +  a11*pow(x, 11.0) +  a13*pow(x, 13.0) +  a15*pow(x, 15.0) +  a17*pow(x, 17.0);\n\n\treturn result_atan;\n}\n\nfloat atanHP(in float x) // atan High Precision.\n{\n\t// https://studylib.net/doc/18241330/high-precision-calculation-of-arcsin-x--arceos-x--and-arctan\n\t//-----------------------------------------------------------------------------------------------\n\n\t// Obtain the interval.\n\tint interval = atanHP_getInterval(x);\n\n\tif(interval == 0)\n\t{\n\t\t// use polynomial approximation.\n\t\treturn atanHP_polynomialApproximation(x);\n\t}\n\telse if(interval >= 1 && interval <6)\n\t{\n\t\t// use Arctan|x| = (j*PI/12) + Arctan(tj),\n\t\t// where tj = A / B, where\n\t\t// A = |x| - tan(j*PI/12)\n\t\t// B = 1 + |x| * tan(j*PI/12).\n\t\tfloat tan_jPIdiv12;\n\t\tfloat j = float(interval);\n\t\tif(interval == 1)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(2);\n\t\t}\n\t\telse if(interval == 2)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(4);\n\t\t}\n\t\telse if(interval == 3)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(6);\n\t\t}\n\t\telse if(interval == 4)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(8);\n\t\t}\n\t\telse if(interval == 5)\n\t\t{\n\t\t\ttan_jPIdiv12 = atanHP_getConstant(10);\n\t\t}\n\n\t\tfloat A = abs(x) - tan_jPIdiv12;\n\t\tfloat B = 1.0 + abs(x) * tan_jPIdiv12;\n\t\tfloat tj = A/B;\n\t\tfloat arctan_tj = atanHP_polynomialApproximation(tj);\n\t\tfloat arctan = (j*M_PI/12.0) + arctan_tj;\n\t\treturn arctan;\n\t}\n\telse\n\t{\n\t\t// the interval = 6 (the last interval).\n\t\t// In this case,\n\t\t// Arctan|x| = PI/2 - Arctan(1/|x|).\n\t\tfloat pi_div2 = atanHP_getConstant(12);\n\t\tfloat arctan = pi_div2 - atan(1.0/abs(x));\n\t\treturn arctan;\n\t}\n\n\treturn -1.0;\n}\n\nfloat atan2(in float y, in float x) \n{\n\tif (x > 0.0)\n\t{\n\t\treturn atanHP(y/x);\n\t}\n\telse if (x < 0.0)\n\t{\n\t\tif (y >= 0.0)\n\t\t{\n\t\t\treturn atanHP(y/x) + M_PI;\n\t\t}\n\t\telse \n\t\t{\n\t\t\treturn atanHP(y/x) - M_PI;\n\t\t}\n\t}\n\telse if (x == 0.0)\n\t{\n\t\tif (y>0.0)\n\t\t{\n\t\t\treturn M_PI/2.0;\n\t\t}\n\t\telse if (y<0.0)\n\t\t{\n\t\t\treturn -M_PI/2.0;\n\t\t}\n\t\telse \n\t\t{\n\t\t\treturn 0.0; // return undefined.\n\t\t}\n\t}\n}\n\nvec3 CartesianToGeographicWgs84(vec3 posWC, inout float inoutAux)\n{\n\tvec3 geoCoord;\n\n\t// From WebWorldWind.\n\t// According to H. Vermeille, "An analytical method to transform geocentric into geodetic coordinates"\n\t// http://www.springerlink.com/content/3t6837t27t351227/fulltext.pdf\n\t// Journal of Geodesy, accepted 10/2010, not yet published\n\t\n\t\n\t//// equatorialRadius = 6378137.0; // meters.\n\t//// polarRadius = 6356752.3142; // meters.\n\t//// firstEccentricitySquared = 6.69437999014E-3;\n\t//// secondEccentricitySquared = 6.73949674228E-3;\n\t//// degToRadFactor = Math.PI/180.0;\n\t\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat equatorialRadius = 6378137.0;\n\n\tfloat X = posWC.x;\n\tfloat Y = posWC.y;\n\tfloat Z = posWC.z;\n\n\tfloat XXpYY = X * X + Y * Y;\n\tfloat sqrtXXpYY = sqrt(XXpYY);\n\tfloat a = equatorialRadius;\n\tfloat ra2 = 1.0 / (a * a);\n\tfloat e2 = firstEccentricitySquared;\n\tfloat e4 = e2 * e2;\n\tfloat p = XXpYY * ra2;\n\tfloat q = Z * Z * (1.0 - e2) * ra2;\n\tfloat r = (p + q - e4) / 6.0;\n\tfloat h;\n\tfloat phi;\n\tfloat u;\n\tfloat evoluteBorderTest = 8.0 * r * r * r + e4 * p * q;\n\tfloat rad1;\n\tfloat rad2;\n\tfloat rad3;\n\tfloat atan_son;\n\tfloat v;\n\tfloat w;\n\tfloat k;\n\tfloat D;\n\tfloat sqrtDDpZZ;\n\tfloat e;\n\tfloat lambda;\n\tfloat s2;\n\n\t\n\n\tif (evoluteBorderTest > 0.0 || q != 0.0) \n\t{\n\t\tif (evoluteBorderTest > 0.0) \n\t\t{\n\t\t\t// Step 2: general case\n\t\t\trad1 = sqrt(evoluteBorderTest);\n\t\t\trad2 = sqrt(e4 * p * q);\n\n\t\t\t// 10*e2 is my arbitrary decision of what Vermeille means by "near... the cusps of the evolute".\n\t\t\tif (evoluteBorderTest > 10.0 * e2) \n\t\t\t{\n\t\t\t\trad3 = cbrt((rad1 + rad2) * (rad1 + rad2));\n\t\t\t\tu = r + 0.5 * rad3 + 2.0 * r * r / rad3;\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tu = r + 0.5 * cbrt((rad1 + rad2) * (rad1 + rad2))\n\t\t\t\t\t+ 0.5 * cbrt((rad1 - rad2) * (rad1 - rad2));\n\t\t\t}\n\t\t}\n\t\telse \n\t\t{\n\t\t\t// Step 3: near evolute\n\t\t\trad1 = sqrt(-evoluteBorderTest);\n\t\t\trad2 = sqrt(-8.0 * r * r * r);\n\t\t\trad3 = sqrt(e4 * p * q);\n\t\t\tatan_son = 2.0 * atan2(rad3, rad1 + rad2) / 3.0;\n\n\t\t\tu = -4.0 * r * sin(atan_son) * cos(M_PI / 6.0 + atan_son);\n\t\t}\n\n\t\tv = sqrt(u * u + e4 * q);\n\t\tw = e2 * (u + v - q) / (2.0 * v);\n\t\tk = (u + v) / (sqrt(w * w + u + v) + w);\n\t\tD = k * sqrtXXpYY / (k + e2);\n\t\tfloat D_scaled = D/10000.0;\n\t\tfloat Z_scaled = Z/10000.0;\n\t\tsqrtDDpZZ = sqrt(D_scaled * D_scaled + Z_scaled * Z_scaled) * 10000.0; // more precision.\n\t\t//sqrtDDpZZ = sqrt(D * D + Z * Z);\n\n\t\th = (k + e2 - 1.0) * sqrtDDpZZ / k;\n\t\tphi = 2.0 * atan2(Z, (sqrtDDpZZ + D));\n\t\t\n\t}\n\telse \n\t{\n\t\t// Step 4: singular disk\n\t\trad1 = sqrt(1.0 - e2);\n\t\trad2 = sqrt(e2 - p);\n\t\te = sqrt(e2);\n\n\t\th = -a * rad1 * rad2 / e;\n\t\tphi = rad2 / (e * rad2 + rad1 * sqrt(p));\n\t}\n\n\n\t// Compute lambda\n\ts2 = sqrt(2.0);\n\tif ((s2 - 1.0) * Y < sqrtXXpYY + X) \n\t{\n\t\t// case 1 - -135deg < lambda < 135deg\n\t\tlambda = 2.0 * atan2(Y, sqrtXXpYY + X);\n\t}\n\telse if (sqrtXXpYY + Y < (s2 + 1.0) * X) \n\t{\n\t\t// case 2 - -225deg < lambda < 45deg\n\t\tlambda = -M_PI * 0.5 + 2.0 * atan2(X, sqrtXXpYY - Y);\n\t}\n\telse \n\t{\n\t\t// if (sqrtXXpYY-Y<(s2=1)*X) {  // is the test, if needed, but it\'s not\n\t\t// case 3: - -45deg < lambda < 225deg\n\t\tlambda = M_PI * 0.5 - 2.0 * atan2(X, sqrtXXpYY + Y);\n\t}\n\n\tfloat factor = 180.0 / M_PI;\n\tgeoCoord = vec3(factor * lambda, factor * phi, h);\n\n\treturn geoCoord;\n}\n\nfloat rand(vec2 co){\n    return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nbool aproxEqual(float valA, float valB, float error)\n{\n\tbool areEquals = false;\n\n\tif(abs(valA - valB) < error)\n\t{\n\t\tareEquals = true;\n\t}\n\telse{\n\t\tareEquals = false;\n\t}\n\n\treturn areEquals;\n}\n  \nvoid main()\n{\t\n\t// Function for overWrite waterSystem DEM texture.\n\tvec4 rotatedPos;\n\n\tif(refMatrixType == 0)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 1)\n\t{\n\t\trotatedPos = buildingRotMatrix * vec4(position.xyz + refTranslationVec.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\telse if(refMatrixType == 2)\n\t{\n\t\trotatedPos = RefTransfMatrix * vec4(position.xyz, 1.0) + vec4(aditionalPosition.xyz, 0.0);\n\t}\n\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz; // - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz; // - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0); // world position.\n\n\tfloat inoutAux = 0.0;\n\tvec3 geoCoord = CartesianToGeographicWgs84(pos4.xyz, inoutAux);\n\n\t////gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\tgl_Position = modelViewProjectionMatrix * vec4(geoCoord, 1.0);\n\tgl_PointSize = 2.0;\n\n\tvDepth = gl_Position.z * 0.5 + 0.5;\n\tglPos = gl_Position;\n\tvAltitude = geoCoord.z;\n\tvColor4 = u_color4; // used for "waterCalculateHeightContaminationFS".***\n\n}\n',WaterOrthogonalMagoTexture3DFS:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D currDEMTex;\n\nuniform vec2 u_heightMap_MinMax; // terrain min max heights. \nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec2 u_quantizedVolume_MinMax;\nuniform int u_texSize[3]; // The original texture3D size.***\nuniform int u_lowestTex3DSliceIndex;\nuniform float u_airMaxPressure; // use if rendering soundSource.***\nuniform float u_currAirPressure; // use if rendering soundSource.***\n\n\nvarying float vDepth;\nvarying float vAltitude;\n\nvec4 packDepth( float v ) {\n    vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n    enc = fract(enc);\n    enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n    return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nvoid main()\n{     \n    // Now, must determine in what slice must render.***\n    float onePixelSize = 1.0 / float(u_texSize[2]); // here can use u_texSize[0] or u_texSize[1] too.***\n    float halfPixelSize = onePixelSize / 2.0 * 1.5;\n    //halfPixelSize = onePixelSize;\n\n    // Now, must invert vDepth, bcos vDepth is up-to-down value (up is zero & down is 1).***\n    float vDepthsAbs = 1.0 - abs(vDepth);\n    //float vDepthsAbs = vDepth;\n\n    // slice 0.***\n    vec4 color = vec4(0.0);\n    float slice_altitude = float(u_lowestTex3DSliceIndex) / float(u_texSize[2]);\n    if(abs(slice_altitude - vDepthsAbs) < halfPixelSize)\n    {\n        color = packDepth(u_currAirPressure/u_airMaxPressure);\n    }\n\n    gl_FragData[0] = color;\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        color = vec4(0.0);\n        slice_altitude = float(u_lowestTex3DSliceIndex + 1) / float(u_texSize[2]);\n        if(abs(slice_altitude - vDepthsAbs) < halfPixelSize)\n        {\n            color = packDepth(u_currAirPressure/u_airMaxPressure);\n        }\n\n        gl_FragData[1] = color; \n\n         color = vec4(0.0);\n        slice_altitude = float(u_lowestTex3DSliceIndex + 2) / float(u_texSize[2]);\n        if(abs(slice_altitude - vDepthsAbs) < halfPixelSize)\n        {\n            color = packDepth(u_currAirPressure/u_airMaxPressure);\n        }\n\n        gl_FragData[2] = color; \n\n         color = vec4(0.0);\n        slice_altitude = float(u_lowestTex3DSliceIndex + 3) / float(u_texSize[2]);\n        if(abs(slice_altitude - vDepthsAbs) < halfPixelSize)\n        {\n            color = packDepth(u_currAirPressure/u_airMaxPressure);\n        }\n\n        gl_FragData[3] = color; \n\n         color = vec4(0.0);\n        slice_altitude = float(u_lowestTex3DSliceIndex + 4) / float(u_texSize[2]);\n        if(abs(slice_altitude - vDepthsAbs) < halfPixelSize)\n        {\n            color = packDepth(u_currAirPressure/u_airMaxPressure);\n        }\n\n        gl_FragData[4] = color; \n\n         color = vec4(0.0);\n        slice_altitude = float(u_lowestTex3DSliceIndex + 5) / float(u_texSize[2]);\n        if(abs(slice_altitude - vDepthsAbs) < halfPixelSize)\n        {\n            color = packDepth(u_currAirPressure/u_airMaxPressure);\n        }\n\n        gl_FragData[5] = color; \n\n         color = vec4(0.0);\n        slice_altitude = float(u_lowestTex3DSliceIndex + 6) / float(u_texSize[2]);\n        if(abs(slice_altitude - vDepthsAbs) < halfPixelSize)\n        {\n            color = packDepth(u_currAirPressure/u_airMaxPressure);\n        }\n\n        gl_FragData[6] = color; \n\n         color = vec4(0.0);\n        slice_altitude = float(u_lowestTex3DSliceIndex + 7) / float(u_texSize[2]);\n        if(abs(slice_altitude - vDepthsAbs) < halfPixelSize)\n        {\n            color = packDepth(u_currAirPressure/u_airMaxPressure);\n        }\n        gl_FragData[7] = color; \n    #endif\n}",waterParticlesRenderFS:"precision mediump float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D u_wind;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform bool u_flipTexCoordY_windMap;\nuniform bool u_colorScale;\n\nvarying vec2 v_particle_pos;\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\nvoid main() {\n\n\tvec2 pt = gl_PointCoord - vec2(0.5);\n\tif(pt.x*pt.x+pt.y*pt.y > 0.25)\n\t{\n\t\tdiscard;\n\t}\n\t\n\tvec2 windMapTexCoord = v_particle_pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n\tvec2 velociCol = mix(u_wind_min, u_wind_max, decodeVelocity(texture2D(u_wind, windMapTexCoord).rg));\n    vec2 velocity = mix(u_wind_min, u_wind_max, texture2D(u_wind, windMapTexCoord).rg);\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\tif(length(velociCol) < 0.205) \n\t{\n\t\tdiscard;\n\t}\n\n\tif(u_colorScale)\n\t{\n\t\tspeed_t *= 1.5;\n\t\tif(speed_t > 1.0)speed_t = 1.0;\n\t\tfloat b = 1.0 - speed_t;\n\t\tfloat g;\n\t\tif(speed_t > 0.5)\n\t\t{\n\t\t\tg = 2.0-2.0*speed_t;\n\t\t}\n\t\telse{\n\t\t\tg = 2.0*speed_t;\n\t\t}\n\t\tfloat r = speed_t;\n\t\tgl_FragColor = vec4(r,g,b,1.0);\n\t}\n\telse\n\t{\n\t\tfloat intensity = speed_t*3.0;\n\t\tif(intensity > 1.0)\n\t\t\tintensity = 1.0;\n\t\tgl_FragColor = vec4(intensity,intensity,intensity,1.0);\n\t}\n\t\n}\n",waterParticlesRenderingFadeFS:"precision mediump float;\n\nuniform sampler2D u_screen;\nuniform float u_opacity;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_screen, vec2(v_tex_pos.x, v_tex_pos.y));\n    // a hack to guarantee opacity fade out even with a value close to 1.0\n    gl_FragColor = vec4(floor(255.0 * color * u_opacity) / 255.0);\n}",waterParticlesRenderVS:"precision mediump float;\n\nattribute float a_index;\n\nuniform sampler2D u_particles;\nuniform float u_particles_res;\n\nvarying vec2 v_particle_pos;\n\nvoid main() {\n    vec4 color = texture2D(u_particles, vec2(\n        fract(a_index / u_particles_res),\n        floor(a_index / u_particles_res) / u_particles_res));\n\n    // decode current particle position from the pixel's RGBA value\n    v_particle_pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a);\n\n    gl_PointSize = 1.5;\n    gl_Position = vec4(2.0 * v_particle_pos.x - 1.0, 1.0 - 2.0 * v_particle_pos.y, 0, 1);\n}\n",waterQuadVertVS:"//precision mediump float;\n\nattribute vec2 a_pos;\n\nvarying vec2 v_tex_pos;\n\nvoid main() {\n    v_tex_pos = a_pos;\n    gl_Position = vec4(-1.0 + 2.0 * a_pos, 0.0, 1.0);\n}",waterQuantizedMeshFS_3D_TEST:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform vec2 u_minMaxHeights;\nuniform int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform vec4 u_oneColor4;\n\nvarying vec3 vPos;\nvarying vec4 vColor4;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\n\n\nvoid main()\n{\n    vec4 finalCol4 = vec4(vPos.z, vPos.z, vPos.z, 1.0); // original.***\n\n    if(colorType == 1)\n    {\n        //finalCol4 = vColor4;\n        finalCol4 = u_oneColor4;\n    }\n\n    finalCol4 = u_oneColor4; // original.***\n\n    //-------------------------------------------------------------------------------------------------------------\n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0); // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n\n}",waterQuantizedMeshVS:"//precision mediump float;\n\nattribute vec3 a_pos;\nattribute vec4 color4;\n\nuniform vec3 u_totalMinGeoCoord; // (lon, lat, alt).\nuniform vec3 u_totalMaxGeoCoord;\nuniform vec3 u_currentMinGeoCoord; // min geoCoord of the current quantizedMesh.***\nuniform vec3 u_currentMaxGeoCoord; // max geoCoord of the current quantizedMesh.***\n\nuniform bool u_flipTexCoordY;\n\nvarying vec2 v_tex_pos;\nvarying vec3 vPos;\nvarying vec4 vColor4;\nvarying float v_altitude;\n\nvoid main() {\n    // Note: the position attributte is initially (in javascript) unsignedInt16 (0 to 32,767) (quantizedMesh).\n    // So, when normalize the data it transforms to (0.0 to 0.5), so must multiply by 2.0.\n    vec3 pos = a_pos * 2.0; // quantizedMeshes uses the positive parts of the signed short, so must multiply by 2.\n    \n    // Now, use totalGeoExtent & currentGeoExtent to scale the mesh.\n    // Calculate longitude & latitude.\n    float lon = u_currentMinGeoCoord.x + pos.x * (u_currentMaxGeoCoord.x - u_currentMinGeoCoord.x);\n    float lat = u_currentMinGeoCoord.y + pos.y * (u_currentMaxGeoCoord.y - u_currentMinGeoCoord.y);\n    float alt = u_currentMinGeoCoord.z + pos.z * (u_currentMaxGeoCoord.z - u_currentMinGeoCoord.z);\n\n    // Now, calculate the coord on total geoExtent.\n    float s = (lon - u_totalMinGeoCoord.x) / (u_totalMaxGeoCoord.x - u_totalMinGeoCoord.x);\n    float t = (lat - u_totalMinGeoCoord.y) / (u_totalMaxGeoCoord.y - u_totalMinGeoCoord.y);\n    float u = (alt - u_totalMinGeoCoord.z) / (u_totalMaxGeoCoord.z - u_totalMinGeoCoord.z);\n\n    //pos = vec3(pos.x, 1.0 - pos.y, pos.z); // flip y coords. // original.***\n    if(u_flipTexCoordY)\n    {\n        pos = vec3(s, 1.0 - t, u); // flip y coords.\n    }\n    else{\n        pos = vec3(s, t, u);\n    }\n    \n    vPos = pos;\n\n\n    v_tex_pos = pos.xy;\n\n    gl_Position = vec4(-1.0 + 2.0 * pos, 1.0);\n\n    vColor4 = color4;\n}",waterQuantizedMeshVS_3D_TEST:"//precision mediump float;\n\nattribute vec3 a_pos;\nattribute vec4 color4;\n\nuniform mat4 buildingRotMatrix; \n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 RefTransfMatrix;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform vec3 aditionalPosition;\n\tuniform vec3 refTranslationVec;\n\tuniform int refMatrixType; // 0= identity, 1= translate, 2= transform\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform vec3 u_minGeoCoord;\nuniform vec3 u_maxGeoCoord;\n\nuniform vec3 u_totalMinGeoCoord; // (lon, lat, alt).\nuniform vec3 u_totalMaxGeoCoord;\nuniform vec3 u_currentMinGeoCoord;\nuniform vec3 u_currentMaxGeoCoord;\n\nvarying vec2 v_tex_pos;\nvarying vec3 vPos;\nvarying vec4 vColor4;\n\n/*\nvec3 geographicToCartesianWgs84 = function(longitude, latitude, altitude)\n{\n\t// a = semi-major axis.\n\t// e2 = firstEccentricitySquared.\n\t// v = a / sqrt(1 - e2 * sin2(lat)).\n\t// x = (v+h)*cos(lat)*cos(lon).\n\t// y = (v+h)*cos(lat)*sin(lon).\n\t// z = [v*(1-e2)+h]*sin(lat).\n\tvar degToRadFactor = Math.PI/180.0;\n\tvar equatorialRadius = 6378137.0;\n\tvar firstEccentricitySquared = 6.69437999014E-3;\n\tvar lonRad = longitude * degToRadFactor;\n\tvar latRad = latitude * degToRadFactor;\n\tvar cosLon = Math.cos(lonRad);\n\tvar cosLat = Math.cos(latRad);\n\tvar sinLon = Math.sin(lonRad);\n\tvar sinLat = Math.sin(latRad);\n\tvar a = equatorialRadius;\n\tvar e2 = firstEccentricitySquared;\n\tvar v = a/Math.sqrt(1.0 - e2 * sinLat * sinLat);\n\tvar h = altitude;\n\t\n\tif (resultCartesian === undefined)\n\t{ resultCartesian = []; }\n\t\n\tresultCartesian[0]=(v+h)*cosLat*cosLon;\n\tresultCartesian[1]=(v+h)*cosLat*sinLon;\n\tresultCartesian[2]=(v*(1.0-e2)+h)*sinLat;\n\t\n\treturn resultCartesian;\n};\n*/\n\nvoid main() {\n    // Note: the position attributte is initially (in javascript) unsignedInt16 (0 to 32,767) (quantizedMesh).\n    // So, when normalize the data it transforms to (0.0 to 0.5), so must multiply by 2.0.\n    vec3 pos = a_pos * 2.0; // quantizedMeshes uses the positive parts of the signed short, so must multiply by 2.\n    \n\tpos = vec3(pos.xy * 2000.0, pos.z * 500.0 + 500.0);\n\t//pos = vec3(pos.xy * 20.0, pos.z + 500.0);\n    //----------------------------------------------------------------------------------------------------\n\tvec4 rotatedPos = buildingRotMatrix * vec4(pos.xyz, 1.0);\n    vec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + rotatedPos.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n    //vec3 rotatedNormal = currentTMat * normal;\n\n    //vNormal = normalize((normalMatrix4 * vec4(rotatedNormal, 1.0)).xyz); // original.***\n    //vTexCoord = texCoord;\n\n    gl_Position = ModelViewProjectionMatrixRelToEye * pos4;\n\n    vColor4 = color4;\n}",waterRenderFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D depthTex;\nuniform sampler2D waterTex;\nuniform sampler2D particlesTex;\n\n// Textures.********************************\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainmap;\nuniform sampler2D contaminantHeightTex;\n\n\n\nuniform vec2 u_screenSize;\nuniform float near;\nuniform float far;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\nuniform mat4 projectionMatrixInv;\nuniform bool bUseLogarithmicDepth;\nuniform int uWaterType; // 0= nothing, 1= flux, 2= velocity\nuniform float uMinWaterHeightToRender;\nvarying float flogz;\nvarying float Fcoef_half;\n\n\n\nvarying vec4 vColorAuxTest;\nvarying float vWaterHeight;\nvarying float vContaminantHeight;\nvarying float vExistContaminant;\nvarying vec3 vNormal;\nvarying vec3 vViewRay;\nvarying vec3 vOrthoPos;\nvarying vec2 vTexCoord;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\n\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/u_screenSize.x;\n    float pixelSizeY = 1.0/u_screenSize.y;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<1.0; i++)\n\t{\n\t\tdepthA += getDepth(texCoord + offset1*(1.0+i));\n\t\tdepthB += getDepth(texCoord + offset2*(1.0+i));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*1.0, depthA/1.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*1.0, depthB/1.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\nvec3 getRainbowColor_byHeight(float height, in float maxi, in float mini)\n{\n\tfloat gray = (height - mini)/(maxi - mini);\n\tif (gray > 1.0){ gray = 1.0; }\n\telse if (gray<0.0){ gray = 0.0; }\n\t\n\tfloat r, g, b;\n\n    b= 0.0;\n    r = min(gray * 2.0, 1.0);\n    g = min(2.0 - gray * 2.0, 1.0);\n\n\tvec3 resultColor = vec3(r, g, b);\n    return resultColor;\n} \n\n\n\nvoid main()\n{\n    bool isParticle = false;\n    float alpha = vColorAuxTest.a;\n    vec4 finalCol4 = vec4(vColorAuxTest);\n\n    if(uWaterType == 3)\n    {\n        // particles case: now, decode velocity:\n        vec4 velocity4 = texture2D(waterTex, vec2(vTexCoord.x, vTexCoord.y));\n        finalCol4 = mix(vColorAuxTest, velocity4, velocity4.a);\n        if(alpha < velocity4.a)\n        {\n            alpha = velocity4.a;\n            isParticle = true;\n        }\n    }\n\n    if(!isParticle && vWaterHeight + vContaminantHeight < uMinWaterHeightToRender)// original = 0.0001\n    {\n        discard;\n    }\n\n    float totalH = vWaterHeight + vContaminantHeight;\n    \n    float whiteWaterMaxHeight = uMinWaterHeightToRender * 1.5;\n    float whiteFactor = 0.0;\n    if(totalH < whiteWaterMaxHeight)\n    {\n        alpha = min(totalH/0.1, alpha); // original.***\n        //alpha = min(totalH, alpha); // test.***\n\n        // do water more white.***\n        \n        whiteFactor = (totalH - uMinWaterHeightToRender) / (whiteWaterMaxHeight - uMinWaterHeightToRender);\n        vec4 white = vec4(1.0, 1.0, 1.0, 1.0);\n        finalCol4 = mix(white, finalCol4, whiteFactor);\n\n        alpha = finalCol4.a;\n    }\n    \n\n    // calculate contaminationConcentration;\n    float contaminConcentration = vContaminantHeight / (totalH);\n\n    //vec2 screenPos = vec2(gl_FragCoord.x / u_screenSize.x, gl_FragCoord.y / u_screenSize.y);\n\n    \n    float dotProd = dot(vViewRay, vNormal);\n    //finalCol4 = vec4(finalCol4.xyz * dotProd, alpha);\n    \n\n    if(uWaterType == 1)\n    {\n        alpha = 1.0;\n\n        // flux case:\n        vec4 flux = texture2D(waterTex, vec2(vTexCoord.x, vTexCoord.y));\n        float fluxLength = length(flux)/sqrt(4.0);\n        float value = fluxLength;\n        finalCol4 = vec4(value, value, value, alpha);\n        \n    }\n    else if(uWaterType == 2)\n    {\n        alpha = 1.0;\n\n        // velocity case: now, decode velocity:\n        vec4 velocity4 = texture2D(waterTex, vec2(vTexCoord.x, vTexCoord.y));\n        vec2 decodedVelocity = decodeVelocity(velocity4.xy);\n        float velocity = length(decodedVelocity.xy)/sqrt(2.0);\n        float value = velocity;\n        finalCol4 = vec4(value, value, value, alpha);\n\n    }\n    else if(uWaterType == 3)\n    {\n        // particles case: now, decode velocity:\n        vec4 velocity4 = texture2D(waterTex, vec2(vTexCoord.x, vTexCoord.y));\n        finalCol4 = mix(finalCol4, velocity4, velocity4.a);\n        if(alpha < velocity4.a)\n        {\n            alpha = velocity4.a;\n            isParticle = true;\n        }\n    }\n\n    if(vExistContaminant > 0.0 && vContaminantHeight > 0.001)\n    {\n        float factor = min(contaminConcentration + 0.6, 1.0);\n        \n        vec4 contaminCol4 = finalCol4;\n\n        if(!isParticle)\n        {\n            float maxConc = 0.001;\n            float minConc = 0.0;\n            contaminCol4 = vec4(getRainbowColor_byHeight(contaminConcentration, maxConc, minConc), 1.0);\n            factor = (contaminConcentration - minConc)/(maxConc - minConc);\n        }\n        finalCol4 = mix(finalCol4, contaminCol4, factor);\n    }\n\n    finalCol4 = vec4(finalCol4.xyz * dotProd, alpha);\n\n    //*************************************************************************************************************\n    // Do specular lighting.***\n\tfloat lambertian = 1.0;\n\tfloat specular = 0.0;\n    float shininessValue = 200.0;\n\t//if(applySpecLighting> 0.0)\n\t//{\n\t\tvec3 L;\n        vec3 lightPos = vec3(0.0, 1.0, -1.0)*length(vOrthoPos);\n        L = normalize(lightPos - vOrthoPos);\n        lambertian = max(dot(vNormal, L), 0.0);\n\t\t\n\t\tspecular = 0.0;\n\t\t//if(lambertian > 0.0)\n\t\t{\n\t\t\tvec3 R = reflect(-L, vNormal);      // Reflected light vector\n\t\t\tvec3 V = normalize(-vOrthoPos); // Vector to viewer\n\t\t\t\n\t\t\t// Compute the specular term\n\t\t\tfloat specAngle = max(dot(R, V), 0.0);\n\t\t\tspecular = pow(specAngle, shininessValue);\n\t\t\t\n\t\t\tif(specular > 1.0)\n\t\t\t{\n\t\t\t\t//specular = 1.0;\n\t\t\t}\n\t\t}\n\t\t\n\t\tif(lambertian < 0.9)\n\t\t{\n\t\t\tlambertian = 0.9;\n\t\t}\n\n\t//}\n    //vec3 specCol = finalCol4.xyz * 3.0;\n    vec3 specCol = vec3(0.5, 1.0, 1.0);\n\n    //finalCol4 = vec4((finalCol4.xyz * lambertian + specCol * specular), alpha);\n    //*************************************************************************************************************\n    vec3 lightdir = normalize(lightPos - vOrthoPos);\n    vec3 halfway = normalize(lightdir + vViewRay);\n    float spec = pow(max(dot(vNormal, halfway), 0.0), 333.0);\n    finalCol4 = vec4((finalCol4.xyz * lambertian + specCol * spec), alpha);\n\n    if(!isParticle)\n    {\n        finalCol4 = vec4(finalCol4.xyz* (1.0 + whiteFactor), alpha);\n    }\n    \n\n    //-------------------------------------------------------------------------------------------------------------\n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0); // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n    /*\n    vec2 uv = vec2(gl_FragCoord.xy/u_Dimensions);\n    float terrainDepth = texture(sceneDepth,uv).x;\n    float sediment = texture(sedimap,fs_Uv).x;\n    float waterDepth = gl_FragCoord.z;\n\n    terrainDepth = linearDepth(terrainDepth);\n    waterDepth = linearDepth(waterDepth);\n\n    float dpVal = 180.0 * max(0.0,terrainDepth - waterDepth);\n    dpVal = clamp(dpVal, 0.0,4.0);\n    //dpVal = pow(dpVal, 0.1);\n\n\n    float fbias = 0.2;\n    float fscale = 0.2;\n    float fpow = 22.0;\n    vec3 sundir = unif_LightPos;\n\n    sundir = normalize(sundir);\n\n    vec3 nor = -calnor(fs_Uv);\n    vec3 viewdir = normalize(u_Eye - fs_Pos);\n    vec3 lightdir = normalize(sundir);\n    vec3 halfway = normalize(lightdir + viewdir);\n    vec3 reflectedSky = sky(halfway);\n    float spec = pow(max(dot(nor, halfway), 0.0), 333.0);\n\n\n    float R = max(0.0, min(1.0, fbias + fscale * pow(1.0 + dot(viewdir, -nor), fpow)));\n\n    //lamb =1.f;\n\n    float yval = texture(waterHeightTex,fs_Uv).x * 4.0;\n    float wval = texture(waterHeightTex,fs_Uv).y;\n    wval /= 1.0;\n\n    vec3 watercolor = mix(vec3(0.8,0.0,0.0), vec3(0.0,0.0,0.8), sediment * 2.0);\n    vec3 watercolorspec = vec3(1.0);\n    watercolorspec *= spec;\n\n    out_Col = vec4(vec3(0.0,0.2,0.5) + R * reflectedSky + watercolorspec  , (.5 + spec) * u_WaterTransparency * dpVal);\n    col_reflect = vec4(1.0);\n    */\n}",waterRenderVS:"\n//#version 300 es\n\n\tattribute vec3 position;\n\tattribute vec3 normal;\n\tattribute vec2 texCoord;\n\tattribute vec4 color4;\n\t\n\tuniform mat4 buildingRotMatrix; // use this matrix to calculate normals from highMaps.***\n\tuniform mat4 modelViewMatrixRelToEye; \n\tuniform mat4 ModelViewProjectionMatrixRelToEye;\n\tuniform mat4 normalMatrix4;\n\tuniform vec3 buildingPosHIGH;\n\tuniform vec3 buildingPosLOW;\n\tuniform float near;\n\tuniform float far;\n\tuniform vec3 scaleLC;\n\tuniform vec3 encodedCameraPositionMCHigh;\n\tuniform vec3 encodedCameraPositionMCLow;\n\tuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\t\n\tuniform bool bUseLogarithmicDepth;\n\tuniform float uFCoef_logDepth;\n    \nuniform vec2 u_screenSize;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\nuniform mat4 projectionMatrixInv;\n\n// Textures.********************************\nuniform sampler2D waterHeightTex;\nuniform sampler2D terrainmap;\nuniform sampler2D contaminantHeightTex;\n\nuniform vec2 u_heightMap_MinMax; // terrain.\nuniform float u_waterMaxHeigh;\nuniform float u_contaminantMaxHeigh;\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec2 u_terrainTextureSize; // for example 512 x 512.\nuniform float u_waterRenderingHeightOffset; \n\nuniform sampler2D depthTex;\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying vec4 vColorAuxTest;\nvarying float vWaterHeight;\nvarying float vContaminantHeight;\nvarying float vExistContaminant;\nvarying vec3 vNormal;\nvarying vec3 vViewRay;\nvarying vec3 vOrthoPos;\nvarying vec2 vTexCoord;\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n}\n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nfloat decodeRG(in vec2 waterColorRG)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    return dot(waterColorRG, vec2(1.0, 1.0 / 255.0));\n}\n\nvec2 encodeRG(in float wh)\n{\n    // https://titanwolf.org/Network/Articles/Article?AID=666e7443-0511-4210-b39c-db0bb6738246#gsc.tab=0\n    float encodedBit = 1.0/255.0;\n    vec2 enc = vec2(1.0, 255.0) * wh;\n    enc = fract(enc);\n    enc.x -= enc.y * encodedBit;\n    return enc; // R = HIGH, G = LOW.***\n}\n\nfloat getWaterHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(waterHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // old.\n    float decoded = unpackDepth(color4);\n    float waterHeight = decoded * u_waterMaxHeigh;\n    return waterHeight;\n}\n\nfloat getContaminantHeight(in vec2 texCoord)\n{\n    vec4 color4 = texture2D(contaminantHeightTex, texCoord);\n    //float decoded = decodeRG(color4.rg); // 16bit.\n    float decoded = unpackDepth(color4); // 32bit.\n    float waterHeight = decoded * u_contaminantMaxHeigh;\n    return waterHeight;\n}\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    //float terainHeight = texture2D(terrainmap, texCoord).r;\n    //terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    //return terainHeight;\n\n\t// 4byte mode.***\n    vec4 terrainEncoded = texture2D(terrainmap, texCoord);\n    float terainHeight = unpackDepth(terrainEncoded);\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\n/*\nvec3 calnor(vec2 uv){\n    float eps = 1.0/u_SimRes;\n    vec4 cur = texture(waterHeightTex,uv);\n    vec4 r = texture(waterHeightTex,uv+vec2(eps,0.f));\n    vec4 t = texture(waterHeightTex,uv+vec2(0.f,eps));\n\n    vec3 n1 = normalize(vec3(-1.0, cur.y + cur.x - r.y - r.x, 0.f));\n    vec3 n2 = normalize(vec3(-1.0, t.x + t.y - r.y - r.x, 1.0));\n\n    vec3 nor = -cross(n1,n2);\n    nor = normalize(nor);\n    return nor;\n}\n\nvec3 sky(in vec3 rd){\n    return mix(vec3(0.6,0.6,0.6),vec3(0.3,0.5,0.9),clamp(rd.y,0.f,1.f));\n}\n\nfloat linearDepth(float depthSample)\n{\n    depthSample = 2.0 * depthSample - 1.0;\n    float zLinear = 2.0 * u_near * u_far / (u_far + u_near - depthSample * (u_far - u_near));\n    return zLinear;\n}\n*/\n\nfloat getTotalHeight(in vec2 texCoord)\n{\n\tfloat waterHeight = getWaterHeight(texCoord);\n\tfloat terrainHeight = getTerrainHeight(texCoord);\n\tfloat contaminHeight = 0.0;\n\tif(u_contaminantMaxHeigh > 0.0)\n\t{\n\t\t// exist contaminant.\n\t\tcontaminHeight = getContaminantHeight(texCoord);\n\t}\n\n\tfloat totalHeight = waterHeight + terrainHeight + contaminHeight;\n\treturn totalHeight;\n}\n\nfloat getLiquidHeight(in vec2 texCoord)\n{\n\tfloat waterHeight = getWaterHeight(texCoord);\n\tfloat contaminHeight = 0.0;\n\tif(u_contaminantMaxHeigh > 0.0)\n\t{\n\t\t// exist contaminant.\n\t\tcontaminHeight = getContaminantHeight(texCoord);\n\t}\n\n\tfloat totalHeight = waterHeight + contaminHeight;\n\treturn totalHeight;\n}\n\nvec3 calculateNormalFromHeights(in vec2 texCoord)\n{\n\tvec3 normal;\n\tfloat cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n\tfloat divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n\t// curPos = (0, 0, curH).\n\t// upPos = (0, dy, upH).\n\t// rightPos = (dz, 0, rightH).\n\n\tvec3 curPos = vec3(0.0, 0.0, getTotalHeight(texCoord));\n\tvec3 upPos = vec3(0.0, cellSize_y, getTotalHeight(texCoord + vec2(0.0, divY)));\n\tvec3 rightPos = vec3(cellSize_x, 0.0, getTotalHeight(texCoord + vec2(divX, 0.0)));\n\n\tvec3 rightDir = (rightPos - curPos);\n\tvec3 upDir = (upPos - curPos);\n\n\tnormal = normalize(cross(rightDir, upDir));\n\n\treturn normal;\n}\n\n\nvoid main()\n{\n\t// read the altitude from waterHeightTex.\n\tvTexCoord = texCoord;\n\tvWaterHeight = getWaterHeight(texCoord);\n\n\tvContaminantHeight = 0.0;\n\tvExistContaminant = -1.0;\n\t// check if exist contaminat.\n\tif(u_contaminantMaxHeigh > 0.0)\n\t{\n\t\t// exist contaminant.\n\t\tvContaminantHeight = getContaminantHeight(texCoord);\n\t\tvExistContaminant = 1.0;\n\t}\n\n\t// Test check neighbor(adjacent) waterHeights.**************************\n\t// If some adjacent waterHeight is zero, then this waterHeight is zero.\n\t/*\n\tfloat extrudeHeight = 0.0;\n\tfloat minLiquidHeight = 0.0001;\n\tbool thisIsBorderWater = false;\n\tif(vWaterHeight + vContaminantHeight < minLiquidHeight)\n\t{\n\t\tthisIsBorderWater = true;\n\t\textrudeHeight = 0.0;\n\t}\n\t*/\n\t// End test.------------------------------------------------------------\n\n\tfloat terrainHeight = getTerrainHeight(texCoord);\n\t//float terrainHeight = getTerrainHeight_interpolated(texCoord);\n\tfloat height = terrainHeight + vWaterHeight + vContaminantHeight;\n\n\t// Test debug:\n\theight += u_waterRenderingHeightOffset;\n\n\t//if(thisIsBorderWater)\n\t//{\n\t//\theight = extrudeHeight;\n\t//}\n\n\t//float alpha = max(vWaterHeight/u_waterMaxHeigh*1.5, 0.4); // original.***\n\tfloat alpha = max(vWaterHeight/u_waterMaxHeigh*1.5, 0.7);\n\n\t\n\tvColorAuxTest = vec4(0.1, 0.3, 1.0, alpha);\n\n\tvec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t// calculate the up direction:\n\tvec4 posWC = vec4(objPosLow + objPosHigh, 1.0);\n\tvec3 upDir = normalize(posWC.xyz);\n\n\tvec4 finalPos4 =  vec4(pos4.x + upDir.x * height, pos4.y + upDir.y * height, pos4.z + upDir.z * height, 1.0);\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * finalPos4;\n\n\tvOrthoPos = (modelViewMatrixRelToEye * finalPos4).xyz;\n\tfloat depth = (-vOrthoPos.z)/(far); // the correct value.\n\n\t// try to calculate normal here.\n\tvec3 ndc = gl_Position.xyz / gl_Position.w; //perspective divide/normalize\n\tvec2 screenPos = ndc.xy * 0.5 + 0.5; //ndc is -1 to 1 in GL. scale for 0 to 1\n\n\t// Calculate normal.\n\tvec3 normalLC = calculateNormalFromHeights(texCoord);\n\tvec4 normalWC = buildingRotMatrix * vec4(normalLC, 1.0);\n\tvec4 normalCC = normalMatrix4 * normalWC;\n\n\tvNormal = normalCC.xyz;\n\tvViewRay = normalize(-getViewRay(screenPos, depth)); // original.***\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//---------------------------------------------------------------------------------\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}\n",waterReQuatizeFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D texToCopy;\n\nuniform vec2 u_original_MinMax;\nuniform vec2 u_desired_MinMax;\n\nuniform bool u_textureFlipYAxis;\nvarying vec2 v_tex_pos;\n\nvoid main()\n{\n    vec4 finalCol4;\n    if(u_textureFlipYAxis)\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n    }\n    else\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, v_tex_pos.y));\n    }\n    \n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(1.0); // depth\n        gl_FragData[2] = vec4(1.0); // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n\n}",waterSimTerrainRenderFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D diffuseTex;\nuniform sampler2D depthTex; \n\nuniform sampler2D terrainmap;\nuniform sampler2D terrainMapToCompare;\n\nuniform float near;\nuniform float far;\nuniform mat4 projectionMatrixInv;\nuniform bool bUseLogarithmicDepth;\nvarying float flogz;\nvarying float Fcoef_half;\n\nuniform int uFrustumIdx;\nuniform int u_TerrainType;\nuniform float u_WaterTransparency;\nuniform float u_SimRes;\nuniform vec2 u_Dimensions;\nuniform vec3 unif_LightPos;\nuniform float u_far;\nuniform float u_near;\n\nuniform vec2 u_screenSize;\n\nvarying vec4 vColorAuxTest;\nvarying vec2 vTexCoord;\nvarying float depth;\nvarying vec3 vNormal;\nvarying vec3 vViewRay;\nvarying float vTerrainSlided;\n\nvec3 calculateNormal(vec2 uv){\n    float eps = 1.0/u_SimRes;\n    vec4 cur = texture2D(terrainmap, uv)*50.0;\n    vec4 r = texture2D(terrainmap, uv + vec2(eps, 0.0))*50.0;\n    vec4 t = texture2D(terrainmap, uv + vec2(0.0, eps))*50.0;\n\n    vec3 n1 = normalize(vec3(-1.0, cur.x - r.x, 0.0));\n    vec3 n2 = normalize(vec3(-1.0, t.x - r.x, 1.0));\n\n    vec3 nor = -cross(n1,n2);\n    nor = normalize(nor);\n    return nor;\n}\n/*\nvec3 sky(in vec3 rd){\n    return mix(vec3(0.6,0.6,0.6),vec3(0.3,0.5,0.9),clamp(rd.y,0.f,1.f));\n}\n\nfloat linearDepth(float depthSample)\n{\n    depthSample = 2.0 * depthSample - 1.0;\n    float zLinear = 2.0 * u_near * u_far / (u_far + u_near - depthSample * (u_far - u_near));\n    return zLinear;\n}\n*/\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nfloat unpackDepth(const in vec4 rgba_depth)\n{\n\treturn dot(rgba_depth, vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} \n\nfloat getDepth(vec2 coord)\n{\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tfloat linearDepth = unpackDepth(texture2D(depthTex, coord.xy));\n\t\t// gl_FragDepthEXT = linearDepth = log2(flogz) * Fcoef_half;\n\t\t// flogz = 1.0 + gl_Position.z;\n\n\t\tfloat flogzAux = pow(2.0, linearDepth/Fcoef_half);\n\t\tfloat z = flogzAux - 1.0;\n\t\tlinearDepth = z/(far);\n\t\treturn linearDepth;\n\t}\n\telse{\n\t\treturn unpackDepth(texture2D(depthTex, coord.xy));\n\t}\n}\n\n/*\nvec3 reconstructPosition(vec2 texCoord, float depth)\n{\n    // https://wickedengine.net/2019/09/22/improved-normal-reconstruction-from-depth/\n    float x = texCoord.x * 2.0 - 1.0;\n    //float y = (1.0 - texCoord.y) * 2.0 - 1.0;\n    float y = (texCoord.y) * 2.0 - 1.0;\n    float z = (1.0 - depth) * 2.0 - 1.0;\n    vec4 pos_NDC = vec4(x, y, z, 1.0);\n    vec4 pos_CC = projectionMatrixInv * pos_NDC;\n    return pos_CC.xyz / pos_CC.w;\n}\n\nvec3 normal_from_depth(float depth, vec2 texCoord) {\n    // http://theorangeduck.com/page/pure-depth-ssao\n    float pixelSizeX = 1.0/u_screenSize.x;\n    float pixelSizeY = 1.0/u_screenSize.y;\n\n    vec2 offset1 = vec2(0.0,pixelSizeY);\n    vec2 offset2 = vec2(pixelSizeX,0.0);\n\n\tfloat depthA = 0.0;\n\tfloat depthB = 0.0;\n\tfor(float i=0.0; i<1.0; i++)\n\t{\n\t\tdepthA += getDepth(texCoord + offset1*(1.0+i));\n\t\tdepthB += getDepth(texCoord + offset2*(1.0+i));\n\t}\n\n\tvec3 posA = reconstructPosition(texCoord + offset1*1.0, depthA/1.0);\n\tvec3 posB = reconstructPosition(texCoord + offset2*1.0, depthB/1.0);\n\n    vec3 pos0 = reconstructPosition(texCoord, depth);\n    vec3 normal = cross(posA - pos0, posB - pos0);\n    normal.z = -normal.z;\n\n    return normalize(normal);\n}\n*/\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\n\nvoid main()\n{\n    //vec3 camDir = normalize(vec3(-gl_FragCoord.x / u_screenSize.x, -gl_FragCoord.y / u_screenSize.y, 1.0));\n    //vec3 camDir2 = -1.0 + 2.0 * camDir;\n    //vec3 normal = calculateNormal(vec2(vTexCoord.x, 1.0 - vTexCoord.y));\n    //float dotProd = dot(camDir2, normal);\n    //vec4 finalCol4 = vec4(vColorAuxTest * dotProd);\n    //finalCol4 = vec4(normal, 1.0);\n    //if(vColorAuxTest.r == vColorAuxTest.g && vColorAuxTest.r == vColorAuxTest.b )\n    //{\n    //    finalCol4 = vec4(1.0, 0.0, 0.0, 1.0);\n    //}\n\n    \n\n    float depthAux = depth;\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t\tdepthAux = gl_FragDepthEXT; \n\t}\n\t#endif\n\n    // read difusseTex.\n    vec4 difusseColor = texture2D(diffuseTex, vec2(vTexCoord.x, 1.0 - vTexCoord.y));\n    if(vTerrainSlided > 0.0)\n    {\n        difusseColor.r *= 0.5;\n        difusseColor.g *= 0.5;\n        difusseColor.b *= 0.5;\n    }\n    //float dotProd = dot(vViewRay, vNormal);\n    //difusseColor = vec4(difusseColor.xyz * dotProd, 1.0);\n    //gl_FragData[2] = vec4(vNormal, 1.0); // normal\n    float frustumIdx = 1.0;\n    if(uFrustumIdx == 0)\n    frustumIdx = 0.005;\n    else if(uFrustumIdx == 1)\n    frustumIdx = 0.015;\n    else if(uFrustumIdx == 2)\n    frustumIdx = 0.025;\n    else if(uFrustumIdx == 3)\n    frustumIdx = 0.035;\n\n    vec3 encodedNormal = encodeNormal(vNormal);\n\n\n    gl_FragData[0] = difusseColor;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = packDepth(depthAux);  // depth\n        gl_FragData[2] = vec4(encodedNormal, frustumIdx); // normal\n        gl_FragData[3] = difusseColor; // albedo\n        gl_FragData[4] = vec4(1.0); // selection color\n    #endif\n    /*\n    vec2 uv = vec2(gl_FragCoord.xy/u_Dimensions);\n    float terrainDepth = texture(sceneDepth,uv).x;\n    float sediment = texture(sedimap,fs_Uv).x;\n    float waterDepth = gl_FragCoord.z;\n\n    terrainDepth = linearDepth(terrainDepth);\n    waterDepth = linearDepth(waterDepth);\n\n    float dpVal = 180.0 * max(0.0,terrainDepth - waterDepth);\n    dpVal = clamp(dpVal, 0.0,4.0);\n    //dpVal = pow(dpVal, 0.1);\n\n\n    float fbias = 0.2;\n    float fscale = 0.2;\n    float fpow = 22.0;\n    vec3 sundir = unif_LightPos;\n\n    sundir = normalize(sundir);\n\n    vec3 nor = -calnor(fs_Uv);\n    vec3 viewdir = normalize(u_Eye - fs_Pos);\n    vec3 lightdir = normalize(sundir);\n    vec3 halfway = normalize(lightdir + viewdir);\n    vec3 reflectedSky = sky(halfway);\n    float spec = pow(max(dot(nor, halfway), 0.0), 333.0);\n\n\n    float R = max(0.0, min(1.0, fbias + fscale * pow(1.0 + dot(viewdir, -nor), fpow)));\n\n    //lamb =1.f;\n\n    float yval = texture(hightmap,fs_Uv).x * 4.0;\n    float wval = texture(hightmap,fs_Uv).y;\n    wval /= 1.0;\n\n\n\n    vec3 watercolor = mix(vec3(0.8,0.0,0.0), vec3(0.0,0.0,0.8), sediment * 2.0);\n    vec3 watercolorspec = vec3(1.0);\n    watercolorspec *= spec;\n\n\n\n    out_Col = vec4(vec3(0.0,0.2,0.5) + R * reflectedSky + watercolorspec  , (.5 + spec) * u_WaterTransparency * dpVal);\n    col_reflect = vec4(1.0);\n    */\n}",waterSimTerrainRenderVS:"\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texCoord;\nattribute vec4 color4;\n\nuniform mat4 buildingRotMatrix; // use this to calculate normal from hightMap textures.\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 normalMatrix4;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform float near;\nuniform float far;\nuniform vec3 scaleLC;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\n\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nuniform sampler2D terrainmap;\nuniform sampler2D terrainMapToCompare;\n\nuniform vec2 u_screenSize;\nuniform float tangentOfHalfFovy;\nuniform float aspectRatio;\n\nuniform vec2 u_heightMap_MinMax;\nuniform vec2 u_tileSize; // tile size in meters.\nuniform vec2 u_simulationTextureSize; // for example 512 x 512.\nuniform vec2 u_terrainTextureSize; // for example 512 x 512.\n\nvarying float flogz;\nvarying float Fcoef_half;\n\nvarying vec4 vColorAuxTest;\nvarying vec2 vTexCoord;\nvarying float depth;\nvarying vec3 vNormal;\nvarying vec3 vViewRay;\nvarying float vTerrainSlided;\n\nvec3 getViewRay(vec2 tc, in float relFar)\n{\n\tfloat hfar = 2.0 * tangentOfHalfFovy * relFar;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -relFar);    \n\t\n    return ray;                      \n}\n\nfloat getTerrainHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainmap, texCoord).b;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nfloat getTerrainToCompareHeight(in vec2 texCoord)\n{\n    float terainHeight = texture2D(terrainMapToCompare, texCoord).b;\n    terainHeight = u_heightMap_MinMax.x + terainHeight * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n    return terainHeight;\n}\n\nfloat getTerrainHeight_interpolated(const vec2 uv) \n{\n    vec2 px = 1.0 / u_terrainTextureSize;\n    vec2 vc = (floor(uv * u_terrainTextureSize)) * px;\n    vec2 f = fract(uv * u_terrainTextureSize);\n    float tl = texture2D(terrainmap, vc).r;\n    float tr = texture2D(terrainmap, vc + vec2(px.x, 0)).r;\n    float bl = texture2D(terrainmap, vc + vec2(0, px.y)).r;\n    float br = texture2D(terrainmap, vc + px).r;\n\n    float h =  mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n\th = u_heightMap_MinMax.x + h * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n\treturn h;\n}\n\nvec3 calculateNormalFromHeights(in vec2 texCoord, in float curHeight)\n{\n\tvec3 normal;\n\tfloat cellSize_x = u_tileSize.x / u_simulationTextureSize.x;\n    float cellSize_y = u_tileSize.y / u_simulationTextureSize.y;\n\n\tfloat divX = 1.0/u_simulationTextureSize.x;\n    float divY = 1.0/u_simulationTextureSize.y;\n\n\tvec3 curPos = vec3(0.0, 0.0, curHeight);\n\tvec3 upPos = vec3(0.0, cellSize_y, getTerrainHeight_interpolated(texCoord + vec2(0.0, divY)));\n\tvec3 rightPos = vec3(cellSize_x, 0.0, getTerrainHeight_interpolated(texCoord + vec2(divX, 0.0)));\n\n\tvec3 rightDir = (rightPos - curPos);\n\tvec3 upDir = (upPos - curPos);\n\n\tnormal = normalize(cross(rightDir, upDir));\n\treturn normal;\n}\n\nvoid main()\n{\n\t// read the altitude from hightmap.\n\tvTexCoord = texCoord; // used for difusseTex.\n\n\t//float terrainHeight = getTerrainHeight_interpolated(texCoord);\n\tfloat terrainHeight = getTerrainHeight(texCoord);\n\tfloat height = terrainHeight; \n\tfloat terrainToCompareHeight = getTerrainToCompareHeight(texCoord);\n\n\tvTerrainSlided = -1.0;\n\tif(abs(terrainToCompareHeight - terrainHeight) > 0.8)\n\t{\n\t\tvTerrainSlided = 1.0;\n\t}\n\n\tvec3 objPosHigh = buildingPosHIGH;\n    vec3 objPosLow = buildingPosLOW.xyz + position.xyz;\n    vec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n    vec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n    vec4 pos4 = vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n\t\n\t// calculate the up direction:\n\tvec4 posWC = vec4(objPosLow + objPosHigh, 1.0);\n\tvec3 upDir = normalize(posWC.xyz);\n\n\tvec4 finalPos4 =  vec4(pos4.x + upDir.x * height, pos4.y + upDir.y * height, pos4.z + upDir.z * height, 1.0);\n\n\tgl_Position = ModelViewProjectionMatrixRelToEye * finalPos4;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * finalPos4;\n\t//vertexPos = orthoPos.xyz;\n\tdepth = (-orthoPos.z)/(far); // the correct value.\n\n\t// Calculate normal.\n\t// try to calculate normal here.\n\t////vec3 ndc = gl_Position.xyz / gl_Position.w; //perspective divide/normalize\n\t////vec2 screenPos = ndc.xy * 0.5 + 0.5; //ndc is -1 to 1 in GL. scale for 0 to 1\n\t////vViewRay = normalize(-getViewRay(screenPos, depth));\n\n\tvec3 normalLC = calculateNormalFromHeights(texCoord, terrainHeight);\n\tvec4 normalWC = buildingRotMatrix * vec4(normalLC, 1.0);\n\tvec4 normalCC = normalMatrix4 * normalWC;\n\tvNormal = normalCC.xyz;\n\t\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\t// float Fcoef = 2.0 / log2(far + 1.0);\n\t\t// gl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * uFCoef_logDepth - 1.0;\n\t\t// flogz = 1.0 + gl_Position.w;\n\t\t//---------------------------------------------------------------------------------\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * uFCoef_logDepth;\n\t}\n}\n",waterUpdateParticlesFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D u_particles;\nuniform sampler2D u_wind;\nuniform sampler2D u_windGlobeDepthTex;\nuniform sampler2D u_windGlobeNormalTex;\n\nuniform mat4 modelViewMatrixInv;\n\nuniform vec2 u_wind_res;\nuniform vec2 u_wind_min;\nuniform vec2 u_wind_max;\nuniform vec3 u_geoCoordRadiansMax;\nuniform vec3 u_geoCoordRadiansMin;\nuniform float u_rand_seed;\nuniform float u_speed_factor;\nuniform float u_interpolation;\nuniform float u_drop_rate;\nuniform float u_drop_rate_bump;\nuniform bool u_flipTexCoordY_windMap;\nuniform vec4 u_visibleTilesRanges[16];\nuniform int u_visibleTilesRangesCount;\n\nuniform float tangentOfHalfFovy;\nuniform float far;            \nuniform float aspectRatio; \n\n// new uniforms test.\nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform mat4 buildingRotMatrix;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform mat4 buildingRotMatrixInv;\nuniform vec2 uNearFarArray[4];\n\n#define M_PI 3.1415926535897932384626433832795\n\nvarying vec2 v_tex_pos;\n\n// pseudo-random generator\nconst vec3 rand_constants = vec3(12.9898, 78.233, 4375.85453);\n// https://community.khronos.org/t/random-values/75728\nfloat rand(const vec2 co) {\n    float t = dot(rand_constants.xy, co);\n    return fract(sin(t) * (rand_constants.z + t));\n}\n\nvec2 encodeVelocity(in vec2 vel)\n{\n\treturn vel*0.5 + 0.5;\n}\n\nvec2 decodeVelocity(in vec2 encodedVel)\n{\n\treturn vec2(encodedVel.xy * 2.0 - 1.0);\n}\n\n// wind speed lookup; use manual bilinear filtering based on 4 adjacent pixels for smooth interpolation\nvec2 lookup_wind(const vec2 uv) {\n    //return texture2D(u_wind, uv).rg; // lower-res hardware filtering\n\t\n    vec2 px = 1.0 / u_wind_res;\n    vec2 vc = (floor(uv * u_wind_res)) * px;\n    vec2 f = fract(uv * u_wind_res);\n    vec2 tl = texture2D(u_wind, vc).rg;\n    vec2 tr = texture2D(u_wind, vc + vec2(px.x, 0)).rg;\n    vec2 bl = texture2D(u_wind, vc + vec2(0, px.y)).rg;\n    vec2 br = texture2D(u_wind, vc + px).rg;\n\n    return mix(mix(tl, tr, f.x), mix(bl, br, f.x), f.y);\n}\n\nfloat radiusAtLatitudeRad(in float latRad)\n{\n\t// a = equatorialRadius, b = polarRadius.\n\t// r = a*b / sqrt(a2*sin2(lat) + b2*cos2(lat)).\n\t//------------------------------------------------------\n\tfloat a = 6378137.0; // Globe.equatorialRadius();\n\tfloat b = 6356752.3142; // Globe.polarRadius();\n\tfloat a2 = 40680631590769.0; // Globe.equatorialRadiusSquared();\n\tfloat b2 = 40408299984087.05552164; // Globe.polarRadiusSquared();\n\t\n\tfloat sin = sin(latRad);\n\tfloat cos = cos(latRad);\n\tfloat sin2 = sin*sin;\n\tfloat cos2 = cos*cos;\n\t\n\tfloat radius = (a*b)/(sqrt(a2*sin2 + b2*cos2));\n\treturn radius;\n}\n\nvoid main() \n{\n    vec4 color = texture2D(u_particles, v_tex_pos);\n    vec2 pos = vec2(\n        color.r / 255.0 + color.b,\n        color.g / 255.0 + color.a); // decode particle position from pixel RGBA\n\n\tvec2 windMapTexCoord = pos;\n\tif(u_flipTexCoordY_windMap)\n\t{\n\t\twindMapTexCoord.y = 1.0 - windMapTexCoord.y;\n\t}\n\t// Test debug:::::::::::::::::::::::::::::::::::\n\t//vec2 velColor = vec2(1.0, 0.0);\n\tvec2 velColor = lookup_wind(windMapTexCoord);\n\tvec2 decodedVel = decodeVelocity(velColor);\n\t// End test.------------------------------------\n\n    vec2 velocity = mix(u_wind_min, u_wind_max, decodeVelocity(lookup_wind(windMapTexCoord)));\n    float speed_t = length(velocity) / length(u_wind_max);\n\n\tif(abs(decodedVel.x) < 0.004 && abs(decodedVel.y) < 0.004) // 1/255 = 0.0039...\n\t{\n\t\tspeed_t = 0.0;\n\t\tvelocity = vec2(0.0);\n\t}\n\n\n\n    // Calculate pixelSizes.**************************************************************************************************\n\t//vec3 buildingPos = buildingPosHIGH + buildingPosLOW;\n\t//float radius = length(buildingPos);\n\tfloat minLonRad = u_geoCoordRadiansMin.x;\n\tfloat maxLonRad = u_geoCoordRadiansMax.x;\n\tfloat minLatRad = u_geoCoordRadiansMin.y;\n\tfloat maxLatRad = u_geoCoordRadiansMax.y;\n\tfloat lonRadRange = maxLonRad - minLonRad;\n\tfloat latRadRange = maxLatRad - minLatRad;\n\n    float midLatRad = (maxLatRad + minLatRad) / 2.0;\n    float radius = radiusAtLatitudeRad(midLatRad);\n\n\tfloat distortion = cos((minLatRad + pos.y * latRadRange ));\n\n\tfloat meterToLon = 1.0/(radius * distortion);\n\tfloat meterToLat = 1.0 / radius;\n\n\tfloat xSpeedFactor = meterToLon / lonRadRange;\n\tfloat ySpeedFactor = meterToLat / latRadRange;\n\n\txSpeedFactor *= 1.0 * u_speed_factor;\n\tySpeedFactor *= 1.0 * u_speed_factor;\n\n\tvec2 offset = vec2(velocity.x / distortion * xSpeedFactor, -velocity.y * ySpeedFactor);\n\n    // update particle position, wrapping around the date line\n    pos = fract(1.0 + pos + offset);\n\t// End ******************************************************************************************************************\n\n    float drop = 0.0;\n\n    // a random seed to use for the particle drop\n    vec2 seed = (pos + v_tex_pos) * u_rand_seed;\n    float drop_rate = u_drop_rate + speed_t * u_drop_rate_bump;\n    drop = step(1.0 - drop_rate, rand(seed));\n\n    //vec4 vel = texture2D(u_wind, v_tex_pos);\n\n    if(drop > 0.1 || speed_t < 0.0006) // 0.01\n\t{\n\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\tpos = random_pos;\n\t\t\n\t\t// check the velocity in the new position.***\n\t\tdecodedVel = decodeVelocity(lookup_wind(random_pos));\n\t\tif(abs(decodedVel.x) < 0.004 && abs(decodedVel.y) < 0.004) // 1/255 = 0.0039...\n\t\t{\n\t\t\t//pos = vec2( 0.0, 0.0);\n\n\t\t\tvec2 random_pos = vec2( rand(pos), rand(v_tex_pos) );\n\t\t\tpos = random_pos;\n\t\t}\n\t\t\n\t\t\n\t}\n    \n    // encode the new particle position back into RGBA\n    gl_FragData[0] = vec4(\n        fract(pos * 255.0),\n        floor(pos * 255.0) / 255.0);\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = vec4(velColor, 0.0, 0.0); //\n        gl_FragData[2] = vec4(0.0); // \n        gl_FragData[3] = vec4(0.0); // \n        gl_FragData[4] = vec4(0.0); // \n    #endif\n}",waterVoxelizeFromDepthTexFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D depthTex;\n\nuniform bool u_textureFlipYAxis;\nuniform int u_texSize[3]; // The original texture3D size.***\nuniform int u_mosaicTexSize[3]; // The mosaic texture size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_lowestMosaicSliceIndex;\nuniform vec2 u_heightMap_MinMax; // dem of terrain (buildings included) min max heights. \nuniform vec2 u_realTex3d_minMaxAltitudes; // min max of tex3d slices altitudes.***\n\nvarying vec2 v_tex_pos;\n\n\t//       Sample of a slice of the mosaic texture.***\n\t//\n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_15  |   tex_16  |   tex_17  |   tex_18  |   tex_19  |      row 3  \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_10  |   tex_11  |   tex_12  |   tex_13  |   tex_14  |      row 2   \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_5   |   tex_6   |   tex_7   |   tex_8   |   tex_9   |      row 1    \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_0   |   tex_1   |   tex_2   |   tex_3   |   tex_4   |      row 0     \n\t//      |           |           |           |           |           |  \n\t//      +-----------+-----------+-----------+-----------+-----------+   \n    //\n    //          col 0       col 1       col 2       col 3       col 4\nint getSliceIdx_ofTexture3D(int col, int row, int currMosaicSliceIdx)\n{\n    int subTexCount_inAMosaicSlice = u_mosaicSize[0] * u_mosaicSize[1]; // total textures count in a mosaic slice.***\n    int currentSlicesAmount = (row * u_mosaicSize[0]) + col; // the textures count under the texture[col, row] in a mosaic slice.***\n    int tex3DSliceIdx = subTexCount_inAMosaicSlice * currMosaicSliceIdx + currentSlicesAmount;\n\n    return tex3DSliceIdx;\n}\n\nfloat getSliceAltitude_ofTexture3D(int col, int row, int currMosaicSliceIdx)\n{\n    int sliceIdx = getSliceIdx_ofTexture3D(col, row, currMosaicSliceIdx);\n    //float slice_altitude = float(sliceIdx) / float(u_texSize[2]); // original.***\n    float unitary_alt = float(sliceIdx) / float(u_texSize[2]);\n    float slice_altitude = u_realTex3d_minMaxAltitudes.x + unitary_alt * (u_realTex3d_minMaxAltitudes.y - u_realTex3d_minMaxAltitudes.x);\n    return slice_altitude;\n}\n\nvec2 getColRow_and_subTexCoord(in vec2 texCoord, inout vec2 subTexCoord)\n{\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    // Determine the [col, row] of the mosaic.***\n    vec2 resultColRow = vec2(floor(texCoord.x / sRange), floor(texCoord.y / tRange));\n\n    // determine the subTexCoord.***\n    float col_mod = texCoord.x - resultColRow.x * sRange;\n    float row_mod = texCoord.y - resultColRow.y * tRange;\n    float s = col_mod / sRange;\n    float t = row_mod / tRange;\n    subTexCoord = vec2(s, t);\n\n    return resultColRow;\n}\n\nvoid main()\n{\n    // By tex-coord, must know the column & row of the mosaic texture.***\n    // Note : The rendering process uses a FBO with (u_mosaicTexSize[0] X u_mosaicTexSize[1]) as screen size.***\n    vec2 subTexCoord;\n    vec2 colRow = getColRow_and_subTexCoord(v_tex_pos, subTexCoord);\n\n    vec4 depth;\n    if(u_textureFlipYAxis)\n    {\n        depth = texture2D(depthTex, vec2(subTexCoord.x, 1.0 - subTexCoord.y));\n    }\n    else\n    {\n        depth = texture2D(depthTex, vec2(subTexCoord.x, subTexCoord.y));\n    }\n\n    // Now, for each slice, must determine if the "depth" value is bigger or lower than the slice altitude (the slice altitude in a range [0 to 1]).***\n    float col = colRow.x;\n    float row = colRow.y;\n    int col_int = int(col);\n    int row_int = int(row);\n    // slice 0.\n    // must determine the altitude of the sub-texture[col, row].\n    float slice_altitude = getSliceAltitude_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex);\n    float r = col / float(u_mosaicSize[0]);\n    float g = row / float(u_mosaicSize[1]);\n    vec4 slice_color = vec4(0.0);\n\n    float depthTex_altitude = u_heightMap_MinMax.x + depth.r * (u_heightMap_MinMax.y - u_heightMap_MinMax.x);\n\n    //if(depth.r > slice_altitude)\n    if(depthTex_altitude > slice_altitude)\n    {\n        slice_color = vec4(0.0, 0.0, 0.0, 1.0);\n    }\n\n    gl_FragData[0] = slice_color;  \n\n    #ifdef USE_MULTI_RENDER_TARGET\n        // slice 1.\n        slice_altitude = getSliceAltitude_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex + 1);\n        slice_color = vec4(0.0);\n        if(depthTex_altitude > slice_altitude)\n        {\n            slice_color = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n        gl_FragData[1] = slice_color;\n\n        // slice 2.\n        slice_altitude = getSliceAltitude_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex + 2);\n        slice_color = vec4(0.0);\n        if(depthTex_altitude > slice_altitude)\n        {\n            slice_color = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n        gl_FragData[2] = slice_color;\n\n        // slice 3.\n        slice_altitude = getSliceAltitude_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex + 3);\n        slice_color = vec4(0.0);\n        if(depthTex_altitude > slice_altitude)\n        {\n            slice_color = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n        gl_FragData[3] = slice_color; \n\n        // slice 4.\n        slice_altitude = getSliceAltitude_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex + 4);\n        slice_color = vec4(0.0);\n        if(depthTex_altitude > slice_altitude)\n        {\n            slice_color = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n        gl_FragData[4] = slice_color;\n\n        // slice 5.\n        slice_altitude = getSliceAltitude_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex + 5);\n        slice_color = vec4(0.0);\n        if(depthTex_altitude > slice_altitude)\n        {\n            slice_color = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n        gl_FragData[5] = slice_color; \n\n        // slice 6.\n        slice_altitude = getSliceAltitude_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex + 6);\n        slice_color = vec4(0.0);\n        if(depthTex_altitude > slice_altitude)\n        {\n            slice_color = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n        gl_FragData[6] = slice_color; \n\n        // slice 7.\n        slice_altitude = getSliceAltitude_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex + 7);\n        slice_color = vec4(0.0);\n        if(depthTex_altitude > slice_altitude)\n        {\n            slice_color = vec4(0.0, 0.0, 0.0, 1.0);\n        }\n        gl_FragData[7] = slice_color;\n    #endif\n\n}',waterVoxelizeFromPartialXDirectionTexture3DFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D currentSceneVoxelizedMosaicTex;\nuniform sampler2D partialXDirectionMosaicTex;\n\n//uniform bool u_textureFlipYAxis;\nuniform int u_texSize[3]; // The original texture3D size.***\n//uniform int u_mosaicTexSize[3]; // The mosaic texture size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_lowestMosaicSliceIndex;\n\n// vars for partialXDirectionMosaicTex:\nuniform int u_lowestXDirMosaicSliceIndex;\nuniform int u_xDirMosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_xDirTextureSize[3]; // The real 3D texture size.***\n\nvarying vec2 v_tex_pos;\n\n\t//       Sample of a slice of the mosaic texture.***\n\t//\n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_15  |   tex_16  |   tex_17  |   tex_18  |   tex_19  |      row 3  \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_10  |   tex_11  |   tex_12  |   tex_13  |   tex_14  |      row 2   \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_5   |   tex_6   |   tex_7   |   tex_8   |   tex_9   |      row 1    \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_0   |   tex_1   |   tex_2   |   tex_3   |   tex_4   |      row 0     \n\t//      |           |           |           |           |           |  \n\t//      +-----------+-----------+-----------+-----------+-----------+   \n    //\n    //          col 0       col 1       col 2       col 3       col 4\nint getSliceIdx_ofTexture3D(int col, int row, int currMosaicSliceIdx)\n{\n    int subTexCount_inAMosaicSlice = u_mosaicSize[0] * u_mosaicSize[1]; // total textures count in a mosaic slice.***\n    int currentSlicesAmount = (row * u_mosaicSize[0]) + col; // the textures count under the texture[col, row] in a mosaic slice.***\n    int tex3DSliceIdx = subTexCount_inAMosaicSlice * currMosaicSliceIdx + currentSlicesAmount;\n\n    return tex3DSliceIdx;\n}\n\nvec2 getColRow_and_subTexCoord(in vec2 texCoord, inout vec2 subTexCoord)\n{\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    // Determine the [col, row] of the mosaic.***\n    vec2 resultColRow = vec2(floor(texCoord.x / sRange), floor(texCoord.y / tRange));\n\n    // determine the subTexCoord.***\n    float col_mod = texCoord.x - resultColRow.x * sRange;\n    float row_mod = texCoord.y - resultColRow.y * tRange;\n    float s = col_mod / sRange;\n    float t = row_mod / tRange;\n    subTexCoord = vec2(s, t);\n\n    return resultColRow;\n}\n\nvec2 getColRow_ofSliceIdx(in int sliceIdx, in int mosaicColsCount)\n{\n    // Given a sliceIdx, mosaicColumnsCount & mosaicRowsCount, this function returns the column & row of the sliceIdx.***\n    float row = floor(float(sliceIdx)/float(mosaicColsCount));\n    //float col = mod(float(sliceIdx), float(mosaicColsCount)); // mod = float(sliceIdx) - float(mosaicColsCount) * row;\n    float col = float(sliceIdx) - float(mosaicColsCount) * row;\n    vec2 colRow = vec2(col, row);\n    return colRow;\n}\n\n float getVoxelSpaceValue(in vec2 texCoord)\n{\n    // The scene voxelMatrix is into flux_RFU_MosaicTex_HIGH(here named currentSceneVoxelizedMosaicTex), in alpha channel.***\n    vec4 color4_RFU_HIGH = texture2D(currentSceneVoxelizedMosaicTex, texCoord);\n    return color4_RFU_HIGH.a;\n}\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col, in int row, in int mosaicNumCols, in int mosaicNumRows)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(mosaicNumCols);\n    float tRange = 1.0 / float(mosaicNumRows);\n\n    float s = float(col) * sRange + subTexCoord.x * sRange;\n    float t = float(row) * tRange + subTexCoord.y * tRange;\n\n    vec2 resultTexCoord = vec2(s, t);\n    return resultTexCoord;\n}\n\nvoid main()\n{\n    // Note : this shader only can have one output. Is not possible MRT.***\n    //-------------------------------------------------------------------------\n\n    // 1rst, check if the current voxel is solid or not.\n    // If the current voxel is solid, then write "solid" and return. No need calculate anything.***\n    vec4 color4_RFU_HIGH = texture2D(currentSceneVoxelizedMosaicTex, v_tex_pos); \n    if(color4_RFU_HIGH.a > 0.0)\n    {\n        gl_FragData[0] = color4_RFU_HIGH;  \n        return;\n    }\n\n    // By tex-coord, must know the column & row of the mosaic texture.***\n    // Note : The rendering process uses a FBO with (u_mosaicTexSize[0] X u_mosaicTexSize[1]) as screen size.***\n    vec2 subTexCoord;\n    vec2 colRow = getColRow_and_subTexCoord(v_tex_pos, subTexCoord); // here returns the subTexCoords too.***\n    float col = colRow.x;\n    float row = colRow.y;\n    int col_int = int(col);\n    int row_int = int(row);\n\n    // Now, with "colRow" & "u_lowestMosaicSliceIndex" determine the sliceIdx of the real3dTexture.***\n    int sliceIdx = getSliceIdx_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex);\n\n    // Now, with "subTexCoord" & "sliceIdx" calculate the textureIdx of "partialYDirectionMosaicTex" & the texCoords of it.***\n    // With subTexCoord.y we can determine the partialYDirectionMosaicTex_sliceIdx.***\n    int xDirSliceIdx = int(subTexCoord.x * float(u_texSize[0])); // the absolute xDirSliceIdx. There are "u_texSize[1]" yDirSlices count in total, but we only have 8 yDirSlices in a mosaic.***\n\n    vec4 finalColor4 = vec4(color4_RFU_HIGH.r, color4_RFU_HIGH.g, color4_RFU_HIGH.b, color4_RFU_HIGH.a);\n\n    // Now, check if "xDirSliceIdx" is inside of the 8 YDirTextures availables.***\n    \n    if(xDirSliceIdx < u_lowestXDirMosaicSliceIndex || xDirSliceIdx > u_lowestXDirMosaicSliceIndex + 7)\n    {\n        gl_FragData[0] = color4_RFU_HIGH;    \n        return;\n    } \n\n    int currXDirSliceIdx = xDirSliceIdx - u_lowestXDirMosaicSliceIndex;\n\n\n    // Now determine the col & row of the yDirMosaicTexture.***\n    vec2 colRow_xDirMosaic = getColRow_ofSliceIdx(currXDirSliceIdx, u_xDirMosaicSize[0]);\n\n    // Now, calculate the subTexCoordXDir (texCoord in realTex3D).***\n    // Note : u_texSize[2] must to be = u_xDirTextureSize[1];\n    vec2 subTexCoordXDir = vec2(1.0 - subTexCoord.y, float(sliceIdx)/float(u_xDirTextureSize[1]));\n\n    // Now, calculate the texCoordXDirMosaic.***\n    int col_xDirMosaic = int(colRow_xDirMosaic.x);\n    int row_xDirMosaic = int(colRow_xDirMosaic.y);\n\n    vec2 texCoordXDirMosaic = subTexCoord_to_texCoord(subTexCoordXDir, col_xDirMosaic, row_xDirMosaic, u_xDirMosaicSize[0], u_xDirMosaicSize[1]);\n\n    // Now, read the value:\n    vec4 color4_xDirTex = texture2D(partialXDirectionMosaicTex, texCoordXDirMosaic); \n\n    if(finalColor4.a < color4_xDirTex.a)\n    {\n        finalColor4.a = color4_xDirTex.a;\n    }\n\n    gl_FragData[0] = finalColor4;  \n\n}',waterVoxelizeFromPartialYDirectionTexture3DFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D currentSceneVoxelizedMosaicTex;\nuniform sampler2D partialYDirectionMosaicTex;\n\n//uniform bool u_textureFlipYAxis;\nuniform int u_texSize[3]; // The original texture3D size.***\n//uniform int u_mosaicTexSize[3]; // The mosaic texture size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_lowestMosaicSliceIndex;\n\n// vars for partialYDirectionMosaicTex:\nuniform int u_lowestYDirMosaicSliceIndex;\nuniform int u_yDirMosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_yDirTextureSize[3]; // The real 3D texture size.***\n\nvarying vec2 v_tex_pos;\n\n\t//       Sample of a slice of the mosaic texture.***\n\t//\n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_15  |   tex_16  |   tex_17  |   tex_18  |   tex_19  |      row 3  \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_10  |   tex_11  |   tex_12  |   tex_13  |   tex_14  |      row 2   \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_5   |   tex_6   |   tex_7   |   tex_8   |   tex_9   |      row 1    \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_0   |   tex_1   |   tex_2   |   tex_3   |   tex_4   |      row 0     \n\t//      |           |           |           |           |           |  \n\t//      +-----------+-----------+-----------+-----------+-----------+   \n    //\n    //          col 0       col 1       col 2       col 3       col 4\nint getSliceIdx_ofTexture3D(int col, int row, int currMosaicSliceIdx)\n{\n    int subTexCount_inAMosaicSlice = u_mosaicSize[0] * u_mosaicSize[1]; // total textures count in a mosaic slice.***\n    int currentSlicesAmount = (row * u_mosaicSize[0]) + col; // the textures count under the texture[col, row] in a mosaic slice.***\n    int tex3DSliceIdx = subTexCount_inAMosaicSlice * currMosaicSliceIdx + currentSlicesAmount;\n\n    return tex3DSliceIdx;\n}\n\nvec2 getColRow_and_subTexCoord(in vec2 texCoord, inout vec2 subTexCoord)\n{\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    // Determine the [col, row] of the mosaic.***\n    vec2 resultColRow = vec2(floor(texCoord.x / sRange), floor(texCoord.y / tRange));\n\n    // determine the subTexCoord.***\n    float col_mod = texCoord.x - resultColRow.x * sRange;\n    float row_mod = texCoord.y - resultColRow.y * tRange;\n    float s = col_mod / sRange;\n    float t = row_mod / tRange;\n    subTexCoord = vec2(s, t);\n\n    return resultColRow;\n}\n\nvec2 getColRow_ofSliceIdx(in int sliceIdx, in int mosaicColsCount)\n{\n    // Given a sliceIdx, mosaicColumnsCount & mosaicRowsCount, this function returns the column & row of the sliceIdx.***\n    float row = floor(float(sliceIdx)/float(mosaicColsCount));\n    //float col = mod(float(sliceIdx), float(mosaicColsCount)); // mod = float(sliceIdx) - float(mosaicColsCount) * row;\n    float col = float(sliceIdx) - float(mosaicColsCount) * row;\n    vec2 colRow = vec2(col, row);\n    return colRow;\n}\n\n float getVoxelSpaceValue(in vec2 texCoord)\n{\n    // The scene voxelMatrix is into flux_RFU_MosaicTex_HIGH(here named currentSceneVoxelizedMosaicTex), in alpha channel.***\n    vec4 color4_RFU_HIGH = texture2D(currentSceneVoxelizedMosaicTex, texCoord);\n    return color4_RFU_HIGH.a;\n}\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col, in int row, in int mosaicNumCols, in int mosaicNumRows)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(mosaicNumCols);\n    float tRange = 1.0 / float(mosaicNumRows);\n\n    float s = float(col) * sRange + subTexCoord.x * sRange;\n    float t = float(row) * tRange + subTexCoord.y * tRange;\n\n    vec2 resultTexCoord = vec2(s, t);\n    return resultTexCoord;\n}\n\nvoid main()\n{\n    // Note : this shader only can have one output. Is not possible MRT.***\n    //-------------------------------------------------------------------------\n\n    // 1rst, check if the current voxel is solid or not.\n    // If the current voxel is solid, then write "solid" and return. No need calculate anything.***\n    vec4 color4_RFU_HIGH = texture2D(currentSceneVoxelizedMosaicTex, v_tex_pos); \n    if(color4_RFU_HIGH.a > 0.0)\n    {\n        gl_FragData[0] = color4_RFU_HIGH;  \n        return;\n    }\n\n    // By tex-coord, must know the column & row of the mosaic texture.***\n    // Note : The rendering process uses a FBO with (u_mosaicTexSize[0] X u_mosaicTexSize[1]) as screen size.***\n    vec2 subTexCoord;\n    vec2 colRow = getColRow_and_subTexCoord(v_tex_pos, subTexCoord); // here returns the subTexCoords too.***\n    float col = colRow.x;\n    float row = colRow.y;\n    int col_int = int(col);\n    int row_int = int(row);\n\n    // Now, with "colRow" & "u_lowestMosaicSliceIndex" determine the sliceIdx of the real3dTexture.***\n    int sliceIdx = getSliceIdx_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex);\n\n    // Now, with "subTexCoord" & "sliceIdx" calculate the textureIdx of "partialYDirectionMosaicTex" & the texCoords of it.***\n    // With subTexCoord.y we can determine the partialYDirectionMosaicTex_sliceIdx.***\n    int yDirSliceIdx = int(subTexCoord.y * float(u_texSize[1])); // the absolute yDirSliceIdx. There are "u_texSize[1]" yDirSlices count in total, but we only have 8 yDirSlices in a mosaic.***\n\n    vec4 finalColor4 = vec4(color4_RFU_HIGH.r, color4_RFU_HIGH.g, color4_RFU_HIGH.b, color4_RFU_HIGH.a);\n\n    // Now, check if "yDirSliceIdx" is inside of the 8 YDirTextures availables.***\n    \n    if(yDirSliceIdx < u_lowestYDirMosaicSliceIndex || yDirSliceIdx > u_lowestYDirMosaicSliceIndex + 7)\n    {\n        gl_FragData[0] = color4_RFU_HIGH;    \n        return;\n    } \n\n    int currYDirSliceIdx = yDirSliceIdx - u_lowestYDirMosaicSliceIndex;\n\n\n    // Now determine the col & row of the yDirMosaicTexture.***\n    vec2 colRow_yDirMosaic = getColRow_ofSliceIdx(currYDirSliceIdx, u_yDirMosaicSize[0]);\n\n    // Now, calculate the subTexCoordYDir (texCoord in realTex3D).***\n    // Note : u_texSize[2] must to be = u_yDirTextureSize[1];\n    vec2 subTexCoordYDir = vec2(subTexCoord.x, float(sliceIdx)/float(u_yDirTextureSize[1]));\n\n    // Now, calculate the texCoordYDirMosaic.***\n    int col_yDirMosaic = int(floor(colRow_yDirMosaic.x));\n    int row_yDirMosaic = int(floor(colRow_yDirMosaic.y));\n\n    vec2 texCoordYDirMosaic = subTexCoord_to_texCoord(subTexCoordYDir, col_yDirMosaic, row_yDirMosaic, u_yDirMosaicSize[0], u_yDirMosaicSize[1]);\n\n    // Now, read the value:\n    vec4 color4_yDirTex = texture2D(partialYDirectionMosaicTex, texCoordYDirMosaic); \n\n    if(finalColor4.a < color4_yDirTex.a)\n    {\n        finalColor4.a = color4_yDirTex.a;\n    }\n\n    gl_FragData[0] = finalColor4;  \n\n}',waterVoxelizeFromPartialZDirectionTexture3DFS:'//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D currentSceneVoxelizedMosaicTex;\nuniform sampler2D partialZDirectionMosaicTex;\n\n//uniform bool u_textureFlipYAxis;\nuniform int u_texSize[3]; // The original texture3D size.***\n//uniform int u_mosaicTexSize[3]; // The mosaic texture size.***\nuniform int u_mosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_lowestMosaicSliceIndex;\n\n// vars for partialZDirectionMosaicTex:\nuniform int u_lowestZDirMosaicSliceIndex;\nuniform int u_zDirMosaicSize[3]; // The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\nuniform int u_zDirTextureSize[3]; // The real 3D texture size.***\n\nvarying vec2 v_tex_pos;\n\n\t//       Sample of a slice of the mosaic texture.***\n\t//\n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_15  |   tex_16  |   tex_17  |   tex_18  |   tex_19  |      row 3  \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_10  |   tex_11  |   tex_12  |   tex_13  |   tex_14  |      row 2   \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_5   |   tex_6   |   tex_7   |   tex_8   |   tex_9   |      row 1    \n\t//      |           |           |           |           |           |     \n\t//      +-----------+-----------+-----------+-----------+-----------+\n\t//      |           |           |           |           |           |           \n\t//      |   tex_0   |   tex_1   |   tex_2   |   tex_3   |   tex_4   |      row 0     \n\t//      |           |           |           |           |           |  \n\t//      +-----------+-----------+-----------+-----------+-----------+   \n    //\n    //          col 0       col 1       col 2       col 3       col 4\nint getSliceIdx_ofTexture3D(int col, int row, int currMosaicSliceIdx)\n{\n    int subTexCount_inAMosaicSlice = u_mosaicSize[0] * u_mosaicSize[1]; // total textures count in a mosaic slice.***\n    int currentSlicesAmount = (row * u_mosaicSize[0]) + col; // the textures count under the texture[col, row] in a mosaic slice.***\n    int tex3DSliceIdx = subTexCount_inAMosaicSlice * currMosaicSliceIdx + currentSlicesAmount;\n\n    return tex3DSliceIdx;\n}\n\nvec2 getColRow_and_subTexCoord(in vec2 texCoord, inout vec2 subTexCoord)\n{\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    float sRange = 1.0 / float(u_mosaicSize[0]);\n    float tRange = 1.0 / float(u_mosaicSize[1]);\n\n    // Determine the [col, row] of the mosaic.***\n    vec2 resultColRow = vec2(floor(texCoord.x / sRange), floor(texCoord.y / tRange));\n\n    // determine the subTexCoord.***\n    float col_mod = texCoord.x - resultColRow.x * sRange;\n    float row_mod = texCoord.y - resultColRow.y * tRange;\n    float s = col_mod / sRange;\n    float t = row_mod / tRange;\n    subTexCoord = vec2(s, t);\n\n    return resultColRow;\n}\n\nvec2 getColRow_ofSliceIdx(in int sliceIdx, in int mosaicColsCount)\n{\n    // Given a sliceIdx, mosaicColumnsCount & mosaicRowsCount, this function returns the column & row of the sliceIdx.***\n    float row = floor(float(sliceIdx)/float(mosaicColsCount));\n    //float col = mod(float(sliceIdx), float(mosaicColsCount)); // mod = float(sliceIdx) - float(mosaicColsCount) * row;\n    float col = float(sliceIdx) - float(mosaicColsCount) * row;\n    vec2 colRow = vec2(col, row);\n    return colRow;\n}\n\n float getVoxelSpaceValue(in vec2 texCoord)\n{\n    // The scene voxelMatrix is into flux_RFU_MosaicTex_HIGH(here named currentSceneVoxelizedMosaicTex), in alpha channel.***\n    vec4 color4_RFU_HIGH = texture2D(currentSceneVoxelizedMosaicTex, texCoord);\n    return color4_RFU_HIGH.a;\n}\n\nvec2 subTexCoord_to_texCoord(in vec2 subTexCoord, in int col, in int row, in int mosaicNumCols, in int mosaicNumRows)\n{\n    // given col, row & subTexCoord, this function returns the texCoord into mosaic texture.***\n    // The "subTexCoord" is the texCoord of the subTexture[col, row].***\n    // u_mosaicSize =  The mosaic composition (xTexCount X yTexCount X zSlicesCount).***\n    float sRange = 1.0 / float(mosaicNumCols);\n    float tRange = 1.0 / float(mosaicNumRows);\n\n    float s = float(col) * sRange + subTexCoord.x * sRange;\n    float t = float(row) * tRange + subTexCoord.y * tRange;\n\n    vec2 resultTexCoord = vec2(s, t);\n    return resultTexCoord;\n}\n\nvoid main()\n{\n    // Note : this shader only can have one output. Is not possible MRT.***\n    //-------------------------------------------------------------------------\n\n    // 1rst, check if the current voxel is solid or not.\n    // If the current voxel is solid, then write "solid" and return. No need calculate anything.***\n    vec4 color4_RFU_HIGH = texture2D(currentSceneVoxelizedMosaicTex, v_tex_pos); \n    if(color4_RFU_HIGH.a > 0.0)\n    {\n        gl_FragData[0] = color4_RFU_HIGH;  \n        return;\n    }\n\n    // By tex-coord, must know the column & row of the mosaic texture.***\n    // Note : The rendering process uses a FBO with (u_mosaicTexSize[0] X u_mosaicTexSize[1]) as screen size.***\n    vec2 subTexCoord;\n    vec2 colRow = getColRow_and_subTexCoord(v_tex_pos, subTexCoord); // here returns the subTexCoords too.***\n    float col = colRow.x;\n    float row = colRow.y;\n    int col_int = int(col);\n    int row_int = int(row);\n\n    // Now, with "colRow" & "u_lowestMosaicSliceIndex" determine the sliceIdx of the real3dTexture.***\n    int sliceIdx = getSliceIdx_ofTexture3D(col_int, row_int, u_lowestMosaicSliceIndex);\n\n    // Now, with "subTexCoord" & "sliceIdx" calculate the textureIdx of "partialYDirectionMosaicTex" & the texCoords of it.***\n    // With subTexCoord.y we can determine the partialYDirectionMosaicTex_sliceIdx.***\n    int zDirSliceIdx = u_texSize[2] - sliceIdx; // the absolute zDirSliceIdx. Is coincident to the simulation mosaic sliceIdx.***\n\n    vec4 finalColor4 = vec4(color4_RFU_HIGH.r, color4_RFU_HIGH.g, color4_RFU_HIGH.b, color4_RFU_HIGH.a);\n\n    // Now, check if "xDirSliceIdx" is inside of the 8 YDirTextures availables.***\n    \n    if(zDirSliceIdx < u_lowestZDirMosaicSliceIndex || zDirSliceIdx > u_lowestZDirMosaicSliceIndex + 7)\n    {\n        gl_FragData[0] = color4_RFU_HIGH;    \n        return;\n    } \n\n    int currZDirSliceIdx = zDirSliceIdx - u_lowestZDirMosaicSliceIndex;\n\n\n    // Now determine the col & row of the yDirMosaicTexture.***\n    vec2 colRow_zDirMosaic = getColRow_ofSliceIdx(currZDirSliceIdx, u_zDirMosaicSize[0]);\n\n    // Now, calculate the subTexCoordXDir (texCoord in realTex3D).***\n    //vec2 subTexCoordZDir = vec2(1.0 - subTexCoord.y, float(sliceIdx)/float(u_zDirTextureSize[1]));\n    vec2 subTexCoordZDir = vec2(subTexCoord.x, subTexCoord.y);\n\n    // Now, calculate the texCoordXDirMosaic.***\n    int col_zDirMosaic = int(colRow_zDirMosaic.x);\n    int row_zDirMosaic = int(colRow_zDirMosaic.y);\n\n    vec2 texCoordZDirMosaic = subTexCoord_to_texCoord(subTexCoordZDir, col_zDirMosaic, row_zDirMosaic, u_zDirMosaicSize[0], u_zDirMosaicSize[1]);\n\n    // Now, read the value:\n    vec4 color4_zDirTex = texture2D(partialZDirectionMosaicTex, texCoordZDirMosaic); \n\n    if(finalColor4.a < color4_zDirTex.a)\n    {\n        finalColor4.a = color4_zDirTex.a;\n    }\n\n    gl_FragData[0] = finalColor4;  \n\n}',waterVoxelizeFS:"//#version 300 es\n\n#ifdef GL_ES\n    precision highp float;\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform sampler2D tex_0;\n\nuniform bool u_textureFlipYAxis;\nvarying vec2 v_tex_pos;\n\nvoid main()\n{\n    vec4 finalCol4;\n    if(u_textureFlipYAxis)\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, 1.0 - v_tex_pos.y));\n    }\n    else\n    {\n        finalCol4 = texture2D(texToCopy, vec2(v_tex_pos.x, v_tex_pos.y));\n    }\n    \n    gl_FragData[0] = finalCol4;  // anything.\n\n    #ifdef USE_MULTI_RENDER_TARGET\n        gl_FragData[1] = finalCol4; // depth\n        gl_FragData[2] = finalCol4; // normal\n        gl_FragData[3] = finalCol4; // albedo\n        gl_FragData[4] = finalCol4; // selection color\n    #endif\n\n}",wgs84_volumFS:"precision mediump float;\n\n#define M_PI 3.1415926535897932384626433832795\n\nuniform sampler2D volumeTex;\nuniform mat4 projectionMatrix;  \nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixInv;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\n\nuniform float screenWidth;    \nuniform float screenHeight;\nuniform float aspectRatio;\nuniform float far;\nuniform float fovyRad;\nuniform float tanHalfFovy;\n\n// volume tex definition.***\nuniform int texNumCols;\nuniform int texNumRows;\nuniform int texNumSlices;\nuniform int numSlicesPerStacks;\nuniform int slicesNumCols;\nuniform int slicesNumRows;\nuniform float maxLon;\nuniform float minLon;\nuniform float maxLat;\nuniform float minLat;\nuniform float maxAlt;\nuniform float minAlt;\nuniform vec4 cuttingPlanes[6];   \nuniform int cuttingPlanesCount;\n\nuniform float maxValue;\nuniform float minValue;\n\nvec3 getViewRay(vec2 tc)\n{\n\tfloat hfar = 2.0 * tanHalfFovy * far;\n    float wfar = hfar * aspectRatio;    \n    vec3 ray = vec3(wfar * (tc.x - 0.5), hfar * (tc.y - 0.5), -far);    \n    return ray;                      \n} \n\nfloat squaredLength(vec3 point1, vec3 point2)\n{\n\tfloat a = point1.x - point2.x;\n\tfloat b = point1.y - point2.y;\n\tfloat c = point1.z - point2.z;\n\t\n\tfloat sqDist = a*a + b*b + c*c;\n\treturn sqDist;\n}\n\nvoid intersectionLineSphere(float radius, vec3 rayPos, vec3 rayDir, out int intersectType, out vec3 nearIntersectPos, out vec3 farIntersectPos)\n{\n\t// line: (x, y, z) = x1 + t(x2 - x1), y1 + t(y2 - y1), z1 + t(z2 - z1)\n\t// sphere: (x - x3)^2 + (y - y3)^2 + (z - z3)^2 = r^2, where x3, y3, z3 is the center of the sphere.\n\t\n\t// line:\n\tvec3 p1 = rayPos;\n\tvec3 lineDir = rayDir;\n\tfloat dist = 1000.0;// any value is ok.***\n\tvec3 p2 = vec3(p1.x + lineDir.x * dist, p1.y + lineDir.y * dist, p1.z + lineDir.z * dist);\n\tfloat x1 = p1.x;\n\tfloat y1 = p1.y;\n\tfloat z1 = p1.z;\n\tfloat x2 = p2.x;\n\tfloat y2 = p2.y;\n\tfloat z2 = p2.z;\n\n\t// sphere:\n\tfloat x3 = 0.0;\n\tfloat y3 = 0.0;\n\tfloat z3 = 0.0;\n\tfloat r = radius;\n\t\n\t// resolve:\n\tfloat x21 = (x2-x1);\n\tfloat y21 = (y2-y1);\n\tfloat z21 = (z2-z1);\n\t\n\tfloat a = x21*x21 + y21*y21 + z21*z21;\n\t\n\tfloat x13 = (x1-x3);\n\tfloat y13 = (y1-y3);\n\tfloat z13 = (z1-z3);\n\t\n\tfloat b = 2.0*(x21 * x13 + y21 * y13 + z21 * z13);\n\t\n\tfloat c = x3*x3 + y3*y3 + z3*z3 + x1*x1 + y1*y1 + z1*z1 - 2.0*(x3*x1 + y3*y1+ z3*z1) - r*r;\n\t\n\tfloat discriminant = b*b - 4.0*a*c;\n\t\n\tif (discriminant < 0.0)\n\t{\n\t\t// no intersection.***\n\t\tintersectType = 0;\n\t}\n\telse if (discriminant == 0.0)\n\t{\n\t\t// this is tangent.***\n\t\tintersectType = 1;\n\t\t\n\t\tfloat t1 = (-b)/(2.0*a);\n\t\tnearIntersectPos = vec3(x1 + (x2 - x1)*t1, y1 + (y2 - y1)*t1, z1 + (z2 - z1)*t1);\n\t}\n\telse\n\t{\n\t\tintersectType = 2;\n\t\t\n\t\t// find the nearest to p1.***\n\t\tfloat sqrtDiscriminant = sqrt(discriminant);\n\t\tfloat t1 = (-b + sqrtDiscriminant)/(2.0*a);\n\t\tfloat t2 = (-b - sqrtDiscriminant)/(2.0*a);\n\t\t\n\t\t// solution 1.***\n\t\tvec3 intersectPoint1 = vec3(x1 + (x2 - x1)*t1, y1 + (y2 - y1)*t1, z1 + (z2 - z1)*t1);\n\t\tvec3 intersectPoint2 = vec3(x1 + (x2 - x1)*t2, y1 + (y2 - y1)*t2, z1 + (z2 - z1)*t2);\n\t\t\n\t\tfloat dist1 = squaredLength(p1,intersectPoint1);\n\t\tfloat dist2 = squaredLength(p1,intersectPoint2);\n\t\t\n\t\t// nearIntersectPos, out vec3 farIntersectPos\n\t\tif (dist1 < dist2)\n\t\t{\n\t\t\tnearIntersectPos = intersectPoint1;\n\t\t\tfarIntersectPos = intersectPoint2;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tnearIntersectPos = intersectPoint2;\n\t\t\tfarIntersectPos = intersectPoint1;\n\t\t}\n\t}\n}\n\nfloat atan2(float y, float x) \n{\n\tif(x > 0.0)\n\t{\n\t\treturn atan(y/x);\n\t}\n\telse if(x < 0.0)\n\t{\n\t\tif(y >= 0.0)\n\t\t{\n\t\t\treturn atan(y/x) + M_PI;\n\t\t}\n\t\telse{\n\t\t\treturn atan(y/x) - M_PI;\n\t\t}\n\t}\n\telse if(x == 0.0)\n\t{\n\t\tif(y>0.0)\n\t\t{\n\t\t\treturn M_PI/2.0;\n\t\t}\n\t\telse if(y<0.0)\n\t\t{\n\t\t\treturn -M_PI/2.0;\n\t\t}\n\t\telse{\n\t\t\treturn 0.0; // return undefined.***\n\t\t}\n\t}\n}\n\nvoid cartesianToGeographicWgs84(vec3 point, out vec3 result) \n{\n\t// From WebWorldWind.***\n\t// According to H. Vermeille, An analytical method to transform geocentric into geodetic coordinates\n\t// http://www.springerlink.com/content/3t6837t27t351227/fulltext.pdf\n\t\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat equatorialRadius = 6378137.0;\n\n\t// wwwind coord type.***\n\t// X = point.z;\n\t// Y = point.x;\n\t// Z = point.y;\n\n\t// magoWorld coord type.***\n\tfloat X = point.x;\n\tfloat Y = point.y;\n\tfloat Z = point.z;\n\tfloat XXpYY = X * X + Y * Y;\n\tfloat sqrtXXpYY = sqrt(XXpYY);\n\tfloat a = equatorialRadius;\n\tfloat ra2 = 1.0 / (a * a);\n\tfloat e2 = firstEccentricitySquared;\n\tfloat e4 = e2 * e2;\n\tfloat p = XXpYY * ra2;\n\tfloat q = Z * Z * (1.0 - e2) * ra2;\n\tfloat r = (p + q - e4) / 6.0;\n\tfloat h;\n\tfloat phi;\n\tfloat u;\n\tfloat evoluteBorderTest = 8.0 * r * r * r + e4 * p * q;\n\tfloat rad1;\n\tfloat rad2;\n\tfloat rad3;\n\tfloat atanAux;\n\tfloat v;\n\tfloat w;\n\tfloat k;\n\tfloat D;\n\tfloat sqrtDDpZZ;\n\tfloat e;\n\tfloat lambda;\n\tfloat s2;\n\tfloat cbrtFac = 1.0/3.0;\n\n\tif (evoluteBorderTest > 0.0 || q != 0.0) \n\t{\n\t\tif (evoluteBorderTest > 0.0) \n\t\t{\n\t\t\t// Step 2: general case\n\t\t\trad1 = sqrt(evoluteBorderTest);\n\t\t\trad2 = sqrt(e4 * p * q);\n\n\t\t\t// 10*e2 is my arbitrary decision of what Vermeille means by near... the cusps of the evolute.\n\t\t\tif (evoluteBorderTest > 10.0 * e2) \n\t\t\t{\n\t\t\t\trad3 = pow((rad1 + rad2) * (rad1 + rad2), cbrtFac);\n\t\t\t\tu = r + 0.5 * rad3 + 2.0 * r * r / rad3;\n\t\t\t}\n\t\t\telse \n\t\t\t{\n\t\t\t\tu = r + 0.5 * pow((rad1 + rad2) * (rad1 + rad2), cbrtFac)\n\t\t\t\t\t+ 0.5 * pow((rad1 - rad2) * (rad1 - rad2), cbrtFac);\n\t\t\t}\n\t\t}\n\t\telse \n\t\t{\n\t\t\t// Step 3: near evolute\n\t\t\trad1 = sqrt(-evoluteBorderTest);\n\t\t\trad2 = sqrt(-8.0 * r * r * r);\n\t\t\trad3 = sqrt(e4 * p * q);\n\t\t\tatanAux = 2.0 * atan2(rad3, rad1 + rad2) / 3.0;\n\n\t\t\tu = -4.0 * r * sin(atanAux) * cos(M_PI / 6.0 + atanAux);\n\t\t}\n\n\t\tv = sqrt(u * u + e4 * q);\n\t\tw = e2 * (u + v - q) / (2.0 * v);\n\t\tk = (u + v) / (sqrt(w * w + u + v) + w);\n\t\tD = k * sqrtXXpYY / (k + e2);\n\t\tsqrtDDpZZ = sqrt(D * D + Z * Z);\n\n\t\th = (k + e2 - 1.0) * sqrtDDpZZ / k;\n\t\tphi = 2.0 * atan2(Z, sqrtDDpZZ + D);\n\t}\n\telse \n\t{\n\t\t// Step 4: singular disk\n\t\trad1 = sqrt(1.0 - e2);\n\t\trad2 = sqrt(e2 - p);\n\t\te = sqrt(e2);\n\n\t\th = -a * rad1 * rad2 / e;\n\t\tphi = rad2 / (e * rad2 + rad1 * sqrt(p));\n\t}\n\n\t// Compute lambda\n\ts2 = sqrt(2.0);\n\tif ((s2 - 1.0) * Y < sqrtXXpYY + X) \n\t{\n\t\t// case 1 - -135deg < lambda < 135deg\n\t\tlambda = 2.0 * atan2(Y, sqrtXXpYY + X);\n\t}\n\telse if (sqrtXXpYY + Y < (s2 + 1.0) * X) \n\t{\n\t\t// case 2 - -225deg < lambda < 45deg\n\t\tlambda = -M_PI * 0.5 + 2.0 * atan2(X, sqrtXXpYY - Y);\n\t}\n\telse \n\t{\n\t\t// if (sqrtXXpYY-Y<(s2=1)*X) {  // is the test, if needed, but it's not\n\t\t// case 3: - -45deg < lambda < 225deg\n\t\tlambda = M_PI * 0.5 - 2.0 * atan2(X, sqrtXXpYY + Y);\n\t}\n\n\tfloat factor = 180.0 / M_PI;\n\tresult = vec3(factor * lambda, factor * phi, h); // (longitude, latitude, altitude).***\n}\n\nbool isPointRearCamera(vec3 point, vec3 camPos, vec3 camDir)\n{\n\tbool isRear = false;\n\tfloat lambdaX = 10.0;\n\tfloat lambdaY = 10.0;\n\tfloat lambdaZ = 10.0;\n\tif(abs(camDir.x) > 0.0000001)\n\t{\n\t\tfloat lambdaX = (point.x - camPos.x)/camDir.x;\n\t}\n\telse if(abs(camDir.y) > 0.0000001)\n\t{\n\t\tfloat lambdaY = (point.y - camPos.y)/camDir.y;\n\t}\n\telse if(abs(camDir.z) > 0.0000001)\n\t{\n\t\tfloat lambdaZ = (point.z - camPos.z)/camDir.z;\n\t}\n\t\n\tif(lambdaZ < 0.0 || lambdaY < 0.0 || lambdaX < 0.0)\n\t\t\tisRear = true;\n\t\telse\n\t\t\tisRear = false;\n\treturn isRear;\n}\n\nfloat distPointToPlane(vec3 point, vec4 plane)\n{\n\treturn (point.x*plane.x + point.y*plane.y + point.z*plane.z + plane.w);\n}\n\nbool getValue(vec3 geoLoc, out vec4 value)\n{\n\t// geoLoc = (longitude, latitude, altitude).***\n\tfloat lon = geoLoc.x;\n\tfloat lat = geoLoc.y;\n\tfloat alt = geoLoc.z;\n\t\n\t// 1rst, check if geoLoc intersects the volume.***\n\t// Note: minLon, maxLon, minLat, maxLat, minAlt & maxAlt are uniforms.***\n\tif(lon < minLon || lon > maxLon)\n\t\treturn false;\n\telse if(lat < minLat || lat > maxLat)\n\t\treturn false;\n\telse if(alt < minAlt || alt > maxAlt)\n\t\treturn false;\n\t\t\n\tfloat lonRange = maxLon - minLon;\n\tfloat latRange = maxLat - minLat;\n\tfloat altRange = maxAlt - minAlt;\n\tfloat col = (lon - minLon)/lonRange * float(slicesNumCols); \n\tfloat row = (lat - minLat)/latRange * float(slicesNumRows); \n\tfloat slice = (alt - minAlt)/altRange * float(texNumSlices); // slice if texture has only one stack.***\n\tfloat sliceDown = floor(slice);\n\tfloat sliceUp = ceil(slice);\n\tfloat sliceDownDist = slice - sliceDown;\n\t//slice = 18.0; // test. force slice to nearest to ground.***\n\t\n\tfloat stackDown = floor(sliceDown/float(numSlicesPerStacks));\n\tfloat realSliceDown = sliceDown - stackDown * float(numSlicesPerStacks);\n\tfloat tx = stackDown * float(slicesNumCols) + col;\n\tfloat ty = realSliceDown * float(slicesNumRows) + row;\n\tvec2 texCoord = vec2(tx/float(texNumCols), ty/float(texNumRows));\n\tvec4 valueDown = texture2D(volumeTex, texCoord);\n\t\n\tif(sliceDown < float(texNumSlices-1))\n\t{\n\t\tfloat stackUp = floor(sliceUp/float(numSlicesPerStacks));\n\t\tfloat realSliceUp = sliceUp - stackUp * float(numSlicesPerStacks);\n\t\tfloat tx2 = stackUp * float(slicesNumCols) + col;\n\t\tfloat ty2 = realSliceUp * float(slicesNumRows) + row;\n\t\tvec2 texCoord2 = vec2(tx2/float(texNumCols), ty2/float(texNumRows));\n\t\tvec4 valueUp = texture2D(volumeTex, texCoord2);\n\t\tvalue = valueDown*(1.0-sliceDownDist)+valueUp*(sliceDownDist);\n\t}\n\telse{\n\t\tvalue = valueDown;\n\t}\n\t//if((value.r * (maxValue - minValue)) > maxValue * 0.3)\n\t//\treturn true;\n\t//else return false;\n\treturn true;\n}\n\nvoid main() {\n\tvec2 screenPos = vec2(gl_FragCoord.x / screenWidth, gl_FragCoord.y / screenHeight);\n\tfloat linearDepth = 1.0; // the quad is 1m of dist of the camera.***          \n    vec3 rayCamCoord = getViewRay(screenPos) * linearDepth;  \n\trayCamCoord = normalize(rayCamCoord);\n\t\n\tvec3 camTarget = rayCamCoord * 10000.0;\n\tvec4 camPosWorld = vec4(encodedCameraPositionMCHigh + encodedCameraPositionMCLow, 1.0);\n\tvec4 camTargetWorld = modelViewMatrixInv * vec4(camTarget.xyz, 1.0);\n\tvec3 camDirWorld = camTargetWorld.xyz - camPosWorld.xyz;\n\tcamDirWorld = normalize(camDirWorld);\n\n\t// now, must find sampling points.***\n\tint intersectType = 0;\n\tvec3 nearP;\n\tvec3 farP;\n\tfloat radius = 6378137.0 + maxAlt; // equatorial radius.***\n\t//radius = 6250000.0 + maxAlt; // test radius.***\n\t\n\tintersectionLineSphere(radius, camPosWorld.xyz, camDirWorld, intersectType, nearP, farP);\n\t\n\tif(intersectType == 0)\n\t{\n\t\tdiscard;\n\t}\n\t\t\n\tif(intersectType == 1)\n\t{\n\t\t// provisionally discard.***\n\t\tdiscard;\t\n\t}\n\t\n\t// check if nearP is rear of the camera.***\n\tif(isPointRearCamera(nearP, camPosWorld.xyz, camDirWorld.xyz))\n\t{\n\t\tnearP = vec3(camPosWorld.xyz);\n\t}\n\tfloat dist = distance(nearP, farP);\n\tfloat testDist = dist;\n\tif(dist > 1500000.0)\n\t\ttestDist = 1500000.0;\n\t\n\t// now calculate the geographicCoords of 2 points.***\n\t// now, depending the dist(nearP, endPoint), determine numSmples.***\n\t// provisionally take 16 samples.***\n\tfloat numSamples = 512.0;\n\tvec4 color = vec4(0.0, 0.0, 0.0, 0.0);\n\tfloat alpha = 0.8/numSamples;\n\tfloat tempRange = maxValue - minValue;\n\tvec4 value;\n\tfloat totalValue = 0.0;\n\tint sampledsCount = 0;\n\tint intAux = 0;\n\tfloat increDist = testDist / numSamples;\n\tint c = 0;\n\tbool isPointRearPlane = true;\n\tfor(int i=0; i<512; i++)\n\t{\n\t\tvec3 currGeoLoc;\n\t\tvec3 currPosWorld = vec3(nearP.x + camDirWorld.x * increDist*float(c), nearP.y + camDirWorld.y * increDist*float(c), nearP.z + camDirWorld.z * increDist*float(c));\n\t\t// Check if the currPosWorld is in front or rear of planes (if exist planes).***\n\t\tint planesCounter = 0;\n\t\tfor(int j=0; j<6; j++)\n\t\t{\n\t\t\tif(planesCounter == cuttingPlanesCount)\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tvec4 plane = cuttingPlanes[j];\n\t\t\tfloat dist = distPointToPlane(currPosWorld, plane);\n\t\t\tif(dist > 0.0)\n\t\t\t{\n\t\t\t\tisPointRearPlane = false;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\telse{\n\t\t\t\tisPointRearPlane = true;\n\t\t\t}\n\t\t\tplanesCounter++;\n\t\t}\n\t\t\n\t\t\n\t\tif(isPointRearPlane)\n\t\t{\n\t\t\tcartesianToGeographicWgs84(currPosWorld, currGeoLoc);\n\t\t\tif(getValue(currGeoLoc, value))\n\t\t\t{\n\t\t\t\tfloat realValue = value.r * tempRange + minValue*255.0;\n\t\t\t\ttotalValue += (value.r);\n\t\t\t\tsampledsCount += 1;\n\t\t\t}\n\t\t}\n\t\tif(sampledsCount >= 1)\n\t\t{\n\t\t\tbreak;\n\t\t}\n\t\tc++;\n\t}\n\tif(sampledsCount == 0)\n\t{\n\t\tdiscard;\n\t}\n\tfloat fValue = totalValue/numSamples;\n\tfValue = totalValue;\n\tif(fValue > 1.0)\n\t{\n\t\tgl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n\t\treturn;\n\t}\n\tfloat b = 1.0 - fValue;\n\tfloat g;\n\tif(fValue > 0.5)\n\t{\n\t\tg = 2.0-2.0*fValue;\n\t}\n\telse{\n\t\tg = 2.0*fValue;\n\t}\n\tfloat r = fValue;\n\tcolor += vec4(r,g,b,0.8);\n\tgl_FragColor = color;\n}",wgs84_volumVS:"precision mediump float;\n\nattribute vec3 position;\nuniform mat4 projectionMatrix;\n\nvoid main()\n{\t\n\tvec4 pos = projectionMatrix * vec4(position.xyz, 1.0);\n    gl_Position = pos;\n}",windStreamThickLineFS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\nuniform int uElemIndex;\nuniform int uTotalPointsCount; // total points to draw.\nuniform vec2 viewport;\nuniform float thickness;\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vCurrentIndex;\n\nvarying float vSense;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main() {\n\t// calculate the transparency.\n\tfloat alpha = 1.0 - (vCurrentIndex - float(uElemIndex))/float(uTotalPointsCount);\n\n\t// use vSense to calculate aditional transparency in the borders of the thick line.***\n\tfloat beta = sin(acos(vSense));\n\talpha *= beta;\n\n\tvec4 finalColor =  vec4(vColor.rgb, alpha);\n\n\tgl_FragData[0] = finalColor;\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\tgl_FragData[1] = packDepth(vDepth);\n\t\t\n\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = finalColor;\n\t\t\n\t}\n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",windStreamThickLineRAD_FS:"precision highp float;\n\n#define %USE_LOGARITHMIC_DEPTH%\n#ifdef USE_LOGARITHMIC_DEPTH\n#extension GL_EXT_frag_depth : enable\n#endif\n\n#define %USE_MULTI_RENDER_TARGET%\n#ifdef USE_MULTI_RENDER_TARGET\n#extension GL_EXT_draw_buffers : require\n#endif\n\nuniform bool bUseLogarithmicDepth;\nuniform bool bUseMultiRenderTarget;\nuniform int uFrustumIdx;\nuniform int uElemIndex;\nuniform int uTotalPointsCount; // total points to draw.\nuniform vec2 viewport;\nuniform float thickness;\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vCurrentIndex;\n\nvarying float vSense;\n\nvec3 encodeNormal(in vec3 normal)\n{\n\treturn normal*0.5 + 0.5;\n}\n\nvec3 decodeNormal(in vec3 normal)\n{\n\treturn normal * 2.0 - 1.0;\n}\n\nvec4 packDepth( float v ) {\n  vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * v;\n  enc = fract(enc);\n  enc -= enc.yzww * vec4(1.0/255.0, 1.0/255.0, 1.0/255.0, 0.0);\n  return enc;\n}\n\nvoid main() {\n\t// calculate the transparency.\n\tfloat alpha = 1.0 - (vCurrentIndex - float(uElemIndex))/float(uTotalPointsCount);\n\n\t// use vSense to calculate aditional transparency in the borders of the thick line.***\n\tfloat beta = sin(acos(vSense));\n\talpha *= beta;\n\n\tvec4 finalColor =  vec4(vColor.rgb, alpha);\n\n\tgl_FragData[0] = finalColor; // original.***\n\n\t#ifdef USE_MULTI_RENDER_TARGET\n\tif(bUseMultiRenderTarget)\n\t{\n\t\tgl_FragData[1] = packDepth(vDepth);\n\t\t\n\n\t\t// Note: points cloud data has frustumIdx 20 .. 23.********\n\t\tfloat frustumIdx = 0.1; // realFrustumIdx = 0.1 * 100 = 10. \n\t\t\n\t\tif(uFrustumIdx == 0)\n\t\tfrustumIdx = 0.005; // frustumIdx = 20.***\n\t\telse if(uFrustumIdx == 1)\n\t\tfrustumIdx = 0.015; // frustumIdx = 21.***\n\t\telse if(uFrustumIdx == 2)\n\t\tfrustumIdx = 0.025; // frustumIdx = 22.***\n\t\telse if(uFrustumIdx == 3)\n\t\tfrustumIdx = 0.035; // frustumIdx = 23.***\n\n\t\tvec3 normal = encodeNormal(vec3(0.0, 0.0, 1.0));\n\t\tgl_FragData[2] = vec4(normal, frustumIdx); // save normal.***\n\n\t\t// now, albedo.\n\t\tgl_FragData[3] = finalColor;\n\t\t\n\t}\n\t#endif\n\n\t#ifdef USE_LOGARITHMIC_DEPTH\n\tif(bUseLogarithmicDepth)\n\t{\n\t\tgl_FragDepthEXT = log2(flogz) * Fcoef_half;\n\t}\n\t#endif\n}",windStreamThickLineRAD_VS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\nattribute float index;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vCurrentIndex;\n\nvarying float vSense;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec3 geographicToCartesianWgs84(float lonRad, float latRad, float altitude)\n{\n\t// a = semi-major axis.\n\t// e2 = firstEccentricitySquared.\n\t// v = a / sqrt(1 - e2 * sin2(lat)).\n\t// x = (v+h)*cos(lat)*cos(lon).\n\t// y = (v+h)*cos(lat)*sin(lon).\n\t// z = [v*(1-e2)+h]*sin(lat).\n\tfloat equatorialRadius = 6378137.0;\n\tfloat firstEccentricitySquared = 6.69437999014E-3;\n\tfloat cosLon = cos(lonRad);\n\tfloat cosLat = cos(latRad);\n\tfloat sinLon = sin(lonRad);\n\tfloat sinLat = sin(latRad);\n\tfloat a = equatorialRadius;\n\tfloat e2 = firstEccentricitySquared;\n\tfloat v = a/sqrt(1.0 - e2 * sinLat * sinLat);\n\t//float h = altitude; // original.***\n\tfloat h = 2000.0;\n\t\n\tvec3 resultCartesian = vec3((v+h)*cosLat*cosLon, (v+h)*cosLat*sinLon, (v*(1.0-e2)+h)*sinLat);\n\t\n\treturn resultCartesian;\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec3 posWC = geographicToCartesianWgs84(point.x, point.y, point.z);\n\tvec4 rotatedCurrent = vec4(posWC.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = rotatedCurrent.xyz -encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = vec3(0.0) - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\t//float order_w = float(order);\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * vCurrent;\n\tvDepth = -orthoPos.z/far;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1)\n\t{\n\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x);\n\t}\n\telse{\n\t\tnormal = vec2(-tangentNext.y, tangentNext.x);\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat realThickness = (thickness*sense*projectedDepth)/1000.0;\n\t\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * realThickness, 0.0, 0.0);\n\tgl_Position = currentProjected + offset; \n\tvSense = sense;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n\n\tvCurrentIndex = index;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n",windStreamThickLineVS:"\nattribute vec4 prev;\nattribute vec4 current;\nattribute vec4 next;\nattribute vec4 color4;\nattribute float index;\n\nuniform float thickness;\nuniform mat4 buildingRotMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewMatrixRelToEye; \nuniform mat4 ModelViewProjectionMatrixRelToEye;\nuniform vec2 viewport;\nuniform vec3 buildingPosHIGH;\nuniform vec3 buildingPosLOW;\nuniform vec3 encodedCameraPositionMCHigh;\nuniform vec3 encodedCameraPositionMCLow;\nuniform vec4 oneColor4;\nuniform highp int colorType; // 0= oneColor, 1= attribColor, 2= texture.\nuniform float near;\nuniform float far;\nuniform bool bUseLogarithmicDepth;\nuniform float uFCoef_logDepth;\n\nvarying vec4 vColor;\nvarying float flogz;\nvarying float Fcoef_half;\nvarying float vDepth;\nvarying float vCurrentIndex;\n\nvarying float vSense;\n\nconst float error = 0.001;\n\n// see https://weekly-geekly.github.io/articles/331164/index.html\n// see too https://github.com/ridiculousfish/wavefiz/blob/master/ts/polyline.ts#L306\n\nvec2 project(vec4 p){\n\treturn (0.5 * p.xyz / p.w + 0.5).xy * viewport;\n}\n\nbool isEqual(float value, float valueToCompare)\n{\n\tif(value + error > valueToCompare && value - error < valueToCompare)\n\treturn true;\n\t\n\treturn false;\n}\n\nvec4 getPointRelToEye(in vec4 point)\n{\n\tvec4 rotatedCurrent = buildingRotMatrix * vec4(point.xyz, 1.0);\n\tvec3 objPosHigh = buildingPosHIGH;\n\tvec3 objPosLow = buildingPosLOW.xyz + rotatedCurrent.xyz;\n\tvec3 highDifference = objPosHigh.xyz - encodedCameraPositionMCHigh.xyz;\n\tvec3 lowDifference = objPosLow.xyz - encodedCameraPositionMCLow.xyz;\n\treturn vec4(highDifference.xyz + lowDifference.xyz, 1.0);\n}\n\nvoid main(){\n\t// current, prev & next.***\n\tvec4 vCurrent = getPointRelToEye(vec4(current.xyz, 1.0));\n\tvec4 vPrev = getPointRelToEye(vec4(prev.xyz, 1.0));\n\tvec4 vNext = getPointRelToEye(vec4(next.xyz, 1.0));\n\t\n\tfloat order_w = current.w;\n\t//float order_w = float(order);\n\tfloat sense = 1.0;\n\tint orderInt = 0;\n\tif(order_w > 0.0)\n\t{\n\t\tsense = -1.0;\n\t\tif(order_w < 1.5)\n\t\t{\n\t\t\torderInt = 1;\n\t\t}\n\t\telse{\n\t\t\torderInt = 2;\n\t\t}\n\t}\n\telse\n\t{\n\t\tsense = 1.0;\n\t\tif(order_w > -1.5)\n\t\t{\n\t\t\torderInt = -1;\n\t\t}\n\t\telse{\n\t\t\torderInt = -2;\n\t\t}\n\t}\n\t\n\tfloat aspect = viewport.x / viewport.y;\n\tvec2 aspectVec = vec2(aspect, 1.0);\n\t\n\tvec4 previousProjected = ModelViewProjectionMatrixRelToEye * vPrev;\n\tvec4 currentProjected = ModelViewProjectionMatrixRelToEye * vCurrent;\n\tvec4 nextProjected = ModelViewProjectionMatrixRelToEye * vNext;\n\n\tvec4 orthoPos = modelViewMatrixRelToEye * vCurrent;\n\tvDepth = -orthoPos.z/far;\n\t\n\tfloat projectedDepth = currentProjected.w;                \n\t// Get 2D screen space with W divide and aspect correction\n\tvec2 currentScreen = currentProjected.xy / currentProjected.w * aspectVec;\n\tvec2 previousScreen = previousProjected.xy / previousProjected.w * aspectVec;\n\tvec2 nextScreen = nextProjected.xy / nextProjected.w * aspectVec;\n\t\t\t\t\t\n\t// This helps us handle 90 degree turns correctly\n\tvec2 tangentNext = normalize(nextScreen - currentScreen);\n\tvec2 tangentPrev = normalize(currentScreen - previousScreen);\n\tvec2 normal; \n\tif(orderInt == 1 || orderInt == -1)\n\t{\n\t\tnormal = vec2(-tangentPrev.y, tangentPrev.x);\n\t}\n\telse{\n\t\tnormal = vec2(-tangentNext.y, tangentNext.x);\n\t}\n\tnormal *= thickness/2.0;\n\tnormal.x /= aspect;\n\tfloat realThickness = (thickness*sense*projectedDepth)/1000.0;\n\t\n\t// Offset our position along the normal\n\tvec4 offset = vec4(normal * realThickness, 0.0, 0.0);\n\tgl_Position = currentProjected + offset; \n\tvSense = sense;\n\n\tif(bUseLogarithmicDepth)\n\t{\n\t\t// logarithmic zBuffer:\n\t\t// https://outerra.blogspot.com/2013/07/logarithmic-depth-buffer-optimizations.html\n\t\tfloat Fcoef = 2.0 / log2(far + 1.0);\n\t\tgl_Position.z = log2(max(1e-6, 1.0 + gl_Position.w)) * Fcoef - 1.0;\n\n\t\tflogz = 1.0 + gl_Position.w;\n\t\tFcoef_half = 0.5 * Fcoef;\n\t}\n\t\n\tif(colorType == 0)\n\t\tvColor = oneColor4;\n\telse if(colorType == 1)\n\t\tvColor = color4; //vec4(color4.r+0.8, color4.g+0.8, color4.b+0.8, color4.a+0.8);\n\telse\n\t\tvColor = oneColor4;\n\n\tvCurrentIndex = index;\n}\n\n\n\n\n\n\n\n\n\n\n\n\n"},No=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl=t,this.name=r,this.uniformLocation,this.floatValue};No.prototype.bindUniform=function(){this.gl.uniform1f(this.uniformLocation,this.floatValue[0])};var Uo=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl=t,this.name=r,this.uniformLocation,this.intValue};Uo.prototype.bindUniform=function(){this.gl.uniform1i(this.uniformLocation,this.intValue)};var Go=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl=t,this.name=r,this.uniformLocation,this.matrix4fv};Go.prototype.bindUniform=function(){this.gl.uniformMatrix4fv(this.uniformLocation,!1,this.matrix4fv)};var zo=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl=t,this.name=r,this.uniformLocation,this.vec2fv};zo.prototype.bindUniform=function(){this.gl.uniform2fv(this.uniformLocation,this.vec2fv)};var Ho=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl=t,this.name=r,this.uniformLocation,this.vec3fv};Ho.prototype.bindUniform=function(){this.gl.uniform3fv(this.uniformLocation,this.vec3fv)};var Vo=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.gl=t,this.name=r,this.uniformLocation,this.vec4fv};Vo.prototype.bindUniform=function(){this.gl.uniform4fv(this.uniformLocation,this.vec4fv)};var ko=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.nodeOwner,t&&(this.nodeOwner=t),this.id,this.nodesArray,this.edgesArray,this.spacesArray,this.attributes,this.edgesVboKeysContainer,this.nodesVboKeysContainer,this.renderSpaces=!0,this.spacesAlpha=.2};ko.prototype.newNode=function(){void 0===this.nodesArray&&(this.nodesArray=[]);var e=new Wo(this);return this.nodesArray.push(e),e},ko.prototype.newEdge=function(){void 0===this.edgesArray&&(this.edgesArray=[]);var e=new jo(this);return this.edgesArray.push(e),e},ko.prototype.newSpace=function(){void 0===this.spacesArray&&(this.spacesArray=[]);var e=new Xo(this);return this.spacesArray.push(e),e},ko.prototype.test__makeVbos=function(e){var t=0;this.edgesArray&&(t=this.edgesArray.length);for(var r=[],i=0;i<t;i++){var o=this.edgesArray[i].vtxSegment,n=o.startVertex.point3d,a=o.endVertex.point3d;r.push(n.x),r.push(n.y),r.push(n.z),r.push(a.x),r.push(a.y),r.push(a.z)}void 0===this.edgesVboKeysContainer&&(this.edgesVboKeysContainer=new xt);var s=this.edgesVboKeysContainer.newVBOVertexIdxCacheKey(),l=3*(2*t),u=e.vboMemoryManager.getClassifiedBufferSize(l);s.posVboDataArray=new Float32Array(u),s.posVboDataArray.set(r),s.posArrayByteSize=r.length,s.segmentsCount=t},ko.prototype.parseTopologyData=function(e,t){var r=new G;r.minX=t.min_X,r.minY=t.min_Y,r.minZ=t.min_Z,r.maxX=t.max_X,r.maxY=t.max_Y,r.maxZ=t.max_Z;var i=new Jr;i.set(-115.0978055,31.885502,-28.5);for(var o={},n=t.nodes.length,a=0;a<n;a++){var s=t.nodes[a],l=this.newNode();l.id="#"+s.id,l.position=new Jr(s.coordinates[0],s.coordinates[1],s.coordinates[2]),l.position.addPoint(i),l.position.add(0,0,.1),l.box=new qi(.6,.6,.6),o[l.id]=l}var u={},c=t.cellSpaceMembers.length;for(a=0;a<c;a++){var d=t.cellSpaceMembers[a],h=(d.href,this.newSpace()),f=new kr;h.mesh=f;for(var g=f.getVertexList(),p=d.surfaceMember.length,m=0;m<p;m++){for(var v=f.newSurface().newFace(),x=d.surfaceMember[m].coordinates,_=x.length/3,y=0;y<_;y++){var T=x[3*y],C=x[3*y+1],b=x[3*y+2],M=g.newVertex();M.setPosition(T,C,b),M.point3d.addPoint(i),v.addVertex(M)}v.solveUroborus(),v.calculateVerticesNormals()}u[d.href]=d}var A=t.edges.length;for(a=0;a<A;a++){var E=t.edges[a],L=this.newEdge(),w=E.stateMembers[0].coordinates,S=E.stateMembers[1].coordinates,D=new wi,R=new wi;D.setPosition(w[0],w[1],w[2]),R.setPosition(S[0],S[1],S[2]),D.point3d.addPoint(i),D.point3d.add(0,0,.1),R.point3d.addPoint(i),R.point3d.add(0,0,.1);var P=new Ni(D,R);L.vtxSegment=P;var I=E.connects[0],F=E.connects[1];L.strNodeId=I,L.endNodeId=F}this.test__makeVbos(e)},ko.prototype.renderColorCoding=function(e,t,r){var i=e.selectionColor,o=(n=e.selectionManager).getSelectionCandidatesFamily("networkNodes");void 0===o&&(o=n.newCandidatesFamily("networkNodes"));var n,a=(n=e.selectionManager).getSelectionCandidatesFamily("networkEdges");void 0===a&&(a=n.newCandidatesFamily("networkEdges"));var s=e.vboMemoryManager,l=e.sceneState.gl;t.disableVertexAttribArray(t.texCoord2_loc),t.enableVertexAttribArray(t.normal3_loc),l.uniform1i(t.hasTexture_loc,!1),l.uniform4fv(t.oneColor4_loc,[.8,.8,.8,1]),t.last_isAditionalMovedZero||(l.uniform1i(t.hasAditionalMov_loc,!1),l.uniform3fv(t.aditionalMov_loc,[0,0,0]),t.last_isAditionalMovedZero=!0);var u,c=0;if(this.nodesArray&&(c=this.nodesArray.length),c>0){var d=1;l.uniform1i(t.refMatrixType_loc,d);for(var h=this.nodesArray[0],f=0;f<c;f++){var g=this.nodesArray[f];l.uniform3fv(t.refTranslationVec_loc,[g.position.x,g.position.y,g.position.z]);var p=i.getAvailableColor(void 0),m=i.decodeColor3(p.r,p.g,p.b);n.setCandidateCustom(m,"networkNodes",g),l.uniform4fv(t.oneColor4_loc,[p.r/255,p.g/255,p.b/255,1]),h.box.render(e,t,r)}}if(this.edgesVboKeysContainer&&(u=this.edgesVboKeysContainer.vboCacheKeysArray[0]).isReadyPositions(l,s)){t.disableVertexAttribArray(t.texCoord2_loc),t.disableVertexAttribArray(t.normal3_loc),d=0,l.uniform1i(t.refMatrixType_loc,d),u.meshVertexCacheKey!==t.lastVboKeyBindedMap[t.position3_loc]&&(l.bindBuffer(l.ARRAY_BUFFER,u.meshVertexCacheKey),l.vertexAttribPointer(t.position3_loc,3,l.FLOAT,!1,0,0),t.lastVboKeyBindedMap[t.position3_loc]=u.meshVertexCacheKey);var v=this.edgesArray.length;for(f=0;f<v;f++){var x=this.edgesArray[f];p=i.getAvailableColor(void 0),m=i.decodeColor3(p.r,p.g,p.b);n.setCandidateCustom(m,"networkEdges",x),l.uniform4fv(t.oneColor4_loc,[p.r/255,p.g/255,p.b/255,1]),l.drawArrays(l.LINES,2*f,2)}}},ko.prototype.render=function(e,t,r){e.selectionColor.init();var i=(o=e.selectionManager).getSelectionCandidatesFamily("networkNodes");void 0===i&&(i=o.newCandidatesFamily("networkNodes"));var o,n=(o=e.selectionManager).getSelectionCandidatesFamily("networkEdges");void 0===n&&(n=o.newCandidatesFamily("networkEdges"));var a=e.vboMemoryManager,s=e.sceneState.gl;t.disableVertexAttribArray(t.texCoord2_loc),t.enableVertexAttribArray(t.normal3_loc),s.uniform1i(t.colorType_loc,0),s.uniform4fv(t.oneColor4_loc,[.8,.8,.8,1]),t.last_isAditionalMovedZero||(s.uniform1i(t.hasAditionalMov_loc,!1),s.uniform3fv(t.aditionalMov_loc,[0,0,0]),t.last_isAditionalMovedZero=!0);var l,u=0;if(this.nodesArray&&(u=this.nodesArray.length),u>0){s.uniform1i(t.colorType_loc,0);var c=1;s.uniform1i(t.refMatrixType_loc,c),s.uniform4fv(t.oneColor4_loc,[.3,.3,.9,1]);for(var d=this.nodesArray[0],h=0;h<u;h++){var f=this.nodesArray[h];f===i.currentSelected&&s.uniform4fv(t.oneColor4_loc,[.9,.5,.1,1]),s.uniform3fv(t.refTranslationVec_loc,[f.position.x,f.position.y,f.position.z]),d.box.render(e,t,r),f===i.currentSelected&&s.uniform4fv(t.oneColor4_loc,[.3,.3,.9,1])}}if(this.edgesVboKeysContainer&&(l=this.edgesVboKeysContainer.vboCacheKeysArray[0]).isReadyPositions(s,a)){t.disableVertexAttribArray(t.texCoord2_loc),t.disableVertexAttribArray(t.normal3_loc),s.uniform1i(t.colorType_loc,0),c=0,s.uniform1i(t.refMatrixType_loc,c),s.uniform4fv(t.oneColor4_loc,[.1,.1,.6,1]),l.meshVertexCacheKey!==t.lastVboKeyBindedMap[t.position3_loc]&&(s.bindBuffer(s.ARRAY_BUFFER,l.meshVertexCacheKey),s.vertexAttribPointer(t.position3_loc,3,s.FLOAT,!1,0,0),t.lastVboKeyBindedMap[t.position3_loc]=l.meshVertexCacheKey);var g=this.edgesArray.length;for(h=0;h<g;h++){var p=this.edgesArray[h];p===n.currentSelected&&s.uniform4fv(t.oneColor4_loc,[0,1,0,1]),s.drawArrays(s.LINES,2*h,2),p===n.currentSelected&&s.uniform4fv(t.oneColor4_loc,[.1,.1,.6,1])}}if(this.renderSpaces=e.tempSettings.renderSpaces,this.spacesAlpha=e.tempSettings.spacesAlpha,1===r&&t.enableVertexAttribArray(t.normal3_loc),this.renderSpaces){s.uniform1i(t.colorType_loc,0),c=0,s.uniform1i(t.refMatrixType_loc,c),s.uniform4fv(t.oneColor4_loc,[.8,.8,.8,this.spacesAlpha]),s.enable(s.BLEND);var m=0;this.spacesArray&&(m=this.spacesArray.length);for(h=0;h<m;h++){this.spacesArray[h].mesh.render(e,t)}s.disable(s.BLEND)}};var jo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.strNode,this.endNode,this.sense,this.attributes,this.strNodeId,this.endNodeId},Wo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.edgesArray,this.attributes,this.box},Xo=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.networkOwner=t,this.id,this.mesh,this.attributes},Yo=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.ByteR=0,this.ByteG=0,this.ByteB=0,this.ByteAlfa=255};Yo.prototype.destroy=function(){this.ByteR=null,this.ByteG=null,this.ByteB=null,this.ByteAlfa=null},Yo.prototype.set=function(e,t,r){this.ByteR=e,this.ByteG=t,this.ByteB=r};var qo=function(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})},Ko=function(e){var t=null;try{(t=new Worker(e)).onerror=function(i){i.preventDefault(),t=r(e)}}catch(i){t=r(e)}return t;function r(e){var t=null;try{var r;try{r=new Blob(["importScripts('"+e+"');"],{type:"application/javascript"})}catch(t){var i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);i.append("importScripts('"+e+"');"),r=i.getBlob("application/javascript")}var o=(window.URL||window.webkitURL).createObjectURL(r);t=new Worker(o)}catch(e){}return t}},Zo=function(e,t){return void 0!==e&&null!==e?e:t},Jo=function(e,t){return void 0!==e&&null!==e&&e.toString().trim().length>0?e:t},Qo=function(e){return void 0!==e&&null!==e},$o=function(e){return geobuf.geobuf.decode(new Pbf(e))},en=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR)};function H(e){"@babel/helpers - typeof";return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}en.projectPoint3DInToBestPlaneToProject=function(e,t,r){return void 0===r&&(r=new Kr),0===t?r.set(e.x,e.y):1===t?r.set(e.y,e.z):2===t&&r.set(e.x,e.z),r},en.projectTriangle3DInToBestPlaneToProject=function(e,t,r){void 0===r&&(r=new Mi);var i=e.vertex0.getPosition(),o=en.projectPoint3DInToBestPlaneToProject(i,t,void 0),n=e.vertex1.getPosition(),a=en.projectPoint3DInToBestPlaneToProject(n,t,void 0),s=e.vertex2.getPosition(),l=en.projectPoint3DInToBestPlaneToProject(s,t,void 0);return r.setPoints(o,a,l),r},en.getNextIdx=function(e,t){return e===t-1?0:e+1},en.getPrevIdx=function(e,t){return 0===e?t-1:e-1},en.getCenterPositionAndLocalPositions3DFloat32=function(e){for(var t=e.length,r=t/3,i=new G,o=0;o<r;o++){var n=e[3*o],a=e[3*o+1],s=e[3*o+2];0===o?i.initXYZData(n,a,s):i.addXYZData(n,a,s)}var l=i.getCenterPoint(void 0),u=new Float32Array([l.x])[0],c=new Float32Array([l.y])[0],d=new Float32Array([l.z])[0],h=new Float32Array(t);for(o=0;o<r;o++){n=e[3*o],a=e[3*o+1],s=e[3*o+2];h[3*o]=n-u,h[3*o+1]=a-c,h[3*o+2]=s-d}return{centerPos:l,localPosFloatArray:h}},en.getIndicesTrianglesRegularNet=function(e,t,r,i,o,n,a,s){var l,u,c,d=(e-1)*(t-1)*2,h=0,f={},g=!1,p=!0,m=2;void 0!==s&&(void 0!==s.bLoopColumns&&(g=s.bLoopColumns),void 0!==s.bTrianglesSenseCCW&&(p=s.bTrianglesSenseCCW),s.indicesByteSize&&(m=s.indicesByteSize)),void 0===r&&(2===m?r=new Uint16Array(3*d):4===m&&(r=new Uint32Array(3*d)));for(var v=0;v<t-1;v++)for(var x=0;x<e-1;x++)l=Di.getIndexOfArray(e,t,x,v),u=Di.getIndexOfArray(e,t,x+1,v),c=Di.getIndexOfArray(e,t,x,v+1),p?(r[h]=l,r[++h]=u,r[++h]=c,h++):(r[h]=l,r[++h]=c,r[++h]=u,h++),l=Di.getIndexOfArray(e,t,x+1,v),u=Di.getIndexOfArray(e,t,x+1,v+1),c=Di.getIndexOfArray(e,t,x,v+1),p?(r[h]=l,r[++h]=u,r[++h]=c,h++):(r[h]=l,r[++h]=c,r[++h]=u,h++);f.indicesArray=r;var _=!1;if(s&&void 0!==s.bCalculateBorderIndices&&!0===s.bCalculateBorderIndices&&(_=!0),_){i||(2===m?i=new Uint16Array(e):4===m&&(i=new Uint32Array(e)));for(x=0;x<e;x++){var y=Di.getIndexOfArray(e,t,x,0);i[x]=y}f.southIndicesArray=i,o||(2===m?o=new Uint16Array(t):4===m&&(o=new Uint32Array(t)));for(v=0;v<t;v++){y=Di.getIndexOfArray(e,t,e-1,v);o[v]=y}f.eastIndicesArray=o,n||(2===m?n=new Uint16Array(e):4===m&&(n=new Uint32Array(e)));var T=0;for(x=e-1;x>=0;x--){y=Di.getIndexOfArray(e,t,x,t-1);n[T]=y,T++}f.northIndicesArray=n,a||(2===m?a=new Uint16Array(t):4===m&&(a=new Uint32Array(t))),T=0;for(v=t-1;v>=0;v--){y=Di.getIndexOfArray(e,t,0,v);a[T]=y,T++}f.westIndicesArray=a}if(g){var C=e;for(v=0;v<t-1;v++)l=Di.getIndexOfArray(e,t,C,v),u=Di.getIndexOfArray(e,t,0,v),c=Di.getIndexOfArray(e,t,C,v+1),p?(r[h]=l,r[++h]=u,r[++h]=c,h++):(r[h]=l,r[++h]=c,r[++h]=u,h++),l=Di.getIndexOfArray(e,t,0,v),u=Di.getIndexOfArray(e,t,0,v+1),c=Di.getIndexOfArray(e,t,C,v+1),p?(r[h]=l,r[++h]=u,r[++h]=c,h++):(r[h]=l,r[++h]=c,r[++h]=u,h++)}return f};var tn=function(e){return""===e||null===e||void 0===e||null!==e&&"object"===H(e)&&!Object.keys(e).length},rn=function(e,t,r,i,o){if(!Qo(e))throw new Error("url required");return new Promise(function(n,a){void 0===t&&(t=new XMLHttpRequest),o=o||"GET",t.open(o,e,!0),t.responseType=i||"arraybuffer",(e.endsWith(".geojson")||e.endsWith("layer.json"))&&t.overrideMimeType("application/json");var s="json"===i,l=window.navigator.userAgent.indexOf("Trident")>-1;void 0!==r&&(t.timeout=r),t.onload=function(){if(t.status<200||t.status>=300)a(t.status);else{var e=s&&l?JSON.parse(t.response):t.response;n(e)}},t.ontimeout=function(e){a(-1)},t.onerror=function(e){console.log("Invalid XMLHttpRequest response type."),a(t.status)},t.send(null)})},on=function(){};on.getIndexToInsertBySquaredDistToEye=function(e,t,r,i){void 0===r&&(r=0),void 0===i&&(i=e.length-1);var o=i-r;if(o<=0)return 0;if(o<6){var n,a=!1,s=r;for(e.length;!a&&s<=i;)t.distToCamera<e[s].distToCamera&&(n=s,a=!0),s++;return a?n:i+1}var l,u,c=r+Math.floor(o/2);return e[c].distToCamera>t.distToCamera?(l=r,u=c):(l=c,u=i),on.getIndexToInsertBySquaredDistToEye(e,t,l,u)},on.pointToGeographicCoord=function(e,t){if(!e)throw new Error("point is requred");void 0===t&&(t=new pe);var r=Te.CartesianToGeographicWgs84(e.x,e.y,e.z,r);return t.setLonLatAlt(r.longitude,r.latitude,r.altitude),t},on.geographicCoordToWorldPoint=function(e,t,r,i){void 0===i&&(i=new Jr);var o=Te.geographicToCartesianWgs84(e,t,r,void 0);return i.set(o[0],o[1],o[2]),i},on.translatePivotPointGeoLocationData=function(e,t){if(void 0!==e){var r=new Jr;r.set(-t.x,-t.y,-t.z),e.pivotPointTraslationLC=r,e.doEffectivePivotPointTranslation()}},on.calculateGeoLocationMatrixAtWorldPosition=function(e,t){return void 0===t&&(t=new Ne),Te.transformMatrixAtCartesianPointWgs84(e.x,e.y,e.z,t._floatArrays),t},on.calculateGeoLocationMatrixAtLonLatAlt=function(e,t,r,i){void 0===i&&(i=new Ne);var o=this.geographicCoordToWorldPoint(e,t,r,o);return i=on.calculateGeoLocationMatrixAtWorldPosition(o,i)},on.calculateTransformMatrixAtWorldPosition=function(e,t,r,i,o,n){var a,s,l,u=new Ne,c=new Ne,d=new Ne;return void 0!==t&&0!==t&&d.rotationAxisAngDeg(t,0,0,1),void 0!==r&&0!==r&&u.rotationAxisAngDeg(r,1,0,0),void 0!==i&&0!==i&&c.rotationAxisAngDeg(i,0,1,0),void 0===o&&(o=new Ne),void 0===n&&(n=new Ne),o=on.calculateGeoLocationMatrixAtWorldPosition(e,o),n.copyFromMatrix4(o),a=d.getMultipliedByMatrix(n,a),s=u.getMultipliedByMatrix(a,s),n=l=c.getMultipliedByMatrix(s,l)},on.calculateGeoLocationData=function(e,t,r,i,o,n,a){if(void 0===a&&(a=new _e),void 0===a.geographicCoord&&(a.geographicCoord=new pe),void 0!==e?a.geographicCoord.longitude=e:e=a.geographicCoord.longitude,void 0!==t?a.geographicCoord.latitude=t:t=a.geographicCoord.latitude,void 0!==r?a.geographicCoord.altitude=r:r=a.geographicCoord.altitude,void 0!==i&&(a.heading=i),void 0!==o&&(a.pitch=o),void 0!==n&&(a.roll=n),void 0!==a.geographicCoord.longitude&&void 0!==a.geographicCoord.latitude)return a.position=on.geographicCoordToWorldPoint(e,t,r,a.position),void 0===a.positionHIGH&&(a.positionHIGH=new Float32Array([0,0,0])),void 0===a.positionLOW&&(a.positionLOW=new Float32Array([0,0,0])),on.calculateSplited3fv([a.position.x,a.position.y,a.position.z],a.positionHIGH,a.positionLOW),void 0===a.positionSplitted&&(a.positionSplitted=new Float32Array([0,0,0,0,0,0])),a.positionSplitted[0]=a.positionHIGH[0],a.positionSplitted[1]=a.positionHIGH[1],a.positionSplitted[2]=a.positionHIGH[2],a.positionSplitted[3]=a.positionLOW[0],a.positionSplitted[4]=a.positionLOW[1],a.positionSplitted[5]=a.positionLOW[2],void 0===a.tMatrix?a.tMatrix=new Ne:a.tMatrix.Identity(),void 0===a.geoLocMatrix?a.geoLocMatrix=new Ne:a.geoLocMatrix.Identity(),void 0===a.rotMatrix?a.rotMatrix=new Ne:a.rotMatrix.Identity(),a.tMatrixInv=void 0,a.rotMatrixInv=void 0,a.geoLocMatrixInv=void 0,a.tMatrix=on.calculateTransformMatrixAtWorldPosition(a.position,a.heading,a.pitch,a.roll,a.geoLocMatrix,a.tMatrix),a.rotMatrix.copyFromMatrix4(a.tMatrix),a.rotMatrix._floatArrays[12]=0,a.rotMatrix._floatArrays[13]=0,a.rotMatrix._floatArrays[14]=0,void 0===a.pivotPoint&&(a.pivotPoint=new Jr),a.pivotPoint.set(a.position.x,a.position.y,a.position.z),a.doEffectivePivotPointTranslation(),a},on.calculateGeoLocationDataByAbsolutePoint=function(e,t,r,i,o){if(void 0===i&&(i=new _e),void 0===i.geographicCoord&&(i.geographicCoord=new pe),void 0!==o.configInformation)return void 0===i.position&&(i.position=new Jr),i.position.x=e,i.position.y=t,i.position.z=r,i.geographicCoord=on.pointToGeographicCoord(new Jr(e,t,r)),void 0===i.positionHIGH&&(i.positionHIGH=new Float32Array([0,0,0])),void 0===i.positionLOW&&(i.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([i.position.x,i.position.y,i.position.z],i.positionHIGH,i.positionLOW),void 0===i.tMatrix?i.tMatrix=new Ne:i.tMatrix.Identity(),void 0===i.geoLocMatrix?i.geoLocMatrix=new Ne:i.geoLocMatrix.Identity(),void 0===i.rotMatrix?i.rotMatrix=new Ne:i.rotMatrix.Identity(),i.tMatrixInv=void 0,i.rotMatrixInv=void 0,i.geoLocMatrixInv=void 0,i.tMatrix=on.calculateTransformMatrixAtWorldPosition(i.position,i.heading,i.pitch,i.roll,i.geoLocMatrix,i.tMatrix),i.rotMatrix.copyFromMatrix4(i.tMatrix),i.rotMatrix._floatArrays[12]=0,i.rotMatrix._floatArrays[13]=0,i.rotMatrix._floatArrays[14]=0,void 0===i.pivotPoint&&(i.pivotPoint=new Jr),i.pivotPoint.set(i.position.x,i.position.y,i.position.z),i.doEffectivePivotPointTranslation(),i},on.calculateGeoLocationDataByAbsolutePoint__original=function(e,t,r,i,o){if(void 0===i&&(i=new _e),void 0===i.geographicCoord&&(i.geographicCoord=new pe),void 0!==o.configInformation){if(void 0===i.position&&(i.position=new Jr),i.position.x=e,i.position.y=t,i.position.z=r,o.isCesiumGlobe()){var n=new Cesium.Cartographic,a=new Cesium.Cartesian3;a.x=e,a.y=t,a.z=r,n=Cesium.Cartographic.fromCartesian(a,o.scene._globe._ellipsoid,n),i.geographicCoord.longitude=180*n.longitude/Math.PI,i.geographicCoord.latitude=180*n.latitude/Math.PI,i.geographicCoord.altitude=n.height}void 0===i.positionHIGH&&(i.positionHIGH=new Float32Array([0,0,0])),void 0===i.positionLOW&&(i.positionLOW=new Float32Array([0,0,0])),this.calculateSplited3fv([i.position.x,i.position.y,i.position.z],i.positionHIGH,i.positionLOW),void 0===i.tMatrix?i.tMatrix=new Ne:i.tMatrix.Identity(),void 0===i.geoLocMatrix?i.geoLocMatrix=new Ne:i.geoLocMatrix.Identity(),void 0===i.geoLocMatrixInv?i.geoLocMatrixInv=new Ne:i.geoLocMatrixInv.Identity(),void 0===i.tMatrixInv?i.tMatrixInv=new Ne:i.tMatrixInv.Identity(),void 0===i.rotMatrix?i.rotMatrix=new Ne:i.rotMatrix.Identity(),void 0===i.rotMatrixInv?i.rotMatrixInv=new Ne:i.rotMatrixInv.Identity();var s=new Ne,l=new Ne,u=new Ne;if(void 0!==i.heading&&0!==i.heading&&u.rotationAxisAngDeg(i.heading,0,0,-1),void 0!==i.pitch&&0!==i.pitch&&s.rotationAxisAngDeg(i.pitch,-1,0,0),void 0!==i.roll&&0!==i.roll&&l.rotationAxisAngDeg(i.roll,0,-1,0),o.isCesiumGlobe()){Cesium.Transforms.eastNorthUpToFixedFrame(i.position,void 0,i.tMatrix._floatArrays),i.geoLocMatrix.copyFromMatrix4(i.tMatrix);var c=u.getMultipliedByMatrix(i.tMatrix,c),d=s.getMultipliedByMatrix(c,d),h=l.getMultipliedByMatrix(d,h);i.tMatrix=h,i.rotMatrix.copyFromMatrix4(i.tMatrix),i.rotMatrix._floatArrays[12]=0,i.rotMatrix._floatArrays[13]=0,i.rotMatrix._floatArrays[14]=0,Cesium.Matrix4.inverse(i.tMatrix._floatArrays,i.tMatrixInv._floatArrays),Cesium.Matrix4.inverse(i.rotMatrix._floatArrays,i.rotMatrixInv._floatArrays),Cesium.Matrix4.inverse(i.geoLocMatrix._floatArrays,i.geoLocMatrixInv._floatArrays)}return void 0===i.pivotPoint&&(i.pivotPoint=new Jr),i.pivotPoint.set(i.position.x,i.position.y,i.position.z),i}},on.calculateSplitedValues=function(e,t){var r;return void 0===t&&(t=new Qe),e>=0?(r=65536*Math.floor(e/65536),t.high=r,t.low=e-r):(r=65536*Math.floor(-e/65536),t.high=-r,t.low=e+r),t},on.calculateSplited3fv=function(e,t,r){if(void 0!==e){void 0===t&&(t=new Float32Array(3)),void 0===r&&(r=new Float32Array(3));var i=new Qe;i=this.calculateSplitedValues(e[0],i);var o=new Qe;o=this.calculateSplitedValues(e[1],o);var n=new Qe;n=this.calculateSplitedValues(e[2],n),t[0]=i.high,t[1]=o.high,t[2]=n.high,r[0]=i.low,r[1]=o.low,r[2]=n.low}},on.unpackDepth=function(e){return e[0]+1*e[1]/255+1*e[2]/65025+1*e[3]/16581375},on.mod=function(e,t){return e-t*Math.floor(e/t)},on.packDepth=function(e){var t=[16777216,65536,256,1],r=[0,.00390625,.00390625,.00390625],i=[e*t[0]*255,e*t[1]*255,e*t[2]*255,e*t[3]*255],o=[256,256,256,256],n=[on.mod(i[0],o[0])/255,on.mod(i[1],o[1])/255,on.mod(i[2],o[2])/255,on.mod(i[3],o[3])/255],a=[n[0]*r[0],n[0]*r[1],n[1]*r[2],n[2]*r[3]],s=[n[0]-a[0],n[1]-a[1],n[2]-a[2],n[3]-a[3]];return[s[3],s[2],s[1],s[0]]},on.calculatePixelLinearDepth=function(e,t,r,i,o){if(void 0===i&&(i=o.depthFboNeo),i){i&&i.bind();var n=new Uint8Array(4);e.readPixels(t,o.sceneState.drawingBufferHeight[0]-r,1,1,e.RGBA,e.UNSIGNED_BYTE,n);var a=new Float32Array([n[0]/256,n[1]/256,n[2]/256,n[3]/256]),s=on.unpackDepth(a),l=s;if(o.postFxShadersManager.bUseLogarithmicDepth){l=1.0037*s;var u=o.sceneState,c=u.camera.frustum.far[0],d=u.fCoef_logDepth[0]/2;l=(Math.pow(2,l/d)-1)/c}return l}},on.calculatePixelLinearDepthV2=function(e,t,r,i,o,n){var a=new Uint8Array(4);n.framebufferAux.bind(),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0),e.readPixels(t,n.sceneState.drawingBufferHeight[0]-r,1,1,e.RGBA,e.UNSIGNED_BYTE,a);var s=new Float32Array([a[0]/255,a[1]/255,a[2]/255,a[3]/255]),l=on.unpackDepth(s),u=l;e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,o,0),e.readPixels(t,n.sceneState.drawingBufferHeight[0]-r,1,1,e.RGBA,e.UNSIGNED_BYTE,a);for(var c,d,h=new Float32Array([a[0]/255,a[1]/255,a[2]/255,a[3]/255]),f=Math.floor(100*h[3]);f>=10;)f-=10;if(n.framebufferAux.unbind(),f<n.numFrustums&&(c=n.frustumVolumeControl.nearFarArray[2*f],d=n.frustumVolumeControl.nearFarArray[2*f+1]),n.postFxShadersManager.bUseLogarithmicDepth){u=l;var g=n.sceneState.fCoef_logDepth[0]/2;u=(Math.pow(2,u/g)-1)/d}return{linearDepth:u,normal4:h,frustumIdx:f,near:c,far:d}},on.calculatePixelPositionCamCoord=function(e,t,r,i,o,n,a,s,l){var u,c=s.sceneState;if(void 0===a&&(a=c.camera.frustum.far[0]),void 0===n&&(n=0),l&&l.linearDepth&&(u=l.linearDepth),!u){var d=s.getTexturesManager().texturesMergerFbo,h=d.colorBuffersArray[0],f=d.colorBuffersArray[1],g=on.calculatePixelLinearDepthV2(e,t,r,h,f,s);if(!(g.frustumIdx<s.numFrustums))return;u=g.linearDepth,a=g.far,n=g.near}var p=u*a;return s.resultRaySC=on.getRayCamSpace(t,r,s.resultRaySC,s),void 0===i&&(i=new Jr),i.set(s.resultRaySC[0]*p,s.resultRaySC[1]*p,s.resultRaySC[2]*p),e.bindFramebuffer(e.FRAMEBUFFER,null),i},on.cameraCoordPositionToWorldCoord=function(e,t,r){if(void 0===t)t=new Jr;var i=r.sceneState;t=i.getModelViewRelToEyeMatrixInv().transformPoint3D(e,t);var o=i.encodedCamPosHigh,n=i.encodedCamPosLow;return t.add(n[0],n[1],n[2]),t.add(o[0],o[1],o[2]),t},on.detectedDepth=function(e,t,r){var i=r.getGl(),o=r.getTexturesManager().texturesMergerFbo,n=o.colorBuffersArray[0],a=o.colorBuffersArray[1];return on.calculatePixelLinearDepthV2(i,e,t,n,a,r).frustumIdx<r.numFrustums},on.screenCoordToWorldCoordUseDepthCheck=function(e,t,r,i){var o,n=r.getGl();if(n){var a=r.getTexturesManager().texturesMergerFbo,s=a.colorBuffersArray[0],l=a.colorBuffersArray[1],u=on.calculatePixelLinearDepthV2(n,e,t,s,l,r),c=!0;if(new Jr(u.normal4[0],u.normal4[1],u.normal4[2]).getSquaredModul()<.5&&(c=!1),!c&&r.isCesiumGlobe()){var d=r.scene,h=d.frameState.camera.getPickRay(new Cesium.Cartesian2(e,t));o=d.globe.pick(h,d)}else{var f=zr.screenToCamCoord(e,t,r,f,u);o=f?on.cameraCoordPositionToWorldCoord(f,o,r,u):void 0}var g=(i=i||{}).highPrecision;if(c&&g){var p=r.sceneState.getCamera().getPosition(),m=new Jr(o.x-p.x,o.y-p.y,o.z-p.z);m.unitary();var v=new Jr(o.x-10*m.x,o.y-10*m.y,o.z-10*m.z),x=new Jr(o.x+10*m.x,o.y+10*m.y,o.z+10*m.z),_=on.pointToGeographicCoord(v,void 0),y=on.pointToGeographicCoord(x,void 0),T=X.intersectPointByLaser(_,y,void 0,void 0,r,void 0);T&&(o=T)}return o}},on.screenCoordToWorldCoord=function(e,t,r,i,o,n,a,s){if(s.isCesiumGlobe()){var l=s.scene,u=l.globe,c=l.camera,d=new Cesium.Cartesian2(t,r),h=c.getPickRay(d);return u.pick(h,l)}var f=zr.screenToCamCoord(t,r,s);return on.cameraCoordPositionToWorldCoord(f,void 0,s)},on.calculatePixelPositionWorldCoord=function(e,t,r,i,o,n,a,s){var l=new Jr;if(void 0===a&&(a=s.sceneState.camera.frustum.far[0]),void 0===n&&(n=0),void 0===o&&(o=s.depthFboNeo),l=on.calculatePixelPositionCamCoord(e,t,r,l,o,n,a,s),void 0===i)i=new Jr;return i=on.cameraCoordPositionToWorldCoord(l,i,s)},on.calculateWorldPositionToScreenCoord=function(e,t,r,i,o,n){void 0===o&&(o=new Jr),void 0===n.pointSC&&(n.pointSC=new Jr),void 0===n.pointSC2&&(n.pointSC2=new Jr);var a=n.sceneState,s=a.encodedCamPosHigh,l=a.encodedCamPosLow;n.pointSC.set(t,r,i),n.pointSC.add(-l[0],-l[1],-l[2]),n.pointSC.add(-s[0],-s[1],-s[2]);var u=a.modelViewRelToEyeMatrix,c=n.pointSC2,d=(c=u.transformPoint3D(n.pointSC,c)).z;if(d>0)return o.set(-1,-1,0),o;var h=a.camera.frustum.tangentOfHalfFovy[0]*d*2,f=h*a.camera.frustum.aspectRatio[0],g=-c.x*a.drawingBufferWidth[0]/f,p=-c.y*a.drawingBufferHeight[0]/h;return g+=a.drawingBufferWidth[0]/2,p+=a.drawingBufferHeight[0]/2,p=a.drawingBufferHeight[0]-p,o.set(g,p,0),o},on.getRayCamSpace=function(e,t,r,i,o){var n=i.sceneState,a=n.camera.frustum,s=1;o&&(s=o);var l=a.aspectRatio[0],u=2*a.tangentOfHalfFovy[0]*s,c=u*l,d=e,h=n.drawingBufferHeight[0]-t;return void 0===r&&(r=new Float32Array(3)),r[0]=c*(d/n.drawingBufferWidth[0]-.5),r[1]=u*(h/n.drawingBufferHeight[0]-.5),r[2]=-s,r},on.getRayWorldSpace=function(e,t,r,i,o){void 0===i&&(i=new Rr);var n=o.sceneState.camera.position,a=new Float32Array(3);a=on.getRayCamSpace(t,r,a,o),void 0===o.pointSC&&(o.pointSC=new Jr);var s=o.pointSC,l=o.pointSC2;return s.set(a[0],a[1],a[2]),(l=o.sceneState.getModelViewMatrixInv().rotatePoint3D(s,l)).unitary(),i.setPointAndDir(n.x,n.y,n.z,l.x,l.y,l.z),i},on.getHeadingToNorthByTwoGeographicCoords=function(e,t,r){var i=on.calculateGeoLocationData(e.longitude,e.latitude,0,0,0,0,i,r),o=on.geographicCoordToWorldPoint(t.longitude,t.latitude,0,o,r),n=i.worldCoordToLocalCoord(o,n),a=new Kr(n.x,n.y);a.unitary();var s=new Kr(0,1).angleDegToVector(a);return a.x>0&&(s*=-1),s},on.getComplexCoordinateByScreenCoord=function(e,t,r,i,o,n,a){var s=on.screenCoordToWorldCoord(a.getGl(),t,r,s,void 0,void 0,void 0,a);if(!s)return null;var l=on.pointToGeographicCoord(s,l);return{screenCoordinate:new Kr(t,r),worldCoordinate:s,geographicCoordinate:l}},on.geographicToWkt=function(e,t){var r="";switch(t){case"POINT":r="POINT (",r+=e.longitude,r+=" ",r+=e.latitude,r+=")";break;case"LINE":r="LINESTRING (";for(var i=0,o=e.length;i<o;i++)i>0&&(r+=","),r+=e[i].longitude,r+=" ",r+=e[i].latitude;r+=")";break;case"POLYGON":r="POLYGON ((";for(i=0,o=e.length;i<o;i++)i>0&&(r+=","),r+=e[i].longitude,r+=" ",r+=e[i].latitude;r+=",",r+=e[0].longitude,r+=" ",r+=e[0].latitude,r+="))"}return r};var nn=function(e,t){for(var r=0,i=0,o=0,n=0,a=0,s=0,l=0,u=0,c=null,d=null,h=e[0],f=e[1],g=t.length;r<g;r++){i=0;var p=t[r].length-1,m=t[r];if((c=m[0])[0]!==m[p][0]&&c[1]!==m[p][1])throw new Error("First and last coordinates in a ring must be the same");for(a=c[0]-h,s=c[1]-f;i<p;i++)if(u=(d=m[i+1])[1]-f,s<0&&u<0||s>0&&u>0)s=u,a=(c=d)[0]-h;else{if(l=d[0]-e[0],u>0&&s<=0){if((n=a*u-l*s)>0)o+=1;else if(0===n)return 0}else if(s>0&&u<=0){if((n=a*u-l*s)<0)o+=1;else if(0===n)return 0}else if(0===u&&s<0){if(0===(n=a*u-l*s))return 0}else if(0===s&&u<0){if(0===(n=a*u-l*s))return 0}else if(0===s&&0===u){if(l<=0&&a>=0)return 0;if(a<=0&&l>=0)return 0}c=d,s=u,a=l}}return o%2!=0},an=function(e){if(Math.log2=Math.log2||function(e){return Math.log(e)*Math.LOG2E},Math.cbrt=Math.cbrt||function(e){var t=Math.pow(Math.abs(e),1/3);return e<0?-t:t},e.URLSearchParams=e.URLSearchParams||function(e){var t=this;t.searchString=e,t.get=function(e){var r=new RegExp("[?&]"+e+"=([^&#]*)").exec(t.searchString);return null===r?null:decodeURI(r[1])||0}},"function"!=typeof e.CustomEvent){var t=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var r=document.createEvent("CustomEvent");return r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),r};t.prototype=e.Event.prototype,e.CustomEvent=t}}(window),sn=function(){};sn.strokeText_fillText=function(e,t){};var ln=function(){return function(){throw new Error("Unimplemented abstract method.")}()},un=function(){return!0},cn=function(e,t){return!!Object.keys(t).filter(function(r){return t[r](e[r])}).length},dn=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.waterManager=t,this.geographicExtent,this._targetDepth,this.original_dem_texture,this.dem_withExcavation,this.dem_texture_A,this.dem_texture_B,this.terrainFluxTexA_HIGH,this.terrainFluxTexB_HIGH,this.terrainFluxTexA_LOW,this.terrainFluxTexB_LOW,this.terrainMaxSlippageTex,this.demWithBuildingsTex,this.terrainMaxFlux=1e4,this.waterSourceUrl,this.waterHeightTexA,this.waterHeightTexB,this.waterSourceTex,this.waterAditionTex,this.rainTex,this.contaminantSourceTex,this.waterFluxTexA_HIGH,this.waterFluxTexB_HIGH,this.waterFluxTexA_LOW,this.waterFluxTexB_LOW,this.waterVelocityTexA,this.waterVelocityTexB,this.particlesTex_A,this.particlesTex_B,this.particlesPosTex_A,this.particlesPosTex_B,this.windRes,this.contaminationTex_A,this.contaminationTex_B,this.shaderLogTexA,this.shaderLogTexB,this.shaderLogParticlesPos_TexA,this.shaderLogTex_Flux_A,this.shaderLogTex_Flux_B,this.quantizedVolumeMinMaxHeights=new Float32Array([-100,1e3]),this.terrainMinMaxHeights=new Float32Array([180,540]),this.surface,this._bIsPrepared=!1,this.visibleObjectsControler,r&&(r.geographicExtent&&(this.geographicExtent=r.geographicExtent),r.tileIndices&&(this.tileIndices=r.tileIndices),r.targetDepth&&(this._targetDepth=r.targetDepth),void 0!==r.waterSourceUrl&&(this.waterSourceUrl=r.waterSourceUrl))};dn.prototype.deleteObjects=function(){var e=this.waterManager.magoManager,t=e.getGl();this.waterHeightTexA&&(this.waterHeightTexA.deleteObjects(t),this.waterHeightTexA=void 0),this.waterHeightTexB&&(this.waterHeightTexB.deleteObjects(t),this.waterHeightTexB=void 0),this.contaminationTex_A&&(this.contaminationTex_A.deleteObjects(t),this.contaminationTex_A=void 0),this.contaminationTex_B&&(this.contaminationTex_B.deleteObjects(t),this.contaminationTex_B=void 0),this.waterFluxTexA_HIGH&&(this.waterFluxTexA_HIGH.deleteObjects(t),this.waterFluxTexA_HIGH=void 0),this.waterFluxTexA_LOW&&(this.waterFluxTexA_LOW.deleteObjects(t),this.waterFluxTexA_LOW=void 0),this.waterFluxTexB_HIGH&&(this.waterFluxTexB_HIGH.deleteObjects(t),this.waterFluxTexB_HIGH=void 0),this.waterFluxTexB_LOW&&(this.waterFluxTexB_LOW.deleteObjects(t),this.waterFluxTexB_LOW=void 0),this.shaderLogTexA&&(this.shaderLogTexA.deleteObjects(t),this.shaderLogTexA=void 0),this.shaderLogTexB&&(this.shaderLogTexB.deleteObjects(t),this.shaderLogTexB=void 0),this.waterSourceTex&&(this.waterSourceTex.deleteObjects(t),this.waterSourceTex=void 0),this.rainTex&&(this.rainTex.deleteObjects(t),this.rainTex=void 0),this.waterAditionTex&&(this.waterAditionTex.deleteObjects(t),this.waterAditionTex=void 0),this.waterVelocityTexA&&(this.waterVelocityTexA.deleteObjects(t),this.waterVelocityTexA=void 0),this.waterVelocityTexB&&(this.waterVelocityTexB.deleteObjects(t),this.waterVelocityTexB=void 0),this.demWithBuildingsTex&&(this.demWithBuildingsTex.deleteObjects(t),this.demWithBuildingsTex=void 0),this.shaderLogTex_Flux_A&&(this.shaderLogTex_Flux_A.deleteObjects(t),this.shaderLogTex_Flux_A=void 0),this.shaderLogTex_Flux_B&&(this.shaderLogTex_Flux_B.deleteObjects(t),this.shaderLogTex_Flux_B=void 0),this.particlesTex_A&&(this.particlesTex_A.deleteObjects(t),this.particlesTex_A=void 0),this.particlesTex_B&&(this.particlesTex_B.deleteObjects(t),this.particlesTex_B=void 0),this.particlesPosTex_A&&(this.particlesPosTex_A.deleteObjects(t),this.particlesPosTex_A=void 0),this.particlesPosTex_B&&(this.particlesPosTex_B.deleteObjects(t),this.particlesPosTex_B=void 0),this.contaminationTex_A&&(this.contaminationTex_A.deleteObjects(t),this.contaminationTex_A=void 0),this.contaminationTex_B&&(this.contaminationTex_B.deleteObjects(t),this.contaminationTex_B=void 0),this.contaminantSourceTex&&(this.contaminantSourceTex.deleteObjects(t),this.contaminantSourceTex=void 0),this.dem_withExcavation&&(this.dem_withExcavation.deleteObjects(t),this.dem_withExcavation=void 0),this.dem_texture_A&&(this.dem_texture_A.deleteObjects(t),this.dem_texture_A=void 0),this.dem_texture_B&&(this.dem_texture_B.deleteObjects(t),this.dem_texture_B=void 0),this.terrainFluxTexA_HIGH&&(this.terrainFluxTexA_HIGH.deleteObjects(t),this.terrainFluxTexA_HIGH=void 0),this.terrainFluxTexB_HIGH&&(this.terrainFluxTexB_HIGH.deleteObjects(t),this.terrainFluxTexB_HIGH=void 0),this.terrainFluxTexA_LOW&&(this.terrainFluxTexA_LOW.deleteObjects(t),this.terrainFluxTexA_LOW=void 0),this.terrainFluxTexB_LOW&&(this.terrainFluxTexB_LOW.deleteObjects(t),this.terrainFluxTexB_LOW=void 0),this.terrainMaxSlippageTex&&(this.terrainMaxSlippageTex.deleteObjects(t),this.terrainMaxSlippageTex=void 0),this.vbo_vicks_container&&(this.vbo_vicks_container.deleteGlObjects(t,e.vboMemoryManager),this.vbo_vicks_container=void 0)},dn.prototype.resetSimulation=function(){var e=this.waterManager,t=e.magoManager.getGl(),r=e.simulationTextureSize[0],i=e.simulationTextureSize[1],o=t.LINEAR,n=t.CLAMP_TO_EDGE;it.resetTexture(this.waterHeightTexA,t,o,n,r,i),it.resetTexture(this.waterHeightTexB,t,o,n,r,i),it.resetTexture(this.contaminationTex_A,t,o,n,r,i),it.resetTexture(this.contaminationTex_B,t,o,n,r,i),it.resetTexture(this.waterFluxTexA_HIGH,t,o,n,r,i),it.resetTexture(this.waterFluxTexA_LOW,t,o,n,r,i),it.resetTexture(this.waterFluxTexB_HIGH,t,o,n,r,i),it.resetTexture(this.waterFluxTexB_LOW,t,o,n,r,i)},dn.prototype.init=function(){this._makeSurface(),this._makeTextures();var e=this.geographicExtent.minGeographicCoord.longitude,t=this.geographicExtent.minGeographicCoord.latitude,r=this.geographicExtent.maxGeographicCoord.longitude,i=this.geographicExtent.maxGeographicCoord.latitude,o=new pe(e,t,0),n=new pe(e,i,0),a=new pe(r,t,0);this.tileSizeMeters_x=Te.getArcDistanceBetweenGeographicCoords(o,a),this.tileSizeMeters_y=Te.getArcDistanceBetweenGeographicCoords(o,n),this.cellSize_x=this.tileSizeMeters_x/this.waterManager.simulationTextureSize[0],this.cellSize_y=this.tileSizeMeters_y/this.waterManager.simulationTextureSize[1],this.cellArea=this.cellSize_x*this.cellSize_y,this._bIsPrepared=!0},dn.prototype._makeTextures=function(){var e=this.waterManager,t=e.magoManager.getGl(),r=e.simulationTextureSize[0],i=e.simulationTextureSize[1];this.waterAditionTex=e._newTexture(t,r,i),this.waterHeightTexA=e._newTexture(t,r,i),this.waterHeightTexB=e._newTexture(t,r,i),this.waterHeightTexA.name="A",this.waterHeightTexB.name="B",this.waterFluxTexA_HIGH=e._newTexture(t,r,i),this.waterFluxTexB_HIGH=e._newTexture(t,r,i),this.waterFluxTexA_LOW=e._newTexture(t,r,i),this.waterFluxTexB_LOW=e._newTexture(t,r,i),this.waterVelocityTexA=e._newTexture(t,r,i),this.waterVelocityTexB=e._newTexture(t,r,i),this.demWithBuildingsTex=e._newTexture(t,r,i),this.shaderLogTexA=e._newTexture(t,r,i),this.shaderLogTexB=e._newTexture(t,r,i),this.shaderLogTex_Flux_A=e._newTexture(t,r,i),this.shaderLogTex_Flux_B=e._newTexture(t,r,i);var o=e.particlesRenderTexWidth,n=e.particlesRenderTexHeight;this.particlesTex_A=e._newTexture(t,o,n),this.particlesTex_B=e._newTexture(t,o,n);for(var a=this.windRes*this.windRes,s=new Uint8Array(4*a),l=0;l<s.length;l++)s[l]=Math.floor(256*Math.random());this.particlesPosTex_A=new it,this.particlesPosTex_B=new it,this.particlesPosTex_A.texId=it.createTexture(t,t.NEAREST,s,this.windRes,this.windRes),this.particlesPosTex_B.texId=it.createTexture(t,t.NEAREST,s,this.windRes,this.windRes),this.shaderLogParticlesPos_TexA=e._newTexture(t,this.windRes,this.windRes),this.contaminationTex_A=e._newTexture(t,r,i),this.contaminationTex_B=e._newTexture(t,r,i),this.contaminantSourceTex=e._newTexture(t,r,i),this.dem_withExcavation,this.dem_texture_A,this.dem_texture_B,this.terrainFluxTexA_HIGH=e._newTexture(t,r,i),this.terrainFluxTexB_HIGH=e._newTexture(t,r,i),this.terrainFluxTexA_LOW=e._newTexture(t,r,i),this.terrainFluxTexB_LOW=e._newTexture(t,r,i),this.terrainMaxSlippageTex=e._newTexture(t,r,i),t.bindTexture(t.TEXTURE_2D,null)},dn.prototype.makeDEMTextureByQuantizedMeshes=function(){if(!this.makeDemTextureByQMeshses_processFinished&&this.isPrepared()){if(!this.recalculatedGeoExtentAltitudes){this.geographicExtent.setExtentAltitudes(1e4,-1e4);for(var e=this.tilesArray.length,t=0;t<e;t++){var r=(p=this.tilesArray[t]).qMesh._minimumHeight,i=p.qMesh._maximumHeight;this.geographicExtent.minGeographicCoord.altitude>r?this.geographicExtent.minGeographicCoord.altitude=r:this.geographicExtent.maxGeographicCoord.altitude<i&&(this.geographicExtent.maxGeographicCoord.altitude=i)}this.recalculatedGeoExtentAltitudes=!0}this.terrainMinMaxHeights[0]=this.geographicExtent.minGeographicCoord.altitude,this.terrainMinMaxHeights[1]=this.geographicExtent.maxGeographicCoord.altitude;e=this.tilesArray.length;if(!this.tilesQuantizedMeshVboMade){for(t=0;t<e;t++){(p=this.tilesArray[t]).qMeshVboKeyContainer||this._makeQuantizedMeshVbo(p)}this.tilesQuantizedMeshVboMade=!0}var o,n=this.waterManager,a=n.magoManager,s=a.vboMemoryManager,l=a.getGl(),u=n.terrainTexFbo,c=u.extbuffers;if(!this.original_dem_texture){var d=n.terrainTextureSize[0],h=n.terrainTextureSize[1];this.original_dem_texture=n._newTexture(l,d,h)}u.bind(),l.viewport(0,0,u.width[0],u.height[0]),l.framebufferTexture2D(l.FRAMEBUFFER,c.COLOR_ATTACHMENT0_WEBGL,l.TEXTURE_2D,this.original_dem_texture.texId,0),l.framebufferTexture2D(l.FRAMEBUFFER,c.COLOR_ATTACHMENT1_WEBGL,l.TEXTURE_2D,null,0),l.framebufferTexture2D(l.FRAMEBUFFER,c.COLOR_ATTACHMENT2_WEBGL,l.TEXTURE_2D,null,0),l.framebufferTexture2D(l.FRAMEBUFFER,c.COLOR_ATTACHMENT3_WEBGL,l.TEXTURE_2D,null,0),c.drawBuffersWEBGL([c.COLOR_ATTACHMENT0_WEBGL,c.NONE,c.NONE,c.NONE]),l.disable(l.BLEND),l.disable(l.CULL_FACE),l.clearColor(1,0,0,0),l.clearDepth(1),o=a.postFxShadersManager.getShader("depthTexFromQuantizedMesh"),a.postFxShadersManager.useProgram(o),o.bindUniformGenerals(),l.uniform1i(o.colorType_loc_loc,0),l.uniform1i(o.u_terrainHeightEncodingBytes_loc,n.terrainHeightEncodingBytes),l.uniform1i(o.u_flipTexCoordY_loc,!0),l.clear(l.DEPTH_BUFFER_BIT);var f=this.geographicExtent;l.uniform3fv(o.u_totalMinGeoCoord_loc,[f.minGeographicCoord.longitude,f.minGeographicCoord.latitude,f.minGeographicCoord.altitude]),l.uniform3fv(o.u_totalMaxGeoCoord_loc,[f.maxGeographicCoord.longitude,f.maxGeographicCoord.latitude,f.maxGeographicCoord.altitude]),void 0===this.demTextureByQMesh_lastTileIdx&&(this.demTextureByQMesh_lastTileIdx=0);for(t=0;t<50;t++){var g=t+this.demTextureByQMesh_lastTileIdx;if(g>=e){this.original_dem_texture.fileLoadState=I.fileLoadState.BINDING_FINISHED,this.makeDemTextureByQMeshses_processFinished=!0;break}var p,m=(p=this.tilesArray[g]).geoExtent;l.uniform3fv(o.u_currentMinGeoCoord_loc,[m.minGeographicCoord.longitude,m.minGeographicCoord.latitude,p.qMesh._minimumHeight]),l.uniform3fv(o.u_currentMaxGeoCoord_loc,[m.maxGeographicCoord.longitude,m.maxGeographicCoord.latitude,p.qMesh._maximumHeight]);var v=p.qMeshVboKeyContainer.vboCacheKeysArray[0];v.vertexCount;v.vboBufferPos.bindData(o,o.position3_loc,s);var x=v.indicesCount;if(!v.bindDataIndice(o,a.vboMemoryManager))return!1;l.drawElements(l.TRIANGLES,x,l.UNSIGNED_SHORT,0)}this.demTextureByQMesh_lastTileIdx+=50,u.unbind(),l.enable(l.CULL_FACE)}},dn.prototype.makeDEMTextureByQuantizedMesh__testQSurfaceMesh=function(e){if(this.isPrepared()){this.qMeshVboKeyContainer||this._makeQuantizedMeshVbo__testQSurfaceMesh(e);var t,r=this.waterManager,i=r.magoManager,o=i.vboMemoryManager,n=i.getGl(),a=r.terrainTexFbo,s=a.extbuffers;if(n.disable(n.BLEND),n.disable(n.CULL_FACE),n.clearColor(1,1,1,1),n.clearDepth(1),!this.qSurfaceMesh_dem_texture){var l=r.terrainTextureSize[0],u=r.terrainTextureSize[1];this.qSurfaceMesh_dem_texture=r._newTexture(n,l,u)}if(!e.geoExtent){var c=I.imageryType.CRS84,d=e.tileIndices;e.geoExtent=Ke.getGeographicExtentOfTileLXY(d.L,d.X,d.Y,void 0,c);var h=e._maximumHeight,f=e._minimumHeight;e.geoExtent.setExtentAltitudes(f,h)}a.bind(),n.viewport(0,0,a.width[0],a.height[0]),n.framebufferTexture2D(n.FRAMEBUFFER,s.COLOR_ATTACHMENT0_WEBGL,n.TEXTURE_2D,this.qSurfaceMesh_dem_texture.texId,0),n.framebufferTexture2D(n.FRAMEBUFFER,s.COLOR_ATTACHMENT1_WEBGL,n.TEXTURE_2D,null,0),n.framebufferTexture2D(n.FRAMEBUFFER,s.COLOR_ATTACHMENT2_WEBGL,n.TEXTURE_2D,null,0),n.framebufferTexture2D(n.FRAMEBUFFER,s.COLOR_ATTACHMENT3_WEBGL,n.TEXTURE_2D,null,0),s.drawBuffersWEBGL([s.COLOR_ATTACHMENT0_WEBGL,s.NONE,s.NONE,s.NONE]),t=i.postFxShadersManager.getShader("depthTexFromQuantizedMesh"),i.postFxShadersManager.useProgram(t),t.bindUniformGenerals(),n.uniform4fv(t.u_oneColor4_loc,[1,.5,.25,1]),n.uniform1i(t.u_flipTexCoordY_loc,!0);var g=e.geoExtent;n.uniform3fv(t.u_totalMinGeoCoord_loc,[g.minGeographicCoord.longitude,g.minGeographicCoord.latitude,g.minGeographicCoord.altitude]),n.uniform3fv(t.u_totalMaxGeoCoord_loc,[g.maxGeographicCoord.longitude,g.maxGeographicCoord.latitude,g.maxGeographicCoord.altitude]),n.uniform3fv(t.u_currentMinGeoCoord_loc,[g.minGeographicCoord.longitude,g.minGeographicCoord.latitude,g.minGeographicCoord.altitude]),n.uniform3fv(t.u_currentMaxGeoCoord_loc,[g.maxGeographicCoord.longitude,g.maxGeographicCoord.latitude,g.maxGeographicCoord.altitude]),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);var p=this.qMeshVboKeyContainer.vboCacheKeysArray[0];p.vertexCount;p.vboBufferPos.bindData(t,t.a_pos,o),p.vboBufferCol&&p.vboBufferCol.bindData(t,t.color4_loc,o);var m=p.indicesCount;if(!p.bindDataIndice(t,i.vboMemoryManager))return!1;var v,x=m/3;n.uniform1i(t.colorType_loc,1);for(var _=0;_<x;_++)v=3*_*2,n.uniform4fv(t.u_oneColor4_loc,[.5*Math.random(),.5*Math.random(),.5*Math.random(),1]),n.drawElements(n.TRIANGLES,3,n.UNSIGNED_SHORT,v);a.unbind(),n.enable(n.CULL_FACE),n.enable(n.DEPTH_TEST),this.qSurfaceMesh_dem_texture.fileLoadState=I.fileLoadState.BINDING_FINISHED}},dn.prototype._makeQuantizedMeshVbo=function(e){var t=e.qMesh,r=(t._minimumHeight,t._maximumHeight,t._uValues),i=t._vValues,o=t._heightValues;this.indices=t._indices;var n=r.length;this.cartesiansArray=new Uint16Array(3*n);for(var a,s,l,u=0;u<n;u++)a=r[u],s=i[u],l=o[u],this.cartesiansArray[3*u]=a,this.cartesiansArray[3*u+1]=s,this.cartesiansArray[3*u+2]=l;var c=this.waterManager.magoManager.vboMemoryManager;void 0===e.qMeshVboKeyContainer&&(e.qMeshVboKeyContainer=new xt);var d=e.qMeshVboKeyContainer.newVBOVertexIdxCacheKey();d.setDataArrayPos(this.cartesiansArray,c),this.normalsArray&&d.setDataArrayNor(this.normalsArray,c),this.texCoordsArray&&d.setDataArrayTexCoord(this.texCoordsArray,c),d.setDataArrayIdx(this.indices,c)},dn.prototype._makeQuantizedMeshVbo__testQSurfaceMesh=function(e){if(this.qMeshVboKeyContainer)return!0;e._minimumHeight,e._maximumHeight;var t,r=e._uValues,i=e._vValues,o=e._heightValues;this.indices=e._indices,e._colors&&(t=e._colors);for(var n,a,s,l=r.length,u=new Uint16Array(3*l),c=0;c<l;c++)n=r[c],a=i[c],s=o[c],u[3*c]=n,u[3*c+1]=a,u[3*c+2]=s;var d,h=this.waterManager.magoManager.vboMemoryManager;void 0===this.qMeshVboKeyContainer&&(this.qMeshVboKeyContainer=new xt),(d=this.qMeshVboKeyContainer.newVBOVertexIdxCacheKey()).setDataArrayPos(u,h),t&&d.setDataArrayCol(t,h),d.setDataArrayIdx(this.indices,h);var f,g=(m=e._southIndices).length,p=[];for(c=0;c<g;c++)n=r[f=m[c]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);for(g=(m=e._eastIndices).length,c=0;c<g;c++)n=r[f=m[c]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);for(c=(g=(m=e._northIndices).length)-1;c>=0;c--)n=r[f=m[c]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);var m;for(c=(g=(m=e._westIndices).length)-1;c>=0;c--)n=r[f=m[c]],a=i[f],s=o[f],p.push(n,a,s),p.push(n,a,1e4);(d=this.qMeshVboKeyContainer.newVBOVertexIdxCacheKey()).setDataArrayPos(new Uint16Array(p),h)},dn.prototype.isPrepared=function(){return!!this._bIsPrepared||(this.init(),!1)},dn.prototype._loadQuantizedMesh=function(e,t,r,i){i.qMeshPromise=this.waterManager.terrainProvider.requestTileGeometry(t,r,e),i.qMeshPromise.then(function(o){i.qMesh=o,i.geoExtent=Ke.getGeographicExtentOfTileLXY(e,t,r,void 0,I.imageryType.CRS84)})},dn._loadOrCreateTexture=function(e,t){if(e.fileLoadState===I.fileLoadState.BINDING_FINISHED)return!0;if(!e.url){a=t.magoManager.getGl();var r=t.simulationTextureSize[0],i=t.simulationTextureSize[1],o=a.NEAREST,n=it.createTexture(a,o,null,r,i);return e.texId=n,e.imageWidth=r,e.imageHeight=i,e.fileLoadState=I.fileLoadState.BINDING_FINISHED,!1}if(e.fileLoadState===I.fileLoadState.READY){var a=t.magoManager.getGl();return hr.loadImage(a,e.url,e),!1}return e.fileLoadState===I.fileLoadState.BINDING_FINISHED},dn.prototype.prepareTextures=function(){var e=this.waterManager;if(!this.waterSourceTex){var t=this.waterManager.magoManager.getGl(),r={};return this.waterSourceUrl&&(r.waterSourceUrl=this.waterSourceUrl),this.waterSourceTex=new it(r),this.waterSourceTex.texId=t.createTexture(),!1}if(this.waterSourceTex.fileLoadState===I.fileLoadState.READY){t=this.waterManager.magoManager.getGl();var i=e.waterSourceUrl;hr.loadImage(t,i,this.waterSourceTex);var o=e.simulationTextureSize[0],n=e.simulationTextureSize[1];return!1}if(this.waterSourceTex.fileLoadState!==I.fileLoadState.BINDING_FINISHED)return!1;if(1===e.rainType){if(!this.rainTex){t=this.waterManager.magoManager.getGl();return this.rainTex=new it,this.rainTex.texId=t.createTexture(),!1}if(this.rainTex.fileLoadState===I.fileLoadState.READY){t=this.waterManager.magoManager.getGl(),i=this.waterManager.waterSourceRainUrl;return hr.loadImage(t,i,this.rainTex),!1}if(this.rainTex.fileLoadState!==I.fileLoadState.BINDING_FINISHED)return!1}if("HIGHMAP"===this.waterManager.terrainDemSourceType){if(!this.original_dem_texture){t=this.waterManager.magoManager.getGl();return this.original_dem_texture=new it,this.original_dem_texture.texId=t.createTexture(),!1}if(this.original_dem_texture.fileLoadState===I.fileLoadState.READY){t=this.waterManager.magoManager.getGl();var a=this.waterManager.DEMHighMapUrl;return hr.loadImage(t,a,this.original_dem_texture),!1}if(this.original_dem_texture.fileLoadState!==I.fileLoadState.BINDING_FINISHED)return!1}else if("QUANTIZEDMESH"===this.waterManager.terrainDemSourceType){if(!this.tilesArray){var s=this.geographicExtent,l=s.maxGeographicCoord.longitude-s.minGeographicCoord.longitude,u=s.maxGeographicCoord.latitude-s.minGeographicCoord.latitude,c=-1;if(l<u){for(var d=1;d<30;d++)if(Ke.selectTileAngleRangeByDepth(d)<l){c=d;break}}else for(d=1;d<30;d++)if(Ke.selectTileAngleRangeByDepth(d)<u){c=d;break}(e=this.waterManager).simulationTileDepth=c;var h=e.simulationTileDepth;this._targetDepth=h+6;var f=Fe.getMaximumLevelOfTerrainProvider(this.waterManager.terrainProvider);this._targetDepth>f&&(this._targetDepth=f);var g=this._targetDepth,p=s.minGeographicCoord.longitude,m=s.minGeographicCoord.latitude,v=s.maxGeographicCoord.longitude,x=s.maxGeographicCoord.latitude;this.tilesArray=Ke.selectTileIndicesArray(g,p,m,v,x,void 0)}if(!this.allQuantizedMeshesLoaded){var _=!0,y=this.tilesArray.length;for(d=0;d<y;d++){var T=this.tilesArray[d];if(!T.qMesh){if(!T.qMeshPromise){var C=T.X,b=T.Y,M=T.L;this._loadQuantizedMesh(M,C,b,T)}_=!1}}_&&(this.allQuantizedMeshesLoaded=!0)}if(this.allQuantizedMeshesLoaded){if(!this.makeDemTextureByQMeshses_processFinished)return this.makeDEMTextureByQuantizedMeshes(),!1}}if(!this.dem_texture_A){if(this.original_dem_texture&&this.original_dem_texture.fileLoadState===I.fileLoadState.BINDING_FINISHED){t=this.waterManager.magoManager.getGl(),o=this.waterManager.simulationTextureSize[0],n=this.waterManager.simulationTextureSize[1];this.dem_texture_A=this.waterManager._newTexture(t,o,n);this.copyTexture(this.original_dem_texture,[this.dem_texture_A],!0),this.dem_texture_B=this.waterManager._newTexture(t,o,n),this.copyTexture(this.original_dem_texture,[this.dem_texture_B],!0),this.dem_withExcavation=this.waterManager._newTexture(t,o,n),this.copyTexture(this.original_dem_texture,[this.dem_withExcavation],!0),this.copyTexture(this.original_dem_texture,[this.demWithBuildingsTex],!0)}return!1}return!0},dn._swapTextures=function(e,t){var r=e.texId;e.texId=t.texId,t.texId=r},dn.prototype.test__doQuantizedSurfaceExcavation=function(e){var t=this;if(!this.qMeshTestFinished){if(!this.requestedTile){var r=27934,i=4791,o={L:17,X:r=223685,Y:i=38147};this.requestedTile=!0,this.qMeshPromise=e.scene.globe.terrainProvider.requestTileGeometry(r,i,17),this.qMeshPromise.then(function(e){t.testQMesh=e,t.testQMesh.tileIndices={L:17,X:r,Y:i}})}if(!this.quantizedSurfaceTest&&this.testQMesh){var n=I.imageryType.CRS84,a=(o=this.testQMesh.tileIndices,Ke.getGeographicExtentOfTileLXY(o.L,o.X,o.Y,void 0,n)),s=a.minGeographicCoord,l=a.maxGeographicCoord,u=(s.longitude,s.latitude,l.longitude,l.latitude,[]);.004,u.push(127.18867778778076,37.615659186587635),u.push(127.18434333801268,37.612055711412815),u.push(127.18932151794434,37.608758038672185),u.push(127.19541549682617,37.60865604646256),u.push(127.19653129577637,37.613109575992404),u.push(127.19537258148193,37.61613510421666),u.push(127.19357013702391,37.617324884962706),u.push(127.1918535232544,37.61766481882189),u.push(127.18867778778076,37.615659186587635);var c,d=e.modeler.getGeographicCoordsList();if((c=new pe(127.18867778778076,37.615659186587635,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),(c=new pe(127.18434333801268,37.612055711412815,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),(c=new pe(127.18932151794434,37.608758038672185,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),(c=new pe(127.19541549682617,37.60865604646256,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),(c=new pe(127.19653129577637,37.613109575992404,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),(c=new pe(127.19537258148193,37.61613510421666,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),(c=new pe(127.19357013702391,37.617324884962706,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),(c=new pe(127.1918535232544,37.61766481882189,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),(c=new pe(127.18867778778076,37.615659186587635,50)).makeDefaultGeoLocationData(),d.addGeoCoord(c),h=e.quantizedMeshManager){h.doExcavation(this.testQMesh,u,-30);h.newExcavationSet(u,-30).getIntersectedTiles()}this.quantizedSurfaceTest=!0}var h;if((h=e.quantizedMeshManager)&&this.testQMesh&&!this.testQMesh_received){o=this.testQMesh.tileIndices;var f=h.getExcavatedQuantizedMesh(o.X,o.Y,o.L);f&&(this.testQMesh_received||(this.testQMesh._uValues=f.uValues,this.testQMesh._vValues=f.vValues,this.testQMesh._heightValues=f.hValues,this.testQMesh._indices=f.indices,this.testQMesh._southIndices=f.southIndices,this.testQMesh._eastIndices=f.eastIndices,this.testQMesh._northIndices=f.northIndices,this.testQMesh._westIndices=f.westIndices,this.testQMesh._minimumHeight=f.minHeight,this.testQMesh._maximumHeight=f.maxHeight,this.testQMesh_received=!0))}!this.qSurfaceMesh_dem_texture&&this.testQMesh_received&&(this.makeDEMTextureByQuantizedMesh__testQSurfaceMesh(this.testQMesh),this.qMeshTestFinished=!0)}},dn.prototype.doSimulationSteps=function(e){if(this.isPrepared()){if(!this.prepareTextures())return!1;e.sceneState;var t,r=this.waterManager,i=e.getGl(),o=r.fbo,n=o.extbuffers;r.bDoLandSlideSimulation&&this.doSimulationSteps_landSlide(e),i.disable(i.BLEND),i.clearColor(0,0,0,0),i.clearDepth(1),o.bind(),i.viewport(0,0,o.width[0],o.height[0]),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.waterHeightTexA.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,this.contaminationTex_A.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,this.shaderLogTexA.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.COLOR_ATTACHMENT1_WEBGL,n.COLOR_ATTACHMENT2_WEBGL,n.NONE]),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);var a=r.getQuadBuffer();t=e.postFxShadersManager.getShader("waterCalculateHeight"),e.postFxShadersManager.useProgram(t);var s=1*r.getIncrementTimeSeconds();i.uniform1f(t.u_waterMaxHeigh_loc,r.waterMaxHeight),i.uniform1f(t.u_contaminantMaxHeigh_loc,r.contaminantMaxheight),i.uniform1f(t.u_increTimeSeconds_loc,s),i.uniform1i(t.u_rainType_loc,r.rainType),i.uniform1f(t.u_rainValue_mmHour_loc,r.rainValue_mmHour),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.waterSourceTex.texId),i.activeTexture(i.TEXTURE1),this.rainTex&&this.rainTex.texId>=0?i.bindTexture(i.TEXTURE_2D,this.rainTex.texId):i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.waterHeightTexB.texId),r.contaminantMaxheight>0&&(i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.contaminantSourceTex.texId),i.activeTexture(i.TEXTURE4),i.bindTexture(i.TEXTURE_2D,this.contaminationTex_B.texId)),i.activeTexture(i.TEXTURE5),i.bindTexture(i.TEXTURE_2D,this.waterAditionTex.texId),ae.bindAttribute(i,a.posBuffer,t.attribLocations.a_pos,2),i.drawArrays(i.TRIANGLES,0,6),dn._swapTextures(this.waterHeightTexA,this.waterHeightTexB),dn._swapTextures(this.contaminationTex_A,this.contaminationTex_B),o.bind(),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.waterFluxTexA_HIGH.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,this.waterFluxTexA_LOW.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.COLOR_ATTACHMENT1_WEBGL,n.NONE,n.NONE]),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),t=e.postFxShadersManager.getShader("waterCalculateFlux"),e.postFxShadersManager.useProgram(t),i.uniform2fv(t.u_simulationTextureSize_loc,r.simulationTextureSize),i.uniform2fv(t.u_terrainTextureSize_loc,r.terrainTextureSize),i.uniform1f(t.u_timestep_loc,r.simulationTimeStep),i.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),i.uniform1f(t.u_waterMaxHeigh_loc,r.waterMaxHeight),i.uniform1f(t.u_waterMaxFlux_loc,r.waterMaxFlux),i.uniform2fv(t.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),i.uniform1f(t.u_contaminantMaxHeigh_loc,r.contaminantMaxheight),i.uniform1i(t.u_terrainHeightEncodingBytes_loc,r.terrainHeightEncodingBytes),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.waterHeightTexB.texId),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.demWithBuildingsTex.texId),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.waterFluxTexB_HIGH.texId),i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.waterFluxTexB_LOW.texId),r.contaminantMaxheight>0&&(i.activeTexture(i.TEXTURE4),i.bindTexture(i.TEXTURE_2D,this.contaminationTex_B.texId)),ae.bindAttribute(i,a.posBuffer,t.attribLocations.a_pos,2),i.drawArrays(i.TRIANGLES,0,6),dn._swapTextures(this.waterFluxTexA_HIGH,this.waterFluxTexB_HIGH),dn._swapTextures(this.waterFluxTexA_LOW,this.waterFluxTexB_LOW),o.bind(),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.waterHeightTexA.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,this.waterVelocityTexA.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,this.contaminationTex_A.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.COLOR_ATTACHMENT1_WEBGL,n.COLOR_ATTACHMENT2_WEBGL,n.NONE]),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),t=e.postFxShadersManager.getShader("waterCalculateVelocity"),e.postFxShadersManager.useProgram(t),i.uniform2fv(t.u_simulationTextureSize_loc,r.simulationTextureSize),i.uniform2fv(t.u_terrainTextureSize_loc,r.terrainTextureSize),i.uniform1f(t.u_timestep_loc,r.simulationTimeStep),i.uniform1f(t.u_PipeArea_loc,.8),i.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),i.uniform1f(t.u_waterMaxHeigh_loc,r.waterMaxHeight),i.uniform1f(t.u_waterMaxFlux_loc,r.waterMaxFlux),i.uniform2fv(t.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),i.uniform1f(t.u_waterMaxVelocity_loc,r.waterMaxVelocity),i.uniform1f(t.u_contaminantMaxHeigh_loc,r.contaminantMaxheight),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.waterHeightTexB.texId),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.demWithBuildingsTex.texId),i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.waterFluxTexB_HIGH.texId),i.activeTexture(i.TEXTURE3),i.bindTexture(i.TEXTURE_2D,this.waterFluxTexB_LOW.texId),r.contaminantMaxheight>0&&(i.activeTexture(i.TEXTURE4),i.bindTexture(i.TEXTURE_2D,this.contaminationTex_B.texId)),ae.bindAttribute(i,a.posBuffer,t.attribLocations.a_pos,2),i.drawArrays(i.TRIANGLES,0,6),dn._swapTextures(this.waterHeightTexA,this.waterHeightTexB),dn._swapTextures(this.waterVelocityTexA,this.waterVelocityTexB),dn._swapTextures(this.contaminationTex_A,this.contaminationTex_B),r.bRenderParticles&&this.doSimulationSteps_particles(e);for(var l=0;l<8;l++)i.activeTexture(i.TEXTURE0+l),i.bindTexture(i.TEXTURE_2D,null);i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.NONE,n.NONE,n.NONE])}},dn.prototype.doSimulationSteps_landSlide=function(e){var t,r=e.getGl(),i=this.waterManager.fbo,o=i.extbuffers,n=this.waterManager.getQuadBuffer(),a=this.waterManager;this.copyTexture(this.dem_texture_A,[this.dem_texture_B],!1),r.disable(r.BLEND),i.bind(),r.viewport(0,0,i.width[0],i.height[0]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.terrainMaxSlippageTex.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.NONE,o.NONE]),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),t=e.postFxShadersManager.getShader("waterCalculateTerrainMaxSlippage"),e.postFxShadersManager.useProgram(t),r.uniform2fv(t.u_simulationTextureSize_loc,a.simulationTextureSize),r.uniform2fv(t.u_terrainTextureSize_loc,a.terrainTextureSize),r.uniform1f(t.u_timestep_loc,a.simulationTimeStep),r.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.dem_texture_A.texId),r.disable(r.DEPTH_TEST),ae.bindAttribute(r,n.posBuffer,t.a_pos,2),r.drawArrays(r.TRIANGLES,0,6),r.enable(r.DEPTH_TEST),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.terrainFluxTexA_HIGH.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.terrainFluxTexA_LOW.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,this.shaderLogTex_Flux_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.COLOR_ATTACHMENT2_WEBGL,o.NONE]),t=e.postFxShadersManager.getShader("waterCalculateTerrainFlux"),e.postFxShadersManager.useProgram(t),r.uniform2fv(t.u_simulationTextureSize_loc,a.simulationTextureSize),r.uniform2fv(t.u_terrainTextureSize_loc,a.terrainTextureSize),r.uniform1f(t.u_timestep_loc,a.simulationTimeStep),r.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),r.uniform1f(t.u_terrainMaxFlux_loc,this.terrainMaxFlux),r.uniform2fv(t.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.dem_texture_A.texId),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.terrainMaxSlippageTex.texId),ae.bindAttribute(r,n.posBuffer,t.a_pos,2),r.drawArrays(r.TRIANGLES,0,6),dn._swapTextures(this.terrainFluxTexA_HIGH,this.terrainFluxTexB_HIGH),dn._swapTextures(this.terrainFluxTexA_LOW,this.terrainFluxTexB_LOW),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.dem_texture_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.NONE,o.NONE]),t=e.postFxShadersManager.getShader("waterCalculateTerrainHeightByFlux"),e.postFxShadersManager.useProgram(t),r.uniform2fv(t.u_simulationTextureSize_loc,a.simulationTextureSize),r.uniform2fv(t.u_terrainTextureSize_loc,a.terrainTextureSize),r.uniform1f(t.u_timestep_loc,a.simulationTimeStep),r.uniform2fv(t.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),r.uniform1f(t.u_terrainMaxFlux_loc,this.terrainMaxFlux),r.uniform2fv(t.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.dem_texture_B.texId),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.terrainFluxTexB_HIGH.texId),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,this.terrainFluxTexB_LOW.texId),ae.bindAttribute(r,n.posBuffer,t.a_pos,2),r.drawArrays(r.TRIANGLES,0,6)},dn.prototype.doSimulationSteps_particles=function(e){var t,r=e.getGl(),i=this.waterManager.windParticlesPosFbo,o=i.extbuffers,n=this.waterManager.getQuadBuffer();i.bind(),r.viewport(0,0,i.width[0],i.height[0]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.particlesPosTex_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,this.shaderLogParticlesPos_TexA.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.COLOR_ATTACHMENT1_WEBGL,o.NONE,o.NONE]),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),t=e.postFxShadersManager.getShader("waterParticlesUpdate"),e.postFxShadersManager.useProgram(t);var a=this.geographicExtent.minGeographicCoord,s=this.geographicExtent.maxGeographicCoord;r.uniform1i(t.u_flipTexCoordY_windMap_loc,!0),r.uniform2fv(t.u_wind_res_loc,[this.windRes,this.windRes]),r.uniform2fv(t.u_wind_min_loc,[0,0]),r.uniform2fv(t.u_wind_max_loc,[40,40]),r.uniform3fv(t.u_geoCoordRadiansMax_loc,[s.getLongitudeRad(),s.getLatitudeRad(),0]),r.uniform3fv(t.u_geoCoordRadiansMin_loc,[a.getLongitudeRad(),a.getLatitudeRad(),0]),r.uniform1f(t.u_speed_factor_loc,.6),r.uniform1f(t.u_drop_rate_loc,this.waterManager.dropRate),r.uniform1f(t.u_drop_rate_bump_loc,this.waterManager.dropRateBump);var l=Math.random();r.uniform1f(t.u_rand_seed_loc,l),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.particlesPosTex_B.texId),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.waterVelocityTexB.texId),r.enableVertexAttribArray(t.attribLocations.a_pos),ae.bindAttribute(r,n.posBuffer,t.attribLocations.a_pos,2),r.drawArrays(r.TRIANGLES,0,6),dn._swapTextures(this.particlesPosTex_A,this.particlesPosTex_B),r.disable(r.DEPTH_TEST),(i=this.waterManager.windParticlesRenderingFbo).bind(),r.viewport(0,0,i.width[0],i.height[0]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.particlesTex_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.NONE,o.NONE,o.NONE]),t=e.postFxShadersManager.getShader("waterParticlesRenderFade"),e.postFxShadersManager.useProgram(t),r.uniform1f(t.u_opacity_loc,.99),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.particlesTex_B.texId),r.enableVertexAttribArray(t.attribLocations.a_pos),ae.bindAttribute(r,n.posBuffer,t.attribLocations.a_pos,2),r.drawArrays(r.TRIANGLES,0,6),o=(i=this.waterManager.windParticlesRenderingFbo).extbuffers,i.bind(),r.viewport(0,0,i.width[0],i.height[0]),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT0_WEBGL,r.TEXTURE_2D,this.particlesTex_A.texId,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.NONE,o.NONE,o.NONE]),t=e.postFxShadersManager.getShader("waterParticlesRender"),e.postFxShadersManager.useProgram(t),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,this.particlesPosTex_B.texId),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,this.waterVelocityTexB.texId),r.enableVertexAttribArray(t.attribLocations.a_index),ae.bindAttribute(r,this.waterManager.particleIndexBuffer,t.attribLocations.a_index,1),r.uniform1i(t.u_colorScale_loc,!1),r.uniform1f(t.u_particles_res_loc,this.waterManager.windRes),r.uniform2fv(t.u_wind_min_loc,[0,0]),r.uniform2fv(t.u_wind_max_loc,[40,40]),r.uniform1i(t.u_flipTexCoordY_windMap_loc,this.flipTexCoordsY_windMap),r.drawArrays(r.POINTS,0,this.waterManager.numParticles),dn._swapTextures(this.particlesTex_A,this.particlesTex_B),r.enable(r.DEPTH_TEST)},dn.prototype.renderTerrain=function(e,t){if(this.isPrepared()){if(!this.prepareTextures())return!1;var r=this.waterManager,i=t.sceneState;e=t.postFxShadersManager.getShader("terrainRender");if(t.postFxShadersManager.useProgram(e),e.bindUniformGenerals(),void 0===this.vbo_vicks_container){this.vbo_vicks_container=new xt;var o=this.vbo_vicks_container.newVBOVertexIdxCacheKey();o.setDataArrayPos(this.posBuffer,t.vboMemoryManager),o.setDataArrayTexCoord(this.texCoordBuffer,t.vboMemoryManager)}var n=t.getGl();n.uniform3fv(e.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(e.buildingPosLOW_loc,this.terrainPositionLOW),n.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.buildingGeoLocMat._floatArrays),n.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),n.uniform2fv(e.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),n.uniform2fv(e.u_simulationTextureSize_loc,r.simulationTextureSize),n.uniform2fv(e.u_terrainTextureSize_loc,r.terrainTextureSize),n.uniform1i(e.uFrustumIdx_loc,t.currentFrustumIdx),n.uniform2fv(e.u_quantizedVolume_MinMax_loc,this.quantizedVolumeMinMaxHeights),n.uniform2fv(e.u_screenSize_loc,[i.drawingBufferWidth[0],i.drawingBufferHeight[0]]),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this.waterHeightTexA.texId),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this.dem_texture_A.texId),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,this.original_dem_texture.texId),n.activeTexture(n.TEXTURE3),n.bindTexture(n.TEXTURE_2D,this.dem_withExcavation.texId);var a=this.vbo_vicks_container.vboCacheKeysArray[0],s=a.vertexCount;if(!a.bindDataPosition(e,t.vboMemoryManager))return!1;if(!a.bindDataTexCoord(e,t.vboMemoryManager))return!1;n.drawArrays(n.TRIANGLES,0,s);for(var l=0;l<3;l++)n.activeTexture(n.TEXTURE0+l),n.bindTexture(n.TEXTURE_2D,null)}},dn.prototype.renderWaterDepth=function(e,t){if(this.isPrepared()){if(!this.prepareTextures())return!1;if(void 0===this.vbo_vicks_container){this.vbo_vicks_container=new xt;var r=this.vbo_vicks_container.newVBOVertexIdxCacheKey();r.setDataArrayPos(this.posBuffer,t.vboMemoryManager),r.setDataArrayTexCoord(this.texCoordBuffer,t.vboMemoryManager)}var i=t.getGl();i.uniform3fv(e.buildingPosHIGH_loc,this.terrainPositionHIGH),i.uniform3fv(e.buildingPosLOW_loc,this.terrainPositionLOW),i.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),i.uniform1f(e.u_waterMaxHeigh_loc,waterManager.waterMaxHeight),i.uniform1f(e.u_contaminantMaxHeigh_loc,waterManager.contaminantMaxheight),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.waterHeightTexA.texId),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,this.demWithBuildingsTex.texId),waterManager.contaminantMaxheight>0&&(i.activeTexture(i.TEXTURE2),i.bindTexture(i.TEXTURE_2D,this.contaminationTex_B.texId));var o=this.vbo_vicks_container.vboCacheKeysArray[0],n=o.vertexCount;if(!o.bindDataPosition(e,t.vboMemoryManager))return!1;if(!o.bindDataTexCoord(e,t.vboMemoryManager))return!1;i.disable(i.BLEND),i.drawArrays(i.TRIANGLES,0,n);for(var a=0;a<3;a++)i.activeTexture(i.TEXTURE0+a),i.bindTexture(i.TEXTURE_2D,null)}},dn.prototype.resetObjectIdDemOverWrited=function(){this.buildingsId_OverWritedOnDemMap={};this.copyTexture(this.dem_texture_A,[this.demWithBuildingsTex],!1)},dn.prototype._isObjectIdDemOverWrited=function(e){return!!this.buildingsId_OverWritedOnDemMap&&this.buildingsId_OverWritedOnDemMap.hasOwnProperty(e)},dn.prototype.getBoundingSphereWC=function(){if(!this._BSphereWC){var e=this.waterManager.magoManager;this._BSphereWC=Ke.computeSphereExtent(e,this.geographicExtent.minGeographicCoord,this.geographicExtent.maxGeographicCoord,void 0)}return this._BSphereWC},dn.prototype.doIntersectedObjectsCulling=function(e,t){this.cullingUpdatedTime||(this.cullingUpdatedTime=0);var r=0,i=0;e&&(r=e.length),t&&(i=t.length);var o,n,a,s=this.getBoundingSphereWC();this.visibleObjectsControler||(this.visibleObjectsControler=new _t);for(var l=0;l<r;l++)o=e[l],this._isObjectIdDemOverWrited(o._guid)||(n=o.getBoundingSphereWC(n),s.intersectionSphere(n)!==F.INTERSECTION_OUTSIDE&&this.visibleObjectsControler.currentVisibles0.push(o));this.buildingsId_OverWritedOnDemMap||(this.buildingsId_OverWritedOnDemMap={});for(l=0;l<i;l++)"contaminationGenerator"!==(a=t[l]).name&&"excavationObject"!==a.name&&"waterGenerator"!==a.name&&(this._isObjectIdDemOverWrited(a._guid)||(n=a.getBoundingSphereWC(n),s.intersectionSphere(n)!==F.INTERSECTION_OUTSIDE&&this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.push(a)));return this.bIntersectionCulling=!0,!0},dn.prototype.getTileOrthographic_mvpMat=function(){if(!this.tileOrthoModelViewProjMatrix){var e=this.geographicExtent.minGeographicCoord.longitude,t=this.geographicExtent.minGeographicCoord.latitude,r=this.terrainMinMaxHeights[0],i=this.geographicExtent.maxGeographicCoord.longitude,o=this.geographicExtent.maxGeographicCoord.latitude,n=this.terrainMinMaxHeights[1],a=(e+i)/2,s=(t+o)/2,l=(r+n)/2,u=i-e,c=o-t,d=n-r,h=-u/2,f=u/2,g=-c/2,p=c/2,m=-d/2,v=d/2,x=new Ne;x._floatArrays=glMatrix.mat4.ortho(x._floatArrays,h,f,g,p,5*m,5*v);var _=new Ne;_.setTranslation(a,s,l);var y=new Ne;y._floatArrays=glMatrix.mat4.invert(y._floatArrays,_._floatArrays),this.tileOrthoModelViewProjMatrix=new Ne,this.tileOrthoModelViewProjMatrix=y.getMultipliedByMatrix(x,this.tileOrthoModelViewProjMatrix)}return this.tileOrthoModelViewProjMatrix},dn.prototype.makeWaterAndContaminationSourceTex=function(e){if(this.isPrepared()){if(!this.prepareTextures())return!1;var t,r=this.getTileOrthographic_mvpMat(),i=(this.waterManager.getQuadBuffer(),e.getGl()),o=this.waterManager.fbo,n=o.extbuffers;i.disable(i.BLEND),i.disable(i.DEPTH_TEST),i.clearColor(0,0,0,0),i.clearDepth(1),o.bind(),i.viewport(0,0,o.width[0],o.height[0]),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.contaminantSourceTex.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.NONE,n.NONE,n.NONE]),e.isFarestFrustum()&&i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),t=e.postFxShadersManager.getShader("waterOrthogonalContamination"),e.postFxShadersManager.useProgram(t),t.bindUniformGenerals(),i.uniformMatrix4fv(t.u_modelViewProjectionMatrix_loc,!1,r._floatArrays),i.uniform3fv(t.aditionalMov_loc,[0,0,0]),i.uniform4fv(t.u_color4_loc,[0,.5,.6,1]),i.uniform1f(t.u_fluidMaxHeigh_loc,100),i.uniform1f(t.u_fluidHeigh_loc,.2),i.disable(i.CULL_FACE),e.isFarestFrustum()&&i.clear(i.DEPTH_BUFFER_BIT);for(var a=0,s=void 0,l=this.waterManager.getContaminationObjectsArray(),u=l.length,c=0;c<u;c++){l[c].render(e,t,a,s)}i.enable(i.CULL_FACE),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT0_WEBGL,i.TEXTURE_2D,this.waterAditionTex.texId,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,n.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,null,0),n.drawBuffersWEBGL([n.COLOR_ATTACHMENT0_WEBGL,n.NONE,n.NONE,n.NONE]),e.isFarestFrustum()&&i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),i.uniform1f(t.u_fluidMaxHeigh_loc,100),i.uniform1f(t.u_fluidHeigh_loc,3),i.disable(i.CULL_FACE),e.isFarestFrustum()&&i.clear(i.DEPTH_BUFFER_BIT);a=0,s=void 0;var d=this.waterManager.getWaterSourceObjectsArray(),h=d.length;for(c=0;c<h;c++){d[c].render(e,t,a,s)}i.enable(i.CULL_FACE),i.enable(i.DEPTH_TEST)}},dn.prototype.copyTexture=function(e,t,r,i){var o=this.waterManager.magoManager,n=this.waterManager.getQuadBuffer(),a=o.getGl();i||(i=this.waterManager.fbo);var s,l=i.extbuffers,u=t[0];i.bind(),a.viewport(0,0,i.width[0],i.height[0]),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT0_WEBGL,a.TEXTURE_2D,u.texId,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT1_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT2_WEBGL,a.TEXTURE_2D,null,0),a.framebufferTexture2D(a.FRAMEBUFFER,l.COLOR_ATTACHMENT3_WEBGL,a.TEXTURE_2D,null,0),l.drawBuffersWEBGL([l.COLOR_ATTACHMENT0_WEBGL,l.NONE,l.NONE,l.NONE]),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,e.texId),a.disable(a.BLEND),a.disable(a.DEPTH_TEST),s=o.postFxShadersManager.getShader("waterCopyTexture"),o.postFxShadersManager.useProgram(s),s.bindUniformGenerals(),a.uniform1i(s.u_textureFlipYAxis_loc,r),ae.bindAttribute(a,n.posBuffer,s.attribLocations.a_pos,2),a.drawArrays(a.TRIANGLES,0,6),a.enable(a.BLEND),a.enable(a.DEPTH_TEST),a.activeTexture(a.TEXTURE0),a.bindTexture(a.TEXTURE_2D,null),i.unbind()},dn.prototype.excavationDEM=function(e,t){if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;this.visibleObjectsControler.currentVisibles0.length;var r=this.getTileOrthographic_mvpMat(),i=this.waterManager,o=(this.waterManager.getQuadBuffer(),t.getGl()),n=this.waterManager.fbo,a=n.extbuffers;if(t.isFarestFrustum()){var s=!0;this.copyTexture(this.original_dem_texture,[this.dem_texture_A],s)}o.disable(o.BLEND),o.clearColor(0,1,0,0),o.clearDepth(1),n.bind(),o.viewport(0,0,n.width[0],n.height[0]),o.framebufferTexture2D(o.FRAMEBUFFER,a.COLOR_ATTACHMENT0_WEBGL,o.TEXTURE_2D,this.dem_texture_A.texId,0),o.framebufferTexture2D(o.FRAMEBUFFER,a.COLOR_ATTACHMENT1_WEBGL,o.TEXTURE_2D,null,0),o.framebufferTexture2D(o.FRAMEBUFFER,a.COLOR_ATTACHMENT2_WEBGL,o.TEXTURE_2D,null,0),o.framebufferTexture2D(o.FRAMEBUFFER,a.COLOR_ATTACHMENT3_WEBGL,o.TEXTURE_2D,null,0),a.drawBuffersWEBGL([a.COLOR_ATTACHMENT0_WEBGL,a.NONE,a.NONE,a.NONE]),e=t.postFxShadersManager.getShader("waterOrthogonalDepthRender"),t.postFxShadersManager.useProgram(e),e.bindUniformGenerals(),o.uniformMatrix4fv(e.u_modelViewProjectionMatrix_loc,!1,r._floatArrays),o.uniform3fv(e.aditionalMov_loc,[0,0,0]),o.uniform4fv(e.u_color4_loc,[1,0,0,1]),o.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),o.uniform2fv(e.u_simulationTextureSize_loc,i.simulationTextureSize),o.uniform1i(e.u_processType_loc,1),o.disable(o.CULL_FACE),o.clear(o.DEPTH_BUFFER_BIT),o.frontFace(o.CW);for(var l=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,u=0;u<l;u++){"excavationObject"===(d=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray[u]).name&&(d.render(t,e,0,void 0),d.setDeleted(!0))}var c=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length;for(u=0;u<c;u++){var d;"excavationObject"===(d=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray[u]).name&&(d.render(t,e,0,void 0),d.setDeleted(!0))}if(n.unbind(),o.enable(o.CULL_FACE),o.activeTexture(o.TEXTURE0),o.bindTexture(o.TEXTURE_2D,null),o.frontFace(o.CCW),t.isFarestFrustum()){s=!1;this.copyTexture(this.dem_texture_A,[this.dem_withExcavation],s)}}},dn.prototype.overWriteDEMWithObjects=function(e,t){if(this.visibleObjectsControler&&this.isPrepared()){if(!this.prepareTextures())return!1;this.buildingsId_OverWritedOnDemMap||(this.buildingsId_OverWritedOnDemMap={});var r=this.visibleObjectsControler.currentVisibles0.length,i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,n=this.getTileOrthographic_mvpMat(),a=this.waterManager,s=t.getGl(),l=this.waterManager.fbo,u=l.extbuffers;if(void 0===this.demTexCopied_toDemWithBuildingsTex&&(this.demTexCopied_toDemWithBuildingsTex=!1),!this.demTexCopied_toDemWithBuildingsTex&&t.isFarestFrustum()){this.copyTexture(this.dem_texture_A,[this.demWithBuildingsTex],!1),this.demTexCopied_toDemWithBuildingsTex=!0}l.bind(),s.viewport(0,0,l.width[0],l.height[0]),s.framebufferTexture2D(s.FRAMEBUFFER,u.COLOR_ATTACHMENT0_WEBGL,s.TEXTURE_2D,this.demWithBuildingsTex.texId,0),s.framebufferTexture2D(s.FRAMEBUFFER,u.COLOR_ATTACHMENT1_WEBGL,s.TEXTURE_2D,null,0),s.framebufferTexture2D(s.FRAMEBUFFER,u.COLOR_ATTACHMENT2_WEBGL,s.TEXTURE_2D,null,0),s.framebufferTexture2D(s.FRAMEBUFFER,u.COLOR_ATTACHMENT3_WEBGL,s.TEXTURE_2D,null,0),u.drawBuffersWEBGL([u.COLOR_ATTACHMENT0_WEBGL,u.NONE,u.NONE,u.NONE]),s.disable(s.BLEND),s.clearColor(1,0,0,0),s.clearDepth(1),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.dem_texture_A.texId),e=t.postFxShadersManager.getShader("waterOrthogonalDepthRender"),t.postFxShadersManager.useProgram(e),e.bindUniformGenerals(),s.uniformMatrix4fv(e.u_modelViewProjectionMatrix_loc,!1,n._floatArrays),s.uniform3fv(e.aditionalMov_loc,[0,0,0]),s.uniform4fv(e.u_color4_loc,[1,0,0,1]),s.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),s.uniform2fv(e.u_simulationTextureSize_loc,a.simulationTextureSize),s.uniform1i(e.u_terrainHeightEncodingBytes_loc,a.terrainHeightEncodingBytes),s.uniform1i(e.u_processType_loc,0),s.disable(s.CULL_FACE);var c=0;for(var d in this.buildingsId_OverWritedOnDemMap)if(this.buildingsId_OverWritedOnDemMap.hasOwnProperty(d)){++c;break}0===c&&s.clear(s.DEPTH_BUFFER_BIT);for(var h=0;h<r;h++){var f=this.visibleObjectsControler.currentVisibles0[h],g=f.renderContent(t,e,0,0);g>=0&&g<6&&(this.buildingsId_OverWritedOnDemMap[f._guid]=f)}for(i=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray.length,h=0;h<i;h++){"contaminationGenerator"!==(p=this.visibleObjectsControler.currentVisibleNativeObjects.opaquesArray[h]).name&&"excavationObject"!==p.name&&"waterGenerator"!==p.name&&p.render(t,e,0,void 0)&&(this.buildingsId_OverWritedOnDemMap[p._guid]=p)}for(o=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray.length,h=0;h<o;h++){var p;"contaminationGenerator"!==(p=this.visibleObjectsControler.currentVisibleNativeObjects.transparentsArray[h]).name&&"excavationObject"!==p.name&&"waterGenerator"!==p.name&&p.render(t,e,0,void 0)&&(this.buildingsId_OverWritedOnDemMap[p._guid]=p)}s.enable(s.CULL_FACE),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.frontFace(s.CCW)}},dn.prototype._renderQMesh=function(e){if(this.qMeshVboKeyContainer){var t=(e=this.waterManager.magoManager).vboMemoryManager,r=e.getGl(),i=e.postFxShadersManager.getShader("qMeshRenderTEST");e.postFxShadersManager.useProgram(i),i.bindUniformGenerals(),r.uniform4fv(i.u_oneColor4_loc,[1,.5,.25,1]),r.uniform3fv(i.buildingPosHIGH_loc,this.terrainPositionHIGH),r.uniform3fv(i.buildingPosLOW_loc,this.terrainPositionLOW),r.uniformMatrix4fv(i.buildingRotMatrix_loc,!1,this.buildingGeoLocMat._floatArrays);var o=(u=this.qMeshVboKeyContainer.vboCacheKeysArray[0]).vertexCount;u.vboBufferPos.bindData(i,i.attribLocations.a_pos,t),u.vboBufferCol&&u.vboBufferCol.bindData(i,i.color4_loc,t);var n=u.indicesCount;if(!u.bindDataIndice(i,e.vboMemoryManager))return!1;var a,s=n/3;if(!this.randomColorsArray){this.randomColorsArray=[];for(var l=0;l<s;l++)this.randomColorsArray.push([.5*Math.random(),.5*Math.random(),.5*Math.random(),1])}r.uniform1i(i.colorType_loc,1);for(l=0;l<s;l++)a=3*l*2,r.uniform4fv(i.u_oneColor4_loc,this.randomColorsArray[l]),r.drawElements(r.TRIANGLES,3,r.UNSIGNED_SHORT,a);var u;o=(u=this.qMeshVboKeyContainer.vboCacheKeysArray[1]).vertexCount;u.vboBufferPos.bindData(i,i.attribLocations.a_pos,t),r.drawArrays(r.TRIANGLE_STRIP,0,o)}},dn.prototype.renderWater=function(e,t){if(this.isPrepared()){if(!this.prepareTextures())return!1;var r=this.waterManager;if(void 0===this.vbo_vicks_container){this.vbo_vicks_container=new xt;var i=this.vbo_vicks_container.newVBOVertexIdxCacheKey();i.setDataArrayPos(this.posBuffer,t.vboMemoryManager),i.setDataArrayTexCoord(this.texCoordBuffer,t.vboMemoryManager)}var o=0;r.bRenderParticles&&(o=3);var n=t.getGl(),a=this.waterManager.magoManager.sceneState;n.uniform3fv(e.buildingPosHIGH_loc,this.terrainPositionHIGH),n.uniform3fv(e.buildingPosLOW_loc,this.terrainPositionLOW),n.uniformMatrix4fv(e.buildingRotMatrix_loc,!1,this.buildingGeoLocMat._floatArrays),n.uniform2fv(e.u_heightMap_MinMax_loc,this.terrainMinMaxHeights),n.uniform2fv(e.u_screenSize_loc,[a.drawingBufferWidth[0],a.drawingBufferHeight[0]]),n.uniform1i(e.uWaterType_loc,o),n.uniform1f(e.u_waterMaxHeigh_loc,r.waterMaxHeight),n.uniform1f(e.u_contaminantMaxHeigh_loc,r.contaminantMaxheight),n.uniform2fv(e.u_tileSize_loc,[this.tileSizeMeters_x,this.tileSizeMeters_y]),n.uniform2fv(e.u_simulationTextureSize_loc,r.simulationTextureSize),n.uniform2fv(e.u_terrainTextureSize_loc,r.terrainTextureSize),n.uniform1f(e.uMinWaterHeightToRender_loc,r.minWaterHeightToRender),n.uniform1f(e.u_waterRenderingHeightOffset_loc,r.waterRenderingHeightOffset);var s=a.getProjectionMatrixInv();n.uniformMatrix4fv(e.projectionMatrixInv_loc,!1,s._floatArrays),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,null),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this.waterHeightTexA.texId),n.activeTexture(n.TEXTURE2),n.bindTexture(n.TEXTURE_2D,this.demWithBuildingsTex.texId),r.bRenderParticles&&(n.activeTexture(n.TEXTURE3),n.bindTexture(n.TEXTURE_2D,this.particlesTex_A.texId)),r.contaminantMaxheight>0&&(n.activeTexture(n.TEXTURE4),n.bindTexture(n.TEXTURE_2D,this.contaminationTex_B.texId));var l=this.vbo_vicks_container.vboCacheKeysArray[0],u=l.vertexCount;if(!l.bindDataPosition(e,t.vboMemoryManager))return!1;if(!l.bindDataTexCoord(e,t.vboMemoryManager))return!1;n.enable(n.BLEND),n.drawArrays(n.TRIANGLES,0,u),n.disable(n.BLEND);for(var c=0;c<5;c++)n.activeTexture(n.TEXTURE0+c),n.bindTexture(n.TEXTURE_2D,null)}},dn.prototype._makeSurface=function(){var e=this.waterManager.simulationTextureSize[0],t=this.waterManager.simulationTextureSize[1],r=0,i=Math.PI/180,o=this.geographicExtent.minGeographicCoord.longitude*i,n=this.geographicExtent.minGeographicCoord.latitude*i,a=this.geographicExtent.maxGeographicCoord.longitude*i,s=this.geographicExtent.maxGeographicCoord.latitude*i,l=a-o,u=s-n,c=(this.depth,l/e),d=u/t,h=(e+1)*(t+1),f=new Array(h),g=new Array(h),p=new Array(h);this.texCoordsArray=new Float32Array(2*h);var m,v,x=o,_=n,y=0,T=0;r&&(T=r);for(var C=0;C<t+1;C++){(_=n+d*C)>s&&(_=s);for(var b=0;b<e+1;b++)(x=o+c*b)>a&&(x=a),f[y]=x,g[y]=_,p[y]=T,m=(x-o)/l,v=(_-n)/u,this.texCoordsArray[2*y]=m,this.texCoordsArray[2*y+1]=v,y++}if(!this.cartesiansArray){var M=f.length;this.cartesiansArray=new Array(M)}this.cartesiansArray=Te.geographicRadianArrayToFloat32ArrayWgs84(f,g,p,this.cartesiansArray),this.normalsArray=new Int8Array(3*h);for(var A=new Jr,E=0;E<h;E++)A.set(this.cartesiansArray[3*E],this.cartesiansArray[3*E+1],this.cartesiansArray[3*E+2]),A.unitary(),this.normalsArray[3*E]=126*A.x,this.normalsArray[3*E+1]=126*A.y,this.normalsArray[3*E+2]=126*A.z;var L=e+1,w=t+1,S=en.getIndicesTrianglesRegularNet(L,w,void 0,void 0,void 0,void 0,void 0,{bCalculateBorderIndices:!0,indicesByteSize:4});this.indices=S.indicesArray,this.southIndices=S.southIndicesArray,this.eastIndices=S.eastIndicesArray,this.northIndices=S.northIndicesArray,this.westIndices=S.westIndicesArray,this.westVertexCount=this.westIndices.length,this.southVertexCount=this.southIndices.length,this.eastVertexCount=this.eastIndices.length,this.northVertexCount=this.northIndices.length;r=0;var D,R,P=(D=this.geographicExtent.getMidPoint(D)).longitude,I=D.latitude;R=Te.geographicToCartesianWgs84(P,I,r,R),this.centerX=new Float64Array([R[0]]),this.centerY=new Float64Array([R[1]]),this.centerZ=new Float64Array([R[2]]);var F=this.indices.length,O=new Float32Array(3*F),B=new Float32Array(2*F);for(E=0;E<F;E++)y=this.indices[E],O[3*E]=this.cartesiansArray[3*y]-this.centerX[0],O[3*E+1]=this.cartesiansArray[3*y+1]-this.centerY[0],O[3*E+2]=this.cartesiansArray[3*y+2]-this.centerZ[0],B[2*E]=this.texCoordsArray[2*y],B[2*E+1]=this.texCoordsArray[2*y+1];this.surface=!0,this.posBuffer=O,this.texCoordBuffer=B,void 0===this.terrainPositionHIGH&&(this.terrainPositionHIGH=new Float32Array(3)),void 0===this.terrainPositionLOW&&(this.terrainPositionLOW=new Float32Array(3)),on.calculateSplited3fv([this.centerX[0],this.centerY[0],this.centerZ[0]],this.terrainPositionHIGH,this.terrainPositionLOW),this.buildingGeoLocMat=new Ne,this.buildingGeoLocMat._floatArrays=Te.transformMatrixAtCartesianPointWgs84(this.centerX[0],this.centerY[0],this.centerZ[0],this.buildingGeoLocMat._floatArrays),this.buildingGeoLocMat._floatArrays[12]=0,this.buildingGeoLocMat._floatArrays[13]=0,this.buildingGeoLocMat._floatArrays[14]=0};var hn=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.waterLayersArray=[],this.magoManager=t,this.simulationGeoExtent,this.simulationTileDepth,this.terrainDemSourceType="QUANTIZEDMESH",this.terrainProvider=this.magoManager.scene.globe.terrainProvider,this.fbo,this.currTimeSeconds,this.lastTimeSeconds,this.timeScale=1,this.maxSimulationSize=2048,this.simulationTextureSize=new Float32Array([this.maxSimulationSize,this.maxSimulationSize]),this.bSsimulateWater=!1,this.terrainTextureSize=new Float32Array([this.maxSimulationSize,this.maxSimulationSize]),this.terrainHeightEncodingBytes=4,this.waterMaxHeight=500,this.waterMaxFlux=2e3,this.waterMaxVelocity=400,this.contaminantMaxheight=50,this.simulationTimeStep=.08,this.simulationTimeStep=.05,this.minWaterHeightToRender=.02,this.waterRenderingHeightOffset=.7,this.bRenderParticles=!0,this.windParticlesPosFbo,this.windRes=64,this.dropRate=.003,this.dropRateBump=.001,this.rainType=0,this.rainValue_mmHour=300,this.bSimulateTerrainSlippage=!1,this.bExistPendentExcavation=!1,this.bDoLandSlideSimulation=!1,r&&(r.simulationGeographicExtent&&(this.simulationGeoExtent=r.simulationGeographicExtent),r.terrainDemSourceType&&(this.terrainDemSourceType=r.terrainDemSourceType),r.terrainProvider&&(this.terrainProvider=r.terrainProvider),void 0!==r.renderParticles&&(this.bRenderParticles=r.renderParticles),void 0!==r.rainType&&(this.rainType=r.rainType),void 0!==r.rainValue_mmHour&&(this.rainValue_mmHour=r.rainValue_mmHour),void 0!==r.waterSourceUrl&&(this.waterSourceUrl=r.waterSourceUrl),void 0!==r.maxSimulationTextureSize&&(this.maxSimulationSize=r.maxSimulationTextureSize),void 0!==r.terrainHeightEncodingBytes&&(this.terrainHeightEncodingBytes=r.terrainHeightEncodingBytes),void 0!==r.minWaterHeightToRender&&(this.minWaterHeightToRender=r.minWaterHeightToRender),void 0!==r.waterRenderingHeightOffset&&(this.waterRenderingHeightOffset=r.waterRenderingHeightOffset),void 0!==r.rainValue_mmHour&&(this.rainValue_mmHour=r.rainValue_mmHour)),this.createDefaultShaders(),this.init()};hn.prototype.setSimulationSettings=function(e){void 0!==e&&(void 0!==e.waterMaxHeight&&(this.waterMaxHeight=e.waterMaxHeight),void 0!==e.waterMaxFlux&&(this.waterMaxFlux=e.waterMaxFlux),void 0!==e.waterMaxVelocity&&(this.waterMaxVelocity=e.waterMaxVelocity),void 0!==e.contaminantMaxheight&&(this.contaminantMaxheight=e.contaminantMaxheight),void 0!==e.simulationTimeStep&&(this.simulationTimeStep=e.simulationTimeStep),void 0!==e.minWaterHeightToRender&&(this.minWaterHeightToRender=e.minWaterHeightToRender),void 0!==e.waterRenderingHeightOffset&&(this.waterRenderingHeightOffset=e.waterRenderingHeightOffset))},hn.prototype.setCurrentTimeSeconds=function(e){this.lastTimeSeconds=this.currTimeSeconds,this.currTimeSeconds=e},hn.prototype.getIncrementTimeSeconds=function(){return(this.currTimeSeconds-this.lastTimeSeconds)*this.timeScale},hn.prototype.setDoLandSlideSimulation=function(e){this.bDoLandSlideSimulation=e},hn.prototype.newWater=function(e){var t=new dn(this,e);return t.windRes=this.windRes,this.waterLayersArray.push(t),t},hn.prototype.init=function(){var e=this.simulationGeoExtent,t=e.getLongitudeArcDistance(),r=e.getLatitudeArcDistance(),i=this.maxSimulationSize;t>r?(this.simulationTextureSize[0]=i,this.simulationTextureSize[1]=Math.floor(i*(r/t))):(this.simulationTextureSize[0]=Math.floor(i*(t/r)),this.simulationTextureSize[1]=i),this.terrainTextureSize[0]=this.simulationTextureSize[0],this.terrainTextureSize[1]=this.simulationTextureSize[1];var o=this.magoManager,n=this.magoManager.getGl();if(!this.fbo){var a=this.simulationTextureSize[0],s=this.simulationTextureSize[1],l=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.fbo=new ae(n,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:3})}if(!this.terrainTexFbo){a=this.terrainTextureSize[0],s=this.terrainTextureSize[1],l=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.terrainTexFbo=new ae(n,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:3})}if(!this.depthFbo){var u=(o=this.magoManager).sceneState;a=u.drawingBufferWidth[0],s=u.drawingBufferHeight[0],l=o.postFxShadersManager.bUseMultiRenderTarget;this.depthFbo=new ae(n,a,s,{matchCanvasSize:!0,multiRenderTarget:l,numColorBuffers:3})}this.numParticles=this.windRes*this.windRes;for(var c=new Float32Array(this.numParticles),d=0;d<this.numParticles;d++)c[d]=d;if(this.particleIndexBuffer=ae.createBuffer(n,c),this.particlesRenderTexWidth=2048,this.particlesRenderTexHeight=2048,!this.windParticlesPosFbo){a=this.windRes,s=this.windRes,l=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.windParticlesPosFbo=new ae(n,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:1})}if(!this.windParticlesRenderingFbo){a=this.particlesRenderTexWidth,s=this.particlesRenderTexHeight,l=this.magoManager.postFxShadersManager.bUseMultiRenderTarget;this.windParticlesRenderingFbo=new ae(n,a,s,{matchCanvasSize:!1,multiRenderTarget:l,numColorBuffers:3})}var h={geographicExtent:this.simulationGeoExtent};this.waterSourceUrl&&(h.waterSourceUrl=this.waterSourceUrl);this.newWater(h)},hn.prototype.start=function(){this.bSsimulateWater=!0},hn.prototype.stop=function(){this.bSsimulateWater=!1},hn.prototype.createDefaultShaders=function(){var e=this.magoManager,t=e.getGl(),r="USE_LINEAR_DEPTH",i="NO_USE_MULTI_RENDER_TARGET";t.getParameter(t.VERSION);e.isCesiumGlobe()||(t.getSupportedExtensions().indexOf("EXT_frag_depth")>-1&&t.getExtension("EXT_frag_depth"),e.EXTENSIONS_init=!0,r="USE_LOGARITHMIC_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!0);if(e.postFxShadersManager.bUseMultiRenderTarget=!1,t.getSupportedExtensions().indexOf("WEBGL_draw_buffers")>-1){t.getExtension("WEBGL_draw_buffers");e.postFxShadersManager.bUseMultiRenderTarget=!0,i="USE_MULTI_RENDER_TARGET"}window.navigator.userAgent.indexOf("Trident")>-1&&(r="USE_LINEAR_DEPTH",e.postFxShadersManager.bUseLogarithmicDepth=!1);var o="waterRender",n=Bo.waterRenderVS;a=(a=(a=Bo.waterRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).hightmap_loc=t.getUniformLocation(s.program,"waterHeightTex"),s.terrainmap_loc=t.getUniformLocation(s.program,"terrainmap"),s.waterTex_loc=t.getUniformLocation(s.program,"waterTex"),s.contaminantHeightTex_loc=t.getUniformLocation(s.program,"contaminantHeightTex"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.uWaterType_loc=t.getUniformLocation(s.program,"uWaterType"),s.u_waterMaxHeigh_loc=t.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_RenderParticles_loc=t.getUniformLocation(s.program,"u_RenderParticles"),s.u_contaminantMaxHeigh_loc=t.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.u_tileSize_loc=t.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=t.getUniformLocation(s.program,"u_terrainTextureSize"),s.uMinWaterHeightToRender_loc=t.getUniformLocation(s.program,"uMinWaterHeightToRender"),s.u_waterRenderingHeightOffset_loc=t.getUniformLocation(s.program,"u_waterRenderingHeightOffset"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.hightmap_loc,1),t.uniform1i(s.terrainmap_loc,2),t.uniform1i(s.waterTex_loc,3),t.uniform1i(s.contaminantHeightTex_loc,4);o="waterDepthRender",n=Bo.waterDepthRenderVS;a=(a=(a=Bo.waterDepthRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).hightmap_loc=t.getUniformLocation(s.program,"waterHeightTex"),s.terrainmap_loc=t.getUniformLocation(s.program,"terrainmap"),s.contaminantHeightTex_loc=t.getUniformLocation(s.program,"contaminantHeightTex"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxHeigh_loc=t.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_contaminantMaxHeigh_loc=t.getUniformLocation(s.program,"u_contaminantMaxHeigh"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.hightmap_loc,0),t.uniform1i(s.terrainmap_loc,1),t.uniform1i(s.contaminantHeightTex_loc,2);o="terrainRender",n=Bo.waterSimTerrainRenderVS;a=(a=(a=Bo.waterSimTerrainRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_tileSize_loc=t.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.uFrustumIdx_loc=t.getUniformLocation(s.program,"uFrustumIdx"),s.u_terrainTextureSize_loc=t.getUniformLocation(s.program,"u_terrainTextureSize"),s.hightmap_loc=t.getUniformLocation(s.program,"hightmap"),s.terrainmap_loc=t.getUniformLocation(s.program,"terrainmap"),s.difusseTex_loc=t.getUniformLocation(s.program,"diffuseTex"),s.terrainMapToCompare_loc=t.getUniformLocation(s.program,"terrainMapToCompare"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.hightmap_loc,0),t.uniform1i(s.terrainmap_loc,1),t.uniform1i(s.difusseTex_loc,2),t.uniform1i(s.terrainMapToCompare_loc,3),o="waterCalculateHeight",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCalculateHeightFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_existRain_loc=t.getUniformLocation(s.program,"u_existRain"),s.u_waterMaxHeigh_loc=t.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_contaminantMaxHeigh_loc=t.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.u_increTimeSeconds_loc=t.getUniformLocation(s.program,"u_increTimeSeconds"),s.u_rainType_loc=t.getUniformLocation(s.program,"u_rainType"),s.u_rainValue_mmHour_loc=t.getUniformLocation(s.program,"u_rainValue_mmHour"),s.waterSourceTex_loc=t.getUniformLocation(s.program,"waterSourceTex"),s.contaminantSourceTex_loc=t.getUniformLocation(s.program,"contaminantSourceTex"),s.rainTex_loc=t.getUniformLocation(s.program,"rainTex"),s.currWaterHeightTex_loc=t.getUniformLocation(s.program,"currWaterHeightTex"),s.currContaminationHeightTex_loc=t.getUniformLocation(s.program,"currContaminationHeightTex"),s.waterAditionTex_loc=t.getUniformLocation(s.program,"waterAditionTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.waterSourceTex_loc,0),t.uniform1i(s.rainTex_loc,1),t.uniform1i(s.currWaterHeightTex_loc,2),t.uniform1i(s.contaminantSourceTex_loc,3),t.uniform1i(s.currContaminationHeightTex_loc,4),t.uniform1i(s.waterAditionTex_loc,5),o="waterCalculateFlux",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCalculateFluxFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_timestep_loc=t.getUniformLocation(s.program,"u_timestep"),s.u_PipeArea_loc=t.getUniformLocation(s.program,"u_PipeArea"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxHeigh_loc=t.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_waterMaxFlux_loc=t.getUniformLocation(s.program,"u_waterMaxFlux"),s.u_tileSize_loc=t.getUniformLocation(s.program,"u_tileSize"),s.u_terrainHeightEncodingBytes_loc=t.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=t.getUniformLocation(s.program,"u_terrainTextureSize"),s.u_contaminantMaxHeigh_loc=t.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.waterHeightTex_loc=t.getUniformLocation(s.program,"waterHeightTex"),s.terrainHeightTex_loc=t.getUniformLocation(s.program,"terrainHeightTex"),s.currWaterFluxTex_HIGH_loc=t.getUniformLocation(s.program,"currWaterFluxTex_HIGH"),s.currWaterFluxTex_LOW_loc=t.getUniformLocation(s.program,"currWaterFluxTex_LOW"),s.contaminantHeightTex_loc=t.getUniformLocation(s.program,"contaminantHeightTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.waterHeightTex_loc,0),t.uniform1i(s.terrainHeightTex_loc,1),t.uniform1i(s.currWaterFluxTex_HIGH_loc,2),t.uniform1i(s.currWaterFluxTex_LOW_loc,3),t.uniform1i(s.contaminantHeightTex_loc,4),o="waterCalculateVelocity",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCalculateVelocityFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_timestep_loc=t.getUniformLocation(s.program,"u_timestep"),s.u_PipeArea_loc=t.getUniformLocation(s.program,"u_PipeArea"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxHeigh_loc=t.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_waterMaxFlux_loc=t.getUniformLocation(s.program,"u_waterMaxFlux"),s.u_tileSize_loc=t.getUniformLocation(s.program,"u_tileSize"),s.u_waterMaxVelocity_loc=t.getUniformLocation(s.program,"u_waterMaxVelocity"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=t.getUniformLocation(s.program,"u_terrainTextureSize"),s.u_contaminantMaxHeigh_loc=t.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.waterHeightTex_loc=t.getUniformLocation(s.program,"waterHeightTex"),s.terrainHeightTex_loc=t.getUniformLocation(s.program,"terrainHeightTex"),s.currWaterFluxTex_loc=t.getUniformLocation(s.program,"currWaterFluxTex"),s.currWaterFluxTex_HIGH_loc=t.getUniformLocation(s.program,"currWaterFluxTex_HIGH"),s.currWaterFluxTex_LOW_loc=t.getUniformLocation(s.program,"currWaterFluxTex_LOW"),s.contaminantHeightTex_loc=t.getUniformLocation(s.program,"contaminantHeightTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.waterHeightTex_loc,0),t.uniform1i(s.terrainHeightTex_loc,1),t.uniform1i(s.currWaterFluxTex_HIGH_loc,2),t.uniform1i(s.currWaterFluxTex_LOW_loc,3),t.uniform1i(s.contaminantHeightTex_loc,4),o="waterCalculateTerrainMaxSlippage",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCalculateTerrainMaxSlippageFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_timestep_loc=t.getUniformLocation(s.program,"u_timestep"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxFlux_loc=t.getUniformLocation(s.program,"u_terrainMaxFlux"),s.u_tileSize_loc=t.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=t.getUniformLocation(s.program,"u_terrainTextureSize"),s.terrainHeightTex_loc=t.getUniformLocation(s.program,"terrainHeightTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.terrainHeightTex_loc,0),o="waterCalculateTerrainFlux",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCalculateTerrainFluxFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_timestep_loc=t.getUniformLocation(s.program,"u_timestep"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_terrainMaxFlux_loc=t.getUniformLocation(s.program,"u_terrainMaxFlux"),s.u_tileSize_loc=t.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=t.getUniformLocation(s.program,"u_terrainTextureSize"),s.terrainHeightTex_loc=t.getUniformLocation(s.program,"terrainHeightTex"),s.terrainMaxSlippageTex_loc=t.getUniformLocation(s.program,"terrainMaxSlippageTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.terrainHeightTex_loc,0),t.uniform1i(s.terrainMaxSlippageTex_loc,1),o="waterCalculateTerrainHeightByFlux",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCalculateTerrainHeightByFluxFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_timestep_loc=t.getUniformLocation(s.program,"u_timestep"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_terrainMaxFlux_loc=t.getUniformLocation(s.program,"u_terrainMaxFlux"),s.u_tileSize_loc=t.getUniformLocation(s.program,"u_tileSize"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainTextureSize_loc=t.getUniformLocation(s.program,"u_terrainTextureSize"),s.terrainHeightTex_loc=t.getUniformLocation(s.program,"terrainHeightTex"),s.terrainFluxTex_HIGH_loc=t.getUniformLocation(s.program,"terrainFluxTex_HIGH"),s.terrainFluxTex_LOW_loc=t.getUniformLocation(s.program,"terrainFluxTex_LOW"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.terrainHeightTex_loc,0),t.uniform1i(s.terrainFluxTex_HIGH_loc,1),t.uniform1i(s.terrainFluxTex_LOW_loc,2),o="waterCalculateSediment",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCalculateSedimentFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).waterHeightTex_loc=t.getUniformLocation(s.program,"waterHeightTex"),s.terrainHeightTex_loc=t.getUniformLocation(s.program,"terrainHeightTex"),s.currWaterFluxTex_loc=t.getUniformLocation(s.program,"currWaterFluxTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.waterHeightTex_loc,0),t.uniform1i(s.terrainHeightTex_loc,1),t.uniform1i(s.currWaterFluxTex_loc,2),o="waterCalculateContamination",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCalculateContaminationFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_waterMaxHeigh_loc=t.getUniformLocation(s.program,"u_waterMaxHeigh"),s.u_waterMaxFlux_loc=t.getUniformLocation(s.program,"u_waterMaxFlux"),s.u_tileSize_loc=t.getUniformLocation(s.program,"u_tileSize"),s.u_waterMaxVelocity_loc=t.getUniformLocation(s.program,"u_waterMaxVelocity"),s.u_contaminantMaxHeigh_loc=t.getUniformLocation(s.program,"u_contaminantMaxHeigh"),s.waterHeightTex_loc=t.getUniformLocation(s.program,"waterHeightTex"),s.terrainHeightTex_loc=t.getUniformLocation(s.program,"terrainHeightTex"),s.currWaterFluxTex_loc=t.getUniformLocation(s.program,"currWaterFluxTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.waterHeightTex_loc,0),t.uniform1i(s.terrainHeightTex_loc,1),t.uniform1i(s.currWaterFluxTex_loc,2),o="waterOrthogonalDepthRender",n=Bo.WaterOrthogonalDepthShaderVS,a=(a=(a=Bo.WaterOrthogonalDepthShaderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=t.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=t.getUniformLocation(s.program,"u_color4"),s.u_heightMap_MinMax_loc=t.getUniformLocation(s.program,"u_heightMap_MinMax"),s.u_simulationTextureSize_loc=t.getUniformLocation(s.program,"u_simulationTextureSize"),s.u_terrainHeightEncodingBytes_loc=t.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_processType_loc=t.getUniformLocation(s.program,"u_processType"),s.currDEMTex_loc=t.getUniformLocation(s.program,"currDEMTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.currDEMTex_loc,0),o="waterOrthogonalContamination",n=Bo.WaterOrthogonalDepthShaderVS,a=(a=(a=Bo.waterCalculateHeightContaminationFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_modelViewProjectionMatrix_loc=t.getUniformLocation(s.program,"modelViewProjectionMatrix"),s.u_fluidMaxHeigh_loc=t.getUniformLocation(s.program,"u_fluidMaxHeigh"),s.u_fluidHeigh_loc=t.getUniformLocation(s.program,"u_fluidHeigh"),s.u_screenSize_loc=t.getUniformLocation(s.program,"u_screenSize"),s.u_color4_loc=t.getUniformLocation(s.program,"u_color4"),s.currDEMTex_loc=t.getUniformLocation(s.program,"currDEMTex"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.currDEMTex_loc,0),o="waterCopyTexture",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterCopyFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).texToCopy_loc=t.getUniformLocation(s.program,"texToCopy"),s.u_textureFlipYAxis_loc=t.getUniformLocation(s.program,"u_textureFlipYAxis"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.texToCopy_loc,0),o="waterParticlesUpdate",n=Bo.waterQuadVertVS,a=(a=(a=Bo.waterUpdateParticlesFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_particles_loc=t.getUniformLocation(s.program,"u_particles"),s.u_wind_loc=t.getUniformLocation(s.program,"u_wind"),s.u_flipTexCoordY_windMap_loc=t.getUniformLocation(s.program,"u_flipTexCoordY_windMap"),s.u_wind_res_loc=t.getUniformLocation(s.program,"u_wind_res"),s.u_wind_min_loc=t.getUniformLocation(s.program,"u_wind_min"),s.u_wind_max_loc=t.getUniformLocation(s.program,"u_wind_max"),s.u_geoCoordRadiansMax_loc=t.getUniformLocation(s.program,"u_geoCoordRadiansMax"),s.u_geoCoordRadiansMin_loc=t.getUniformLocation(s.program,"u_geoCoordRadiansMin"),s.u_speed_factor_loc=t.getUniformLocation(s.program,"u_speed_factor"),s.u_drop_rate_loc=t.getUniformLocation(s.program,"u_drop_rate"),s.u_drop_rate_bump_loc=t.getUniformLocation(s.program,"u_drop_rate_bump"),s.u_rand_seed_loc=t.getUniformLocation(s.program,"u_rand_seed"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.u_particles_loc,0),t.uniform1i(s.u_wind_loc,1),o="waterParticlesRender",n=Bo.waterParticlesRenderVS,a=(a=(a=Bo.waterParticlesRenderFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_particles_loc=t.getUniformLocation(s.program,"u_particles"),s.u_wind_loc=t.getUniformLocation(s.program,"u_wind"),s.u_particles_res_loc=t.getUniformLocation(s.program,"u_particles_res"),s.u_flipTexCoordY_windMap_loc=t.getUniformLocation(s.program,"u_flipTexCoordY_windMap"),s.u_wind_min_loc=t.getUniformLocation(s.program,"u_wind_min"),s.u_wind_max_loc=t.getUniformLocation(s.program,"u_wind_max"),s.u_colorScale_loc=t.getUniformLocation(s.program,"u_colorScale"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.u_particles_loc,0),t.uniform1i(s.u_wind_loc,1),o="waterParticlesRenderFade",n=Bo.waterQuadVertVS,a=Bo.waterParticlesRenderingFadeFS,(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_screen_loc=t.getUniformLocation(s.program,"u_screen"),s.u_opacity_loc=t.getUniformLocation(s.program,"u_opacity"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.u_screen_loc,0);var a,s;o="depthTexFromQuantizedMesh",n=Bo.waterQuantizedMeshVS;a=(a=(a=Bo.waterDEMTexFromQuantizedMeshFS).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).position3_loc=t.getAttribLocation(s.program,"a_pos"),s.color4_loc=t.getAttribLocation(s.program,"color4"),s.u_minMaxHeights_loc=t.getUniformLocation(s.program,"u_minMaxHeights"),s.colorType_loc=t.getUniformLocation(s.program,"colorType"),s.u_oneColor4_loc=t.getUniformLocation(s.program,"u_oneColor4"),s.u_terrainHeightEncodingBytes_loc=t.getUniformLocation(s.program,"u_terrainHeightEncodingBytes"),s.u_flipTexCoordY_loc=t.getUniformLocation(s.program,"u_flipTexCoordY"),s.u_totalMinGeoCoord_loc=t.getUniformLocation(s.program,"u_totalMinGeoCoord"),s.u_totalMaxGeoCoord_loc=t.getUniformLocation(s.program,"u_totalMaxGeoCoord"),s.u_currentMinGeoCoord_loc=t.getUniformLocation(s.program,"u_currentMinGeoCoord"),s.u_currentMaxGeoCoord_loc=t.getUniformLocation(s.program,"u_currentMaxGeoCoord"),e.postFxShadersManager.useProgram(s),o="qMeshRenderTEST",n=Bo.waterQuantizedMeshVS_3D_TEST,a=(a=(a=Bo.waterQuantizedMeshFS_3D_TEST).replace(/%USE_LOGARITHMIC_DEPTH%/g,r)).replace(/%USE_MULTI_RENDER_TARGET%/g,i),(s=e.postFxShadersManager.createShaderProgram(t,n,a,o,this.magoManager)).u_screen_loc=t.getUniformLocation(s.program,"u_screen"),s.u_opacity_loc=t.getUniformLocation(s.program,"u_opacity"),s.colorType_loc=t.getUniformLocation(s.program,"colorType"),s.u_oneColor4_loc=t.getUniformLocation(s.program,"u_oneColor4"),e.postFxShadersManager.useProgram(s),t.uniform1i(s.u_screen_loc,0)},hn.prototype.getQuadBuffer=function(){if(!this.screenQuad){var e=this.magoManager.getGl(),t=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),r=ae.createBuffer(e,t);this.screenQuad={posBuffer:r}}return this.screenQuad},hn.prototype._newTexture=function(e,t,r){var i=e.LINEAR,o=new Uint8Array(t*r*4),n=it.createTexture(e,i,o,t,r),a=new it;return a.texId=n,a.imageWidth=t,a.imageHeight=r,a.fileLoadState=I.fileLoadState.BINDING_FINISHED,a},hn.prototype.doIntersectedObjectsCulling=function(e,t){var r,i=this.magoManager.isFarestFrustum(),o=this.waterLayersArray.length;if(i)for(var n=0;n<o;n++)(r=this.waterLayersArray[n]).visibleObjectsControler&&r.visibleObjectsControler.clear();for(n=0;n<o;n++)(r=this.waterLayersArray[n]).doIntersectedObjectsCulling(e,t);this.bObjectsCulling=!0},hn.prototype.makeWaterAndContaminationSourceTex=function(){for(var e=this.waterLayersArray.length,t=this.magoManager,r=0;r<e;r++)this.waterLayersArray[r].makeWaterAndContaminationSourceTex(t)},hn.prototype.doExcavationDEM=function(){for(var e=this.waterLayersArray.length,t=this.magoManager,r=0;r<e;r++)this.waterLayersArray[r].excavationDEM(void 0,t)},hn.prototype.overWriteDEMWithObjects=function(){for(var e=this.waterLayersArray.length,t=this.magoManager,r=0;r<e;r++)this.waterLayersArray[r].overWriteDEMWithObjects(void 0,t)},hn.prototype.renderTerrain=function(){var e=this.magoManager,t=this.waterLayersArray.length,r=e.postFxShadersManager.getShader("terrainRender");e.postFxShadersManager.useProgram(r),r.bindUniformGenerals();for(var i=0;i<t;i++)this.waterLayersArray[i].renderTerrain(r,e)},hn.prototype._TEST_renderQMesh=function(){for(var e=this.magoManager,t=this.waterLayersArray.length,r=0;r<t;r++)this.waterLayersArray[r]._renderQMesh(e)},hn.prototype.setExistPendentExcavation=function(e){this.bExistPendentExcavation=e},hn.prototype.setTrrainDiffuseTextureIdx=function(e){for(var t,r=this.waterLayersArray.length,i=0;i<r;i++)t=this.waterLayersArray[i],dn._swapTextures(t.terrainDiffTex,t.terrainDiffTex2)},hn.prototype.render=function(){var e=this.magoManager,t=e.sceneState,r=e.getGl();e.isFarestFrustum()&&this.setCurrentTimeSeconds(e.getCurrentTime()/1e3),this.bExistPendentExcavation&&(this.doExcavationDEM(),0===this.magoManager.currentFrustumIdx&&(this.bExistPendentExcavation=!1)),this.bSsimulateWater&&(this.overWriteDEMWithObjects(),this.makeWaterAndContaminationSourceTex(),0===this.magoManager.currentFrustumIdx&&this.doSimulation());var i,o=this.waterLayersArray.length;e.bindMainFramebuffer(),r.viewport(0,0,t.drawingBufferWidth[0],t.drawingBufferHeight[0]),i=e.postFxShadersManager.getShader("waterRender"),e.postFxShadersManager.useProgram(i),i.bindUniformGenerals();r.uniform1i(i.textureFlipYAxis_loc,!1),i.enableVertexAttribArray(i.position3_loc),i.enableVertexAttribArray(i.texCoord2_loc),r.uniform1i(i.colorType_loc,2),r.uniform1i(i.u_RenderParticles_loc,1),r.enable(r.DEPTH_TEST);for(var n=0;n<o;n++)this.waterLayersArray[n].renderWater(i,e)},hn.prototype.getContaminationObjectsArray=function(){return this._contaminationBoxesArray||(this._contaminationBoxesArray=[]),this._contaminationBoxesArray},hn.prototype.getWaterSourceObjectsArray=function(){return this._waterSourceObjectsArray||(this._waterSourceObjectsArray=[]),this._waterSourceObjectsArray},hn.prototype.addObject=function(e,t){if(!(e instanceof r))return!1;var i=["waterGenerator","contaminationGenerator"].indexOf(e.name);if(!e.name||i<0)return!1;(0===i?this.getWaterSourceObjectsArray():this.getContaminationObjectsArray()).push(e),t=t||5,this.magoManager.modeler.addObject(e,t)},hn.prototype.removeObject=function(e){var t=function(t){return t!==e};if(!(e instanceof r))return!1;var i=["waterGenerator","contaminationGenerator"].indexOf(e.name);if(!e.name||i<0)return!1;0===i?this._waterSourceObjectsArray=this._waterSourceObjectsArray.filter(t):this._contaminationBoxesArray=this._contaminationBoxesArray.filter(t),this.magoManager.modeler.removeObject(e)},hn.prototype.getExcavationObjectsArray=function(){return this._excavationObjectsArray||(this._excavationObjectsArray=[]),this._excavationObjectsArray},hn.prototype._loadQuantizedMesh=function(e,t,r,i){var o=this;if(this.qMeshesPromisesMap||(this.qMeshesPromisesMap={}),this.qMeshesPromisesMap[e]&&this.qMeshesPromisesMap[e][t]&&this.qMeshesPromisesMap[e][t][r])return!1;this.qMeshesPromisesMap[e]||(this.qMeshesPromisesMap[e]={}),this.qMeshesPromisesMap[e][t]||(this.qMeshesPromisesMap[e][t]={}),this.qMeshesPromisesMap[e][t][r]||(this.qMeshesPromisesMap[e][t][r]={}),this.qMeshesPromisesMap[e][t][r]=this.terrainProvider.requestTileGeometry(t,r,e),this.qMeshesPromisesMap[e][t][r].then(function(i){o.qMeshesMap[e]||(o.qMeshesMap[e]={}),o.qMeshesMap[e][t]||(o.qMeshesMap[e][t]={}),o.qMeshesMap[e][t][r]||(o.qMeshesMap[e][t][r]={}),o.qMeshesMap[e][t][r]=i,o.qMeshesMap[e][t][r].tileIndices={L:e,X:t,Y:r}})},hn.prototype.getQuantizedMesh=function(e,t,r,i){this.qMeshesMap||(this.qMeshesMap={});if(this.qMeshesMap[e]&&this.qMeshesMap[e][t]&&this.qMeshesMap[e][t][r])return this.qMeshesMap[e][t][r];this._loadQuantizedMesh(e,t,r,i)},hn.prototype.test__createExcavationBox=function(e){var t=new pe(127.21537,35.61202,80),r=new qi(300,300,400,"excavationObject");r.setGeographicPosition(t,0,0,0),r.attributes.isMovable=!0,r.setOneColor(.8,.8,.2,1),r.options={};return e.modeler.addObject(r,6),this.getExcavationObjectsArray().push(r),!0},hn.prototype.test__createContaminationBox=function(e){var t=127.21537,r=35.61202,i=10,o=10,n=200,a="contaminationGenerator",s=new pe(t,r,200),l=new qi(i,o,n,a);l.setGeographicPosition(s,0,0,0),l.attributes.isMovable=!0,l.setOneColor(1,.5,.2,1),l.options={};var u=6;e.modeler.addObject(l,u),this.getContaminationObjectsArray().push(l),i=20,o=20,n=200;return a="waterGenerator",s=new pe(t=127.21049,r=35.60385,300),(l=new qi(i,o,n,a)).setGeographicPosition(s,0,0,0),l.attributes.isMovable=!0,l.setOneColor(.2,.5,1,1),l.options={},u=6,e.modeler.addObject(l,u),this.getWaterSourceObjectsArray().push(l),a="waterGenerator",s=new pe(t=127.21592,r=35.61843,300),(l=new qi(i,o,n,a)).setGeographicPosition(s,0,0,0),l.attributes.isMovable=!0,l.setOneColor(.2,.5,1,1),l.options={},u=6,e.modeler.addObject(l,u),this.getWaterSourceObjectsArray().push(l),a="waterGenerator",s=new pe(t=127.21673,r=35.6046,300),(l=new qi(i,o,n,a)).setGeographicPosition(s,0,0,0),l.attributes.isMovable=!0,l.setOneColor(.2,.5,1,1),l.options={},u=6,e.modeler.addObject(l,u),this.getWaterSourceObjectsArray().push(l),!0},hn.prototype.test__createContaminationBox_sejong=function(e){var t=20,r=20,i=200,o="contaminationGenerator",n=new pe(127.23257,36.51568,200),a=new qi(t,r,i,o);a.setGeographicPosition(n,0,0,0),a.attributes.isMovable=!0,a.setOneColor(1,.5,.2,1),a.options={};var s=6;e.modeler.addObject(a,s),this.getContaminationObjectsArray().push(a),t=20,r=20,t=50,r=50,i=400;return o="waterGenerator",n=new pe(127.182017,37.616451,50),(a=new qi(t,r,i,o)).setGeographicPosition(n,0,0,0),a.attributes.isMovable=!0,a.setOneColor(.2,.5,1,1),a.options={},s=6,e.modeler.addObject(a,s),this.getWaterSourceObjectsArray().push(a),127.21592,35.61843,o="waterGenerator",n=new pe(126.88789,37.34314,50),(a=new qi(t,r,i,o)).setGeographicPosition(n,0,0,0),a.attributes.isMovable=!0,a.setOneColor(.2,.5,1,1),a.options={},s=6,e.modeler.addObject(a,s),this.getWaterSourceObjectsArray().push(a),127.21673,35.6046,o="waterGenerator",n=new pe(126.8965,37.35525,50),(a=new qi(t,r,i,o)).setGeographicPosition(n,0,0,0),a.attributes.isMovable=!0,a.setOneColor(.2,.5,1,1),a.options={},s=6,e.modeler.addObject(a,s),this.getWaterSourceObjectsArray().push(a),!0},hn.prototype.deleteObjects=function(){for(var e=this.waterLayersArray.length,t=0;t<e;t++)this.waterLayersArray[t].deleteObjects(),this.waterLayersArray[t]=void 0;this.waterLayersArray.length=0},hn.prototype.resetSimulation=function(){for(var e=this.waterLayersArray.length,t=0;t<e;t++)this.waterLayersArray[t].resetSimulation()},hn.prototype.objectDeleted=function(e){for(var t,r=this.waterLayersArray.length,i=0;i<r;i++)(t=this.waterLayersArray[i])._isObjectIdDemOverWrited(e)&&t.resetObjectIdDemOverWrited()},hn.prototype.objectMoved=function(e){for(var t,r=this.waterLayersArray.length,i=0;i<r;i++)if((t=this.waterLayersArray[i])._isObjectIdDemOverWrited(e._guid))t.resetObjectIdDemOverWrited();else{var o=t.getBoundingSphereWC(),n=e.getBoundingSphereWC(void 0);o.intersectionSphere(n)!==F.INTERSECTION_OUTSIDE&&t.resetObjectIdDemOverWrited()}},hn.prototype.doSimulation=function(){for(var e,t=this.waterLayersArray.length,r=0;r<t;r++){e=this.waterLayersArray[r];for(var i=0;i<1;i++)e.doSimulationSteps(this.magoManager)}},hn.prototype._test_water=function(){var e={geographicExtent:new xe(127.196678737,35.59728252,0,127.228314058,35.627702394,0)};this.newWater(e);this.testStarted=!0};var fn=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._year=2023,this._month=0,this._day=1,this._hour=0,this._minute=0,this._second=0,this._milisecond=0,this._animationState=I.processState.NO_STARTED,this._animationStartUnixTimeMilisec=0,this._currentUnixTimeMilisec=0,this._timeScale=1,this._date,this._incrementalAddingTimeMilisec=0,this.setOptions(t)};fn.prototype.setOptions=function(e){void 0!==e&&(void 0!==e.year&&(this._year=e.year),void 0!==e.month&&(this._month=e.month),void 0!==e.day&&(this._day=e.day),void 0!==e.hour&&(this._hour=e.hour),void 0!==e.minute&&(this._minute=e.minute),void 0!==e.second&&(this._second=e.second),void 0!==e.milisecond&&(this._milisecond=e.milisecond),void 0!==e.timeScale&&(this._timeScale=e.timeScale),void 0!==e.incrementalAddingTimeMilisec&&(this._incrementalAddingTimeMilisec=e.incrementalAddingTimeMilisec)),this.calculateAnimationStartUnixTimeMilisec()},fn.prototype.calculateAnimationStartUnixTimeMilisec=function(){var e=new Date(this._year,this._month-1,this._day,this._hour,this._minute,this._second,this._milisecond);this._animationStartUnixTimeMilisec=e.getTime(),this._currentUnixTimeMilisec=this._animationStartUnixTimeMilisec},fn.prototype.switchPlayPause=function(){this._animationState===I.processState.STARTED?this._animationState=I.processState.PAUSED:this._animationState===I.processState.PAUSED&&(this._animationState=I.processState.STARTED)},fn.prototype.reset=function(e){this._animationState=I.processState.NO_STARTED,this.setOptions(e)},fn.prototype.getCurrentTimeMilisec=function(){return this._currentUnixTimeMilisec},fn.prototype.getCurrentUnixTimeMilisec=function(){return this._currentUnixTimeMilisec},fn.prototype.setCurrentTimeMilisec=function(e){this._currentTimeMilisec=e},fn.prototype.incrementCurrentTime=function(e){this._animationState===I.processState.STARTED&&this._animationState!==I.processState.PAUSED&&(this._incrementalAddingTimeMilisec=e,this._currentUnixTimeMilisec+=this._incrementalAddingTimeMilisec*this._timeScale)},fn.prototype.startAnimation=function(){this._animationState=I.processState.STARTED},fn.prototype.pauseAnimation=function(){this._animationState=I.processState.PAUSED},fn.prototype.getAnimationState=function(){return this._animationState};var gn=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.weatherStation,this.gl,this.dustMapTexture,this.dustMapJson,this.dustMapFileName,this.dustMapJsonFileLoadState=I.fileLoadState.READY,this.dustMapFolderPath,this.dustData,this.dustVolume,this.geoExtent,this.geoLocDataManager,void 0!==t&&(t.geoJsonFile&&(this.dustMapJson=t.geoJsonFile,this.dustMapJsonFileLoadState=I.fileLoadState.LOADING_FINISHED),t.geoJsonFileFolderPath&&(this.dustMapFolderPath=t.geoJsonFileFolderPath),void 0!==t.speedFactor&&(this.speedFactor=t.speedFactor),void 0!==t.dustMapFileName&&(this.dustMapFileName=t.dustMapFileName),void 0!==t.dustMapFolderPath&&(this.dustMapFolderPath=t.dustMapFolderPath),void 0!==t.pendentPointSize&&(this.pendentPointSize=t.pendentPointSize))};gn.prototype.getAltitude=function(){if(this.dustMapJson)return this.dustMapJson.bbox[2]},gn.prototype.deleteObjects=function(e){if(this.dustMapTexture){var t=e.getGl();this.dustMapTexture.deleteObjects(t)}this.dustMapTexture=void 0,delete this.dustMapJson,this.dustMapFileName=void 0,this.dustMapJsonFileLoadState=void 0,this.dustMapFolderPath=void 0,this.dustData=void 0,this.dustVolume=void 0,this.geoExtent&&this.geoExtent.deleteObjects(),this.geoExtent=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0},gn.prototype.prepareDustLayer=function(){if(void 0===this.gl&&(this.gl=this.dustVolume.weatherStation.magoManager.getGl()),void 0===this.dustMapTexture&&(this.dustMapTexture=new it,this.dustMapTexture.texId=this.gl.createTexture()),this.dustMapTexture.fileLoadState===I.fileLoadState.READY){if(!this.dustMapFileName){if(!this.dustMapJson)return!1;this.dustMapFileName=this.dustMapJson.properties.image.uri}this.dustMapFolderPath&&0!==this.dustMapFolderPath.length||(this.dustMapFolderPath=this.dustMapJson.properties.image.serviceUri.split(this.dustMapFileName)[0]);var e=this.dustMapFolderPath+"/"+this.dustMapFileName;return hr.loadImage(this.gl,e,this.dustMapTexture),!1}if(void 0===this.dustMapJsonFileLoadState||this.dustMapJsonFileLoadState===I.fileLoadState.READY){thisdustMapJsonFileLoadState=I.fileLoadState.LOADING_STARTED;var t=this,r=this.dustMapFolderPath+"/"+this.dustMapFileName+".json";return rn(r,void 0,void 0,"json","GET").done(function(e){t.dustMapJsonFileLoadState=I.fileLoadState.LOADING_FINISHED,t.dustMapJson=e}),!1}return!0},gn.prototype.getConcentration_biLinearInterpolation=function(e,t,r){var i=this.dustMapTexture.imageWidth,o=this.dustMapTexture.imageHeight,n=Math.floor(e*i),a=Math.floor(t*o),s=e*i,l=t*o,u=Math.ceil(1e4*(s<1?s:s%Math.floor(s)))/1e4,c=Math.ceil(1e4*(l<1?l:l%Math.floor(l)))/1e4,d=n+1<i?n+1:n,h=a+1<o?a+1:a;return(this.getConcentration(n,a,r)*(1-u)+this.getConcentration(d,a,r)*u)*(1-c)+(this.getConcentration(n,h,r)*(1-u)+this.getConcentration(d,h,r)*u)*c},gn.prototype.getMinMaxConcentration=function(){if(this.dustMapJson){var e=this.dustMapJson.properties.value;return[e.r.min,e.r.max]}},gn.prototype.getConcentration=function(e,t,r){if(this.dustMapTexture.fileLoadState!==I.fileLoadState.BINDING_FINISHED)return 0;var i=this.dustMapTexture.imageWidth,o=this.dustMapTexture.imageHeight;if(e<0&&(e=0),t<0&&(t=0),!this.dustConcentrationMap){var n=r.getGl();if(void 0===this.framebuffer&&(this.framebuffer=n.createFramebuffer()),n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,this.dustMapTexture.texId,0),n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE){var a=i*o;this.dustConcentrationMap=new Uint8Array(4*a),n.readPixels(0,0,i,o,n.RGBA,n.UNSIGNED_BYTE,this.dustConcentrationMap)}n.bindFramebuffer(n.FRAMEBUFFER,null)}var s=t*i+e,l=this.dustConcentrationMap[4*s]/255,u=(this.dustConcentrationMap[4*s+1],this.dustConcentrationMap[4*s+2],this.dustMapJson.properties.value);return u.r.min*(1-l)+u.r.max*l};var pn=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.dustLayersArray,this._dustLayersAltitudesArray,this.weatherStation,this.extrusionHeight,this.dustDisplayBox,this.dustDisplayPlane,this.dustDisplayPlanesArray=[],this._geoJsonFile,this._geoJsonFilePath,this._geoJsonFileLoadState=I.fileLoadState.READY,this._geoJsonFileFolderPath,this.particlesArray,this._animationState=1,this._particesGenerationType=1,this._particlesGeneratorBoxesArray,t&&(t.geoJsonFile&&(this._geoJsonFile=t.geoJsonFile,this._geoJsonFileLoadState=I.fileLoadState.LOADING_FINISHED),t.geoJsonFilePath&&(this._geoJsonFilePath=t.geoJsonFilePath),t.geoJsonFileFolderPath&&(this._geoJsonFileFolderPath=t.geoJsonFileFolderPath))};pn.prototype.loadDustGeoJson=function(){if(this._geoJsonFileLoadState===I.fileLoadState.READY){this._geoJsonFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._geoJsonFilePath,void 0,void 0,"json","GET").done(function(t){e._geoJsonFileLoadState=I.fileLoadState.LOADING_FINISHED,e._geoJsonFile=t})}},pn.prototype._prepareDustGeoJson=function(){return this._geoJsonFileLoadState===I.fileLoadState.READY?(this.loadDustGeoJson(),!1):this._geoJsonFileLoadState===I.fileLoadState.LOADING_FINISHED},pn.prototype.deleteObjects=function(e){if(this.dustLayersArray)for(var t=this.dustLayersArray.length,r=0;r<t;r++)this.dustLayersArray[r].deleteObjects(e),this.dustLayersArray[r]=void 0;this.dustLayersArray=void 0,this._dustLayersAltitudesArray=void 0,this.weatherStation=void 0,this.extrusionHeight=void 0;var i=e.vboMemoryManager;if(this.dustDisplayBox&&(this.dustDisplayBox.deleteObjects(i),e.modeler.removeObject(this.dustDisplayBox)),this.dustDisplayBox=void 0,this.dustDisplayPlane=void 0,this.dustDisplayPlanesArray){var o=this.dustDisplayPlanesArray.length;for(r=0;r<o;r++)this.dustDisplayPlanesArray[r].deleteObjects(i),e.modeler.removeObject(this.dustDisplayPlanesArray[r]),this.dustDisplayPlanesArray[r]=void 0}this.dustDisplayPlanesArray=void 0,this._geoJsonFile,this._geoJsonFilePath,this._geoJsonFileLoadState=I.fileLoadState.READY,this._geoJsonFileFolderPath,this.particlesArray,this._animationState=1,this._particesGenerationType=1,this._particlesGeneratorBoxesArray},pn.prototype.newDustLayer=function(e){void 0===this.dustLayersArray&&(this.dustLayersArray=[]);var t=new gn(e);return t.weatherStation=this.weatherStation,t.dustVolume=this,this.dustLayersArray.push(t),t},pn.prototype._prepareDustLayers=function(){if(!this._geoJsonFile)return!1;if(void 0===this.dustLayersArray){this.dustLayersArray=[];var e=this._geoJsonFileFolderPath,t=this._geoJsonFile.features;if((l=t.length)>0){var r;this._dustLayersAltitudesArray=new Array(l),r=t[0];var i=new G;i.initXYZData(r.bbox[0],r.bbox[1],r.bbox[2]);for(var o=0;o<l;o++){var n={geoJsonFile:r=t[o],geoJsonFileFolderPath:e},a=(this.newDustLayer(n),r.bbox);i.addXYZData(a[0],a[1],a[2]),i.addXYZData(a[3],a[4],a[5]),this._dustLayersAltitudesArray[o]=a[2]}this.geoExtent?this.geoExtent.setExtent(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ):this.geoExtent=new xe(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ)}return!1}if(!this._allDustLayersPrepared){var s=!0,l=this.dustLayersArray.length;for(o=0;o<l;o++){this.dustLayersArray[o].prepareDustLayer()||(s=!1)}return s&&(this._allDustLayersPrepared=!0),!1}return!0},pn.prototype.getGeographicExtent=function(){if(!this.geoExtent){var e=this._geoJsonFile.features,t=e.length;if(t>0){var r;r=e[0];var i=new G;i.initXYZData(r.bbox[0],r.bbox[1],r.bbox[2]);for(var o=0;o<t;o++){var n=(r=e[o]).bbox;i.addXYZData(n[0],n[1],n[2]),i.addXYZData(n[3],n[4],n[5])}this.geoExtent=new xe(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ)}}return this.geoExtent},pn.prototype.createDustDisplayBox=function(e){var t=this.getGeographicExtent();if(!t)return!1;var r=t.minGeographicCoord,i=t.maxGeographicCoord,o=r.longitude,n=i.longitude,a=r.latitude,s=i.latitude,l=r.altitude,u=i.altitude,c=new ve;c.newGeoCoord(o,a,l),c.newGeoCoord(n,a,l),c.newGeoCoord(n,s,l),c.newGeoCoord(o,s,l);var d=u-l;this.dustDisplayBox=c.getExtrudedMeshRenderableObject(d,!0,void 0,e,void 0),this.dustDisplayBox.setOneColor(.2,.7,.8,.05),this.dustDisplayBox.attributes.isMovable=!1,this.dustDisplayBox.attributes.isSelectable=!1,this.dustDisplayBox.attributes.name="dustDisplayBox",this.dustDisplayBox.attributes.selectedColor4=new J(1,0,0,0),void 0===this.dustDisplayBox.options&&(this.dustDisplayBox.options={}),this.dustDisplayBox.options.renderWireframe=!0,this.dustDisplayBox.options.renderShaded=!0,this.dustDisplayBox.options.depthMask=!1;return e.modeler.addObject(this.dustDisplayBox,4),!0},pn.prototype.createDustDisplayPlane=function(e){var t=this.getGeographicExtent();if(!t)return!1;var r=t.minGeographicCoord,i=t.maxGeographicCoord,o=r.longitude,n=i.longitude,a=r.latitude,s=i.latitude;r.altitude,i.altitude;var l=new ve;l.newGeoCoord(o,a,35),l.newGeoCoord(n,a,35),l.newGeoCoord(n,s,35),l.newGeoCoord(o,s,35);for(var u=0;u<1;u++){var c=l.getExtrudedMeshRenderableObject(.1,!0,void 0,e,void 0);this.dustDisplayPlaneForTexture=l.getRenderableObjectPolygon(void 0,void 0),c.setOneColor(.8,.7,.2,0),c.setWireframeColor(.2,.3,.4,1),c.attributes.isMovable=!0,c.attributes.movementInAxisZ=!0,c.attributes.minAltitude=this.getMinAltitude(),c.attributes.maxAltitude=this.getMaxAltitude(),c.attributes.name="dustDisplayPlane",c.attributes.selectedColor4=new J(1,0,0,0),void 0===c.options&&(c.options={}),c.options.renderWireframe=!0,c.options.renderShaded=!0,c.options.depthMask=!1;if(e.modeler.addObject(c,5),this.dustDisplayPlanesArray.push(c),this.dustDisplayPlaneForTexture)this.dustDisplayPlaneForTexture.getObject(0).calculateTexCoordsBox(void 0)}return!0},pn.prototype.getMaxAltitude=function(){var e=this.getGeographicExtent();if(e)return e.maxGeographicCoord.altitude},pn.prototype.getMinAltitude=function(){var e=this.getGeographicExtent();if(e)return e.minGeographicCoord.altitude},pn.prototype._createdElemsForDisplayBox=function(e){void 0===this.dustDisplayBox&&this.createDustDisplayBox(e)&&0===this.dustDisplayPlanesArray.length&&this.createDustDisplayPlane(e)},pn.prototype.prepareVolume=function(e){return!!this._prepareDustGeoJson()&&(!!this._prepareDustLayers()&&(void 0!==this.dustDisplayBox||(this._createdElemsForDisplayBox(e),!1)))},pn.prototype._getVolumeFrontFBO=function(e){if(!this.volumeFrontFBO){var t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.volumeFrontFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeFrontFBO},pn.prototype._getVolumeRearFBO=function(e){if(!this.volumeRearFBO){var t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.volumeRearFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeRearFBO},pn.prototype.renderDepthDustVolume=function(e){e.sceneState;var t=e.getGl(),r=e.extbuffers;if(this.visibleObjControler||(this.visibleObjControler=new _t),this.dustDisplayBox&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.dustDisplayBox),this.dustDisplayPlanesArray&&this.dustDisplayPlanesArray.length>0){var i=this.dustDisplayPlanesArray[0];this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[1]=i}var o=this._getVolumeFrontFBO(e);o.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,o.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,o.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,o.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,o.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1));var n=1;t.frontFace(t.CCW),e.renderer.renderGeometryBuffer(t,n,this.visibleObjControler),e.windVolumeFrontDepthTex=o.colorBuffersArray[1],e.windVolumeFrontNormalTex=o.colorBuffersArray[2];var a=this._getVolumeRearFBO(e);a.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,a.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,a.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,a.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,a.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1));n=1;t.frontFace(t.CW),e.renderer.renderGeometryBuffer(t,n,this.visibleObjControler),e.windVolumeRearDepthTex=a.colorBuffersArray[1],e.windVolumeRearNormalTex=a.colorBuffersArray[2],t.frontFace(t.CCW),e.bindMainFramebuffer(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,null,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.NONE,r.NONE,r.NONE])},pn.prototype._getRayIntersectionWithVolume=function(e,t,r){var i,o,n,a=r.getGl(),s=on.getRayCamSpace(e,t,void 0,r),l=this._getVolumeRearFBO(),u=l.colorBuffersArray[1],c=l.colorBuffersArray[2],d=on.calculatePixelLinearDepthV2(a,e,t,u,c,r);if(d.frustumIdx<r.numFrustums&&(i=d.linearDepth,o=d.far,d.near,n=d.normal4),!(n[0]+n[1]+n[2]<.1)){var h,f=i*o,g=new Jr(s[0]*f,s[1]*f,s[2]*f),p=this._getVolumeFrontFBO();return u=p.colorBuffersArray[1],c=p.colorBuffersArray[2],(d=on.calculatePixelLinearDepthV2(a,e,t,u,c,r)).frustumIdx<r.numFrustums&&(i=d.linearDepth,o=d.far,d.near,n=d.normal4),n[0]+n[1]+n[2]<.1?h=new Jr(0,0,0):(f=i*o,h=new Jr(s[0]*f,s[1]*f,s[2]*f)),new vi(h,g)}},pn.prototype.getDustDensityInGeographicCoord=function(e){if(e)e.altitude},pn.prototype._get2LayersInfoByAltitude=function(e){var t=Rn.binarySearch_layersByAltitude(this._dustLayersAltitudesArray,e,void 0,void 0),r=this.dustLayersArray.length;t>=r?t=r-1:t<0&&(t=0);var i=t-1<0?0:t-1,o=this.dustLayersArray[i],n=this.dustLayersArray[t],a=o.getAltitude(),s=n.getAltitude();return{idxUp:t,idxDown:i,zFactor:t===i?1:(e-a)/(s-a)}},pn.prototype._getDustConcentration=function(e,t){var r=this.getGeographicExtent();if(r.intersects2dWithGeoCoord(e)){var i=r.getMinLongitudeRad(),o=r.getMinLatitudeRad(),n=r.getMaxLongitudeRad()-i,a=r.getMaxLatitudeRad()-o,s=e.getLongitudeRad(),l=e.getLatitudeRad(),u=e.getAltitude(),c=this._get2LayersInfoByAltitude(u),d=c.zFactor,h=this.dustLayersArray[c.idxDown],f=this.dustLayersArray[c.idxUp],g=(s-i)/n,p=(l-o)/a;if(!(g>1||p>1||g<0||p<0)){f.getConcentration_biLinearInterpolation(g,p,t);var m=h.getConcentration_biLinearInterpolation(g,p,t);return m*(1-d)+m*d}}},pn.prototype.newDustParticle=function(e){var t={};t.startColor=new J(.8,1,1,1),t.endColor=new J(.8,1,1,1),t.numPoints=300;var r,i=e.sceneState,o=i.drawingBufferWidth[0],n=i.drawingBufferHeight[0];if(1===this._particesGenerationType){var a=Math.floor(Math.random()*o),s=Math.floor(Math.random()*n),l=this._getRayIntersectionWithVolume(a,s,e);if(l){var u=Math.random(),c=(l.getDirection(),l.getLength(),l.startPoint3d,new Jr(l.endPoint3d.x,l.endPoint3d.y,l.endPoint3d.z)),d=on.cameraCoordPositionToWorldCoord(c,void 0,e),h=on.pointToGeographicCoord(d,void 0),f=this._getDustConcentration(h,e);f>0&&(r={posWC:d,geoCoord:h,dustConcentration:f})}return r}this._particesGenerationType},pn.prototype.renderModeTexture=function(e){if(this.prepareVolume(e)&&this.dustDisplayPlaneForTexture&&this.dustDisplayPlanesArray){var t=e.getGl(),r=e.extbuffers;e.bindMainFramebuffer(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,e.albedoTex,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.NONE,r.NONE,r.COLOR_ATTACHMENT3_WEBGL]);var i=e.sceneState,o=e.postFxShadersManager.dustTextureModeShader;o.useProgram(),o.bindUniformGenerals(),t.uniformMatrix4fv(o.modelViewMatrix4RelToEye_loc,!1,i.modelViewRelToEyeMatrix._floatArrays),t.uniformMatrix4fv(o.modelViewProjectionMatrix4RelToEye_loc,!1,i.modelViewProjRelToEyeMatrix._floatArrays),t.uniform4fv(o.oneColor4_loc,[.3,.9,.5,1]),t.uniform1i(o.colorType_loc,0),t.uniform2fv(o.viewport_loc,[i.drawingBufferWidth[0],i.drawingBufferHeight[0]]),t.uniform1f(o.thickness_loc,2.5),t.uniform1i(o.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),t.uniform1i(o.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),t.uniform1i(o.uFrustumIdx_loc,e.currentFrustumIdx),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.disable(t.CULL_FACE),t.enable(t.BLEND),t.uniform3fv(o.cameraPosHIGH_loc,i.encodedCamPosHigh),t.uniform3fv(o.cameraPosLOW_loc,i.encodedCamPosLow),t.uniformMatrix4fv(o.buildingRotMatrix_loc,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);var n=i.camera.frustum;t.uniform1f(o.uNear_loc,n.near[0]),t.uniform1f(o.uFar_loc,n.far[0]);var a=this.dustDisplayPlanesArray[0].geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude,s=this._get2LayersInfoByAltitude(a),l=s.zFactor,u=this.dustLayersArray[s.idxDown],c=this.dustLayersArray[s.idxUp];t.uniform2fv(o.uDustConcentMinMax_up_loc,c.getMinMaxConcentration()),t.uniform2fv(o.uDustConcentMinMax_down_loc,u.getMinMaxConcentration()),t.uniform2fv(o.u_tex_res_loc,[u.dustMapTexture.imageWidth,u.dustMapTexture.imageHeight]),t.uniform1f(o.uZFactor_loc,l),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,u.dustMapTexture.texId),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,c.dustMapTexture.texId),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR);if(this.dustDisplayPlanesArray.length>0)this.dustDisplayPlanesArray[0].geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude;this.dustDisplayPlaneForTexture.render(e,o,1,void 0,!1),t.useProgram(null),t.enable(t.CULL_FACE),t.disable(t.BLEND)}},pn.prototype.renderMode3D=function(e){if(this.prepareVolume(e)){var t=this.weatherStation.getSmokeTexture();if(t){if(this.particlesArray||(this.particlesArray=[]),this.renderDepthDustVolume(e),this.particlesArray.length<3e3&&0===e.currentFrustumIdx)for(var r=0;r<3;r++){(l=this.newDustParticle(e))&&this.particlesArray.push(l)}var i=e.getGl(),o=e.extbuffers;e.bindMainFramebuffer(),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,null,0),i.framebufferTexture2D(i.FRAMEBUFFER,o.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,e.albedoTex,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.NONE,o.NONE,o.COLOR_ATTACHMENT3_WEBGL]);i=e.getGl();var n=e.sceneState,a=e.postFxShadersManager.dustParticleShader;a.useProgram(),a.bindUniformGenerals(),i.uniformMatrix4fv(a.modelViewMatrix4RelToEye_loc,!1,n.modelViewRelToEyeMatrix._floatArrays),i.uniformMatrix4fv(a.modelViewProjectionMatrix4RelToEye_loc,!1,n.modelViewProjRelToEyeMatrix._floatArrays),i.uniform4fv(a.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(a.colorType_loc,0),i.uniform2fv(a.viewport_loc,[n.drawingBufferWidth[0],n.drawingBufferHeight[0]]),i.uniform1f(a.thickness_loc,2.5),i.uniform1i(a.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(a.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),i.uniform1i(a.uFrustumIdx_loc,e.currentFrustumIdx),i.blendFunc(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA),i.disable(i.CULL_FACE),i.enable(i.BLEND),i.uniform3fv(a.cameraPosHIGH_loc,n.encodedCamPosHigh),i.uniform3fv(a.cameraPosLOW_loc,n.encodedCamPosLow),i.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),i.uniform2fv(a.uDustConcentMinMax_loc,[0,18]);var s=n.camera.frustum;i.uniform1f(a.uNear_loc,s.near[0]),i.uniform1f(a.uFar_loc,s.far[0]),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,t.texId);var l,u=this.particlesArray.length,c=(this._animationState,e.vboMemoryManager);for(r=0;r<u;r++){var d=(l=this.particlesArray[r]).vboKeysContainer,h=l.geoCoord;if(d)if(h.geoLocDataManager){var f=h.geoLocDataManager.getCurrentGeoLocationData();i.uniformMatrix4fv(a.buildingRotMatrix_loc,!1,f.rotMatrix._floatArrays),i.uniform3fv(a.buildingPosHIGH_loc,f.positionHIGH),i.uniform3fv(a.buildingPosLOW_loc,f.positionLOW),i.uniform1f(a.uDustConcentration_loc,l.dustConcentration);var g=d.vboCacheKeysArray[0];g&&g.bindDataPosition(a,c)&&i.drawArrays(i.POINTS,0,g.vertexCount)}else h.makeDefaultGeoLocationData();else{void 0===l.vboKeysContainer&&(l.vboKeysContainer=new xt);var p=new Float32Array([0,0,0]);l.vboKeysContainer.newVBOVertexIdxCacheKey().setDataArrayPos(p,c)}}i.useProgram(null),i.enable(i.CULL_FACE),i.disable(i.BLEND)}}};var mn=function(){this.dataArray,this.width,this.height,this.geographicExtent};mn.prototype.getValue=function(e,t){if(void 0!==this.dataArray&&0!==this.dataArray.length){var r=xn.getIndexOfArray(this.width,e,t);return this.dataArray[r]}},mn.prototype.setValue=function(e,t,r){if(void 0===this.dataArray||0===this.dataArray.length)return!1;var i=xn.getIndexOfArray(this.width,e,t);this.dataArray[i]=r},mn.getMinMaxValuesOfArray=function(e,t){if(void 0===e||0===e.length)return t;void 0===t&&(t=[]);var r,i,o,n=e.length;i=e[0],o=e[0];for(var a=1;a<n;a++)(r=e[a])>o?o=r:r<i&&(i=r);return t.push(i),t.push(o),t},mn.getColumn=function(e,t,r){if(void 0===r)return[];for(var i,o=e,n=t,a=0;a<o;a++)i=e.getValue(n,a),r.push(i);return r},mn.getSplittedVertical=function(e,t,r,i,o){if(void 0===e)return t;if(void 0===t)return[];var n=e.width,a=e.height,s=Math.floor(n/2),l=new mn,u=new mn,c=s+1,d=n-s;void 0===o&&(o=!1),!0===o&&(d+=1);var h,f=c*a,g=d*a;if(r&&i){var p,m,v,x,_,y,T=r.minGeographicCoord,C=r.maxGeographicCoord,b=(C.longitude-T.longitude)*(c/n),M=new xe,A=new xe;p=T.longitude,m=T.latitude,v=T.altitude,x=T.longitude+b,_=C.latitude,y=C.altitude,M.setExtent(p,m,v,x,_,y),p=T.longitude+b,m=T.latitude,v=T.altitude,x=C.longitude,_=C.latitude,y=C.altitude,A.setExtent(p,m,v,x,_,y),i.push(M),i.push(A)}l.dataArray=new Float32Array(f),l.width=c,l.height=a,u.dataArray=new Float32Array(g),u.width=d,u.height=a;for(var E=0;E<a;E++){for(var L=0;L<n;L++)h=e.getValue(L,E),L<s?l.setValue(L,E,h):L===s?(l.setValue(L,E,h),u.setValue(L-s,E,h)):u.setValue(L-s,E,h);o&&(h=e.getValue(0,E),u.setValue(u.width-1,E,h))}return t.push(l),t.push(u),t},mn.exaggerateAltitude=function(e){};var vn=function(){this.slicesArray};vn.prototype.newSlice=function(){void 0===this.slicesArray&&(this.slicesArray=[]);var e=new mn;return this.slicesArray.push(e),e},vn.prototype.getSlicesCount=function(){return void 0===this.slicesArray?0:this.slicesArray.length},vn.prototype.getSlice=function(e){if(void 0!==this.slicesArray&&!(e>=this.slicesArraylength))return this.slicesArray[e]};var xn=function(){this.stacksArray,this.numSlicesPerStack};xn.getIndexOfArray=function(e,t,r){return t+r*e},xn.getIndexOfArray3D=function(e,t,r,i,o,n,a,s){var l=s*e+o,u=a*t+n,c=i*e;return xn.getIndexOfArray(c,l,u)},xn.prototype.getStack=function(e){if(void 0!==this.stacksArray&&!(e>=this.stacksArray.length))return this.stacksArray[e]},xn.prototype.getStacksCount=function(){return void 0===this.stacksArray?0:this.stacksArray.length},xn.prototype.newStack=function(){void 0===this.stacksArray&&(this.stacksArray=[]);var e=new vn;return this.stacksArray.push(e),e},xn.prototype.reverseSlicesOfStacks=function(){if(void 0!==this.stacksArray)for(var e=this.stacksArray.length,t=0;t<e;t++){this.stacksArray[t].slicesArray.reverse()}},xn.prototype.getAnUniqueSlice=function(e){void 0===e&&(e=new mn);var t=this.stacksArray.length,r=this.stacksArray[0];void 0===this.numSlicesPerStack&&(this.numSlicesPerStack=r.slicesArray.length);var i=this.numSlicesPerStack,o=r.slicesArray[0],n=o.width,a=n*t,s=o.height*i;e.width=a,e.height=s;var l=a*s;e.dataArray=new Uint8Array(l);for(var u,c=-1,d=0;d<t;d++)for(var h=(r=this.stacksArray[d]).slicesArray.length,f=0;f<h;f++)for(var g=(o=r.slicesArray[f]).height,p=o.width,m=0;m<g;m++)for(var v=0;v<p;v++){if(v>=n-1);u=o.getValue(v,m),c=xn.getIndexOfArray3D(p,g,i,t,v,m,f,d),e.dataArray[c]=u}return e};var _n=function(){};_n.calculateNumStacks=function(e,t,r,i){var o=-1;if(t>e)return-1;for(var n=!1,a=1;!n;){if(r*Math.ceil(i/a)<e){if(n=!0,t*a>e)return-1;o=a}if(++a>=i)return-1}return o},_n.convertMonoStackImage3DToMultiStackImage3D=function(e,t,r){if(void 0!==e&&void 0!==e.stacksArray&&0!==e.stacksArray.length){void 0===t&&(t=new xn);var i=e.stacksArray[0],o=(h=i.slicesArray[0]).width,n=h.height,a=i.slicesArray.length,s=_n.calculateNumStacks(r,o,n,a),l=Math.ceil(a/s);t.numSlicesPerStack=l;var u=0,c=t.newStack();c.slicesArray=[];for(var d=0;d<a;d++){u>=l&&((c=t.newStack()).slicesArray=[],u=0);var h=i.slicesArray[d];c.slicesArray.push(h),u++}return t.reverseSlicesOfStacks(),t}};var yn=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._fileileLoadState=I.fileLoadState.READY,this._filePath,this._jsonFile,this._isPrepared=!1,this._glTexture,void 0!==t&&t.filePath&&(this._filePath=t.filePath)};yn.prototype._prepare=function(){if(this._isPrepared)return!0;if(this._fileileLoadState===I.fileLoadState.READY){this._fileileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._filePath,void 0,void 0,"json","GET").done(function(t){e._fileileLoadState=I.fileLoadState.LOADING_FINISHED,e._jsonFile=t})}return this._fileileLoadState===I.fileLoadState.LOADING_FINISHED&&(this._isPrepared=!0,this._isPrepared)},yn.prototype.getQuantizedMinMaxValues=function(){if(void 0!==this._jsonFile)return[this._jsonFile.minValue,this._jsonFile.maxValue]},yn.prototype.deleteObjects=function(e){this._glTexture&&e.gl.deleteTexture(this._glTexture);for(var t in this._fileileLoadState=void 0,this._filePath=void 0,this._jsonFile)this._jsonFile.hasOwnProperty(t)&&delete this._jsonFile[t];this._jsonFile=void 0,this._isPrepared=void 0},yn.prototype.getGlTexture=function(e){if(void 0===this._glTexture||null===this._glTexture){for(var t=this._jsonFile.values,r=t.length,i=new Uint8Array(4*r),o=0;o<r;o++){var n=t[o],a=on.packDepth(n);i[4*o+0]=new Uint8Array([255*a[0]])[0],i[4*o+1]=new Uint8Array([255*a[1]])[0],i[4*o+2]=new Uint8Array([255*a[2]])[0],i[4*o+3]=new Uint8Array([255*a[3]])[0]}var s=e.LINEAR,l=e.CLAMP_TO_EDGE,u=this._jsonFile.columnsCount,c=this._jsonFile.rowsCount;this._glTexture=it.createTexture(e,s,i,u,c,l)}return this._glTexture};var Tn=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._pollutionVolumeOwner,this.geoLocationDataManager,this.gl,this._timeSlicesArray,this.altitude,this.timeInterval_min,this.timeSlicesCount,this.timeSliceFileNames,this.timeSliceFileFolderPath,this._isPrepared=!1,this._terrainSamplingState=I.processState.NO_STARTED,this.vboKeysContainer,void 0!==t&&(t.pollutionVolumeOwner&&(this._pollutionVolumeOwner=t.pollutionVolumeOwner),void 0!==t.altitude&&(this.altitude=t.altitude),void 0!==t.timeInterval_min&&(this.timeInterval_min=t.timeInterval_min),void 0!==t.timeSlicesCount&&(this.timeSlicesCount=t.timeSlicesCount),void 0!==t.timeSliceFileNames&&(this.timeSliceFileNames=t.timeSliceFileNames),void 0!==t.timeSliceFileFolderPath&&(this.timeSliceFileFolderPath=t.timeSliceFileFolderPath))};Tn.prototype._getMinMaxQuantizedValues=function(){if(void 0===this.minMaxValues){if(void 0===this._timeSlicesArray||0===this._timeSlicesArray.length)return;for(var e,t,r=[],i=this._timeSlicesArray.length,o=0;o<i;o++){var n=this._timeSlicesArray[o];if(void 0===n._jsonFile)return;e=n._jsonFile.minValue,t=n._jsonFile.maxValue,0===o?(r[0]=e,r[1]=t):(e<r[0]&&(r[0]=e),t>r[1]&&(r[1]=t))}i>0&&(this.minMaxValues=new Float32Array(r))}return this.minMaxValues},Tn.prototype.getPollutionValue=function(e,t){if(!this._prepareLayer())return!1;var r=this.geoLocDataManager.getCurrentGeoLocationData(),i=this._pollutionVolumeOwner._geoJsonIndexFile;if(void 0!==i&&void 0!==this._pollutionVolumeOwner&&void 0!==this._pollutionVolumeOwner._totalAnimTime){var o=r.worldCoordToLocalCoord(e,void 0),n=1e3*i.height_km,a=1e3*i.width_km,s=new Kr((o.x+.5*n)/n,(o.y+.5*a)/a),l=this._pollutionVolumeOwner._totalAnimTime,u=t-this._pollutionVolumeOwner._animationStartTime,c=this._timeSlicesArray.length,d=u/l*c,h=(Math.floor(d),Math.floor(d));h>=c&&(h=c-1);var f=h+1;f>=c&&(f=h);var g=this._timeSlicesArray[h],p=this._timeSlicesArray[f];if(void 0!==g){var m=g._jsonFile.columnsCount,v=g._jsonFile.rowsCount,x=g.getGlTexture(_),_=(p.getGlTexture(_),this._pollutionVolumeOwner.weatherStation.magoManager.getGl());if(!this.fboValuesTex){this.fboValuesTex=new ae(_,m,v,{matchCanvasSize:!1,multiRenderTarget:!1,numColorBuffers:1})}var y=Math.floor(s.x*m),T=Math.floor(s.y*v),C=new Uint8Array(4);if(this.fboValuesTex.bind(),_.framebufferTexture2D(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,_.TEXTURE_2D,x,0),_.readPixels(y,T,1,1,_.RGBA,_.UNSIGNED_BYTE,C),this.fboValuesTex.unbind(),0!==C[0]||0!==C[1]||0!==C[2]||0!==C[3]);var b=g._jsonFile.minValue,M=g._jsonFile.maxValue,A=(p._jsonFile.minValue,p._jsonFile.maxValue,[C[0]/255,C[1]/255,C[2]/255,C[3]/255]);return on.unpackDepth(A)*(M-b)+b}}},Tn.prototype.getTotalAnimationTimeMinutes=function(){return this.timeInterval_min*this._timeSlicesArray.length},Tn.prototype.render=function(e){if(void 0===this._timeSlicesArray||0===this._timeSlicesArray.length)return!1;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount())return!1;e.getCurrentTime(),this._pollutionVolumeOwner._animationStartTime;var t=this._timeSlicesArray.length,r=(this.timeInterval_min,this._timeSlicesArray[0],e.getGl()),i=e.sceneState,o=e.extbuffers;e.bindMainFramebuffer(),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT1_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT2_WEBGL,r.TEXTURE_2D,null,0),r.framebufferTexture2D(r.FRAMEBUFFER,o.COLOR_ATTACHMENT5_WEBGL,r.TEXTURE_2D,null,0),o.drawBuffersWEBGL([o.COLOR_ATTACHMENT0_WEBGL,o.NONE,o.NONE,o.COLOR_ATTACHMENT3_WEBGL,o.COLOR_ATTACHMENT4_WEBGL,o.NONE]);var n=this.vboKeysContainer.getVboKey(0),a=e.postFxShadersManager.getShader("pollution");e.postFxShadersManager.useProgram(a),r.uniform1i(a.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),r.uniform1i(a.bApplySpecularLighting_loc,!0),r.uniform1f(a.uFCoef_logDepth_loc,i.fCoef_logDepth[0]),r.uniform1i(a.uFrustumIdx_loc,e.currentFrustumIdx),r.uniform1i(a.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),r.enableVertexAttribArray(a.texCoord2_loc),r.enableVertexAttribArray(a.position3_loc),r.disableVertexAttribArray(a.normal3_loc),-1!==a.color4_loc&&r.disableVertexAttribArray(a.color4_loc),a.bindUniformGenerals(),r.uniform1f(a.externalAlpha_loc,1),r.uniform1i(a.textureFlipYAxis_loc,e.sceneState.textureFlipYAxis),r.uniform3fv(a.scaleLC_loc,[1,1,1]),r.uniform4fv(a.colorMultiplier_loc,[1,1,1,1]),r.uniform3fv(a.aditionalMov_loc,[0,0,0]),r.uniform1i(a.colorType_loc,2);var s=this._getMinMaxQuantizedValues();r.uniform2fv(a.uMinMaxValues_loc,s);t=this._timeSlicesArray.length;var l=this._pollutionVolumeOwner._totalAnimTime,u=this._pollutionVolumeOwner._increTime/l*t,c=u-Math.floor(u),d=Math.floor(u);d>=t&&(d=t-1);var h=d+1;h>=t&&(h=d);var f=this._timeSlicesArray[d],g=this._timeSlicesArray[h],p=f.getGlTexture(r),m=g.getGlTexture(r);r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,p),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,m),r.frontFace(r.CCW),r.enable(r.BLEND),r.depthMask(!1);var v=f.getQuantizedMinMaxValues(),x=g.getQuantizedMinMaxValues();r.uniform2fv(a.uMinMaxQuantizedValues_tex0_loc,v),r.uniform2fv(a.uMinMaxQuantizedValues_tex1_loc,x),r.uniform1f(a.uInterpolationFactor_loc,c),r.uniform1f(a.uModelOpacity_loc,1),r.uniform4fv(a.oneColor4_loc,[.99,.5,.25,1]),this.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,a);for(var _=e.vboMemoryManager,y=this.vboKeysContainer.vboCacheKeysArray.length,T=0;T<y;T++){if(!(n=this.vboKeysContainer.vboCacheKeysArray[T]))return!1;if(!n.bindDataPosition(a,_))return!1;if(n.vboBufferTCoord){if(!n.bindDataTexCoord(a,_))return!1}else a.disableVertexAttribArray(a.texCoord2_loc);if(!n.bindDataIndice(a,_))return!1;var C=r.TRIANGLES;r.drawElements(C,n.indicesCount,r.UNSIGNED_SHORT,0)}r.disable(r.BLEND),r.depthMask(!0),a.disableVertexAttribArrayAll(),e.postFxShadersManager.useProgram(null)},Tn.prototype.deleteObjects=function(e){if(this._timeSlicesArray&&this._timeSlicesArray.length>0){for(var t=this._timeSlicesArray.length,r=0;r<t;r++){this._timeSlicesArray[r].deleteObjects(e)}this._timeSlicesArray.length=0}if(this._timeSlicesArray=void 0,this.vboKeysContainer){var i=e.gl;this.vboKeysContainer.deleteGlObjects(i,e),this.vboKeysContainer=void 0}this._pollutionVolumeOwner=void 0,this.geoLocationDataManager&&(this.geoLocationDataManager.deleteObjects(),this.geoLocationDataManager=void 0),this.gl=void 0,this.altitude=void 0,this.timeInterval_min=void 0,this.timeSlicesCount=void 0,this.timeSliceFileNames=void 0,this.timeSliceFileFolderPath=void 0,this._isPrepared=void 0,this._terrainSamplingState=void 0},Tn.prototype._prepareLayer=function(){if(this._isPrepared)return!0;if(void 0===this._timeSlicesArray&&(this._timeSlicesArray=[]),0===this._timeSlicesArray.length)for(var e=this.timeSliceFileNames.length,t=0;t<e;t++){var r=this.timeSliceFileFolderPath+"\\"+this.timeSliceFileNames[t],i=new yn({filePath:r});this._timeSlicesArray.push(i)}var o=!0,n=this._timeSlicesArray.length;for(t=0;t<n;t++){(i=this._timeSlicesArray[t])._prepare()||(o=!1)}if(!o)return!1;if(0===this._timeSlicesArray.length)return!1;if(void 0===this._terrainSampled&&(this._terrainSampled=!1),this._terrainSamplingState===I.processState.NO_STARTED){this._terrainSamplingState=I.processState.STARTED;var a=this._pollutionVolumeOwner.weatherStation.magoManager;void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt,this.vboKeysContainer.newVBOVertexIdxCacheKey());var s=this.vboKeysContainer.getVboKey(0),l=(i=this._timeSlicesArray[0])._jsonFile.columnsCount,u=i._jsonFile.rowsCount,c=this._pollutionVolumeOwner._geoJsonIndexFile,d=c.centerGeographicCoord,h=1e3*c.height_km,f=1e3*c.width_km,g=Te.getRectangleMeshOnEllisoideCenteredAtGeographicCoord(d,h,f,l,u);s.setDataArrayIdx(g.indices,a.vboMemoryManager);var p=(a=this._pollutionVolumeOwner.weatherStation.magoManager).scene.globe.terrainProvider,m=Fe.getMaximumLevelOfTerrainProvider(p),v=g.pointsArray;this._texCoordsArray=g.texCoordsArray;var x=Te.Point3DToGeographicWgs84Array(v,!1).geoCoordsArray,_=x.length;this._cartographicsArray=new Array(_);for(t=0;t<_;t++){var y=x[t];this._cartographicsArray[t]=Cesium.Cartographic.fromDegrees(y.longitude,y.latitude)}var T=10;T>m&&(T=m);var C=Cesium.sampleTerrain(p,T,this._cartographicsArray),b=this;Cesium.when(C,function(e){b._terrainSamplingState=I.processState.FINISHED})}if(this._terrainSamplingState!==I.processState.FINISHED)return!1;if(void 0===this._makingRectangleMeshProcess&&(this._makingRectangleMeshProcess=I.processState.NO_STARTED),this._makingRectangleMeshProcess===I.processState.NO_STARTED){var M=this._cartographicsArray.length,A=new Array(M),E=new Array(M),L=new Array(M);for(t=0;t<M;t++){var w=this._cartographicsArray[t];A[t]=w.longitude,E[t]=w.latitude,L[t]=w.height+10}var S=Te.geographicRadianArrayToFloat32ArrayWgs84(A,E,L,void 0),D=en.getCenterPositionAndLocalPositions3DFloat32(S),R=D.centerPos;d=Te.CartesianToGeographicWgs84(R.x,R.y,R.z,void 0,!1);void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var P=this.geoLocDataManager.getCurrentGeoLocationData();void 0===P&&(P=this.geoLocDataManager.newGeoLocationData("default"));(P=on.calculateGeoLocationData(d.longitude,d.latitude,d.altitude,0,0,0,P)).rotMatrix.Identity();a=this._pollutionVolumeOwner.weatherStation.magoManager;(s=this.vboKeysContainer.getVboKey(0)).setDataArrayPos(D.localPosFloatArray,a.vboMemoryManager);var F=this._texCoordsArray.length,O=new Float32Array(2*F);for(t=0;t<F;t++){var B=this._texCoordsArray[t];O[2*t]=B.x,O[2*t+1]=B.y}return s.setDataArrayTexCoord(O,a.vboMemoryManager),this._makingRectangleMeshProcess=I.processState.FINISHED,!1}return this._isPrepared=!0,this._isPrepared};var Cn=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._pollutionLayersArray,this.weatherStation,this._geoJsonIndexFileLoadState=I.fileLoadState.READY,this._geoJsonIndexFile,this._geoJsonIndexFilePath,this._geoJsonIndexFileFolderPath,this._allLayersArePrepared=!1,this._animationState=I.processState.NO_STARTED,this._animationStartTime=0,this._totalAnimTime,this._increTime,t&&(t.geoJsonIndexFilePath&&(this._geoJsonIndexFilePath=t.geoJsonIndexFilePath),t.geoJsonIndexFileFolderPath&&(this._geoJsonIndexFileFolderPath=t.geoJsonIndexFileFolderPath),void 0!==t.animationSpeed&&(this._animationSpeed=t.animationSpeed))};Cn.prototype.render=function(e){if(this._animationState===I.processState.FINISHED)return!0;if(!this.prepareVolume(e))return!1;if(this._animationState===I.processState.NO_STARTED&&(this._animationState=I.processState.STARTED),void 0===this._totalAnimTime){this._pollutionLayersArray[0];this._totalAnimTime=3e4}if(void 0===this._timeScale&&(this._timeScale=1),void 0===e.animationTimeController){e.animationTimeController=new fn({incrementalAddingTimeMilisec:50})}var t=this._totalAnimTime,r=e.animationTimeController.getCurrentTimeMilisec();if(this._increTime=(r-this._animationStartTime)*this._timeScale,this._increTime>=t)return this._animationState=I.processState.FINISHED,!0;for(var i=this.getPollutionLayersCount(),o=0;o<i;o++){this._pollutionLayersArray[o].render(e)}},Cn.prototype.setGeoJsonIndexFile=function(e){return this._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,this._geoJsonIndexFile=e,!0},Cn.prototype._loadGeoJsonIndexFile=function(){if(this._geoJsonIndexFileLoadState===I.fileLoadState.READY){this._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._geoJsonIndexFilePath,void 0,void 0,"json","GET").done(function(t){e._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,e._geoJsonIndexFile=t})}},Cn.prototype._preparePollutionGeoJsonIndexFile=function(){return this._geoJsonIndexFileLoadState===I.fileLoadState.READY?(this._loadGeoJsonIndexFile(),!1):this._geoJsonIndexFileLoadState===I.fileLoadState.LOADING_FINISHED},Cn.prototype.getPollutionLayersCount=function(){return void 0===this._pollutionLayersArray?0:this._pollutionLayersArray.length},Cn.prototype.newPollutionLayer=function(e){void 0===this._pollutionLayersArray&&(this._pollutionLayersArray=[]);var t=new Tn(e);return this._pollutionLayersArray.push(t),t},Cn.prototype.deleteObjects=function(e){if(this._pollutionLayersArray&&this._pollutionLayersArray.length>0){void 0===e&&(e=this.weatherStation.magoManager.vboMemoryManager);for(var t=this._pollutionLayersArray.length,r=0;r<t;r++){this._pollutionLayersArray[r].deleteObjects(e)}this._pollutionLayersArray.length=0}for(var i in this._pollutionLayersArray=void 0,this.weatherStation=void 0,this._geoJsonIndexFileLoadState=void 0,this._geoJsonIndexFile)this._geoJsonIndexFile.hasOwnProperty(i)&&delete this._geoJsonIndexFile[i];this._geoJsonIndexFile=void 0,this._geoJsonIndexFilePath=void 0,this._geoJsonIndexFileFolderPath=void 0,this._allLayersArePrepared=void 0,this._animationState=void 0,this._animationStartTime=void 0,this._totalAnimTime=void 0,this._increTime=void 0},Cn.prototype._preparePollutionLayers=function(e){if(!0===this._allLayersArePrepared)return!0;if(0===(h=this.getPollutionLayersCount()))for(var t=this._geoJsonIndexFile.layersCount,r=this._geoJsonIndexFileFolderPath,i=0;i<t;i++){var o=this._geoJsonIndexFile.layers[i],n={pollutionVolumeOwner:this,altitude:o.altitude,timeInterval_min:o.timeInterval_min,timeSlicesCount:o.timeSlicesCount,timeSliceFileNames:o.timeSliceFileNames,timeSliceFileFolderPath:r},a=this.newPollutionLayer(n),s=this._geoJsonIndexFile.layers[i].timeSliceFiles;if(void 0!==s){void 0===a._timeSlicesArray&&(a._timeSlicesArray=[]);for(var l=s.length,u=0;u<l;u++){var c=new yn(n={});c._jsonFile=s[u],c._fileileLoadState=I.fileLoadState.LOADING_FINISHED,c._isPrepared=!0,a._timeSlicesArray.push(c)}}}var d=!0,h=this.getPollutionLayersCount();for(i=0;i<h;i++){this._pollutionLayersArray[i]._prepareLayer()||(d=!1)}return this._allLayersArePrepared=d,!1},Cn.prototype.prepareVolume=function(e){return!!this._preparePollutionGeoJsonIndexFile()&&!!this._preparePollutionLayers()};var bn={lat:[89.921875,89.765625,89.609375,89.453125,89.296875,89.140625,88.984375,88.828125,88.671875,88.515625,88.359375,88.203125,88.046875,87.890625,87.734375,87.578125,87.421875,87.265625,87.109375,86.953125,86.796875,86.640625,86.484375,86.328125,86.171875,86.015625,85.859375,85.703125,85.546875,85.390625,85.234375,85.078125,84.921875,84.765625,84.609375,84.453125,84.296875,84.140625,83.984375,83.828125,83.671875,83.515625,83.359375,83.203125,83.046875,82.890625,82.734375,82.578125,82.421875,82.265625,82.109375,81.953125,81.796875,81.640625,81.484375,81.328125,81.171875,81.015625,80.859375,80.703125,80.546875,80.390625,80.234375,80.078125,79.921875,79.765625,79.609375,79.453125,79.296875,79.140625,78.984375,78.828125,78.671875,78.515625,78.359375,78.203125,78.046875,77.890625,77.734375,77.578125,77.421875,77.265625,77.109375,76.953125,76.796875,76.640625,76.484375,76.328125,76.171875,76.015625,75.859375,75.703125,75.546875,75.390625,75.234375,75.078125,74.921875,74.765625,74.609375,74.453125,74.296875,74.140625,73.984375,73.828125,73.671875,73.515625,73.359375,73.203125,73.046875,72.890625,72.734375,72.578125,72.421875,72.265625,72.109375,71.953125,71.796875,71.640625,71.484375,71.328125,71.171875,71.015625,70.859375,70.703125,70.546875,70.390625,70.234375,70.078125,69.921875,69.765625,69.609375,69.453125,69.296875,69.140625,68.984375,68.828125,68.671875,68.515625,68.359375,68.203125,68.046875,67.890625,67.734375,67.578125,67.421875,67.265625,67.109375,66.953125,66.796875,66.640625,66.484375,66.328125,66.171875,66.015625,65.859375,65.703125,65.546875,65.390625,65.234375,65.078125,64.921875,64.765625,64.609375,64.453125,64.296875,64.140625,63.984375,63.828125,63.671875,63.515625,63.359375,63.203125,63.046875,62.890625,62.734375,62.578125,62.421875,62.265625,62.109375,61.953125,61.796875,61.640625,61.484375,61.328125,61.171875,61.015625,60.859375,60.703125,60.546875,60.390625,60.234375,60.078125,59.921875,59.765625,59.609375,59.453125,59.296875,59.140625,58.984375,58.828125,58.671875,58.515625,58.359375,58.203125,58.046875,57.890625,57.734375,57.578125,57.421875,57.265625,57.109375,56.953125,56.796875,56.640625,56.484375,56.328125,56.171875,56.015625,55.859375,55.703125,55.546875,55.390625,55.234375,55.078125,54.921875,54.765625,54.609375,54.453125,54.296875,54.140625,53.984375,53.828125,53.671875,53.515625,53.359375,53.203125,53.046875,52.890625,52.734375,52.578125,52.421875,52.265625,52.109375,51.953125,51.796875,51.640625,51.484375,51.328125,51.171875,51.015625,50.859375,50.703125,50.546875,50.390625,50.234375,50.078125,49.921875,49.765625,49.609375,49.453125,49.296875,49.140625,48.984375,48.828125,48.671875,48.515625,48.359375,48.203125,48.046875,47.890625,47.734375,47.578125,47.421875,47.265625,47.109375,46.953125,46.796875,46.640625,46.484375,46.328125,46.171875,46.015625,45.859375,45.703125,45.546875,45.390625,45.234375,45.078125,44.921875,44.765625,44.609375,44.453125,44.296875,44.140625,43.984375,43.828125,43.671875,43.515625,43.359375,43.203125,43.046875,42.890625,42.734375,42.578125,42.421875,42.265625,42.109375,41.953125,41.796875,41.640625,41.484375,41.328125,41.171875,41.015625,40.859375,40.703125,40.546875,40.390625,40.234375,40.078125,39.921875,39.765625,39.609375,39.453125,39.296875,39.140625,38.984375,38.828125,38.671875,38.515625,38.359375,38.203125,38.046875,37.890625,37.734375,37.578125,37.421875,37.265625,37.109375,36.953125,36.796875,36.640625,36.484375,36.328125,36.171875,36.015625,35.859375,35.703125,35.546875,35.390625,35.234375,35.078125,34.921875,34.765625,34.609375,34.453125,34.296875,34.140625,33.984375,33.828125,33.671875,33.515625,33.359375,33.203125,33.046875,32.890625,32.734375,32.578125,32.421875,32.265625,32.109375,31.953125,31.796875,31.640625,31.484375,31.328125,31.171875,31.015625,30.859375,30.703125,30.546875,30.390625,30.234375,30.078125,29.921875,29.765625,29.609375,29.453125,29.296875,29.140625,28.984375,28.828125,28.671875,28.515625,28.359375,28.203125,28.046875,27.890625,27.734375,27.578125,27.421875,27.265625,27.109375,26.953125,26.796875,26.640625,26.484375,26.328125,26.171875,26.015625,25.859375,25.703125,25.546875,25.390625,25.234375,25.078125,24.921875,24.765625,24.609375,24.453125,24.296875,24.140625,23.984375,23.828125,23.671875,23.515625,23.359375,23.203125,23.046875,22.890625,22.734375,22.578125,22.421875,22.265625,22.109375,21.953125,21.796875,21.640625,21.484375,21.328125,21.171875,21.015625,20.859375,20.703125,20.546875,20.390625,20.234375,20.078125,19.921875,19.765625,19.609375,19.453125,19.296875,19.140625,18.984375,18.828125,18.671875,18.515625,18.359375,18.203125,18.046875,17.890625,17.734375,17.578125,17.421875,17.265625,17.109375,16.953125,16.796875,16.640625,16.484375,16.328125,16.171875,16.015625,15.859375,15.703125,15.546875,15.390625,15.234375,15.078125,14.921875,14.765625,14.609375,14.453125,14.296875,14.140625,13.984375,13.828125,13.671875,13.515625,13.359375,13.203125,13.046875,12.890625,12.734375,12.578125,12.421875,12.265625,12.109375,11.953125,11.796875,11.640625,11.484375,11.328125,11.171875,11.015625,10.859375,10.703125,10.546875,10.390625,10.234375,10.078125,9.921875,9.765625,9.609375,9.453125,9.296875,9.140625,8.984375,8.828125,8.671875,8.515625,8.359375,8.203125,8.046875,7.890625,7.734375,7.578125,7.421875,7.265625,7.109375,6.953125,6.796875,6.640625,6.484375,6.328125,6.171875,6.015625,5.859375,5.703125,5.546875,5.390625,5.234375,5.078125,4.921875,4.765625,4.609375,4.453125,4.296875,4.140625,3.984375,3.828125,3.671875,3.515625,3.359375,3.203125,3.046875,2.890625,2.734375,2.578125,2.421875,2.265625,2.109375,1.953125,1.796875,1.640625,1.484375,1.328125,1.171875,1.015625,.859375,.703125,.546875,.390625,.234375,.078125,-.078125,-.234375,-.390625,-.546875,-.703125,-.859375,-1.015625,-1.171875,-1.328125,-1.484375,-1.640625,-1.796875,-1.953125,-2.109375,-2.265625,-2.421875,-2.578125,-2.734375,-2.890625,-3.046875,-3.203125,-3.359375,-3.515625,-3.671875,-3.828125,-3.984375,-4.140625,-4.296875,-4.453125,-4.609375,-4.765625,-4.921875,-5.078125,-5.234375,-5.390625,-5.546875,-5.703125,-5.859375,-6.015625,-6.171875,-6.328125,-6.484375,-6.640625,-6.796875,-6.953125,-7.109375,-7.265625,-7.421875,-7.578125,-7.734375,-7.890625,-8.046875,-8.203125,-8.359375,-8.515625,-8.671875,-8.828125,-8.984375,-9.140625,-9.296875,-9.453125,-9.609375,-9.765625,-9.921875,-10.078125,-10.234375,-10.390625,-10.546875,-10.703125,-10.859375,-11.015625,-11.171875,-11.328125,-11.484375,-11.640625,-11.796875,-11.953125,-12.109375,-12.265625,-12.421875,-12.578125,-12.734375,-12.890625,-13.046875,-13.203125,-13.359375,-13.515625,-13.671875,-13.828125,-13.984375,-14.140625,-14.296875,-14.453125,-14.609375,-14.765625,-14.921875,-15.078125,-15.234375,-15.390625,-15.546875,-15.703125,-15.859375,-16.015625,-16.171875,-16.328125,-16.484375,-16.640625,-16.796875,-16.953125,-17.109375,-17.265625,-17.421875,-17.578125,-17.734375,-17.890625,-18.046875,-18.203125,-18.359375,-18.515625,-18.671875,-18.828125,-18.984375,-19.140625,-19.296875,-19.453125,-19.609375,-19.765625,-19.921875,-20.078125,-20.234375,-20.390625,-20.546875,-20.703125,-20.859375,-21.015625,-21.171875,-21.328125,-21.484375,-21.640625,-21.796875,-21.953125,-22.109375,-22.265625,-22.421875,-22.578125,-22.734375,-22.890625,-23.046875,-23.203125,-23.359375,-23.515625,-23.671875,-23.828125,-23.984375,-24.140625,-24.296875,-24.453125,-24.609375,-24.765625,-24.921875,-25.078125,-25.234375,-25.390625,-25.546875,-25.703125,-25.859375,-26.015625,-26.171875,-26.328125,-26.484375,-26.640625,-26.796875,-26.953125,-27.109375,-27.265625,-27.421875,-27.578125,-27.734375,-27.890625,-28.046875,-28.203125,-28.359375,-28.515625,-28.671875,-28.828125,-28.984375,-29.140625,-29.296875,-29.453125,-29.609375,-29.765625,-29.921875,-30.078125,-30.234375,-30.390625,-30.546875,-30.703125,-30.859375,-31.015625,-31.171875,-31.328125,-31.484375,-31.640625,-31.796875,-31.953125,-32.109375,-32.265625,-32.421875,-32.578125,-32.734375,-32.890625,-33.046875,-33.203125,-33.359375,-33.515625,-33.671875,-33.828125,-33.984375,-34.140625,-34.296875,-34.453125,-34.609375,-34.765625,-34.921875,-35.078125,-35.234375,-35.390625,-35.546875,-35.703125,-35.859375,-36.015625,-36.171875,-36.328125,-36.484375,-36.640625,-36.796875,-36.953125,-37.109375,-37.265625,-37.421875,-37.578125,-37.734375,-37.890625,-38.046875,-38.203125,-38.359375,-38.515625,-38.671875,-38.828125,-38.984375,-39.140625,-39.296875,-39.453125,-39.609375,-39.765625,-39.921875,-40.078125,-40.234375,-40.390625,-40.546875,-40.703125,-40.859375,-41.015625,-41.171875,-41.328125,-41.484375,-41.640625,-41.796875,-41.953125,-42.109375,-42.265625,-42.421875,-42.578125,-42.734375,-42.890625,-43.046875,-43.203125,-43.359375,-43.515625,-43.671875,-43.828125,-43.984375,-44.140625,-44.296875,-44.453125,-44.609375,-44.765625,-44.921875,-45.078125,-45.234375,-45.390625,-45.546875,-45.703125,-45.859375,-46.015625,-46.171875,-46.328125,-46.484375,-46.640625,-46.796875,-46.953125,-47.109375,-47.265625,-47.421875,-47.578125,-47.734375,-47.890625,-48.046875,-48.203125,-48.359375,-48.515625,-48.671875,-48.828125,-48.984375,-49.140625,-49.296875,-49.453125,-49.609375,-49.765625,-49.921875,-50.078125,-50.234375,-50.390625,-50.546875,-50.703125,-50.859375,-51.015625,-51.171875,-51.328125,-51.484375,-51.640625,-51.796875,-51.953125,-52.109375,-52.265625,-52.421875,-52.578125,-52.734375,-52.890625,-53.046875,-53.203125,-53.359375,-53.515625,-53.671875,-53.828125,-53.984375,-54.140625,-54.296875,-54.453125,-54.609375,-54.765625,-54.921875,-55.078125,-55.234375,-55.390625,-55.546875,-55.703125,-55.859375,-56.015625,-56.171875,-56.328125,-56.484375,-56.640625,-56.796875,-56.953125,-57.109375,-57.265625,-57.421875,-57.578125,-57.734375,-57.890625,-58.046875,-58.203125,-58.359375,-58.515625,-58.671875,-58.828125,-58.984375,-59.140625,-59.296875,-59.453125,-59.609375,-59.765625,-59.921875,-60.078125,-60.234375,-60.390625,-60.546875,-60.703125,-60.859375,-61.015625,-61.171875,-61.328125,-61.484375,-61.640625,-61.796875,-61.953125,-62.109375,-62.265625,-62.421875,-62.578125,-62.734375,-62.890625,-63.046875,-63.203125,-63.359375,-63.515625,-63.671875,-63.828125,-63.984375,-64.140625,-64.296875,-64.453125,-64.609375,-64.765625,-64.921875,-65.078125,-65.234375,-65.390625,-65.546875,-65.703125,-65.859375,-66.015625,-66.171875,-66.328125,-66.484375,-66.640625,-66.796875,-66.953125,-67.109375,-67.265625,-67.421875,-67.578125,-67.734375,-67.890625,-68.046875,-68.203125,-68.359375,-68.515625,-68.671875,-68.828125,-68.984375,-69.140625,-69.296875,-69.453125,-69.609375,-69.765625,-69.921875,-70.078125,-70.234375,-70.390625,-70.546875,-70.703125,-70.859375,-71.015625,-71.171875,-71.328125,-71.484375,-71.640625,-71.796875,-71.953125,-72.109375,-72.265625,-72.421875,-72.578125,-72.734375,-72.890625,-73.046875,-73.203125,-73.359375,-73.515625,-73.671875,-73.828125,-73.984375,-74.140625,-74.296875,-74.453125,-74.609375,-74.765625,-74.921875,-75.078125,-75.234375,-75.390625,-75.546875,-75.703125,-75.859375,-76.015625,-76.171875,-76.328125,-76.484375,-76.640625,-76.796875,-76.953125,-77.109375,-77.265625,-77.421875,-77.578125,-77.734375,-77.890625,-78.046875,-78.203125,-78.359375,-78.515625,-78.671875,-78.828125,-78.984375,-79.140625,-79.296875,-79.453125,-79.609375,-79.765625,-79.921875,-80.078125,-80.234375,-80.390625,-80.546875,-80.703125,-80.859375,-81.015625,-81.171875,-81.328125,-81.484375,-81.640625,-81.796875,-81.953125,-82.109375,-82.265625,-82.421875,-82.578125,-82.734375,-82.890625,-83.046875,-83.203125,-83.359375,-83.515625,-83.671875,-83.828125,-83.984375,-84.140625,-84.296875,-84.453125,-84.609375,-84.765625,-84.921875,-85.078125,-85.234375,-85.390625,-85.546875,-85.703125,-85.859375,-86.015625,-86.171875,-86.328125,-86.484375,-86.640625,-86.796875,-86.953125,-87.109375,-87.265625,-87.421875,-87.578125,-87.734375,-87.890625,-88.046875,-88.203125,-88.359375,-88.515625,-88.671875,-88.828125,-88.984375,-89.140625,-89.296875,-89.453125,-89.609375,-89.765625,-89.921875],lon:[.117188,.351563,.585938,.820313,1.054688,1.289063,1.523438,1.757813,1.992188,2.226563,2.460938,2.695313,2.929688,3.164063,3.398438,3.632813,3.867188,4.101563,4.335938,4.570313,4.804688,5.039063,5.273438,5.507813,5.742188,5.976563,6.210938,6.445313,6.679688,6.914063,7.148438,7.382813,7.617188,7.851563,8.085938,8.320313,8.554688,8.789063,9.023438,9.257813,9.492188,9.726563,9.960938,10.195313,10.429688,10.664063,10.898438,11.132813,11.367188,11.601563,11.835938,12.070313,12.304688,12.539063,12.773438,13.007813,13.242188,13.476563,13.710938,13.945313,14.179688,14.414063,14.648438,14.882813,15.117188,15.351563,15.585938,15.820313,16.054688,16.289062,16.523438,16.757812,16.992188,17.226562,17.460938,17.695312,17.929688,18.164062,18.398438,18.632812,18.867188,19.101562,19.335938,19.570312,19.804688,20.039062,20.273438,20.507812,20.742188,20.976562,21.210938,21.445312,21.679688,21.914062,22.148438,22.382812,22.617188,22.851562,23.085938,23.320312,23.554688,23.789062,24.023438,24.257812,24.492188,24.726562,24.960938,25.195312,25.429688,25.664062,25.898438,26.132812,26.367188,26.601562,26.835938,27.070312,27.304688,27.539062,27.773438,28.007812,28.242188,28.476562,28.710938,28.945312,29.179688,29.414062,29.648438,29.882812,30.117188,30.351562,30.585938,30.820312,31.054688,31.289062,31.523438,31.757812,31.992188,32.226562,32.460938,32.695312,32.929688,33.164062,33.398438,33.632812,33.867188,34.101562,34.335938,34.570312,34.804688,35.039062,35.273438,35.507812,35.742188,35.976562,36.210938,36.445312,36.679688,36.914062,37.148438,37.382812,37.617188,37.851562,38.085938,38.320312,38.554688,38.789062,39.023438,39.257812,39.492188,39.726562,39.960938,40.195312,40.429688,40.664062,40.898438,41.132812,41.367188,41.601562,41.835938,42.070312,42.304688,42.539062,42.773438,43.007812,43.242188,43.476562,43.710938,43.945312,44.179688,44.414062,44.648438,44.882812,45.117188,45.351562,45.585938,45.820312,46.054688,46.289062,46.523438,46.757812,46.992188,47.226562,47.460938,47.695312,47.929688,48.164062,48.398438,48.632812,48.867188,49.101562,49.335938,49.570312,49.804688,50.039062,50.273438,50.507812,50.742188,50.976562,51.210938,51.445312,51.679688,51.914062,52.148438,52.382812,52.617188,52.851562,53.085938,53.320312,53.554688,53.789062,54.023438,54.257812,54.492188,54.726562,54.960938,55.195312,55.429688,55.664062,55.898438,56.132812,56.367188,56.601562,56.835938,57.070312,57.304688,57.539062,57.773438,58.007812,58.242188,58.476562,58.710938,58.945312,59.179688,59.414062,59.648438,59.882812,60.117188,60.351562,60.585938,60.820312,61.054688,61.289062,61.523438,61.757812,61.992188,62.226562,62.460938,62.695312,62.929688,63.164062,63.398438,63.632812,63.867188,64.10156,64.33594,64.57031,64.80469,65.03906,65.27344,65.50781,65.74219,65.97656,66.21094,66.44531,66.67969,66.91406,67.14844,67.38281,67.61719,67.85156,68.08594,68.32031,68.55469,68.78906,69.02344,69.25781,69.49219,69.72656,69.96094,70.19531,70.42969,70.66406,70.89844,71.13281,71.36719,71.60156,71.83594,72.07031,72.30469,72.53906,72.77344,73.00781,73.24219,73.47656,73.71094,73.94531,74.17969,74.41406,74.64844,74.88281,75.11719,75.35156,75.58594,75.82031,76.05469,76.28906,76.52344,76.75781,76.99219,77.22656,77.46094,77.69531,77.92969,78.16406,78.39844,78.63281,78.86719,79.10156,79.33594,79.57031,79.80469,80.03906,80.27344,80.50781,80.74219,80.97656,81.21094,81.44531,81.67969,81.91406,82.14844,82.38281,82.61719,82.85156,83.08594,83.32031,83.55469,83.78906,84.02344,84.25781,84.49219,84.72656,84.96094,85.19531,85.42969,85.66406,85.89844,86.13281,86.36719,86.60156,86.83594,87.07031,87.30469,87.53906,87.77344,88.00781,88.24219,88.47656,88.71094,88.94531,89.17969,89.41406,89.64844,89.88281,90.11719,90.35156,90.58594,90.82031,91.05469,91.28906,91.52344,91.75781,91.99219,92.22656,92.46094,92.69531,92.92969,93.16406,93.39844,93.63281,93.86719,94.10156,94.33594,94.57031,94.80469,95.03906,95.27344,95.50781,95.74219,95.97656,96.21094,96.44531,96.67969,96.91406,97.14844,97.38281,97.61719,97.85156,98.08594,98.32031,98.55469,98.78906,99.02344,99.25781,99.49219,99.72656,99.96094,100.19531,100.42969,100.66406,100.89844,101.13281,101.36719,101.60156,101.83594,102.07031,102.30469,102.53906,102.77344,103.00781,103.24219,103.47656,103.71094,103.94531,104.17969,104.41406,104.64844,104.88281,105.11719,105.35156,105.58594,105.82031,106.05469,106.28906,106.52344,106.75781,106.99219,107.22656,107.46094,107.69531,107.92969,108.16406,108.39844,108.63281,108.86719,109.10156,109.33594,109.57031,109.80469,110.03906,110.27344,110.50781,110.74219,110.97656,111.21094,111.44531,111.67969,111.91406,112.14844,112.38281,112.61719,112.85156,113.08594,113.32031,113.55469,113.78906,114.02344,114.25781,114.49219,114.72656,114.96094,115.19531,115.42969,115.66406,115.89844,116.13281,116.36719,116.60156,116.83594,117.07031,117.30469,117.53906,117.77344,118.00781,118.24219,118.47656,118.71094,118.94531,119.17969,119.41406,119.64844,119.88281,120.11719,120.35156,120.58594,120.82031,121.05469,121.28906,121.52344,121.75781,121.99219,122.22656,122.46094,122.69531,122.92969,123.16406,123.39844,123.63281,123.86719,124.10156,124.33594,124.57031,124.80469,125.03906,125.27344,125.50781,125.74219,125.97656,126.21094,126.44531,126.67969,126.91406,127.14844,127.38281,127.61719,127.85156,128.08594,128.32031,128.55469,128.78906,129.02344,129.25781,129.49219,129.72656,129.96094,130.19531,130.42969,130.66406,130.89844,131.13281,131.36719,131.60156,131.83594,132.07031,132.30469,132.53906,132.77344,133.00781,133.24219,133.47656,133.71094,133.94531,134.17969,134.41406,134.64844,134.88281,135.11719,135.35156,135.58594,135.82031,136.05469,136.28906,136.52344,136.75781,136.99219,137.22656,137.46094,137.69531,137.92969,138.16406,138.39844,138.63281,138.86719,139.10156,139.33594,139.57031,139.80469,140.03906,140.27344,140.50781,140.74219,140.97656,141.21094,141.44531,141.67969,141.91406,142.14844,142.38281,142.61719,142.85156,143.08594,143.32031,143.55469,143.78906,144.02344,144.25781,144.49219,144.72656,144.96094,145.19531,145.42969,145.66406,145.89844,146.13281,146.36719,146.60156,146.83594,147.07031,147.30469,147.53906,147.77344,148.00781,148.24219,148.47656,148.71094,148.94531,149.17969,149.41406,149.64844,149.88281,150.11719,150.35156,150.58594,150.82031,151.05469,151.28906,151.52344,151.75781,151.99219,152.22656,152.46094,152.69531,152.92969,153.16406,153.39844,153.63281,153.86719,154.10156,154.33594,154.57031,154.80469,155.03906,155.27344,155.50781,155.74219,155.97656,156.21094,156.44531,156.67969,156.91406,157.14844,157.38281,157.61719,157.85156,158.08594,158.32031,158.55469,158.78906,159.02344,159.25781,159.49219,159.72656,159.96094,160.19531,160.42969,160.66406,160.89844,161.13281,161.36719,161.60156,161.83594,162.07031,162.30469,162.53906,162.77344,163.00781,163.24219,163.47656,163.71094,163.94531,164.17969,164.41406,164.64844,164.88281,165.11719,165.35156,165.58594,165.82031,166.05469,166.28906,166.52344,166.75781,166.99219,167.22656,167.46094,167.69531,167.92969,168.16406,168.39844,168.63281,168.86719,169.10156,169.33594,169.57031,169.80469,170.03906,170.27344,170.50781,170.74219,170.97656,171.21094,171.44531,171.67969,171.91406,172.14844,172.38281,172.61719,172.85156,173.08594,173.32031,173.55469,173.78906,174.02344,174.25781,174.49219,174.72656,174.96094,175.19531,175.42969,175.66406,175.89844,176.13281,176.36719,176.60156,176.83594,177.07031,177.30469,177.53906,177.77344,178.00781,178.24219,178.47656,178.71094,178.94531,179.17969,179.41406,179.64844,179.88281,180.11719,180.35156,180.58594,180.82031,181.05469,181.28906,181.52344,181.75781,181.99219,182.22656,182.46094,182.69531,182.92969,183.16406,183.39844,183.63281,183.86719,184.10156,184.33594,184.57031,184.80469,185.03906,185.27344,185.50781,185.74219,185.97656,186.21094,186.44531,186.67969,186.91406,187.14844,187.38281,187.61719,187.85156,188.08594,188.32031,188.55469,188.78906,189.02344,189.25781,189.49219,189.72656,189.96094,190.19531,190.42969,190.66406,190.89844,191.13281,191.36719,191.60156,191.83594,192.07031,192.30469,192.53906,192.77344,193.00781,193.24219,193.47656,193.71094,193.94531,194.17969,194.41406,194.64844,194.88281,195.11719,195.35156,195.58594,195.82031,196.05469,196.28906,196.52344,196.75781,196.99219,197.22656,197.46094,197.69531,197.92969,198.16406,198.39844,198.63281,198.86719,199.10156,199.33594,199.57031,199.80469,200.03906,200.27344,200.50781,200.74219,200.97656,201.21094,201.44531,201.67969,201.91406,202.14844,202.38281,202.61719,202.85156,203.08594,203.32031,203.55469,203.78906,204.02344,204.25781,204.49219,204.72656,204.96094,205.19531,205.42969,205.66406,205.89844,206.13281,206.36719,206.60156,206.83594,207.07031,207.30469,207.53906,207.77344,208.00781,208.24219,208.47656,208.71094,208.94531,209.17969,209.41406,209.64844,209.88281,210.11719,210.35156,210.58594,210.82031,211.05469,211.28906,211.52344,211.75781,211.99219,212.22656,212.46094,212.69531,212.92969,213.16406,213.39844,213.63281,213.86719,214.10156,214.33594,214.57031,214.80469,215.03906,215.27344,215.50781,215.74219,215.97656,216.21094,216.44531,216.67969,216.91406,217.14844,217.38281,217.61719,217.85156,218.08594,218.32031,218.55469,218.78906,219.02344,219.25781,219.49219,219.72656,219.96094,220.19531,220.42969,220.66406,220.89844,221.13281,221.36719,221.60156,221.83594,222.07031,222.30469,222.53906,222.77344,223.00781,223.24219,223.47656,223.71094,223.94531,224.17969,224.41406,224.64844,224.88281,225.11719,225.35156,225.58594,225.82031,226.05469,226.28906,226.52344,226.75781,226.99219,227.22656,227.46094,227.69531,227.92969,228.16406,228.39844,228.63281,228.86719,229.10156,229.33594,229.57031,229.80469,230.03906,230.27344,230.50781,230.74219,230.97656,231.21094,231.44531,231.67969,231.91406,232.14844,232.38281,232.61719,232.85156,233.08594,233.32031,233.55469,233.78906,234.02344,234.25781,234.49219,234.72656,234.96094,235.19531,235.42969,235.66406,235.89844,236.13281,236.36719,236.60156,236.83594,237.07031,237.30469,237.53906,237.77344,238.00781,238.24219,238.47656,238.71094,238.94531,239.17969,239.41406,239.64844,239.88281,240.11719,240.35156,240.58594,240.82031,241.05469,241.28906,241.52344,241.75781,241.99219,242.22656,242.46094,242.69531,242.92969,243.16406,243.39844,243.63281,243.86719,244.10156,244.33594,244.57031,244.80469,245.03906,245.27344,245.50781,245.74219,245.97656,246.21094,246.44531,246.67969,246.91406,247.14844,247.38281,247.61719,247.85156,248.08594,248.32031,248.55469,248.78906,249.02344,249.25781,249.49219,249.72656,249.96094,250.19531,250.42969,250.66406,250.89844,251.13281,251.36719,251.60156,251.83594,252.07031,252.30469,252.53906,252.77344,253.00781,253.24219,253.47656,253.71094,253.94531,254.17969,254.41406,254.64844,254.88281,255.11719,255.35156,255.58594,255.82031,256.0547,256.28906,256.52344,256.7578,256.9922,257.22656,257.46094,257.6953,257.9297,258.16406,258.39844,258.6328,258.8672,259.10156,259.33594,259.5703,259.8047,260.03906,260.27344,260.5078,260.7422,260.97656,261.21094,261.4453,261.6797,261.91406,262.14844,262.3828,262.6172,262.85156,263.08594,263.3203,263.5547,263.78906,264.02344,264.2578,264.4922,264.72656,264.96094,265.1953,265.4297,265.66406,265.89844,266.1328,266.3672,266.60156,266.83594,267.0703,267.3047,267.53906,267.77344,268.0078,268.2422,268.47656,268.71094,268.9453,269.1797,269.41406,269.64844,269.8828,270.1172,270.35156,270.58594,270.8203,271.0547,271.28906,271.52344,271.7578,271.9922,272.22656,272.46094,272.6953,272.9297,273.16406,273.39844,273.6328,273.8672,274.10156,274.33594,274.5703,274.8047,275.03906,275.27344,275.5078,275.7422,275.97656,276.21094,276.4453,276.6797,276.91406,277.14844,277.3828,277.6172,277.85156,278.08594,278.3203,278.5547,278.78906,279.02344,279.2578,279.4922,279.72656,279.96094,280.1953,280.4297,280.66406,280.89844,281.1328,281.3672,281.60156,281.83594,282.0703,282.3047,282.53906,282.77344,283.0078,283.2422,283.47656,283.71094,283.9453,284.1797,284.41406,284.64844,284.8828,285.1172,285.35156,285.58594,285.8203,286.0547,286.28906,286.52344,286.7578,286.9922,287.22656,287.46094,287.6953,287.9297,288.16406,288.39844,288.6328,288.8672,289.10156,289.33594,289.5703,289.8047,290.03906,290.27344,290.5078,290.7422,290.97656,291.21094,291.4453,291.6797,291.91406,292.14844,292.3828,292.6172,292.85156,293.08594,293.3203,293.5547,293.78906,294.02344,294.2578,294.4922,294.72656,294.96094,295.1953,295.4297,295.66406,295.89844,296.1328,296.3672,296.60156,296.83594,297.0703,297.3047,297.53906,297.77344,298.0078,298.2422,298.47656,298.71094,298.9453,299.1797,299.41406,299.64844,299.8828,300.1172,300.35156,300.58594,300.8203,301.0547,301.28906,301.52344,301.7578,301.9922,302.22656,302.46094,302.6953,302.9297,303.16406,303.39844,303.6328,303.8672,304.10156,304.33594,304.5703,304.8047,305.03906,305.27344,305.5078,305.7422,305.97656,306.21094,306.4453,306.6797,306.91406,307.14844,307.3828,307.6172,307.85156,308.08594,308.3203,308.5547,308.78906,309.02344,309.2578,309.4922,309.72656,309.96094,310.1953,310.4297,310.66406,310.89844,311.1328,311.3672,311.60156,311.83594,312.0703,312.3047,312.53906,312.77344,313.0078,313.2422,313.47656,313.71094,313.9453,314.1797,314.41406,314.64844,314.8828,315.1172,315.35156,315.58594,315.8203,316.0547,316.28906,316.52344,316.7578,316.9922,317.22656,317.46094,317.6953,317.9297,318.16406,318.39844,318.6328,318.8672,319.10156,319.33594,319.5703,319.8047,320.03906,320.27344,320.5078,320.7422,320.97656,321.21094,321.4453,321.6797,321.91406,322.14844,322.3828,322.6172,322.85156,323.08594,323.3203,323.5547,323.78906,324.02344,324.2578,324.4922,324.72656,324.96094,325.1953,325.4297,325.66406,325.89844,326.1328,326.3672,326.60156,326.83594,327.0703,327.3047,327.53906,327.77344,328.0078,328.2422,328.47656,328.71094,328.9453,329.1797,329.41406,329.64844,329.8828,330.1172,330.35156,330.58594,330.8203,331.0547,331.28906,331.52344,331.7578,331.9922,332.22656,332.46094,332.6953,332.9297,333.16406,333.39844,333.6328,333.8672,334.10156,334.33594,334.5703,334.8047,335.03906,335.27344,335.5078,335.7422,335.97656,336.21094,336.4453,336.6797,336.91406,337.14844,337.3828,337.6172,337.85156,338.08594,338.3203,338.5547,338.78906,339.02344,339.2578,339.4922,339.72656,339.96094,340.1953,340.4297,340.66406,340.89844,341.1328,341.3672,341.60156,341.83594,342.0703,342.3047,342.53906,342.77344,343.0078,343.2422,343.47656,343.71094,343.9453,344.1797,344.41406,344.64844,344.8828,345.1172,345.35156,345.58594,345.8203,346.0547,346.28906,346.52344,346.7578,346.9922,347.22656,347.46094,347.6953,347.9297,348.16406,348.39844,348.6328,348.8672,349.10156,349.33594,349.5703,349.8047,350.03906,350.27344,350.5078,350.7422,350.97656,351.21094,351.4453,351.6797,351.91406,352.14844,352.3828,352.6172,352.85156,353.08594,353.3203,353.5547,353.78906,354.02344,354.2578,354.4922,354.72656,354.96094,355.1953,355.4297,355.66406,355.89844,356.1328,356.3672,356.60156,356.83594,357.0703,357.3047,357.53906,357.77344,358.0078,358.2422,358.47656,358.71094,358.9453,359.1797,359.41406,359.64844,359.8828]},Mn=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.precipitationData,this.gl,this.maxPrecipitation,this.minPrecipitation,this.geographicExtent,this.weatherStation};Mn.prototype.init=function(e,t){this.gl=e,this.loadData(),void 0===this.geographicExtent&&(this.geographicExtent=new xe),this.geographicExtent.setExtent(-180,-90,0,180,90,0)},Mn.prototype.loadData=function(){var e=bn.lon.length,t=bn.lat.length,r=this.weatherStation.provisional_geometryDataPath+"/volumRenderingTest/rain_iSuSok/Total_precipitation_surface_3_Hour_Accumulation.bin",i=new Sn;i.numCols=e,i.numRows=t,hr.loadBinaryData(r,i,this)},Mn.prototype.parseData=function(e){this.gl;var t=bn.lon.length,r=bn.lat.length,i=t*r,o=new DataStream(e.dataArraybuffer,0,DataStream.BIG_ENDIAN).readFloat32Array(i);e.dataArraybuffer=o;var n,a=o.length;this.maxPrecipitation=o[0],this.minPrecipitation=o[0];for(var s=1;s<a;s++)(n=o[s])>this.maxPrecipitation?this.maxPrecipitation=n:n<this.minPrecipitation&&(this.minPrecipitation=n);var l=this.maxPrecipitation-this.minPrecipitation;this.image3d=new xn;var u=t,c=r;this.resampledWidth=u,this.resampledHeght=c;for(s=0;s<t;s++)bn.lon[s]-=180;for(var d=bn.lon[0],h=bn.lon[t-1],f=bn.lat[0],g=bn.lat[r-1],p=t/2,m=Math.floor(t/u),v=Math.floor(r/c),x=this.image3d.newStack(),_=0;_<1;_++){var y=x.newSlice(),T=u*c;y.dataArray=new Uint8Array(T),y.width=u,y.height=c;for(var C=0;C<c;C++)for(s=0;s<u;s++){var b=s*m,M=C*v+_*r;(b+=p)>t&&(b-=t);var A=xn.getIndexOfArray(t,b,M),E=xn.getIndexOfArray(u,s,C),L=o[A],w=Math.floor(256*(L-this.minPrecipitation)/l);y.dataArray[E]=w}void 0===y.geographicExtent&&(y.geographicExtent=new xe),y.geographicExtent.setExtent(d,f,0,h,g,0)}},Mn.prototype.test_makeGeometryFromSlice=function(e,t,r,i,o,n,a){if(void 0!==this.image3d){Math.PI;var s,l,u,c,d,h,f,g,p=e.geographicExtent.minGeographicCoord.longitude,m=e.geographicExtent.minGeographicCoord.latitude,v=e.geographicExtent.maxGeographicCoord.longitude,x=e.geographicExtent.maxGeographicCoord.latitude,_=(v-p)/(e.width-1),y=(x-m)/(e.height-1),T=p,C=m,b=new Di,M=a*(a-n)*5-n;.8;for(var A=r;A<=o;A++){d=b.newVertexList(),l=C+A*y;for(var E=t;E<=i;E++){var L=E;L>=e.width&&(L-=e.width),s=T+L*_,u=e?e.getValue(L,A):0,u*=5*(u-n),u+=1e3,f=d.newVertex(),(h=(u-n)/M)>1?h=1:h<0&&(h=0),c=J.grayToRGB_MagoStyle(h,c),g=Te.geographicToCartesianWgs84(s,l,u,g),f.setPosition(g[0],g[1],g[2]),f.setColorRGBA(c.b,c.g,c.r,.8)}}var w=new kr,S=Di.makeSurface(b,void 0,!1,!0);S.calculateVerticesNormals(),w.addSurface(S),void 0===this.meshesArray&&(this.meshesArray=[]),this.meshesArray.push(w)}},Mn.prototype.test_makeGeometryFromData=function(e){if(void 0!==this.image3d)for(var t,r,i,o,n=this.image3d.getStacksCount(),a=0;a<n;a++)for(var s=this.image3d.getStack(a),l=s.getSlicesCount(),u=0;u<l;u++){for(var c=s.getSlice(u),d=[],h=(d=mn.getMinMaxValuesOfArray(c.dataArray,d))[0],f=d[1],g=Math.floor(c.width/300),p=Math.floor(c.height/300),m=0;m<=p;m++)for(var v=0;v<=g;v++)t=300*v,(r=300*(v+1))>c.width&&(r=c.width),i=300*m,(o=300*(m+1))>c.height&&(o=c.height),this.test_makeGeometryFromSlice(c,t,i,r,o,h,f);break}},Mn.prototype.renderMesh=function(e,t,r){if(void 0!==this.meshesArray)for(var i=this.meshesArray.length,o=0;o<i;o++)this.meshesArray[o].render(e,t,r)};var An=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._soundSurfaceLayerOwner,this._fileileLoadState=I.fileLoadState.READY,this._filePath,this._jsonFile,this._isPrepared=!1,this._glTexture,void 0!==t&&(t.filePath&&(this._filePath=t.filePath),t.soundSurfaceLayerOwner&&(this._soundSurfaceLayerOwner=t.soundSurfaceLayerOwner))};An.prototype._prepare=function(){if(this._isPrepared)return!0;if(this._fileileLoadState===I.fileLoadState.READY){this._fileileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._filePath,void 0,void 0,"json","GET").done(function(t){e._fileileLoadState=I.fileLoadState.LOADING_FINISHED,e._jsonFile=t})}if(this._fileileLoadState!==I.fileLoadState.LOADING_FINISHED)return!1;if(void 0===this._makingMeshProcess&&(this._makingMeshProcess=I.processState.NO_STARTED),this._makingMeshProcess===I.processState.NO_STARTED){void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt,this.vboKeysContainer.newVBOVertexIdxCacheKey()),void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var t=this.geoLocDataManager.getCurrentGeoLocationData();void 0===t&&(t=this.geoLocDataManager.newGeoLocationData("default"));var r=this._jsonFile.centerGeographicCoord;t=on.calculateGeoLocationData(r.longitude,r.latitude,r.altitude,0,0,0,t);var i=new Float32Array(this._jsonFile.positions),o=new Float32Array(this._jsonFile.soundLevelValues),n=this._soundSurfaceLayerOwner._soundSurfaceVolumeOwner.weatherStation.magoManager,a=this.vboKeysContainer.getVboKey(0);if(i.length/3>=65535){n.getGl().getExtension("OES_element_index_uint");var s=new Uint32Array(this._jsonFile.indices);a.setDataArrayIdx(s,n.vboMemoryManager)}else{s=new Uint16Array(this._jsonFile.indices);a.setDataArrayIdx(s,n.vboMemoryManager)}a.setDataArrayPos(i,n.vboMemoryManager);return a.setDataArrayCustom(o,n.vboMemoryManager,1,"soundLevelValue",4),this._makingMeshProcess=I.processState.FINISHED,!1}return this._isPrepared=!0,this._isPrepared};var En=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._soundSurfaceVolumeOwner,this.geoLocationDataManager,this.gl,this._timeSlicesArray,this.altitude,this.timeInterval_min,this.timeSlicesCount,this.timeSliceFileNames,this.timeSliceFileFolderPath,this._isPrepared=!1,this._terrainSamplingState=I.processState.NO_STARTED,this.vboKeysContainer,this._makingMeshProcess,this._currTimeSliceIdx=0,void 0!==t&&(t.soundSurfaceVolumeOwner&&(this._soundSurfaceVolumeOwner=t.soundSurfaceVolumeOwner),void 0!==t.altitude&&(this.altitude=t.altitude),void 0!==t.timeInterval_min&&(this.timeInterval_min=t.timeInterval_min),void 0!==t.timeSlicesCount&&(this.timeSlicesCount=t.timeSlicesCount),void 0!==t.timeSliceFileNames&&(this.timeSliceFileNames=t.timeSliceFileNames),void 0!==t.timeSliceFileFolderPath&&(this.timeSliceFileFolderPath=t.timeSliceFileFolderPath))};En.prototype.getCurrentTimeSliceIdx=function(){return this._currTimeSliceIdx},En.prototype.setCurrentTimeSliceIdx=function(e){if(void 0===e)return!1;e<0?e=0:e>=this._timeSlicesArray.length&&(e=this._timeSlicesArray.length-1),this._currTimeSliceIdx=e},En.prototype.render=function(e){if(void 0===this._timeSlicesArray||0===this._timeSlicesArray.length)return!1;if(void 0===this.vboKeysContainer||0===this.vboKeysContainer.getVbosCount())return!1;e.getCurrentTime(),this._soundSurfaceVolumeOwner._animationStartTime,this._timeSlicesArray.length,this.timeInterval_min;var t=e.getGl(),r=e.sceneState,i=e.extbuffers;e.bindMainFramebuffer(),t.framebufferTexture2D(t.FRAMEBUFFER,i.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,i.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,i.COLOR_ATTACHMENT5_WEBGL,t.TEXTURE_2D,null,0),i.drawBuffersWEBGL([i.COLOR_ATTACHMENT0_WEBGL,i.NONE,i.NONE,i.COLOR_ATTACHMENT3_WEBGL,i.COLOR_ATTACHMENT4_WEBGL,i.NONE]);var o=e.postFxShadersManager.getShader("soundSurface");e.postFxShadersManager.useProgram(o),t.uniform1i(o.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),t.uniform1i(o.bApplySpecularLighting_loc,!0),t.uniform1f(o.uFCoef_logDepth_loc,r.fCoef_logDepth[0]),t.uniform1i(o.uFrustumIdx_loc,e.currentFrustumIdx),t.uniform1i(o.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),t.disableVertexAttribArray(o.texCoord2_loc),t.enableVertexAttribArray(o.position3_loc),t.disableVertexAttribArray(o.normal3_loc),-1!==o.color4_loc&&t.disableVertexAttribArray(o.color4_loc),o.bindUniformGenerals(),t.uniform1f(o.externalAlpha_loc,1),t.uniform1i(o.textureFlipYAxis_loc,e.sceneState.textureFlipYAxis),t.uniform3fv(o.scaleLC_loc,[1,1,1]),t.uniform4fv(o.colorMultiplier_loc,[1,1,1,1]),t.uniform3fv(o.aditionalMov_loc,[0,0,0]),t.uniform1i(o.colorType_loc,this._soundSurfaceVolumeOwner._colorType);var n=this._soundSurfaceVolumeOwner._legendColors4,a=this._soundSurfaceVolumeOwner._legendValues;t.uniform4fv(o.uLegendColors_loc,n),t.uniform1fv(o.uLegendValues_loc,a),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.uniform1f(o.uModelOpacity_loc,1),t.uniform4fv(o.oneColor4_loc,[.99,.5,.25,1]);for(var s=this._timeSlicesArray.length,l=0;l<s;l++){var u=this._timeSlicesArray[l],c=u._jsonFile.minSoundValue,d=u._jsonFile.maxSoundValue;t.uniform1fv(o.uMinMaxValue_loc,new Float32Array([c,d])),u.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(t,o);for(var h=e.vboMemoryManager,f=u.vboKeysContainer.vboCacheKeysArray.length,g=0;g<f;g++){var p=u.vboKeysContainer.vboCacheKeysArray[g];if(!p)return!1;if(!p.bindDataPosition(o,h))return!1;if(!p.bindDataCustom(o,h,"soundLevelValue",o.value_loc))return!1;if(!p.bindDataIndice(o,h))return!1;var m=t.TRIANGLES,v=p.vboBufferIdx.dataGlType;t.drawElements(m,p.indicesCount,v,0)}}return t.disable(t.BLEND),o.disableVertexAttribArrayAll(),e.postFxShadersManager.useProgram(null),!0},En.prototype._prepareLayer=function(){if(this._isPrepared)return!0;if(void 0===this._timeSlicesArray&&(this._timeSlicesArray=[]),0===this._timeSlicesArray.length)for(var e=this.timeSliceFileNames.length,t=0;t<e;t++){var r=this.timeSliceFileFolderPath+"\\"+this.timeSliceFileNames[t],i=new An({filePath:r,soundSurfaceLayerOwner:this});this._timeSlicesArray.push(i)}var o=!0,n=this._timeSlicesArray.length;for(t=0;t<n;t++){(i=this._timeSlicesArray[t])._prepare()||(o=!1)}if(!o)return!1;if(0===this._timeSlicesArray.length)return!1;if(void 0===this._makingMeshProcess&&(this._makingMeshProcess=I.processState.NO_STARTED),this._makingMeshProcess===I.processState.NO_STARTED){void 0===this.vboKeysContainer&&(this.vboKeysContainer=new xt,this.vboKeysContainer.newVBOVertexIdxCacheKey());i=this._timeSlicesArray[this._currTimeSliceIdx];void 0===this.geoLocDataManager&&(this.geoLocDataManager=new ye);var a=this.geoLocDataManager.getCurrentGeoLocationData();void 0===a&&(a=this.geoLocDataManager.newGeoLocationData("default"));var s=i._jsonFile.centerGeographicCoord;a=on.calculateGeoLocationData(s.longitude,s.latitude,s.altitude,0,0,0,a);var l=new Float32Array(i._jsonFile.positions),u=new Float32Array(i._jsonFile.soundLevelValues),c=this._soundSurfaceVolumeOwner.weatherStation.magoManager,d=this.vboKeysContainer.getVboKey(0);if(l.length/3>=65535){c.getGl().getExtension("OES_element_index_uint");var h=new Uint32Array(i._jsonFile.indices);d.setDataArrayIdx(h,c.vboMemoryManager)}else{h=new Uint16Array(i._jsonFile.indices);d.setDataArrayIdx(h,c.vboMemoryManager)}d.setDataArrayPos(l,c.vboMemoryManager);return d.setDataArrayCustom(u,c.vboMemoryManager,1,"soundLevelValue",4),this._makingMeshProcess=I.processState.FINISHED,!1}return this._isPrepared=!0,this._isPrepared};var Ln=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._soundSurfLayersArray,this.weatherStation,this._geoJsonIndexFileLoadState=I.fileLoadState.READY,this._geoJsonIndexFile,this._geoJsonIndexFilePath,this._geoJsonIndexFileFolderPath,this._allLayersArePrepared=!1,this._geoJsonIndexFilePathsArray,this._animationState=0,this._animationStartTime=0,this._totalAnimTime,this._increTime,this._colorType=5,this._legendColors4,this._legendValues,this._TEST_setLegendsColors(),t&&(t.geoJsonIndexFilePath&&(this._geoJsonIndexFilePath=t.geoJsonIndexFilePath),t.geoJsonIndexFilePathsArray&&(this._geoJsonIndexFilePathsArray=t.geoJsonIndexFilePathsArray),t.geoJsonIndexFileFolderPath&&(this._geoJsonIndexFileFolderPath=t.geoJsonIndexFileFolderPath),void 0!==t.animationSpeed&&(this._animationSpeed=t.animationSpeed))};Ln.prototype._TEST_setLegendsColors=function(){this._legendColors4=new Float32Array([0,0,143/255,128/255,0,15/255,1,128/255,0,95/255,1,128/255,0,175/255,1,128/255,0,1,1,128/255,79/255,1,175/255,128/255,159/255,1,95/255,128/255,239/255,1,15/255,128/255,1,191/255,0,128/255,1,111/255,0,128/255,1,31/255,0,128/255,207/255,0,0,128/255,127/255,0,0,128/255,127/255,0,0,128/255,0,0,0,0,0,0,0,0]);for(var e=45.71200180053711,t=this._legendColors4.length/4,r=43.69499588012695/(t-1),i=[],o=0;o<t;o++)i.push(r*o+e);this._legendValues=new Float32Array(i)},Ln.prototype.getSoundLayer=function(e){if(void 0!==this._soundSurfLayersArray&&0!==this._soundSurfLayersArray.length&&void 0!==e)return e<0?e=0:e>this._soundSurfLayersArray.length-1&&(e=this._soundSurfLayersArray.length-1),this._soundSurfLayersArray[e]},Ln.prototype.setLegendColors4=function(e){if(void 0===e)return!1;if(e.constructor===Float32Array)this._legendColors4=e;else if(e.constructor===Uint8Array){this._legendColors4=new Float32Array(16);var t=e.length;t>64&&(t=64);for(var r=0;r<t;r++)this._legendColors4[r]=new Float32Array(e[r]/255)[0]}},Ln.prototype.setLegendValues=function(e){if(void 0===e)return!1;this._legendValues=new Float32Array(e)},Ln.prototype._loadGeoJsonIndexFile=function(){if(this._geoJsonIndexFileLoadState===I.fileLoadState.READY){this._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._geoJsonIndexFilePath,void 0,void 0,"json","GET").done(function(t){e._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,e._geoJsonIndexFile=t})}},Ln.prototype._prepareSoundSurfaceGeoJsonIndexFile=function(){return this._geoJsonIndexFileLoadState===I.fileLoadState.READY?(this._loadGeoJsonIndexFile(),!1):this._geoJsonIndexFileLoadState===I.fileLoadState.LOADING_FINISHED},Ln.prototype.getSoundSurfacesLayersCount=function(){return void 0===this._soundSurfLayersArray?0:this._soundSurfLayersArray.length},Ln.prototype.newSoundSurfaceLayer=function(e){void 0===this._soundSurfLayersArray&&(this._soundSurfLayersArray=[]);var t=new En(e);return this._soundSurfLayersArray.push(t),t},Ln.prototype._prepareSoundSurfacesLayers=function(e){if(!0===this._allLayersArePrepared)return!0;if(0===(s=this.getSoundSurfacesLayersCount()))for(var t=this._geoJsonIndexFile.layersCount,r=this._geoJsonIndexFileFolderPath,i=0;i<t;i++){var o=this._geoJsonIndexFile.layers[i],n={soundSurfaceVolumeOwner:this,timeInterval_min:o.timeInterval_min,timeSlicesCount:o.timeSlicesCount,timeSliceFileNames:o.timeSliceFileNames,timeSliceFileFolderPath:r};this.newSoundSurfaceLayer(n)}var a=!0,s=this.getSoundSurfacesLayersCount();for(i=0;i<s;i++){this._soundSurfLayersArray[i]._prepareLayer()||(a=!1)}return this._allLayersArePrepared=a,!1},Ln.prototype.addJsonsArray=function(e){if(void 0===e||0===e.length)return!1;if(this._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,0===this.getSoundSurfacesLayersCount())var t={soundSurfaceVolumeOwner:this},r=this.newSoundSurfaceLayer(t);void 0===(r=this.getSoundLayer(0))._timeSlicesArray&&(r._timeSlicesArray=[]);for(var i=e.length,o=0;o<i;o++){var n=new An(t={soundSurfaceLayerOwner:r});n._jsonFile=e[o],n._fileileLoadState=I.fileLoadState.LOADING_FINISHED,r._timeSlicesArray.push(n)}return!0},Ln.prototype.prepareVolume=function(e){return!!this._prepareSoundSurfaceGeoJsonIndexFile()&&!!this._prepareSoundSurfacesLayers()},Ln.prototype.getCurrentLayerIdx=function(){return this.currLayerIdx},Ln.prototype.setCurrentLayerIdx=function(e){if(void 0===e)return!1;e<0?e=0:e>=this.getSoundSurfacesLayersCount()&&(e=this.getSoundSurfacesLayersCount()-1),this.currLayerIdx=e},Ln.prototype.render=function(e){return!!this.prepareVolume(e)&&(0!==this.getSoundSurfacesLayersCount()&&(void 0===this.currLayerIdx&&(this.currLayerIdx=0),this._soundSurfLayersArray[this.currLayerIdx].render(e),!0))};var wn={isobaric:[40,50,100,200,300,500,700,1e3,1500,2e3,3e3,5e3,7e3,1e4,15e3,2e4,25e3,3e4,4e4,5e4,6e4,7e4,85e3,92500,95e3,1e5],lat:[89.921875,89.765625,89.609375,89.453125,89.296875,89.140625,88.984375,88.828125,88.671875,88.515625,88.359375,88.203125,88.046875,87.890625,87.734375,87.578125,87.421875,87.265625,87.109375,86.953125,86.796875,86.640625,86.484375,86.328125,86.171875,86.015625,85.859375,85.703125,85.546875,85.390625,85.234375,85.078125,84.921875,84.765625,84.609375,84.453125,84.296875,84.140625,83.984375,83.828125,83.671875,83.515625,83.359375,83.203125,83.046875,82.890625,82.734375,82.578125,82.421875,82.265625,82.109375,81.953125,81.796875,81.640625,81.484375,81.328125,81.171875,81.015625,80.859375,80.703125,80.546875,80.390625,80.234375,80.078125,79.921875,79.765625,79.609375,79.453125,79.296875,79.140625,78.984375,78.828125,78.671875,78.515625,78.359375,78.203125,78.046875,77.890625,77.734375,77.578125,77.421875,77.265625,77.109375,76.953125,76.796875,76.640625,76.484375,76.328125,76.171875,76.015625,75.859375,75.703125,75.546875,75.390625,75.234375,75.078125,74.921875,74.765625,74.609375,74.453125,74.296875,74.140625,73.984375,73.828125,73.671875,73.515625,73.359375,73.203125,73.046875,72.890625,72.734375,72.578125,72.421875,72.265625,72.109375,71.953125,71.796875,71.640625,71.484375,71.328125,71.171875,71.015625,70.859375,70.703125,70.546875,70.390625,70.234375,70.078125,69.921875,69.765625,69.609375,69.453125,69.296875,69.140625,68.984375,68.828125,68.671875,68.515625,68.359375,68.203125,68.046875,67.890625,67.734375,67.578125,67.421875,67.265625,67.109375,66.953125,66.796875,66.640625,66.484375,66.328125,66.171875,66.015625,65.859375,65.703125,65.546875,65.390625,65.234375,65.078125,64.921875,64.765625,64.609375,64.453125,64.296875,64.140625,63.984375,63.828125,63.671875,63.515625,63.359375,63.203125,63.046875,62.890625,62.734375,62.578125,62.421875,62.265625,62.109375,61.953125,61.796875,61.640625,61.484375,61.328125,61.171875,61.015625,60.859375,60.703125,60.546875,60.390625,60.234375,60.078125,59.921875,59.765625,59.609375,59.453125,59.296875,59.140625,58.984375,58.828125,58.671875,58.515625,58.359375,58.203125,58.046875,57.890625,57.734375,57.578125,57.421875,57.265625,57.109375,56.953125,56.796875,56.640625,56.484375,56.328125,56.171875,56.015625,55.859375,55.703125,55.546875,55.390625,55.234375,55.078125,54.921875,54.765625,54.609375,54.453125,54.296875,54.140625,53.984375,53.828125,53.671875,53.515625,53.359375,53.203125,53.046875,52.890625,52.734375,52.578125,52.421875,52.265625,52.109375,51.953125,51.796875,51.640625,51.484375,51.328125,51.171875,51.015625,50.859375,50.703125,50.546875,50.390625,50.234375,50.078125,49.921875,49.765625,49.609375,49.453125,49.296875,49.140625,48.984375,48.828125,48.671875,48.515625,48.359375,48.203125,48.046875,47.890625,47.734375,47.578125,47.421875,47.265625,47.109375,46.953125,46.796875,46.640625,46.484375,46.328125,46.171875,46.015625,45.859375,45.703125,45.546875,45.390625,45.234375,45.078125,44.921875,44.765625,44.609375,44.453125,44.296875,44.140625,43.984375,43.828125,43.671875,43.515625,43.359375,43.203125,43.046875,42.890625,42.734375,42.578125,42.421875,42.265625,42.109375,41.953125,41.796875,41.640625,41.484375,41.328125,41.171875,41.015625,40.859375,40.703125,40.546875,40.390625,40.234375,40.078125,39.921875,39.765625,39.609375,39.453125,39.296875,39.140625,38.984375,38.828125,38.671875,38.515625,38.359375,38.203125,38.046875,37.890625,37.734375,37.578125,37.421875,37.265625,37.109375,36.953125,36.796875,36.640625,36.484375,36.328125,36.171875,36.015625,35.859375,35.703125,35.546875,35.390625,35.234375,35.078125,34.921875,34.765625,34.609375,34.453125,34.296875,34.140625,33.984375,33.828125,33.671875,33.515625,33.359375,33.203125,33.046875,32.890625,32.734375,32.578125,32.421875,32.265625,32.109375,31.953125,31.796875,31.640625,31.484375,31.328125,31.171875,31.015625,30.859375,30.703125,30.546875,30.390625,30.234375,30.078125,29.921875,29.765625,29.609375,29.453125,29.296875,29.140625,28.984375,28.828125,28.671875,28.515625,28.359375,28.203125,28.046875,27.890625,27.734375,27.578125,27.421875,27.265625,27.109375,26.953125,26.796875,26.640625,26.484375,26.328125,26.171875,26.015625,25.859375,25.703125,25.546875,25.390625,25.234375,25.078125,24.921875,24.765625,24.609375,24.453125,24.296875,24.140625,23.984375,23.828125,23.671875,23.515625,23.359375,23.203125,23.046875,22.890625,22.734375,22.578125,22.421875,22.265625,22.109375,21.953125,21.796875,21.640625,21.484375,21.328125,21.171875,21.015625,20.859375,20.703125,20.546875,20.390625,20.234375,20.078125,19.921875,19.765625,19.609375,19.453125,19.296875,19.140625,18.984375,18.828125,18.671875,18.515625,18.359375,18.203125,18.046875,17.890625,17.734375,17.578125,17.421875,17.265625,17.109375,16.953125,16.796875,16.640625,16.484375,16.328125,16.171875,16.015625,15.859375,15.703125,15.546875,15.390625,15.234375,15.078125,14.921875,14.765625,14.609375,14.453125,14.296875,14.140625,13.984375,13.828125,13.671875,13.515625,13.359375,13.203125,13.046875,12.890625,12.734375,12.578125,12.421875,12.265625,12.109375,11.953125,11.796875,11.640625,11.484375,11.328125,11.171875,11.015625,10.859375,10.703125,10.546875,10.390625,10.234375,10.078125,9.921875,9.765625,9.609375,9.453125,9.296875,9.140625,8.984375,8.828125,8.671875,8.515625,8.359375,8.203125,8.046875,7.890625,7.734375,7.578125,7.421875,7.265625,7.109375,6.953125,6.796875,6.640625,6.484375,6.328125,6.171875,6.015625,5.859375,5.703125,5.546875,5.390625,5.234375,5.078125,4.921875,4.765625,4.609375,4.453125,4.296875,4.140625,3.984375,3.828125,3.671875,3.515625,3.359375,3.203125,3.046875,2.890625,2.734375,2.578125,2.421875,2.265625,2.109375,1.953125,1.796875,1.640625,1.484375,1.328125,1.171875,1.015625,.859375,.703125,.546875,.390625,.234375,.078125,-.078125,-.234375,-.390625,-.546875,-.703125,-.859375,-1.015625,-1.171875,-1.328125,-1.484375,-1.640625,-1.796875,-1.953125,-2.109375,-2.265625,-2.421875,-2.578125,-2.734375,-2.890625,-3.046875,-3.203125,-3.359375,-3.515625,-3.671875,-3.828125,-3.984375,-4.140625,-4.296875,-4.453125,-4.609375,-4.765625,-4.921875,-5.078125,-5.234375,-5.390625,-5.546875,-5.703125,-5.859375,-6.015625,-6.171875,-6.328125,-6.484375,-6.640625,-6.796875,-6.953125,-7.109375,-7.265625,-7.421875,-7.578125,-7.734375,-7.890625,-8.046875,-8.203125,-8.359375,-8.515625,-8.671875,-8.828125,-8.984375,-9.140625,-9.296875,-9.453125,-9.609375,-9.765625,-9.921875,-10.078125,-10.234375,-10.390625,-10.546875,-10.703125,-10.859375,-11.015625,-11.171875,-11.328125,-11.484375,-11.640625,-11.796875,-11.953125,-12.109375,-12.265625,-12.421875,-12.578125,-12.734375,-12.890625,-13.046875,-13.203125,-13.359375,-13.515625,-13.671875,-13.828125,-13.984375,-14.140625,-14.296875,-14.453125,-14.609375,-14.765625,-14.921875,-15.078125,-15.234375,-15.390625,-15.546875,-15.703125,-15.859375,-16.015625,-16.171875,-16.328125,-16.484375,-16.640625,-16.796875,-16.953125,-17.109375,-17.265625,-17.421875,-17.578125,-17.734375,-17.890625,-18.046875,-18.203125,-18.359375,-18.515625,-18.671875,-18.828125,-18.984375,-19.140625,-19.296875,-19.453125,-19.609375,-19.765625,-19.921875,-20.078125,-20.234375,-20.390625,-20.546875,-20.703125,-20.859375,-21.015625,-21.171875,-21.328125,-21.484375,-21.640625,-21.796875,-21.953125,-22.109375,-22.265625,-22.421875,-22.578125,-22.734375,-22.890625,-23.046875,-23.203125,-23.359375,-23.515625,-23.671875,-23.828125,-23.984375,-24.140625,-24.296875,-24.453125,-24.609375,-24.765625,-24.921875,-25.078125,-25.234375,-25.390625,-25.546875,-25.703125,-25.859375,-26.015625,-26.171875,-26.328125,-26.484375,-26.640625,-26.796875,-26.953125,-27.109375,-27.265625,-27.421875,-27.578125,-27.734375,-27.890625,-28.046875,-28.203125,-28.359375,-28.515625,-28.671875,-28.828125,-28.984375,-29.140625,-29.296875,-29.453125,-29.609375,-29.765625,-29.921875,-30.078125,-30.234375,-30.390625,-30.546875,-30.703125,-30.859375,-31.015625,-31.171875,-31.328125,-31.484375,-31.640625,-31.796875,-31.953125,-32.109375,-32.265625,-32.421875,-32.578125,-32.734375,-32.890625,-33.046875,-33.203125,-33.359375,-33.515625,-33.671875,-33.828125,-33.984375,-34.140625,-34.296875,-34.453125,-34.609375,-34.765625,-34.921875,-35.078125,-35.234375,-35.390625,-35.546875,-35.703125,-35.859375,-36.015625,-36.171875,-36.328125,-36.484375,-36.640625,-36.796875,-36.953125,-37.109375,-37.265625,-37.421875,-37.578125,-37.734375,-37.890625,-38.046875,-38.203125,-38.359375,-38.515625,-38.671875,-38.828125,-38.984375,-39.140625,-39.296875,-39.453125,-39.609375,-39.765625,-39.921875,-40.078125,-40.234375,-40.390625,-40.546875,-40.703125,-40.859375,-41.015625,-41.171875,-41.328125,-41.484375,-41.640625,-41.796875,-41.953125,-42.109375,-42.265625,-42.421875,-42.578125,-42.734375,-42.890625,-43.046875,-43.203125,-43.359375,-43.515625,-43.671875,-43.828125,-43.984375,-44.140625,-44.296875,-44.453125,-44.609375,-44.765625,-44.921875,-45.078125,-45.234375,-45.390625,-45.546875,-45.703125,-45.859375,-46.015625,-46.171875,-46.328125,-46.484375,-46.640625,-46.796875,-46.953125,-47.109375,-47.265625,-47.421875,-47.578125,-47.734375,-47.890625,-48.046875,-48.203125,-48.359375,-48.515625,-48.671875,-48.828125,-48.984375,-49.140625,-49.296875,-49.453125,-49.609375,-49.765625,-49.921875,-50.078125,-50.234375,-50.390625,-50.546875,-50.703125,-50.859375,-51.015625,-51.171875,-51.328125,-51.484375,-51.640625,-51.796875,-51.953125,-52.109375,-52.265625,-52.421875,-52.578125,-52.734375,-52.890625,-53.046875,-53.203125,-53.359375,-53.515625,-53.671875,-53.828125,-53.984375,-54.140625,-54.296875,-54.453125,-54.609375,-54.765625,-54.921875,-55.078125,-55.234375,-55.390625,-55.546875,-55.703125,-55.859375,-56.015625,-56.171875,-56.328125,-56.484375,-56.640625,-56.796875,-56.953125,-57.109375,-57.265625,-57.421875,-57.578125,-57.734375,-57.890625,-58.046875,-58.203125,-58.359375,-58.515625,-58.671875,-58.828125,-58.984375,-59.140625,-59.296875,-59.453125,-59.609375,-59.765625,-59.921875,-60.078125,-60.234375,-60.390625,-60.546875,-60.703125,-60.859375,-61.015625,-61.171875,-61.328125,-61.484375,-61.640625,-61.796875,-61.953125,-62.109375,-62.265625,-62.421875,-62.578125,-62.734375,-62.890625,-63.046875,-63.203125,-63.359375,-63.515625,-63.671875,-63.828125,-63.984375,-64.140625,-64.296875,-64.453125,-64.609375,-64.765625,-64.921875,-65.078125,-65.234375,-65.390625,-65.546875,-65.703125,-65.859375,-66.015625,-66.171875,-66.328125,-66.484375,-66.640625,-66.796875,-66.953125,-67.109375,-67.265625,-67.421875,-67.578125,-67.734375,-67.890625,-68.046875,-68.203125,-68.359375,-68.515625,-68.671875,-68.828125,-68.984375,-69.140625,-69.296875,-69.453125,-69.609375,-69.765625,-69.921875,-70.078125,-70.234375,-70.390625,-70.546875,-70.703125,-70.859375,-71.015625,-71.171875,-71.328125,-71.484375,-71.640625,-71.796875,-71.953125,-72.109375,-72.265625,-72.421875,-72.578125,-72.734375,-72.890625,-73.046875,-73.203125,-73.359375,-73.515625,-73.671875,-73.828125,-73.984375,-74.140625,-74.296875,-74.453125,-74.609375,-74.765625,-74.921875,-75.078125,-75.234375,-75.390625,-75.546875,-75.703125,-75.859375,-76.015625,-76.171875,-76.328125,-76.484375,-76.640625,-76.796875,-76.953125,-77.109375,-77.265625,-77.421875,-77.578125,-77.734375,-77.890625,-78.046875,-78.203125,-78.359375,-78.515625,-78.671875,-78.828125,-78.984375,-79.140625,-79.296875,-79.453125,-79.609375,-79.765625,-79.921875,-80.078125,-80.234375,-80.390625,-80.546875,-80.703125,-80.859375,-81.015625,-81.171875,-81.328125,-81.484375,-81.640625,-81.796875,-81.953125,-82.109375,-82.265625,-82.421875,-82.578125,-82.734375,-82.890625,-83.046875,-83.203125,-83.359375,-83.515625,-83.671875,-83.828125,-83.984375,-84.140625,-84.296875,-84.453125,-84.609375,-84.765625,-84.921875,-85.078125,-85.234375,-85.390625,-85.546875,-85.703125,-85.859375,-86.015625,-86.171875,-86.328125,-86.484375,-86.640625,-86.796875,-86.953125,-87.109375,-87.265625,-87.421875,-87.578125,-87.734375,-87.890625,-88.046875,-88.203125,-88.359375,-88.515625,-88.671875,-88.828125,-88.984375,-89.140625,-89.296875,-89.453125,-89.609375,-89.765625,-89.921875],lon:[.117188,.351563,.585938,.820313,1.054688,1.289063,1.523438,1.757813,1.992188,2.226563,2.460938,2.695313,2.929688,3.164063,3.398438,3.632813,3.867188,4.101563,4.335938,4.570313,4.804688,5.039063,5.273438,5.507813,5.742188,5.976563,6.210938,6.445313,6.679688,6.914063,7.148438,7.382813,7.617188,7.851563,8.085938,8.320313,8.554688,8.789063,9.023438,9.257813,9.492188,9.726563,9.960938,10.195313,10.429688,10.664063,10.898438,11.132813,11.367188,11.601563,11.835938,12.070313,12.304688,12.539063,12.773438,13.007813,13.242188,13.476563,13.710938,13.945313,14.179688,14.414063,14.648438,14.882813,15.117188,15.351563,15.585938,15.820313,16.054688,16.289062,16.523438,16.757812,16.992188,17.226562,17.460938,17.695312,17.929688,18.164062,18.398438,18.632812,18.867188,19.101562,19.335938,19.570312,19.804688,20.039062,20.273438,20.507812,20.742188,20.976562,21.210938,21.445312,21.679688,21.914062,22.148438,22.382812,22.617188,22.851562,23.085938,23.320312,23.554688,23.789062,24.023438,24.257812,24.492188,24.726562,24.960938,25.195312,25.429688,25.664062,25.898438,26.132812,26.367188,26.601562,26.835938,27.070312,27.304688,27.539062,27.773438,28.007812,28.242188,28.476562,28.710938,28.945312,29.179688,29.414062,29.648438,29.882812,30.117188,30.351562,30.585938,30.820312,31.054688,31.289062,31.523438,31.757812,31.992188,32.226562,32.460938,32.695312,32.929688,33.164062,33.398438,33.632812,33.867188,34.101562,34.335938,34.570312,34.804688,35.039062,35.273438,35.507812,35.742188,35.976562,36.210938,36.445312,36.679688,36.914062,37.148438,37.382812,37.617188,37.851562,38.085938,38.320312,38.554688,38.789062,39.023438,39.257812,39.492188,39.726562,39.960938,40.195312,40.429688,40.664062,40.898438,41.132812,41.367188,41.601562,41.835938,42.070312,42.304688,42.539062,42.773438,43.007812,43.242188,43.476562,43.710938,43.945312,44.179688,44.414062,44.648438,44.882812,45.117188,45.351562,45.585938,45.820312,46.054688,46.289062,46.523438,46.757812,46.992188,47.226562,47.460938,47.695312,47.929688,48.164062,48.398438,48.632812,48.867188,49.101562,49.335938,49.570312,49.804688,50.039062,50.273438,50.507812,50.742188,50.976562,51.210938,51.445312,51.679688,51.914062,52.148438,52.382812,52.617188,52.851562,53.085938,53.320312,53.554688,53.789062,54.023438,54.257812,54.492188,54.726562,54.960938,55.195312,55.429688,55.664062,55.898438,56.132812,56.367188,56.601562,56.835938,57.070312,57.304688,57.539062,57.773438,58.007812,58.242188,58.476562,58.710938,58.945312,59.179688,59.414062,59.648438,59.882812,60.117188,60.351562,60.585938,60.820312,61.054688,61.289062,61.523438,61.757812,61.992188,62.226562,62.460938,62.695312,62.929688,63.164062,63.398438,63.632812,63.867188,64.10156,64.33594,64.57031,64.80469,65.03906,65.27344,65.50781,65.74219,65.97656,66.21094,66.44531,66.67969,66.91406,67.14844,67.38281,67.61719,67.85156,68.08594,68.32031,68.55469,68.78906,69.02344,69.25781,69.49219,69.72656,69.96094,70.19531,70.42969,70.66406,70.89844,71.13281,71.36719,71.60156,71.83594,72.07031,72.30469,72.53906,72.77344,73.00781,73.24219,73.47656,73.71094,73.94531,74.17969,74.41406,74.64844,74.88281,75.11719,75.35156,75.58594,75.82031,76.05469,76.28906,76.52344,76.75781,76.99219,77.22656,77.46094,77.69531,77.92969,78.16406,78.39844,78.63281,78.86719,79.10156,79.33594,79.57031,79.80469,80.03906,80.27344,80.50781,80.74219,80.97656,81.21094,81.44531,81.67969,81.91406,82.14844,82.38281,82.61719,82.85156,83.08594,83.32031,83.55469,83.78906,84.02344,84.25781,84.49219,84.72656,84.96094,85.19531,85.42969,85.66406,85.89844,86.13281,86.36719,86.60156,86.83594,87.07031,87.30469,87.53906,87.77344,88.00781,88.24219,88.47656,88.71094,88.94531,89.17969,89.41406,89.64844,89.88281,90.11719,90.35156,90.58594,90.82031,91.05469,91.28906,91.52344,91.75781,91.99219,92.22656,92.46094,92.69531,92.92969,93.16406,93.39844,93.63281,93.86719,94.10156,94.33594,94.57031,94.80469,95.03906,95.27344,95.50781,95.74219,95.97656,96.21094,96.44531,96.67969,96.91406,97.14844,97.38281,97.61719,97.85156,98.08594,98.32031,98.55469,98.78906,99.02344,99.25781,99.49219,99.72656,99.96094,100.19531,100.42969,100.66406,100.89844,101.13281,101.36719,101.60156,101.83594,102.07031,102.30469,102.53906,102.77344,103.00781,103.24219,103.47656,103.71094,103.94531,104.17969,104.41406,104.64844,104.88281,105.11719,105.35156,105.58594,105.82031,106.05469,106.28906,106.52344,106.75781,106.99219,107.22656,107.46094,107.69531,107.92969,108.16406,108.39844,108.63281,108.86719,109.10156,109.33594,109.57031,109.80469,110.03906,110.27344,110.50781,110.74219,110.97656,111.21094,111.44531,111.67969,111.91406,112.14844,112.38281,112.61719,112.85156,113.08594,113.32031,113.55469,113.78906,114.02344,114.25781,114.49219,114.72656,114.96094,115.19531,115.42969,115.66406,115.89844,116.13281,116.36719,116.60156,116.83594,117.07031,117.30469,117.53906,117.77344,118.00781,118.24219,118.47656,118.71094,118.94531,119.17969,119.41406,119.64844,119.88281,120.11719,120.35156,120.58594,120.82031,121.05469,121.28906,121.52344,121.75781,121.99219,122.22656,122.46094,122.69531,122.92969,123.16406,123.39844,123.63281,123.86719,124.10156,124.33594,124.57031,124.80469,125.03906,125.27344,125.50781,125.74219,125.97656,126.21094,126.44531,126.67969,126.91406,127.14844,127.38281,127.61719,127.85156,128.08594,128.32031,128.55469,128.78906,129.02344,129.25781,129.49219,129.72656,129.96094,130.19531,130.42969,130.66406,130.89844,131.13281,131.36719,131.60156,131.83594,132.07031,132.30469,132.53906,132.77344,133.00781,133.24219,133.47656,133.71094,133.94531,134.17969,134.41406,134.64844,134.88281,135.11719,135.35156,135.58594,135.82031,136.05469,136.28906,136.52344,136.75781,136.99219,137.22656,137.46094,137.69531,137.92969,138.16406,138.39844,138.63281,138.86719,139.10156,139.33594,139.57031,139.80469,140.03906,140.27344,140.50781,140.74219,140.97656,141.21094,141.44531,141.67969,141.91406,142.14844,142.38281,142.61719,142.85156,143.08594,143.32031,143.55469,143.78906,144.02344,144.25781,144.49219,144.72656,144.96094,145.19531,145.42969,145.66406,145.89844,146.13281,146.36719,146.60156,146.83594,147.07031,147.30469,147.53906,147.77344,148.00781,148.24219,148.47656,148.71094,148.94531,149.17969,149.41406,149.64844,149.88281,150.11719,150.35156,150.58594,150.82031,151.05469,151.28906,151.52344,151.75781,151.99219,152.22656,152.46094,152.69531,152.92969,153.16406,153.39844,153.63281,153.86719,154.10156,154.33594,154.57031,154.80469,155.03906,155.27344,155.50781,155.74219,155.97656,156.21094,156.44531,156.67969,156.91406,157.14844,157.38281,157.61719,157.85156,158.08594,158.32031,158.55469,158.78906,159.02344,159.25781,159.49219,159.72656,159.96094,160.19531,160.42969,160.66406,160.89844,161.13281,161.36719,161.60156,161.83594,162.07031,162.30469,162.53906,162.77344,163.00781,163.24219,163.47656,163.71094,163.94531,164.17969,164.41406,164.64844,164.88281,165.11719,165.35156,165.58594,165.82031,166.05469,166.28906,166.52344,166.75781,166.99219,167.22656,167.46094,167.69531,167.92969,168.16406,168.39844,168.63281,168.86719,169.10156,169.33594,169.57031,169.80469,170.03906,170.27344,170.50781,170.74219,170.97656,171.21094,171.44531,171.67969,171.91406,172.14844,172.38281,172.61719,172.85156,173.08594,173.32031,173.55469,173.78906,174.02344,174.25781,174.49219,174.72656,174.96094,175.19531,175.42969,175.66406,175.89844,176.13281,176.36719,176.60156,176.83594,177.07031,177.30469,177.53906,177.77344,178.00781,178.24219,178.47656,178.71094,178.94531,179.17969,179.41406,179.64844,179.88281,180.11719,180.35156,180.58594,180.82031,181.05469,181.28906,181.52344,181.75781,181.99219,182.22656,182.46094,182.69531,182.92969,183.16406,183.39844,183.63281,183.86719,184.10156,184.33594,184.57031,184.80469,185.03906,185.27344,185.50781,185.74219,185.97656,186.21094,186.44531,186.67969,186.91406,187.14844,187.38281,187.61719,187.85156,188.08594,188.32031,188.55469,188.78906,189.02344,189.25781,189.49219,189.72656,189.96094,190.19531,190.42969,190.66406,190.89844,191.13281,191.36719,191.60156,191.83594,192.07031,192.30469,192.53906,192.77344,193.00781,193.24219,193.47656,193.71094,193.94531,194.17969,194.41406,194.64844,194.88281,195.11719,195.35156,195.58594,195.82031,196.05469,196.28906,196.52344,196.75781,196.99219,197.22656,197.46094,197.69531,197.92969,198.16406,198.39844,198.63281,198.86719,199.10156,199.33594,199.57031,199.80469,200.03906,200.27344,200.50781,200.74219,200.97656,201.21094,201.44531,201.67969,201.91406,202.14844,202.38281,202.61719,202.85156,203.08594,203.32031,203.55469,203.78906,204.02344,204.25781,204.49219,204.72656,204.96094,205.19531,205.42969,205.66406,205.89844,206.13281,206.36719,206.60156,206.83594,207.07031,207.30469,207.53906,207.77344,208.00781,208.24219,208.47656,208.71094,208.94531,209.17969,209.41406,209.64844,209.88281,210.11719,210.35156,210.58594,210.82031,211.05469,211.28906,211.52344,211.75781,211.99219,212.22656,212.46094,212.69531,212.92969,213.16406,213.39844,213.63281,213.86719,214.10156,214.33594,214.57031,214.80469,215.03906,215.27344,215.50781,215.74219,215.97656,216.21094,216.44531,216.67969,216.91406,217.14844,217.38281,217.61719,217.85156,218.08594,218.32031,218.55469,218.78906,219.02344,219.25781,219.49219,219.72656,219.96094,220.19531,220.42969,220.66406,220.89844,221.13281,221.36719,221.60156,221.83594,222.07031,222.30469,222.53906,222.77344,223.00781,223.24219,223.47656,223.71094,223.94531,224.17969,224.41406,224.64844,224.88281,225.11719,225.35156,225.58594,225.82031,226.05469,226.28906,226.52344,226.75781,226.99219,227.22656,227.46094,227.69531,227.92969,228.16406,228.39844,228.63281,228.86719,229.10156,229.33594,229.57031,229.80469,230.03906,230.27344,230.50781,230.74219,230.97656,231.21094,231.44531,231.67969,231.91406,232.14844,232.38281,232.61719,232.85156,233.08594,233.32031,233.55469,233.78906,234.02344,234.25781,234.49219,234.72656,234.96094,235.19531,235.42969,235.66406,235.89844,236.13281,236.36719,236.60156,236.83594,237.07031,237.30469,237.53906,237.77344,238.00781,238.24219,238.47656,238.71094,238.94531,239.17969,239.41406,239.64844,239.88281,240.11719,240.35156,240.58594,240.82031,241.05469,241.28906,241.52344,241.75781,241.99219,242.22656,242.46094,242.69531,242.92969,243.16406,243.39844,243.63281,243.86719,244.10156,244.33594,244.57031,244.80469,245.03906,245.27344,245.50781,245.74219,245.97656,246.21094,246.44531,246.67969,246.91406,247.14844,247.38281,247.61719,247.85156,248.08594,248.32031,248.55469,248.78906,249.02344,249.25781,249.49219,249.72656,249.96094,250.19531,250.42969,250.66406,250.89844,251.13281,251.36719,251.60156,251.83594,252.07031,252.30469,252.53906,252.77344,253.00781,253.24219,253.47656,253.71094,253.94531,254.17969,254.41406,254.64844,254.88281,255.11719,255.35156,255.58594,255.82031,256.0547,256.28906,256.52344,256.7578,256.9922,257.22656,257.46094,257.6953,257.9297,258.16406,258.39844,258.6328,258.8672,259.10156,259.33594,259.5703,259.8047,260.03906,260.27344,260.5078,260.7422,260.97656,261.21094,261.4453,261.6797,261.91406,262.14844,262.3828,262.6172,262.85156,263.08594,263.3203,263.5547,263.78906,264.02344,264.2578,264.4922,264.72656,264.96094,265.1953,265.4297,265.66406,265.89844,266.1328,266.3672,266.60156,266.83594,267.0703,267.3047,267.53906,267.77344,268.0078,268.2422,268.47656,268.71094,268.9453,269.1797,269.41406,269.64844,269.8828,270.1172,270.35156,270.58594,270.8203,271.0547,271.28906,271.52344,271.7578,271.9922,272.22656,272.46094,272.6953,272.9297,273.16406,273.39844,273.6328,273.8672,274.10156,274.33594,274.5703,274.8047,275.03906,275.27344,275.5078,275.7422,275.97656,276.21094,276.4453,276.6797,276.91406,277.14844,277.3828,277.6172,277.85156,278.08594,278.3203,278.5547,278.78906,279.02344,279.2578,279.4922,279.72656,279.96094,280.1953,280.4297,280.66406,280.89844,281.1328,281.3672,281.60156,281.83594,282.0703,282.3047,282.53906,282.77344,283.0078,283.2422,283.47656,283.71094,283.9453,284.1797,284.41406,284.64844,284.8828,285.1172,285.35156,285.58594,285.8203,286.0547,286.28906,286.52344,286.7578,286.9922,287.22656,287.46094,287.6953,287.9297,288.16406,288.39844,288.6328,288.8672,289.10156,289.33594,289.5703,289.8047,290.03906,290.27344,290.5078,290.7422,290.97656,291.21094,291.4453,291.6797,291.91406,292.14844,292.3828,292.6172,292.85156,293.08594,293.3203,293.5547,293.78906,294.02344,294.2578,294.4922,294.72656,294.96094,295.1953,295.4297,295.66406,295.89844,296.1328,296.3672,296.60156,296.83594,297.0703,297.3047,297.53906,297.77344,298.0078,298.2422,298.47656,298.71094,298.9453,299.1797,299.41406,299.64844,299.8828,300.1172,300.35156,300.58594,300.8203,301.0547,301.28906,301.52344,301.7578,301.9922,302.22656,302.46094,302.6953,302.9297,303.16406,303.39844,303.6328,303.8672,304.10156,304.33594,304.5703,304.8047,305.03906,305.27344,305.5078,305.7422,305.97656,306.21094,306.4453,306.6797,306.91406,307.14844,307.3828,307.6172,307.85156,308.08594,308.3203,308.5547,308.78906,309.02344,309.2578,309.4922,309.72656,309.96094,310.1953,310.4297,310.66406,310.89844,311.1328,311.3672,311.60156,311.83594,312.0703,312.3047,312.53906,312.77344,313.0078,313.2422,313.47656,313.71094,313.9453,314.1797,314.41406,314.64844,314.8828,315.1172,315.35156,315.58594,315.8203,316.0547,316.28906,316.52344,316.7578,316.9922,317.22656,317.46094,317.6953,317.9297,318.16406,318.39844,318.6328,318.8672,319.10156,319.33594,319.5703,319.8047,320.03906,320.27344,320.5078,320.7422,320.97656,321.21094,321.4453,321.6797,321.91406,322.14844,322.3828,322.6172,322.85156,323.08594,323.3203,323.5547,323.78906,324.02344,324.2578,324.4922,324.72656,324.96094,325.1953,325.4297,325.66406,325.89844,326.1328,326.3672,326.60156,326.83594,327.0703,327.3047,327.53906,327.77344,328.0078,328.2422,328.47656,328.71094,328.9453,329.1797,329.41406,329.64844,329.8828,330.1172,330.35156,330.58594,330.8203,331.0547,331.28906,331.52344,331.7578,331.9922,332.22656,332.46094,332.6953,332.9297,333.16406,333.39844,333.6328,333.8672,334.10156,334.33594,334.5703,334.8047,335.03906,335.27344,335.5078,335.7422,335.97656,336.21094,336.4453,336.6797,336.91406,337.14844,337.3828,337.6172,337.85156,338.08594,338.3203,338.5547,338.78906,339.02344,339.2578,339.4922,339.72656,339.96094,340.1953,340.4297,340.66406,340.89844,341.1328,341.3672,341.60156,341.83594,342.0703,342.3047,342.53906,342.77344,343.0078,343.2422,343.47656,343.71094,343.9453,344.1797,344.41406,344.64844,344.8828,345.1172,345.35156,345.58594,345.8203,346.0547,346.28906,346.52344,346.7578,346.9922,347.22656,347.46094,347.6953,347.9297,348.16406,348.39844,348.6328,348.8672,349.10156,349.33594,349.5703,349.8047,350.03906,350.27344,350.5078,350.7422,350.97656,351.21094,351.4453,351.6797,351.91406,352.14844,352.3828,352.6172,352.85156,353.08594,353.3203,353.5547,353.78906,354.02344,354.2578,354.4922,354.72656,354.96094,355.1953,355.4297,355.66406,355.89844,356.1328,356.3672,356.60156,356.83594,357.0703,357.3047,357.53906,357.77344,358.0078,358.2422,358.47656,358.71094,358.9453,359.1797,359.41406,359.64844,359.8828]},Sn=function(){},Dn=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.volumeTex,this.gl,this.maxTemperature,this.minTemperature,this.geographicExtent,this.weatherStation,this.cuttingPlanesArray,this.weatherEarthArray};Dn.prototype.loadVolumeTexture=function(e,t){var r=document.createElement("img");r.onload=function(t){for(var i=e.columns,o=r.width/i,n=e.slices,a=r.height/(n/i),s=document.createElement("canvas"),l=s.getContext("2d"),u=new Uint8Array(o*a*n),c=0;c<i;c++){s.width=o,s.height=r.height,l.drawImage(r,-c*o,0);for(var d=l.getImageData(0,0,s.width,s.height).data,h=0;h<u.length/i;h++)u[h+c*u.length/i]=d[4*h]}var f=new Uint8ClampedArray(3*u.length),g=0,p=0,m=0;for(h=0;h<u.length;h++)g=u[h-1]-u[h+1],isNaN(g)?f[3*h]=128:f[3*h]=g+128,p=u[h-o]-u[h+o],isNaN(p)?f[3*h+1]=128:f[3*h+1]=p+128,m=u[h-o*a]-u[h+o*a],isNaN(m)?f[3*h+2]=128:f[3*h+2]=m+128;f=new Uint8Array(f)},r.src=e.src},Dn.prototype.loadVolumeData=function(){var e=wn.lon.length,t=wn.lat.length,r=wn.isobaric.length,i=this.weatherStation.provisional_geometryDataPath+"/volumRenderingTest/Temperature.bin",o=new Sn;o.numCols=e,o.numRows=t,o.numSlices=r,hr.loadBinaryData(i,o,this)},Dn.createTexture=function(e,t,r,i,o){var n=e.createTexture();return e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,t),r instanceof Uint8Array?e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,i,o,0,e.LUMINANCE,e.UNSIGNED_BYTE,r):e.texImage2D(e.TEXTURE_2D,0,e.LUMINANCE,e.LUMINANCE,e.UNSIGNED_BYTE,r),e.bindTexture(e.TEXTURE_2D,null),n},Dn.calculateNumStacks=function(e,t,r,i){var o=-1,n=e.getParameter(e.MAX_TEXTURE_SIZE);if(t>n)return-1;for(var a=!1,s=1;!a;){if(r*Math.ceil(i/s)<n){if(a=!0,t*s>n)return-1;o=s}if(++s>=i)return-1}return o},Dn.prototype.parseData=function(e){var t=this.gl,r=wn.lon.length,i=wn.lat.length,o=wn.isobaric.length,n=r*i*o,a=new DataStream(e.dataArraybuffer,0,DataStream.BIG_ENDIAN).readFloat32Array(n);e.dataArraybuffer=a;var s,l=a.length;this.maxTemperature=a[0],this.minTemperature=a[0];for(var u=1;u<l;u++)(s=a[u])>this.maxTemperature?this.maxTemperature=s:s<this.minTemperature&&(this.minTemperature=s);var c=this.maxTemperature-this.minTemperature;this.image3d=new xn;var d=r,h=i;this.resampledWidth=d,this.resampledHeght=h;for(u=0;u<r;u++)wn.lon[u]-=180;for(var f=wn.lon[0],g=wn.lon[r-1],p=wn.lat[0],m=wn.lat[i-1],v=r/2,x=Math.floor(r/d),_=Math.floor(i/h),y=this.image3d.newStack(),T=0;T<o;T++){var C=y.newSlice(),b=d*h;C.dataArray=new Uint8Array(b),C.width=d,C.height=h;for(var M=0;M<h;M++)for(u=0;u<d;u++){var A=u*x,E=M*_+T*i;(A+=v)>r&&(A-=r);var L=xn.getIndexOfArray(r,A,E),w=xn.getIndexOfArray(d,u,M),S=a[L],D=Math.floor(256*(S-this.minTemperature)/c);C.dataArray[w]=D}void 0===C.geographicExtent&&(C.geographicExtent=new xe),C.geographicExtent.setExtent(f,p,0,g,m,0)}this.image3d.stacksArray[0].slicesArray.reverse();var R=t.getParameter(t.MAX_TEXTURE_SIZE);this.reorderedImage3d=_n.convertMonoStackImage3DToMultiStackImage3D(this.image3d,void 0,R),this.uniqueSlice=this.reorderedImage3d.getAnUniqueSlice(void 0);var P=this.uniqueSlice.width,I=this.uniqueSlice.height,F=t.LINEAR,O=Dn.createTexture(t,F,this.uniqueSlice.dataArray,P,I);this.volumeTex=new it,this.volumeTex.texId=O},Dn.prototype.init=function(e,t){this.gl=e,this.loadVolumeData();t.sceneState;var r=t.myCameraSCX.bigFrustum,i=(t.sceneState.camera.frustum.fovyRad,r.aspectRatio[0]),o=r.tangentOfHalfFovy[0],n=o*i,a=new Jr(-n,-o,-1),s=new Jr(n,-o,-1),l=new Jr(n,o,-1),u=new Jr(-n,o,-1);if(void 0===this.quadBuffer){var c=new Float32Array([a.x,a.y,a.z,s.x,s.y,s.z,u.x,u.y,u.z,s.x,s.y,s.z,l.x,l.y,l.z,u.x,u.y,u.z]);this.quadBuffer=ae.createBuffer(e,c)}var d=Bo.wgs84_volumVS,h=Bo.wgs84_volumFS;this.temperatureProgram=Fo.createProgram(e,d,h),void 0===this.geographicExtent&&(this.geographicExtent=new xe),this.geographicExtent.setExtent(-180,-90,0,180,90,0)},Dn.prototype.test_makeGeometryFromSlice=function(e,t,r,i,o,n,a){if(void 0!==this.image3d){Math.PI;var s,l,u,c,d,h,f,g,p=e.geographicExtent.minGeographicCoord.longitude,m=e.geographicExtent.minGeographicCoord.latitude,v=e.geographicExtent.maxGeographicCoord.longitude,x=e.geographicExtent.maxGeographicCoord.latitude,_=(v-p)/(e.width-1),y=(x-m)/(e.height-1),T=p,C=m,b=new Di,M=a*(a-n)*5-n;.8;for(var A=r;A<=o;A++){d=b.newVertexList(),l=C+A*y;for(var E=t;E<=i;E++){var L=E;L>=e.width&&(L-=e.width),s=T+L*_,u=e?e.getValue(L,A):0,u*=5*(u-n),f=d.newVertex(),(h=(u-n)/M)>1?h=1:h<0&&(h=0),c=J.grayToRGB_MagoStyle(h,c),g=Te.geographicToCartesianWgs84(s,l,u,g),f.setPosition(g[0],g[1],g[2]),f.setColorRGBA(c.b,c.g,c.r,.8)}}var w=new kr,S=Di.makeSurface(b,void 0,!1,!0);S.calculateVerticesNormals(),w.addSurface(S),void 0===this.meshesArray&&(this.meshesArray=[]),this.meshesArray.push(w)}},Dn.prototype.test_makeGeometryFromData=function(e){if(void 0!==this.image3d)for(var t,r,i,o,n=this.image3d.getStacksCount(),a=0;a<n;a++)for(var s=this.image3d.getStack(a),l=s.getSlicesCount(),u=0;u<l;u++){for(var c=s.getSlice(0),d=[],h=(d=mn.getMinMaxValuesOfArray(c.dataArray,d))[0],f=d[1],g=Math.floor(c.width/300),p=Math.floor(c.height/300),m=0;m<=p;m++)for(var v=0;v<=g;v++)t=300*v,(r=300*(v+1))>c.width&&(r=c.width),i=300*m,(o=300*(m+1))>c.height&&(o=c.height),this.test_makeGeometryFromSlice(c,t,i,r,o,h,f);break}},Dn.prototype.test_makeCuttingPlane=function(e){void 0===this.cuttingPlanesArray&&(this.cuttingPlanesArray=[]);var t=new Mr;this.cuttingPlanesArray.push(t);var r=128,i=37.5,o=0;void 0===t.geoLocDataManager&&(t.geoLocDataManager=new ye);var n=t.geoLocDataManager.newGeoLocationData("default"),a=90,s=45,l=0;on.calculateGeoLocationData(r,i,o,a,s,l,n,e);var u=5e5,c=5e5;t.makeRectangle(u,c);t=new Mr;this.cuttingPlanesArray.push(t);r=128,i=32,o=0;void 0===t.geoLocDataManager&&(t.geoLocDataManager=new ye);n=t.geoLocDataManager.newGeoLocationData("default"),a=0,s=90,l=0;on.calculateGeoLocationData(r,i,o,a,s,l,n,e);u=5e5,c=5e5;t.makeRectangle(u,c)},Dn.prototype.test_renderCuttingPlanes=function(e,t,r){if(void 0!==this.cuttingPlanesArray)for(var i=e.sceneState.gl,o=this.cuttingPlanesArray.length,n=0;n<o;n++){var a=this.cuttingPlanesArray[n],s=a.geoLocDataManager;if(void 0!==s){var l=s.getCurrentGeoLocationData();void 0!==l&&(i.uniformMatrix4fv(t.buildingRotMatrix_loc,!1,l.rotMatrix._floatArrays),i.uniform3fv(t.buildingPosHIGH_loc,l.positionHIGH),i.uniform3fv(t.buildingPosLOW_loc,l.positionLOW),i.uniform3fv(t.aditionalMov_loc,[0,0,0]),a.render(e,t,r))}}},Dn.prototype.test_getCuttingPlanesParams=function(e){var t=this.cuttingPlanesArray.length;if(e=new Float32Array(24),t>0)for(var r=0;r<t;r++){var i=this.cuttingPlanesArray[r].getPlane();e[4*r]=i.a,e[4*r+1]=i.b,e[4*r+2]=i.c,e[4*r+3]=i.d}return e},Dn.prototype.renderMesh=function(e,t,r){if(void 0!==this.meshesArray)for(var i=this.meshesArray.length,o=0;o<i;o++)this.meshesArray[o].render(e,t,r)},Dn.prototype.render=function(e){if(void 0!==this.volumeTex&&void 0!==this.reorderedImage3d){var t=e.sceneState,r=t.getModelViewMatrixInv(),i=t.projectionMatrix,o=e.myCameraSCX.bigFrustum,n=this.gl;n.enable(n.BLEND);var a=this.temperatureProgram;n.useProgram(a.program),n.enableVertexAttribArray(a.position),n.bindBuffer(n.ARRAY_BUFFER,this.quadBuffer),n.vertexAttribPointer(a.position,3,n.FLOAT,!1,0,0),ae.bindTexture(n,this.volumeTex.texId,0),n.uniformMatrix4fv(a.modelViewMatrixInv,!1,r._floatArrays),n.uniformMatrix4fv(a.projectionMatrix,!1,i._floatArrays),n.uniform3fv(a.encodedCameraPositionMCHigh,t.encodedCamPosHigh),n.uniform3fv(a.encodedCameraPositionMCLow,t.encodedCamPosLow),n.uniform1f(a.screenWidth,t.drawingBufferWidth[0]),n.uniform1f(a.screenHeight,t.drawingBufferHeight[0]),n.uniform1f(a.aspectRatio,o.aspectRatio[0]),n.uniform1f(a.far,o.far[0]),n.uniform1f(a.fovyRad,o.fovyRad[0]),n.uniform1f(a.tanHalfFovy,o.tangentOfHalfFovy[0]);var s=wn.isobaric.length,l=this.reorderedImage3d.stacksArray[0],u=(this.reorderedImage3d.stacksArray.length,l.slicesArray.length),c=l.slicesArray[0],d=c.width,h=c.height,f=this.uniqueSlice.width,g=this.uniqueSlice.height;n.uniform1i(a.texNumCols,f),n.uniform1i(a.texNumRows,g),n.uniform1i(a.texNumSlices,s),n.uniform1i(a.numSlicesPerStacks,u),n.uniform1i(a.slicesNumCols,d),n.uniform1i(a.slicesNumRows,h);var p=0;this.cuttingPlanesArray&&(p=this.cuttingPlanesArray.length);var m=this.test_getCuttingPlanesParams(void 0);n.uniform1i(a.cuttingPlanesCount,p);var v=n.getUniformLocation(a.program,"cuttingPlanes");n.uniform4fv(v,m),n.uniform1f(a.maxLon,180),n.uniform1f(a.minLon,-180),n.uniform1f(a.maxLat,90),n.uniform1f(a.minLat,-90),n.uniform1f(a.maxAlt,15e4),n.uniform1f(a.minAlt,0),n.uniform1f(a.maxValue,this.maxTemperature),n.uniform1f(a.minValue,this.minTemperature),n.drawArrays(n.TRIANGLES,0,6),n.disable(n.BLEND)}};var Rn=function e(t,r){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.provisional_geometryDataPath,this.windVolumesArray,this.dustVolumesArray,this.pollutionVolumesArray,this.soundSurfacesVolumesArray,this.windLayersArray,this.tempLayersArray,this.precipitLayersArray,this.dustLayersArray,this.focusedWindLayerIdx,this.windDisplayBox,this.displayBox,this.magoManager=t,this.WIND_MAXPARTICLES_INSCREEN=1500,this.WIND_STREAMLINES_NUMPOINTS=250,this.windDisplayMode="NORMAL",this.speedFactor=1,this.windThickness=2.5,this.windDefaultAnimationSpeed=1,this.pollutionDefaultAnimationSpeed=1,r&&(r.windDisplayMode&&(this.windDisplayMode=r.windDisplayMode),r.WIND_MAXPARTICLES_INSCREEN&&(this.WIND_MAXPARTICLES_INSCREEN=r.WIND_MAXPARTICLES_INSCREEN),r.WIND_STREAMLINES_NUMPOINTS&&(this.WIND_STREAMLINES_NUMPOINTS=r.WIND_STREAMLINES_NUMPOINTS),r.speedFactor&&(this.speedFactor=r.speedFactor))};Rn.prototype.setWindThickness=function(e){this.windThickness=e},Rn.prototype.getWindLayersCount=function(){return void 0===this.windLayersArray?0:this.windLayersArray.length},Rn.prototype.getWindLayer=function(e){if(void 0!==this.windLayersArray)return this.windLayersArray[e]},Rn.prototype.getWindVolume=function(e){if(void 0!==this.windVolumesArray)return this.windVolumesArray[e]},Rn.prototype.newWindLayer=function(e){void 0===this.windLayersArray&&(this.windLayersArray=[]);var t=new Pn(e);return t.weatherStation=this,this.windLayersArray.push(t),t},Rn.prototype.newWindVolume=function(e){void 0===this.windVolumesArray&&(this.windVolumesArray=[]),e&&void 0===e.animationSpeed&&(e.animationSpeed=this.windDefaultAnimationSpeed);var t=new Fn(e);return t.weatherStation=this,this.windVolumesArray.push(t),t},Rn.prototype.newPollutionVolumeTest=function(e){void 0===this.pollutionVolumesArray&&(this.pollutionVolumesArray=[]),e&&void 0===e.animationSpeed&&(e.animationSpeed=this.pollutionDefaultAnimationSpeed);var t=new Cn(e);return t.weatherStation=this,this.pollutionVolumesArray.push(t),t},Rn.prototype.getSoundSurfaceVolume=function(e){if(void 0!==this.soundSurfacesVolumesArray&&0!==this.soundSurfacesVolumesArray.length&&void 0!==e)return e<0&&(e=0),e>this.soundSurfacesVolumesArray.length&&(e=this.soundSurfacesVolumesArray.length),this.soundSurfacesVolumesArray[e]},Rn.prototype.newSoundSurfaceVolume=function(e){void 0===this.soundSurfacesVolumesArray&&(this.soundSurfacesVolumesArray=[]);var t=new Ln(e);return t.weatherStation=this,this.soundSurfacesVolumesArray.push(t),t},Rn.prototype.deleteDustVolumes=function(){if(this.dustVolumesArray){for(var e=this.dustVolumesArray.length,t=0;t<e;t++)this.dustVolumesArray[t].deleteObjects(this.magoManager),this.dustVolumesArray[t]=void 0;this.dustVolumesArray=void 0}},Rn.prototype.deleteWindVolumes=function(){if(this.windVolumesArray){for(var e=this.windVolumesArray.length,t=0;t<e;t++)this.windVolumesArray[t].deleteObjects(this.magoManager),this.windVolumesArray[t]=void 0;this.windVolumesArray=void 0}},Rn.prototype.deleteAllVolumes=function(){this.deleteWindVolumes(),this.deleteDustVolumes()},Rn.prototype.newDustVolume=function(e){void 0===this.dustVolumesArray&&(this.dustVolumesArray=[]);var t=new pn(e);return t.weatherStation=this,this.dustVolumesArray.push(t),t},Rn.prototype.getSmokeTexture=function(){if(void 0===this.smokeTexture){var e=this.magoManager.getGl();this.smokeTexture=new it,this.smokeTexture.texId=e.createTexture()}if(this.smokeTexture.fileLoadState===I.fileLoadState.READY){e=this.magoManager.getGl();return hr.loadImage(e,"\\images\\ko\\smoke.png",this.smokeTexture),!1}return this.smokeTexture.fileLoadState===I.fileLoadState.BINDING_FINISHED&&this.smokeTexture},Rn.prototype.newTemperatureLayer=function(){void 0===this.tempLayersArray&&(this.tempLayersArray=[]);var e=new Dn;return e.weatherStation=this,this.tempLayersArray.push(e),e},Rn.prototype.newPrecipitationLayer=function(){void 0===this.precipitLayersArray&&(this.precipitLayersArray=[]);var e=new Mn;return e.weatherStation=this,this.precipitLayersArray.push(e),e},Rn.binarySearch_layersByAltitude=function(e,t,r,i){void 0===r&&(r=0),void 0===i&&(i=e.length-1);var o=i-r;if(o<6){for(var n,a=!1,s=r;!a&&s<=i;)t<e[s]&&(n=s,a=!0),s++;return a?n:i+1}var l,u,c=r+Math.floor(o/2);return e[c]>t?(l=r,u=c):(l=c,u=i),Rn.binarySearch_layersByAltitude(e,t,l,u)},Rn.prototype.test_createTemperaturaLayerExample=function(e){var t=e.sceneState.gl;(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=e.readerWriter.geometryDataPath),void 0===this.tempLayersArray||0===this.tempLayersArray.length)&&((o=this.newTemperatureLayer()).init(t,e),o.test_makeCuttingPlane(e),o.test_makeGeometryFromData(e));var r=0;this.tempLayersArray&&(r=this.tempLayersArray.length);for(var i=0;i<r;i++){var o;void 0===(o=this.tempLayersArray[i]).meshesArray&&o.test_makeGeometryFromData(e)}},Rn.prototype.test_createPrecipitationLayerExample=function(e){void 0===this.precipitLayersArray&&(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=e.readerWriter.geometryDataPath),(i=this.newPrecipitationLayer()).init());var t=0;this.precipitLayersArray&&(t=this.precipitLayersArray.length);for(var r=0;r<t;r++){var i;void 0===(i=this.precipitLayersArray[r]).meshesArray&&i.test_makeGeometryFromData(e)}},Rn.prototype.test_createWindLayerExample=function(e){var t=e.sceneState.gl;if(void 0===this.provisional_geometryDataPath&&(this.provisional_geometryDataPath=e.readerWriter.geometryDataPath),void 0===this.windLayersArray||0===this.windLayersArray.length){var r=this.provisional_geometryDataPath,i={name:"JeJu Island",speedFactor:2,dropRate:.003,dropRateBump:.001,numParticles:4096,layerAltitude:1e3,windMapFileName:"OBS-QWM_2016062000.grib2_wind_000",windMapFolderPath:r+"/JeJu_wind_20191127"};this.newWindLayer(i).init(t)}},Rn.prototype.renderWindMultiLayers=function(e){if(void 0!==this.windLayersArray&&0!==this.windLayersArray.length){var t,r;void 0===this.focusedWindLayerIdx&&(this.focusedWindLayerIdx=0);for(var i=this.windLayersArray.length-1;i>=0;i--)(r=this.windLayersArray[i]).isReadyToRender()?(r.renderMode3D(e),t=r.gl,ae.bindTexture(t,r.windMapTexture.texId,0),r.updateParticlesPositions(e)):r.prepareWindLayer()}},Rn.prototype.renderPollutionTest=function(e){if(void 0!==this.pollutionVolumesArray&&0!==this.pollutionVolumesArray.length)for(var t=this.pollutionVolumesArray.length,r=0;r<t;r++)this.pollutionVolumesArray[r].render(e)},Rn.prototype.renderSoundSurfaces=function(e){if(void 0!==this.soundSurfacesVolumesArray&&0!==this.soundSurfacesVolumesArray.length)for(var t=this.soundSurfacesVolumesArray.length,r=0;r<t;r++)this.soundSurfacesVolumesArray[r].render(e)},Rn.prototype.renderWeather=function(e){this.dustVolumesArray&&this.renderDust3D(e),this.windVolumesArray&&this.renderWind3D(e),this.pollutionVolumesArray&&this.renderPollutionTest(e),this.soundSurfacesVolumesArray&&this.renderSoundSurfaces(e)},Rn.prototype.renderWeatherORT=function(e){this.windVolumesArray&&this.renderWind3D(e)},Rn.prototype.renderWeatherTransparents=function(e){},Rn.prototype.renderWeatherTransparentsORT=function(e){},Rn.prototype.renderDust3D=function(e){if(!(e.currentFrustumIdx>2)&&void 0!==this.dustVolumesArray&&0!==this.dustVolumesArray.length)for(var t=this.dustVolumesArray.length,r=0;r<t;r++)r>0&&this.dustVolumesArray[r].dustDisplayBox&&this.dustVolumesArray[r].dustDisplayBox.setOneColor(.2,.7,.8,0),this.dustVolumesArray[r].renderModeTexture(e)},Rn.prototype.renderWind3D=function(e){if(!(e.currentFrustumIdx>2)&&void 0!==this.windVolumesArray&&0!==this.windVolumesArray.length)for(var t=e.postFxShadersManager.bUseMultiRenderTarget,r=this.windVolumesArray.length,i=0;i<r;i++)i>0&&this.windVolumesArray[i].windDisplayBox&&this.windVolumesArray[i].windDisplayBox.setOneColor(.2,.7,.8,0),t?this.windVolumesArray[i].renderMode3DThickLines(e):this.windVolumesArray[i].renderMode3DThickLinesORT(e)},Rn.prototype.renderWindLayerDisplayPlanes=function(e){if(!(e.currentFrustumIdx>2)&&void 0!==this.windVolumesArray&&0!==this.windVolumesArray.length)for(var t=this.windVolumesArray.length,r=0;r<t;r++)r>0&&this.windVolumesArray[r].windDisplayBox&&this.windVolumesArray[r].windDisplayBox.setOneColor(.2,.7,.8,0),this.windVolumesArray[r].renderMode3DThickLines(e)},Rn.prototype.loadWindGeoJson=function(e){if(!e)return!1;var t="";try{for(var r=new URL(e,self.location.href).pathname.split("/"),i=r.length,o=0;o<i-1;o++){var n=r[o];n.length>0&&(t+="/",t+=n)}var a={geoJsonFilePath:e,geoJsonFileFolderPath:t};this.newWindVolume(a)}catch(e){throw new Error(e)}},Rn.prototype.loadPollutionTestGeoJsonIndexFile=function(e){if(!e)return!1;var t,r="";try{for(var i=new URL(e,self.location.href).pathname.split("/"),o=i.length,n=0;n<o-1;n++){var a=i[n];a.length>0&&(r+="/",r+=a)}var s={geoJsonIndexFilePath:e,geoJsonIndexFileFolderPath:r};t=this.newPollutionVolumeTest(s)}catch(e){throw new Error(e)}return t},Rn.prototype._TEST_itineraryJsonsArray=function(){if(void 0===this._test_addingItineraryJsonsProcess&&(this._test_addingItineraryJsonsProcess=I.processState.NO_STARTED),this._test_addingItineraryJsonsProcess===I.processState.NO_STARTED){this._test_addingItineraryJsonsProcess=I.processState.STARTED,this.test_itinearyJsonsArray=[];var e="\\f4d\\result_personItinerary\\A_gps_20220915.json";this.test_itinearyJsonsArray.push({path:e,fileLoadState:0}),e="\\f4d\\result_personItinerary\\B_gps_20220915.json",this.test_itinearyJsonsArray.push({path:e,fileLoadState:0});var t=this;rn(this.test_itinearyJsonsArray[0].path,void 0,void 0,"json","GET").done(function(e){t.test_itinearyJsonsArray[0]._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,t.test_itinearyJsonsArray[0]._geoJsonIndexFile=e}),rn(this.test_itinearyJsonsArray[1].path,void 0,void 0,"json","GET").done(function(e){t.test_itinearyJsonsArray[1]._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,t.test_itinearyJsonsArray[1]._geoJsonIndexFile=e})}if(this._test_addingItineraryJsonsProcess!==I.processState.FINISHED){for(var r=!0,i=this.test_itinearyJsonsArray.length,o=0;o<i;o++)this.test_itinearyJsonsArray[o]._geoJsonIndexFileLoadState!==I.fileLoadState.LOADING_FINISHED&&(r=!1);if(r){this._test_addingItineraryJsonsProcess=I.processState.FINISHED;var n=this.magoManager,a={magoManager:n,walkingManMosaicTexPath:"\\f4d\\result_personItinerary\\walk-right.png",walkingManMosaicColumnsCount:6,walkingManMosaicRowsCount:1};n.itineraryManager=new mr(a);var s=this.test_itinearyJsonsArray.length;for(o=0;o<s;o++){var l={jsonFile:this.test_itinearyJsonsArray[o]._geoJsonIndexFile,lineThickness:4};n.itineraryManager.newItineraryLayer(l)}a={incrementalAddingTimeMilisec:5e4};n.animationTimeController=new fn(a),n.animationTimeController.startAnimation()}}},Rn.prototype._TEST_addPollutionJsonsArray=function(){if(void 0===this._test_addingPollutionJsonsProcess&&(this._test_addingPollutionJsonsProcess=I.processState.NO_STARTED),this._test_addingPollutionJsonsProcess===I.processState.NO_STARTED){this._test_addingPollutionJsonsProcess=I.processState.STARTED,void 0===this.test_pollutionJsonsArray&&(this.test_pollutionJsonsArray=[]);var e=this;this.test_pollutionJsonsArray.push({path:"\\f4d\\result_air_1minInterval\\JsonIndex.json",fileLoadState:0}),rn(this.test_pollutionJsonsArray[0].path,void 0,void 0,"json","GET").done(function(t){e.test_pollutionJsonsArray[0]._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,e.test_pollutionJsonsArray[0]._geoJsonIndexFile=t})}if(this._test_addingPollutionJsonsProcess!==I.processState.FINISHED){for(var t=!0,r=this.test_pollutionJsonsArray.length,i=0;i<r;i++)this.test_pollutionJsonsArray[i]._geoJsonIndexFileLoadState!==I.fileLoadState.LOADING_FINISHED&&(t=!1);if(t){this._test_addingPollutionJsonsProcess=I.processState.FINISHED;var o={samplingDataIncrementTimeMilisec:100,geoJsonIndexFileFolderPath:"\\f4d\\result_air_1minInterval"},n=this.newPollutionVolumeTest(o),a=[],s=this.test_pollutionJsonsArray.length;for(i=0;i<s;i++)a.push(this.test_pollutionJsonsArray[i]._geoJsonIndexFile);n.setGeoJsonIndexFile(a[0])}}},Rn.prototype._TEST_addSoundJsonsArray=function(){if(void 0===this._test_addingSoundsJsonsProcess&&(this._test_addingSoundsJsonsProcess=I.processState.NO_STARTED),this._test_addingSoundsJsonsProcess===I.processState.NO_STARTED){this._test_addingSoundsJsonsProcess=I.processState.STARTED,this.test_soundJsonsArray=[];var e="\\f4d\\result_sound_facada_Json\\M.json";this.test_soundJsonsArray.push({path:e,fileLoadState:0}),e="\\f4d\\result_sound_facada_Json\\M_00000.json",this.test_soundJsonsArray.push({path:e,fileLoadState:0}),e="\\f4d\\result_sound_facada_Json\\M_00001.json",this.test_soundJsonsArray.push({path:e,fileLoadState:0}),e="\\f4d\\result_sound_facada_Json\\M_00002.json",this.test_soundJsonsArray.push({path:e,fileLoadState:0});var t=this;rn(this.test_soundJsonsArray[0].path,void 0,void 0,"json","GET").done(function(e){t.test_soundJsonsArray[0]._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,t.test_soundJsonsArray[0]._geoJsonIndexFile=e}),rn(this.test_soundJsonsArray[1].path,void 0,void 0,"json","GET").done(function(e){t.test_soundJsonsArray[1]._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,t.test_soundJsonsArray[1]._geoJsonIndexFile=e}),rn(this.test_soundJsonsArray[2].path,void 0,void 0,"json","GET").done(function(e){t.test_soundJsonsArray[2]._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,t.test_soundJsonsArray[2]._geoJsonIndexFile=e}),rn(this.test_soundJsonsArray[3].path,void 0,void 0,"json","GET").done(function(e){t.test_soundJsonsArray[3]._geoJsonIndexFileLoadState=I.fileLoadState.LOADING_FINISHED,t.test_soundJsonsArray[3]._geoJsonIndexFile=e})}if(this._test_addingSoundsJsonsProcess!==I.processState.FINISHED){for(var r=!0,i=this.test_soundJsonsArray.length,o=0;o<i;o++)this.test_soundJsonsArray[o]._geoJsonIndexFileLoadState!==I.fileLoadState.LOADING_FINISHED&&(r=!1);if(r){this._test_addingSoundsJsonsProcess=I.processState.FINISHED;var n=this.newSoundSurfaceVolume(void 0),a=[],s=this.test_soundJsonsArray.length;for(o=0;o<s;o++)a.push(this.test_soundJsonsArray[o]._geoJsonIndexFile);n.addJsonsArray(a)}}},Rn.prototype.loadSoundSurfaceGeoJsonIndexFile=function(e){if(!e)return!1;var t,r="";try{for(var i=new URL(e,self.location.href).pathname.split("/"),o=i.length,n=0;n<o-1;n++){var a=i[n];a.length>0&&(r+="/",r+=a)}var s={geoJsonIndexFilePath:e,geoJsonIndexFileFolderPath:r};t=this.newSoundSurfaceVolume(s)}catch(e){throw new Error(e)}return t},Rn.prototype.addWind=function(e,t){return!!e&&(t||(t={}),t.geoJsonFile=e,this.newWindVolume(t))},Rn.prototype.loadDustGeoJson=function(e){if(!e)return!1;var t="";try{for(var r=new URL(e,self.location.href).pathname.split("/"),i=r.length,o=0;o<i-1;o++){var n=r[o];n.length>0&&(t+="/",t+=n)}var a={geoJsonFilePath:e,geoJsonFileFolderPath:t};this.newDustVolume(a)}catch(e){throw new Error(e)}},Rn.prototype.addDust=function(e){if(!e)return!1;var t={geoJsonFile:e};return this.newDustVolume(t)},Rn.prototype.test_loadDustData3d=function(e,t,r){var i=new gn;void 0===this.dustLayersArray&&(this.dustLayersArray=[]),this.dustLayersArray.push(i)},Rn.prototype.test_renderTemperatureLayer=function(e){(this.test_createTemperaturaLayerExample(e),void 0!==this.tempLayersArray)&&(0!==this.tempLayersArray.length&&this.tempLayersArray[0].render(e))},Rn.prototype.test_renderTemperatureMesh=function(e,t,r){(this.test_createTemperaturaLayerExample(e),void 0!==this.tempLayersArray)&&(0!==this.tempLayersArray.length&&this.tempLayersArray[0].renderMesh(e,t,r))},Rn.prototype.test_renderPrecipitationMesh=function(e,t,r){(this.test_createPrecipitationLayerExample(e),void 0!==this.precipitLayersArray)&&(0!==this.precipitLayersArray.length&&this.precipitLayersArray[0].renderMesh(e,t,r))};var Pn=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.weatherStation,this.gl,this.windMapTexture,this.windMapJson,this.windMapFileName,this.windMapJsonFileLoadState=I.fileLoadState.READY,this.windMapFolderPath,this.windData,this.windVelocityMap,this.currWindMap,this.currWindMapIdx=0,this.screenTexture0,this.screenTexture1,this.screenTexWidth,this.screenTexHeight,this.geoExtent,this.layerAltitude=6e3,this.geoLocDataManager,this.drawParticlesProgram,this.screenFadeProgram,this.updateParticlesProgram,this.drawRegionProgram,this.quadBuffer,this.particlesPositionTexture0,this.particlesPositionTexture1,this.weatherEarth,this.fadeOpacity=.9999,this.speedFactor=.04,this.dropRate=.003,this.dropRateBump=.001,this.speedFactor=.1,this.dropRate=.003,this.dropRateBump=.01,this.numParticles=16384,this.particlesPositionTexturesCount=20,this.pendentPointSize=2e4,this.flipTexCoordsY_windMap=!0,this.externalAlpha=.7,void 0!==t&&(t.geoJsonFile&&(this.windMapJson=t.geoJsonFile,this.windMapJsonFileLoadState=I.fileLoadState.LOADING_FINISHED),t.geoJsonFileFolderPath&&(this.windMapFolderPath=t.geoJsonFileFolderPath),void 0!==t.speedFactor&&(this.speedFactor=t.speedFactor),void 0!==t.dropRate&&(this.dropRate=t.dropRate),void 0!==t.dropRateBump&&(this.dropRateBump=t.dropRateBump),void 0!==t.numParticles&&(this.numParticles=t.numParticles),void 0!==t.windMapFileName&&(this.windMapFileName=t.windMapFileName),void 0!==t.windMapFolderPath&&(this.windMapFolderPath=t.windMapFolderPath),void 0!==t.layerAltitude&&(this.layerAltitude=t.layerAltitude),void 0!==t.particlesPositionTexturesCount&&(this.particlesPositionTexturesCount=t.particlesPositionTexturesCount),void 0!==t.pendentPointSize&&(this.pendentPointSize=t.pendentPointSize))};Pn.prototype.init=function(e,t){if(this.gl=e,void 0===this.quadBuffer){var r=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);this.quadBuffer=ae.createBuffer(e,r)}void 0===this.windFramebuffer&&(this.windFramebuffer=e.createFramebuffer());var i=Bo.draw_vert,o=Bo.draw_frag;this.drawParticlesProgram=Fo.createProgram(e,i,o),i=Bo.quad_vert,o=Bo.screen_frag,this.screenFadeProgram=Fo.createProgram(e,i,o),i=Bo.quad_vert,o=Bo.update_frag,this.updateParticlesProgram=Fo.createProgram(e,i,o),this.updateParticlesProgram.u_visibleTilesRanges=e.getUniformLocation(this.updateParticlesProgram.program,"u_visibleTilesRanges"),this.updateParticlesProgram.uTangentOfHalfFovy_loc=e.getUniformLocation(this.updateParticlesProgram.program,"tangentOfHalfFovy"),this.updateParticlesProgram.uFar_loc=e.getUniformLocation(this.updateParticlesProgram.program,"far"),this.updateParticlesProgram.uAspectRatio_loc=e.getUniformLocation(this.updateParticlesProgram.program,"aspectRatio"),this.updateParticlesProgram.uModelViewMatInv_loc=e.getUniformLocation(this.updateParticlesProgram.program,"modelViewMatrixInv"),this.updateParticlesProgram.uBuildingRotMatrix_loc=e.getUniformLocation(this.updateParticlesProgram.program,"buildingRotMatrix"),this.updateParticlesProgram.buildingRotMatrixInv=e.getUniformLocation(this.updateParticlesProgram.program,"buildingRotMatrixInv"),this.updateParticlesProgram.uNearFarArray_loc=e.getUniformLocation(this.updateParticlesProgram.program,"uNearFarArray"),e.useProgram(this.updateParticlesProgram.program),this.updateParticlesProgram.u_particles_loc=e.getUniformLocation(this.updateParticlesProgram.program,"u_particles"),this.updateParticlesProgram.u_wind_loc=e.getUniformLocation(this.updateParticlesProgram.program,"u_wind"),this.updateParticlesProgram.u_windGlobeDepthTex_loc=e.getUniformLocation(this.updateParticlesProgram.program,"u_windGlobeDepthTex"),this.updateParticlesProgram.u_windGlobeNormalTex_loc=e.getUniformLocation(this.updateParticlesProgram.program,"u_windGlobeNormalTex"),e.uniform1i(this.updateParticlesProgram.u_particles_loc,0),e.uniform1i(this.updateParticlesProgram.u_wind_loc,1),e.uniform1i(this.updateParticlesProgram.u_windGlobeDepthTex,2),e.uniform1i(this.updateParticlesProgram.u_windGlobeNormalTex,3);i=Bo.draw_vert3D,o=Bo.draw_frag3D;var n="USE_LINEAR_DEPTH",a="NO_USE_MULTI_RENDER_TARGET";if(t.postFxShadersManager.getUseLogarithmicDepth()&&(n="USE_LOGARITHMIC_DEPTH"),o=o.replace(/%USE_LOGARITHMIC_DEPTH%/g,n),t.postFxShadersManager.bUseMultiRenderTarget)a="USE_MULTI_RENDER_TARGET";o=o.replace(/%USE_MULTI_RENDER_TARGET%/g,a),this.drawParticles3DShader=t.postFxShadersManager.createShaderProgram(e,i,o,"drawWindParticles3d",t),this.drawParticles3DShader.bUseLogarithmicDepth_loc=e.getUniformLocation(this.drawParticles3DShader.program,"bUseLogarithmicDepth"),this.drawParticles3DShader.uFCoef_logDepth_loc=e.getUniformLocation(this.drawParticles3DShader.program,"uFCoef_logDepth"),this.drawParticles3DShader.uFrustumIdx_loc=e.getUniformLocation(this.drawParticles3DShader.program,"uFrustumIdx"),this.drawParticlesProgram3D=this.drawParticles3DShader.program,e.useProgram(this.drawParticles3DShader.program),this.drawParticles3DShader.u_wind_loc=e.getUniformLocation(this.drawParticles3DShader.program,"u_wind"),this.drawParticles3DShader.u_depthTex_loc=e.getUniformLocation(this.drawParticles3DShader.program,"u_depthTex"),e.uniform1i(this.drawParticles3DShader.u_wind_loc,0),e.uniform1i(this.drawParticles3DShader.u_depthTex_loc,1);var s=this.particleStateResolution=Math.ceil(Math.sqrt(this.numParticles));this.numParticles=s*s;for(var l=new Uint8Array(4*this.numParticles),u=0;u<l.length;u++)l[u]=Math.floor(256*Math.random());this.particlesPositionTexturesArray=[];for(u=0;u<this.particlesPositionTexturesCount;u++){var c=it.createTexture(e,e.NEAREST,l,s,s);this.particlesPositionTexturesArray.push(c)}var d=new Float32Array(this.numParticles);for(u=0;u<this.numParticles;u++)d[u]=u;this.particleIndexBuffer=ae.createBuffer(e,d)},Pn.prototype.parseWindDataGeoJson=function(e){if(e.lat){this.windMapJson=e,this.windMapJsonFileLoadState=I.fileLoadState.LOADING_FINISHED;var t=this.windMapJson.lon.length,r=this.windMapJson.lat.length;this.windMapJson.lon[0],this.windMapJson.lon[t-1],this.windMapJson.lat[r-1],this.windMapJson.lat[0];this.windMapJson.minLon&&this.windMapJson.minLon,this.windMapJson.maxLon&&this.windMapJson.maxLon,this.windMapJson.minLat&&this.windMapJson.minLat,this.windMapJson.maxLat&&this.windMapJson.maxLat;return void 0!==this.windMapJson.height_above_ground&&this.windMapJson.height_above_ground[0],void 0===this.windData&&(this.windData={}),this.windData.uMin=this.windMapJson.uMin,this.windData.vMin=this.windMapJson.vMin,this.windData.uMax=this.windMapJson.uMax,this.windData.vMax=this.windMapJson.vMax,this.windData.height=this.windMapJson.height,this.windData.width=this.windMapJson.width,this.windData.height_above_ground=this.windMapJson.height_above_ground[0],!0}if(e.type){this.windMapJson=e,this.windMapJsonFileLoadState=I.fileLoadState.LOADING_FINISHED;return void 0!==this.windMapJson.height_above_ground&&this.windMapJson.height_above_ground[0],void 0===this.windData&&(this.windData={}),this.windData.uMin=this.windMapJson.properties.value.r.min,this.windData.vMin=this.windMapJson.properties.value.g.min,this.windData.wMin=this.windMapJson.properties.value.b.min,this.windData.uMax=this.windMapJson.properties.value.r.max,this.windData.vMax=this.windMapJson.properties.value.g.max,this.windData.wMax=this.windMapJson.properties.value.b.max,this.windData.height=this.windMapJson.properties.image.width,this.windData.width=this.windMapJson.properties.image.height,this.windMapJson.minLon=this.windMapJson.bbox[0],this.windMapJson.minLat=this.windMapJson.bbox[1],this.windMapJson.minAlt=this.windMapJson.bbox[2],this.windMapJson.maxLon=this.windMapJson.bbox[3],this.windMapJson.maxLat=this.windMapJson.bbox[4],this.windMapJson.maxAlt=this.windMapJson.bbox[5],this.windData.height_above_ground=this.windMapJson.minAlt,!0}return!1},Pn.prototype.prepareWindLayer=function(){if(void 0===this.gl&&(this.gl=this.windVolume.weatherStation.magoManager.getGl()),void 0===this.windMapTexture&&(this.windMapTexture=new it,this.windMapTexture.texId=this.gl.createTexture()),this.windMapTexture.fileLoadState===I.fileLoadState.READY){if(!this.windMapFileName){if(!this.windMapJson)return!1;this.windMapFileName=this.windMapJson.properties.image.uri}var e;return e=this.windMapFolderPath&&0!==this.windMapFolderPath.length?this.windMapFolderPath+"/"+this.windMapFileName:this.windMapJson.properties.image.serviceUri,hr.loadImage(this.gl,e,this.windMapTexture),!1}if(void 0===this.windMapJsonFileLoadState||this.windMapJsonFileLoadState===I.fileLoadState.READY){this.windMapJsonFileLoadState=I.fileLoadState.LOADING_STARTED;var t=this,r=this.windMapFolderPath+"/"+this.windMapFileName+".json";return rn(r,void 0,void 0,"json","GET").done(function(e){t.windMapJsonFileLoadState=I.fileLoadState.LOADING_FINISHED,t.windMapJson=e}),!1}return!0},Pn.prototype.getGeographicExtent=function(){if(!this.geoExtent){var e,t,r,i,o;this.windMapJson.minLon&&(e=this.windMapJson.minLon),this.windMapJson.maxLon&&(r=this.windMapJson.maxLon),this.windMapJson.minLat&&(t=this.windMapJson.minLat),this.windMapJson.maxLat&&(i=this.windMapJson.maxLat);var n=10;void 0!==this.windMapJson.height_above_ground&&(n=this.windMapJson.height_above_ground[0]),o=n,this.geoExtent=new xe(e,t,n,r,i,o)}return this.geoExtent},Pn.prototype.isReadyToRender=function(){return void 0!==this.windMapTexture&&this.windMapTexture.fileLoadState===I.fileLoadState.BINDING_FINISHED&&void 0!==this.windMapJsonFileLoadState&&this.windMapJsonFileLoadState===I.fileLoadState.LOADING_FINISHED},Pn.prototype.createEarthRegion=function(e,t,r,i,o,n){void 0===e&&(e=-180),void 0===t&&(t=-90),void 0===r&&(r=180),void 0===i&&(i=90),void 0===o&&(o=0),this.weatherEarth=new fr,this.weatherEarth.geographicExtent=new xe,this.weatherEarth.geographicExtent.minGeographicCoord=new pe,this.weatherEarth.geographicExtent.maxGeographicCoord=new pe,this.weatherEarth.geographicExtent.minGeographicCoord.setLonLatAlt(e,t,o),this.weatherEarth.geographicExtent.maxGeographicCoord.setLonLatAlt(r,i,o),this.weatherEarth.centerX=new Float64Array([0]),this.weatherEarth.centerY=new Float64Array([0]),this.weatherEarth.centerZ=new Float64Array([0]);void 0===o&&(o=16e3),this.weatherEarth.makeMeshVirtuallyCRS84(72,36,o),this.weatherEarth.centerX[0]=0,this.weatherEarth.centerX[1]=0,this.weatherEarth.centerX[2]=0,this.weatherEarth.makeVbo(n.vboMemoryManager)},Pn.prototype.getVelocityVector2d=function(e,t,r,i){var o=this.windMapTexture.imageWidth,n=this.windMapTexture.imageHeight;if(e<0&&(e=0),t<0&&(t=0),!this.windVelocityMap){var a=i.getGl();if(void 0===this.framebuffer&&(this.framebuffer=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,this.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.windMapTexture.texId,0),a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE){var s=o*n;this.windVelocityMap=new Uint8Array(4*s),a.readPixels(0,0,o,n,a.RGBA,a.UNSIGNED_BYTE,this.windVelocityMap)}a.bindFramebuffer(a.FRAMEBUFFER,null)}var l=t*o+e,u=this.windVelocityMap[4*l]/255,c=this.windVelocityMap[4*l+1]/255,d=(this.windVelocityMap[4*l+2],this.windData.uMin),h=this.windData.vMin,f=d*(1-u)+this.windData.uMax*u,g=h*(1-c)+this.windData.vMax*c;return void 0===r&&(r=new Kr),r.set(f,g),r},Pn.prototype.getAltitude=function(){if(this.windMapJson)return this.windMapJson.bbox[2]},Pn.prototype.deleteObjects=function(e){if(this.windMapTexture){var t=e.getGl();this.windMapTexture.deleteObjects(t)}this.windMapTexture=void 0,delete this.windMapJson,this.windMapFileName=void 0,this.windMapJsonFileLoadState=void 0,this.windMapFolderPath=void 0,this.windData=void 0,this.currWindMap=void 0,this.currWindMapIdx=void 0,this.geoExtent&&this.geoExtent.deleteObjects(),this.geoExtent=void 0,this.geoLocDataManager&&this.geoLocDataManager.deleteObjects(),this.geoLocDataManager=void 0,this.flipTexCoordsY_windMap=void 0,this.externalAlpha=void 0,this.windVelocityMap&&delete this.windVelocityMap,this.windVelocityMap=void 0},Pn.prototype.getVelocityVector3d=function(e,t,r,i){if(this.windMapTexture.fileLoadState!==I.fileLoadState.BINDING_FINISHED)return void 0===r&&(r=new Jr),r;var o=this.windMapTexture.imageWidth,n=this.windMapTexture.imageHeight;if(e<0&&(e=0),t<0&&(t=0),!this.windVelocityMap){var a=i.getGl();if(void 0===this.windVolume.framebuffer&&(this.windVolume.framebuffer=a.createFramebuffer()),a.bindFramebuffer(a.FRAMEBUFFER,this.windVolume.framebuffer),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_2D,this.windMapTexture.texId,0),!(a.checkFramebufferStatus(a.FRAMEBUFFER)===a.FRAMEBUFFER_COMPLETE))return void 0===r&&(r=new Jr),r;var s=o*n;this.windVelocityMap=new Uint8Array(4*s),a.readPixels(0,0,o,n,a.RGBA,a.UNSIGNED_BYTE,this.windVelocityMap),a.bindFramebuffer(a.FRAMEBUFFER,null)}var l=t*o+e,u=this.windVelocityMap[4*l]/255,c=this.windVelocityMap[4*l+1]/255,d=this.windVelocityMap[4*l+2]/255,h=this.windMapJson.properties.value,f=h.r.min,g=h.g.min,p=h.b.min,m=f*(1-u)+h.r.max*u,v=g*(1-c)+h.g.max*c,x=p*(1-d)+h.b.max*d;return void 0===r&&(r=new Jr),r.set(m,v,x),r},Pn.prototype.getVelocityVector2d_biLinearInterpolation=function(e,t,r,i){var o=this.windMapTexture.imageWidth,n=this.windMapTexture.imageHeight,a=Math.floor(e*o),s=Math.floor(t*n),l=e*o,u=t*n,c=Math.ceil(1e4*(l<1?l:l%Math.floor(l)))/1e4,d=Math.ceil(1e4*(u<1?u:u%Math.floor(u)))/1e4,h=a+1<o?a+1:a,f=s+1<n?s+1:s,g=this.getVelocityVector2d(a,s,void 0,i),p=this.getVelocityVector2d(h,s,void 0,i),m=this.getVelocityVector2d(a,f,void 0,i),v=this.getVelocityVector2d(h,f,void 0,i),x=Kr.mix(g,p,c,void 0),_=Kr.mix(m,v,c,void 0);return r||(r=new Kr),r=Kr.mix(x,_,d,r)},Pn.prototype.getVelocityVector3d_biLinearInterpolation=function(e,t,r,i){var o=this.windMapTexture.imageWidth,n=this.windMapTexture.imageHeight,a=Math.floor(e*o),s=Math.floor(t*n),l=e*o,u=t*n,c=Math.ceil(1e4*(l<1?l:l%Math.floor(l)))/1e4,d=Math.ceil(1e4*(u<1?u:u%Math.floor(u)))/1e4,h=a+1<o?a+1:a,f=s+1<n?s+1:s,g=this.getVelocityVector3d(a,s,void 0,i),p=this.getVelocityVector3d(h,s,void 0,i),m=this.getVelocityVector3d(a,f,void 0,i),v=this.getVelocityVector3d(h,f,void 0,i),x=Jr.mix(g,p,c,void 0),_=Jr.mix(m,v,c,void 0);return r||(r=new Jr),r=Jr.mix(x,_,d,r)},Pn.prototype.getTrajectoryInLocalCoordinates=function(e,t,r){var i=this.getGeographicExtent();if(i.intersects2dWithGeoCoord(e)){var o=i.getMinLongitudeRad(),n=i.getMinLatitudeRad(),a=i.getMaxLongitudeRad(),s=i.getMaxLatitudeRad(),l=(i.getMinAltitude(),i.getMaxAltitude(),a-o),u=s-n,c=e.getLongitudeRad(),d=e.getLatitudeRad(),h=(this.windMapTexture.imageWidth,this.windMapTexture.imageHeight,i.getCenterLatitude()),f=Te.radiusAtLatitudeDeg(h),g=1/(f*(S=Math.cos(h*Math.PI/180))),p=1/f,m=20;r&&void 0!==r.numPoints&&(m=r.numPoints);var v=[],x=new Jr;v.push(x);for(var _,y,T,C=0,b=0,M=0,A=0;A<m;A++){var E=(c-o)/l,L=(d-n)/u,w=this.getVelocityVector3d_biLinearInterpolation(E,L,void 0,t),S=Math.cos(n+d*u);_=w.x/S*1,y=1*w.y,T=1*w.z;x=new Jr(C+=_,b+=y,M+=T);if(v.push(x),c+=_*g,d+=y*p,Math.abs(w.x)+Math.abs(w.y)<.02)return v}return v}},Pn.prototype.getWindPlaneFBO=function(e){if(!this.windPlaneFBO){var t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.windPlaneFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.windPlaneFBO},Pn.prototype.renderWindPlaneDepth=function(e){e.sceneState;var t=e.getGl(),r=(this.getWindPlaneFBO(e),e.extbuffers);this.windPlaneFBO.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,this.windPlaneFBO.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,this.windPlaneFBO.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,this.windPlaneFBO.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,this.windPlaneFBO.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1)),this.visibleObjControler||(this.visibleObjControler=new _t),this.windDisplayPlane&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.windDisplayPlane);e.renderer.renderGeometryBuffer(t,1,this.visibleObjControler),e.windPlaneDepthTex=this.windPlaneFBO.colorBuffersArray[1],e.windPlaneNormalTex=this.windPlaneFBO.colorBuffersArray[2],e.windPngTex=this.windMapTexture.texId,e.bindMainFramebuffer(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,null,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.NONE,r.NONE,r.NONE])},Pn.prototype.getModelViewProjectionRelToEye=function(e){if(!this.modelViewProjectionRelToEye){var t=e.sceneState,r=t.camera.frustum,i=new Ne;i._floatArrays=glMatrix.mat4.perspective(i._floatArrays,r.fovyRad[0],r.aspectRatio[0],r.near[0],1e8);var o=t.modelViewRelToEyeMatrix;this.modelViewProjectionRelToEye=new Ne,this.modelViewProjectionRelToEye._floatArrays=glMatrix.mat4.multiply(this.modelViewProjectionRelToEye._floatArrays,i._floatArrays,o._floatArrays)}return this.modelViewProjectionRelToEye},Pn.prototype.renderMode3D=function(e){if(this.isReadyToRender()){if(void 0!==this.windDisplayPlane&&!(e.currentFrustumIdx>2)){var t=e.sceneState.camera.position,r=this.gl,i=this.drawParticles3DShader,o=i.program;r.useProgram(o),this.drawParticles3DShader.bindUniformGenerals(),r.enableVertexAttribArray(i.a_index),r.uniform1i(i.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),r.uniform1f(i.uFCoef_logDepth_loc,e.sceneState.fCoef_logDepth[0]),r.uniform1i(i.uFrustumIdx_loc,e.currentFrustumIdx),this.windDisplayPlane.geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(r,i),r.bindBuffer(r.ARRAY_BUFFER,this.particleIndexBuffer),r.vertexAttribPointer(i.a_index,1,r.FLOAT,!1,0,0),r.uniform1i(i.u_colorScale,!0),r.uniform1i(i.u_wind,0),r.uniform1i(i.u_particles,1),r.uniform1i(i.u_particles_next,2),ae.bindTexture(r,this.windMapTexture.texId,0);var n=this.windData.uMin,a=this.windData.vMin,s=this.windData.uMax,l=this.windData.vMax;this.weatherStation.windData&&this.weatherStation.windData.uMin&&(n=this.weatherStation.windData.uMin,a=this.weatherStation.windData.vMin,s=this.weatherStation.windData.uMax,l=this.weatherStation.windData.vMax),r.uniform1f(i.u_particles_res,this.particleStateResolution),r.uniform2f(i.u_wind_min,n,a),r.uniform2f(i.u_wind_max,s,l),r.uniform1i(i.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap);var u=this.getGeographicExtent(),c=u.getMinLongitudeRad(),d=u.getMinLatitudeRad(),h=u.getMaxLongitudeRad(),f=u.getMaxLatitudeRad(),g=u.getMinAltitude(),p=u.getMaxAltitude();r.uniform3fv(i.u_geoCoordRadiansMax,[h,f,p]),r.uniform3fv(i.u_geoCoordRadiansMin,[c,d,g]),r.uniform3fv(i.u_camPosWC,[t.x,t.y,t.z]),r.uniform1f(i.pendentPointSize,this.pendentPointSize),r.uniform1f(i.u_externAlpha,this.externalAlpha),r.enable(r.BLEND);for(var m=this.particlesPositionTexturesArray.length,v=m-1;v>=0;v--){var x=1/m*(v+1);x=0===v?.1:1/m*(v+1),r.uniform1f(i.u_tailAlpha,x),ae.bindTexture(r,this.particlesPositionTexturesArray[v],1),r.drawArrays(r.POINTS,0,this.numParticles)}r.disable(r.BLEND)}}else this.prepareWindLayer()},Pn.prototype.render=function(e){var t=this.gl;if(this.weatherEarth){var r=e.postFxShadersManager.getShader("testQuad"),i=r.program;t.useProgram(i),t.enableVertexAttribArray(r.texCoord2_loc),t.enableVertexAttribArray(r.position3_loc),r.bindUniformGenerals(),r.resetLastBuffersBinded(),this.flipTexCoordsY_windMap=!0,void 0===this.wwwMat&&(this.wwwMat=new Ne,this.wwwMat.rotationAxisAngDeg(90,1,0,0),this.flipTexCoordsY_windMap=!1),e.configInformation.geo_view_library===F.WORLDWIND?t.uniformMatrix4fv(r.buildingRotMatrix_loc,!1,this.wwwMat._floatArrays):t.uniformMatrix4fv(r.buildingRotMatrix_loc,!1,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),t.uniform3fv(r.buildingPosHIGH_loc,[0,0,0]),t.uniform3fv(r.buildingPosLOW_loc,[0,0,0]),t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this.screenTexture0);var o=this.weatherEarth.vboKeyContainer.vboCacheKeysArray[0];if(!o.bindDataTexCoord(r,e.vboMemoryManager))return;if(!o.bindDataPosition(r,e.vboMemoryManager))return;if(!o.bindDataIndice(r,e.vboMemoryManager))return;t.enable(t.BLEND),t.drawElements(t.TRIANGLES,o.indicesCount,t.UNSIGNED_SHORT,0),t.disable(t.BLEND)}},Pn.prototype.renderWindScreen=function(){var e=this.gl;ae.bindFramebuffer(e,this.windFramebuffer,this.screenTexture0),e.viewport(0,0,this.screenTexWidth,this.screenTexHeight),this.drawFadeScreen(this.screenTexture1,this.fadeOpacity),this.renderParticles();var t=this.screenTexture1;this.screenTexture1=this.screenTexture0,this.screenTexture0=t},Pn.prototype.drawFadeScreen=function(e,t){var r=this.gl,i=this.screenFadeProgram;r.useProgram(i.program),ae.bindAttribute(r,this.quadBuffer,i.a_pos,2),ae.bindTexture(r,e,2),r.uniform1i(i.u_screen,2),r.uniform1f(i.u_opacity,t),r.drawArrays(r.TRIANGLES,0,6)},Pn.prototype.renderParticles=function(){var e=this.gl,t=this.drawParticlesProgram;e.useProgram(t.program),ae.bindAttribute(e,this.particleIndexBuffer,t.a_index,1),e.uniform1i(t.u_colorScale,!0),e.uniform1i(t.u_wind,0),e.uniform1i(t.u_particles,1),e.uniform1f(t.u_particles_res,this.particleStateResolution),e.uniform2f(t.u_wind_min,this.windData.uMin,this.windData.vMin),e.uniform2f(t.u_wind_max,this.windData.uMax,this.windData.vMax),e.uniform1i(t.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap),e.drawArrays(e.POINTS,0,this.numParticles)},Pn.prototype.updateParticlesPositions=function(e){if(this.windPlaneFBO){var t=e.getGl();1;var r=this.particlesPositionTexturesArray[this.particlesPositionTexturesArray.length-1];ae.bindTexture(t,r,1),ae.bindTexture(t,this.windPlaneFBO.colorBuffersArray[1],2),ae.bindTexture(t,this.windPlaneFBO.colorBuffersArray[2],3);for(var i=0;i<1;i++){var o=1*(1+i);this.updateParticlesPositionsForInterpolation(e,o)}}},Pn.prototype.updateParticlesPositionsForInterpolation=function(e,t){var r=this.gl,i=this.particlesPositionTexturesArray.shift(),o=e.sceneState,n=o.camera,a=n.position,s={},l=e.myCameraSCX.bigFrustum;s=Ke.getFrustumIntersectedTilesNames(l,6,a,e,s);var u=[];for(var c in s)if(Object.prototype.hasOwnProperty.call(s,c)){var d=c.split("\\"),h=(parseInt(d[0]),((x=s[c]).minGeographicCoord.longitude+180)/360),f=(x.minGeographicCoord.latitude+90)/180,g=(x.maxGeographicCoord.longitude+180)/360,p=(x.maxGeographicCoord.latitude+90)/180;u.push(h),u.push(f),u.push(g),u.push(p)}if(this.windData){ae.bindFramebuffer(r,this.windFramebuffer,i),r.viewport(0,0,this.particleStateResolution,this.particleStateResolution);var m=this.updateParticlesProgram;r.useProgram(m.program),ae.bindAttribute(r,this.quadBuffer,m.a_pos,2),r.uniform1i(m.u_wind,0),r.uniform1i(m.u_particles,1);var v=Math.random();if(r.uniform1f(m.u_rand_seed,v),r.uniform2f(m.u_wind_res,this.windData.width,this.windData.height),r.uniform2f(m.u_wind_min,this.windData.uMin,this.windData.vMin),r.uniform2f(m.u_wind_max,this.windData.uMax,this.windData.vMax),r.uniform1f(m.u_speed_factor,this.speedFactor),r.uniform1f(m.u_interpolation,t),r.uniform1f(m.u_drop_rate,this.dropRate),r.uniform1f(m.u_drop_rate_bump,this.dropRateBump),r.uniform1i(m.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap),r.uniform2fv(m.uNearFarArray_loc,e.frustumVolumeControl.nearFarArray),!this.flipTexCoordsY_windMap);var x,_=(x=this.getGeographicExtent()).getMinLongitudeRad(),y=x.getMinLatitudeRad(),T=x.getMaxLongitudeRad(),C=x.getMaxLatitudeRad();r.uniform3fv(m.u_geoCoordRadiansMax,[T,C,16e3]),r.uniform3fv(m.u_geoCoordRadiansMin,[_,y,0]);var b=u.length/4;b>16&&(b=16);var M=new Float32Array(u);r.uniform4fv(m.u_visibleTilesRanges,M),r.uniform1i(m.u_visibleTilesRangesCount,b);var A=o.modelViewProjRelToEyeMatrix;r.uniformMatrix4fv(m.ModelViewProjectionMatrixRelToEye,!1,A._floatArrays);var E=this.windDisplayPlane.geoLocDataManager.getCurrentGeoLocationData();r.uniformMatrix4fv(m.uBuildingRotMatrix_loc,!1,E.rotMatrix._floatArrays),r.uniform3fv(m.buildingPosHIGH,[E.positionHIGH[0],E.positionHIGH[1],E.positionHIGH[2]]),r.uniform3fv(m.buildingPosLOW,[E.positionLOW[0],E.positionLOW[1],E.positionLOW[2]]),r.uniform3fv(m.encodedCameraPositionMCHigh,o.encodedCamPosHigh),r.uniform3fv(m.encodedCameraPositionMCLow,o.encodedCamPosLow),r.uniform1f(m.uTangentOfHalfFovy_loc,n.frustum.tangentOfHalfFovy[0]),r.uniform1f(m.uFar_loc,n.frustum.far[0]),r.uniform1f(m.uAspectRatio_loc,n.frustum.aspectRatio[0]);var L=o.getModelViewMatrixInv();r.uniformMatrix4fv(m.uModelViewMatInv_loc,!1,L._floatArrays);var w=E.getRotMatrixInv();r.uniformMatrix4fv(m.buildingRotMatrixInv,!1,w._floatArrays),r.drawArrays(r.TRIANGLES,0,6),this.particlesPositionTexturesArray.push(i),ae.bindFramebuffer(r,null)}},Pn.prototype.updateParticlesPositions2dMode=function(){var e=this.gl;ae.bindFramebuffer(e,this.windFramebuffer,this.particlesPositionTexture1),e.viewport(0,0,this.particleStateResolution,this.particleStateResolution);var t=this.updateParticlesProgram;e.useProgram(t.program),ae.bindAttribute(e,this.quadBuffer,t.a_pos,2),e.uniform1i(t.u_wind,0),e.uniform1i(t.u_particles,1);var r=Math.random();e.uniform1f(t.u_rand_seed,r),e.uniform2f(t.u_wind_res,this.windData.width,this.windData.height),e.uniform2f(t.u_wind_min,this.windData.uMin,this.windData.vMin),e.uniform2f(t.u_wind_max,this.windData.uMax,this.windData.vMax),e.uniform1f(t.u_speed_factor,this.speedFactor),e.uniform1f(t.u_drop_rate,this.dropRate),e.uniform1f(t.u_drop_rate_bump,this.dropRateBump),e.uniform1i(t.u_flipTexCoordY_windMap,this.flipTexCoordsY_windMap),e.drawArrays(e.TRIANGLES,0,6);var i=this.particlesPositionTexture0;this.particlesPositionTexture0=this.particlesPositionTexture1,this.particlesPositionTexture1=i,ae.bindFramebuffer(e,null)};var In,Fn=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.windLayersArray,this._windLayersAltitudesArray,this.weatherStation,this.extrusionHeight,this.windDisplayBox,this.windDisplayPlane,this.windDisplayPlanesArray=[],this._geoJsonFile,this._geoJsonFilePath,this._geoJsonFileLoadState=I.fileLoadState.READY,this._geoJsonFileFolderPath,this.streamLinesArray,this._animationState=1,this._particesGenerationType=1,this._animationSpeed=1,this._particlesGeneratorBoxesArray,t&&(void 0!==t.geoJsonFile&&this.setWindGeoJson(t.geoJsonFile),void 0!==t.geoJsonFilePath&&(this._geoJsonFilePath=t.geoJsonFilePath),void 0!==t.geoJsonFileFolderPath&&(this._geoJsonFileFolderPath=t.geoJsonFileFolderPath),void 0!==t.particesGenerationType&&(this._particesGenerationType=t.particesGenerationType),void 0!==t.animationSpeed&&(this._animationSpeed=t.animationSpeed))};function H(e){"@babel/helpers - typeof";return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function H(e){"@babel/helpers - typeof";return(H="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function On(e,t){this.jsonresponse=e,this.nodes=[],this.edges=[],this.cellSpaceMembers=[],this.cellSpaceBoundaryMembers=[],this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0,this.center_X=0,this.center_Y=0,this.ENU=new Cesium.Matrix4,this.jsonParsor,this.parsingJson(e,t),this.setCenter()}function Bn(e){this.jsonresponse=e,this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0}function Nn(e){this.jsonresponse=e,this.max_X=0,this.max_Y=0,this.max_Z=0,this.min_X=0,this.min_Y=0,this.min_Z=0}function Un(e,t,r,i){if(this.description=e,this.href=t,this.id=r,this.surfaceMember=i,this.usage="",-1!=e.indexOf("Usage=")){var o=e.indexOf("Usage=")+6;this.usage=e.substring(o,e.indexOf(":",o))}if(this.section="",-1!=e.indexOf("Section=")){var n=e.indexOf("Section=")+8;this.section=e.substring(n,e.indexOf(":",n))}if(this.floor="",-1!=e.indexOf("Floor=")){var a=e.indexOf("Floor=")+6;this.floor=e.substring(a)}}function Gn(e){this.coordinates=e}function zn(e){this.coordinates=e}function Hn(e,t,r){if(this.connects=e,this.description=t,this.stateMembers=r,null!=t){if(this.usage="",-1!=t.indexOf("Usage=")){var i=t.indexOf("Usage=")+6;this.usage=t.substring(i,t.indexOf(":",i))}if(this.section="",-1!=t.indexOf("Section=")){var o=t.indexOf("Section=")+8;this.section=t.substring(o,t.indexOf(":",o))}if(this.floor="",-1!=t.indexOf("Floor=")){var n=t.indexOf("Floor=")+6;this.floor=t.substring(n)}}}Fn.prototype.switchAnimationState=function(){0===this._animationState?this._animationState=1:1===this._animationState&&(this._animationState=0)},Fn.prototype.getWindLayersCount=function(){return void 0===this.windLayersArray?0:this.windLayersArray.length},Fn.prototype.getWindLayer=function(e){if(void 0!==this.windLayersArray)return this.windLayersArray[e]},Fn.prototype.deleteObjects=function(e){if(this.windLayersArray)for(var t=this.windLayersArray.length,r=0;r<t;r++)this.windLayersArray[r].deleteObjects(e),this.windLayersArray[r]=void 0;this.windLayersArray=void 0,this._windLayersAltitudesArray=void 0,this.weatherStation=void 0,this.extrusionHeight=void 0;var i=e.vboMemoryManager;if(this.windDisplayBox&&(this.windDisplayBox.deleteObjects(i),e.modeler.removeObject(this.windDisplayBox)),this.windDisplayBox=void 0,this.windDisplayPlane=void 0,this.windDisplayPlanesArray){var o=this.windDisplayPlanesArray.length;for(r=0;r<o;r++)this.windDisplayPlanesArray[r].deleteObjects(i),e.modeler.removeObject(this.windDisplayPlanesArray[r]),this.windDisplayPlanesArray[r]=void 0}if(this.windDisplayPlanesArray=void 0,delete this._geoJsonFile,this._geoJsonFilePath=void 0,this._geoJsonFileLoadState=void 0,this._geoJsonFileFolderPath=void 0,this.streamLinesArray){var n=this.streamLinesArray.length;for(r=0;r<n;r++)this.streamLinesArray[r].deleteObjects(i),this.streamLinesArray[r]=void 0}if(this.streamLinesArray=void 0,this._animationState=void 0,this._particesGenerationType=void 0,this._particlesGeneratorBoxesArray){var a=this._particlesGeneratorBoxesArray.length;for(r=0;r<a;r++)this._particlesGeneratorBoxesArray[r].deleteObjects(i),e.modeler.removeObject(this._particlesGeneratorBoxesArray[r]),this._particlesGeneratorBoxesArray[r]=void 0}this._particlesGeneratorBoxesArray=void 0},Fn.prototype.newWindLayer=function(e){void 0===this.windLayersArray&&(this.windLayersArray=[]);var t=new Pn(e);return t.weatherStation=this.weatherStation,t.windVolume=this,this.windLayersArray.push(t),t},Fn.prototype.createWindParticlesCreatorBox=function(e){var t=this.getGeographicExtent();if(!t)return!1;var r=t.getMidPoint(void 0),i=t.minGeographicCoord,o=t.maxGeographicCoord,n=(i.longitude,o.longitude,i.latitude,o.latitude,i.altitude),a=(o.altitude,new pe(r.longitude,r.latitude,n+10)),s=new qi(50,50,50,"particlesGenerator");s.setGeographicPosition(a,0,0,0),s.attributes.isMovable=!0,s.options={};return e.modeler.addObject(s,6),this._particlesGeneratorBoxesArray||(this._particlesGeneratorBoxesArray=[]),this._particlesGeneratorBoxesArray.push(s),!0},Fn.prototype.createWindDisplayPlane=function(e){var t=this.getGeographicExtent();if(!t)return!1;var r=t.minGeographicCoord,i=t.maxGeographicCoord,o=r.longitude,n=i.longitude,a=r.latitude,s=i.latitude,l=r.altitude,u=(i.altitude,new ve);u.newGeoCoord(o,a,l),u.newGeoCoord(n,a,l),u.newGeoCoord(n,s,l),u.newGeoCoord(o,s,l);for(var c=0;c<1;c++){var d=u.getExtrudedMeshRenderableObject(.1,!0,void 0,e,void 0);d.setOneColor(.8,.7,.2,0),d.attributes.isMovable=!0,d.attributes.movementInAxisZ=!0,d.attributes.isSelectable=!0,d.attributes.minAltitude=this.getMinAltitude(),d.attributes.maxAltitude=this.getMaxAltitude(),d.attributes.name="windDisplayPlane",d.attributes.selectedColor4=new J(1,0,0,0),void 0===d.options&&(d.options={}),d.options.renderWireframe=!0,d.options.renderShaded=!0,d.options.depthMask=!1;e.modeler.addObject(d,5),this.windDisplayPlanesArray.push(d)}return!0},Fn.prototype.getGeographicExtent=function(){if(!this.geoExtent){var e=this._geoJsonFile.features,t=e.length;if(t>0){var r;r=e[0];var i=new G;i.initXYZData(r.bbox[0],r.bbox[1],r.bbox[2]);for(var o=0;o<t;o++){var n=(r=e[o]).bbox;i.addXYZData(n[0],n[1],n[2]),i.addXYZData(n[3],n[4],n[5])}this.geoExtent=new xe(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ)}}return this.geoExtent},Fn.prototype.createWindDisplayBox=function(e){var t=this.getGeographicExtent();if(!t)return!1;var r=t.minGeographicCoord,i=t.maxGeographicCoord,o=r.longitude,n=i.longitude,a=r.latitude,s=i.latitude,l=r.altitude,u=i.altitude,c=new ve;c.newGeoCoord(o,a,l),c.newGeoCoord(n,a,l),c.newGeoCoord(n,s,l),c.newGeoCoord(o,s,l);var d=u-l;if(this.windDisplayBox=c.getExtrudedMeshRenderableObject(d,!0,void 0,e,void 0),this.windDisplayBox.setOneColor(0,146/255,203/255,.3),this.windDisplayBox.attributes.isMovable=!1,this.windDisplayBox.attributes.isSelectable=!1,this.windDisplayBox.attributes.name="windDisplayBox",this.windDisplayBox.attributes.doubleFace=!0,this.windDisplayBox.attributes.selectedColor4=new J(1,0,0,0),void 0===this.windDisplayBox.options&&(this.windDisplayBox.options={}),this.windDisplayBox.options.renderWireframe=!0,this.windDisplayBox.objectsArray&&this.windDisplayBox.objectsArray.length>0){var h=this.windDisplayBox.objectsArray[0];h.thickness=2.5;var f=h.getSurfacesCount();h.setColor(0,146/255,203/255,.3),h.getSurface(f-2).setColor(0,146/255,203/255,0),h.getSurface(f-1).setColor(0,146/255,203/255,0)}this.windDisplayBox.options.renderShaded=!0,this.windDisplayBox.options.depthMask=!1;return e.modeler.addObject(this.windDisplayBox,4),!0},Fn.prototype._createdElemsForDisplayBox=function(e){void 0===this.windDisplayBox&&this.createWindDisplayBox(e)&&0===this.windDisplayPlanesArray.length&&this.createWindDisplayPlane(e)},Fn.prototype.setWindAnimationSpeed=function(e){this._animationSpeed=e},Fn.prototype.setWindGeoJson=function(e){e&&(this._geoJsonFile=e,this._geoJsonFileLoadState=I.fileLoadState.LOADING_FINISHED,this._geoJsonFile.style&&this._geoJsonFile.style.colorRamp&&(this.colorRamp=new Q(this._geoJsonFile.style.colorRamp)))},Fn.prototype.loadWindGeoJson=function(){if(this._geoJsonFileLoadState===I.fileLoadState.READY){this._geoJsonFileLoadState=I.fileLoadState.LOADING_STARTED;var e=this;rn(this._geoJsonFilePath,void 0,void 0,"json","GET").done(function(t){e.setWindGeoJson(t)})}},Fn.prototype.prepareVolume=function(e){return!!this._prepareWindGeoJson()&&(!!this._prepareWindLayers()&&(void 0!==this.windDisplayBox||(this._createdElemsForDisplayBox(e),!1)))},Fn.prototype.getMaxAltitude=function(){var e=this.getGeographicExtent();if(e)return e.maxGeographicCoord.altitude},Fn.prototype.getMinAltitude=function(){var e=this.getGeographicExtent();if(e)return e.minGeographicCoord.altitude},Fn.prototype.getNearestWindLayerByAltitude=function(e){if(this._windLayersAltitudesArray){var t=Rn.binarySearch_layersByAltitude(this._windLayersAltitudesArray,e);return this.windLayersArray[t]}},Fn.prototype._getRayIntersectionWithVolume=function(e,t,r){var i,o,n,a=r.getGl(),s=on.getRayCamSpace(e,t,void 0,r),l=this._getVolumeRearFBO(),u=l.colorBuffersArray[1],c=l.colorBuffersArray[2],d=on.calculatePixelLinearDepthV2(a,e,t,u,c,r);if(d.frustumIdx<r.numFrustums&&(i=d.linearDepth,o=d.far,d.near,n=d.normal4),!(n[0]+n[1]+n[2]<.1)){var h,f=i*o,g=new Jr(s[0]*f,s[1]*f,s[2]*f),p=this._getVolumeFrontFBO();return u=p.colorBuffersArray[1],c=p.colorBuffersArray[2],(d=on.calculatePixelLinearDepthV2(a,e,t,u,c,r)).frustumIdx<r.numFrustums&&(i=d.linearDepth,o=d.far,d.near,n=d.normal4),n[0]+n[1]+n[2]<.1?h=new Jr(0,0,0):(f=i*o,h=new Jr(s[0]*f,s[1]*f,s[2]*f)),new vi(h,g)}},Fn.prototype.newWindStreamLine_overTerrain=function(e,t){t||(t={}),t.startColor||(t.startColor=new J(.8,1,1,1)),t.endColor||(t.endColor=new J(.8,1,1,1)),void 0===t.numPoints&&(t.numPoints=this.weatherStation.WIND_STREAMLINES_NUMPOINTS);var r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0];if(1===this._particesGenerationType){var n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o);if(x=this._getRayIntersectionWithVolume(n,a,e)){var s=Math.random(),l=x.getDirection(),u=x.getLength()*s,c=x.startPoint3d,d=new Jr(c.x+l.x*u,c.y+l.y*u,c.z+l.z*u),h=on.cameraCoordPositionToWorldCoord(d,void 0,e),f=on.pointToGeographicCoord(h,void 0);return this._getWindStreamLine_overTerrain(f,e,t)}}else if(2===this._particesGenerationType&&this._particlesGeneratorBoxesArray&&this._particlesGeneratorBoxesArray.length>0){f=this._particlesGeneratorBoxesArray[0].geoLocDataManager.getCurrentGeoLocationData().geographicCoord;var g=.001*(.5-Math.random()),p=.001*(.5-Math.random()),m=50*Math.random(),v=new pe(f.longitude+g,f.latitude+p,f.altitude+m);return this._getWindStreamLine_overTerrain(v,e,t)}if(3===this._particesGenerationType){var x;n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o);if(x=this._getRayIntersectionWithVolume(n,a,e)){s=Math.random(),l=x.getDirection(),u=x.getLength()*s,c=x.startPoint3d,d=new Jr(x.endPoint3d.x,x.endPoint3d.y,x.endPoint3d.z),h=on.cameraCoordPositionToWorldCoord(d,void 0,e),f=on.pointToGeographicCoord(h,void 0);return this._getWindStreamLine_overTerrain(f,e,t)}}},Fn.prototype.newWindStreamLine=function(e){var t={};t.startColor=new J(.8,1,1,1),t.endColor=new J(.8,1,1,1),t.numPoints=this.weatherStation.WIND_STREAMLINES_NUMPOINTS;var r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0];if(1===this._particesGenerationType){var n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o);if(x=this._getRayIntersectionWithVolume(n,a,e)){var s=Math.random(),l=x.getDirection(),u=x.getLength()*s,c=x.startPoint3d,d=new Jr(c.x+l.x*u,c.y+l.y*u,c.z+l.z*u),h=on.cameraCoordPositionToWorldCoord(d,void 0,e),f=on.pointToGeographicCoord(h,void 0);return this._getWindStreamLine(f,e,t)}}else if(2===this._particesGenerationType&&this._particlesGeneratorBoxesArray&&this._particlesGeneratorBoxesArray.length>0){f=this._particlesGeneratorBoxesArray[0].geoLocDataManager.getCurrentGeoLocationData().geographicCoord;var g=.001*(.5-Math.random()),p=.001*(.5-Math.random()),m=50*Math.random(),v=new pe(f.longitude+g,f.latitude+p,f.altitude+m);return this._getWindStreamLine(v,e,t)}if(3===this._particesGenerationType){var x;n=Math.floor(Math.random()*i),a=Math.floor(Math.random()*o);if(x=this._getRayIntersectionWithVolume(n,a,e)){s=Math.random(),l=x.getDirection(),u=x.getLength()*s,c=x.startPoint3d,d=new Jr(x.endPoint3d.x,x.endPoint3d.y,x.endPoint3d.z),h=on.cameraCoordPositionToWorldCoord(d,void 0,e),f=on.pointToGeographicCoord(h,void 0);return this._getWindStreamLine(f,e,t)}}},Fn.prototype.newWindStreamLine_oneLayer=function(e){var t=this.getNearestWindLayerByAltitude(80);if(t){var r=t.getGeographicExtent(),i=(r.getMinLongitudeRad(),r.getMinLatitudeRad(),r.getMaxLongitudeRad(),r.getMaxLatitudeRad(),r.getMinAltitude(),r.getMaxAltitude(),Math.PI,{});i.startColor=new J(.8,1,1,1),i.endColor=new J(.8,1,1,1),i.numPoints=300;var o,n,a=e.sceneState,s=a.drawingBufferWidth[0],l=a.drawingBufferHeight[0],u=Math.floor(Math.random()*s),c=Math.floor(Math.random()*l),d=t.getWindPlaneFBO(e),h=d.colorBuffersArray[1],f=d.colorBuffersArray[2],g=e.getGl(),p=on.calculatePixelLinearDepthV2(g,u,c,h,f,e);p.frustumIdx<e.numFrustums&&(o=p.linearDepth,n=p.far,p.near);var m=o*n,v=on.getRayCamSpace(u,c,void 0,e),x=new Jr;x.set(v[0]*m,v[1]*m,v[2]*m);var _=on.cameraCoordPositionToWorldCoord(x,void 0,e),y=on.pointToGeographicCoord(_,void 0),T=t.windData.height_above_ground;if(!(Math.abs(y.altitude-T)>50))if(y.altitude=80,r.intersects2dWithGeoCoord(y))return this._getWindStreamLine_oneLayer(y,t,e,i)}},Fn.prototype._prepareWindGeoJson=function(){return this._geoJsonFileLoadState===I.fileLoadState.READY?(this.loadWindGeoJson(),!1):this._geoJsonFileLoadState===I.fileLoadState.LOADING_FINISHED},Fn.prototype._prepareWindLayers=function(){if(!this._geoJsonFile)return!1;if(void 0===this.windLayersArray){this.windLayersArray=[];var e=this._geoJsonFileFolderPath,t=this._geoJsonFile.features;if((l=t.length)>0){var r;this._windLayersAltitudesArray=new Array(l),r=t[0];var i=new G;i.initXYZData(r.bbox[0],r.bbox[1],r.bbox[2]);for(var o=0;o<l;o++){var n={geoJsonFile:r=t[o],geoJsonFileFolderPath:e},a=(this.newWindLayer(n),r.bbox);i.addXYZData(a[0],a[1],a[2]),i.addXYZData(a[3],a[4],a[5]),this._windLayersAltitudesArray[o]=a[2]}this.geoExtent?this.geoExtent.setExtent(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ):this.geoExtent=new xe(i.minX,i.minY,i.minZ,i.maxX,i.maxY,i.maxZ)}return!1}if(!this._allWindLayersPrepared){var s=!0,l=this.windLayersArray.length;for(o=0;o<l;o++){this.windLayersArray[o].prepareWindLayer()||(s=!1)}return s&&(this._allWindLayersPrepared=!0),!1}return!0},Fn.prototype._getVolumeFrontFBO=function(e){if(!this.volumeFrontFBO){var t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.volumeFrontFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeFrontFBO},Fn.prototype._getVolumeRearFBO=function(e){if(!this.volumeRearFBO){var t=e.getGl(),r=e.sceneState,i=r.drawingBufferWidth[0],o=r.drawingBufferHeight[0],n=e.postFxShadersManager.bUseMultiRenderTarget;this.volumeRearFBO=new ae(t,i,o,{matchCanvasSize:!0,multiRenderTarget:n,numColorBuffers:4})}return this.volumeRearFBO},Fn.prototype.renderDepthWindVolumeORT=function(e){e.sceneState;var t=e.getGl();if(this.visibleObjControler||(this.visibleObjControler=new _t),this.windDisplayBox&&(this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.windDisplayBox),this.windDisplayPlanesArray&&this.windDisplayPlanesArray.length>0){var r=this.windDisplayPlanesArray[0];this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[1]=r}var i=this._getVolumeFrontFBO(e);i.bind();var o={bRenderDepth:!0,bRenderNormal:!1,bRenderAlbedo:!1,bRenderSelColor:!1,ouputDepthTex:i.colorBuffersArray[1],ouputNormalTex:void 0,ouputAlbedoTex:void 0,ouputSelColorTex:void 0};2===e.currentFrustumIdx&&(t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i.colorBuffersArray[1],0),t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1));var n=1;t.frontFace(t.CCW),e.renderer.renderGeometryBufferORT(t,n,this.visibleObjControler,o);o={bRenderDepth:!1,bRenderNormal:!0,bRenderAlbedo:!1,bRenderSelColor:!1,ouputDepthTex:void 0,ouputNormalTex:i.colorBuffersArray[2],ouputAlbedoTex:void 0,ouputSelColorTex:void 0};2===e.currentFrustumIdx&&(t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,i.colorBuffersArray[2],0),t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1));n=1;t.frontFace(t.CCW),e.renderer.renderGeometryBufferORT(t,n,this.visibleObjControler,o),e.windVolumeFrontDepthTex=i.colorBuffersArray[1],e.windVolumeFrontNormalTex=i.colorBuffersArray[2];var a=this._getVolumeRearFBO(e);a.bind();o={bRenderDepth:!0,bRenderNormal:!1,bRenderAlbedo:!1,bRenderSelColor:!1,ouputDepthTex:a.colorBuffersArray[1],ouputNormalTex:void 0,ouputAlbedoTex:void 0,ouputSelColorTex:void 0};2===e.currentFrustumIdx&&(t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,a.colorBuffersArray[1],0),t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1));n=1;t.frontFace(t.CW),e.renderer.renderGeometryBufferORT(t,n,this.visibleObjControler,o);o={bRenderDepth:!1,bRenderNormal:!0,bRenderAlbedo:!1,bRenderSelColor:!1,ouputDepthTex:void 0,ouputNormalTex:a.colorBuffersArray[2],ouputAlbedoTex:void 0,ouputSelColorTex:void 0};2===e.currentFrustumIdx&&(t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,a.colorBuffersArray[2],0),t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1));n=1;t.frontFace(t.CW),e.renderer.renderGeometryBufferORT(t,n,this.visibleObjControler,o),e.windVolumeRearDepthTex=a.colorBuffersArray[1],e.windVolumeRearNormalTex=a.colorBuffersArray[2],e.windVolumeFrontDepthTex=i.colorBuffersArray[1],t.frontFace(t.CCW)},Fn.prototype.renderDepthWindVolume=function(e){e.sceneState;var t=e.getGl(),r=e.extbuffers;if(this.visibleObjControler||(this.visibleObjControler=new _t),this.windDisplayBox&&(this.windDisplayBox.attributes.doubleFace=!1,this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[0]=this.windDisplayBox),this.windDisplayPlanesArray&&this.windDisplayPlanesArray.length>0){var i=this.windDisplayPlanesArray[0];this.visibleObjControler.currentVisibleNativeObjects.opaquesArray[1]=i}if(1===this._particesGenerationType||3===this._particesGenerationType){this.windDisplayBox.options.depthMask=!0;for(var o=this.windDisplayPlanesArray.length,n=0;n<o;n++){this.windDisplayPlanesArray[n].options.depthMask=!0}}3===this._particesGenerationType&&(this.windDisplayBox.attributes.isVisible=!1);var a=this._getVolumeFrontFBO(e);a.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,a.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,a.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,a.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,a.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1));var s=1;t.frontFace(t.CCW),e.renderer.renderGeometryBuffer(t,s,this.visibleObjControler),e.windVolumeFrontDepthTex=a.colorBuffersArray[1],e.windVolumeFrontNormalTex=a.colorBuffersArray[2];var l=this._getVolumeRearFBO(e);l.bind(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL,t.TEXTURE_2D,l.colorBuffersArray[0],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,l.colorBuffersArray[1],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,l.colorBuffersArray[2],0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,l.colorBuffersArray[3],0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.COLOR_ATTACHMENT1_WEBGL,r.COLOR_ATTACHMENT2_WEBGL,r.COLOR_ATTACHMENT3_WEBGL]),2===e.currentFrustumIdx&&(t.clearColor(0,0,0,1),t.clearDepth(1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),t.clearColor(0,0,0,1));s=1;if(t.frontFace(t.CW),e.renderer.renderGeometryBuffer(t,s,this.visibleObjControler),e.windVolumeRearDepthTex=l.colorBuffersArray[1],e.windVolumeRearNormalTex=l.colorBuffersArray[2],this.windDisplayBox.attributes.doubleFace=!0,t.frontFace(t.CCW),1===this._particesGenerationType||3===this._particesGenerationType){this.windDisplayBox.options.depthMask=!1;for(o=this.windDisplayPlanesArray.length,n=0;n<o;n++){this.windDisplayPlanesArray[n].options.depthMask=!1}}3===this._particesGenerationType&&(this.windDisplayBox.attributes.isVisible=!0),e.bindMainFramebuffer(),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT1_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT2_WEBGL,t.TEXTURE_2D,null,0),t.framebufferTexture2D(t.FRAMEBUFFER,r.COLOR_ATTACHMENT3_WEBGL,t.TEXTURE_2D,null,0),r.drawBuffersWEBGL([r.COLOR_ATTACHMENT0_WEBGL,r.NONE,r.NONE,r.NONE])},Fn.prototype.renderMode3DThickLines=function(e){if(this.prepareVolume(e)){this.streamLinesArray||(this.streamLinesArray=[]);var t=this.streamLinesArray.length;if(this.renderDepthWindVolume(e),t<this.weatherStation.WIND_MAXPARTICLES_INSCREEN&&0===e.currentFrustumIdx)if("NORMAL"===this.weatherStation.windDisplayMode)for(var r=0;r<3;r++){(v=this.newWindStreamLine(e))&&this.streamLinesArray.push(v)}else if("OVERTERRAIN"===this.weatherStation.windDisplayMode){if(this._updatedCartographicArray||(this._updatedCartographicArray=[]),this._pointsLCArrayArray||(this._pointsLCArrayArray=[]),this._optionThickLinesArray||(this._optionThickLinesArray=[]),this._updatedCartographicArray.length<1)for(r=0;r<2;r++){var i={};i.startColor=new J(.8,1,1,1),i.endColor=new J(.8,1,1,1),i.numPoints=this.weatherStation.WIND_STREAMLINES_NUMPOINTS,this.newWindStreamLine_overTerrain(e,i)}var o=this._updatedCartographicArray.length;o>2&&(o=2);for(r=0;r<o;r++){for(var n=this._updatedCartographicArray.shift(),a=this._pointsLCArrayArray.shift(),s=this._optionThickLinesArray.shift(),l=n[0],u=n.length,c=0;c<u;c++)a[c].z=n[c].height+10;a.reverse();var d=on.calculateGeoLocationData(180*l.longitude/Math.PI,180*l.latitude/Math.PI,20,0,0,0,void 0),h=this._getVectorMeshFromPoints3dLCArray(a,d,e,s);h&&this.streamLinesArray.push(h)}}var f=e.extbuffers,g=e.getGl();e.bindMainFramebuffer(),g.framebufferTexture2D(g.FRAMEBUFFER,f.COLOR_ATTACHMENT1_WEBGL,g.TEXTURE_2D,e.depthTex,0),g.framebufferTexture2D(g.FRAMEBUFFER,f.COLOR_ATTACHMENT2_WEBGL,g.TEXTURE_2D,e.normalTex,0),g.framebufferTexture2D(g.FRAMEBUFFER,f.COLOR_ATTACHMENT3_WEBGL,g.TEXTURE_2D,e.albedoTex,0),f.drawBuffersWEBGL([f.COLOR_ATTACHMENT0_WEBGL,f.COLOR_ATTACHMENT1_WEBGL,f.COLOR_ATTACHMENT2_WEBGL,f.COLOR_ATTACHMENT3_WEBGL]);g=e.getGl();var p=e.sceneState,m=e.postFxShadersManager.getShader("windStreamThickLine");m.useProgram(),m.bindUniformGenerals(),g.uniform4fv(m.oneColor4_loc,[.3,.9,.5,1]),g.uniform1i(m.colorType_loc,0),g.uniform2fv(m.viewport_loc,[p.drawingBufferWidth[0],p.drawingBufferHeight[0]]),g.uniform1f(m.thickness_loc,this.weatherStation.windThickness),g.uniform1i(m.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),g.uniform1i(m.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),g.uniform1i(m.uFrustumIdx_loc,e.currentFrustumIdx),g.blendEquationSeparate(g.FUNC_ADD,g.FUNC_ADD),g.blendFuncSeparate(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA,g.ONE,g.ONE_MINUS_SRC_ALPHA),g.disable(g.CULL_FACE),g.enable(g.BLEND),g.enableVertexAttribArray(m.prev_loc),g.enableVertexAttribArray(m.current_loc),g.enableVertexAttribArray(m.next_loc);var v,x=this.streamLinesArray.length,_=[];for(s={animationState:this._animationState,animationSpeed:this._animationSpeed},r=0;r<x;r++){(v=this.streamLinesArray[r]).geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(g,m),v.render(e,m,s),v.finished?(v.deleteObjects(e.vboMemoryManager),v=void 0):_.push(v)}this.streamLinesArray=_,g.useProgram(null),g.enable(g.CULL_FACE),g.disable(g.BLEND)}},Fn.prototype.renderMode3DThickLinesORT=function(e){if(this.prepareVolume(e)){this.streamLinesArray||(this.streamLinesArray=[]);var t=this.streamLinesArray.length;if(this.renderDepthWindVolumeORT(e),t<this.weatherStation.WIND_MAXPARTICLES_INSCREEN&&0===e.currentFrustumIdx)for(var r=0;r<3;r++){(a=this.newWindStreamLine(e))&&this.streamLinesArray.push(a)}var i=e.getGl();e.bindMainFramebuffer(),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e.cesiumColorBuffer,0);i=e.getGl();var o=e.sceneState,n=e.postFxShadersManager.getShader("windStreamThickLine");n.useProgram(),n.bindUniformGenerals(),i.uniform4fv(n.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(n.colorType_loc,0),i.uniform2fv(n.viewport_loc,[o.drawingBufferWidth[0],o.drawingBufferHeight[0]]),i.uniform1f(n.thickness_loc,this.weatherStation.windThickness),i.uniform1i(n.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(n.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),i.uniform1i(n.uFrustumIdx_loc,e.currentFrustumIdx),i.blendEquationSeparate(i.FUNC_ADD,i.FUNC_ADD),i.blendFuncSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),i.disable(i.CULL_FACE),i.disable(i.BLEND),i.disable(i.DEPTH_TEST),i.enableVertexAttribArray(n.prev_loc),i.enableVertexAttribArray(n.current_loc),i.enableVertexAttribArray(n.next_loc);var a,s=this.streamLinesArray.length,l=[],u={animationState:this._animationState};for(r=0;r<s;r++){(a=this.streamLinesArray[r]).geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,n),a.render(e,n,u),a.finished?(a.deleteObjects(e.vboMemoryManager),a=void 0):l.push(a)}this.streamLinesArray=l,i.useProgram(null),i.enable(i.CULL_FACE),i.disable(i.BLEND),i.enable(i.DEPTH_TEST)}},Fn.prototype.renderMode3DThickLines_oneLayer=function(e){if(void 0!==this.windLayersArray&&0!==this.windLayersArray.length&&this.prepareVolume())if(void 0!==this.windDisplayBox){if(void 0===this.windData){this.windData={};for(var t=this.windLayersArray.length,r=0;r<t;r++){(a=this.windLayersArray[r]).windData&&(0===r?(this.windData.uMin=a.windData.uMin,this.windData.vMin=a.windData.vMin,this.windData.uMax=a.windData.uMax,this.windData.vMax=a.windData.vMax,this.windData.height=a.windData.height,this.windData.width=a.windData.width):(a.windData.uMin<this.windData.uMin&&(this.windData.uMin=a.windData.uMin),a.windData.vMin<this.windData.vMin&&(this.windData.vMin=a.windData.vMin),a.windData.uMax>this.windData.uMax&&(this.windData.uMax=a.windData.uMax),a.windData.vMax>this.windData.vMax&&(this.windData.vMax=a.windData.vMax)))}}for(var i=e.getGl(),o=this.windDisplayPlanesArray.length,n=0;n<o;n++){var a,s=this.windDisplayPlanesArray[n];for(r=(t=this.windLayersArray.length)-1;r>=0;r--){var l=150;if(this.windDisplayBox)l=s.geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude;(a=this.getNearestWindLayerByAltitude(l))&&(a.windDisplayPlane=s,a.isReadyToRender()||a.prepareWindLayer())}void 0!==a&&void 0!==a.windMapTexture&&a.windMapTexture.fileLoadState===I.fileLoadState.BINDING_FINISHED&&a.renderWindPlaneDepth(e)}if(this.streamLinesArray||(this.streamLinesArray=[]),this.streamLinesArray.length<1e3&&0===e.currentFrustumIdx)for(r=0;r<3;r++){(f=this.newWindStreamLine(e))&&this.streamLinesArray.push(f)}var u=e.scene,c=e.extbuffers;u.view.globeDepth.framebuffer._bind(),i.framebufferTexture2D(i.FRAMEBUFFER,c.COLOR_ATTACHMENT1_WEBGL,i.TEXTURE_2D,e.depthTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,c.COLOR_ATTACHMENT2_WEBGL,i.TEXTURE_2D,e.normalTex,0),i.framebufferTexture2D(i.FRAMEBUFFER,c.COLOR_ATTACHMENT3_WEBGL,i.TEXTURE_2D,e.albedoTex,0),c.drawBuffersWEBGL([c.COLOR_ATTACHMENT0_WEBGL,c.COLOR_ATTACHMENT1_WEBGL,c.COLOR_ATTACHMENT2_WEBGL,c.COLOR_ATTACHMENT3_WEBGL]);i=e.getGl();var d=e.sceneState,h=e.postFxShadersManager.getShader("windStreamThickLine");h.useProgram(),h.bindUniformGenerals(),i.uniform4fv(h.oneColor4_loc,[.3,.9,.5,1]),i.uniform1i(h.colorType_loc,0),i.uniform2fv(h.viewport_loc,[d.drawingBufferWidth[0],d.drawingBufferHeight[0]]),i.uniform1f(h.thickness_loc,2.5),i.uniform1i(h.bUseLogarithmicDepth_loc,e.postFxShadersManager.bUseLogarithmicDepth),i.uniform1i(h.bUseMultiRenderTarget_loc,e.postFxShadersManager.bUseMultiRenderTarget),i.uniform1i(h.uFrustumIdx_loc,e.currentFrustumIdx),i.disable(i.CULL_FACE),i.enable(i.BLEND),i.enableVertexAttribArray(h.prev_loc),i.enableVertexAttribArray(h.current_loc),i.enableVertexAttribArray(h.next_loc);var f,g=this.streamLinesArray.length,p=[];for(r=0;r<g;r++){(f=this.streamLinesArray[r]).geoLocDataManager.getCurrentGeoLocationData().bindGeoLocationUniforms(i,h),f.render(e,h),f.finished?(f.deleteObjects(e.vboMemoryManager),f=void 0):p.push(f)}this.streamLinesArray=p,i.useProgram(null),i.enable(i.CULL_FACE),i.disable(i.BLEND),i.depthMask(!0)}else this._createdElemsForDisplayBox(e)},Fn.prototype._getTrajectoryInLocalCoordinates=function(e,t,r){var i=this.getGeographicExtent();if(i.intersects2dWithGeoCoord(e)){var o=i.getMinLongitudeRad(),n=i.getMinLatitudeRad(),a=i.getMaxLongitudeRad()-o,s=i.getMaxLatitudeRad()-n,l=e.getLongitudeRad(),u=e.getLatitudeRad(),c=e.getAltitude(),d=i.getCenterLatitude(),h=Te.radiusAtLatitudeDeg(d),f=1/(h*(U=Math.cos(d*Math.PI/180))),g=1/h,p=20;r&&void 0!==r.numPoints&&(p=r.numPoints);for(var m,v,x,_,y,T,C,b=[],M=new Jr,A=0,E=0,L=0,w=this.windLayersArray.length,S=0;S<p;S++){var D=(l-o)/a,R=(u-n)/s;if(D>1||R>1||D<0||R<0)return b;var P=Rn.binarySearch_layersByAltitude(this._windLayersAltitudesArray,c);P>=w?P=w-1:P<0&&(P=0);var I=P-1<0?0:P-1,F=this.windLayersArray[I],O=this.windLayersArray[P],B=F.getAltitude(),N=O.getAltitude();C=P===I?1:(c-B)/(N-B),_=F.getVelocityVector3d_biLinearInterpolation(D,R,_,t),y=O.getVelocityVector3d_biLinearInterpolation(D,R,y,t),T=Jr.mix(_,y,C,void 0);var U=Math.cos(n+u*s);m=T.x/U*1,v=1*T.y,x=1*T.z;M=new Jr(A+=m,E+=v,L+=x);if(b.push(M),r.velocitiesArray&&r.velocitiesArray.push(T),l+=m*f,u+=v*g,c+=x,Math.abs(T.x)+Math.abs(T.y)+Math.abs(T.z)<.002)return b}return b}},Fn.prototype._getTrajectoryInLocalCoordinates_overTerrain=function(e,t,r){var i=this.getGeographicExtent();if(i.intersects2dWithGeoCoord(e)){var o=i.getMinLongitudeRad(),n=i.getMinLatitudeRad(),a=i.getMaxLongitudeRad()-o,s=i.getMaxLatitudeRad()-n,l=e.getLongitudeRad(),u=e.getLatitudeRad(),c=e.getAltitude(),d=Math.PI/180,h=(Math.PI,i.getCenterLatitude()),f=Te.radiusAtLatitudeDeg(h),g=1/(f*(W=Math.cos(h*d))),p=1/f,m=t.weatherStation.speedFactor,v=m,x=m,_=m,y=20;r&&void 0!==r.numPoints&&(y=r.numPoints);var T,C,b,M,A,E,L,w=[],S=new Jr,D=0,R=0,P=0,I=this.windLayersArray.length,F=[];r.velocitiesArray=[];for(var O=0;O<y;O++){var B=(l-o)/a,N=(u-n)/s;if(B>1||N>1||B<0||N<0)break;var U=new Cesium.Cartographic(l,u,0);F.push(U);var G=Rn.binarySearch_layersByAltitude(this._windLayersAltitudesArray,c);G>=I?G=I-1:G<0&&(G=0);var z=G-1<0?0:G-1,H=this.windLayersArray[z],V=this.windLayersArray[G],k=H.getAltitude(),j=V.getAltitude();L=G===z?1:(c-k)/(j-k),M=H.getVelocityVector3d_biLinearInterpolation(B,N,M,t),A=V.getVelocityVector3d_biLinearInterpolation(B,N,A,t),E=Jr.mix(M,A,L,void 0);var W=Math.cos(n+u*s);T=E.x/W*v,C=E.y*x,b=E.z*_;S=new Jr(D+=T,R+=C,P+=b);if(w.push(S),r.velocitiesArray&&r.velocitiesArray.push(E),l+=T*g,u+=C*p,c+=b,Math.abs(E.x)+Math.abs(E.y)+Math.abs(E.z)<.002)break}if(w.length>0){var X=t.scene.globe.terrainProvider,Y=Fe.getMaximumLevelOfTerrainProvider(X);Y>14&&(Y=14);var q=Cesium.sampleTerrain(X,Y,F);Cesium.when(q,function(e){e.length;var i=t.weatherStation.windVolumesArray[0];i._updatedCartographicArray.push(e),i._pointsLCArrayArray.push(w),i._optionThickLinesArray.push(r)})}}},Fn.prototype._getVectorMeshFromPoints3dLCArray=function(e,t,i,o){if(e&&!(e.length<2)){void 0===o&&(o={}),void 0===o.thickness&&(o.thickness=2),void 0===o.color&&(o.color=new J(.8,1,1,1)),this.colorRamp&&void 0===o.velocitiesArray&&(o.velocitiesArray=[]),e.reverse();var n=new yo(o);if(this.colorRamp){o.colorsArray=[];for(var a,s,l=o.velocitiesArray.length,u=1e6,c=-100,d=0;d<l;d++)s=o.velocitiesArray[d].getModul(),a=this.colorRamp.getInterpolatedColor(s),o.colorsArray.push(a),s>c?c=s:s<u&&(u=s)}n.vboKeysContainer=Qr.getVboThickLines(i,e,n.vboKeysContainer,o),n.geoLocDataManager=new ye,n.geoLocDataManager.addGeoLocationData(t),n.objectType=r.OBJECT_TYPE.VECTORMESH;var h=e.length,f=new Float32Array(4*h);for(d=0;d<4*h;d++)f[d]=d.toFixed(0);var g=n.vboKeysContainer.getVboKey(0),p=i.vboMemoryManager;return g.setDataArrayCustom(f,p,1,"indices",4),n}},Fn.prototype._getWindStreamLine=function(e,t,r){void 0===r&&(r={}),void 0===r.thickness&&(r.thickness=2),void 0===r.color&&(r.color=new J(1,.3,.3,1)),this.colorRamp&&void 0===r.velocitiesArray&&(r.velocitiesArray=[]);var i=this._getTrajectoryInLocalCoordinates(e,t,r);if(i&&!(i.length<2)){i.reverse();var o=on.calculateGeoLocationData(e.longitude,e.latitude,e.altitude,0,0,0,void 0);return this._getVectorMeshFromPoints3dLCArray(i,o,t,r)}},Fn.prototype._getWindStreamLine_overTerrain=function(e,t,r){void 0===r&&(r={}),void 0===r.thickness&&(r.thickness=2),void 0===r.color&&(r.color=new J(1,.3,.3,1)),this.colorRamp&&void 0===r.velocitiesArray&&(r.velocitiesArray=[]),this._getTrajectoryInLocalCoordinates_overTerrain(e,t,r)},Fn.prototype._getWindStreamLine_oneLayer=function(e,t,i){if(void 0!==e&&0!==e.length){for(var o=ve.getGeographicExtent(e,void 0).getMidPoint(void 0),n=on.calculateGeoLocationData(o.longitude,o.latitude,o.altitude,0,0,0,void 0),a=e.length,s=new Array(a),l=0;l<a;l++){var u=Te.geographicToCartesianWgs84(e[l].longitude,e[l].latitude,e[l].altitude,void 0),c=new Jr(u[0],u[1],u[2]);s[l]=c}var d=new Array(a);for(l=0;l<a;l++)d[l]=n.getTransformedRelativePosition(s[l],d[l]);void 0===i&&(i={}),void 0===i.thickness&&(i.thickness=2),void 0===i.color&&(i.color=new J(1,.3,.3,1));var h=new yo(i);h.vboKeysContainer=Qr.getVboThickLines(t,d,h.vboKeysContainer,i),h.geoLocDataManager=new ye,h.geoLocDataManager.addGeoLocationData(n),h.objectType=r.OBJECT_TYPE.VECTORMESH;var f=d.length,g=new Float32Array(4*f);for(l=0;l<4*f;l++)g[l]=l.toFixed(0);var p=h.vboKeysContainer.getVboKey(0),m=t.vboMemoryManager;return p.setDataArrayCustom(g,m,1,"indices",4),h}},Fn.prototype.renderWindLayerDisplayPlanes=function(e){if(void 0!==this.windLayersArray&&0!==this.windLayersArray.length&&this.prepareVolume())if(void 0!==this.windDisplayBox){if(void 0===this.windData){this.windData={};for(var t=this.windLayersArray.length,r=0;r<t;r++){(n=this.windLayersArray[r]).windData&&(0===r?(this.windData.uMin=n.windData.uMin,this.windData.vMin=n.windData.vMin,this.windData.uMax=n.windData.uMax,this.windData.vMax=n.windData.vMax,this.windData.height=n.windData.height,this.windData.width=n.windData.width):(n.windData.uMin<this.windData.uMin&&(this.windData.uMin=n.windData.uMin),n.windData.vMin<this.windData.vMin&&(this.windData.vMin=n.windData.vMin),n.windData.uMax>this.windData.uMax&&(this.windData.uMax=n.windData.uMax),n.windData.vMax>this.windData.vMax&&(this.windData.vMax=n.windData.vMax)))}}e.getGl();for(var i=this.windDisplayPlanesArray.length,o=0;o<i;o++){var n,a=this.windDisplayPlanesArray[o];for(r=(t=this.windLayersArray.length)-1;r>=0;r--){var s=10;if(this.windDisplayBox)s=a.geoLocDataManager.getCurrentGeoLocationData().geographicCoord.altitude;if(n=this.getNearestWindLayerByAltitude(s)){if(n.windDisplayPlane=a,n.isReadyToRender()){n.gl;break}n.prepareWindLayer()}}void 0!==n&&void 0!==n.windMapTexture&&n.windMapTexture.fileLoadState===I.fileLoadState.BINDING_FINISHED&&(n.renderWindPlaneDepth(e),e.isFarestFrustum())}}else this._createdElemsForDisplayBox(e)},function(e,t){if("object"==("undefined"==typeof exports?"undefined":H(exports))&&"object"==("undefined"==typeof module?"undefined":H(module)))module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var i in r)("object"==("undefined"==typeof exports?"undefined":H(exports))?exports:e)[i]=r[i]}}(window,function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var o=t[i]={i:i,l:!1,exports:{}};return e[i].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==H(e)&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(i,o,function(t){return e[t]}.bind(null,o));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=16)}({0:function(e,t,r){e.exports=function(){function e(e,i,o,n,a){!function e(r,i,o,n,a){for(;n>o;){if(n-o>600){var s=n-o+1,l=i-o+1,u=Math.log(s),c=.5*Math.exp(2*u/3),d=.5*Math.sqrt(u*c*(s-c)/s)*(l-s/2<0?-1:1);e(r,i,Math.max(o,Math.floor(i-l*c/s+d)),Math.min(n,Math.floor(i+(s-l)*c/s+d)),a)}var h=r[i],f=o,g=n;for(t(r,o,i),a(r[n],h)>0&&t(r,o,n);f<g;){for(t(r,f,g),f++,g--;a(r[f],h)<0;)f++;for(;a(r[g],h)>0;)g--}0===a(r[o],h)?t(r,o,g):t(r,++g,n),g<=i&&(o=g+1),i<=g&&(n=g-1)}}(e,i,o||0,n||e.length-1,a||r)}function t(e,t,r){var i=e[t];e[t]=e[r],e[r]=i}function r(e,t){return e<t?-1:e>t?1:0}var i=function(e){void 0===e&&(e=9),this._maxEntries=Math.max(4,e),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function o(e,t,r){if(!r)return t.indexOf(e);for(var i=0;i<t.length;i++)if(r(e,t[i]))return i;return-1}function n(e,t){a(e,0,e.children.length,t,e)}function a(e,t,r,i,o){o||(o=g(null)),o.minX=1/0,o.minY=1/0,o.maxX=-1/0,o.maxY=-1/0;for(var n=t;n<r;n++){var a=e.children[n];s(o,e.leaf?i(a):a)}return o}function s(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function l(e,t){return e.minX-t.minX}function u(e,t){return e.minY-t.minY}function c(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function d(e){return e.maxX-e.minX+(e.maxY-e.minY)}function h(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function f(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function g(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function p(t,r,i,o,n){for(var a=[r,i];a.length;)if(!((i=a.pop())-(r=a.pop())<=o)){var s=r+Math.ceil((i-r)/o/2)*o;e(t,s,r,i,n),a.push(r,s,s,i)}}return i.prototype.all=function(){return this._all(this.data,[])},i.prototype.search=function(e){var t=this.data,r=[];if(!f(e,t))return r;for(var i=this.toBBox,o=[];t;){for(var n=0;n<t.children.length;n++){var a=t.children[n],s=t.leaf?i(a):a;f(e,s)&&(t.leaf?r.push(a):h(e,s)?this._all(a,r):o.push(a))}t=o.pop()}return r},i.prototype.collides=function(e){var t=this.data;if(!f(e,t))return!1;for(var r=[];t;){for(var i=0;i<t.children.length;i++){var o=t.children[i],n=t.leaf?this.toBBox(o):o;if(f(e,n)){if(t.leaf||h(e,n))return!0;r.push(o)}}t=r.pop()}return!1},i.prototype.load=function(e){if(!e||!e.length)return this;if(e.length<this._minEntries){for(var t=0;t<e.length;t++)this.insert(e[t]);return this}var r=this._build(e.slice(),0,e.length-1,0);if(this.data.children.length)if(this.data.height===r.height)this._splitRoot(this.data,r);else{if(this.data.height<r.height){var i=this.data;this.data=r,r=i}this._insert(r,this.data.height-r.height-1,!0)}else this.data=r;return this},i.prototype.insert=function(e){return e&&this._insert(e,this.data.height-1),this},i.prototype.clear=function(){return this.data=g([]),this},i.prototype.remove=function(e,t){if(!e)return this;for(var r,i,n,a=this.data,s=this.toBBox(e),l=[],u=[];a||l.length;){if(a||(a=l.pop(),i=l[l.length-1],r=u.pop(),n=!0),a.leaf){var c=o(e,a.children,t);if(-1!==c)return a.children.splice(c,1),l.push(a),this._condense(l),this}n||a.leaf||!h(a,s)?i?(r++,a=i.children[r],n=!1):a=null:(l.push(a),u.push(r),r=0,i=a,a=a.children[0])}return this},i.prototype.toBBox=function(e){return e},i.prototype.compareMinX=function(e,t){return e.minX-t.minX},i.prototype.compareMinY=function(e,t){return e.minY-t.minY},i.prototype.toJSON=function(){return this.data},i.prototype.fromJSON=function(e){return this.data=e,this},i.prototype._all=function(e,t){for(var r=[];e;)e.leaf?t.push.apply(t,e.children):r.push.apply(r,e.children),e=r.pop();return t},i.prototype._build=function(e,t,r,i){var o,a=r-t+1,s=this._maxEntries;if(a<=s)return n(o=g(e.slice(t,r+1)),this.toBBox),o;i||(i=Math.ceil(Math.log(a)/Math.log(s)),s=Math.ceil(a/Math.pow(s,i-1))),(o=g([])).leaf=!1,o.height=i;var l=Math.ceil(a/s),u=l*Math.ceil(Math.sqrt(s));p(e,t,r,u,this.compareMinX);for(var c=t;c<=r;c+=u){var d=Math.min(c+u-1,r);p(e,c,d,l,this.compareMinY);for(var h=c;h<=d;h+=l){var f=Math.min(h+l-1,d);o.children.push(this._build(e,h,f,i-1))}}return n(o,this.toBBox),o},i.prototype._chooseSubtree=function(e,t,r,i){for(;i.push(t),!t.leaf&&i.length-1!==r;){for(var o=1/0,n=1/0,a=void 0,s=0;s<t.children.length;s++){var l=t.children[s],u=c(l),d=(h=e,f=l,(Math.max(f.maxX,h.maxX)-Math.min(f.minX,h.minX))*(Math.max(f.maxY,h.maxY)-Math.min(f.minY,h.minY))-u);d<n?(n=d,o=u<o?u:o,a=l):d===n&&u<o&&(o=u,a=l)}t=a||t.children[0]}var h,f;return t},i.prototype._insert=function(e,t,r){var i=r?e:this.toBBox(e),o=[],n=this._chooseSubtree(i,this.data,t,o);for(n.children.push(e),s(n,i);t>=0&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(i,o,t)},i.prototype._split=function(e,t){var r=e[t],i=r.children.length,o=this._minEntries;this._chooseSplitAxis(r,o,i);var a=this._chooseSplitIndex(r,o,i),s=g(r.children.splice(a,r.children.length-a));s.height=r.height,s.leaf=r.leaf,n(r,this.toBBox),n(s,this.toBBox),t?e[t-1].children.push(s):this._splitRoot(r,s)},i.prototype._splitRoot=function(e,t){this.data=g([e,t]),this.data.height=e.height+1,this.data.leaf=!1,n(this.data,this.toBBox)},i.prototype._chooseSplitIndex=function(e,t,r){for(var i,o,n,s,l,u,d,h=1/0,f=1/0,g=t;g<=r-t;g++){var p=a(e,0,g,this.toBBox),m=a(e,g,r,this.toBBox),v=(o=p,n=m,s=void 0,l=void 0,u=void 0,d=void 0,s=Math.max(o.minX,n.minX),l=Math.max(o.minY,n.minY),u=Math.min(o.maxX,n.maxX),d=Math.min(o.maxY,n.maxY),Math.max(0,u-s)*Math.max(0,d-l)),x=c(p)+c(m);v<h?(h=v,i=g,f=x<f?x:f):v===h&&x<f&&(f=x,i=g)}return i||r-t},i.prototype._chooseSplitAxis=function(e,t,r){var i=e.leaf?this.compareMinX:l,o=e.leaf?this.compareMinY:u;this._allDistMargin(e,t,r,i)<this._allDistMargin(e,t,r,o)&&e.children.sort(i)},i.prototype._allDistMargin=function(e,t,r,i){e.children.sort(i);for(var o=this.toBBox,n=a(e,0,t,o),l=a(e,r-t,r,o),u=d(n)+d(l),c=t;c<r-t;c++){var h=e.children[c];s(n,e.leaf?o(h):h),u+=d(n)}for(var f=r-t-1;f>=t;f--){var g=e.children[f];s(l,e.leaf?o(g):g),u+=d(l)}return u},i.prototype._adjustParentBBoxes=function(e,t,r){for(var i=r;i>=0;i--)s(t[i],e)},i.prototype._condense=function(e){for(var t=e.length-1,r=void 0;t>=0;t--)0===e[t].children.length?t>0?(r=e[t-1].children).splice(r.indexOf(e[t]),1):this.clear():n(e[t],this.toBBox)},i}()},15:function(e,t){var r=null,i=null;function o(e,t,r){e.addEventListener(t,function(e){var o=new MouseEvent(r,e);o.pointerId=1,o.isPrimary=!0,o.pointerType="mouse",o.width=1,o.height=1,o.tiltX=0,o.tiltY=0,"buttons"in e&&0!==e.buttons?o.pressure=.5:o.pressure=0;var n=e.target;null!==i&&(n=i,"mouseup"===t&&(i=null)),n.dispatchEvent(o),o.defaultPrevented&&e.preventDefault()})}function n(e,t,i){e.addEventListener(t,function(e){for(var o=e.changedTouches,n=o.length,a=0;a<n;a++){var s=new CustomEvent(i,{bubbles:!0,cancelable:!0});s.ctrlKey=e.ctrlKey,s.shiftKey=e.shiftKey,s.altKey=e.altKey,s.metaKey=e.metaKey;var l=o.item(a);s.clientX=l.clientX,s.clientY=l.clientY,s.screenX=l.screenX,s.screenY=l.screenY,s.pageX=l.pageX,s.pageY=l.pageY;var u=l.target.getBoundingClientRect();s.offsetX=l.clientX-u.left,s.offsetY=l.clientY-u.top,s.pointerId=1+l.identifier,s.button=0,s.buttons=1,s.movementX=0,s.movementY=0,s.region=null,s.relatedTarget=null,s.x=s.clientX,s.y=s.clientY,s.pointerType="touch",s.width=1,s.height=1,s.tiltX=0,s.tiltY=0,s.pressure=1,"touchstart"===t&&null===r&&(r=l.identifier),s.isPrimary=l.identifier===r,"touchend"===t&&s.isPrimary&&(r=null),e.target.dispatchEvent(s),s.defaultPrevented&&e.preventDefault()}})}"PointerEvent"in window||(Element.prototype.setPointerCapture=Element.prototype.setCapture,Element.prototype.releasePointerCapture=Element.prototype.releaseCapture,"TouchEvent"in window||(o(document,"mousedown","pointerdown"),o(document,"mousemove","pointermove"),o(document,"mouseup","pointerup")),n(document,"touchstart","pointerdown"),n(document,"touchmove","pointermove"),n(document,"touchend","pointerup"))},16:function(e,t,r){function i(){return function(){throw new Error("Unimplemented abstract method.")}()}r.r(t),r.d(t,"OlMago3d",function(){return Ju});var o=0;function n(e){return e.ol_uid||(e.ol_uid=String(++o))}var a,s=(a=function(e,t){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),l=function(e){function t(t){var r=this,i="Assertion failed. See https://openlayers.org/en/v"+"6.3.1".split("-")[0]+"/doc/errors/#"+t+" for details.";return(r=e.call(this,i)||this).code=t,r.name="AssertionError",r.message=i,r}return s(t,e),t}(Error),u="add",c="remove",d="propertychange",h="function"==typeof Object.assign?Object.assign:function(e,t){if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var r=Object(e),i=1,o=arguments.length;i<o;++i){var n=arguments[i];if(null!=n)for(var a in n)n.hasOwnProperty(a)&&(r[a]=n[a])}return r};function f(e){for(var t in e)delete e[t]}var g="function"==typeof Object.values?Object.values:function(e){var t=[];for(var r in e)t.push(e[r]);return t};function p(e){var t;for(t in e)return!1;return!t}function m(e,t,r,i,o){if(i&&i!==e&&(r=r.bind(i)),o){var n=r;r=function(){e.removeEventListener(t,r),n.apply(this,arguments)}}var a={target:e,type:t,listener:r};return e.addEventListener(t,r),a}function v(e,t,r,i){return m(e,t,r,i,!0)}function x(e){e&&e.target&&(e.target.removeEventListener(e.type,e.listener),f(e))}var _=function(){function e(){this.disposed_=!1}return e.prototype.dispose=function(){this.disposed_||(this.disposed_=!0,this.disposeInternal())},e.prototype.disposeInternal=function(){},e}();function y(e,t){return e>t?1:e<t?-1:0}function T(e,t,r){var i=e.length;if(e[0]<=t)return 0;if(t<=e[i-1])return i-1;var o=void 0;if(r>0){for(o=1;o<i;++o)if(e[o]<t)return o-1}else if(r<0){for(o=1;o<i;++o)if(e[o]<=t)return o}else for(o=1;o<i;++o){if(e[o]==t)return o;if(e[o]<t)return e[o-1]-t<t-e[o]?o-1:o}return i-1}function C(e,t,r){for(;t<r;){var i=e[t];e[t]=e[r],e[r]=i,++t,--r}}function b(e,t){for(var r=Array.isArray(t)?t:[t],i=r.length,o=0;o<i;o++)e[e.length]=r[o]}function M(e,t){var r=e.length;if(r!==t.length)return!1;for(var i=0;i<r;i++)if(e[i]!==t[i])return!1;return!0}function A(){return!0}function E(){return!1}function L(){}var w,S,D,R=function(){function e(e){this.propagationStopped,this.type=e,this.target=null}return e.prototype.preventDefault=function(){this.propagationStopped=!0},e.prototype.stopPropagation=function(){this.propagationStopped=!0},e}(),P=(S=function(e,t){return(S=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}S(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),I=function(e){function t(t){var r=e.call(this)||this;return r.eventTarget_=t,r.pendingRemovals_={},r.dispatching_={},r.listeners_={},r}return P(t,e),t.prototype.addEventListener=function(e,t){if(e&&t){var r=this.listeners_[e];r||(r=[],this.listeners_[e]=r),-1===r.indexOf(t)&&r.push(t)}},t.prototype.dispatchEvent=function(e){var t="string"==typeof e?new R(e):e,r=t.type;t.target||(t.target=this.eventTarget_||this);var i,o=this.listeners_[r];if(o){r in this.dispatching_||(this.dispatching_[r]=0,this.pendingRemovals_[r]=0),++this.dispatching_[r];for(var n=0,a=o.length;n<a;++n)if(!1===(i="handleEvent"in o[n]?o[n].handleEvent(t):o[n].call(this,t))||t.propagationStopped){i=!1;break}if(--this.dispatching_[r],0===this.dispatching_[r]){var s=this.pendingRemovals_[r];for(delete this.pendingRemovals_[r];s--;)this.removeEventListener(r,L);delete this.dispatching_[r]}return i}},t.prototype.disposeInternal=function(){f(this.listeners_)},t.prototype.getListeners=function(e){return this.listeners_[e]},t.prototype.hasListener=function(e){return e?e in this.listeners_:Object.keys(this.listeners_).length>0},t.prototype.removeEventListener=function(e,t){var r=this.listeners_[e];if(r){var i=r.indexOf(t);-1!==i&&(e in this.pendingRemovals_?(r[i]=L,++this.pendingRemovals_[e]):(r.splice(i,1),0===r.length&&delete this.listeners_[e]))}},t}(_),F="change",O="error",B="contextmenu",N="click",U="keydown",G="keypress",z="load",V="resize",k="touchmove",j="wheel",W=(w=function(e,t){return(w=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}w(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),X=function(e){function t(){var t=e.call(this)||this;return t.revision_=0,t}return W(t,e),t.prototype.changed=function(){++this.revision_,this.dispatchEvent(F)},t.prototype.getRevision=function(){return this.revision_},t.prototype.on=function(e,t){if(Array.isArray(e)){for(var r=e.length,i=new Array(r),o=0;o<r;++o)i[o]=m(this,e[o],t);return i}return m(this,e,t)},t.prototype.once=function(e,t){if(Array.isArray(e)){for(var r=e.length,i=new Array(r),o=0;o<r;++o)i[o]=v(this,e[o],t);return i}return v(this,e,t)},t.prototype.un=function(e,t){if(Array.isArray(e))for(var r=0,i=e.length;r<i;++r)this.removeEventListener(e[r],t);else this.removeEventListener(e,t)},t}(I),Y=(D=function(e,t){return(D=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}D(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),q=function(e){function t(t,r,i){var o=e.call(this,t)||this;return o.key=r,o.oldValue=i,o}return Y(t,e),t}(R),K={};function Z(e){return K.hasOwnProperty(e)?K[e]:K[e]="change:"+e}var J,Q,$,ee,te,re=function(e){function t(t){var r=e.call(this)||this;return n(r),r.values_={},void 0!==t&&r.setProperties(t),r}return Y(t,e),t.prototype.get=function(e){var t;return this.values_.hasOwnProperty(e)&&(t=this.values_[e]),t},t.prototype.getKeys=function(){return Object.keys(this.values_)},t.prototype.getProperties=function(){return h({},this.values_)},t.prototype.notify=function(e,t){var r;r=Z(e),this.dispatchEvent(new q(r,e,t)),r=d,this.dispatchEvent(new q(r,e,t))},t.prototype.set=function(e,t,r){if(r)this.values_[e]=t;else{var i=this.values_[e];this.values_[e]=t,i!==t&&this.notify(e,i)}},t.prototype.setProperties=function(e,t){for(var r in e)this.set(r,e[r],t)},t.prototype.unset=function(e,t){if(e in this.values_){var r=this.values_[e];delete this.values_[e],t||this.notify(e,r)}},t}(X),ie=(te=function(e,t){return(te=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}te(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),oe="length",ne=function(e){function t(t,r,i){var o=e.call(this,t)||this;return o.element=r,o.index=i,o}return ie(t,e),t}(R),ae=function(e){function t(t,r){var i=e.call(this)||this,o=r||{};if(i.unique_=!!o.unique,i.array_=t||[],i.unique_)for(var n=0,a=i.array_.length;n<a;++n)i.assertUnique_(i.array_[n],n);return i.updateLength_(),i}return ie(t,e),t.prototype.clear=function(){for(;this.getLength()>0;)this.pop()},t.prototype.extend=function(e){for(var t=0,r=e.length;t<r;++t)this.push(e[t]);return this},t.prototype.forEach=function(e){for(var t=this.array_,r=0,i=t.length;r<i;++r)e(t[r],r,t)},t.prototype.getArray=function(){return this.array_},t.prototype.item=function(e){return this.array_[e]},t.prototype.getLength=function(){return this.get(oe)},t.prototype.insertAt=function(e,t){this.unique_&&this.assertUnique_(t),this.array_.splice(e,0,t),this.updateLength_(),this.dispatchEvent(new ne(u,t,e))},t.prototype.pop=function(){return this.removeAt(this.getLength()-1)},t.prototype.push=function(e){this.unique_&&this.assertUnique_(e);var t=this.getLength();return this.insertAt(t,e),this.getLength()},t.prototype.remove=function(e){for(var t=this.array_,r=0,i=t.length;r<i;++r)if(t[r]===e)return this.removeAt(r)},t.prototype.removeAt=function(e){var t=this.array_[e];return this.array_.splice(e,1),this.updateLength_(),this.dispatchEvent(new ne(c,t,e)),t},t.prototype.setAt=function(e,t){var r=this.getLength();if(e<r){this.unique_&&this.assertUnique_(t,e);var i=this.array_[e];this.array_[e]=t,this.dispatchEvent(new ne(c,i,e)),this.dispatchEvent(new ne(u,t,e))}else{for(var o=r;o<e;++o)this.insertAt(o,void 0);this.insertAt(e,t)}},t.prototype.updateLength_=function(){this.set(oe,this.array_.length)},t.prototype.assertUnique_=function(e,t){for(var r=0,i=this.array_.length;r<i;++r)if(this.array_[r]===e&&r!==t)throw new l(58)},t}(re),se=(ee=function(e,t){return(ee=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}ee(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),le=function(e){function t(t,r,i){var o=e.call(this,t)||this;return o.map=r,o.frameState=void 0!==i?i:null,o}return se(t,e),t}(R),ue=($=function(e,t){return($=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}$(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),ce=function(e){function t(t,r,i,o,n){var a=e.call(this,t,r,n)||this;return a.originalEvent=i,a.pixel_=null,a.coordinate_=null,a.dragging=void 0!==o&&o,a}return ue(t,e),Object.defineProperty(t.prototype,"pixel",{get:function(){return this.pixel_||(this.pixel_=this.map.getEventPixel(this.originalEvent)),this.pixel_},set:function(e){this.pixel_=e},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"coordinate",{get:function(){return this.coordinate_||(this.coordinate_=this.map.getCoordinateFromPixel(this.pixel)),this.coordinate_},set:function(e){this.coordinate_=e},enumerable:!0,configurable:!0}),t.prototype.preventDefault=function(){e.prototype.preventDefault.call(this),this.originalEvent.preventDefault()},t.prototype.stopPropagation=function(){e.prototype.stopPropagation.call(this),this.originalEvent.stopPropagation()},t}(le),de=(r(15),"undefined"!=typeof navigator?navigator.userAgent.toLowerCase():""),he=-1!==de.indexOf("firefox"),fe=(-1!==de.indexOf("safari")&&de.indexOf("chrom"),-1!==de.indexOf("webkit")&&-1==de.indexOf("edge")),ge=-1!==de.indexOf("macintosh"),pe="undefined"!=typeof devicePixelRatio?devicePixelRatio:1,me="undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof OffscreenCanvas&&self instanceof WorkerGlobalScope,ve="undefined"!=typeof Image&&Image.prototype.decode,xe=function(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("_",null,t),window.removeEventListener("_",null,t)}catch(e){}return e}(),_e={SINGLECLICK:"singleclick",CLICK:N,DBLCLICK:"dblclick",POINTERDRAG:"pointerdrag",POINTERMOVE:"pointermove",POINTERDOWN:"pointerdown",POINTERUP:"pointerup",POINTEROVER:"pointerover",POINTEROUT:"pointerout",POINTERENTER:"pointerenter",POINTERLEAVE:"pointerleave",POINTERCANCEL:"pointercancel"},ye=(Q=function(e,t){return(Q=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Q(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Te=function(e){function t(t,r,i,o,n){var a=e.call(this,t,r,i,o,n)||this;return a.pointerEvent=i,a}return ye(t,e),t}(ce),Ce="pointermove",be="pointerdown",Me=(J=function(e,t){return(J=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}J(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Ae=function(e){function t(t,r){var i=e.call(this,t)||this;i.map_=t,i.clickTimeoutId_,i.dragging_=!1,i.dragListenerKeys_=[],i.moveTolerance_=r?r*pe:pe,i.down_=null;var o=i.map_.getViewport();return i.activePointers_=0,i.trackedTouches_={},i.element_=o,i.pointerdownListenerKey_=m(o,be,i.handlePointerDown_,i),i.originalPointerMoveEvent_,i.relayedListenerKey_=m(o,Ce,i.relayEvent_,i),i.boundHandleTouchMove_=i.handleTouchMove_.bind(i),i.element_.addEventListener(k,i.boundHandleTouchMove_,!!xe&&{passive:!1}),i}return Me(t,e),t.prototype.emulateClick_=function(e){var t=new Te(_e.CLICK,this.map_,e);this.dispatchEvent(t),void 0!==this.clickTimeoutId_?(clearTimeout(this.clickTimeoutId_),this.clickTimeoutId_=void 0,t=new Te(_e.DBLCLICK,this.map_,e),this.dispatchEvent(t)):this.clickTimeoutId_=setTimeout(function(){this.clickTimeoutId_=void 0;var t=new Te(_e.SINGLECLICK,this.map_,e);this.dispatchEvent(t)}.bind(this),250)},t.prototype.updateActivePointers_=function(e){var t=e;t.type==_e.POINTERUP||t.type==_e.POINTERCANCEL?delete this.trackedTouches_[t.pointerId]:t.type==_e.POINTERDOWN&&(this.trackedTouches_[t.pointerId]=!0),this.activePointers_=Object.keys(this.trackedTouches_).length},t.prototype.handlePointerUp_=function(e){this.updateActivePointers_(e);var t=new Te(_e.POINTERUP,this.map_,e);this.dispatchEvent(t),t.propagationStopped||this.dragging_||!this.isMouseActionButton_(e)||this.emulateClick_(this.down_),0===this.activePointers_&&(this.dragListenerKeys_.forEach(x),this.dragListenerKeys_.length=0,this.dragging_=!1,this.down_=null)},t.prototype.isMouseActionButton_=function(e){return 0===e.button},t.prototype.handlePointerDown_=function(e){this.updateActivePointers_(e);var t=new Te(_e.POINTERDOWN,this.map_,e);this.dispatchEvent(t),this.down_=e,0===this.dragListenerKeys_.length&&this.dragListenerKeys_.push(m(document,_e.POINTERMOVE,this.handlePointerMove_,this),m(document,_e.POINTERUP,this.handlePointerUp_,this),m(this.element_,_e.POINTERCANCEL,this.handlePointerUp_,this))},t.prototype.handlePointerMove_=function(e){if(this.isMoving_(e)){this.dragging_=!0;var t=new Te(_e.POINTERDRAG,this.map_,e,this.dragging_);this.dispatchEvent(t)}},t.prototype.relayEvent_=function(e){this.originalPointerMoveEvent_=e;var t=!(!this.down_||!this.isMoving_(e));this.dispatchEvent(new Te(e.type,this.map_,e,t))},t.prototype.handleTouchMove_=function(e){this.originalPointerMoveEvent_&&!this.originalPointerMoveEvent_.defaultPrevented||e.preventDefault()},t.prototype.isMoving_=function(e){return this.dragging_||Math.abs(e.clientX-this.down_.clientX)>this.moveTolerance_||Math.abs(e.clientY-this.down_.clientY)>this.moveTolerance_},t.prototype.disposeInternal=function(){this.relayedListenerKey_&&(x(this.relayedListenerKey_),this.relayedListenerKey_=null),this.element_.removeEventListener(k,this.boundHandleTouchMove_),this.pointerdownListenerKey_&&(x(this.pointerdownListenerKey_),this.pointerdownListenerKey_=null),this.dragListenerKeys_.forEach(x),this.dragListenerKeys_.length=0,this.element_=null,e.prototype.disposeInternal.call(this)},t}(I),Ee="postrender",Le="layergroup",we="size",Se="target",De="view",Re="precompose",Pe="rendercomplete",Ie=0,Fe=4;function Oe(e,t){if(!e)throw new l(t)}var Be,Ne=function(){function e(e,t){this.priorityFunction_=e,this.keyFunction_=t,this.elements_=[],this.priorities_=[],this.queuedElements_={}}return e.prototype.clear=function(){this.elements_.length=0,this.priorities_.length=0,f(this.queuedElements_)},e.prototype.dequeue=function(){var e=this.elements_,t=this.priorities_,r=e[0];1==e.length?(e.length=0,t.length=0):(e[0]=e.pop(),t[0]=t.pop(),this.siftUp_(0));var i=this.keyFunction_(r);return delete this.queuedElements_[i],r},e.prototype.enqueue=function(e){Oe(!(this.keyFunction_(e)in this.queuedElements_),31);var t=this.priorityFunction_(e);return t!=1/0&&(this.elements_.push(e),this.priorities_.push(t),this.queuedElements_[this.keyFunction_(e)]=!0,this.siftDown_(0,this.elements_.length-1),!0)},e.prototype.getCount=function(){return this.elements_.length},e.prototype.getLeftChildIndex_=function(e){return 2*e+1},e.prototype.getRightChildIndex_=function(e){return 2*e+2},e.prototype.getParentIndex_=function(e){return e-1>>1},e.prototype.heapify_=function(){var e;for(e=(this.elements_.length>>1)-1;e>=0;e--)this.siftUp_(e)},e.prototype.isEmpty=function(){return 0===this.elements_.length},e.prototype.isKeyQueued=function(e){return e in this.queuedElements_},e.prototype.isQueued=function(e){return this.isKeyQueued(this.keyFunction_(e))},e.prototype.siftUp_=function(e){for(var t=this.elements_,r=this.priorities_,i=t.length,o=t[e],n=r[e],a=e;e<i>>1;){var s=this.getLeftChildIndex_(e),l=this.getRightChildIndex_(e),u=l<i&&r[l]<r[s]?l:s;t[e]=t[u],r[e]=r[u],e=u}t[e]=o,r[e]=n,this.siftDown_(a,e)},e.prototype.siftDown_=function(e,t){for(var r=this.elements_,i=this.priorities_,o=r[t],n=i[t];t>e;){var a=this.getParentIndex_(t);if(!(i[a]>n))break;r[t]=r[a],i[t]=i[a],t=a}r[t]=o,i[t]=n},e.prototype.reprioritize=function(){var e,t,r,i=this.priorityFunction_,o=this.elements_,n=this.priorities_,a=0,s=o.length;for(t=0;t<s;++t)(r=i(e=o[t]))==1/0?delete this.queuedElements_[this.keyFunction_(e)]:(n[a]=r,o[a++]=e);o.length=a,n.length=a,this.heapify_()},e}(),Ue=(Be=function(e,t){return(Be=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Be(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Ge=function(e){function t(t,r){var i=e.call(this,function(e){return t.apply(null,e)},function(e){return e[0].getKey()})||this;return i.boundHandleTileChange_=i.handleTileChange.bind(i),i.tileChangeCallback_=r,i.tilesLoading_=0,i.tilesLoadingKeys_={},i}return Ue(t,e),t.prototype.enqueue=function(t){var r=e.prototype.enqueue.call(this,t);return r&&t[0].addEventListener(F,this.boundHandleTileChange_),r},t.prototype.getTilesLoading=function(){return this.tilesLoading_},t.prototype.handleTileChange=function(e){var t=e.target,r=t.getState();if(t.hifi&&2===r||3===r||r===Fe){t.removeEventListener(F,this.boundHandleTileChange_);var i=t.getKey();i in this.tilesLoadingKeys_&&(delete this.tilesLoadingKeys_[i],--this.tilesLoading_),this.tileChangeCallback_()}},t.prototype.loadMoreTiles=function(e,t){for(var r,i,o=0;this.tilesLoading_<e&&o<t&&this.getCount()>0;)i=(r=this.dequeue()[0]).getKey(),r.getState()!==Ie||i in this.tilesLoadingKeys_||(this.tilesLoadingKeys_[i]=!0,++this.tilesLoading_,++o,r.load())},t}(Ne);function ze(e,t,r){return Math.min(Math.max(e,t),r)}var He="cosh"in Math?Math.cosh:function(e){var t=Math.exp(e);return(t+1/t)/2};function Ve(e,t,r,i,o,n){var a=o-r,s=n-i;if(0!==a||0!==s){var l=((e-r)*a+(t-i)*s)/(a*a+s*s);l>1?(r=o,i=n):l>0&&(r+=a*l,i+=s*l)}return ke(e,t,r,i)}function ke(e,t,r,i){var o=r-e,n=i-t;return o*o+n*n}function je(e){return e*Math.PI/180}function We(e,t){var r=e%t;return r*t<0?r+t:r}function Xe(e,t,r){return e+r*(t-e)}function Ye(e,t,r){return function(i,o,n,a){if(i){var s=t?0:n[0]*o,l=t?0:n[1]*o,u=e[0]+s/2,c=e[2]-s/2,d=e[1]+l/2,h=e[3]-l/2;u>c&&(c=u=(c+u)/2),d>h&&(h=d=(h+d)/2);var f=ze(i[0],u,c),g=ze(i[1],d,h),p=30*o;return a&&r&&(f+=-p*Math.log(1+Math.max(0,u-i[0])/p)+p*Math.log(1+Math.max(0,i[0]-c)/p),g+=-p*Math.log(1+Math.max(0,d-i[1])/p)+p*Math.log(1+Math.max(0,i[1]-h)/p)),[f,g]}}}function qe(e){return e}var Ke="bottom-left",Ze="bottom-right",Je="top-left",Qe="top-right",$e=0,et=1,tt=2,rt=4,it=8,ot=16;function nt(e){for(var t=[1/0,1/0,-1/0,-1/0],r=0,i=e.length;r<i;++r)vt(t,e[r]);return t}function at(e,t,r){return r?(r[0]=e[0]-t,r[1]=e[1]-t,r[2]=e[2]+t,r[3]=e[3]+t,r):[e[0]-t,e[1]-t,e[2]+t,e[3]+t]}function st(e,t){return t?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t):e.slice()}function lt(e,t,r){var i,o;return(i=t<e[0]?e[0]-t:e[2]<t?t-e[2]:0)*i+(o=r<e[1]?e[1]-r:e[3]<r?r-e[3]:0)*o}function ut(e,t){return dt(e,t[0],t[1])}function ct(e,t){return e[0]<=t[0]&&t[2]<=e[2]&&e[1]<=t[1]&&t[3]<=e[3]}function dt(e,t,r){return e[0]<=t&&t<=e[2]&&e[1]<=r&&r<=e[3]}function ht(e,t){var r=e[0],i=e[1],o=e[2],n=e[3],a=t[0],s=t[1],l=$e;return a<r?l|=ot:a>o&&(l|=rt),s<i?l|=it:s>n&&(l|=tt),l===$e&&(l=et),l}function ft(e,t,r,i,o){return o?(o[0]=e,o[1]=t,o[2]=r,o[3]=i,o):[e,t,r,i]}function gt(e){return ft(1/0,1/0,-1/0,-1/0,e)}function pt(e,t){return e[0]==t[0]&&e[2]==t[2]&&e[1]==t[1]&&e[3]==t[3]}function mt(e,t){return t[0]<e[0]&&(e[0]=t[0]),t[2]>e[2]&&(e[2]=t[2]),t[1]<e[1]&&(e[1]=t[1]),t[3]>e[3]&&(e[3]=t[3]),e}function vt(e,t){t[0]<e[0]&&(e[0]=t[0]),t[0]>e[2]&&(e[2]=t[0]),t[1]<e[1]&&(e[1]=t[1]),t[1]>e[3]&&(e[3]=t[1])}function xt(e,t,r,i,o){for(;r<i;r+=o)_t(e,t[r],t[r+1]);return e}function _t(e,t,r){e[0]=Math.min(e[0],t),e[1]=Math.min(e[1],r),e[2]=Math.max(e[2],t),e[3]=Math.max(e[3],r)}function yt(e){var t=0;return Rt(e)||(t=St(e)*At(e)),t}function Tt(e){return[e[0],e[1]]}function Ct(e){return[e[2],e[1]]}function bt(e){return[(e[0]+e[2])/2,(e[1]+e[3])/2]}function Mt(e,t,r,i,o){var n=t*i[0]/2,a=t*i[1]/2,s=Math.cos(r),l=Math.sin(r),u=n*s,c=n*l,d=a*s,h=a*l,f=e[0],g=e[1],p=f-u+h,m=f-u-h,v=f+u-h,x=f+u+h,_=g-c-d,y=g-c+d,T=g+c+d,C=g+c-d;return ft(Math.min(p,m,v,x),Math.min(_,y,T,C),Math.max(p,m,v,x),Math.max(_,y,T,C),o)}function At(e){return e[3]-e[1]}function Et(e,t,r){var i=r||[1/0,1/0,-1/0,-1/0];return Dt(e,t)?(e[0]>t[0]?i[0]=e[0]:i[0]=t[0],e[1]>t[1]?i[1]=e[1]:i[1]=t[1],e[2]<t[2]?i[2]=e[2]:i[2]=t[2],e[3]<t[3]?i[3]=e[3]:i[3]=t[3]):gt(i),i}function Lt(e){return[e[0],e[3]]}function wt(e){return[e[2],e[3]]}function St(e){return e[2]-e[0]}function Dt(e,t){return e[0]<=t[2]&&e[2]>=t[0]&&e[1]<=t[3]&&e[3]>=t[1]}function Rt(e){return e[2]<e[0]||e[3]<e[1]}function Pt(e,t,r,i){var o=St(t)/r[0],n=At(t)/r[1];return i?Math.min(e,Math.max(o,n)):Math.min(e,Math.min(o,n))}function It(e,t,r){var i=Math.min(e,t);return i*=Math.log(1+50*Math.max(0,e/t-1))/50+1,r&&(i=Math.max(i,r),i/=Math.log(1+50*Math.max(0,r/e-1))/50+1),ze(i,r/2,2*t)}function Ft(e,t,r,i,o){return function(n,a,s,l){if(void 0!==n){var u=i?Pt(e,i,s,o):e;return(void 0===r||r)&&l?It(n,u,t):ze(n,t,u)}}}function Ot(e){return void 0!==e?0:void 0}function Bt(e){return void 0!==e?e:void 0}var Nt="center",Ut="resolution",Gt="rotation";function zt(e,t){for(var r=!0,i=e.length-1;i>=0;--i)if(e[i]!=t[i]){r=!1;break}return r}function Ht(e,t){var r=Math.cos(t),i=Math.sin(t),o=e[0]*r-e[1]*i,n=e[1]*r+e[0]*i;return e[0]=o,e[1]=n,e}function Vt(e,t){var r=t.getExtent();if(t.canWrapX()&&(e[0]<r[0]||e[0]>=r[2])){var i=St(r),o=Math.floor((e[0]-r[0])/i);e[0]-=o*i}return e}function kt(e){return Math.pow(e,3)}function jt(e){return 1-kt(1-e)}function Wt(e){return 3*e*e-2*e*e*e}function Xt(e){return e}var Yt="Point",qt="LineString",Kt="Polygon",Zt="MultiPoint",Jt="MultiLineString",Qt="MultiPolygon",$t="GeometryCollection",er="Circle",tr="XY",rr="XYZ",ir="XYM",or="XYZM";function nr(e,t,r,i,o,n){for(var a=n||[],s=0,l=t;l<r;l+=i){var u=e[l],c=e[l+1];a[s++]=o[0]*u+o[2]*c+o[4],a[s++]=o[1]*u+o[3]*c+o[5]}return n&&a.length!=s&&(a.length=s),a}function ar(e,t,r){var i=r||6371008.8,o=je(e[1]),n=je(t[1]),a=(n-o)/2,s=je(t[0]-e[0])/2,l=Math.sin(a)*Math.sin(a)+Math.sin(s)*Math.sin(s)*Math.cos(o)*Math.cos(n);return 2*i*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))}var sr={DEGREES:"degrees",FEET:"ft",METERS:"m",PIXELS:"pixels",TILE_PIXELS:"tile-pixels",USFEET:"us-ft"},lr={};lr[sr.DEGREES]=2*Math.PI*6370997/360,lr[sr.FEET]=.3048,lr[sr.METERS]=1,lr[sr.USFEET]=1200/3937;var ur,cr=sr,dr=function(){function e(e){this.code_=e.code,this.units_=e.units,this.extent_=void 0!==e.extent?e.extent:null,this.worldExtent_=void 0!==e.worldExtent?e.worldExtent:null,this.axisOrientation_=void 0!==e.axisOrientation?e.axisOrientation:"enu",this.global_=void 0!==e.global&&e.global,this.canWrapX_=!(!this.global_||!this.extent_),this.getPointResolutionFunc_=e.getPointResolution,this.defaultTileGrid_=null,this.metersPerUnit_=e.metersPerUnit}return e.prototype.canWrapX=function(){return this.canWrapX_},e.prototype.getCode=function(){return this.code_},e.prototype.getExtent=function(){return this.extent_},e.prototype.getUnits=function(){return this.units_},e.prototype.getMetersPerUnit=function(){return this.metersPerUnit_||lr[this.units_]},e.prototype.getWorldExtent=function(){return this.worldExtent_},e.prototype.getAxisOrientation=function(){return this.axisOrientation_},e.prototype.isGlobal=function(){return this.global_},e.prototype.setGlobal=function(e){this.global_=e,this.canWrapX_=!(!e||!this.extent_)},e.prototype.getDefaultTileGrid=function(){return this.defaultTileGrid_},e.prototype.setDefaultTileGrid=function(e){this.defaultTileGrid_=e},e.prototype.setExtent=function(e){this.extent_=e,this.canWrapX_=!(!this.global_||!e)},e.prototype.setWorldExtent=function(e){this.worldExtent_=e},e.prototype.setGetPointResolution=function(e){this.getPointResolutionFunc_=e},e.prototype.getPointResolutionFunc=function(){return this.getPointResolutionFunc_},e}(),hr=(ur=function(e,t){return(ur=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}ur(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),fr=6378137*Math.PI,gr=[-fr,-fr,fr,fr],pr=[-180,-85,180,85],mr=function(e){function t(t){return e.call(this,{code:t,units:cr.METERS,extent:gr,global:!0,worldExtent:pr,getPointResolution:function(e,t){return e/He(t[1]/6378137)}})||this}return hr(t,e),t}(dr),vr=[new mr("EPSG:3857"),new mr("EPSG:102100"),new mr("EPSG:102113"),new mr("EPSG:900913"),new mr("urn:ogc:def:crs:EPSG:6.18:3:3857"),new mr("urn:ogc:def:crs:EPSG::3857"),new mr("http://www.opengis.net/gml/srs/epsg.xml#3857")];var xr,_r=(xr=function(e,t){return(xr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}xr(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),yr=[-180,-90,180,90],Tr=6378137*Math.PI/180,Cr=function(e){function t(t,r){return e.call(this,{code:t,units:cr.DEGREES,extent:yr,axisOrientation:r,global:!0,metersPerUnit:Tr,worldExtent:yr})||this}return _r(t,e),t}(dr),br=[new Cr("CRS:84"),new Cr("EPSG:4326","neu"),new Cr("urn:ogc:def:crs:EPSG::4326","neu"),new Cr("urn:ogc:def:crs:EPSG:6.6:4326","neu"),new Cr("urn:ogc:def:crs:OGC:1.3:CRS84"),new Cr("urn:ogc:def:crs:OGC:2:84"),new Cr("http://www.opengis.net/gml/srs/epsg.xml#4326","neu"),new Cr("urn:x-ogc:def:crs:EPSG:4326","neu")],Mr={};function Ar(e,t,r){var i=e.getCode(),o=t.getCode();i in Mr||(Mr[i]={}),Mr[i][o]=r}var Er={};function Lr(e,t,r){var i;if(void 0!==t){for(var o=0,n=e.length;o<n;++o)t[o]=e[o];i=t}else i=e.slice();return i}function wr(e,t,r){if(void 0!==t&&e!==t){for(var i=0,o=e.length;i<o;++i)t[i]=e[i];e=t}return e}function Sr(e){!function(e,t){Er[e]=t}(e.getCode(),e),Ar(e,e,Lr)}function Dr(e){return"string"==typeof e?Er[e]||null:e||null}function Rr(e,t,r,i){var o,n=(e=Dr(e)).getPointResolutionFunc();if(n)o=n(t,r),i&&i!==e.getUnits()&&(a=e.getMetersPerUnit())&&(o=o*a/lr[i]);else if(e.getUnits()==cr.DEGREES&&!i||i==cr.DEGREES)o=t;else{var a,s=Or(e,Dr("EPSG:4326")),l=[r[0]-t/2,r[1],r[0]+t/2,r[1],r[0],r[1]-t/2,r[0],r[1]+t/2];o=(ar((l=s(l,l,2)).slice(0,2),l.slice(2,4))+ar(l.slice(4,6),l.slice(6,8)))/2,void 0!==(a=i?lr[i]:e.getMetersPerUnit())&&(o/=a)}return o}function Pr(e){!function(e){e.forEach(Sr)}(e),e.forEach(function(t){e.forEach(function(e){t!==e&&Ar(t,e,Lr)})})}function Ir(e,t){return e?"string"==typeof e?Dr(e):e:Dr(t)}function Fr(e,t){if(e===t)return!0;var r=e.getUnits()===t.getUnits();return(e.getCode()===t.getCode()||Or(e,t)===Lr)&&r}function Or(e,t){var r=function(e,t){var r;return e in Mr&&t in Mr[e]&&(r=Mr[e][t]),r}(e.getCode(),t.getCode());return r||(r=wr),r}function Br(e,t){return Or(Dr(e),Dr(t))}function Nr(e,t,r){return Br(t,r)(e,void 0,e.length)}function Ur(e,t,r,i){return function(e,t,r,i){var o=[];if(i>1)for(var n=e[2]-e[0],a=e[3]-e[1],s=0;s<i;++s)o.push(e[0]+n*s/i,e[1],e[2],e[1]+a*s/i,e[2]-n*s/i,e[3],e[0],e[3]-a*s/i);else o=[e[0],e[1],e[2],e[1],e[2],e[3],e[0],e[3]];t(o,o,2);for(var l=[],u=[],c=(s=0,o.length);s<c;s+=2)l.push(o[s]),u.push(o[s+1]);return function(e,t,r){return ft(Math.min.apply(null,e),Math.min.apply(null,t),Math.max.apply(null,e),Math.max.apply(null,t),r)}(l,u,r)}(e,Br(t,r),void 0,i)}var Gr,zr,Hr,Vr=null;function kr(){return Vr}function jr(e,t){return Vr?Nr(e,t,Vr):e}function Wr(e,t){return Vr?Nr(e,Vr,t):e}function Xr(e,t){return Vr?Ur(e,t,Vr):e}function Yr(e,t){return Vr?Ur(e,Vr,t):e}function qr(e,t){var r=t[0],i=t[1];return t[0]=e[0]*r+e[2]*i+e[4],t[1]=e[1]*r+e[3]*i+e[5],t}function Kr(e,t,r,i,o,n,a,s){var l=Math.sin(n),u=Math.cos(n);return e[0]=i*u,e[1]=o*l,e[2]=-i*l,e[3]=o*u,e[4]=a*i*u-s*i*l+t,e[5]=a*o*l+s*o*u+r,e}function Zr(e,t){var r,i=(r=t)[0]*r[3]-r[1]*r[2];Oe(0!==i,32);var o=t[0],n=t[1],a=t[2],s=t[3],l=t[4],u=t[5];return e[0]=s/i,e[1]=-n/i,e[2]=-a/i,e[3]=o/i,e[4]=(a*u-s*l)/i,e[5]=-(o*u-n*l)/i,e}function Jr(e){return"matrix("+e.join(", ")+")"}Pr(vr),Pr(br),Gr=vr,zr=function(e,t,r){var i=e.length,o=r>1?r:2,n=t;void 0===n&&(n=o>2?e.slice():new Array(i));for(var a=fr,s=0;s<i;s+=o){n[s]=a*e[s]/180;var l=6378137*Math.log(Math.tan(Math.PI*(+e[s+1]+90)/360));l>a?l=a:l<-a&&(l=-a),n[s+1]=l}return n},Hr=function(e,t,r){var i=e.length,o=r>1?r:2,n=t;void 0===n&&(n=o>2?e.slice():new Array(i));for(var a=0;a<i;a+=o)n[a]=180*e[a]/fr,n[a+1]=360*Math.atan(Math.exp(e[a+1]/6378137))/Math.PI-90;return n},br.forEach(function(e){Gr.forEach(function(t){Ar(e,t,zr),Ar(t,e,Hr)})}),new Array(6);var Qr,$r,ei=($r=function(e,t){return($r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}$r(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),ti=[1,0,0,1,0,0],ri=function(e){function t(){var t,r,i,o,n,a=e.call(this)||this;return a.extent_=[1/0,1/0,-1/0,-1/0],a.extentRevision_=-1,a.simplifiedGeometryMaxMinSquaredTolerance=0,a.simplifiedGeometryRevision=0,a.simplifyTransformedInternal=(t=function(e,t,r){if(!r)return this.getSimplifiedGeometry(t);var i=this.clone();return i.applyTransform(r),i.getSimplifiedGeometry(t)},n=!1,function(){var e=Array.prototype.slice.call(arguments);return n&&this===o&&M(e,i)||(n=!0,o=this,i=e,r=t.apply(this,arguments)),r}),a}return ei(t,e),t.prototype.simplifyTransformed=function(e,t){return this.simplifyTransformedInternal(this.getRevision(),e,t)},t.prototype.clone=function(){return i()},t.prototype.closestPointXY=function(e,t,r,o){return i()},t.prototype.containsXY=function(e,t){var r=this.getClosestPoint([e,t]);return r[0]===e&&r[1]===t},t.prototype.getClosestPoint=function(e,t){var r=t||[NaN,NaN];return this.closestPointXY(e[0],e[1],r,1/0),r},t.prototype.intersectsCoordinate=function(e){return this.containsXY(e[0],e[1])},t.prototype.computeExtent=function(e){return i()},t.prototype.getExtent=function(e){return this.extentRevision_!=this.getRevision()&&(this.extent_=this.computeExtent(this.extent_),this.extentRevision_=this.getRevision()),function(e,t){return t?(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t):e}(this.extent_,e)},t.prototype.rotate=function(e,t){i()},t.prototype.scale=function(e,t,r){i()},t.prototype.simplify=function(e){return this.getSimplifiedGeometry(e*e)},t.prototype.getSimplifiedGeometry=function(e){return i()},t.prototype.getType=function(){return i()},t.prototype.applyTransform=function(e){i()},t.prototype.intersectsExtent=function(e){return i()},t.prototype.translate=function(e,t){i()},t.prototype.transform=function(e,t){var r=Dr(e),i=r.getUnits()==cr.TILE_PIXELS?function(e,i,o){var n=r.getExtent(),a=r.getWorldExtent(),s=At(a)/At(n);return Kr(ti,a[0],a[3],s,-s,0,0,0),nr(e,0,e.length,o,ti,i),Br(r,t)(e,i,o)}:Br(r,t);return this.applyTransform(i),this},t}(re),ii=(Qr=function(e,t){return(Qr=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Qr(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function oi(e){var t;return e==tr?t=2:e==rr||e==ir?t=3:e==or&&(t=4),t}var ni=function(e){function t(){var t=e.call(this)||this;return t.layout=tr,t.stride=2,t.flatCoordinates=null,t}return ii(t,e),t.prototype.computeExtent=function(e){return t=this.flatCoordinates,0,r=this.flatCoordinates.length,i=this.stride,xt(gt(e),t,0,r,i);var t,r,i},t.prototype.getCoordinates=function(){return i()},t.prototype.getFirstCoordinate=function(){return this.flatCoordinates.slice(0,this.stride)},t.prototype.getFlatCoordinates=function(){return this.flatCoordinates},t.prototype.getLastCoordinate=function(){return this.flatCoordinates.slice(this.flatCoordinates.length-this.stride)},t.prototype.getLayout=function(){return this.layout},t.prototype.getSimplifiedGeometry=function(e){if(this.simplifiedGeometryRevision!==this.getRevision()&&(this.simplifiedGeometryMaxMinSquaredTolerance=0,this.simplifiedGeometryRevision=this.getRevision()),e<0||0!==this.simplifiedGeometryMaxMinSquaredTolerance&&e<=this.simplifiedGeometryMaxMinSquaredTolerance)return this;var t=this.getSimplifiedGeometryInternal(e);return t.getFlatCoordinates().length<this.flatCoordinates.length?t:(this.simplifiedGeometryMaxMinSquaredTolerance=e,this)},t.prototype.getSimplifiedGeometryInternal=function(e){return this},t.prototype.getStride=function(){return this.stride},t.prototype.setFlatCoordinates=function(e,t){this.stride=oi(e),this.layout=e,this.flatCoordinates=t},t.prototype.setCoordinates=function(e,t){i()},t.prototype.setLayout=function(e,t,r){var i;if(e)i=oi(e);else{for(var o=0;o<r;++o){if(0===t.length)return this.layout=tr,void(this.stride=2);t=t[0]}e=function(e){var t;return 2==e?t=tr:3==e?t=rr:4==e&&(t=or),t}(i=t.length)}this.layout=e,this.stride=i},t.prototype.applyTransform=function(e){this.flatCoordinates&&(e(this.flatCoordinates,this.flatCoordinates,this.stride),this.changed())},t.prototype.rotate=function(e,t){var r=this.getFlatCoordinates();if(r){var i=this.getStride();!function(e,t,r,i,o,n,a){for(var s=a||[],l=Math.cos(o),u=Math.sin(o),c=n[0],d=n[1],h=0,f=0;f<r;f+=i){var g=e[f]-c,p=e[f+1]-d;s[h++]=c+g*l-p*u,s[h++]=d+g*u+p*l;for(var m=f+2;m<f+i;++m)s[h++]=e[m]}a&&s.length!=h&&(s.length=h)}(r,0,r.length,i,e,t,r),this.changed()}},t.prototype.scale=function(e,t,r){var i=t;void 0===i&&(i=e);var o=r;o||(o=bt(this.getExtent()));var n=this.getFlatCoordinates();if(n){var a=this.getStride();!function(e,t,r,i,o,n,a,s){for(var l=s||[],u=a[0],c=a[1],d=0,h=0;h<r;h+=i){var f=e[h]-u,g=e[h+1]-c;l[d++]=u+o*f,l[d++]=c+n*g;for(var p=h+2;p<h+i;++p)l[d++]=e[p]}s&&l.length!=d&&(l.length=d)}(n,0,n.length,a,e,i,o,n),this.changed()}},t.prototype.translate=function(e,t){var r=this.getFlatCoordinates();if(r){var i=this.getStride();!function(e,t,r,i,o,n,a){for(var s=a||[],l=0,u=0;u<r;u+=i){s[l++]=e[u]+o,s[l++]=e[u+1]+n;for(var c=u+2;c<u+i;++c)s[l++]=e[c]}a&&s.length!=l&&(s.length=l)}(r,0,r.length,i,e,t,r),this.changed()}},t}(ri);function ai(e,t,r,i){for(var o=0,n=e[r-i],a=e[r-i+1];t<r;t+=i){var s=e[t],l=e[t+1];o+=a*s-n*l,n=s,a=l}return o/2}function si(e,t,r,i,o,n,a){var s,l=e[t],u=e[t+1],c=e[r]-l,d=e[r+1]-u;if(0===c&&0===d)s=t;else{var h=((o-l)*c+(n-u)*d)/(c*c+d*d);if(h>1)s=r;else{if(h>0){for(var f=0;f<i;++f)a[f]=Xe(e[t+f],e[r+f],h);return void(a.length=i)}s=t}}for(f=0;f<i;++f)a[f]=e[s+f];a.length=i}function li(e,t,r,i,o){var n=e[t],a=e[t+1];for(t+=i;t<r;t+=i){var s=e[t],l=e[t+1],u=ke(n,a,s,l);u>o&&(o=u),n=s,a=l}return o}function ui(e,t,r,i,o,n,a,s,l,u,c){if(t==r)return u;var d,h;if(0===o){if((h=ke(a,s,e[t],e[t+1]))<u){for(d=0;d<i;++d)l[d]=e[t+d];return l.length=i,h}return u}for(var f=c||[NaN,NaN],g=t+i;g<r;)if(si(e,g-i,g,i,a,s,f),(h=ke(a,s,f[0],f[1]))<u){for(u=h,d=0;d<i;++d)l[d]=f[d];l.length=i,g+=i}else g+=i*Math.max((Math.sqrt(h)-Math.sqrt(u))/o|0,1);if(n&&(si(e,r-i,t,i,a,s,f),(h=ke(a,s,f[0],f[1]))<u)){for(u=h,d=0;d<i;++d)l[d]=f[d];l.length=i}return u}function ci(e,t,r,i){for(var o=0,n=r.length;o<n;++o)for(var a=r[o],s=0;s<i;++s)e[t++]=a[s];return t}function di(e,t,r,i,o){for(var n=void 0!==o?o:[],a=0,s=t;s<r;s+=i)n[a++]=e.slice(s,s+i);return n.length=a,n}function hi(e,t,r,i,o){for(var n=void 0!==o?o:[],a=0,s=0,l=r.length;s<l;++s){var u=r[s];n[a++]=di(e,t,u,i,n[a]),t=u}return n.length=a,n}function fi(e,t,r,i,o){for(var n=void 0!==o?o:[],a=0,s=0,l=r.length;s<l;++s){var u=r[s];n[a++]=hi(e,t,u,i,n[a]),t=u[u.length-1]}return n.length=a,n}function gi(e,t){return t*Math.round(e/t)}function pi(e,t,r,i,o,n,a){if(t==r)return a;var s,l,u=gi(e[t],o),c=gi(e[t+1],o);t+=i,n[a++]=u,n[a++]=c;do{if(s=gi(e[t],o),l=gi(e[t+1],o),(t+=i)==r)return n[a++]=s,n[a++]=l,a}while(s==u&&l==c);for(;t<r;){var d=gi(e[t],o),h=gi(e[t+1],o);if(t+=i,d!=s||h!=l){var f=s-u,g=l-c,p=d-u,m=h-c;f*m==g*p&&(f<0&&p<f||f==p||f>0&&p>f)&&(g<0&&m<g||g==m||g>0&&m>g)?(s=d,l=h):(n[a++]=s,n[a++]=l,u=s,c=l,s=d,l=h)}}return n[a++]=s,n[a++]=l,a}var mi,vi,xi=(vi=function(e,t){return(vi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}vi(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),_i=function(e){function t(t,r){var i=e.call(this)||this;return i.maxDelta_=-1,i.maxDeltaRevision_=-1,void 0===r||Array.isArray(t[0])?i.setCoordinates(t,r):i.setFlatCoordinates(r,t),i}return xi(t,e),t.prototype.clone=function(){return new t(this.flatCoordinates.slice(),this.layout)},t.prototype.closestPointXY=function(e,t,r,i){return i<lt(this.getExtent(),e,t)?i:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(li(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),ui(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,this.maxDelta_,!0,e,t,r,i))},t.prototype.getArea=function(){return ai(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)},t.prototype.getCoordinates=function(){return di(this.flatCoordinates,0,this.flatCoordinates.length,this.stride)},t.prototype.getSimplifiedGeometryInternal=function(e){var r=[];return r.length=function(e,t,r,i,o,n,a){var s=(r-t)/i;if(s<3){for(;t<r;t+=i)n[a++]=e[t],n[a++]=e[t+1];return a}var l=new Array(s);l[0]=1,l[s-1]=1;for(var u=[t,r-i],c=0;u.length>0;){for(var d=u.pop(),h=u.pop(),f=0,g=e[h],p=e[h+1],m=e[d],v=e[d+1],x=h+i;x<d;x+=i){var _=Ve(e[x],e[x+1],g,p,m,v);_>f&&(c=x,f=_)}f>o&&(l[(c-t)/i]=1,h+i<c&&u.push(h,c),c+i<d&&u.push(c,d))}for(x=0;x<s;++x)l[x]&&(n[a++]=e[t+x*i],n[a++]=e[t+x*i+1]);return a}(this.flatCoordinates,0,this.flatCoordinates.length,this.stride,e,r,0),new t(r,tr)},t.prototype.getType=function(){return"LinearRing"},t.prototype.intersectsExtent=function(e){return!1},t.prototype.setCoordinates=function(e,t){this.setLayout(t,e,1),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=ci(this.flatCoordinates,0,e,this.stride),this.changed()},t}(ni),yi=(mi=function(e,t){return(mi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}mi(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Ti=function(e){function t(t,r){var i=e.call(this)||this;return i.setCoordinates(t,r),i}return yi(t,e),t.prototype.clone=function(){return new t(this.flatCoordinates.slice(),this.layout)},t.prototype.closestPointXY=function(e,t,r,i){var o=this.flatCoordinates,n=ke(e,t,o[0],o[1]);if(n<i){for(var a=this.stride,s=0;s<a;++s)r[s]=o[s];return r.length=a,n}return i},t.prototype.getCoordinates=function(){return this.flatCoordinates?this.flatCoordinates.slice():[]},t.prototype.computeExtent=function(e){return r=e,ft(i=(t=this.flatCoordinates)[0],o=t[1],i,o,r);var t,r,i,o},t.prototype.getType=function(){return Yt},t.prototype.intersectsExtent=function(e){return dt(e,this.flatCoordinates[0],this.flatCoordinates[1])},t.prototype.setCoordinates=function(e,t){this.setLayout(t,e,0),this.flatCoordinates||(this.flatCoordinates=[]),this.flatCoordinates.length=function(e,t,r,i){for(var o=0,n=r.length;o<n;++o)e[t++]=r[o];return t}(this.flatCoordinates,0,e,this.stride),this.changed()},t}(ni);function Ci(e,t,r,i,o){return!function(e,t){var r;return(r=t(Tt(e)))||(r=t(Ct(e)))||(r=t(wt(e)))?r:(r=t(Lt(e)))||!1}(o,function(o){return!bi(e,t,r,i,o[0],o[1])})}function bi(e,t,r,i,o,n){for(var a=0,s=e[r-i],l=e[r-i+1];t<r;t+=i){var u=e[t],c=e[t+1];l<=n?c>n&&(u-s)*(n-l)-(o-s)*(c-l)>0&&a++:c<=n&&(u-s)*(n-l)-(o-s)*(c-l)<0&&a--,s=u,l=c}return 0!==a}function Mi(e,t,r,i,o,n){if(0===r.length)return!1;if(!bi(e,t,r[0],i,o,n))return!1;for(var a=1,s=r.length;a<s;++a)if(bi(e,r[a-1],r[a],i,o,n))return!1;return!0}function Ai(e,t,r,i,o){var n=xt([1/0,1/0,-1/0,-1/0],e,t,r,i);return!!Dt(o,n)&&(!!ct(o,n)||n[0]>=o[0]&&n[2]<=o[2]||n[1]>=o[1]&&n[3]<=o[3]||function(e,t,r,i,o){for(var n,a=[e[t],e[t+1]],s=[];t+i<r;t+=i){if(s[0]=e[t+i],s[1]=e[t+i+1],n=o(a,s))return n;a[0]=s[0],a[1]=s[1]}return!1}(e,t,r,i,function(e,t){return function(e,t,r){var i=!1,o=ht(e,t),n=ht(e,r);if(o===et||n===et)i=!0;else{var a=e[0],s=e[1],l=e[2],u=e[3],c=t[0],d=t[1],h=r[0],f=r[1],g=(f-d)/(h-c),p=void 0,m=void 0;n&tt&&!(o&tt)&&(i=(p=h-(f-u)/g)>=a&&p<=l),i||!(n&rt)||o&rt||(i=(m=f-(h-l)*g)>=s&&m<=u),i||!(n&it)||o&it||(i=(p=h-(f-s)/g)>=a&&p<=l),i||!(n&ot)||o&ot||(i=(m=f-(h-a)*g)>=s&&m<=u)}return i}(o,e,t)}))}function Ei(e,t,r,i){for(;t<r-i;){for(var o=0;o<i;++o){var n=e[t+o];e[t+o]=e[r-i+o],e[r-i+o]=n}t+=i,r-=i}}function Li(e,t,r,i){for(var o=0,n=e[r-i],a=e[r-i+1];t<r;t+=i){var s=e[t],l=e[t+1];o+=(s-n)*(l+a),n=s,a=l}return o>0}function wi(e,t,r,i,o){for(var n=void 0!==o&&o,a=0,s=r.length;a<s;++a){var l=r[a],u=Li(e,t,l,i);(0===a?n&&u||!n&&!u:n&&!u||!n&&u)&&Ei(e,t,l,i),t=l}return t}var Si,Di=(Si=function(e,t){return(Si=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Si(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Ri=function(e){function t(t,r,i){var o=e.call(this)||this;return o.ends_=[],o.flatInteriorPointRevision_=-1,o.flatInteriorPoint_=null,o.maxDelta_=-1,o.maxDeltaRevision_=-1,o.orientedRevision_=-1,o.orientedFlatCoordinates_=null,void 0!==r&&i?(o.setFlatCoordinates(r,t),o.ends_=i):o.setCoordinates(t,r),o}return Di(t,e),t.prototype.appendLinearRing=function(e){this.flatCoordinates?b(this.flatCoordinates,e.getFlatCoordinates()):this.flatCoordinates=e.getFlatCoordinates().slice(),this.ends_.push(this.flatCoordinates.length),this.changed()},t.prototype.clone=function(){return new t(this.flatCoordinates.slice(),this.layout,this.ends_.slice())},t.prototype.closestPointXY=function(e,t,r,i){return i<lt(this.getExtent(),e,t)?i:(this.maxDeltaRevision_!=this.getRevision()&&(this.maxDelta_=Math.sqrt(function(e,t,r,i,o){for(var n=0,a=r.length;n<a;++n){var s=r[n];o=li(e,t,s,i,o),t=s}return o}(this.flatCoordinates,0,this.ends_,this.stride,0)),this.maxDeltaRevision_=this.getRevision()),function(e,t,r,i,o,n,a,s,l,u,c){for(var d=c||[NaN,NaN],h=0,f=r.length;h<f;++h){var g=r[h];u=ui(e,t,g,i,o,n,a,s,l,u,d),t=g}return u}(this.flatCoordinates,0,this.ends_,this.stride,this.maxDelta_,!0,e,t,r,i))},t.prototype.containsXY=function(e,t){return Mi(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,e,t)},t.prototype.getArea=function(){return function(e,t,r,i){for(var o=0,n=0,a=r.length;n<a;++n){var s=r[n];o+=ai(e,t,s,i),t=s}return o}(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride)},t.prototype.getCoordinates=function(e){var t;return void 0!==e?wi(t=this.getOrientedFlatCoordinates().slice(),0,this.ends_,this.stride,e):t=this.flatCoordinates,hi(t,0,this.ends_,this.stride)},t.prototype.getEnds=function(){return this.ends_},t.prototype.getFlatInteriorPoint=function(){if(this.flatInteriorPointRevision_!=this.getRevision()){var e=bt(this.getExtent());this.flatInteriorPoint_=function(e,t,r,i,o,n,a){for(var s,l,u,c,d,h,f,g=o[n+1],p=[],m=0,v=r.length;m<v;++m){var x=r[m];for(c=e[x-i],h=e[x-i+1],s=t;s<x;s+=i)d=e[s],f=e[s+1],(g<=h&&f<=g||h<=g&&g<=f)&&(u=(g-h)/(f-h)*(d-c)+c,p.push(u)),c=d,h=f}var _=NaN,T=-1/0;for(p.sort(y),c=p[0],s=1,l=p.length;s<l;++s){d=p[s];var C=Math.abs(d-c);C>T&&Mi(e,t,r,i,u=(c+d)/2,g)&&(_=u,T=C),c=d}return isNaN(_)&&(_=o[n]),a?(a.push(_,g,T),a):[_,g,T]}(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,e,0),this.flatInteriorPointRevision_=this.getRevision()}return this.flatInteriorPoint_},t.prototype.getInteriorPoint=function(){return new Ti(this.getFlatInteriorPoint(),ir)},t.prototype.getLinearRingCount=function(){return this.ends_.length},t.prototype.getLinearRing=function(e){return e<0||this.ends_.length<=e?null:new _i(this.flatCoordinates.slice(0===e?0:this.ends_[e-1],this.ends_[e]),this.layout)},t.prototype.getLinearRings=function(){for(var e=this.layout,t=this.flatCoordinates,r=this.ends_,i=[],o=0,n=0,a=r.length;n<a;++n){var s=r[n],l=new _i(t.slice(o,s),e);i.push(l),o=s}return i},t.prototype.getOrientedFlatCoordinates=function(){if(this.orientedRevision_!=this.getRevision()){var e=this.flatCoordinates;!function(e,t,r,i,o){for(var n=void 0!==o&&o,a=0,s=r.length;a<s;++a){var l=r[a],u=Li(e,t,l,i);if(0===a){if(n&&u||!n&&!u)return!1}else if(n&&!u||!n&&u)return!1;t=l}return!0}(e,0,this.ends_,this.stride)?(this.orientedFlatCoordinates_=e.slice(),this.orientedFlatCoordinates_.length=wi(this.orientedFlatCoordinates_,0,this.ends_,this.stride)):this.orientedFlatCoordinates_=e,this.orientedRevision_=this.getRevision()}return this.orientedFlatCoordinates_},t.prototype.getSimplifiedGeometryInternal=function(e){var r=[],i=[];return r.length=function(e,t,r,i,o,n,a,s){for(var l=0,u=r.length;l<u;++l){var c=r[l];a=pi(e,t,c,i,o,n,a),s.push(a),t=c}return a}(this.flatCoordinates,0,this.ends_,this.stride,Math.sqrt(e),r,0,i),new t(r,tr,i)},t.prototype.getType=function(){return Kt},t.prototype.intersectsExtent=function(e){return function(e,t,r,i,o){if(!function(e,t,r,i,o){return!!(Ai(e,t,r,i,o)||bi(e,t,r,i,o[0],o[1])||bi(e,t,r,i,o[0],o[3])||bi(e,t,r,i,o[2],o[1])||bi(e,t,r,i,o[2],o[3]))}(e,t,r[0],i,o))return!1;if(1===r.length)return!0;for(var n=1,a=r.length;n<a;++n)if(Ci(e,r[n-1],r[n],i,o)&&!Ai(e,r[n-1],r[n],i,o))return!1;return!0}(this.getOrientedFlatCoordinates(),0,this.ends_,this.stride,e)},t.prototype.setCoordinates=function(e,t){this.setLayout(t,e,2),this.flatCoordinates||(this.flatCoordinates=[]);var r=function(e,t,r,i,o){for(var n=o||[],a=0,s=0,l=r.length;s<l;++s){var u=ci(e,t,r[s],i);n[a++]=u,t=u}return n.length=a,n}(this.flatCoordinates,0,e,this.stride,this.ends_);this.flatCoordinates.length=0===r.length?0:r[r.length-1],this.changed()},t}(ni),Pi=Ri;function Ii(e){var t=e[0],r=e[1],i=e[2],o=e[3],n=[t,r,t,o,i,o,i,r,t,r];return new Ri(n,tr,[n.length])}var Fi,Oi=(Fi=function(e,t){return(Fi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Fi(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Bi(e,t){setTimeout(function(){e(t)},0)}function Ni(e){return!(e.sourceCenter&&e.targetCenter&&!zt(e.sourceCenter,e.targetCenter))&&e.sourceResolution===e.targetResolution&&e.sourceRotation===e.targetRotation}var Ui=function(e){function t(t){var r=e.call(this)||this,i=h({},t);return r.hints_=[0,0],r.animations_=[],r.updateAnimationKey_,r.projection_=Ir(i.projection,"EPSG:3857"),r.viewportSize_=[100,100],r.targetCenter_=null,r.targetResolution_,r.targetRotation_,r.cancelAnchor_=void 0,i.center&&(i.center=Wr(i.center,r.projection_)),i.extent&&(i.extent=Yr(i.extent,r.projection_)),r.applyOptions_(i),r}return Oi(t,e),t.prototype.applyOptions_=function(e){var t=function(e){var t,r,i,o=void 0!==e.minZoom?e.minZoom:0,n=void 0!==e.maxZoom?e.maxZoom:28,a=void 0!==e.zoomFactor?e.zoomFactor:2,s=void 0!==e.multiWorld&&e.multiWorld,l=void 0===e.smoothResolutionConstraint||e.smoothResolutionConstraint,u=void 0!==e.showFullExtent&&e.showFullExtent,c=Ir(e.projection,"EPSG:3857"),d=c.getExtent(),h=e.constrainOnlyCenter,f=e.extent;if(s||f||!c.isGlobal()||(h=!1,f=d),void 0!==e.resolutions){var g=e.resolutions;r=g[o],i=void 0!==g[n]?g[n]:g[g.length-1],t=e.constrainResolution?function(e,t,r,i){return function(o,n,a,s){if(void 0!==o){var l=e[0],u=e[e.length-1],c=r?Pt(l,r,a,i):l;if(s)return void 0===t||t?It(o,c,u):ze(o,u,c);var d=Math.min(c,o),h=Math.floor(T(e,d,n));return e[h]>c&&h<e.length-1?e[h+1]:e[h]}}}(g,l,!h&&f,u):Ft(r,i,l,!h&&f,u)}else{var p=(d?Math.max(St(d),At(d)):360*lr[cr.DEGREES]/c.getMetersPerUnit())/256/Math.pow(2,0),m=p/Math.pow(2,28);void 0!==(r=e.maxResolution)?o=0:r=p/Math.pow(a,o),void 0===(i=e.minResolution)&&(i=void 0!==e.maxZoom?void 0!==e.maxResolution?r/Math.pow(a,n):p/Math.pow(a,n):m),n=o+Math.floor(Math.log(r/i)/Math.log(a)),i=r/Math.pow(a,n-o),t=e.constrainResolution?function(e,t,r,i,o,n){return function(a,s,l,u){if(void 0!==a){var c=o?Pt(t,o,l,n):t,d=void 0!==r?r:0;if(u)return void 0===i||i?It(a,c,d):ze(a,d,c);var h=Math.ceil(Math.log(t/c)/Math.log(e)-1e-9),f=-s*(.5-1e-9)+.5,g=Math.min(c,a),p=Math.floor(Math.log(t/g)/Math.log(e)+f),m=Math.max(h,p);return ze(t/Math.pow(e,m),d,c)}}}(a,r,i,l,!h&&f,u):Ft(r,i,l,!h&&f,u)}return{constraint:t,maxResolution:r,minResolution:i,minZoom:o,zoomFactor:a}}(e);this.maxResolution_=t.maxResolution,this.minResolution_=t.minResolution,this.zoomFactor_=t.zoomFactor,this.resolutions_=e.resolutions,this.minZoom_=t.minZoom;var r=function(e){if(void 0!==e.extent){var t=void 0===e.smoothExtentConstraint||e.smoothExtentConstraint;return Ye(e.extent,e.constrainOnlyCenter,t)}var r=Ir(e.projection,"EPSG:3857");if(!0!==e.multiWorld&&r.isGlobal()){var i=r.getExtent().slice();return i[0]=-1/0,i[2]=1/0,Ye(i,!1,!1)}return qe}(e),i=t.constraint,o=function(e){if(void 0===e.enableRotation||e.enableRotation){var t=e.constrainRotation;return void 0===t||!0===t?(o=je(5),function(e,t){return t?e:void 0!==e?Math.abs(e)<=o?0:e:void 0}):!1===t?Bt:"number"==typeof t?(r=t,i=2*Math.PI/r,function(e,t){return t?e:void 0!==e?e=Math.floor(e/i+.5)*i:void 0}):Bt}return Ot;var r,i,o}(e);this.constraints_={center:r,resolution:i,rotation:o},this.setRotation(void 0!==e.rotation?e.rotation:0),this.setCenterInternal(void 0!==e.center?e.center:null),void 0!==e.resolution?this.setResolution(e.resolution):void 0!==e.zoom&&this.setZoom(e.zoom),this.setProperties({}),this.options_=e},t.prototype.getUpdatedOptions_=function(e){var t=h({},this.options_);return void 0!==t.resolution?t.resolution=this.getResolution():t.zoom=this.getZoom(),t.center=this.getCenterInternal(),t.rotation=this.getRotation(),h({},t,e)},t.prototype.animate=function(e){this.isDef()&&!this.getAnimating()&&this.resolveConstraints(0);for(var t=new Array(arguments.length),r=0;r<t.length;++r){var i=arguments[r];i.center&&((i=h({},i)).center=Wr(i.center,this.getProjection())),i.anchor&&((i=h({},i)).anchor=Wr(i.anchor,this.getProjection())),t[r]=i}this.animateInternal.apply(this,t)},t.prototype.animateInternal=function(e){var t,r=arguments.length;if(r>1&&"function"==typeof arguments[r-1]&&(t=arguments[r-1],--r),!this.isDef()){var i=arguments[r-1];return i.center&&this.setCenterInternal(i.center),void 0!==i.zoom&&this.setZoom(i.zoom),void 0!==i.rotation&&this.setRotation(i.rotation),void(t&&Bi(t,!0))}for(var o=Date.now(),n=this.targetCenter_.slice(),a=this.targetResolution_,s=this.targetRotation_,l=[],u=0;u<r;++u){var c=arguments[u],d={start:o,complete:!1,anchor:c.anchor,duration:void 0!==c.duration?c.duration:1e3,easing:c.easing||Wt,callback:t};if(c.center&&(d.sourceCenter=n,d.targetCenter=c.center.slice(),n=d.targetCenter),void 0!==c.zoom?(d.sourceResolution=a,d.targetResolution=this.getResolutionForZoom(c.zoom),a=d.targetResolution):c.resolution&&(d.sourceResolution=a,d.targetResolution=c.resolution,a=d.targetResolution),void 0!==c.rotation){d.sourceRotation=s;var h=We(c.rotation-s+Math.PI,2*Math.PI)-Math.PI;d.targetRotation=s+h,s=d.targetRotation}Ni(d)?d.complete=!0:o+=d.duration,l.push(d)}this.animations_.push(l),this.setHint(0,1),this.updateAnimations_()},t.prototype.getAnimating=function(){return this.hints_[0]>0},t.prototype.getInteracting=function(){return this.hints_[1]>0},t.prototype.cancelAnimations=function(){var e;this.setHint(0,-this.hints_[0]);for(var t=0,r=this.animations_.length;t<r;++t){var i=this.animations_[t];if(i[0].callback&&Bi(i[0].callback,!1),!e)for(var o=0,n=i.length;o<n;++o){var a=i[o];if(!a.complete){e=a.anchor;break}}}this.animations_.length=0,this.cancelAnchor_=e},t.prototype.updateAnimations_=function(){if(void 0!==this.updateAnimationKey_&&(cancelAnimationFrame(this.updateAnimationKey_),this.updateAnimationKey_=void 0),this.getAnimating()){for(var e=Date.now(),t=!1,r=this.animations_.length-1;r>=0;--r){for(var i=this.animations_[r],o=!0,n=0,a=i.length;n<a;++n){var s=i[n];if(!s.complete){var l=e-s.start,u=s.duration>0?l/s.duration:1;u>=1?(s.complete=!0,u=1):o=!1;var c=s.easing(u);if(s.sourceCenter){var d=s.sourceCenter[0],h=s.sourceCenter[1],f=d+c*(s.targetCenter[0]-d),g=h+c*(s.targetCenter[1]-h);this.targetCenter_=[f,g]}if(s.sourceResolution&&s.targetResolution){var p=1===c?s.targetResolution:s.sourceResolution+c*(s.targetResolution-s.sourceResolution);if(s.anchor){var m=this.getViewportSize_(this.getRotation()),v=this.constraints_.resolution(p,0,m,!0);this.targetCenter_=this.calculateCenterZoom(v,s.anchor)}this.targetResolution_=p,this.applyTargetState_(!0)}if(void 0!==s.sourceRotation&&void 0!==s.targetRotation){var x=1===c?We(s.targetRotation+Math.PI,2*Math.PI)-Math.PI:s.sourceRotation+c*(s.targetRotation-s.sourceRotation);if(s.anchor){var _=this.constraints_.rotation(x,!0);this.targetCenter_=this.calculateCenterRotate(_,s.anchor)}this.targetRotation_=x}if(this.applyTargetState_(!0),t=!0,!s.complete)break}}if(o){this.animations_[r]=null,this.setHint(0,-1);var y=i[0].callback;y&&Bi(y,!0)}}this.animations_=this.animations_.filter(Boolean),t&&void 0===this.updateAnimationKey_&&(this.updateAnimationKey_=requestAnimationFrame(this.updateAnimations_.bind(this)))}},t.prototype.calculateCenterRotate=function(e,t){var r,i,o,n=this.getCenterInternal();return void 0!==n&&(Ht(r=[n[0]-t[0],n[1]-t[1]],e-this.getRotation()),o=t,(i=r)[0]+=+o[0],i[1]+=+o[1]),r},t.prototype.calculateCenterZoom=function(e,t){var r,i=this.getCenterInternal(),o=this.getResolution();return void 0!==i&&void 0!==o&&(r=[t[0]-e*(t[0]-i[0])/o,t[1]-e*(t[1]-i[1])/o]),r},t.prototype.getViewportSize_=function(e){var t=this.viewportSize_;if(e){var r=t[0],i=t[1];return[Math.abs(r*Math.cos(e))+Math.abs(i*Math.sin(e)),Math.abs(r*Math.sin(e))+Math.abs(i*Math.cos(e))]}return t},t.prototype.setViewportSize=function(e){this.viewportSize_=Array.isArray(e)?e.slice():[100,100],this.resolveConstraints(0)},t.prototype.getCenter=function(){var e=this.getCenterInternal();return e?jr(e,this.getProjection()):e},t.prototype.getCenterInternal=function(){return this.get(Nt)},t.prototype.getConstraints=function(){return this.constraints_},t.prototype.getConstrainResolution=function(){return this.options_.constrainResolution},t.prototype.getHints=function(e){return void 0!==e?(e[0]=this.hints_[0],e[1]=this.hints_[1],e):this.hints_.slice()},t.prototype.calculateExtent=function(e){return Xr(this.calculateExtentInternal(e),this.getProjection())},t.prototype.calculateExtentInternal=function(e){var t=e||this.getViewportSize_(),r=this.getCenterInternal();Oe(r,1);var i=this.getResolution();Oe(void 0!==i,2);var o=this.getRotation();return Oe(void 0!==o,3),Mt(r,i,o,t)},t.prototype.getMaxResolution=function(){return this.maxResolution_},t.prototype.getMinResolution=function(){return this.minResolution_},t.prototype.getMaxZoom=function(){return this.getZoomForResolution(this.minResolution_)},t.prototype.setMaxZoom=function(e){this.applyOptions_(this.getUpdatedOptions_({maxZoom:e}))},t.prototype.getMinZoom=function(){return this.getZoomForResolution(this.maxResolution_)},t.prototype.setMinZoom=function(e){this.applyOptions_(this.getUpdatedOptions_({minZoom:e}))},t.prototype.setConstrainResolution=function(e){this.applyOptions_(this.getUpdatedOptions_({constrainResolution:e}))},t.prototype.getProjection=function(){return this.projection_},t.prototype.getResolution=function(){return this.get(Ut)},t.prototype.getResolutions=function(){return this.resolutions_},t.prototype.getResolutionForExtent=function(e,t){return this.getResolutionForExtentInternal(Yr(e,this.getProjection()),t)},t.prototype.getResolutionForExtentInternal=function(e,t){var r=t||this.getViewportSize_(),i=St(e)/r[0],o=At(e)/r[1];return Math.max(i,o)},t.prototype.getResolutionForValueFunction=function(e){var t=e||2,r=this.getConstrainedResolution(this.maxResolution_),i=this.minResolution_,o=Math.log(r/i)/Math.log(t);return function(e){return r/Math.pow(t,e*o)}},t.prototype.getRotation=function(){return this.get(Gt)},t.prototype.getValueForResolutionFunction=function(e){var t=Math.log(e||2),r=this.getConstrainedResolution(this.maxResolution_),i=this.minResolution_,o=Math.log(r/i)/t;return function(e){return Math.log(r/e)/t/o}},t.prototype.getState=function(){var e=this.getCenterInternal(),t=this.getProjection(),r=this.getResolution(),i=this.getRotation();return{center:e.slice(0),projection:void 0!==t?t:null,resolution:r,rotation:i,zoom:this.getZoom()}},t.prototype.getZoom=function(){var e,t=this.getResolution();return void 0!==t&&(e=this.getZoomForResolution(t)),e},t.prototype.getZoomForResolution=function(e){var t,r,i=this.minZoom_||0;if(this.resolutions_){var o=T(this.resolutions_,e,1);i=o,t=this.resolutions_[o],r=o==this.resolutions_.length-1?2:t/this.resolutions_[o+1]}else t=this.maxResolution_,r=this.zoomFactor_;return i+Math.log(t/e)/Math.log(r)},t.prototype.getResolutionForZoom=function(e){if(this.resolutions_){if(this.resolutions_.length<=1)return 0;var t=ze(Math.floor(e),0,this.resolutions_.length-2),r=this.resolutions_[t]/this.resolutions_[t+1];return this.resolutions_[t]/Math.pow(r,ze(e-t,0,1))}return this.maxResolution_/Math.pow(this.zoomFactor_,e-this.minZoom_)},t.prototype.fit=function(e,t){var r,i=h({size:this.getViewportSize_()},t||{});if(Oe(Array.isArray(e)||"function"==typeof e.getSimplifiedGeometry,24),Array.isArray(e))Oe(!Rt(e),25),r=Ii(o=Yr(e,this.getProjection()));else if(e.getType()===er){var o;(r=Ii(o=Yr(e.getExtent(),this.getProjection()))).rotate(this.getRotation(),bt(o))}else{var n=kr();r=n?e.clone().transform(n,this.getProjection()):e}this.fitInternal(r,i)},t.prototype.fitInternal=function(e,t){var r=t||{},i=r.size;i||(i=this.getViewportSize_());var o,n=void 0!==r.padding?r.padding:[0,0,0,0],a=void 0!==r.nearest&&r.nearest;o=void 0!==r.minResolution?r.minResolution:void 0!==r.maxZoom?this.getResolutionForZoom(r.maxZoom):0;for(var s=e.getFlatCoordinates(),l=this.getRotation(),u=Math.cos(-l),c=Math.sin(-l),d=1/0,h=1/0,f=-1/0,g=-1/0,p=e.getStride(),m=0,v=s.length;m<v;m+=p){var x=s[m]*u-s[m+1]*c,_=s[m]*c+s[m+1]*u;d=Math.min(d,x),h=Math.min(h,_),f=Math.max(f,x),g=Math.max(g,_)}var y=this.getResolutionForExtentInternal([d,h,f,g],[i[0]-n[1]-n[3],i[1]-n[0]-n[2]]);y=isNaN(y)?o:Math.max(y,o),y=this.getConstrainedResolution(y,a?0:1),c=-c;var T=(d+f)/2,C=(h+g)/2,b=[(T+=(n[1]-n[3])/2*y)*u-(C+=(n[0]-n[2])/2*y)*c,C*u+T*c],M=r.callback?r.callback:L;void 0!==r.duration?this.animateInternal({resolution:y,center:this.getConstrainedCenter(b,y),duration:r.duration,easing:r.easing},M):(this.targetResolution_=y,this.targetCenter_=b,this.applyTargetState_(!1,!0),Bi(M,!0))},t.prototype.centerOn=function(e,t,r){this.centerOnInternal(Wr(e,this.getProjection()),t,r)},t.prototype.centerOnInternal=function(e,t,r){var i=this.getRotation(),o=Math.cos(-i),n=Math.sin(-i),a=e[0]*o-e[1]*n,s=e[1]*o+e[0]*n,l=this.getResolution(),u=(a+=(t[0]/2-r[0])*l)*o-(s+=(r[1]-t[1]/2)*l)*(n=-n),c=s*o+a*n;this.setCenterInternal([u,c])},t.prototype.isDef=function(){return!!this.getCenterInternal()&&void 0!==this.getResolution()},t.prototype.adjustCenter=function(e){var t=jr(this.targetCenter_,this.getProjection());this.setCenter([t[0]+e[0],t[1]+e[1]])},t.prototype.adjustCenterInternal=function(e){var t=this.targetCenter_;this.setCenterInternal([t[0]+e[0],t[1]+e[1]])},t.prototype.adjustResolution=function(e,t){var r=t&&Wr(t,this.getProjection());this.adjustResolutionInternal(e,r)},t.prototype.adjustResolutionInternal=function(e,t){var r=this.getAnimating()||this.getInteracting(),i=this.getViewportSize_(this.getRotation()),o=this.constraints_.resolution(this.targetResolution_*e,0,i,r);t&&(this.targetCenter_=this.calculateCenterZoom(o,t)),this.targetResolution_*=e,this.applyTargetState_()},t.prototype.adjustZoom=function(e,t){this.adjustResolution(Math.pow(this.zoomFactor_,-e),t)},t.prototype.adjustRotation=function(e,t){t&&(t=Wr(t,this.getProjection())),this.adjustRotationInternal(e,t)},t.prototype.adjustRotationInternal=function(e,t){var r=this.getAnimating()||this.getInteracting(),i=this.constraints_.rotation(this.targetRotation_+e,r);t&&(this.targetCenter_=this.calculateCenterRotate(i,t)),this.targetRotation_+=e,this.applyTargetState_()},t.prototype.setCenter=function(e){this.setCenterInternal(Wr(e,this.getProjection()))},t.prototype.setCenterInternal=function(e){this.targetCenter_=e,this.applyTargetState_()},t.prototype.setHint=function(e,t){return this.hints_[e]+=t,this.changed(),this.hints_[e]},t.prototype.setResolution=function(e){this.targetResolution_=e,this.applyTargetState_()},t.prototype.setRotation=function(e){this.targetRotation_=e,this.applyTargetState_()},t.prototype.setZoom=function(e){this.setResolution(this.getResolutionForZoom(e))},t.prototype.applyTargetState_=function(e,t){var r=this.getAnimating()||this.getInteracting()||t,i=this.constraints_.rotation(this.targetRotation_,r),o=this.getViewportSize_(i),n=this.constraints_.resolution(this.targetResolution_,0,o,r),a=this.constraints_.center(this.targetCenter_,n,o,r);this.get(Gt)!==i&&this.set(Gt,i),this.get(Ut)!==n&&this.set(Ut,n),this.get(Nt)&&zt(this.get(Nt),a)||this.set(Nt,a),this.getAnimating()&&!e&&this.cancelAnimations(),this.cancelAnchor_=void 0},t.prototype.resolveConstraints=function(e,t,r){var i=void 0!==e?e:200,o=t||0,n=this.constraints_.rotation(this.targetRotation_),a=this.getViewportSize_(n),s=this.constraints_.resolution(this.targetResolution_,o,a),l=this.constraints_.center(this.targetCenter_,s,a);if(0===i&&!this.cancelAnchor_)return this.targetResolution_=s,this.targetRotation_=n,this.targetCenter_=l,void this.applyTargetState_();var u=r||(0===i?this.cancelAnchor_:void 0);this.cancelAnchor_=void 0,this.getResolution()===s&&this.getRotation()===n&&this.getCenterInternal()&&zt(this.getCenterInternal(),l)||(this.getAnimating()&&this.cancelAnimations(),this.animateInternal({rotation:n,center:l,resolution:s,duration:i,easing:jt,anchor:u}))},t.prototype.beginInteraction=function(){this.resolveConstraints(0),this.setHint(1,1)},t.prototype.endInteraction=function(e,t,r){var i=r&&Wr(r,this.getProjection());this.endInteractionInternal(e,t,i)},t.prototype.endInteractionInternal=function(e,t,r){this.setHint(1,-1),this.resolveConstraints(e,t,r)},t.prototype.getConstrainedCenter=function(e,t){var r=this.getViewportSize_(this.getRotation());return this.constraints_.center(e,t||this.getResolution(),r)},t.prototype.getConstrainedZoom=function(e,t){var r=this.getResolutionForZoom(e);return this.getZoomForResolution(this.getConstrainedResolution(r,t))},t.prototype.getConstrainedResolution=function(e,t){var r=t||0,i=this.getViewportSize_(this.getRotation());return this.constraints_.resolution(e,r,i)},t}(re);function Gi(e,t,r){var i=r&&r.length?r.shift():me?new OffscreenCanvas(e||300,t||300):document.createElement("canvas");return e&&(i.width=e),t&&(i.height=t),i.getContext("2d")}function zi(e,t){var r=t.parentNode;r&&r.replaceChild(e,t)}function Hi(e){return e&&e.parentNode?e.parentNode.removeChild(e):null}var Vi,ki,ji="opacity",Wi="visible",Xi="zIndex",Yi="maxResolution",qi="minResolution",Ki="maxZoom",Zi="minZoom",Ji="source",Qi=(ki=function(e,t){return(ki=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}ki(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),$i=function(e){function t(t){var r=e.call(this)||this,i=h({},t);return i[ji]=void 0!==t.opacity?t.opacity:1,Oe("number"==typeof i[ji],64),i[Wi]=void 0===t.visible||t.visible,i[Xi]=t.zIndex,i[Yi]=void 0!==t.maxResolution?t.maxResolution:1/0,i[qi]=void 0!==t.minResolution?t.minResolution:0,i[Zi]=void 0!==t.minZoom?t.minZoom:-1/0,i[Ki]=void 0!==t.maxZoom?t.maxZoom:1/0,r.className_=void 0!==i.className?t.className:"ol-layer",delete i.className,r.setProperties(i),r.state_=null,r}return Qi(t,e),t.prototype.getClassName=function(){return this.className_},t.prototype.getLayerState=function(e){var t=this.state_||{layer:this,managed:void 0===e||e},r=this.getZIndex();return t.opacity=ze(Math.round(100*this.getOpacity())/100,0,1),t.sourceState=this.getSourceState(),t.visible=this.getVisible(),t.extent=this.getExtent(),t.zIndex=void 0!==r?r:!1===t.managed?1/0:0,t.maxResolution=this.getMaxResolution(),t.minResolution=Math.max(this.getMinResolution(),0),t.minZoom=this.getMinZoom(),t.maxZoom=this.getMaxZoom(),this.state_=t,t},t.prototype.getLayersArray=function(e){return i()},t.prototype.getLayerStatesArray=function(e){return i()},t.prototype.getExtent=function(){return this.get("extent")},t.prototype.getMaxResolution=function(){return this.get(Yi)},t.prototype.getMinResolution=function(){return this.get(qi)},t.prototype.getMinZoom=function(){return this.get(Zi)},t.prototype.getMaxZoom=function(){return this.get(Ki)},t.prototype.getOpacity=function(){return this.get(ji)},t.prototype.getSourceState=function(){return i()},t.prototype.getVisible=function(){return this.get(Wi)},t.prototype.getZIndex=function(){return this.get(Xi)},t.prototype.setExtent=function(e){this.set("extent",e)},t.prototype.setMaxResolution=function(e){this.set(Yi,e)},t.prototype.setMinResolution=function(e){this.set(qi,e)},t.prototype.setMaxZoom=function(e){this.set(Ki,e)},t.prototype.setMinZoom=function(e){this.set(Zi,e)},t.prototype.setOpacity=function(e){Oe("number"==typeof e,64),this.set(ji,e)},t.prototype.setVisible=function(e){this.set(Wi,e)},t.prototype.setZIndex=function(e){this.set(Xi,e)},t.prototype.disposeInternal=function(){this.state_&&(this.state_.layer=null,this.state_=null),e.prototype.disposeInternal.call(this)},t}(re),eo="undefined",to="ready",ro=(Vi=function(e,t){return(Vi=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Vi(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),io="layers",oo=function(e){function t(t){var r=this,i=t||{},o=h({},i);delete o.layers;var n=i.layers;return(r=e.call(this,o)||this).layersListenerKeys_=[],r.listenerKeys_={},r.addEventListener(Z(io),r.handleLayersChanged_),n?Array.isArray(n)?n=new ae(n.slice(),{unique:!0}):Oe("function"==typeof n.getArray,43):n=new ae(void 0,{unique:!0}),r.setLayers(n),r}return ro(t,e),t.prototype.handleLayerChange_=function(){this.changed()},t.prototype.handleLayersChanged_=function(){this.layersListenerKeys_.forEach(x),this.layersListenerKeys_.length=0;var e=this.getLayers();for(var t in this.layersListenerKeys_.push(m(e,u,this.handleLayersAdd_,this),m(e,c,this.handleLayersRemove_,this)),this.listenerKeys_)this.listenerKeys_[t].forEach(x);f(this.listenerKeys_);for(var r=e.getArray(),i=0,o=r.length;i<o;i++){var a=r[i];this.listenerKeys_[n(a)]=[m(a,d,this.handleLayerChange_,this),m(a,F,this.handleLayerChange_,this)]}this.changed()},t.prototype.handleLayersAdd_=function(e){var t=e.element;this.listenerKeys_[n(t)]=[m(t,d,this.handleLayerChange_,this),m(t,F,this.handleLayerChange_,this)],this.changed()},t.prototype.handleLayersRemove_=function(e){var t=n(e.element);this.listenerKeys_[t].forEach(x),delete this.listenerKeys_[t],this.changed()},t.prototype.getLayers=function(){return this.get(io)},t.prototype.setLayers=function(e){this.set(io,e)},t.prototype.getLayersArray=function(e){var t=void 0!==e?e:[];return this.getLayers().forEach(function(e){e.getLayersArray(t)}),t},t.prototype.getLayerStatesArray=function(e){var t=void 0!==e?e:[],r=t.length;this.getLayers().forEach(function(e){e.getLayerStatesArray(t)});for(var i=this.getLayerState(),o=r,n=t.length;o<n;o++){var a=t[o];a.opacity*=i.opacity,a.visible=a.visible&&i.visible,a.maxResolution=Math.min(a.maxResolution,i.maxResolution),a.minResolution=Math.max(a.minResolution,i.minResolution),a.minZoom=Math.max(a.minZoom,i.minZoom),a.maxZoom=Math.min(a.maxZoom,i.maxZoom),void 0!==i.extent&&(void 0!==a.extent?a.extent=Et(a.extent,i.extent):a.extent=i.extent)}return t},t.prototype.getSourceState=function(){return to},t}($i);function no(e,t,r){return void 0===r&&(r=[0,0]),r[0]=e[0]+2*t,r[1]=e[1]+2*t,r}function ao(e,t,r){return void 0===r&&(r=[0,0]),r[0]=e[0]*t+.5|0,r[1]=e[1]*t+.5|0,r}function so(e,t){return Array.isArray(e)?e:(void 0===t?t=[e,e]:(t[0]=e,t[1]=e),t)}var lo,uo,co,ho=(lo=function(e,t){return(lo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}lo(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),fo=function(e){function t(t){var r=e.call(this)||this,i=function(e){var t=null;void 0!==e.keyboardEventTarget&&(t="string"==typeof e.keyboardEventTarget?document.getElementById(e.keyboardEventTarget):e.keyboardEventTarget);var r,i,o,n={},a=e.layers&&"function"==typeof e.layers.getLayers?e.layers:new oo({layers:e.layers});return n[Le]=a,n[Se]=e.target,n[De]=void 0!==e.view?e.view:new Ui,void 0!==e.controls&&(Array.isArray(e.controls)?r=new ae(e.controls.slice()):(Oe("function"==typeof e.controls.getArray,47),r=e.controls)),void 0!==e.interactions&&(Array.isArray(e.interactions)?i=new ae(e.interactions.slice()):(Oe("function"==typeof e.interactions.getArray,48),i=e.interactions)),void 0!==e.overlays?Array.isArray(e.overlays)?o=new ae(e.overlays.slice()):(Oe("function"==typeof e.overlays.getArray,49),o=e.overlays):o=new ae,{controls:r,interactions:i,keyboardEventTarget:t,overlays:o,values:n}}(t);r.boundHandleBrowserEvent_=r.handleBrowserEvent.bind(r),r.maxTilesLoading_=void 0!==t.maxTilesLoading?t.maxTilesLoading:16,r.pixelRatio_=void 0!==t.pixelRatio?t.pixelRatio:pe,r.postRenderTimeoutHandle_,r.animationDelayKey_,r.animationDelay_=function(){this.animationDelayKey_=void 0,this.renderFrame_(Date.now())}.bind(r),r.coordinateToPixelTransform_=[1,0,0,1,0,0],r.pixelToCoordinateTransform_=[1,0,0,1,0,0],r.frameIndex_=0,r.frameState_=null,r.previousExtent_=null,r.viewPropertyListenerKey_=null,r.viewChangeListenerKey_=null,r.layerGroupPropertyListenerKeys_=null,r.viewport_=document.createElement("div"),r.viewport_.className="ol-viewport"+("ontouchstart"in window?" ol-touch":""),r.viewport_.style.position="relative",r.viewport_.style.overflow="hidden",r.viewport_.style.width="100%",r.viewport_.style.height="100%",r.overlayContainer_=document.createElement("div"),r.overlayContainer_.style.position="absolute",r.overlayContainer_.style.zIndex="0",r.overlayContainer_.style.width="100%",r.overlayContainer_.style.height="100%",r.overlayContainer_.className="ol-overlaycontainer",r.viewport_.appendChild(r.overlayContainer_),r.overlayContainerStopEvent_=document.createElement("div"),r.overlayContainerStopEvent_.style.position="absolute",r.overlayContainerStopEvent_.style.zIndex="0",r.overlayContainerStopEvent_.style.width="100%",r.overlayContainerStopEvent_.style.height="100%",r.overlayContainerStopEvent_.className="ol-overlaycontainer-stopevent",r.viewport_.appendChild(r.overlayContainerStopEvent_),r.mapBrowserEventHandler_=new Ae(r,t.moveTolerance);var o=r.handleMapBrowserEvent.bind(r);for(var n in _e)r.mapBrowserEventHandler_.addEventListener(_e[n],o);r.keyboardEventTarget_=i.keyboardEventTarget,r.keyHandlerKeys_=null;var a=r.handleBrowserEvent.bind(r);return r.viewport_.addEventListener(B,a,!1),r.viewport_.addEventListener(j,a,!!xe&&{passive:!1}),r.controls=i.controls||new ae,r.interactions=i.interactions||new ae,r.overlays_=i.overlays,r.overlayIdIndex_={},r.renderer_=null,r.handleResize_,r.postRenderFunctions_=[],r.tileQueue_=new Ge(r.getTilePriority.bind(r),r.handleTileChange_.bind(r)),r.addEventListener(Z(Le),r.handleLayerGroupChanged_),r.addEventListener(Z(De),r.handleViewChanged_),r.addEventListener(Z(we),r.handleSizeChanged_),r.addEventListener(Z(Se),r.handleTargetChanged_),r.setProperties(i.values),r.controls.forEach(function(e){e.setMap(this)}.bind(r)),r.controls.addEventListener(u,function(e){e.element.setMap(this)}.bind(r)),r.controls.addEventListener(c,function(e){e.element.setMap(null)}.bind(r)),r.interactions.forEach(function(e){e.setMap(this)}.bind(r)),r.interactions.addEventListener(u,function(e){e.element.setMap(this)}.bind(r)),r.interactions.addEventListener(c,function(e){e.element.setMap(null)}.bind(r)),r.overlays_.forEach(r.addOverlayInternal_.bind(r)),r.overlays_.addEventListener(u,function(e){this.addOverlayInternal_(e.element)}.bind(r)),r.overlays_.addEventListener(c,function(e){var t=e.element.getId();void 0!==t&&delete this.overlayIdIndex_[t.toString()],e.element.setMap(null)}.bind(r)),r}return ho(t,e),t.prototype.createRenderer=function(){throw new Error("Use a map type that has a createRenderer method")},t.prototype.addControl=function(e){this.getControls().push(e)},t.prototype.addInteraction=function(e){this.getInteractions().push(e)},t.prototype.addLayer=function(e){this.getLayerGroup().getLayers().push(e)},t.prototype.addOverlay=function(e){this.getOverlays().push(e)},t.prototype.addOverlayInternal_=function(e){var t=e.getId();void 0!==t&&(this.overlayIdIndex_[t.toString()]=e),e.setMap(this)},t.prototype.disposeInternal=function(){this.mapBrowserEventHandler_.dispose(),this.viewport_.removeEventListener(B,this.boundHandleBrowserEvent_),this.viewport_.removeEventListener(j,this.boundHandleBrowserEvent_),void 0!==this.handleResize_&&(removeEventListener(V,this.handleResize_,!1),this.handleResize_=void 0),this.setTarget(null),e.prototype.disposeInternal.call(this)},t.prototype.forEachFeatureAtPixel=function(e,t,r){if(this.frameState_){var i=this.getCoordinateFromPixelInternal(e),o=void 0!==(r=void 0!==r?r:{}).hitTolerance?r.hitTolerance*this.frameState_.pixelRatio:0,n=void 0!==r.layerFilter?r.layerFilter:A,a=!1!==r.checkWrapped;return this.renderer_.forEachFeatureAtCoordinate(i,this.frameState_,o,a,t,null,n,null)}},t.prototype.getFeaturesAtPixel=function(e,t){var r=[];return this.forEachFeatureAtPixel(e,function(e){r.push(e)},t),r},t.prototype.forEachLayerAtPixel=function(e,t,r){if(this.frameState_){var i=r||{},o=void 0!==i.hitTolerance?i.hitTolerance*this.frameState_.pixelRatio:0,n=i.layerFilter||A;return this.renderer_.forEachLayerAtPixel(e,this.frameState_,o,t,n)}},t.prototype.hasFeatureAtPixel=function(e,t){if(!this.frameState_)return!1;var r=this.getCoordinateFromPixelInternal(e),i=void 0!==(t=void 0!==t?t:{}).layerFilter?t.layerFilter:A,o=void 0!==t.hitTolerance?t.hitTolerance*this.frameState_.pixelRatio:0,n=!1!==t.checkWrapped;return this.renderer_.hasFeatureAtCoordinate(r,this.frameState_,o,n,i,null)},t.prototype.getEventCoordinate=function(e){return this.getCoordinateFromPixel(this.getEventPixel(e))},t.prototype.getEventCoordinateInternal=function(e){return this.getCoordinateFromPixelInternal(this.getEventPixel(e))},t.prototype.getEventPixel=function(e){var t=this.viewport_.getBoundingClientRect(),r="changedTouches"in e?e.changedTouches[0]:e;return[r.clientX-t.left,r.clientY-t.top]},t.prototype.getTarget=function(){return this.get(Se)},t.prototype.getTargetElement=function(){var e=this.getTarget();return void 0!==e?"string"==typeof e?document.getElementById(e):e:null},t.prototype.getCoordinateFromPixel=function(e){return jr(this.getCoordinateFromPixelInternal(e),this.getView().getProjection())},t.prototype.getCoordinateFromPixelInternal=function(e){var t=this.frameState_;return t?qr(t.pixelToCoordinateTransform,e.slice()):null},t.prototype.getControls=function(){return this.controls},t.prototype.getOverlays=function(){return this.overlays_},t.prototype.getOverlayById=function(e){var t=this.overlayIdIndex_[e.toString()];return void 0!==t?t:null},t.prototype.getInteractions=function(){return this.interactions},t.prototype.getLayerGroup=function(){return this.get(Le)},t.prototype.getLayers=function(){return this.getLayerGroup().getLayers()},t.prototype.getLoading=function(){for(var e=this.getLayerGroup().getLayerStatesArray(),t=0,r=e.length;t<r;++t){var i=e[t].layer.getSource();if(i&&i.loading)return!0}return!1},t.prototype.getPixelFromCoordinate=function(e){var t=Wr(e,this.getView().getProjection());return this.getPixelFromCoordinateInternal(t)},t.prototype.getPixelFromCoordinateInternal=function(e){var t=this.frameState_;return t?qr(t.coordinateToPixelTransform,e.slice(0,2)):null},t.prototype.getRenderer=function(){return this.renderer_},t.prototype.getSize=function(){return this.get(we)},t.prototype.getView=function(){return this.get(De)},t.prototype.getViewport=function(){return this.viewport_},t.prototype.getOverlayContainer=function(){return this.overlayContainer_},t.prototype.getOverlayContainerStopEvent=function(){return this.overlayContainerStopEvent_},t.prototype.getTilePriority=function(e,t,r,i){return function(e,t,r,i,o){if(!(e&&r in e.wantedTiles))return 1/0;if(!e.wantedTiles[r][t.getKey()])return 1/0;var n=e.viewState.center,a=i[0]-n[0],s=i[1]-n[1];return 65536*Math.log(o)+Math.sqrt(a*a+s*s)/o}(this.frameState_,e,t,r,i)},t.prototype.handleBrowserEvent=function(e,t){var r=t||e.type,i=new ce(r,this,e);this.handleMapBrowserEvent(i)},t.prototype.handleMapBrowserEvent=function(e){if(this.frameState_){var t=e.originalEvent.target;if(e.dragging||!this.overlayContainerStopEvent_.contains(t)&&(document.body.contains(t)||this.viewport_.getRootNode&&this.viewport_.getRootNode().contains(t))){e.frameState=this.frameState_;var r=this.getInteractions().getArray();if(!1!==this.dispatchEvent(e))for(var i=r.length-1;i>=0;i--){var o=r[i];if(o.getActive()&&!o.handleEvent(e))break}}}},t.prototype.handlePostRender=function(){var e=this.frameState_,t=this.tileQueue_;if(!t.isEmpty()){var r=this.maxTilesLoading_,i=r;if(e){var o=e.viewHints;if(o[0]||o[1]){var n=!ve&&Date.now()-e.time>8;r=n?0:8,i=n?0:2}}t.getTilesLoading()<r&&(t.reprioritize(),t.loadMoreTiles(r,i))}!e||!this.hasListener(Pe)||e.animate||this.tileQueue_.getTilesLoading()||this.getLoading()||this.renderer_.dispatchRenderEvent(Pe,e);for(var a=this.postRenderFunctions_,s=0,l=a.length;s<l;++s)a[s](this,e);a.length=0},t.prototype.handleSizeChanged_=function(){this.getView()&&this.getView().resolveConstraints(0),this.render()},t.prototype.handleTargetChanged_=function(){var e;if(this.getTarget()&&(e=this.getTargetElement()),this.keyHandlerKeys_){for(var t=0,r=this.keyHandlerKeys_.length;t<r;++t)x(this.keyHandlerKeys_[t]);this.keyHandlerKeys_=null}if(e){e.appendChild(this.viewport_),this.renderer_||(this.renderer_=this.createRenderer());var i=this.keyboardEventTarget_?this.keyboardEventTarget_:e;this.keyHandlerKeys_=[m(i,U,this.handleBrowserEvent,this),m(i,G,this.handleBrowserEvent,this)],this.handleResize_||(this.handleResize_=this.updateSize.bind(this),window.addEventListener(V,this.handleResize_,!1))}else this.renderer_&&(clearTimeout(this.postRenderTimeoutHandle_),this.postRenderFunctions_.length=0,this.renderer_.dispose(),this.renderer_=null),this.animationDelayKey_&&(cancelAnimationFrame(this.animationDelayKey_),this.animationDelayKey_=void 0),Hi(this.viewport_),void 0!==this.handleResize_&&(removeEventListener(V,this.handleResize_,!1),this.handleResize_=void 0);this.updateSize()},t.prototype.handleTileChange_=function(){this.render()},t.prototype.handleViewPropertyChanged_=function(){this.render()},t.prototype.handleViewChanged_=function(){this.viewPropertyListenerKey_&&(x(this.viewPropertyListenerKey_),this.viewPropertyListenerKey_=null),this.viewChangeListenerKey_&&(x(this.viewChangeListenerKey_),this.viewChangeListenerKey_=null);var e=this.getView();e&&(this.updateViewportSize_(),this.viewPropertyListenerKey_=m(e,d,this.handleViewPropertyChanged_,this),this.viewChangeListenerKey_=m(e,F,this.handleViewPropertyChanged_,this),e.resolveConstraints(0)),this.render()},t.prototype.handleLayerGroupChanged_=function(){this.layerGroupPropertyListenerKeys_&&(this.layerGroupPropertyListenerKeys_.forEach(x),this.layerGroupPropertyListenerKeys_=null);var e=this.getLayerGroup();e&&(this.layerGroupPropertyListenerKeys_=[m(e,d,this.render,this),m(e,F,this.render,this)]),this.render()},t.prototype.isRendered=function(){return!!this.frameState_},t.prototype.renderSync=function(){this.animationDelayKey_&&cancelAnimationFrame(this.animationDelayKey_),this.animationDelay_()},t.prototype.redrawText=function(){for(var e=this.getLayerGroup().getLayerStatesArray(),t=0,r=e.length;t<r;++t){var i=e[t].layer;i.hasRenderer()&&i.getRenderer().handleFontsChanged()}},t.prototype.render=function(){this.renderer_&&void 0===this.animationDelayKey_&&(this.animationDelayKey_=requestAnimationFrame(this.animationDelay_))},t.prototype.removeControl=function(e){return this.getControls().remove(e)},t.prototype.removeInteraction=function(e){return this.getInteractions().remove(e)},t.prototype.removeLayer=function(e){return this.getLayerGroup().getLayers().remove(e)},t.prototype.removeOverlay=function(e){return this.getOverlays().remove(e)},t.prototype.renderFrame_=function(e){var t=this.getSize(),r=this.getView(),i=this.frameState_,o=null;if(void 0!==t&&function(e){return e[0]>0&&e[1]>0}(t)&&r&&r.isDef()){var n=r.getHints(this.frameState_?this.frameState_.viewHints:void 0),a=r.getState();o={animate:!1,coordinateToPixelTransform:this.coordinateToPixelTransform_,declutterItems:i?i.declutterItems:[],extent:Mt(a.center,a.resolution,a.rotation,t),index:this.frameIndex_++,layerIndex:0,layerStatesArray:this.getLayerGroup().getLayerStatesArray(),pixelRatio:this.pixelRatio_,pixelToCoordinateTransform:this.pixelToCoordinateTransform_,postRenderFunctions:[],size:t,tileQueue:this.tileQueue_,time:e,usedTiles:{},viewState:a,viewHints:n,wantedTiles:{}}}this.frameState_=o,this.renderer_.renderFrame(o),o&&(o.animate&&this.render(),Array.prototype.push.apply(this.postRenderFunctions_,o.postRenderFunctions),i&&(!this.previousExtent_||!Rt(this.previousExtent_)&&!pt(o.extent,this.previousExtent_))&&(this.dispatchEvent(new le("movestart",this,i)),this.previousExtent_=gt(this.previousExtent_)),this.previousExtent_&&!o.viewHints[0]&&!o.viewHints[1]&&!pt(o.extent,this.previousExtent_)&&(this.dispatchEvent(new le("moveend",this,o)),st(o.extent,this.previousExtent_))),this.dispatchEvent(new le(Ee,this,o)),this.postRenderTimeoutHandle_=setTimeout(this.handlePostRender.bind(this),0)},t.prototype.setLayerGroup=function(e){this.set(Le,e)},t.prototype.setSize=function(e){this.set(we,e)},t.prototype.setTarget=function(e){this.set(Se,e)},t.prototype.setView=function(e){this.set(De,e)},t.prototype.updateSize=function(){var e=this.getTargetElement();if(e){var t=getComputedStyle(e);this.setSize([e.offsetWidth-parseFloat(t.borderLeftWidth)-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight)-parseFloat(t.borderRightWidth),e.offsetHeight-parseFloat(t.borderTopWidth)-parseFloat(t.paddingTop)-parseFloat(t.paddingBottom)-parseFloat(t.borderBottomWidth)])}else this.setSize(void 0);this.updateViewportSize_()},t.prototype.updateViewportSize_=function(){var e=this.getView();if(e){var t=void 0,r=getComputedStyle(this.viewport_);r.width&&r.height&&(t=[parseInt(r.width,10),parseInt(r.height,10)]),e.setViewportSize(t)}},t}(re),go=(co=function(e,t){return(co=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}co(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),po=function(e){function t(t){var r=e.call(this)||this;return r.element=t.element?t.element:null,r.target_=null,r.map_=null,r.listenerKeys=[],r.render_=t.render?t.render:L,t.target&&r.setTarget(t.target),r}return go(t,e),t.prototype.disposeInternal=function(){Hi(this.element),e.prototype.disposeInternal.call(this)},t.prototype.getMap=function(){return this.map_},t.prototype.setMap=function(e){this.map_&&Hi(this.element);for(var t=0,r=this.listenerKeys.length;t<r;++t)x(this.listenerKeys[t]);this.listenerKeys.length=0,this.map_=e,this.map_&&((this.target_?this.target_:e.getOverlayContainerStopEvent()).appendChild(this.element),this.render!==L&&this.listenerKeys.push(m(e,Ee,this.render,this)),e.render())},t.prototype.render=function(e){this.render_.call(this,e)},t.prototype.setTarget=function(e){this.target_="string"==typeof e?document.getElementById(e):e},t}(re),mo=new RegExp(["^\\s*(?=(?:(?:[-a-z]+\\s*){0,2}(italic|oblique))?)","(?=(?:(?:[-a-z]+\\s*){0,2}(small-caps))?)","(?=(?:(?:[-a-z]+\\s*){0,2}(bold(?:er)?|lighter|[1-9]00 ))?)","(?:(?:normal|\\1|\\2|\\3)\\s*){0,3}((?:xx?-)?","(?:small|large)|medium|smaller|larger|[\\.\\d]+(?:\\%|in|[cem]m|ex|p[ctx]))","(?:\\s*\\/\\s*(normal|[\\.\\d]+(?:\\%|in|[cem]m|ex|p[ctx])?))","?\\s*([-,\\\"\\'\\sa-z]+?)\\s*$"].join(""),"i"),vo=["style","variant","weight","size","lineHeight","family"],xo=function(e){var t=e.match(mo);if(!t)return null;for(var r={lineHeight:"normal",size:"1.2em",style:"normal",weight:"normal",variant:"normal"},i=0,o=vo.length;i<o;++i){var n=t[i+1];void 0!==n&&(r[vo[i]]=n)}return r.families=r.family.split(/,\s?/),r},_o=(uo=function(e,t){return(uo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}uo(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function yo(e,t){if(!e.visible)return!1;var r=t.resolution;if(r<e.minResolution||r>=e.maxResolution)return!1;var i=t.zoom;return i>e.minZoom&&i<=e.maxZoom}var To,Co=function(e){function t(t){var r=this,i=h({},t);delete i.source,(r=e.call(this,i)||this).mapPrecomposeKey_=null,r.mapRenderKey_=null,r.sourceChangeKey_=null,r.renderer_=null,t.render&&(r.render=t.render),t.map&&r.setMap(t.map),r.addEventListener(Z(Ji),r.handleSourcePropertyChange_);var o=t.source?t.source:null;return r.setSource(o),r}return _o(t,e),t.prototype.getLayersArray=function(e){var t=e||[];return t.push(this),t},t.prototype.getLayerStatesArray=function(e){var t=e||[];return t.push(this.getLayerState()),t},t.prototype.getSource=function(){return this.get(Ji)||null},t.prototype.getSourceState=function(){var e=this.getSource();return e?e.getState():eo},t.prototype.handleSourceChange_=function(){this.changed()},t.prototype.handleSourcePropertyChange_=function(){this.sourceChangeKey_&&(x(this.sourceChangeKey_),this.sourceChangeKey_=null);var e=this.getSource();e&&(this.sourceChangeKey_=m(e,F,this.handleSourceChange_,this)),this.changed()},t.prototype.getFeatures=function(e){return this.renderer_.getFeatures(e)},t.prototype.render=function(e,t){var r=this.getRenderer();if(r.prepareFrame(e))return r.renderFrame(e,t)},t.prototype.setMap=function(e){this.mapPrecomposeKey_&&(x(this.mapPrecomposeKey_),this.mapPrecomposeKey_=null),e||this.changed(),this.mapRenderKey_&&(x(this.mapRenderKey_),this.mapRenderKey_=null),e&&(this.mapPrecomposeKey_=m(e,Re,function(e){var t=e.frameState.layerStatesArray,r=this.getLayerState(!1);Oe(!t.some(function(e){return e.layer===r.layer}),67),t.push(r)},this),this.mapRenderKey_=m(this,F,e.render,e),this.changed())},t.prototype.setSource=function(e){this.set(Ji,e)},t.prototype.getRenderer=function(){return this.renderer_||(this.renderer_=this.createRenderer()),this.renderer_},t.prototype.hasRenderer=function(){return!!this.renderer_},t.prototype.createRenderer=function(){return null},t.prototype.disposeInternal=function(){this.setSource(null),e.prototype.disposeInternal.call(this)},t}($i),bo=(To=function(e,t){return(To=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}To(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Mo(e){this.updateElement_(e.frameState)}var Ao,Eo=function(e){function t(t){var r=this,i=t||{};(r=e.call(this,{element:document.createElement("div"),render:i.render||Mo,target:i.target})||this).ulElement_=document.createElement("ul"),r.collapsed_=void 0===i.collapsed||i.collapsed,r.overrideCollapsible_=void 0!==i.collapsible,r.collapsible_=void 0===i.collapsible||i.collapsible,r.collapsible_||(r.collapsed_=!1);var o=void 0!==i.className?i.className:"ol-attribution",n=void 0!==i.tipLabel?i.tipLabel:"Attributions",a=void 0!==i.collapseLabel?i.collapseLabel:"»";"string"==typeof a?(r.collapseLabel_=document.createElement("span"),r.collapseLabel_.textContent=a):r.collapseLabel_=a;var s=void 0!==i.label?i.label:"i";"string"==typeof s?(r.label_=document.createElement("span"),r.label_.textContent=s):r.label_=s;var l=r.collapsible_&&!r.collapsed_?r.collapseLabel_:r.label_,u=document.createElement("button");u.setAttribute("type","button"),u.title=n,u.appendChild(l),u.addEventListener(N,r.handleClick_.bind(r),!1);var c=o+" ol-unselectable ol-control"+(r.collapsed_&&r.collapsible_?" ol-collapsed":"")+(r.collapsible_?"":" ol-uncollapsible"),d=r.element;return d.className=c,d.appendChild(r.ulElement_),d.appendChild(u),r.renderedAttributions_=[],r.renderedVisible_=!0,r}return bo(t,e),t.prototype.collectSourceAttributions_=function(e){for(var t={},r=[],i=e.layerStatesArray,o=0,n=i.length;o<n;++o){var a=i[o];if(yo(a,e.viewState)){var s=a.layer.getSource();if(s){var l=s.getAttributions();if(l){var u=l(e);if(u)if(this.overrideCollapsible_||!1!==s.getAttributionsCollapsible()||this.setCollapsible(!1),Array.isArray(u))for(var c=0,d=u.length;c<d;++c)u[c]in t||(r.push(u[c]),t[u[c]]=!0);else u in t||(r.push(u),t[u]=!0)}}}}return r},t.prototype.updateElement_=function(e){if(e){var t=this.collectSourceAttributions_(e),r=t.length>0;if(this.renderedVisible_!=r&&(this.element.style.display=r?"":"none",this.renderedVisible_=r),!M(t,this.renderedAttributions_)){!function(e){for(;e.lastChild;)e.removeChild(e.lastChild)}(this.ulElement_);for(var i=0,o=t.length;i<o;++i){var n=document.createElement("li");n.innerHTML=t[i],this.ulElement_.appendChild(n)}this.renderedAttributions_=t}}else this.renderedVisible_&&(this.element.style.display="none",this.renderedVisible_=!1)},t.prototype.handleClick_=function(e){e.preventDefault(),this.handleToggle_()},t.prototype.handleToggle_=function(){this.element.classList.toggle("ol-collapsed"),this.collapsed_?zi(this.collapseLabel_,this.label_):zi(this.label_,this.collapseLabel_),this.collapsed_=!this.collapsed_},t.prototype.getCollapsible=function(){return this.collapsible_},t.prototype.setCollapsible=function(e){this.collapsible_!==e&&(this.collapsible_=e,this.element.classList.toggle("ol-uncollapsible"),!e&&this.collapsed_&&this.handleToggle_())},t.prototype.setCollapsed=function(e){this.collapsible_&&this.collapsed_!==e&&this.handleToggle_()},t.prototype.getCollapsed=function(){return this.collapsed_},t}(po),Lo=(Ao=function(e,t){return(Ao=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Ao(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function wo(e){var t=e.frameState;if(t){var r=t.viewState.rotation;if(r!=this.rotation_){var i="rotate("+r+"rad)";if(this.autoHide_){var o=this.element.classList.contains("ol-hidden");o||0!==r?o&&0!==r&&this.element.classList.remove("ol-hidden"):this.element.classList.add("ol-hidden")}this.label_.style.transform=i}this.rotation_=r}}var So,Do=function(e){function t(t){var r=this,i=t||{};r=e.call(this,{element:document.createElement("div"),render:i.render||wo,target:i.target})||this;var o=void 0!==i.className?i.className:"ol-rotate",n=void 0!==i.label?i.label:"⇧";r.label_=null,"string"==typeof n?(r.label_=document.createElement("span"),r.label_.className="ol-compass",r.label_.textContent=n):(r.label_=n,r.label_.classList.add("ol-compass"));var a=i.tipLabel?i.tipLabel:"Reset rotation",s=document.createElement("button");s.className=o+"-reset",s.setAttribute("type","button"),s.title=a,s.appendChild(r.label_),s.addEventListener(N,r.handleClick_.bind(r),!1);var l=o+" ol-unselectable ol-control",u=r.element;return u.className=l,u.appendChild(s),r.callResetNorth_=i.resetNorth?i.resetNorth:void 0,r.duration_=void 0!==i.duration?i.duration:250,r.autoHide_=void 0===i.autoHide||i.autoHide,r.rotation_=void 0,r.autoHide_&&r.element.classList.add("ol-hidden"),r}return Lo(t,e),t.prototype.handleClick_=function(e){e.preventDefault(),void 0!==this.callResetNorth_?this.callResetNorth_():this.resetNorth_()},t.prototype.resetNorth_=function(){var e=this.getMap().getView();if(e){var t=e.getRotation();void 0!==t&&(this.duration_>0&&t%(2*Math.PI)!=0?e.animate({rotation:0,duration:this.duration_,easing:jt}):e.setRotation(0))}},t}(po),Ro=(So=function(e,t){return(So=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}So(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Po=function(e){function t(t){var r=this,i=t||{};r=e.call(this,{element:document.createElement("div"),target:i.target})||this;var o=void 0!==i.className?i.className:"ol-zoom",n=void 0!==i.delta?i.delta:1,a=void 0!==i.zoomInLabel?i.zoomInLabel:"+",s=void 0!==i.zoomOutLabel?i.zoomOutLabel:"−",l=void 0!==i.zoomInTipLabel?i.zoomInTipLabel:"Zoom in",u=void 0!==i.zoomOutTipLabel?i.zoomOutTipLabel:"Zoom out",c=document.createElement("button");c.className=o+"-in",c.setAttribute("type","button"),c.title=l,c.appendChild("string"==typeof a?document.createTextNode(a):a),c.addEventListener(N,r.handleClick_.bind(r,n),!1);var d=document.createElement("button");d.className=o+"-out",d.setAttribute("type","button"),d.title=u,d.appendChild("string"==typeof s?document.createTextNode(s):s),d.addEventListener(N,r.handleClick_.bind(r,-n),!1);var h=o+" ol-unselectable ol-control",f=r.element;return f.className=h,f.appendChild(c),f.appendChild(d),r.duration_=void 0!==i.duration?i.duration:250,r}return Ro(t,e),t.prototype.handleClick_=function(e,t){t.preventDefault(),this.zoomByDelta_(e)},t.prototype.zoomByDelta_=function(e){var t=this.getMap().getView();if(t){var r=t.getZoom();if(void 0!==r){var i=t.getConstrainedZoom(r+e);this.duration_>0?(t.getAnimating()&&t.cancelAnimations(),t.animate({zoom:i,duration:this.duration_,easing:jt})):t.setZoom(i)}}},t}(po);function Io(e){var t=e||{},r=new ae;return(void 0===t.zoom||t.zoom)&&r.push(new Po(t.zoomOptions)),(void 0===t.rotate||t.rotate)&&r.push(new Do(t.rotateOptions)),(void 0===t.attribution||t.attribution)&&r.push(new Eo(t.attributionOptions)),r}var Fo,Oo=function(){function e(e,t,r){this.decay_=e,this.minVelocity_=t,this.delay_=r,this.points_=[],this.angle_=0,this.initialVelocity_=0}return e.prototype.begin=function(){this.points_.length=0,this.angle_=0,this.initialVelocity_=0},e.prototype.update=function(e,t){this.points_.push(e,t,Date.now())},e.prototype.end=function(){if(this.points_.length<6)return!1;var e=Date.now()-this.delay_,t=this.points_.length-3;if(this.points_[t+2]<e)return!1;for(var r=t-3;r>0&&this.points_[r+2]>e;)r-=3;var i=this.points_[t+2]-this.points_[r+2];if(i<1e3/60)return!1;var o=this.points_[t]-this.points_[r],n=this.points_[t+1]-this.points_[r+1];return this.angle_=Math.atan2(n,o),this.initialVelocity_=Math.sqrt(o*o+n*n)/i,this.initialVelocity_>this.minVelocity_},e.prototype.getDistance=function(){return(this.minVelocity_-this.initialVelocity_)/this.decay_},e.prototype.getAngle=function(){return this.angle_},e}(),Bo=(Fo=function(e,t){return(Fo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Fo(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function No(e,t,r,i){var o=e.getZoom();if(void 0!==o){var n=e.getConstrainedZoom(o+t),a=e.getResolutionForZoom(n);e.getAnimating()&&e.cancelAnimations(),e.animate({resolution:a,anchor:r,duration:void 0!==i?i:250,easing:jt})}}var Uo,Go=function(e){function t(t){var r=e.call(this)||this;return t.handleEvent&&(r.handleEvent=t.handleEvent),r.map_=null,r.setActive(!0),r}return Bo(t,e),t.prototype.getActive=function(){return this.get("active")},t.prototype.getMap=function(){return this.map_},t.prototype.handleEvent=function(e){return!0},t.prototype.setActive=function(e){this.set("active",e)},t.prototype.setMap=function(e){this.map_=e},t}(re),zo=(Uo=function(e,t){return(Uo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Uo(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Ho(e){var t=!1;if(e.type==_e.DBLCLICK){var r=e.originalEvent,i=e.map,o=e.coordinate,n=r.shiftKey?-this.delta_:this.delta_;No(i.getView(),n,o,this.duration_),e.preventDefault(),t=!0}return!t}var Vo,ko=function(e){function t(t){var r=e.call(this,{handleEvent:Ho})||this,i=t||{};return r.delta_=i.delta?i.delta:1,r.duration_=void 0!==i.duration?i.duration:250,r}return zo(t,e),t}(Go),jo=function(e){var t=e.originalEvent;return t.altKey&&!(t.metaKey||t.ctrlKey)&&t.shiftKey},Wo=function(e){return e.target.getTargetElement()===document.activeElement},Xo=A,Yo=function(e){var t=e.originalEvent;return 0==t.button&&!(fe&&ge&&t.ctrlKey)},qo=function(e){var t=e.originalEvent;return!t.altKey&&!(t.metaKey||t.ctrlKey)&&!t.shiftKey},Ko=function(e){var t=e.originalEvent;return!t.altKey&&!(t.metaKey||t.ctrlKey)&&t.shiftKey},Zo=function(e){var t=e.originalEvent.target.tagName;return"INPUT"!==t&&"SELECT"!==t&&"TEXTAREA"!==t},Jo=function(e){var t=e.pointerEvent;return Oe(void 0!==t,56),"mouse"==t.pointerType},Qo=(Vo=function(e,t){return(Vo=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Vo(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function $o(e){for(var t=e.length,r=0,i=0,o=0;o<t;o++)r+=e[o].clientX,i+=e[o].clientY;return[r/t,i/t]}var en,tn=function(e){function t(t){var r=this,i=t||{};return r=e.call(this,i)||this,i.handleDownEvent&&(r.handleDownEvent=i.handleDownEvent),i.handleDragEvent&&(r.handleDragEvent=i.handleDragEvent),i.handleMoveEvent&&(r.handleMoveEvent=i.handleMoveEvent),i.handleUpEvent&&(r.handleUpEvent=i.handleUpEvent),i.stopDown&&(r.stopDown=i.stopDown),r.handlingDownUpSequence=!1,r.trackedPointers_={},r.targetPointers=[],r}return Qo(t,e),t.prototype.getPointerCount=function(){return this.targetPointers.length},t.prototype.handleDownEvent=function(e){return!1},t.prototype.handleDragEvent=function(e){},t.prototype.handleEvent=function(e){if(!e.pointerEvent)return!0;var t=!1;if(this.updateTrackedPointers_(e),this.handlingDownUpSequence){if(e.type==_e.POINTERDRAG)this.handleDragEvent(e);else if(e.type==_e.POINTERUP){var r=this.handleUpEvent(e);this.handlingDownUpSequence=r&&this.targetPointers.length>0}}else if(e.type==_e.POINTERDOWN){var i=this.handleDownEvent(e);this.handlingDownUpSequence=i,t=this.stopDown(i)}else e.type==_e.POINTERMOVE&&this.handleMoveEvent(e);return!t},t.prototype.handleMoveEvent=function(e){},t.prototype.handleUpEvent=function(e){return!1},t.prototype.stopDown=function(e){return e},t.prototype.updateTrackedPointers_=function(e){if(function(e){var t=e.type;return t===_e.POINTERDOWN||t===_e.POINTERDRAG||t===_e.POINTERUP}(e)){var t=e.pointerEvent,r=t.pointerId.toString();e.type==_e.POINTERUP?delete this.trackedPointers_[r]:(e.type==_e.POINTERDOWN||r in this.trackedPointers_)&&(this.trackedPointers_[r]=t),this.targetPointers=g(this.trackedPointers_)}},t}(Go),rn=(en=function(e,t){return(en=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}en(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function on(e){return qo(e)&&function(e){var t=e.pointerEvent;return Oe(void 0!==t,56),t.isPrimary&&0===t.button}(e)}var nn,an,sn,ln,un=function(e){function t(t){var r=e.call(this,{stopDown:E})||this,i=t||{};return r.kinetic_=i.kinetic,r.lastCentroid=null,r.lastPointersCount_,r.panning_=!1,r.condition_=i.condition?i.condition:on,r.noKinetic_=!1,r}return rn(t,e),t.prototype.conditionInternal_=function(e){var t=!0;return e.map.getTargetElement().hasAttribute("tabindex")&&(t=Wo(e)),t&&this.condition_(e)},t.prototype.handleDragEvent=function(e){this.panning_||(this.panning_=!0,this.getMap().getView().beginInteraction());var t,r,i=this.targetPointers,o=$o(i);if(i.length==this.lastPointersCount_){if(this.kinetic_&&this.kinetic_.update(o[0],o[1]),this.lastCentroid){var n=[this.lastCentroid[0]-o[0],o[1]-this.lastCentroid[1]],a=e.map.getView();t=n,r=a.getResolution(),t[0]*=r,t[1]*=r,Ht(n,a.getRotation()),a.adjustCenterInternal(n)}}else this.kinetic_&&this.kinetic_.begin();this.lastCentroid=o,this.lastPointersCount_=i.length,e.originalEvent.preventDefault()},t.prototype.handleUpEvent=function(e){var t=e.map,r=t.getView();if(0===this.targetPointers.length){if(!this.noKinetic_&&this.kinetic_&&this.kinetic_.end()){var i=this.kinetic_.getDistance(),o=this.kinetic_.getAngle(),n=r.getCenterInternal(),a=t.getPixelFromCoordinateInternal(n),s=t.getCoordinateFromPixelInternal([a[0]-i*Math.cos(o),a[1]-i*Math.sin(o)]);r.animateInternal({center:r.getConstrainedCenter(s),duration:500,easing:jt})}return this.panning_&&(this.panning_=!1,r.endInteraction()),!1}return this.kinetic_&&this.kinetic_.begin(),this.lastCentroid=null,!0},t.prototype.handleDownEvent=function(e){if(this.targetPointers.length>0&&this.conditionInternal_(e)){var t=e.map.getView();return this.lastCentroid=null,t.getAnimating()&&t.cancelAnimations(),this.kinetic_&&this.kinetic_.begin(),this.noKinetic_=this.targetPointers.length>1,!0}return!1},t}(tn),cn=(ln=function(e,t){return(ln=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}ln(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),dn=function(e){function t(t){var r=this,i=t||{};return(r=e.call(this,{stopDown:E})||this).condition_=i.condition?i.condition:jo,r.lastAngle_=void 0,r.duration_=void 0!==i.duration?i.duration:250,r}return cn(t,e),t.prototype.handleDragEvent=function(e){if(Jo(e)){var t=e.map,r=t.getView();if(r.getConstraints().rotation!==Ot){var i=t.getSize(),o=e.pixel,n=Math.atan2(i[1]/2-o[1],o[0]-i[0]/2);if(void 0!==this.lastAngle_){var a=n-this.lastAngle_;r.adjustRotationInternal(-a)}this.lastAngle_=n}}},t.prototype.handleUpEvent=function(e){return!Jo(e)||(e.map.getView().endInteraction(this.duration_),!1)},t.prototype.handleDownEvent=function(e){return!!Jo(e)&&!(!Yo(e)||!this.condition_(e))&&(e.map.getView().beginInteraction(),this.lastAngle_=void 0,!0)},t}(tn),hn=(sn=function(e,t){return(sn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}sn(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),fn=function(e){function t(t){var r=e.call(this)||this;return r.geometry_=null,r.element_=document.createElement("div"),r.element_.style.position="absolute",r.element_.className="ol-box "+t,r.map_=null,r.startPixel_=null,r.endPixel_=null,r}return hn(t,e),t.prototype.disposeInternal=function(){this.setMap(null)},t.prototype.render_=function(){var e=this.startPixel_,t=this.endPixel_,r=this.element_.style;r.left=Math.min(e[0],t[0])+"px",r.top=Math.min(e[1],t[1])+"px",r.width=Math.abs(t[0]-e[0])+"px",r.height=Math.abs(t[1]-e[1])+"px"},t.prototype.setMap=function(e){if(this.map_){this.map_.getOverlayContainer().removeChild(this.element_);var t=this.element_.style;t.left="inherit",t.top="inherit",t.width="inherit",t.height="inherit"}this.map_=e,this.map_&&this.map_.getOverlayContainer().appendChild(this.element_)},t.prototype.setPixels=function(e,t){this.startPixel_=e,this.endPixel_=t,this.createOrUpdateGeometry(),this.render_()},t.prototype.createOrUpdateGeometry=function(){var e=this.startPixel_,t=this.endPixel_,r=[e,[e[0],t[1]],t,[t[0],e[1]]].map(this.map_.getCoordinateFromPixelInternal,this.map_);r[4]=r[0].slice(),this.geometry_?this.geometry_.setCoordinates([r]):this.geometry_=new Pi([r])},t.prototype.getGeometry=function(){return this.geometry_},t}(_),gn=(an=function(e,t){return(an=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}an(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),pn=function(e){function t(t,r,i){var o=e.call(this,t)||this;return o.coordinate=r,o.mapBrowserEvent=i,o}return gn(t,e),t}(R),mn=function(e){function t(t){var r=e.call(this)||this,i=t||{};return r.box_=new fn(i.className||"ol-dragbox"),r.minArea_=void 0!==i.minArea?i.minArea:64,r.onBoxEnd_=i.onBoxEnd?i.onBoxEnd:L,r.startPixel_=null,r.condition_=i.condition?i.condition:Yo,r.boxEndCondition_=i.boxEndCondition?i.boxEndCondition:r.defaultBoxEndCondition,r}return gn(t,e),t.prototype.defaultBoxEndCondition=function(e,t,r){var i=r[0]-t[0],o=r[1]-t[1];return i*i+o*o>=this.minArea_},t.prototype.getGeometry=function(){return this.box_.getGeometry()},t.prototype.handleDragEvent=function(e){this.box_.setPixels(this.startPixel_,e.pixel),this.dispatchEvent(new pn("boxdrag",e.coordinate,e))},t.prototype.handleUpEvent=function(e){return this.box_.setMap(null),this.boxEndCondition_(e,this.startPixel_,e.pixel)&&(this.onBoxEnd_(e),this.dispatchEvent(new pn("boxend",e.coordinate,e))),!1},t.prototype.handleDownEvent=function(e){return!!this.condition_(e)&&(this.startPixel_=e.pixel,this.box_.setMap(e.map),this.box_.setPixels(this.startPixel_,this.startPixel_),this.dispatchEvent(new pn("boxstart",e.coordinate,e)),!0)},t}(tn),vn=(nn=function(e,t){return(nn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}nn(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function xn(){var e,t=this.getMap(),r=t.getView(),i=t.getSize(),o=this.getGeometry().getExtent();if(this.out_){var n=r.calculateExtentInternal(i),a=(e=[t.getPixelFromCoordinateInternal(Tt(o)),t.getPixelFromCoordinateInternal(wt(o))],function(e,t){for(var r=0,i=t.length;r<i;++r)vt(e,t[r]);return e}(gt(void 0),e));!function(e,t){var r=(e[2]-e[0])/2*(t-1),i=(e[3]-e[1])/2*(t-1);e[0]-=r,e[2]+=r,e[1]-=i,e[3]+=i}(n,1/r.getResolutionForExtentInternal(a,i)),o=n}var s=r.getConstrainedResolution(r.getResolutionForExtentInternal(o,i)),l=r.getConstrainedCenter(bt(o),s);r.animateInternal({resolution:s,center:l,duration:this.duration_,easing:jt})}var _n,yn=function(e){function t(t){var r=this,i=t||{},o=i.condition?i.condition:Ko;return(r=e.call(this,{condition:o,className:i.className||"ol-dragzoom",minArea:i.minArea,onBoxEnd:xn})||this).duration_=void 0!==i.duration?i.duration:200,r.out_=void 0!==i.out&&i.out,r}return vn(t,e),t}(mn),Tn=37,Cn=38,bn=39,Mn=40,An=(_n=function(e,t){return(_n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}_n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function En(e){var t=!1;if(e.type==U){var r=e.originalEvent.keyCode;if(this.condition_(e)&&(r==Mn||r==Tn||r==bn||r==Cn)){var i=e.map.getView(),o=i.getResolution()*this.pixelDelta_,n=0,a=0;r==Mn?a=-o:r==Tn?n=-o:r==bn?n=o:a=o;var s=[n,a];Ht(s,i.getRotation()),function(e,t,r){var i=e.getCenterInternal();if(i){var o=[i[0]+t[0],i[1]+t[1]];e.animateInternal({duration:void 0!==r?r:250,easing:Xt,center:e.getConstrainedCenter(o)})}}(i,s,this.duration_),e.preventDefault(),t=!0}}return!t}var Ln,wn=function(e){function t(t){var r=e.call(this,{handleEvent:En})||this,i=t||{};return r.defaultCondition_=function(e){return qo(e)&&Zo(e)},r.condition_=void 0!==i.condition?i.condition:r.defaultCondition_,r.duration_=void 0!==i.duration?i.duration:100,r.pixelDelta_=void 0!==i.pixelDelta?i.pixelDelta:128,r}return An(t,e),t}(Go),Sn=(Ln=function(e,t){return(Ln=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Ln(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Dn(e){var t=!1;if(e.type==U||e.type==G){var r=e.originalEvent.charCode;if(this.condition_(e)&&(r=="+".charCodeAt(0)||r=="-".charCodeAt(0))){var i=e.map,o=r=="+".charCodeAt(0)?this.delta_:-this.delta_;No(i.getView(),o,void 0,this.duration_),e.preventDefault(),t=!0}}return!t}var Rn,Pn,In,Fn=function(e){function t(t){var r=e.call(this,{handleEvent:Dn})||this,i=t||{};return r.condition_=i.condition?i.condition:Zo,r.delta_=i.delta?i.delta:1,r.duration_=void 0!==i.duration?i.duration:100,r}return Sn(t,e),t}(Go),On=(In=function(e,t){return(In=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}In(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Bn="trackpad",Nn=function(e){function t(t){var r=this,i=t||{};return(r=e.call(this,i)||this).totalDelta_=0,r.lastDelta_=0,r.maxDelta_=void 0!==i.maxDelta?i.maxDelta:1,r.duration_=void 0!==i.duration?i.duration:250,r.timeout_=void 0!==i.timeout?i.timeout:80,r.useAnchor_=void 0===i.useAnchor||i.useAnchor,r.condition_=i.condition?i.condition:Xo,r.lastAnchor_=null,r.startTime_=void 0,r.timeoutId_,r.mode_=void 0,r.trackpadEventGap_=400,r.trackpadTimeoutId_,r.deltaPerZoom_=300,r}return On(t,e),t.prototype.conditionInternal_=function(e){var t=!0;return e.map.getTargetElement().hasAttribute("tabindex")&&(t=Wo(e)),t&&this.condition_(e)},t.prototype.endInteraction_=function(){this.trackpadTimeoutId_=void 0,this.getMap().getView().endInteraction(void 0,this.lastDelta_?this.lastDelta_>0?1:-1:0,this.lastAnchor_)},t.prototype.handleEvent=function(e){if(!this.conditionInternal_(e))return!0;if(e.type!==j)return!0;e.preventDefault();var t,r=e.map,i=e.originalEvent;if(this.useAnchor_&&(this.lastAnchor_=e.coordinate),e.type==j&&(t=i.deltaY,he&&i.deltaMode===WheelEvent.DOM_DELTA_PIXEL&&(t/=pe),i.deltaMode===WheelEvent.DOM_DELTA_LINE&&(t*=40)),0===t)return!1;this.lastDelta_=t;var o=Date.now();void 0===this.startTime_&&(this.startTime_=o),(!this.mode_||o-this.startTime_>this.trackpadEventGap_)&&(this.mode_=Math.abs(t)<4?Bn:"wheel");var n=r.getView();if(this.mode_===Bn&&!n.getConstrainResolution())return this.trackpadTimeoutId_?clearTimeout(this.trackpadTimeoutId_):(n.getAnimating()&&n.cancelAnimations(),n.beginInteraction()),this.trackpadTimeoutId_=setTimeout(this.endInteraction_.bind(this),this.timeout_),n.adjustZoom(-t/this.deltaPerZoom_,this.lastAnchor_),this.startTime_=o,!1;this.totalDelta_+=t;var a=Math.max(this.timeout_-(o-this.startTime_),0);return clearTimeout(this.timeoutId_),this.timeoutId_=setTimeout(this.handleWheelZoom_.bind(this,r),a),!1},t.prototype.handleWheelZoom_=function(e){var t=e.getView();t.getAnimating()&&t.cancelAnimations();var r=-ze(this.totalDelta_,-this.maxDelta_*this.deltaPerZoom_,this.maxDelta_*this.deltaPerZoom_)/this.deltaPerZoom_;t.getConstrainResolution()&&(r=r?r>0?1:-1:0),No(t,r,this.lastAnchor_,this.duration_),this.mode_=void 0,this.totalDelta_=0,this.lastAnchor_=null,this.startTime_=void 0,this.timeoutId_=void 0},t.prototype.setMouseAnchor=function(e){this.useAnchor_=e,e||(this.lastAnchor_=null)},t}(Go),Un=(Pn=function(e,t){return(Pn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Pn(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Gn=function(e){function t(t){var r=this,i=t||{},o=i;return o.stopDown||(o.stopDown=E),(r=e.call(this,o)||this).anchor_=null,r.lastAngle_=void 0,r.rotating_=!1,r.rotationDelta_=0,r.threshold_=void 0!==i.threshold?i.threshold:.3,r.duration_=void 0!==i.duration?i.duration:250,r}return Un(t,e),t.prototype.handleDragEvent=function(e){var t=0,r=this.targetPointers[0],i=this.targetPointers[1],o=Math.atan2(i.clientY-r.clientY,i.clientX-r.clientX);if(void 0!==this.lastAngle_){var n=o-this.lastAngle_;this.rotationDelta_+=n,!this.rotating_&&Math.abs(this.rotationDelta_)>this.threshold_&&(this.rotating_=!0),t=n}this.lastAngle_=o;var a=e.map,s=a.getView();if(s.getConstraints().rotation!==Ot){var l=a.getViewport().getBoundingClientRect(),u=$o(this.targetPointers);u[0]-=l.left,u[1]-=l.top,this.anchor_=a.getCoordinateFromPixelInternal(u),this.rotating_&&(a.render(),s.adjustRotationInternal(t,this.anchor_))}},t.prototype.handleUpEvent=function(e){return!(this.targetPointers.length<2&&(e.map.getView().endInteraction(this.duration_),1))},t.prototype.handleDownEvent=function(e){if(this.targetPointers.length>=2){var t=e.map;return this.anchor_=null,this.lastAngle_=void 0,this.rotating_=!1,this.rotationDelta_=0,this.handlingDownUpSequence||t.getView().beginInteraction(),!0}return!1},t}(tn),zn=(Rn=function(e,t){return(Rn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Rn(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Hn=function(e){function t(t){var r=this,i=t||{},o=i;return o.stopDown||(o.stopDown=E),(r=e.call(this,o)||this).anchor_=null,r.duration_=void 0!==i.duration?i.duration:400,r.lastDistance_=void 0,r.lastScaleDelta_=1,r}return zn(t,e),t.prototype.handleDragEvent=function(e){var t=1,r=this.targetPointers[0],i=this.targetPointers[1],o=r.clientX-i.clientX,n=r.clientY-i.clientY,a=Math.sqrt(o*o+n*n);void 0!==this.lastDistance_&&(t=this.lastDistance_/a),this.lastDistance_=a;var s=e.map,l=s.getView();1!=t&&(this.lastScaleDelta_=t);var u=s.getViewport().getBoundingClientRect(),c=$o(this.targetPointers);c[0]-=u.left,c[1]-=u.top,this.anchor_=s.getCoordinateFromPixelInternal(c),s.render(),l.adjustResolutionInternal(t,this.anchor_)},t.prototype.handleUpEvent=function(e){if(this.targetPointers.length<2){var t=e.map.getView(),r=this.lastScaleDelta_>1?1:-1;return t.endInteraction(this.duration_,r),!1}return!0},t.prototype.handleDownEvent=function(e){if(this.targetPointers.length>=2){var t=e.map;return this.anchor_=null,this.lastDistance_=void 0,this.lastScaleDelta_=1,this.handlingDownUpSequence||t.getView().beginInteraction(),!0}return!1},t}(tn);function Vn(e){var t=e||{},r=new ae,i=new Oo(-.005,.05,100);return(void 0===t.altShiftDragRotate||t.altShiftDragRotate)&&r.push(new dn),(void 0===t.doubleClickZoom||t.doubleClickZoom)&&r.push(new ko({delta:t.zoomDelta,duration:t.zoomDuration})),(void 0===t.dragPan||t.dragPan)&&r.push(new un({condition:t.onFocusOnly?Wo:void 0,kinetic:i})),(void 0===t.pinchRotate||t.pinchRotate)&&r.push(new Gn),(void 0===t.pinchZoom||t.pinchZoom)&&r.push(new Hn({duration:t.zoomDuration})),(void 0===t.keyboard||t.keyboard)&&(r.push(new wn),r.push(new Fn({delta:t.zoomDelta,duration:t.zoomDuration}))),(void 0===t.mouseWheelZoom||t.mouseWheelZoom)&&r.push(new Nn({condition:t.onFocusOnly?Wo:void 0,duration:t.zoomDuration})),(void 0===t.shiftDragZoom||t.shiftDragZoom)&&r.push(new yn({duration:t.zoomDuration})),r}var kn,jn=(kn=function(e,t){return(kn=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}kn(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Wn=function(e){function t(t,r,i,o){var n=e.call(this,t)||this;return n.inversePixelTransform=r,n.frameState=i,n.context=o,n}return jn(t,e),t}(R),Xn=/^#([a-f0-9]{3}|[a-f0-9]{4}(?:[a-f0-9]{2}){0,2})$/i,Yn=/^([a-z]*)$|^hsla?\(.*\)$/i;var qn,Kn,Zn=(qn={},Kn=0,function(e){var t;if(qn.hasOwnProperty(e))t=qn[e];else{if(Kn>=1024){var r=0;for(var i in qn)0==(3&r++)&&(delete qn[i],--Kn)}t=function(e){var t,r,i,o,n;if(Yn.exec(e)&&(e=function(e){var t=document.createElement("div");if(t.style.color=e,""!==t.style.color){document.body.appendChild(t);var r=getComputedStyle(t).color;return document.body.removeChild(t),r}return""}(e)),Xn.exec(e)){var a,s=e.length-1;a=s<=4?1:2;var l=4===s||8===s;t=parseInt(e.substr(1+0*a,a),16),r=parseInt(e.substr(1+1*a,a),16),i=parseInt(e.substr(1+2*a,a),16),o=l?parseInt(e.substr(1+3*a,a),16):255,1==a&&(t=(t<<4)+t,r=(r<<4)+r,i=(i<<4)+i,l&&(o=(o<<4)+o)),n=[t,r,i,o/255]}else 0==e.indexOf("rgba(")?Qn(n=e.slice(5,-1).split(",").map(Number)):0==e.indexOf("rgb(")?((n=e.slice(4,-1).split(",").map(Number)).push(1),Qn(n)):Oe(!1,14);return n}(e),qn[e]=t,++Kn}return t});function Jn(e){return Array.isArray(e)?e:Zn(e)}function Qn(e){return e[0]=ze(e[0]+.5|0,0,255),e[1]=ze(e[1]+.5|0,0,255),e[2]=ze(e[2]+.5|0,0,255),e[3]=ze(e[3],0,1),e}function $n(e){var t=e[0];t!=(0|t)&&(t=t+.5|0);var r=e[1];r!=(0|r)&&(r=r+.5|0);var i=e[2];return i!=(0|i)&&(i=i+.5|0),"rgba("+t+","+r+","+i+","+(void 0===e[3]?1:e[3])+")"}function ea(e,t,r){return t+":"+e+":"+(r?"string"==typeof r?r:$n(r):"null")}var ta=new(function(){function e(){this.cache_={},this.cacheSize_=0,this.maxCacheSize_=32}return e.prototype.clear=function(){this.cache_={},this.cacheSize_=0},e.prototype.canExpireCache=function(){return this.cacheSize_>this.maxCacheSize_},e.prototype.expire=function(){if(this.canExpireCache()){var e=0;for(var t in this.cache_){var r=this.cache_[t];0!=(3&e++)||r.hasListener()||(delete this.cache_[t],--this.cacheSize_)}}},e.prototype.get=function(e,t,r){var i=ea(e,t,r);return i in this.cache_?this.cache_[i]:null},e.prototype.set=function(e,t,r,i){var o=ea(e,t,r);this.cache_[o]=i,++this.cacheSize_},e.prototype.setSize=function(e){this.maxCacheSize_=e,this.expire()},e}());function ra(e){return Array.isArray(e)?$n(e):e}var ia=function(){function e(){}return e.prototype.drawCustom=function(e,t,r){},e.prototype.drawGeometry=function(e){},e.prototype.setStyle=function(e){},e.prototype.drawCircle=function(e,t){},e.prototype.drawFeature=function(e,t){},e.prototype.drawGeometryCollection=function(e,t){},e.prototype.drawLineString=function(e,t){},e.prototype.drawMultiLineString=function(e,t){},e.prototype.drawMultiPoint=function(e,t){},e.prototype.drawMultiPolygon=function(e,t){},e.prototype.drawPoint=function(e,t){},e.prototype.drawPolygon=function(e,t){},e.prototype.drawText=function(e,t){},e.prototype.setFillStrokeStyle=function(e,t){},e.prototype.setImageStyle=function(e,t){},e.prototype.setTextStyle=function(e,t){},e}(),oa=[],na=[0,0,0,0],aa=new re;(new I).setSize=function(){console.warn("labelCache is deprecated.")};var sa,la,ua,ca=null,da={},ha=function(){var e,t,r=["monospace","serif"],i=r.length,o="wmytzilWMYTZIL@#/&?$%10";function n(e,n,a){for(var s=!0,l=0;l<i;++l){var u=r[l];if(t=pa(e+" "+n+" 32px "+u,o),a!=u){var c=pa(e+" "+n+" 32px "+a+","+u,o);s=s&&c!=t}}return!!s}function a(){for(var t=!0,r=aa.getKeys(),i=0,o=r.length;i<o;++i){var a=r[i];aa.get(a)<100&&(n.apply(this,a.split("\n"))?(f(da),ca=null,sa=void 0,aa.set(a,100)):(aa.set(a,aa.get(a)+1,!0),t=!1))}t&&(clearInterval(e),e=void 0)}return function(t){var r=xo(t);if(r)for(var i=r.families,o=0,s=i.length;o<s;++o){var l=i[o],u=r.style+"\n"+r.weight+"\n"+l;void 0===aa.get(u)&&(aa.set(u,100,!0),n(r.style,r.weight,l)||(aa.set(u,0,!0),void 0===e&&(e=setInterval(a,32))))}}}(),fa=(ua=da,function(e){var t=ua[e];if(null==t)if(me){var r=xo(e),i=ga(e,"Žg"),o=isNaN(Number(r.lineHeight))?1.2:Number(r.lineHeight);da[e]=o*(i.actualBoundingBoxAscent+i.actualBoundingBoxDescent)}else la||((la=document.createElement("div")).innerHTML="M",la.style.margin="0 !important",la.style.padding="0 !important",la.style.position="absolute !important",la.style.left="-99999px !important"),la.style.font=e,document.body.appendChild(la),t=la.offsetHeight,ua[e]=t,document.body.removeChild(la);return t});function ga(e,t){return ca||(ca=Gi(1,1)),e!=sa&&(ca.font=e,sa=ca.font),ca.measureText(t)}function pa(e,t){return ga(e,t).width}function ma(e,t,r){if(t in r)return r[t];var i=pa(e,t);return r[t]=i,i}function va(e,t,r,i){0!==t&&(e.translate(r,i),e.rotate(t),e.translate(-r,-i))}function xa(e,t,r,i,o,n,a,s,l,u,c){e.save(),1!==r&&(e.globalAlpha*=r),t&&e.setTransform.apply(e,t),i.contextInstructions?(e.translate(l,u),e.scale(c,c),function(e,t){for(var r=e.contextInstructions,i=0,o=r.length;i<o;i+=2)Array.isArray(r[i+1])?t[r[i]].apply(t,r[i+1]):t[r[i]]=r[i+1]}(i,e)):e.drawImage(i,o,n,a,s,l,u,a*c,s*c),e.restore()}var _a,ya=null,Ta=(_a=function(e,t){return(_a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}_a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Ca=function(e){function t(t,r,i,o,n,a,s){var l=e.call(this)||this;return l.context_=t,l.pixelRatio_=r,l.extent_=i,l.transform_=o,l.viewRotation_=n,l.squaredTolerance_=a,l.userTransform_=s,l.contextFillState_=null,l.contextStrokeState_=null,l.contextTextState_=null,l.fillState_=null,l.strokeState_=null,l.image_=null,l.imageAnchorX_=0,l.imageAnchorY_=0,l.imageHeight_=0,l.imageOpacity_=0,l.imageOriginX_=0,l.imageOriginY_=0,l.imageRotateWithView_=!1,l.imageRotation_=0,l.imageScale_=0,l.imageWidth_=0,l.text_="",l.textOffsetX_=0,l.textOffsetY_=0,l.textRotateWithView_=!1,l.textRotation_=0,l.textScale_=0,l.textFillState_=null,l.textStrokeState_=null,l.textState_=null,l.pixelCoordinates_=[],l.tmpLocalTransform_=[1,0,0,1,0,0],l}return Ta(t,e),t.prototype.drawImages_=function(e,t,r,i){if(this.image_){var o=nr(e,t,r,2,this.transform_,this.pixelCoordinates_),n=this.context_,a=this.tmpLocalTransform_,s=n.globalAlpha;1!=this.imageOpacity_&&(n.globalAlpha=s*this.imageOpacity_);var l=this.imageRotation_;this.imageRotateWithView_&&(l+=this.viewRotation_);for(var u=0,c=o.length;u<c;u+=2){var d=o[u]-this.imageAnchorX_,h=o[u+1]-this.imageAnchorY_;if(0!==l||1!=this.imageScale_){var f=d+this.imageAnchorX_,g=h+this.imageAnchorY_;Kr(a,f,g,this.imageScale_,this.imageScale_,l,-f,-g),n.setTransform.apply(n,a)}n.drawImage(this.image_,this.imageOriginX_,this.imageOriginY_,this.imageWidth_,this.imageHeight_,d,h,this.imageWidth_,this.imageHeight_)}0===l&&1==this.imageScale_||n.setTransform(1,0,0,1,0,0),1!=this.imageOpacity_&&(n.globalAlpha=s)}},t.prototype.drawText_=function(e,t,r,i){if(this.textState_&&""!==this.text_){this.textFillState_&&this.setContextFillState_(this.textFillState_),this.textStrokeState_&&this.setContextStrokeState_(this.textStrokeState_),this.setContextTextState_(this.textState_);var o=nr(e,t,r,i,this.transform_,this.pixelCoordinates_),n=this.context_,a=this.textRotation_;for(this.textRotateWithView_&&(a+=this.viewRotation_);t<r;t+=i){var s=o[t]+this.textOffsetX_,l=o[t+1]+this.textOffsetY_;if(0!==a||1!=this.textScale_){var u=Kr(this.tmpLocalTransform_,s,l,this.textScale_,this.textScale_,a,-s,-l);n.setTransform.apply(n,u)}this.textStrokeState_&&n.strokeText(this.text_,s,l),this.textFillState_&&n.fillText(this.text_,s,l)}0===a&&1==this.textScale_||n.setTransform(1,0,0,1,0,0)}},t.prototype.moveToLineTo_=function(e,t,r,i,o){var n=this.context_,a=nr(e,t,r,i,this.transform_,this.pixelCoordinates_);n.moveTo(a[0],a[1]);var s=a.length;o&&(s-=2);for(var l=2;l<s;l+=2)n.lineTo(a[l],a[l+1]);return o&&n.closePath(),r},t.prototype.drawRings_=function(e,t,r,i){for(var o=0,n=r.length;o<n;++o)t=this.moveToLineTo_(e,t,r[o],i,!0);return t},t.prototype.drawCircle=function(e){if(Dt(this.extent_,e.getExtent())){if(this.fillState_||this.strokeState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);var t=function(e,t,r){var i=e.getFlatCoordinates();if(i){var o=e.getStride();return nr(i,0,i.length,o,t,r)}return null}(e,this.transform_,this.pixelCoordinates_),r=t[2]-t[0],i=t[3]-t[1],o=Math.sqrt(r*r+i*i),n=this.context_;n.beginPath(),n.arc(t[0],t[1],o,0,2*Math.PI),this.fillState_&&n.fill(),this.strokeState_&&n.stroke()}""!==this.text_&&this.drawText_(e.getCenter(),0,2,2)}},t.prototype.setStyle=function(e){this.setFillStrokeStyle(e.getFill(),e.getStroke()),this.setImageStyle(e.getImage()),this.setTextStyle(e.getText())},t.prototype.setTransform=function(e){this.transform_=e},t.prototype.drawGeometry=function(e){switch(e.getType()){case Yt:this.drawPoint(e);break;case qt:this.drawLineString(e);break;case Kt:this.drawPolygon(e);break;case Zt:this.drawMultiPoint(e);break;case Jt:this.drawMultiLineString(e);break;case Qt:this.drawMultiPolygon(e);break;case $t:this.drawGeometryCollection(e);break;case er:this.drawCircle(e)}},t.prototype.drawFeature=function(e,t){var r=t.getGeometryFunction()(e);r&&Dt(this.extent_,r.getExtent())&&(this.setStyle(t),this.drawGeometry(r))},t.prototype.drawGeometryCollection=function(e){for(var t=e.getGeometriesArray(),r=0,i=t.length;r<i;++r)this.drawGeometry(t[r])},t.prototype.drawPoint=function(e){this.squaredTolerance_&&(e=e.simplifyTransformed(this.squaredTolerance_,this.userTransform_));var t=e.getFlatCoordinates(),r=e.getStride();this.image_&&this.drawImages_(t,0,t.length,r),""!==this.text_&&this.drawText_(t,0,t.length,r)},t.prototype.drawMultiPoint=function(e){this.squaredTolerance_&&(e=e.simplifyTransformed(this.squaredTolerance_,this.userTransform_));var t=e.getFlatCoordinates(),r=e.getStride();this.image_&&this.drawImages_(t,0,t.length,r),""!==this.text_&&this.drawText_(t,0,t.length,r)},t.prototype.drawLineString=function(e){if(this.squaredTolerance_&&(e=e.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),Dt(this.extent_,e.getExtent())){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);var t=this.context_,r=e.getFlatCoordinates();t.beginPath(),this.moveToLineTo_(r,0,r.length,e.getStride(),!1),t.stroke()}if(""!==this.text_){var i=e.getFlatMidpoint();this.drawText_(i,0,2,2)}}},t.prototype.drawMultiLineString=function(e){this.squaredTolerance_&&(e=e.simplifyTransformed(this.squaredTolerance_,this.userTransform_));var t=e.getExtent();if(Dt(this.extent_,t)){if(this.strokeState_){this.setContextStrokeState_(this.strokeState_);var r=this.context_,i=e.getFlatCoordinates(),o=0,n=e.getEnds(),a=e.getStride();r.beginPath();for(var s=0,l=n.length;s<l;++s)o=this.moveToLineTo_(i,o,n[s],a,!1);r.stroke()}if(""!==this.text_){var u=e.getFlatMidpoints();this.drawText_(u,0,u.length,2)}}},t.prototype.drawPolygon=function(e){if(this.squaredTolerance_&&(e=e.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),Dt(this.extent_,e.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);var t=this.context_;t.beginPath(),this.drawRings_(e.getOrientedFlatCoordinates(),0,e.getEnds(),e.getStride()),this.fillState_&&t.fill(),this.strokeState_&&t.stroke()}if(""!==this.text_){var r=e.getFlatInteriorPoint();this.drawText_(r,0,2,2)}}},t.prototype.drawMultiPolygon=function(e){if(this.squaredTolerance_&&(e=e.simplifyTransformed(this.squaredTolerance_,this.userTransform_)),Dt(this.extent_,e.getExtent())){if(this.strokeState_||this.fillState_){this.fillState_&&this.setContextFillState_(this.fillState_),this.strokeState_&&this.setContextStrokeState_(this.strokeState_);var t=this.context_,r=e.getOrientedFlatCoordinates(),i=0,o=e.getEndss(),n=e.getStride();t.beginPath();for(var a=0,s=o.length;a<s;++a){var l=o[a];i=this.drawRings_(r,i,l,n)}this.fillState_&&t.fill(),this.strokeState_&&t.stroke()}if(""!==this.text_){var u=e.getFlatInteriorPoints();this.drawText_(u,0,u.length,2)}}},t.prototype.setContextFillState_=function(e){var t=this.context_,r=this.contextFillState_;r?r.fillStyle!=e.fillStyle&&(r.fillStyle=e.fillStyle,t.fillStyle=e.fillStyle):(t.fillStyle=e.fillStyle,this.contextFillState_={fillStyle:e.fillStyle})},t.prototype.setContextStrokeState_=function(e){var t=this.context_,r=this.contextStrokeState_;r?(r.lineCap!=e.lineCap&&(r.lineCap=e.lineCap,t.lineCap=e.lineCap),t.setLineDash&&(M(r.lineDash,e.lineDash)||t.setLineDash(r.lineDash=e.lineDash),r.lineDashOffset!=e.lineDashOffset&&(r.lineDashOffset=e.lineDashOffset,t.lineDashOffset=e.lineDashOffset)),r.lineJoin!=e.lineJoin&&(r.lineJoin=e.lineJoin,t.lineJoin=e.lineJoin),r.lineWidth!=e.lineWidth&&(r.lineWidth=e.lineWidth,t.lineWidth=e.lineWidth),r.miterLimit!=e.miterLimit&&(r.miterLimit=e.miterLimit,t.miterLimit=e.miterLimit),r.strokeStyle!=e.strokeStyle&&(r.strokeStyle=e.strokeStyle,t.strokeStyle=e.strokeStyle)):(t.lineCap=e.lineCap,t.setLineDash&&(t.setLineDash(e.lineDash),t.lineDashOffset=e.lineDashOffset),t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth,t.miterLimit=e.miterLimit,t.strokeStyle=e.strokeStyle,this.contextStrokeState_={lineCap:e.lineCap,lineDash:e.lineDash,lineDashOffset:e.lineDashOffset,lineJoin:e.lineJoin,lineWidth:e.lineWidth,miterLimit:e.miterLimit,strokeStyle:e.strokeStyle})},t.prototype.setContextTextState_=function(e){var t=this.context_,r=this.contextTextState_,i=e.textAlign?e.textAlign:"center";r?(r.font!=e.font&&(r.font=e.font,t.font=e.font),r.textAlign!=i&&(r.textAlign=i,t.textAlign=i),r.textBaseline!=e.textBaseline&&(r.textBaseline=e.textBaseline,t.textBaseline=e.textBaseline)):(t.font=e.font,t.textAlign=i,t.textBaseline=e.textBaseline,this.contextTextState_={font:e.font,textAlign:i,textBaseline:e.textBaseline})},t.prototype.setFillStrokeStyle=function(e,t){if(e){var r=e.getColor();this.fillState_={fillStyle:ra(r||"#000")}}else this.fillState_=null;if(t){var i=t.getColor(),o=t.getLineCap(),n=t.getLineDash(),a=t.getLineDashOffset(),s=t.getLineJoin(),l=t.getWidth(),u=t.getMiterLimit();this.strokeState_={lineCap:void 0!==o?o:"round",lineDash:n||oa,lineDashOffset:a||0,lineJoin:void 0!==s?s:"round",lineWidth:this.pixelRatio_*(void 0!==l?l:1),miterLimit:void 0!==u?u:10,strokeStyle:ra(i||"#000")}}else this.strokeState_=null},t.prototype.setImageStyle=function(e){if(e){var t=e.getAnchor(),r=e.getImage(1),i=e.getOrigin(),o=e.getSize();this.imageAnchorX_=t[0],this.imageAnchorY_=t[1],this.imageHeight_=o[1],this.image_=r,this.imageOpacity_=e.getOpacity(),this.imageOriginX_=i[0],this.imageOriginY_=i[1],this.imageRotateWithView_=e.getRotateWithView(),this.imageRotation_=e.getRotation(),this.imageScale_=e.getScale()*this.pixelRatio_,this.imageWidth_=o[0]}else this.image_=null},t.prototype.setTextStyle=function(e){if(e){var t=e.getFill();if(t){var r=t.getColor();this.textFillState_={fillStyle:ra(r||"#000")}}else this.textFillState_=null;var i=e.getStroke();if(i){var o=i.getColor(),n=i.getLineCap(),a=i.getLineDash(),s=i.getLineDashOffset(),l=i.getLineJoin(),u=i.getWidth(),c=i.getMiterLimit();this.textStrokeState_={lineCap:void 0!==n?n:"round",lineDash:a||oa,lineDashOffset:s||0,lineJoin:void 0!==l?l:"round",lineWidth:void 0!==u?u:1,miterLimit:void 0!==c?c:10,strokeStyle:ra(o||"#000")}}else this.textStrokeState_=null;var d=e.getFont(),h=e.getOffsetX(),f=e.getOffsetY(),g=e.getRotateWithView(),p=e.getRotation(),m=e.getScale(),v=e.getText(),x=e.getTextAlign(),_=e.getTextBaseline();this.textState_={font:void 0!==d?d:"10px sans-serif",textAlign:void 0!==x?x:"center",textBaseline:void 0!==_?_:"middle"},this.text_=void 0!==v?v:"",this.textOffsetX_=void 0!==h?this.pixelRatio_*h:0,this.textOffsetY_=void 0!==f?this.pixelRatio_*f:0,this.textRotateWithView_=void 0!==g&&g,this.textRotation_=void 0!==p?p:0,this.textScale_=this.pixelRatio_*(void 0!==m?m:1)}else this.text_=""},t}(ia),ba=0,Ma=2,Aa=3,Ea="Default",La="Image",wa="LineString",Sa="Polygon",Da="Text",Ra={Point:function(e,t,r,i){var o=r.getImage();if(o){if(o.getImageState()!=Ma)return;var n=e.getBuilder(r.getZIndex(),La);n.setImageStyle(o,e.addDeclutter(!1)),n.drawPoint(t,i)}var a=r.getText();if(a){var s=e.getBuilder(r.getZIndex(),Da);s.setTextStyle(a,e.addDeclutter(!!o)),s.drawText(t,i)}},LineString:function(e,t,r,i){var o=r.getStroke();if(o){var n=e.getBuilder(r.getZIndex(),wa);n.setFillStrokeStyle(null,o),n.drawLineString(t,i)}var a=r.getText();if(a){var s=e.getBuilder(r.getZIndex(),Da);s.setTextStyle(a,e.addDeclutter(!1)),s.drawText(t,i)}},Polygon:function(e,t,r,i){var o=r.getFill(),n=r.getStroke();if(o||n){var a=e.getBuilder(r.getZIndex(),Sa);a.setFillStrokeStyle(o,n),a.drawPolygon(t,i)}var s=r.getText();if(s){var l=e.getBuilder(r.getZIndex(),Da);l.setTextStyle(s,e.addDeclutter(!1)),l.drawText(t,i)}},MultiPoint:function(e,t,r,i){var o=r.getImage();if(o){if(o.getImageState()!=Ma)return;var n=e.getBuilder(r.getZIndex(),La);n.setImageStyle(o,e.addDeclutter(!1)),n.drawMultiPoint(t,i)}var a=r.getText();if(a){var s=e.getBuilder(r.getZIndex(),Da);s.setTextStyle(a,e.addDeclutter(!!o)),s.drawText(t,i)}},MultiLineString:function(e,t,r,i){var o=r.getStroke();if(o){var n=e.getBuilder(r.getZIndex(),wa);n.setFillStrokeStyle(null,o),n.drawMultiLineString(t,i)}var a=r.getText();if(a){var s=e.getBuilder(r.getZIndex(),Da);s.setTextStyle(a,e.addDeclutter(!1)),s.drawText(t,i)}},MultiPolygon:function(e,t,r,i){var o=r.getFill(),n=r.getStroke();if(n||o){var a=e.getBuilder(r.getZIndex(),Sa);a.setFillStrokeStyle(o,n),a.drawMultiPolygon(t,i)}var s=r.getText();if(s){var l=e.getBuilder(r.getZIndex(),Da);l.setTextStyle(s,e.addDeclutter(!1)),l.drawText(t,i)}},GeometryCollection:function(e,t,r,i){var o,n,a=t.getGeometriesArray();for(o=0,n=a.length;o<n;++o)(0,Ra[a[o].getType()])(e,a[o],r,i)},Circle:function(e,t,r,i){var o=r.getFill(),n=r.getStroke();if(o||n){var a=e.getBuilder(r.getZIndex(),"Circle");a.setFillStrokeStyle(o,n),a.drawCircle(t,i)}var s=r.getText();if(s){var l=e.getBuilder(r.getZIndex(),Da);l.setTextStyle(s,e.addDeclutter(!1)),l.drawText(t,i)}}};function Pa(e,t){return parseInt(n(e),10)-parseInt(n(t),10)}function Ia(e,t){return.5*e/t}function Fa(e,t,r,i,o,n){var a=!1,s=r.getImage();if(s){var l=s.getImageState();l==Ma||l==Aa?s.unlistenImageChange(o):(l==ba&&s.load(),l=s.getImageState(),s.listenImageChange(o),a=!0)}return function(e,t,r,i,o){var n=r.getGeometryFunction()(t);if(n){var a=n.simplifyTransformed(i,o);r.getRenderer()?function e(t,r,i,o){if(r.getType()!=$t)t.getBuilder(i.getZIndex(),Ea).drawCustom(r,o,i.getRenderer());else for(var n=r.getGeometries(),a=0,s=n.length;a<s;++a)e(t,n[a],i,o)}(e,a,r,t):(0,Ra[a.getType()])(e,a,r,t)}}(e,t,r,i,n),a}var Oa,Ba=(Oa=function(e,t){return(Oa=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Oa(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Na(e,t){ta.expire()}var Ua,Ga,za,Ha=function(e){function t(t){var r=e.call(this)||this;return r.map_=t,r.declutterTree_=null,r}return Ba(t,e),t.prototype.dispatchRenderEvent=function(e,t){i()},t.prototype.calculateMatrices2D=function(e){var t=e.viewState,r=e.coordinateToPixelTransform,i=e.pixelToCoordinateTransform;Kr(r,e.size[0]/2,e.size[1]/2,1/t.resolution,-1/t.resolution,-t.rotation,-t.center[0],-t.center[1]),Zr(i,r)},t.prototype.forEachFeatureAtCoordinate=function(e,t,r,i,o,n,a,s){var l,u=t.viewState;function c(e,t,r){return o.call(n,t,e?r:null)}var d=u.projection,h=Vt(e.slice(),d),f=[[0,0]];if(d.canWrapX()&&i){var g=St(d.getExtent());f.push([-g,0],[g,0])}var p,m=t.layerStatesArray,v=m.length;this.declutterTree_&&(p=this.declutterTree_.all().map(function(e){return e.value}));for(var x=[],_=0;_<f.length;_++)for(var y=v-1;y>=0;--y){var T=m[y],C=T.layer;if(C.hasRenderer()&&yo(T,u)&&a.call(s,C)){var b=C.getRenderer(),M=C.getSource();if(b&&M){var A=M.getWrapX()?h:e,E=c.bind(null,T.managed);x[0]=A[0]+f[_][0],x[1]=A[1]+f[_][1],l=b.forEachFeatureAtCoordinate(x,t,r,E,p)}if(l)return l}}},t.prototype.forEachLayerAtPixel=function(e,t,r,o,n){return i()},t.prototype.hasFeatureAtCoordinate=function(e,t,r,i,o,n){return void 0!==this.forEachFeatureAtCoordinate(e,t,r,i,A,this,o,n)},t.prototype.getMap=function(){return this.map_},t.prototype.renderFrame=function(e){this.declutterTree_=function(e,t){t&&t.clear();for(var r=e.declutterItems,i=r.length-1;i>=0;--i)for(var o=r[i],n=o.items,a=0,s=n.length;a<s;a+=3)t=n[a].renderDeclutter(n[a+1],n[a+2],o.opacity,t);return r.length=0,t}(e,this.declutterTree_)},t.prototype.scheduleExpireIconCache=function(e){ta.canExpireCache()&&e.postRenderFunctions.push(Na)},t}(_),Va=(za=function(e,t){return(za=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}za(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),ka=function(e){function t(t){var r=e.call(this,t)||this;r.fontChangeListenerKey_=m(aa,d,t.redrawText.bind(t)),r.element_=document.createElement("div");var i=r.element_.style;i.position="absolute",i.width="100%",i.height="100%",i.zIndex="0",r.element_.className="ol-unselectable ol-layers";var o=t.getViewport();return o.insertBefore(r.element_,o.firstChild||null),r.children_=[],r.renderedVisible_=!0,r}return Va(t,e),t.prototype.dispatchRenderEvent=function(e,t){var r=this.getMap();if(r.hasListener(e)){var i=new Wn(e,void 0,t);r.dispatchEvent(i)}},t.prototype.disposeInternal=function(){x(this.fontChangeListenerKey_),this.element_.parentNode.removeChild(this.element_),e.prototype.disposeInternal.call(this)},t.prototype.renderFrame=function(t){if(t){this.calculateMatrices2D(t),this.dispatchRenderEvent(Re,t);var r=t.layerStatesArray.sort(function(e,t){return e.zIndex-t.zIndex}),i=t.viewState;this.children_.length=0;for(var o=null,n=0,a=r.length;n<a;++n){var s=r[n];if(t.layerIndex=n,yo(s,i)&&(s.sourceState==to||s.sourceState==eo)){var l=s.layer.render(t,o);l&&l!==o&&(this.children_.push(l),o=l)}}e.prototype.renderFrame.call(this,t),function(e,t){for(var r=e.childNodes,i=0;;++i){var o=r[i],n=t[i];if(!o&&!n)break;o!==n&&(o?n?e.insertBefore(n,o):(e.removeChild(o),--i):e.appendChild(n))}}(this.element_,this.children_),this.dispatchRenderEvent("postcompose",t),this.renderedVisible_||(this.element_.style.display="",this.renderedVisible_=!0),this.scheduleExpireIconCache(t)}else this.renderedVisible_&&(this.element_.style.display="none",this.renderedVisible_=!1)},t.prototype.forEachLayerAtPixel=function(e,t,r,i,o){for(var n=t.viewState,a=t.layerStatesArray,s=a.length-1;s>=0;--s){var l=a[s],u=l.layer;if(u.hasRenderer()&&yo(l,n)&&o(u)){var c=u.getRenderer().getDataAtPixel(e,t,r);if(c){var d=i(u,c);if(d)return d}}}},t}(Ha),ja=(Ga=function(e,t){return(Ga=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Ga(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Wa=function(e){function t(t){return(t=h({},t)).controls||(t.controls=Io()),t.interactions||(t.interactions=Vn()),e.call(this,t)||this}return ja(t,e),t.prototype.createRenderer=function(){return new ka(this)},t}(fo),Xa="preload",Ya="useInterimTilesOnError",qa=(Ua=function(e,t){return(Ua=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Ua(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Ka=function(e){function t(t){var r=this,i=t||{},o=h({},i);return delete o.preload,delete o.useInterimTilesOnError,(r=e.call(this,o)||this).setPreload(void 0!==i.preload?i.preload:0),r.setUseInterimTilesOnError(void 0===i.useInterimTilesOnError||i.useInterimTilesOnError),r}return qa(t,e),t.prototype.getPreload=function(){return this.get(Xa)},t.prototype.setPreload=function(e){this.set(Xa,e)},t.prototype.getUseInterimTilesOnError=function(){return this.get(Ya)},t.prototype.setUseInterimTilesOnError=function(e){this.set(Ya,e)},t}(Co),Za=function(){function e(e,t,r,i){this.minX=e,this.maxX=t,this.minY=r,this.maxY=i}return e.prototype.contains=function(e){return this.containsXY(e[1],e[2])},e.prototype.containsTileRange=function(e){return this.minX<=e.minX&&e.maxX<=this.maxX&&this.minY<=e.minY&&e.maxY<=this.maxY},e.prototype.containsXY=function(e,t){return this.minX<=e&&e<=this.maxX&&this.minY<=t&&t<=this.maxY},e.prototype.equals=function(e){return this.minX==e.minX&&this.minY==e.minY&&this.maxX==e.maxX&&this.maxY==e.maxY},e.prototype.extend=function(e){e.minX<this.minX&&(this.minX=e.minX),e.maxX>this.maxX&&(this.maxX=e.maxX),e.minY<this.minY&&(this.minY=e.minY),e.maxY>this.maxY&&(this.maxY=e.maxY)},e.prototype.getHeight=function(){return this.maxY-this.minY+1},e.prototype.getSize=function(){return[this.getWidth(),this.getHeight()]},e.prototype.getWidth=function(){return this.maxX-this.minX+1},e.prototype.intersects=function(e){return this.minX<=e.maxX&&this.maxX>=e.minX&&this.minY<=e.maxY&&this.maxY>=e.minY},e}();function Ja(e,t,r,i,o){return void 0!==o?(o.minX=e,o.maxX=t,o.minY=r,o.maxY=i,o):new Za(e,t,r,i)}var Qa,$a,es,ts=Za,rs=(es=function(e,t){return(es=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}es(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),is=function(e){function t(t){var r=e.call(this)||this;return r.boundHandleImageChange_=r.handleImageChange_.bind(r),r.layer_=t,r}return rs(t,e),t.prototype.getFeatures=function(e){return i()},t.prototype.prepareFrame=function(e){return i()},t.prototype.renderFrame=function(e,t){return i()},t.prototype.loadedTileCallback=function(e,t,r){e[t]||(e[t]={}),e[t][r.tileCoord.toString()]=r},t.prototype.createLoadedTileFinder=function(e,t,r){return function(i,o){var n=this.loadedTileCallback.bind(this,r,i);return e.forEachLoadedTile(t,i,o,n)}.bind(this)},t.prototype.forEachFeatureAtCoordinate=function(e,t,r,i,o){},t.prototype.getDataAtPixel=function(e,t,r){return i()},t.prototype.getLayer=function(){return this.layer_},t.prototype.handleFontsChanged=function(){},t.prototype.handleImageChange_=function(e){e.target.getState()===Ma&&this.renderIfReadyAndVisible()},t.prototype.loadImage=function(e){var t=e.getState();return t!=Ma&&t!=Aa&&e.addEventListener(F,this.boundHandleImageChange_),t==ba&&(e.load(),t=e.getState()),t==Ma},t.prototype.renderIfReadyAndVisible=function(){var e=this.getLayer();e.getVisible()&&e.getSourceState()==to&&e.changed()},t}(X),os=($a=function(e,t){return($a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}$a(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),ns=function(e){function t(t){var r=e.call(this,t)||this;return r.container=null,r.renderedResolution,r.tempTransform_=[1,0,0,1,0,0],r.pixelTransform=[1,0,0,1,0,0],r.inversePixelTransform=[1,0,0,1,0,0],r.context=null,r.containerReused=!1,r}return os(t,e),t.prototype.useContainer=function(e,t,r){var i,o,n=this.getLayer().getClassName();if(e&&""===e.style.opacity&&e.className===n&&(s=e.firstElementChild)instanceof HTMLCanvasElement&&(o=s.getContext("2d")),o&&o.canvas.style.transform===t?(this.container=e,this.context=o,this.containerReused=!0):this.containerReused&&(this.container=null,this.context=null,this.containerReused=!1),!this.container){(i=document.createElement("div")).className=n;var a=i.style;a.position="absolute",a.width="100%",a.height="100%";var s=(o=Gi()).canvas;i.appendChild(s),(a=s.style).position="absolute",a.left="0",a.transformOrigin="top left",this.container=i,this.context=o}},t.prototype.clip=function(e,t,r){var i=t.pixelRatio,o=t.size[0]*i/2,n=t.size[1]*i/2,a=t.viewState.rotation,s=Lt(r),l=wt(r),u=Ct(r),c=Tt(r);qr(t.coordinateToPixelTransform,s),qr(t.coordinateToPixelTransform,l),qr(t.coordinateToPixelTransform,u),qr(t.coordinateToPixelTransform,c),e.save(),va(e,-a,o,n),e.beginPath(),e.moveTo(s[0]*i,s[1]*i),e.lineTo(l[0]*i,l[1]*i),e.lineTo(u[0]*i,u[1]*i),e.lineTo(c[0]*i,c[1]*i),e.clip(),va(e,a,o,n)},t.prototype.clipUnrotated=function(e,t,r){var i=Lt(r),o=wt(r),n=Ct(r),a=Tt(r);qr(t.coordinateToPixelTransform,i),qr(t.coordinateToPixelTransform,o),qr(t.coordinateToPixelTransform,n),qr(t.coordinateToPixelTransform,a);var s=this.inversePixelTransform;qr(s,i),qr(s,o),qr(s,n),qr(s,a),e.save(),e.beginPath(),e.moveTo(Math.round(i[0]),Math.round(i[1])),e.lineTo(Math.round(o[0]),Math.round(o[1])),e.lineTo(Math.round(n[0]),Math.round(n[1])),e.lineTo(Math.round(a[0]),Math.round(a[1])),e.clip()},t.prototype.dispatchRenderEvent_=function(e,t,r){var i=this.getLayer();if(i.hasListener(e)){var o=new Wn(e,this.inversePixelTransform,r,t);i.dispatchEvent(o)}},t.prototype.preRender=function(e,t){this.dispatchRenderEvent_("prerender",e,t)},t.prototype.postRender=function(e,t){this.dispatchRenderEvent_("postrender",e,t)},t.prototype.getRenderTransform=function(e,t,r,i,o,n,a){var s=o/2,l=n/2,u=i/t,c=-u,d=-e[0]+a,h=-e[1];return Kr(this.tempTransform_,s,l,u,c,-r,d,h)},t.prototype.getDataAtPixel=function(e,t,r){var i,o=qr(this.inversePixelTransform,e.slice()),n=this.context;try{i=n.getImageData(Math.round(o[0]),Math.round(o[1]),1,1).data}catch(e){return"SecurityError"===e.name?new Uint8Array:i}return 0===i[3]?null:i},t}(is),as=(Qa=function(e,t){return(Qa=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Qa(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),ss=function(e){function t(t){var r=e.call(this,t)||this;return r.extentChanged=!0,r.renderedExtent_=null,r.renderedPixelRatio,r.renderedProjection=null,r.renderedRevision,r.renderedTiles=[],r.newTiles_=!1,r.tmpExtent=[1/0,1/0,-1/0,-1/0],r.tmpTileRange_=new ts(0,0,0,0),r}return as(t,e),t.prototype.isDrawableTile=function(e){var t=this.getLayer(),r=e.getState(),i=t.getUseInterimTilesOnError();return 2==r||r==Fe||3==r&&!i},t.prototype.getTile=function(e,t,r,i){var o=i.pixelRatio,n=i.viewState.projection,a=this.getLayer(),s=a.getSource().getTile(e,t,r,o,n);return 3==s.getState()&&(a.getUseInterimTilesOnError()?a.getPreload()>0&&(this.newTiles_=!0):s.setState(2)),this.isDrawableTile(s)||(s=s.getInterimTile()),s},t.prototype.loadedTileCallback=function(t,r,i){return!!this.isDrawableTile(i)&&e.prototype.loadedTileCallback.call(this,t,r,i)},t.prototype.prepareFrame=function(e){return!!this.getLayer().getSource()},t.prototype.renderFrame=function(e,t){var r=e.layerStatesArray[e.layerIndex],i=e.viewState,o=i.projection,a=i.resolution,s=i.center,l=i.rotation,u=e.pixelRatio,c=this.getLayer(),d=c.getSource(),h=d.getRevision(),f=d.getTileGridForProjection(o),g=f.getZForResolution(a,d.zDirection),p=f.getResolution(g),m=e.extent,v=r.extent&&Yr(r.extent,o);v&&(m=Et(m,Yr(r.extent,o)));var x=d.getTilePixelRatio(u),_=Math.round(e.size[0]*x),T=Math.round(e.size[1]*x);if(l){var C=Math.round(Math.sqrt(_*_+T*T));_=C,T=C}var b=p*_/2/x,M=p*T/2/x,A=[s[0]-b,s[1]-M,s[0]+b,s[1]+M],E=f.getTileRangeForExtentAndZ(m,g),L={};L[g]={};var w=this.createLoadedTileFinder(d,o,L),S=this.tmpExtent,D=this.tmpTileRange_;this.newTiles_=!1;for(var R=E.minX;R<=E.maxX;++R)for(var P=E.minY;P<=E.maxY;++P){var I=this.getTile(g,R,P,e);if(this.isDrawableTile(I)){var F=n(this);if(2==I.getState()){L[g][I.tileCoord.toString()]=I;var O=I.inTransition(F);this.newTiles_||!O&&-1!==this.renderedTiles.indexOf(I)||(this.newTiles_=!0)}if(1===I.getAlpha(F,e.time))continue}var B=f.getTileCoordChildTileRange(I.tileCoord,D,S),N=!1;B&&(N=w(g+1,B)),N||f.forEachTileCoordParentTileRange(I.tileCoord,w,D,S)}var U=p/a;Kr(this.pixelTransform,e.size[0]/2,e.size[1]/2,1/x,1/x,l,-_/2,-T/2);var G,z=(G=this.pixelTransform,me?Jr(G):(ya||(ya=Gi(1,1).canvas),ya.style.transform=Jr(G),ya.style.transform));this.useContainer(t,z,r.opacity);var H=this.context,V=H.canvas;Zr(this.inversePixelTransform,this.pixelTransform),Kr(this.tempTransform_,_/2,T/2,U,U,0,-_/2,-T/2),V.width!=_||V.height!=T?(V.width=_,V.height=T):this.containerReused||H.clearRect(0,0,_,T),v&&this.clipUnrotated(H,e,v),this.preRender(H,e),this.renderedTiles.length=0;var k,j,W,X=Object.keys(L).map(Number);X.sort(y),1!==r.opacity||this.containerReused&&!d.getOpaque(e.viewState.projection)?(k=[],j=[]):X=X.reverse();for(var Y=X.length-1;Y>=0;--Y){var q=X[Y],K=d.getTilePixelSize(q,u,o),Z=f.getResolution(q)/p,J=K[0]*Z*U,Q=K[1]*Z*U,$=f.getTileCoordForCoordAndZ(Lt(A),q),ee=f.getTileCoordExtent($),te=qr(this.tempTransform_,[x*(ee[0]-A[0])/p,x*(A[3]-ee[3])/p]),re=x*d.getGutterForProjection(o),ie=L[q];for(var oe in ie){var ne=(I=ie[oe]).tileCoord,ae=te[0]-($[1]-ne[1])*J,se=Math.round(ae+J),le=te[1]-($[2]-ne[2])*Q,ue=Math.round(le+Q),ce=se-(R=Math.round(ae)),de=ue-(P=Math.round(le)),he=g===q;if(!(O=he&&1!==I.getAlpha(n(this),e.time)))if(k){H.save(),W=[R,P,R+ce,P,R+ce,P+de,R,P+de];for(var fe=0,ge=k.length;fe<ge;++fe)if(g!==q&&q<j[fe]){var pe=k[fe];H.beginPath(),H.moveTo(W[0],W[1]),H.lineTo(W[2],W[3]),H.lineTo(W[4],W[5]),H.lineTo(W[6],W[7]),H.moveTo(pe[6],pe[7]),H.lineTo(pe[4],pe[5]),H.lineTo(pe[2],pe[3]),H.lineTo(pe[0],pe[1]),H.clip()}k.push(W),j.push(q)}else H.clearRect(R,P,ce,de);this.drawTileImage(I,e,R,P,ce,de,re,he,r.opacity),k&&!O&&H.restore(),this.renderedTiles.push(I),this.updateUsedTiles(e.usedTiles,d,I)}}return this.renderedRevision=h,this.renderedResolution=p,this.extentChanged=!this.renderedExtent_||!pt(this.renderedExtent_,A),this.renderedExtent_=A,this.renderedPixelRatio=u,this.renderedProjection=o,this.manageTilePyramid(e,d,f,u,o,m,g,c.getPreload()),this.scheduleExpireCache(e,d),this.postRender(H,e),r.extent&&H.restore(),z!==V.style.transform&&(V.style.transform=z),this.container},t.prototype.drawTileImage=function(e,t,r,i,o,a,s,l,u){var c=this.getTileImage(e);if(c){var d=n(this),h=l?e.getAlpha(d,t.time):1,f=u*h,g=f!==this.context.globalAlpha;g&&(this.context.save(),this.context.globalAlpha=f),this.context.drawImage(c,s,s,c.width-2*s,c.height-2*s,r,i,o,a),g&&this.context.restore(),1!==h?t.animate=!0:l&&e.endTransition(d)}},t.prototype.getImage=function(){var e=this.context;return e?e.canvas:null},t.prototype.getTileImage=function(e){return e.getImage()},t.prototype.scheduleExpireCache=function(e,t){if(t.canExpireCache()){var r=function(e,t,r){var i=n(e);i in r.usedTiles&&e.expireCache(r.viewState.projection,r.usedTiles[i])}.bind(null,t);e.postRenderFunctions.push(r)}},t.prototype.updateUsedTiles=function(e,t,r){var i=n(t);i in e||(e[i]={}),e[i][r.getKey()]=!0},t.prototype.manageTilePyramid=function(e,t,r,i,o,a,s,l,u){var c=n(t);c in e.wantedTiles||(e.wantedTiles[c]={});var d,h,f,g,p,m,v=e.wantedTiles[c],x=e.tileQueue;for(m=r.getMinZoom();m<=s;++m)for(h=r.getTileRangeForExtentAndZ(a,m,h),f=r.getResolution(m),g=h.minX;g<=h.maxX;++g)for(p=h.minY;p<=h.maxY;++p)s-m<=l?((d=t.getTile(m,g,p,i,o)).getState()==Ie&&(v[d.getKey()]=!0,x.isKeyQueued(d.getKey())||x.enqueue([d,c,r.getTileCoordCenter(d.tileCoord),f])),void 0!==u&&u(d)):t.useTile(m,g,p,o)},t}(ns);ss.prototype.getLayer;var ls,us,cs,ds=ss,hs=(cs=function(e,t){return(cs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}cs(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),fs=function(e){function t(t){return e.call(this,t)||this}return hs(t,e),t.prototype.createRenderer=function(){return new ds(this)},t}(Ka),gs=function(){function e(e){this.opacity_=e.opacity,this.rotateWithView_=e.rotateWithView,this.rotation_=e.rotation,this.scale_=e.scale,this.displacement_=e.displacement}return e.prototype.clone=function(){return new e({opacity:this.getOpacity(),scale:this.getScale(),rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),displacement:this.getDisplacement().slice()})},e.prototype.getOpacity=function(){return this.opacity_},e.prototype.getRotateWithView=function(){return this.rotateWithView_},e.prototype.getRotation=function(){return this.rotation_},e.prototype.getScale=function(){return this.scale_},e.prototype.getDisplacement=function(){return this.displacement_},e.prototype.getAnchor=function(){return i()},e.prototype.getImage=function(e){return i()},e.prototype.getHitDetectionImage=function(e){return i()},e.prototype.getImageState=function(){return i()},e.prototype.getImageSize=function(){return i()},e.prototype.getHitDetectionImageSize=function(){return i()},e.prototype.getOrigin=function(){return i()},e.prototype.getSize=function(){return i()},e.prototype.setOpacity=function(e){this.opacity_=e},e.prototype.setRotateWithView=function(e){this.rotateWithView_=e},e.prototype.setRotation=function(e){this.rotation_=e},e.prototype.setScale=function(e){this.scale_=e},e.prototype.listenImageChange=function(e){i()},e.prototype.load=function(){i()},e.prototype.unlistenImageChange=function(e){i()},e}(),ps=(us=function(e,t){return(us=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}us(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),ms=function(e){function t(t){var r=this,i=void 0!==t.rotateWithView&&t.rotateWithView;return(r=e.call(this,{opacity:1,rotateWithView:i,rotation:void 0!==t.rotation?t.rotation:0,scale:1,displacement:void 0!==t.displacement?t.displacement:[0,0]})||this).canvas_=null,r.hitDetectionCanvas_=null,r.fill_=void 0!==t.fill?t.fill:null,r.origin_=[0,0],r.points_=t.points,r.radius_=void 0!==t.radius?t.radius:t.radius1,r.radius2_=t.radius2,r.angle_=void 0!==t.angle?t.angle:0,r.stroke_=void 0!==t.stroke?t.stroke:null,r.anchor_=null,r.size_=null,r.imageSize_=null,r.hitDetectionImageSize_=null,r.render(),r}return ps(t,e),t.prototype.clone=function(){var e=new t({fill:this.getFill()?this.getFill().clone():void 0,points:this.getPoints(),radius:this.getRadius(),radius2:this.getRadius2(),angle:this.getAngle(),stroke:this.getStroke()?this.getStroke().clone():void 0,rotation:this.getRotation(),rotateWithView:this.getRotateWithView(),displacement:this.getDisplacement().slice()});return e.setOpacity(this.getOpacity()),e.setScale(this.getScale()),e},t.prototype.getAnchor=function(){return this.anchor_},t.prototype.getAngle=function(){return this.angle_},t.prototype.getFill=function(){return this.fill_},t.prototype.getHitDetectionImage=function(e){return this.hitDetectionCanvas_},t.prototype.getImage=function(e){return this.canvas_},t.prototype.getImageSize=function(){return this.imageSize_},t.prototype.getHitDetectionImageSize=function(){return this.hitDetectionImageSize_},t.prototype.getImageState=function(){return Ma},t.prototype.getOrigin=function(){return this.origin_},t.prototype.getPoints=function(){return this.points_},t.prototype.getRadius=function(){return this.radius_},t.prototype.getRadius2=function(){return this.radius2_},t.prototype.getSize=function(){return this.size_},t.prototype.getStroke=function(){return this.stroke_},t.prototype.listenImageChange=function(e){},t.prototype.load=function(){},t.prototype.unlistenImageChange=function(e){},t.prototype.render=function(){var e,t="round",r="round",i=0,o=null,n=0,a=0;this.stroke_&&(null===(e=this.stroke_.getColor())&&(e="#000"),e=ra(e),void 0===(a=this.stroke_.getWidth())&&(a=1),o=this.stroke_.getLineDash(),n=this.stroke_.getLineDashOffset(),void 0===(r=this.stroke_.getLineJoin())&&(r="round"),void 0===(t=this.stroke_.getLineCap())&&(t="round"),void 0===(i=this.stroke_.getMiterLimit())&&(i=10));var s=2*(this.radius_+a)+1,l={strokeStyle:e,strokeWidth:a,size:s,lineCap:t,lineDash:o,lineDashOffset:n,lineJoin:r,miterLimit:i},u=Gi(s,s);this.canvas_=u.canvas;var c=s=this.canvas_.width,d=this.getDisplacement();this.draw_(l,u,0,0),this.createHitDetectionCanvas_(l),this.anchor_=[s/2-d[0],s/2+d[1]],this.size_=[s,s],this.imageSize_=[c,c]},t.prototype.draw_=function(e,t,r,i){var o,n,a;t.setTransform(1,0,0,1,0,0),t.translate(r,i),t.beginPath();var s=this.points_;if(s===1/0)t.arc(e.size/2,e.size/2,this.radius_,0,2*Math.PI,!0);else{var l=void 0!==this.radius2_?this.radius2_:this.radius_;for(l!==this.radius_&&(s*=2),o=0;o<=s;o++)n=2*o*Math.PI/s-Math.PI/2+this.angle_,a=o%2==0?this.radius_:l,t.lineTo(e.size/2+a*Math.cos(n),e.size/2+a*Math.sin(n))}if(this.fill_){var u=this.fill_.getColor();null===u&&(u="#000"),t.fillStyle=ra(u),t.fill()}this.stroke_&&(t.strokeStyle=e.strokeStyle,t.lineWidth=e.strokeWidth,t.setLineDash&&e.lineDash&&(t.setLineDash(e.lineDash),t.lineDashOffset=e.lineDashOffset),t.lineCap=e.lineCap,t.lineJoin=e.lineJoin,t.miterLimit=e.miterLimit,t.stroke()),t.closePath()},t.prototype.createHitDetectionCanvas_=function(e){if(this.hitDetectionImageSize_=[e.size,e.size],this.hitDetectionCanvas_=this.canvas_,this.fill_){var t=this.fill_.getColor(),r=0;if("string"==typeof t&&(t=Jn(t)),null===t?r=1:Array.isArray(t)&&(r=4===t.length?t[3]:1),0===r){var i=Gi(e.size,e.size);this.hitDetectionCanvas_=i.canvas,this.drawHitDetectionCanvas_(e,i,0,0)}}},t.prototype.drawHitDetectionCanvas_=function(e,t,r,i){t.setTransform(1,0,0,1,0,0),t.translate(r,i),t.beginPath();var o=this.points_;if(o===1/0)t.arc(e.size/2,e.size/2,this.radius_,0,2*Math.PI,!0);else{var n=void 0!==this.radius2_?this.radius2_:this.radius_;n!==this.radius_&&(o*=2);var a=void 0,s=void 0,l=void 0;for(a=0;a<=o;a++)l=2*a*Math.PI/o-Math.PI/2+this.angle_,s=a%2==0?this.radius_:n,t.lineTo(e.size/2+s*Math.cos(l),e.size/2+s*Math.sin(l))}t.fillStyle="#000",t.fill(),this.stroke_&&(t.strokeStyle=e.strokeStyle,t.lineWidth=e.strokeWidth,e.lineDash&&(t.setLineDash(e.lineDash),t.lineDashOffset=e.lineDashOffset),t.stroke()),t.closePath()},t}(gs),vs=(ls=function(e,t){return(ls=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}ls(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),xs=function(e){function t(t){var r=t||{};return e.call(this,{points:1/0,fill:r.fill,radius:r.radius,stroke:r.stroke,displacement:void 0!==r.displacement?r.displacement:[0,0]})||this}return vs(t,e),t.prototype.clone=function(){var e=new t({fill:this.getFill()?this.getFill().clone():void 0,stroke:this.getStroke()?this.getStroke().clone():void 0,radius:this.getRadius(),displacement:this.getDisplacement().slice()});return e.setOpacity(this.getOpacity()),e.setScale(this.getScale()),e},t.prototype.setRadius=function(e){this.radius_=e,this.render()},t}(ms),_s=function(){function e(e){var t=e||{};this.color_=void 0!==t.color?t.color:null}return e.prototype.clone=function(){var t=this.getColor();return new e({color:Array.isArray(t)?t.slice():t||void 0})},e.prototype.getColor=function(){return this.color_},e.prototype.setColor=function(e){this.color_=e},e}(),ys=function(){function e(e){var t=e||{};this.color_=void 0!==t.color?t.color:null,this.lineCap_=t.lineCap,this.lineDash_=void 0!==t.lineDash?t.lineDash:null,this.lineDashOffset_=t.lineDashOffset,this.lineJoin_=t.lineJoin,this.miterLimit_=t.miterLimit,this.width_=t.width}return e.prototype.clone=function(){var t=this.getColor();return new e({color:Array.isArray(t)?t.slice():t||void 0,lineCap:this.getLineCap(),lineDash:this.getLineDash()?this.getLineDash().slice():void 0,lineDashOffset:this.getLineDashOffset(),lineJoin:this.getLineJoin(),miterLimit:this.getMiterLimit(),width:this.getWidth()})},e.prototype.getColor=function(){return this.color_},e.prototype.getLineCap=function(){return this.lineCap_},e.prototype.getLineDash=function(){return this.lineDash_},e.prototype.getLineDashOffset=function(){return this.lineDashOffset_},e.prototype.getLineJoin=function(){return this.lineJoin_},e.prototype.getMiterLimit=function(){return this.miterLimit_},e.prototype.getWidth=function(){return this.width_},e.prototype.setColor=function(e){this.color_=e},e.prototype.setLineCap=function(e){this.lineCap_=e},e.prototype.setLineDash=function(e){this.lineDash_=e},e.prototype.setLineDashOffset=function(e){this.lineDashOffset_=e},e.prototype.setLineJoin=function(e){this.lineJoin_=e},e.prototype.setMiterLimit=function(e){this.miterLimit_=e},e.prototype.setWidth=function(e){this.width_=e},e}(),Ts=function(){function e(e){var t=e||{};this.geometry_=null,this.geometryFunction_=Ms,void 0!==t.geometry&&this.setGeometry(t.geometry),this.fill_=void 0!==t.fill?t.fill:null,this.image_=void 0!==t.image?t.image:null,this.renderer_=void 0!==t.renderer?t.renderer:null,this.stroke_=void 0!==t.stroke?t.stroke:null,this.text_=void 0!==t.text?t.text:null,this.zIndex_=t.zIndex}return e.prototype.clone=function(){var t=this.getGeometry();return t&&"object"==H(t)&&(t=t.clone()),new e({geometry:t,fill:this.getFill()?this.getFill().clone():void 0,image:this.getImage()?this.getImage().clone():void 0,stroke:this.getStroke()?this.getStroke().clone():void 0,text:this.getText()?this.getText().clone():void 0,zIndex:this.getZIndex()})},e.prototype.getRenderer=function(){return this.renderer_},e.prototype.setRenderer=function(e){this.renderer_=e},e.prototype.getGeometry=function(){return this.geometry_},e.prototype.getGeometryFunction=function(){return this.geometryFunction_},e.prototype.getFill=function(){return this.fill_},e.prototype.setFill=function(e){this.fill_=e},e.prototype.getImage=function(){return this.image_},e.prototype.setImage=function(e){this.image_=e},e.prototype.getStroke=function(){return this.stroke_},e.prototype.setStroke=function(e){this.stroke_=e},e.prototype.getText=function(){return this.text_},e.prototype.setText=function(e){this.text_=e},e.prototype.getZIndex=function(){return this.zIndex_},e.prototype.setGeometry=function(e){"function"==typeof e?this.geometryFunction_=e:"string"==typeof e?this.geometryFunction_=function(t){return t.get(e)}:e?void 0!==e&&(this.geometryFunction_=function(){return e}):this.geometryFunction_=Ms,this.geometry_=e},e.prototype.setZIndex=function(e){this.zIndex_=e},e}(),Cs=null;function bs(e,t){if(!Cs){var r=new _s({color:"rgba(255,255,255,0.4)"}),i=new ys({color:"#3399CC",width:1.25});Cs=[new Ts({image:new xs({fill:r,stroke:i,radius:5}),fill:r,stroke:i})]}return Cs}function Ms(e){return e.getGeometry()}var As,Es,Ls,ws,Ss,Ds=(Ss=function(e,t){return(Ss=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Ss(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Rs="renderOrder",Ps=function(e){function t(t){var r=this,i=t||{},o=h({},i);return delete o.style,delete o.renderBuffer,delete o.updateWhileAnimating,delete o.updateWhileInteracting,(r=e.call(this,o)||this).declutter_=void 0!==i.declutter&&i.declutter,r.renderBuffer_=void 0!==i.renderBuffer?i.renderBuffer:100,r.style_=null,r.styleFunction_=void 0,r.setStyle(i.style),r.updateWhileAnimating_=void 0!==i.updateWhileAnimating&&i.updateWhileAnimating,r.updateWhileInteracting_=void 0!==i.updateWhileInteracting&&i.updateWhileInteracting,r}return Ds(t,e),t.prototype.getDeclutter=function(){return this.declutter_},t.prototype.getFeatures=function(t){return e.prototype.getFeatures.call(this,t)},t.prototype.getRenderBuffer=function(){return this.renderBuffer_},t.prototype.getRenderOrder=function(){return this.get(Rs)},t.prototype.getStyle=function(){return this.style_},t.prototype.getStyleFunction=function(){return this.styleFunction_},t.prototype.getUpdateWhileAnimating=function(){return this.updateWhileAnimating_},t.prototype.getUpdateWhileInteracting=function(){return this.updateWhileInteracting_},t.prototype.setRenderOrder=function(e){this.set(Rs,e)},t.prototype.setStyle=function(e){this.style_=void 0!==e?e:bs,this.styleFunction_=null===e?void 0:function(e){var t,r;"function"==typeof e?t=e:(Array.isArray(e)?r=e:(Oe("function"==typeof e.getZIndex,41),r=[e]),t=function(){return r});return t}(this.style_),this.changed()},t}(Co),Is={BEGIN_GEOMETRY:0,BEGIN_PATH:1,CIRCLE:2,CLOSE_PATH:3,CUSTOM:4,DRAW_CHARS:5,DRAW_IMAGE:6,END_GEOMETRY:7,FILL:8,MOVE_TO_LINE_TO:9,SET_FILL_STYLE:10,SET_STROKE_STYLE:11,STROKE:12},Fs=[Is.FILL],Os=[Is.STROKE],Bs=[Is.BEGIN_PATH],Ns=[Is.CLOSE_PATH],Us=Is,Gs=(ws=function(e,t){return(ws=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}ws(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),zs=function(e){function t(t,r,i,o){var n=e.call(this)||this;return n.tolerance=t,n.maxExtent=r,n.pixelRatio=o,n.maxLineWidth=0,n.resolution=i,n.beginGeometryInstruction1_=null,n.beginGeometryInstruction2_=null,n.bufferedMaxExtent_=null,n.instructions=[],n.coordinates=[],n.tmpCoordinate_=[],n.hitDetectionInstructions=[],n.state={},n}return Gs(t,e),t.prototype.applyPixelRatio=function(e){var t=this.pixelRatio;return 1==t?e:e.map(function(e){return e*t})},t.prototype.appendFlatCoordinates=function(e,t,r,i,o,n){var a=this.coordinates.length,s=this.getBufferedMaxExtent();n&&(t+=i);var l,u,c,d=e[t],h=e[t+1],f=this.tmpCoordinate_,g=!0;for(l=t+i;l<r;l+=i)f[0]=e[l],f[1]=e[l+1],(c=ht(s,f))!==u?(g&&(this.coordinates[a++]=d,this.coordinates[a++]=h),this.coordinates[a++]=f[0],this.coordinates[a++]=f[1],g=!1):c===et?(this.coordinates[a++]=f[0],this.coordinates[a++]=f[1],g=!1):g=!0,d=f[0],h=f[1],u=c;return(o&&g||l===t+i)&&(this.coordinates[a++]=d,this.coordinates[a++]=h),a},t.prototype.drawCustomCoordinates_=function(e,t,r,i,o){for(var n=0,a=r.length;n<a;++n){var s=r[n],l=this.appendFlatCoordinates(e,t,s,i,!1,!1);o.push(l),t=s}return t},t.prototype.drawCustom=function(e,t,r){this.beginGeometry(e,t);var i,o,n,a,s,l=e.getType(),u=e.getStride(),c=this.coordinates.length;if(l==Qt){i=(e=e).getOrientedFlatCoordinates(),a=[];var d=e.getEndss();s=0;for(var h=0,f=d.length;h<f;++h){var g=[];s=this.drawCustomCoordinates_(i,s,d[h],u,g),a.push(g)}this.instructions.push([Us.CUSTOM,c,a,e,r,fi])}else l==Kt||l==Jt?(n=[],i=l==Kt?e.getOrientedFlatCoordinates():e.getFlatCoordinates(),s=this.drawCustomCoordinates_(i,0,e.getEnds(),u,n),this.instructions.push([Us.CUSTOM,c,n,e,r,hi])):l==qt||l==Zt?(i=e.getFlatCoordinates(),o=this.appendFlatCoordinates(i,0,i.length,u,!1,!1),this.instructions.push([Us.CUSTOM,c,o,e,r,di])):l==Yt&&(i=e.getFlatCoordinates(),this.coordinates.push(i[0],i[1]),o=this.coordinates.length,this.instructions.push([Us.CUSTOM,c,o,e,r]));this.endGeometry(t)},t.prototype.beginGeometry=function(e,t){var r=e.getExtent();this.beginGeometryInstruction1_=[Us.BEGIN_GEOMETRY,t,0,r],this.instructions.push(this.beginGeometryInstruction1_),this.beginGeometryInstruction2_=[Us.BEGIN_GEOMETRY,t,0,r],this.hitDetectionInstructions.push(this.beginGeometryInstruction2_)},t.prototype.finish=function(){return{instructions:this.instructions,hitDetectionInstructions:this.hitDetectionInstructions,coordinates:this.coordinates}},t.prototype.reverseHitDetectionInstructions=function(){var e,t=this.hitDetectionInstructions;t.reverse();var r,i,o=t.length,n=-1;for(e=0;e<o;++e)(i=(r=t[e])[0])==Us.END_GEOMETRY?n=e:i==Us.BEGIN_GEOMETRY&&(r[2]=e,C(this.hitDetectionInstructions,n,e),n=-1)},t.prototype.setFillStrokeStyle=function(e,t){var r=this.state;if(e){var i=e.getColor();r.fillStyle=ra(i||"#000")}else r.fillStyle=void 0;if(t){var o=t.getColor();r.strokeStyle=ra(o||"#000");var n=t.getLineCap();r.lineCap=void 0!==n?n:"round";var a=t.getLineDash();r.lineDash=a?a.slice():oa;var s=t.getLineDashOffset();r.lineDashOffset=s||0;var l=t.getLineJoin();r.lineJoin=void 0!==l?l:"round";var u=t.getWidth();r.lineWidth=void 0!==u?u:1;var c=t.getMiterLimit();r.miterLimit=void 0!==c?c:10,r.lineWidth>this.maxLineWidth&&(this.maxLineWidth=r.lineWidth,this.bufferedMaxExtent_=null)}else r.strokeStyle=void 0,r.lineCap=void 0,r.lineDash=null,r.lineDashOffset=void 0,r.lineJoin=void 0,r.lineWidth=void 0,r.miterLimit=void 0},t.prototype.createFill=function(e){var t=e.fillStyle,r=[Us.SET_FILL_STYLE,t];return"string"!=typeof t&&r.push(!0),r},t.prototype.applyStroke=function(e){this.instructions.push(this.createStroke(e))},t.prototype.createStroke=function(e){return[Us.SET_STROKE_STYLE,e.strokeStyle,e.lineWidth*this.pixelRatio,e.lineCap,e.lineJoin,e.miterLimit,this.applyPixelRatio(e.lineDash),e.lineDashOffset*this.pixelRatio]},t.prototype.updateFillStyle=function(e,t){var r=e.fillStyle;"string"==typeof r&&e.currentFillStyle==r||(void 0!==r&&this.instructions.push(t.call(this,e)),e.currentFillStyle=r)},t.prototype.updateStrokeStyle=function(e,t){var r=e.strokeStyle,i=e.lineCap,o=e.lineDash,n=e.lineDashOffset,a=e.lineJoin,s=e.lineWidth,l=e.miterLimit;(e.currentStrokeStyle!=r||e.currentLineCap!=i||o!=e.currentLineDash&&!M(e.currentLineDash,o)||e.currentLineDashOffset!=n||e.currentLineJoin!=a||e.currentLineWidth!=s||e.currentMiterLimit!=l)&&(void 0!==r&&t.call(this,e),e.currentStrokeStyle=r,e.currentLineCap=i,e.currentLineDash=o,e.currentLineDashOffset=n,e.currentLineJoin=a,e.currentLineWidth=s,e.currentMiterLimit=l)},t.prototype.endGeometry=function(e){this.beginGeometryInstruction1_[2]=this.instructions.length,this.beginGeometryInstruction1_=null,this.beginGeometryInstruction2_[2]=this.hitDetectionInstructions.length,this.beginGeometryInstruction2_=null;var t=[Us.END_GEOMETRY,e];this.instructions.push(t),this.hitDetectionInstructions.push(t)},t.prototype.getBufferedMaxExtent=function(){if(!this.bufferedMaxExtent_&&(this.bufferedMaxExtent_=st(this.maxExtent),this.maxLineWidth>0)){var e=this.resolution*(this.maxLineWidth+1)/2;at(this.bufferedMaxExtent_,e,this.bufferedMaxExtent_)}return this.bufferedMaxExtent_},t}(ia),Hs=(Ls=function(e,t){return(Ls=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Ls(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Vs=function(e){function t(t,r,i,o){var n=e.call(this,t,r,i,o)||this;return n.declutterGroups_=null,n.hitDetectionImage_=null,n.image_=null,n.anchorX_=void 0,n.anchorY_=void 0,n.height_=void 0,n.opacity_=void 0,n.originX_=void 0,n.originY_=void 0,n.rotateWithView_=void 0,n.rotation_=void 0,n.scale_=void 0,n.width_=void 0,n}return Hs(t,e),t.prototype.drawCoordinates_=function(e,t,r,i){return this.appendFlatCoordinates(e,t,r,i,!1,!1)},t.prototype.drawPoint=function(e,t){if(this.image_){this.beginGeometry(e,t);var r=e.getFlatCoordinates(),i=e.getStride(),o=this.coordinates.length,n=this.drawCoordinates_(r,0,r.length,i);this.instructions.push([Us.DRAW_IMAGE,o,n,this.image_,this.anchorX_,this.anchorY_,this.declutterGroups_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_*this.pixelRatio,this.width_]),this.hitDetectionInstructions.push([Us.DRAW_IMAGE,o,n,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.declutterGroups_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_]),this.endGeometry(t)}},t.prototype.drawMultiPoint=function(e,t){if(this.image_){this.beginGeometry(e,t);var r=e.getFlatCoordinates(),i=e.getStride(),o=this.coordinates.length,n=this.drawCoordinates_(r,0,r.length,i);this.instructions.push([Us.DRAW_IMAGE,o,n,this.image_,this.anchorX_,this.anchorY_,this.declutterGroups_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_*this.pixelRatio,this.width_]),this.hitDetectionInstructions.push([Us.DRAW_IMAGE,o,n,this.hitDetectionImage_,this.anchorX_,this.anchorY_,this.declutterGroups_,this.height_,this.opacity_,this.originX_,this.originY_,this.rotateWithView_,this.rotation_,this.scale_,this.width_]),this.endGeometry(t)}},t.prototype.finish=function(){return this.reverseHitDetectionInstructions(),this.anchorX_=void 0,this.anchorY_=void 0,this.hitDetectionImage_=null,this.image_=null,this.height_=void 0,this.scale_=void 0,this.opacity_=void 0,this.originX_=void 0,this.originY_=void 0,this.rotateWithView_=void 0,this.rotation_=void 0,this.width_=void 0,e.prototype.finish.call(this)},t.prototype.setImageStyle=function(e,t){var r=e.getAnchor(),i=e.getSize(),o=e.getHitDetectionImage(1),n=e.getImage(1),a=e.getOrigin();this.anchorX_=r[0],this.anchorY_=r[1],this.declutterGroups_=t,this.hitDetectionImage_=o,this.image_=n,this.height_=i[1],this.opacity_=e.getOpacity(),this.originX_=a[0],this.originY_=a[1],this.rotateWithView_=e.getRotateWithView(),this.rotation_=e.getRotation(),this.scale_=e.getScale(),this.width_=i[0]},t}(zs),ks=(Es=function(e,t){return(Es=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Es(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),js=function(e){function t(t,r,i,o){return e.call(this,t,r,i,o)||this}return ks(t,e),t.prototype.drawFlatCoordinates_=function(e,t,r,i){var o=this.coordinates.length,n=this.appendFlatCoordinates(e,t,r,i,!1,!1),a=[Us.MOVE_TO_LINE_TO,o,n];return this.instructions.push(a),this.hitDetectionInstructions.push(a),r},t.prototype.drawLineString=function(e,t){var r=this.state,i=r.strokeStyle,o=r.lineWidth;if(void 0!==i&&void 0!==o){this.updateStrokeStyle(r,this.applyStroke),this.beginGeometry(e,t),this.hitDetectionInstructions.push([Us.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset],Bs);var n=e.getFlatCoordinates(),a=e.getStride();this.drawFlatCoordinates_(n,0,n.length,a),this.hitDetectionInstructions.push(Os),this.endGeometry(t)}},t.prototype.drawMultiLineString=function(e,t){var r=this.state,i=r.strokeStyle,o=r.lineWidth;if(void 0!==i&&void 0!==o){this.updateStrokeStyle(r,this.applyStroke),this.beginGeometry(e,t),this.hitDetectionInstructions.push([Us.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset],Bs);for(var n=e.getEnds(),a=e.getFlatCoordinates(),s=e.getStride(),l=0,u=0,c=n.length;u<c;++u)l=this.drawFlatCoordinates_(a,l,n[u],s);this.hitDetectionInstructions.push(Os),this.endGeometry(t)}},t.prototype.finish=function(){var t=this.state;return null!=t.lastStroke&&t.lastStroke!=this.coordinates.length&&this.instructions.push(Os),this.reverseHitDetectionInstructions(),this.state=null,e.prototype.finish.call(this)},t.prototype.applyStroke=function(t){null!=t.lastStroke&&t.lastStroke!=this.coordinates.length&&(this.instructions.push(Os),t.lastStroke=this.coordinates.length),t.lastStroke=0,e.prototype.applyStroke.call(this,t),this.instructions.push(Bs)},t}(zs),Ws=(As=function(e,t){return(As=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}As(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Xs=function(e){function t(t,r,i,o){return e.call(this,t,r,i,o)||this}return Ws(t,e),t.prototype.drawFlatCoordinatess_=function(e,t,r,i){var o=this.state,n=void 0!==o.fillStyle,a=void 0!==o.strokeStyle,s=r.length;this.instructions.push(Bs),this.hitDetectionInstructions.push(Bs);for(var l=0;l<s;++l){var u=r[l],c=this.coordinates.length,d=this.appendFlatCoordinates(e,t,u,i,!0,!a),h=[Us.MOVE_TO_LINE_TO,c,d];this.instructions.push(h),this.hitDetectionInstructions.push(h),a&&(this.instructions.push(Ns),this.hitDetectionInstructions.push(Ns)),t=u}return n&&(this.instructions.push(Fs),this.hitDetectionInstructions.push(Fs)),a&&(this.instructions.push(Os),this.hitDetectionInstructions.push(Os)),t},t.prototype.drawCircle=function(e,t){var r=this.state,i=r.fillStyle,o=r.strokeStyle;if(void 0!==i||void 0!==o){this.setFillStrokeStyles_(),this.beginGeometry(e,t),void 0!==r.fillStyle&&this.hitDetectionInstructions.push([Us.SET_FILL_STYLE,"#000"]),void 0!==r.strokeStyle&&this.hitDetectionInstructions.push([Us.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset]);var n=e.getFlatCoordinates(),a=e.getStride(),s=this.coordinates.length;this.appendFlatCoordinates(n,0,n.length,a,!1,!1);var l=[Us.CIRCLE,s];this.instructions.push(Bs,l),this.hitDetectionInstructions.push(Bs,l),void 0!==r.fillStyle&&(this.instructions.push(Fs),this.hitDetectionInstructions.push(Fs)),void 0!==r.strokeStyle&&(this.instructions.push(Os),this.hitDetectionInstructions.push(Os)),this.endGeometry(t)}},t.prototype.drawPolygon=function(e,t){var r=this.state,i=r.fillStyle,o=r.strokeStyle;if(void 0!==i||void 0!==o){this.setFillStrokeStyles_(),this.beginGeometry(e,t),void 0!==r.fillStyle&&this.hitDetectionInstructions.push([Us.SET_FILL_STYLE,"#000"]),void 0!==r.strokeStyle&&this.hitDetectionInstructions.push([Us.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset]);var n=e.getEnds(),a=e.getOrientedFlatCoordinates(),s=e.getStride();this.drawFlatCoordinatess_(a,0,n,s),this.endGeometry(t)}},t.prototype.drawMultiPolygon=function(e,t){var r=this.state,i=r.fillStyle,o=r.strokeStyle;if(void 0!==i||void 0!==o){this.setFillStrokeStyles_(),this.beginGeometry(e,t),void 0!==r.fillStyle&&this.hitDetectionInstructions.push([Us.SET_FILL_STYLE,"#000"]),void 0!==r.strokeStyle&&this.hitDetectionInstructions.push([Us.SET_STROKE_STYLE,r.strokeStyle,r.lineWidth,r.lineCap,r.lineJoin,r.miterLimit,r.lineDash,r.lineDashOffset]);for(var n=e.getEndss(),a=e.getOrientedFlatCoordinates(),s=e.getStride(),l=0,u=0,c=n.length;u<c;++u)l=this.drawFlatCoordinatess_(a,l,n[u],s);this.endGeometry(t)}},t.prototype.finish=function(){this.reverseHitDetectionInstructions(),this.state=null;var t=this.tolerance;if(0!==t)for(var r=this.coordinates,i=0,o=r.length;i<o;++i)r[i]=gi(r[i],t);return e.prototype.finish.call(this)},t.prototype.setFillStrokeStyles_=function(){var e=this.state;void 0!==e.fillStyle&&this.updateFillStyle(e,this.createFill),void 0!==e.strokeStyle&&this.updateStrokeStyle(e,this.applyStroke)},t}(zs);function Ys(e,t,r,i,o){var n,a,s,l,u,c,d,h,f,g=r,p=r,m=0,v=0,x=r;for(n=r;n<i;n+=o){var _=t[n],y=t[n+1];void 0!==l&&(h=_-l,f=y-u,s=Math.sqrt(h*h+f*f),void 0!==c&&(v+=a,Math.acos((c*h+d*f)/(a*s))>e&&(v>m&&(m=v,g=x,p=n),v=0,x=n-o)),a=s,c=h,d=f),l=_,u=y}return(v+=s)>m?[x,n]:[g,p]}var qs,Ks=(qs=function(e,t){return(qs=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}qs(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Zs={left:0,end:0,center:.5,right:1,start:1,top:0,middle:.5,hanging:.2,alphabetic:.8,ideographic:.8,bottom:1},Js={Circle:Xs,Default:zs,Image:Vs,LineString:js,Polygon:Xs,Text:function(e){function t(t,r,i,o){var n=e.call(this,t,r,i,o)||this;return n.declutterGroups_,n.labels_=null,n.text_="",n.textOffsetX_=0,n.textOffsetY_=0,n.textRotateWithView_=void 0,n.textRotation_=0,n.textFillState_=null,n.fillStates={},n.textStrokeState_=null,n.strokeStates={},n.textState_={},n.textStates={},n.textKey_="",n.fillKey_="",n.strokeKey_="",n}return Ks(t,e),t.prototype.finish=function(){var t=e.prototype.finish.call(this);return t.textStates=this.textStates,t.fillStates=this.fillStates,t.strokeStates=this.strokeStates,t},t.prototype.drawText=function(e,t){var r=this.textFillState_,i=this.textStrokeState_,o=this.textState_;if(""!==this.text_&&o&&(r||i)){var n,a,s=this.coordinates.length,l=e.getType(),u=null,c=2,d=2;if("line"===o.placement){if(!Dt(this.getBufferedMaxExtent(),e.getExtent()))return;var h=void 0;if(u=e.getFlatCoordinates(),d=e.getStride(),l==qt)h=[u.length];else if(l==Jt)h=e.getEnds();else if(l==Kt)h=e.getEnds().slice(0,1);else if(l==Qt){var f=e.getEndss();for(h=[],n=0,a=f.length;n<a;++n)h.push(f[n][0])}this.beginGeometry(e,t);for(var g=o.textAlign,p=0,m=void 0,v=0,x=h.length;v<x;++v){if(null==g){var _=Ys(o.maxAngle,u,p,h[v],d);p=_[0],m=_[1]}else m=h[v];for(n=p;n<m;n+=d)this.coordinates.push(u[n],u[n+1]);c=this.coordinates.length,p=h[v];var y=this.declutterGroups_?0===v?this.declutterGroups_[0]:[].concat(this.declutterGroups_[0]):null;this.drawChars_(s,c,y),s=c}this.endGeometry(t)}else{var T=null;switch(o.overflow||(T=[]),l){case Yt:case Zt:c=(u=e.getFlatCoordinates()).length;break;case qt:u=e.getFlatMidpoint();break;case er:u=e.getCenter();break;case Jt:c=(u=e.getFlatMidpoints()).length;break;case Kt:u=e.getFlatInteriorPoint(),o.overflow||T.push(u[2]/this.resolution),d=3;break;case Qt:var C=e.getFlatInteriorPoints();for(u=[],n=0,a=C.length;n<a;n+=3)o.overflow||T.push(C[n+2]/this.resolution),u.push(C[n],C[n+1]);if(0==(c=u.length))return}c=this.appendFlatCoordinates(u,0,c,d,!1,!1),this.saveTextStates_(),(o.backgroundFill||o.backgroundStroke)&&(this.setFillStrokeStyle(o.backgroundFill,o.backgroundStroke),o.backgroundFill&&(this.updateFillStyle(this.state,this.createFill),this.hitDetectionInstructions.push(this.createFill(this.state))),o.backgroundStroke&&(this.updateStrokeStyle(this.state,this.applyStroke),this.hitDetectionInstructions.push(this.createStroke(this.state)))),this.beginGeometry(e,t);var b=this.pixelRatio;this.instructions.push([Us.DRAW_IMAGE,s,c,null,NaN,NaN,this.declutterGroups_,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,1,NaN,o.padding==na?na:o.padding.map(function(e){return e*b}),!!o.backgroundFill,!!o.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,T]),this.hitDetectionInstructions.push([Us.DRAW_IMAGE,s,c,null,NaN,NaN,this.declutterGroups_,NaN,1,0,0,this.textRotateWithView_,this.textRotation_,1/this.pixelRatio,NaN,o.padding,!!o.backgroundFill,!!o.backgroundStroke,this.text_,this.textKey_,this.strokeKey_,this.fillKey_,this.textOffsetX_,this.textOffsetY_,T]),this.endGeometry(t)}}},t.prototype.saveTextStates_=function(){var e=this.textStrokeState_,t=this.textState_,r=this.textFillState_,i=this.strokeKey_;e&&(i in this.strokeStates||(this.strokeStates[i]={strokeStyle:e.strokeStyle,lineCap:e.lineCap,lineDashOffset:e.lineDashOffset,lineWidth:e.lineWidth,lineJoin:e.lineJoin,miterLimit:e.miterLimit,lineDash:e.lineDash}));var o=this.textKey_;o in this.textStates||(this.textStates[o]={font:t.font,textAlign:t.textAlign||"center",textBaseline:t.textBaseline||"middle",scale:t.scale});var n=this.fillKey_;r&&(n in this.fillStates||(this.fillStates[n]={fillStyle:r.fillStyle}))},t.prototype.drawChars_=function(e,t,r){var i=this.textStrokeState_,o=this.textState_,n=this.strokeKey_,a=this.textKey_,s=this.fillKey_;this.saveTextStates_();var l=this.pixelRatio,u=Zs[o.textBaseline],c=this.textOffsetY_*l,d=this.text_,h=o.scale,f=i?i.lineWidth*h/2:0;this.instructions.push([Us.DRAW_CHARS,e,t,u,r,o.overflow,s,o.maxAngle,l,c,n,f*l,d,a,1]),this.hitDetectionInstructions.push([Us.DRAW_CHARS,e,t,u,r,o.overflow,s,o.maxAngle,1,c,n,f,d,a,1/l])},t.prototype.setTextStyle=function(e,t){var r,i,o;if(e){this.declutterGroups_=t;var a=e.getFill();a?((i=this.textFillState_)||(i={},this.textFillState_=i),i.fillStyle=ra(a.getColor()||"#000")):(i=null,this.textFillState_=i);var s=e.getStroke();if(s){(o=this.textStrokeState_)||(o={},this.textStrokeState_=o);var l=s.getLineDash(),u=s.getLineDashOffset(),c=s.getWidth(),d=s.getMiterLimit();o.lineCap=s.getLineCap()||"round",o.lineDash=l?l.slice():oa,o.lineDashOffset=void 0===u?0:u,o.lineJoin=s.getLineJoin()||"round",o.lineWidth=void 0===c?1:c,o.miterLimit=void 0===d?10:d,o.strokeStyle=ra(s.getColor()||"#000")}else o=null,this.textStrokeState_=o;r=this.textState_;var h=e.getFont()||"10px sans-serif";ha(h);var f=e.getScale();r.overflow=e.getOverflow(),r.font=h,r.maxAngle=e.getMaxAngle(),r.placement=e.getPlacement(),r.textAlign=e.getTextAlign(),r.textBaseline=e.getTextBaseline()||"middle",r.backgroundFill=e.getBackgroundFill(),r.backgroundStroke=e.getBackgroundStroke(),r.padding=e.getPadding()||na,r.scale=void 0===f?1:f;var g=e.getOffsetX(),p=e.getOffsetY(),m=e.getRotateWithView(),v=e.getRotation();this.text_=e.getText()||"",this.textOffsetX_=void 0===g?0:g,this.textOffsetY_=void 0===p?0:p,this.textRotateWithView_=void 0!==m&&m,this.textRotation_=void 0===v?0:v,this.strokeKey_=o?("string"==typeof o.strokeStyle?o.strokeStyle:n(o.strokeStyle))+o.lineCap+o.lineDashOffset+"|"+o.lineWidth+o.lineJoin+o.miterLimit+"["+o.lineDash.join()+"]":"",this.textKey_=r.font+r.scale+(r.textAlign||"?")+(r.textBaseline||"?"),this.fillKey_=i?"string"==typeof i.fillStyle?i.fillStyle:"|"+n(i.fillStyle):""}else this.text_=""},t}(zs)},Qs=function(){function e(e,t,r,i,o){this.declutter_=o,this.declutterGroups_=null,this.tolerance_=e,this.maxExtent_=t,this.pixelRatio_=i,this.resolution_=r,this.buildersByZIndex_={}}return e.prototype.addDeclutter=function(e){var t=null;return this.declutter_&&(e?(t=this.declutterGroups_)[0][4]++:(t=[[1/0,1/0,-1/0,-1/0]],this.declutterGroups_=t,t[0].push(1))),t},e.prototype.finish=function(){var e={};for(var t in this.buildersByZIndex_){e[t]=e[t]||{};var r=this.buildersByZIndex_[t];for(var i in r){var o=r[i].finish();e[t][i]=o}}return e},e.prototype.getBuilder=function(e,t){var r=void 0!==e?e.toString():"0",i=this.buildersByZIndex_[r];void 0===i&&(i={},this.buildersByZIndex_[r]=i);var o=i[t];return void 0===o&&(o=new(0,Js[t])(this.tolerance_,this.maxExtent_,this.resolution_,this.pixelRatio_),i[t]=o),o},e}();function $s(e,t,r,i){for(var o=e[t],n=e[t+1],a=0,s=t+i;s<r;s+=i){var l=e[s],u=e[s+1];a+=Math.sqrt((l-o)*(l-o)+(u-n)*(u-n)),o=l,n=u}return a}function el(e,t,r,i,o,n,a,s,l,u,c){for(var d,h,f=[],g=e[t]>e[r-i],p=o.length,m=e[t],v=e[t+1],x=e[t+=i],_=e[t+1],y=0,T=Math.sqrt(Math.pow(x-m,2)+Math.pow(_-v,2)),C=!1,b=0;b<p;++b){for(var M=o[d=g?p-b-1:b],A=s*l(u,M,c),E=n+A/2;t<r-i&&y+T<E;)m=x,v=_,x=e[t+=i],_=e[t+1],y+=T,T=Math.sqrt(Math.pow(x-m,2)+Math.pow(_-v,2));var L=E-y,w=Math.atan2(_-v,x-m);if(g&&(w+=w>0?-Math.PI:Math.PI),void 0!==h){var S=w-h;if(C=C||0!==S,S+=S>Math.PI?-2*Math.PI:S<-Math.PI?2*Math.PI:0,Math.abs(S)>a)return null}h=w;var D=L/T,R=Xe(m,x,D),P=Xe(v,_,D);f[d]=[R,P,A/2,w,M],n+=A}return C?f:[[f[0][0],f[0][1],f[0][2],f[0][3],o]]}var tl=r(0),rl=r.n(tl),il=[1/0,1/0,-1/0,-1/0],ol=[1,0,0,1,0,0],nl=[],al=[],sl=[],ll=[],ul=function(){function e(e,t,r,i){this.overlaps=r,this.pixelRatio=t,this.resolution=e,this.alignFill_,this.declutterItems=[],this.instructions=i.instructions,this.coordinates=i.coordinates,this.coordinateCache_={},this.renderedTransform_=[1,0,0,1,0,0],this.hitDetectionInstructions=i.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=i.fillStates||{},this.strokeStates=i.strokeStates||{},this.textStates=i.textStates||{},this.widths_={},this.labels_={}}return e.prototype.createLabel=function(e,t,r,i){var o=e+t+r+i;if(this.labels_[o])return this.labels_[o];var n=i?this.strokeStates[i]:null,a=r?this.fillStates[r]:null,s=this.textStates[t],l=this.pixelRatio,u=s.scale*l,c=Zs[s.textAlign||"center"],d=i&&n.lineWidth?n.lineWidth:0,h=e.split("\n"),f=h.length,g=[],p=function(e,t,r){for(var i=t.length,o=0,n=0;n<i;++n){var a=pa(e,t[n]);o=Math.max(o,a),r.push(a)}return o}(s.font,h,g),m=fa(s.font),v=m*f,x=p+d,_=[],y={width:Math.ceil((x+2)*u),height:Math.ceil((v+d)*u),contextInstructions:_};1!=u&&_.push("scale",[u,u]),_.push("font",s.font),i&&(_.push("strokeStyle",n.strokeStyle),_.push("lineWidth",d),_.push("lineCap",n.lineCap),_.push("lineJoin",n.lineJoin),_.push("miterLimit",n.miterLimit),(me?OffscreenCanvasRenderingContext2D:CanvasRenderingContext2D).prototype.setLineDash&&(_.push("setLineDash",[n.lineDash]),_.push("lineDashOffset",n.lineDashOffset))),r&&_.push("fillStyle",a.fillStyle),_.push("textBaseline","middle"),_.push("textAlign","center");var T,C=.5-c,b=c*x+C*d;if(i)for(T=0;T<f;++T)_.push("strokeText",[h[T],b+C*g[T],.5*(d+m)+T*m]);if(r)for(T=0;T<f;++T)_.push("fillText",[h[T],b+C*g[T],.5*(d+m)+T*m]);return this.labels_[o]=y,y},e.prototype.replayTextBackground_=function(e,t,r,i,o,n,a){e.beginPath(),e.moveTo.apply(e,t),e.lineTo.apply(e,r),e.lineTo.apply(e,i),e.lineTo.apply(e,o),e.lineTo.apply(e,t),n&&(this.alignFill_=n[2],this.fill_(e)),a&&(this.setStrokeStyle_(e,a),e.stroke())},e.prototype.replayImageOrLabel_=function(e,t,r,i,o,n,a,s,l,u,c,d,h,f,g,p,m,v){var x=m||v;t-=o*=h,r-=n*=h;var _=g+u>i.width?i.width-u:g,y=s+c>i.height?i.height-c:s,T=p[3]+_*h+p[1],C=p[0]+y*h+p[2],b=t-p[3],M=r-p[0];(x||0!==d)&&(nl[0]=b,ll[0]=b,nl[1]=M,al[1]=M,al[0]=b+T,sl[0]=al[0],sl[1]=M+C,ll[1]=sl[1]);var A=null;if(0!==d){var E=t+o,L=r+n;A=Kr(ol,E,L,1,1,d,-E,-L),qr(ol,nl),qr(ol,al),qr(ol,sl),qr(ol,ll),ft(Math.min(nl[0],al[0],sl[0],ll[0]),Math.min(nl[1],al[1],sl[1],ll[1]),Math.max(nl[0],al[0],sl[0],ll[0]),Math.max(nl[1],al[1],sl[1],ll[1]),il)}else ft(b,M,b+T,M+C,il);var w=e.canvas,S=v?v[2]*h/2:0,D=il[0]-S<=w.width&&il[2]+S>=0&&il[1]-S<=w.height&&il[3]+S>=0;if(f&&(t=Math.round(t),r=Math.round(r)),a){if(!D&&1==a[4])return;mt(a,il);var R=D?[e,A?A.slice(0):null,l,i,u,c,_,y,t,r,h]:null;R&&(x&&R.push(m,v,nl.slice(0),al.slice(0),sl.slice(0),ll.slice(0)),a.push(R))}else D&&(x&&this.replayTextBackground_(e,nl,al,sl,ll,m,v),xa(e,A,l,i,u,c,_,y,t,r,h))},e.prototype.fill_=function(e){if(this.alignFill_){var t=qr(this.renderedTransform_,[0,0]),r=512*this.pixelRatio;e.save(),e.translate(t[0]%r,t[1]%r),e.rotate(this.viewRotation_)}e.fill(),this.alignFill_&&e.restore()},e.prototype.setStrokeStyle_=function(e,t){e.strokeStyle=t[1],e.lineWidth=t[2],e.lineCap=t[3],e.lineJoin=t[4],e.miterLimit=t[5],e.setLineDash&&(e.lineDashOffset=t[7],e.setLineDash(t[6]))},e.prototype.renderDeclutter=function(e,t,r,i){if(e&&e.length>5){var o=e[4];if(1==o||o==e.length-5){var n={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};if(i||(i=new rl.a(9)),!i.collides(n)){i.insert(n);for(var a=5,s=e.length;a<s;++a){var l=e[a],u=l[0],c=u.globalAlpha;c!==r&&(u.globalAlpha=r),l.length>11&&this.replayTextBackground_(l[0],l[13],l[14],l[15],l[16],l[11],l[12]),xa.apply(void 0,l),c!==r&&(u.globalAlpha=c)}}e.length=5,gt(e)}}return i},e.prototype.drawLabelWithPointPlacement_=function(e,t,r,i){var o=this.textStates[t],n=this.createLabel(e,t,i,r),a=this.strokeStates[r],s=this.pixelRatio,l=Zs[o.textAlign||"center"],u=Zs[o.textBaseline||"middle"],c=a&&a.lineWidth?a.lineWidth:0;return{label:n,anchorX:l*(n.width/s-2*o.scale)+2*(.5-l)*c,anchorY:u*n.height/s+2*(.5-u)*c}},e.prototype.execute_=function(e,t,r,i,o,n){var a,s,l;this.declutterItems.length=0,this.pixelCoordinates_&&M(t,this.renderedTransform_)?a=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),a=nr(this.coordinates,0,this.coordinates.length,2,t,this.pixelCoordinates_),l=t,(s=this.renderedTransform_)[0]=l[0],s[1]=l[1],s[2]=l[2],s[3]=l[3],s[4]=l[4],s[5]=l[5]);for(var u,c,d,h,f,g,p,m,v,x,_,y,T,C,b,A,E,L=0,w=r.length,S=0,D=0,R=0,P=null,I=null,F=this.coordinateCache_,O=this.viewRotation_,B=Math.round(1e12*Math.atan2(-t[1],t[0]))/1e12,N={context:e,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:O},U=this.instructions!=r||this.overlaps?0:200;L<w;){var G=r[L];switch(G[0]){case Us.BEGIN_GEOMETRY:(b=G[1]).getGeometry()?void 0===n||Dt(n,G[3])?++L:L=G[2]+1:L=G[2];break;case Us.BEGIN_PATH:D>U&&(this.fill_(e),D=0),R>U&&(e.stroke(),R=0),D||R||(e.beginPath(),h=NaN,f=NaN),++L;break;case Us.CIRCLE:var z=a[S=G[1]],H=a[S+1],V=a[S+2]-z,k=a[S+3]-H,j=Math.sqrt(V*V+k*k);e.moveTo(z+j,H),e.arc(z,H,j,0,2*Math.PI,!0),++L;break;case Us.CLOSE_PATH:e.closePath(),++L;break;case Us.CUSTOM:S=G[1],u=G[2];var W=G[3],X=G[4],Y=6==G.length?G[5]:void 0;N.geometry=W,N.feature=b,L in F||(F[L]=[]);var q=F[L];Y?Y(a,S,u,2,q):(q[0]=a[S],q[1]=a[S+1],q.length=2),X(q,N),++L;break;case Us.DRAW_IMAGE:S=G[1],u=G[2],x=G[3],c=G[4],d=G[5],v=o?null:G[6];var K=G[7],Z=G[8],J=G[9],Q=G[10],$=G[11],ee=G[12],te=G[13],re=G[14];if(!x&&G.length>=19){_=G[18],y=G[19],T=G[20],C=G[21];var ie=this.drawLabelWithPointPlacement_(_,y,T,C);x=ie.label,G[3]=x;var oe=G[22];c=(ie.anchorX-oe)*this.pixelRatio,G[4]=c;var ne=G[23];d=(ie.anchorY-ne)*this.pixelRatio,G[5]=d,K=x.height,G[7]=K,re=x.width,G[14]=re}var ae=void 0;G.length>24&&(ae=G[24]);var se=void 0,le=void 0,ue=void 0;G.length>16?(se=G[15],le=G[16],ue=G[17]):(se=na,le=!1,ue=!1),$&&B?ee+=O:$||B||(ee-=O);for(var ce=0,de=0;S<u;S+=2)if(!(ae&&ae[ce++]<re/this.pixelRatio)){if(v){var he=Math.floor(de);v.length<he+1&&((m=[1/0,1/0,-1/0,-1/0]).push(v[0][4]),v.push(m)),m=v[he]}this.replayImageOrLabel_(e,a[S],a[S+1],x,c,d,m,K,Z,J,Q,ee,te,i,re,se,le?P:null,ue?I:null),m&&(de===Math.floor(de)&&this.declutterItems.push(this,m,b),de+=1/m[4])}++L;break;case Us.DRAW_CHARS:var fe=G[1],ge=G[2],pe=G[3];m=o?null:G[4];var me=G[5];C=G[6];var ve=G[7],xe=G[8],_e=G[9];T=G[10];var ye=G[11];_=G[12],y=G[13];var Te=G[14],Ce=this.textStates[y],be=Ce.font,Me=Ce.scale*xe,Ae=void 0;be in this.widths_?Ae=this.widths_[be]:(Ae={},this.widths_[be]=Ae);var Ee=$s(a,fe,ge,2),Le=Me*ma(be,_,Ae);if(me||Le<=Ee){var we=this.textStates[y].textAlign,Se=el(a,fe,ge,2,_,(Ee-Le)*Zs[we],ve,Me,ma,be,Ae);if(Se){var De=void 0,Re=void 0,Pe=void 0,Ie=void 0,Fe=void 0;if(T)for(De=0,Re=Se.length;De<Re;++De)Pe=(Fe=Se[De])[4],Ie=this.createLabel(Pe,y,"",T),c=Fe[2]+ye,d=pe*Ie.height+2*(.5-pe)*ye-_e,this.replayImageOrLabel_(e,Fe[0],Fe[1],Ie,c,d,m,Ie.height,1,0,0,Fe[3],Te,!1,Ie.width,na,null,null);if(C)for(De=0,Re=Se.length;De<Re;++De)Pe=(Fe=Se[De])[4],Ie=this.createLabel(Pe,y,C,""),c=Fe[2],d=pe*Ie.height-_e,this.replayImageOrLabel_(e,Fe[0],Fe[1],Ie,c,d,m,Ie.height,1,0,0,Fe[3],Te,!1,Ie.width,na,null,null)}}this.declutterItems.push(this,m,b),++L;break;case Us.END_GEOMETRY:if(void 0!==o){var Oe=o(b=G[1]);if(Oe)return Oe}++L;break;case Us.FILL:U?D++:this.fill_(e),++L;break;case Us.MOVE_TO_LINE_TO:for(S=G[1],u=G[2],A=a[S],p=(E=a[S+1])+.5|0,(g=A+.5|0)===h&&p===f||(e.moveTo(A,E),h=g,f=p),S+=2;S<u;S+=2)g=(A=a[S])+.5|0,p=(E=a[S+1])+.5|0,S!=u-2&&g===h&&p===f||(e.lineTo(A,E),h=g,f=p);++L;break;case Us.SET_FILL_STYLE:P=G,this.alignFill_=G[2],D&&(this.fill_(e),D=0,R&&(e.stroke(),R=0)),e.fillStyle=G[1],++L;break;case Us.SET_STROKE_STYLE:I=G,R&&(e.stroke(),R=0),this.setStrokeStyle_(e,G),++L;break;case Us.STROKE:U?R++:e.stroke(),++L;break;default:++L}}D&&this.fill_(e),R&&e.stroke()},e.prototype.execute=function(e,t,r,i){this.viewRotation_=r,this.execute_(e,t,this.instructions,i,void 0,void 0)},e.prototype.executeHitDetection=function(e,t,r,i,o){return this.viewRotation_=r,this.execute_(e,t,this.hitDetectionInstructions,!0,i,o)},e}(),cl=[Sa,"Circle",wa,La,Da,Ea],dl=function(){function e(e,t,r,i,o,n){this.maxExtent_=e,this.overlaps_=i,this.pixelRatio_=r,this.resolution_=t,this.renderBuffer_=n,this.executorsByZIndex_={},this.hitDetectionContext_=null,this.hitDetectionTransform_=[1,0,0,1,0,0],this.createExecutors_(o)}return e.prototype.clip=function(e,t){var r=this.getClipCoords(t);e.beginPath(),e.moveTo(r[0],r[1]),e.lineTo(r[2],r[3]),e.lineTo(r[4],r[5]),e.lineTo(r[6],r[7]),e.clip()},e.prototype.createExecutors_=function(e){for(var t in e){var r=this.executorsByZIndex_[t];void 0===r&&(r={},this.executorsByZIndex_[t]=r);var i=e[t];for(var o in i){var n=i[o];r[o]=new ul(this.resolution_,this.pixelRatio_,this.overlaps_,n)}}},e.prototype.hasExecutors=function(e){for(var t in this.executorsByZIndex_)for(var r=this.executorsByZIndex_[t],i=0,o=e.length;i<o;++i)if(e[i]in r)return!0;return!1},e.prototype.forEachFeatureAtCoordinate=function(e,t,r,i,o,n){var a=2*(i=Math.round(i))+1,s=Kr(this.hitDetectionTransform_,i+.5,i+.5,1/t,-1/t,-r,-e[0],-e[1]);this.hitDetectionContext_||(this.hitDetectionContext_=Gi(a,a));var l,u=this.hitDetectionContext_;u.canvas.width!==a||u.canvas.height!==a?(u.canvas.width=a,u.canvas.height=a):u.clearRect(0,0,a,a),void 0!==this.renderBuffer_&&(vt(l=[1/0,1/0,-1/0,-1/0],e),at(l,t*(this.renderBuffer_+i),l));var c,d=function(e){if(void 0!==hl[e])return hl[e];for(var t=2*e+1,r=new Array(t),i=0;i<t;i++)r[i]=new Array(t);for(var o=e,n=0,a=0;o>=n;)fl(r,e+o,e+n),fl(r,e+n,e+o),fl(r,e-n,e+o),fl(r,e-o,e+n),fl(r,e-o,e-n),fl(r,e-n,e-o),fl(r,e+n,e-o),fl(r,e+o,e-n),2*((a+=1+2*++n)-o)+1>0&&(a+=1-2*(o-=1));return hl[e]=r,r}(i);function h(e){for(var t=u.getImageData(0,0,a,a).data,r=0;r<a;r++)for(var i=0;i<a;i++)if(d[r][i]&&t[4*(i*a+r)+3]>0){var s=void 0;return(!n||c!=La&&c!=Da||-1!==n.indexOf(e))&&(s=o(e)),s||void u.clearRect(0,0,a,a)}}var f,g,p,m,v,x=Object.keys(this.executorsByZIndex_).map(Number);for(x.sort(y),f=x.length-1;f>=0;--f){var _=x[f].toString();for(p=this.executorsByZIndex_[_],g=cl.length-1;g>=0;--g)if(void 0!==(m=p[c=cl[g]])&&(v=m.executeHitDetection(u,s,r,h,l)))return v}},e.prototype.getClipCoords=function(e){var t=this.maxExtent_;if(!t)return null;var r=t[0],i=t[1],o=t[2],n=t[3],a=[r,i,r,n,o,n,o,i];return nr(a,0,8,2,e,a),a},e.prototype.isEmpty=function(){return p(this.executorsByZIndex_)},e.prototype.execute=function(e,t,r,i,o,n){var a=Object.keys(this.executorsByZIndex_).map(Number);a.sort(y),this.maxExtent_&&(e.save(),this.clip(e,t));var s,l,u,c,d,h,f=o||cl;for(s=0,l=a.length;s<l;++s){var g=a[s].toString();for(d=this.executorsByZIndex_[g],u=0,c=f.length;u<c;++u){var p=f[u];if(void 0!==(h=d[p]))if(!n||p!=La&&p!=Da)h.execute(e,t,r,i);else{var m=n[g];m?m.push(h,t.slice(0)):n[g]=[h,t.slice(0)]}}}this.maxExtent_&&e.restore()},e}(),hl={0:[[!0]]};function fl(e,t,r){var i,o=Math.floor(e.length/2);if(t>=o)for(i=o;i<t;i++)e[i][r]=!0;else if(t<o)for(i=t+1;i<o;i++)e[i][r]=!0}var gl,pl,ml=dl,vl="fraction",xl=(pl=function(e,t){return(pl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}pl(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),_l=function(e){function t(t,r,i,o){var n=e.call(this)||this;return n.extent=t,n.pixelRatio_=i,n.resolution=r,n.state=o,n}return xl(t,e),t.prototype.changed=function(){this.dispatchEvent(F)},t.prototype.getExtent=function(){return this.extent},t.prototype.getImage=function(){return i()},t.prototype.getPixelRatio=function(){return this.pixelRatio_},t.prototype.getResolution=function(){return this.resolution},t.prototype.getState=function(){return this.state},t.prototype.load=function(){i()},t}(I),yl=(gl=function(e,t){return(gl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}gl(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Tl(e,t,r){var i=e;if(i.src&&ve){var o=!0;return i.decode().then(function(){o&&t()}).catch(function(e){o&&("EncodingError"===e.name&&"Invalid image type."===e.message?t():r())}),function(){o=!1}}var n=[v(i,z,t),v(i,O,r)];return function(){n.forEach(x)}}!function(e){function t(t,r,i,o,n,a){var s=e.call(this,t,r,i,ba)||this;return s.src_=o,s.image_=new Image,null!==n&&(s.image_.crossOrigin=n),s.unlisten_=null,s.state=ba,s.imageLoadFunction_=a,s}yl(t,e),t.prototype.getImage=function(){return this.image_},t.prototype.handleImageError_=function(){this.state=Aa,this.unlistenImage_(),this.changed()},t.prototype.handleImageLoad_=function(){void 0===this.resolution&&(this.resolution=At(this.extent)/this.image_.height),this.state=Ma,this.unlistenImage_(),this.changed()},t.prototype.load=function(){this.state!=ba&&this.state!=Aa||(this.state=1,this.changed(),this.imageLoadFunction_(this,this.src_),this.unlisten_=Tl(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))},t.prototype.setImage=function(e){this.image_=e},t.prototype.unlistenImage_=function(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)}}(_l);var Cl,bl,Ml,Al,El=(Cl=function(e,t){return(Cl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Cl(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Ll=function(e){function t(t,r,i,o,n,a){var s=e.call(this)||this;return s.hitDetectionImage_=null,s.image_=t||new Image,null!==o&&(s.image_.crossOrigin=o),s.canvas_=a?document.createElement("canvas"):null,s.color_=a,s.unlisten_=null,s.imageState_=n,s.size_=i,s.src_=r,s.tainted_,s}return El(t,e),t.prototype.isTainted_=function(e){if(void 0===this.tainted_&&this.imageState_===Ma){e||(e=Gi(1,1)).drawImage(this.image_,0,0);try{e.getImageData(0,0,1,1),this.tainted_=!1}catch(e){this.tainted_=!0}}return!0===this.tainted_},t.prototype.dispatchChangeEvent_=function(){this.dispatchEvent(F)},t.prototype.handleImageError_=function(){this.imageState_=Aa,this.unlistenImage_(),this.dispatchChangeEvent_()},t.prototype.handleImageLoad_=function(){this.imageState_=Ma,this.size_&&(this.image_.width=this.size_[0],this.image_.height=this.size_[1]),this.size_=[this.image_.width,this.image_.height],this.unlistenImage_(),this.replaceColor_(),this.dispatchChangeEvent_()},t.prototype.getImage=function(e){return this.canvas_?this.canvas_:this.image_},t.prototype.getImageState=function(){return this.imageState_},t.prototype.getHitDetectionImage=function(e){if(!this.hitDetectionImage_)if(this.isTainted_()){var t=this.size_[0],r=this.size_[1],i=Gi(t,r);i.fillRect(0,0,t,r),this.hitDetectionImage_=i.canvas}else this.hitDetectionImage_=this.image_;return this.hitDetectionImage_},t.prototype.getSize=function(){return this.size_},t.prototype.getSrc=function(){return this.src_},t.prototype.load=function(){if(this.imageState_==ba){this.imageState_=1;try{this.image_.src=this.src_}catch(e){this.handleImageError_()}this.unlisten_=Tl(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this))}},t.prototype.replaceColor_=function(){if(this.color_){this.canvas_.width=this.image_.width,this.canvas_.height=this.image_.height;var e=this.canvas_.getContext("2d");if(e.drawImage(this.image_,0,0),this.isTainted_(e)){var t=this.color_;return e.globalCompositeOperation="multiply",e.fillStyle="rgb("+t[0]+","+t[1]+","+t[2]+")",e.fillRect(0,0,this.image_.width,this.image_.height),e.globalCompositeOperation="destination-in",void e.drawImage(this.image_,0,0)}for(var r=e.getImageData(0,0,this.image_.width,this.image_.height),i=r.data,o=this.color_[0]/255,n=this.color_[1]/255,a=this.color_[2]/255,s=0,l=i.length;s<l;s+=4)i[s]*=o,i[s+1]*=n,i[s+2]*=a;e.putImageData(r,0,0)}},t.prototype.unlistenImage_=function(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)},t}(I),wl="bottom-left",Sl="bottom-right",Dl="top-left",Rl="top-right",Pl=(bl=function(e,t){return(bl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}bl(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Il=function(e){function t(t){var r=this,i=t||{},o=void 0!==i.opacity?i.opacity:1,a=void 0!==i.rotation?i.rotation:0,s=void 0!==i.scale?i.scale:1,l=void 0!==i.rotateWithView&&i.rotateWithView;(r=e.call(this,{opacity:o,rotation:a,scale:s,displacement:void 0!==i.displacement?i.displacement:[0,0],rotateWithView:l})||this).anchor_=void 0!==i.anchor?i.anchor:[.5,.5],r.normalizedAnchor_=null,r.anchorOrigin_=void 0!==i.anchorOrigin?i.anchorOrigin:Dl,r.anchorXUnits_=void 0!==i.anchorXUnits?i.anchorXUnits:vl,r.anchorYUnits_=void 0!==i.anchorYUnits?i.anchorYUnits:vl,r.crossOrigin_=void 0!==i.crossOrigin?i.crossOrigin:null;var u=void 0!==i.img?i.img:null,c=void 0!==i.imgSize?i.imgSize:null,d=i.src;Oe(!(void 0!==d&&u),4),Oe(!u||u&&c,5),void 0!==d&&0!==d.length||!u||(d=u.src||n(u)),Oe(void 0!==d&&d.length>0,6);var h=void 0!==i.src?ba:Ma;return r.color_=void 0!==i.color?Jn(i.color):null,r.iconImage_=function(e,t,r,i,o,n){var a=ta.get(t,i,n);return a||(a=new Ll(e,t,r,i,o,n),ta.set(t,i,n,a)),a}(u,d,c,r.crossOrigin_,h,r.color_),r.offset_=void 0!==i.offset?i.offset:[0,0],r.offsetOrigin_=void 0!==i.offsetOrigin?i.offsetOrigin:Dl,r.origin_=null,r.size_=void 0!==i.size?i.size:null,r}return Pl(t,e),t.prototype.clone=function(){return new t({anchor:this.anchor_.slice(),anchorOrigin:this.anchorOrigin_,anchorXUnits:this.anchorXUnits_,anchorYUnits:this.anchorYUnits_,crossOrigin:this.crossOrigin_,color:this.color_&&this.color_.slice?this.color_.slice():this.color_||void 0,src:this.getSrc(),offset:this.offset_.slice(),offsetOrigin:this.offsetOrigin_,size:null!==this.size_?this.size_.slice():void 0,opacity:this.getOpacity(),scale:this.getScale(),rotation:this.getRotation(),rotateWithView:this.getRotateWithView()})},t.prototype.getAnchor=function(){if(this.normalizedAnchor_)return this.normalizedAnchor_;var e=this.anchor_,t=this.getSize();if(this.anchorXUnits_==vl||this.anchorYUnits_==vl){if(!t)return null;e=this.anchor_.slice(),this.anchorXUnits_==vl&&(e[0]*=t[0]),this.anchorYUnits_==vl&&(e[1]*=t[1])}if(this.anchorOrigin_!=Dl){if(!t)return null;e===this.anchor_&&(e=this.anchor_.slice()),this.anchorOrigin_!=Rl&&this.anchorOrigin_!=Sl||(e[0]=-e[0]+t[0]),this.anchorOrigin_!=wl&&this.anchorOrigin_!=Sl||(e[1]=-e[1]+t[1])}return this.normalizedAnchor_=e,this.normalizedAnchor_},t.prototype.setAnchor=function(e){this.anchor_=e,this.normalizedAnchor_=null},t.prototype.getColor=function(){return this.color_},t.prototype.getImage=function(e){return this.iconImage_.getImage(e)},t.prototype.getImageSize=function(){return this.iconImage_.getSize()},t.prototype.getHitDetectionImageSize=function(){return this.getImageSize()},t.prototype.getImageState=function(){return this.iconImage_.getImageState()},t.prototype.getHitDetectionImage=function(e){return this.iconImage_.getHitDetectionImage(e)},t.prototype.getOrigin=function(){if(this.origin_)return this.origin_;var e=this.offset_,t=this.getDisplacement();if(this.offsetOrigin_!=Dl){var r=this.getSize(),i=this.iconImage_.getSize();if(!r||!i)return null;e=e.slice(),this.offsetOrigin_!=Rl&&this.offsetOrigin_!=Sl||(e[0]=i[0]-r[0]-e[0]),this.offsetOrigin_!=wl&&this.offsetOrigin_!=Sl||(e[1]=i[1]-r[1]-e[1])}return e[0]+=t[0],e[1]+=t[1],this.origin_=e,this.origin_},t.prototype.getSrc=function(){return this.iconImage_.getSrc()},t.prototype.getSize=function(){return this.size_?this.size_:this.iconImage_.getSize()},t.prototype.listenImageChange=function(e){this.iconImage_.addEventListener(F,e)},t.prototype.load=function(){this.iconImage_.load()},t.prototype.unlistenImageChange=function(e){this.iconImage_.removeEventListener(F,e)},t}(gs),Fl=(Al=function(e,t){return(Al=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Al(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Ol=function(e){function t(t){var r=e.call(this,t)||this;return r.boundHandleStyleImageChange_=r.handleStyleImageChange_.bind(r),r.animatingOrInteracting_,r.dirty_=!1,r.hitDetectionImageData_=null,r.renderedFeatures_=null,r.renderedRevision_=-1,r.renderedResolution_=NaN,r.renderedExtent_=[1/0,1/0,-1/0,-1/0],r.renderedRotation_,r.renderedCenter_=null,r.renderedProjection_=null,r.renderedRenderOrder_=null,r.replayGroup_=null,r.replayGroupChanged=!0,r}return Fl(t,e),t.prototype.useContainer=function(t,r,i){i<1&&(t=null),e.prototype.useContainer.call(this,t,r,i)},t.prototype.renderFrame=function(e,t){var r=e.pixelRatio,i=e.layerStatesArray[e.layerIndex];!function(e,t,r){!function(e,t,r,i,o,n,a){e[0]=t,e[1]=r,e[2]=i,e[3]=o,e[4]=n,e[5]=a}(e,t,0,0,r,0,0)}(this.pixelTransform,1/r,1/r),Zr(this.inversePixelTransform,this.pixelTransform);var o=Jr(this.pixelTransform);this.useContainer(t,o,i.opacity);var n=this.context,a=n.canvas,s=this.replayGroup_;if(!s||s.isEmpty())return!this.containerReused&&a.width>0&&(a.width=0),this.container;var l=Math.round(e.size[0]*r),u=Math.round(e.size[1]*r);a.width!=l||a.height!=u?(a.width=l,a.height=u,a.style.transform!==o&&(a.style.transform=o)):this.containerReused||n.clearRect(0,0,l,u),this.preRender(n,e);var c=e.extent,d=e.viewState,h=d.center,f=d.resolution,g=d.projection,p=d.rotation,m=g.getExtent(),v=this.getLayer().getSource(),x=!1;if(i.extent){var _=Yr(i.extent,g);(x=!ct(_,e.extent)&&Dt(_,e.extent))&&this.clip(n,e,_)}var T=e.viewHints,C=!(T[0]||T[1]),b=this.getRenderTransform(h,f,p,r,l,u,0),M=this.getLayer().getDeclutter()?{}:null;if(s.execute(n,b,p,C,void 0,M),v.getWrapX()&&g.canWrapX()&&!ct(m,c)){for(var A=c[0],E=St(m),L=0,w=void 0;A<m[0];){w=E*--L;var S=this.getRenderTransform(h,f,p,r,l,u,w);s.execute(n,S,p,C,void 0,M),A+=E}for(L=0,A=c[2];A>m[2];){w=E*++L;var D=this.getRenderTransform(h,f,p,r,l,u,w);s.execute(n,D,p,C,void 0,M),A-=E}}if(M){var R=e.viewHints;!function(e,t,r,i,o,n){for(var a=Object.keys(e).map(Number).sort(y),s=0,l=a.length;s<l;++s)for(var u=e[a[s].toString()],c=void 0,d=0,h=u.length;d<h;){var f=u[d++];f!==c&&(c=f,n.push({items:f.declutterItems,opacity:1}));var g=u[d++];f.execute(t,g,r,o)}}(M,n,p,0,!(R[0]||R[1]),e.declutterItems)}x&&n.restore(),this.postRender(n,e);var P=i.opacity,I=this.container;return P!==parseFloat(I.style.opacity)&&(I.style.opacity=1===P?"":P),this.container},t.prototype.getFeatures=function(e){return new Promise(function(t,r){if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){var i=[this.context.canvas.width,this.context.canvas.height];qr(this.pixelTransform,i);var o=this.renderedCenter_,n=this.renderedResolution_,a=this.renderedRotation_,s=this.renderedProjection_,l=this.renderedExtent_,u=this.getLayer(),c=[],d=i[0]/2,h=i[1]/2;c.push(this.getRenderTransform(o,n,a,.5,d,h,0).slice());var f=u.getSource(),g=s.getExtent();if(f.getWrapX()&&s.canWrapX()&&!ct(g,l)){for(var p=l[0],m=St(g),v=0,x=void 0;p<g[0];)x=m*--v,c.push(this.getRenderTransform(o,n,a,.5,d,h,x).slice()),p+=m;for(v=0,p=l[2];p>g[2];)x=m*++v,c.push(this.getRenderTransform(o,n,a,.5,d,h,x).slice()),p-=m}this.hitDetectionImageData_=function(e,t,r,i,o,n,a){var s=Gi(e[0]/2,e[1]/2);s.imageSmoothingEnabled=!1;for(var l=s.canvas,u=new Ca(s,.5,o,null,a),c=r.length,d=Math.floor(16777215/c),h={},f=1;f<=c;++f){var g=r[f-1],p=g.getStyleFunction()||i;if(i){var m=p(g,n);if(m){Array.isArray(m)||(m=[m]);for(var v="#"+("000000"+(f*d).toString(16)).slice(-6),x=0,_=m.length;x<_;++x){var T=m[x],C=T.clone(),b=C.getFill();b&&b.setColor(v);var M=C.getStroke();M&&M.setColor(v),C.setText(void 0);var A=T.getImage();if(A){var E=A.getImageSize();if(!E)continue;var L=document.createElement("canvas");L.width=E[0],L.height=E[1];var w=L.getContext("2d",{alpha:!1});w.fillStyle=v;var S=w.canvas;w.fillRect(0,0,S.width,S.height),Gi(E?E[0]:S.width,E?E[1]:S.height).drawImage(S,0,0),C.setImage(new Il({img:S,imgSize:E,anchor:A.getAnchor(),anchorXUnits:"pixels",anchorYUnits:"pixels",offset:A.getOrigin(),size:A.getSize(),opacity:A.getOpacity(),scale:A.getScale(),rotation:A.getRotation(),rotateWithView:A.getRotateWithView()}))}var D=Number(C.getZIndex());(F=h[D])||(F={},h[D]=F,F[Kt]=[],F[er]=[],F[qt]=[],F[Yt]=[]);var R=C.getGeometryFunction()(g);R&&Dt(o,R.getExtent())&&F[R.getType().replace("Multi","")].push(R,C)}}}}for(var P=Object.keys(h).map(Number).sort(y),I=(f=0,P.length);f<I;++f){var F=h[P[f]];for(var O in F){var B=F[O];for(x=0,_=B.length;x<_;x+=2){u.setStyle(B[x+1]);for(var N=0,U=t.length;N<U;++N)u.setTransform(t[N]),u.drawGeometry(B[x])}}}return document.body.appendChild(s.canvas),s.getImageData(0,0,l.width,l.height)}(i,c,this.renderedFeatures_,u.getStyleFunction(),l,n,a)}t(function(e,t,r){var i=[];if(r){var o=4*(Math.round(e[0]/2)+Math.round(e[1]/2)*r.width),n=r.data[o],a=r.data[o+1],s=r.data[o+2]+256*(a+256*n),l=Math.floor(16777215/t.length);s&&s%l==0&&i.push(t[s/l-1])}return i}(e,this.renderedFeatures_,this.hitDetectionImageData_))}.bind(this))},t.prototype.forEachFeatureAtCoordinate=function(e,t,r,i,o){if(this.replayGroup_){var a=t.viewState.resolution,s=t.viewState.rotation,l=this.getLayer(),u={};return this.replayGroup_.forEachFeatureAtCoordinate(e,a,s,r,function(e){var t=n(e);if(!(t in u))return u[t]=!0,i(e,l)},l.getDeclutter()?o:null)}},t.prototype.handleFontsChanged=function(){var e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()},t.prototype.handleStyleImageChange_=function(e){this.renderIfReadyAndVisible()},t.prototype.prepareFrame=function(e){var t=this.getLayer(),r=t.getSource();if(!r)return!1;var i=e.viewHints[0],o=e.viewHints[1],n=t.getUpdateWhileAnimating(),a=t.getUpdateWhileInteracting();if(!this.dirty_&&!n&&i||!a&&o)return this.animatingOrInteracting_=!0,!0;this.animatingOrInteracting_=!1;var s=e.extent,l=e.viewState,u=l.projection,c=l.resolution,d=e.pixelRatio,h=t.getRevision(),f=t.getRenderBuffer(),g=t.getRenderOrder();void 0===g&&(g=Pa);var p=l.center.slice(),m=at(s,f*c),v=[m.slice()],x=u.getExtent();if(r.getWrapX()&&u.canWrapX()&&!ct(x,e.extent)){var _=St(x),y=Math.max(St(m)/2,_);m[0]=x[0]-y,m[2]=x[2]+y,Vt(p,u);var T=function(e,t){var r=t.getExtent(),i=bt(e);if(t.canWrapX()&&(i[0]<r[0]||i[0]>=r[2])){var o=St(r),n=Math.floor((i[0]-r[0])/o)*o;e[0]-=n,e[2]-=n}return e}(v[0],u);T[0]<x[0]&&T[2]<x[2]?v.push([T[0]+_,T[1],T[2]+_,T[3]]):T[0]>x[0]&&T[2]>x[2]&&v.push([T[0]-_,T[1],T[2]-_,T[3]])}if(!this.dirty_&&this.renderedResolution_==c&&this.renderedRevision_==h&&this.renderedRenderOrder_==g&&ct(this.renderedExtent_,m))return this.replayGroupChanged=!1,!0;this.replayGroup_=null,this.dirty_=!1;var C,b=new Qs(Ia(c,d),m,c,d,t.getDeclutter()),M=kr();if(M){for(var A=0,E=v.length;A<E;++A)r.loadFeatures(Xr(v[A],u),c,M);C=Or(M,u)}else for(A=0,E=v.length;A<E;++A)r.loadFeatures(v[A],c,u);var L=function(e,t){var r=Ia(e,t);return r*r}(c,d),w=function(e){var r,i=e.getStyleFunction()||t.getStyleFunction();if(i&&(r=i(e,c)),r){var o=this.renderFeature(e,L,r,b,C);this.dirty_=this.dirty_||o}}.bind(this),S=Xr(m,u),D=r.getFeaturesInExtent(S);for(g&&D.sort(g),A=0,E=D.length;A<E;++A)w(D[A]);this.renderedFeatures_=D;var R=b.finish(),P=new ml(m,c,d,r.getOverlaps(),R,t.getRenderBuffer());return this.renderedResolution_=c,this.renderedRevision_=h,this.renderedRenderOrder_=g,this.renderedExtent_=m,this.renderedRotation_=l.rotation,this.renderedCenter_=p,this.renderedProjection_=u,this.replayGroup_=P,this.hitDetectionImageData_=null,this.replayGroupChanged=!0,!0},t.prototype.renderFeature=function(e,t,r,i,o){if(!r)return!1;var n=!1;if(Array.isArray(r))for(var a=0,s=r.length;a<s;++a)n=Fa(i,e,r[a],t,this.boundHandleStyleImageChange_,o)||n;else n=Fa(i,e,r,t,this.boundHandleStyleImageChange_,o);return n},t}(ns),Bl=(Ml=function(e,t){return(Ml=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Ml(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Nl=function(e){function t(t){return e.call(this,t)||this}return Bl(t,e),t.prototype.createRenderer=function(){return new Ol(this)},t}(Ps),Ul="arraybuffer",Gl="json",zl="text",Hl="xml",Vl=!1;function kl(e,t){return function(e,t,r,i){return function(r,o,n){var a=new XMLHttpRequest;a.open("GET","function"==typeof e?e(r,o,n):e,!0),t.getType()==Ul&&(a.responseType="arraybuffer"),a.withCredentials=Vl,a.onload=function(e){if(!a.status||a.status>=200&&a.status<300){var o=t.getType(),s=void 0;o==Gl||o==zl?s=a.responseText:o==Hl?(s=a.responseXML)||(s=(new DOMParser).parseFromString(a.responseText,"application/xml")):o==Ul&&(s=a.response),s?function(e,t){"function"==typeof this.addFeatures&&this.addFeatures(e)}.call(this,t.readFeatures(s,{extent:r,featureProjection:n}),t.readProjection(s)):i.call(this)}else i.call(this)}.bind(this),a.onerror=function(){i.call(this)}.bind(this),a.send()}}(e,t,0,L)}function jl(e,t){return[[-1/0,-1/0,1/0,1/0]]}var Wl,Xl=(Wl=function(e,t){return(Wl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Wl(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Yl(e){return e?Array.isArray(e)?function(t){return e}:"function"==typeof e?e:function(t){return[e]}:null}var ql,Kl,Zl,Jl,Ql=function(e){function t(t){var r=e.call(this)||this;return r.projection_=Dr(t.projection),r.attributions_=Yl(t.attributions),r.attributionsCollapsible_=void 0===t.attributionsCollapsible||t.attributionsCollapsible,r.loading=!1,r.state_=void 0!==t.state?t.state:to,r.wrapX_=void 0!==t.wrapX&&t.wrapX,r}return Xl(t,e),t.prototype.getAttributions=function(){return this.attributions_},t.prototype.getAttributionsCollapsible=function(){return this.attributionsCollapsible_},t.prototype.getProjection=function(){return this.projection_},t.prototype.getResolutions=function(){return i()},t.prototype.getState=function(){return this.state_},t.prototype.getWrapX=function(){return this.wrapX_},t.prototype.refresh=function(){this.changed()},t.prototype.setAttributions=function(e){this.attributions_=Yl(e),this.changed()},t.prototype.setState=function(e){this.state_=e,this.changed()},t}(re),$l="addfeature",eu="removefeature",tu=function(){function e(e){this.rbush_=new rl.a(e),this.items_={}}return e.prototype.insert=function(e,t){var r={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3],value:t};this.rbush_.insert(r),this.items_[n(t)]=r},e.prototype.load=function(e,t){for(var r=new Array(t.length),i=0,o=t.length;i<o;i++){var a=e[i],s=t[i],l={minX:a[0],minY:a[1],maxX:a[2],maxY:a[3],value:s};r[i]=l,this.items_[n(s)]=l}this.rbush_.load(r)},e.prototype.remove=function(e){var t=n(e),r=this.items_[t];return delete this.items_[t],null!==this.rbush_.remove(r)},e.prototype.update=function(e,t){var r=this.items_[n(t)];pt([r.minX,r.minY,r.maxX,r.maxY],e)||(this.remove(t),this.insert(e,t))},e.prototype.getAll=function(){return this.rbush_.all().map(function(e){return e.value})},e.prototype.getInExtent=function(e){var t={minX:e[0],minY:e[1],maxX:e[2],maxY:e[3]};return this.rbush_.search(t).map(function(e){return e.value})},e.prototype.forEach=function(e){return this.forEach_(this.getAll(),e)},e.prototype.forEachInExtent=function(e,t){return this.forEach_(this.getInExtent(e),t)},e.prototype.forEach_=function(e,t){for(var r,i=0,o=e.length;i<o;i++)if(r=t(e[i]))return r;return r},e.prototype.isEmpty=function(){return p(this.items_)},e.prototype.clear=function(){this.rbush_.clear(),this.items_={}},e.prototype.getExtent=function(e){var t=this.rbush_.toJSON();return ft(t.minX,t.minY,t.maxX,t.maxY,e)},e.prototype.concat=function(e){for(var t in this.rbush_.load(e.rbush_.all()),e.items_)this.items_[t]=e.items_[t]},e}(),ru=(Kl=function(e,t){return(Kl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Kl(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),iu=function(e){function t(t,r){var i=e.call(this,t)||this;return i.feature=r,i}return ru(t,e),t}(R),ou=function(e){function t(t){var r=this,i=t||{};(r=e.call(this,{attributions:i.attributions,projection:void 0,state:to,wrapX:void 0===i.wrapX||i.wrapX})||this).loader_=L,r.format_=i.format,r.overlaps_=void 0===i.overlaps||i.overlaps,r.url_=i.url,void 0!==i.loader?r.loader_=i.loader:void 0!==r.url_&&(Oe(r.format_,7),r.loader_=kl(r.url_,r.format_)),r.strategy_=void 0!==i.strategy?i.strategy:jl;var o,n,a=void 0===i.useSpatialIndex||i.useSpatialIndex;return r.featuresRtree_=a?new tu:null,r.loadedExtentsRtree_=new tu,r.nullGeometryFeatures_={},r.idIndex_={},r.uidIndex_={},r.featureChangeKeys_={},r.featuresCollection_=null,Array.isArray(i.features)?n=i.features:i.features&&(n=(o=i.features).getArray()),a||void 0!==o||(o=new ae(n)),void 0!==n&&r.addFeaturesInternal(n),void 0!==o&&r.bindFeaturesCollection_(o),r}return ru(t,e),t.prototype.addFeature=function(e){this.addFeatureInternal(e),this.changed()},t.prototype.addFeatureInternal=function(e){var t=n(e);if(this.addToIndex_(t,e)){this.setupChangeEvents_(t,e);var r=e.getGeometry();if(r){var i=r.getExtent();this.featuresRtree_&&this.featuresRtree_.insert(i,e)}else this.nullGeometryFeatures_[t]=e;this.dispatchEvent(new iu($l,e))}else this.featuresCollection_&&this.featuresCollection_.remove(e)},t.prototype.setupChangeEvents_=function(e,t){this.featureChangeKeys_[e]=[m(t,F,this.handleFeatureChange_,this),m(t,d,this.handleFeatureChange_,this)]},t.prototype.addToIndex_=function(e,t){var r=!0,i=t.getId();return void 0!==i&&(i.toString()in this.idIndex_?r=!1:this.idIndex_[i.toString()]=t),r&&(Oe(!(e in this.uidIndex_),30),this.uidIndex_[e]=t),r},t.prototype.addFeatures=function(e){this.addFeaturesInternal(e),this.changed()},t.prototype.addFeaturesInternal=function(e){for(var t=[],r=[],i=[],o=0,a=e.length;o<a;o++){var s=n(u=e[o]);this.addToIndex_(s,u)&&r.push(u)}o=0;for(var l=r.length;o<l;o++){var u;s=n(u=r[o]),this.setupChangeEvents_(s,u);var c=u.getGeometry();if(c){var d=c.getExtent();t.push(d),i.push(u)}else this.nullGeometryFeatures_[s]=u}this.featuresRtree_&&this.featuresRtree_.load(t,i),o=0;for(var h=r.length;o<h;o++)this.dispatchEvent(new iu($l,r[o]))},t.prototype.bindFeaturesCollection_=function(e){var t=!1;this.addEventListener($l,function(r){t||(t=!0,e.push(r.feature),t=!1)}),this.addEventListener(eu,function(r){t||(t=!0,e.remove(r.feature),t=!1)}),e.addEventListener(u,function(e){t||(t=!0,this.addFeature(e.element),t=!1)}.bind(this)),e.addEventListener(c,function(e){t||(t=!0,this.removeFeature(e.element),t=!1)}.bind(this)),this.featuresCollection_=e},t.prototype.clear=function(e){if(e){for(var t in this.featureChangeKeys_)this.featureChangeKeys_[t].forEach(x);this.featuresCollection_||(this.featureChangeKeys_={},this.idIndex_={},this.uidIndex_={})}else if(this.featuresRtree_)for(var r in this.featuresRtree_.forEach(this.removeFeatureInternal.bind(this)),this.nullGeometryFeatures_)this.removeFeatureInternal(this.nullGeometryFeatures_[r]);this.featuresCollection_&&this.featuresCollection_.clear(),this.featuresRtree_&&this.featuresRtree_.clear(),this.nullGeometryFeatures_={};var i=new iu("clear");this.dispatchEvent(i),this.changed()},t.prototype.forEachFeature=function(e){if(this.featuresRtree_)return this.featuresRtree_.forEach(e);this.featuresCollection_&&this.featuresCollection_.forEach(e)},t.prototype.forEachFeatureAtCoordinateDirect=function(e,t){var r=[e[0],e[1],e[0],e[1]];return this.forEachFeatureInExtent(r,function(r){return r.getGeometry().intersectsCoordinate(e)?t(r):void 0})},t.prototype.forEachFeatureInExtent=function(e,t){if(this.featuresRtree_)return this.featuresRtree_.forEachInExtent(e,t);this.featuresCollection_&&this.featuresCollection_.forEach(t)},t.prototype.forEachFeatureIntersectingExtent=function(e,t){return this.forEachFeatureInExtent(e,function(r){if(r.getGeometry().intersectsExtent(e)){var i=t(r);if(i)return i}})},t.prototype.getFeaturesCollection=function(){return this.featuresCollection_},t.prototype.getFeatures=function(){var e;return this.featuresCollection_?e=this.featuresCollection_.getArray():this.featuresRtree_&&(e=this.featuresRtree_.getAll(),p(this.nullGeometryFeatures_)||b(e,g(this.nullGeometryFeatures_))),e},t.prototype.getFeaturesAtCoordinate=function(e){var t=[];return this.forEachFeatureAtCoordinateDirect(e,function(e){t.push(e)}),t},t.prototype.getFeaturesInExtent=function(e){return this.featuresRtree_?this.featuresRtree_.getInExtent(e):this.featuresCollection_?this.featuresCollection_.getArray():[]},t.prototype.getClosestFeatureToCoordinate=function(e,t){var r=e[0],i=e[1],o=null,n=[NaN,NaN],a=1/0,s=[-1/0,-1/0,1/0,1/0],l=t||A;return this.featuresRtree_.forEachInExtent(s,function(e){if(l(e)){var t=e.getGeometry(),u=a;if((a=t.closestPointXY(r,i,n,a))<u){o=e;var c=Math.sqrt(a);s[0]=r-c,s[1]=i-c,s[2]=r+c,s[3]=i+c}}}),o},t.prototype.getExtent=function(e){return this.featuresRtree_.getExtent(e)},t.prototype.getFeatureById=function(e){var t=this.idIndex_[e.toString()];return void 0!==t?t:null},t.prototype.getFeatureByUid=function(e){var t=this.uidIndex_[e];return void 0!==t?t:null},t.prototype.getFormat=function(){return this.format_},t.prototype.getOverlaps=function(){return this.overlaps_},t.prototype.getUrl=function(){return this.url_},t.prototype.handleFeatureChange_=function(e){var t=e.target,r=n(t),i=t.getGeometry();if(i){var o=i.getExtent();r in this.nullGeometryFeatures_?(delete this.nullGeometryFeatures_[r],this.featuresRtree_&&this.featuresRtree_.insert(o,t)):this.featuresRtree_&&this.featuresRtree_.update(o,t)}else r in this.nullGeometryFeatures_||(this.featuresRtree_&&this.featuresRtree_.remove(t),this.nullGeometryFeatures_[r]=t);var a=t.getId();if(void 0!==a){var s=a.toString();this.idIndex_[s]!==t&&(this.removeFromIdIndex_(t),this.idIndex_[s]=t)}else this.removeFromIdIndex_(t),this.uidIndex_[r]=t;this.changed(),this.dispatchEvent(new iu("changefeature",t))},t.prototype.hasFeature=function(e){var t=e.getId();return void 0!==t?t in this.idIndex_:n(e)in this.uidIndex_},t.prototype.isEmpty=function(){return this.featuresRtree_.isEmpty()&&p(this.nullGeometryFeatures_)},t.prototype.loadFeatures=function(e,t,r){var i=this.loadedExtentsRtree_,o=this.strategy_(e,t);this.loading=!1;for(var n=function(e,n){var s=o[e];i.forEachInExtent(s,function(e){return ct(e.extent,s)})||(a.loader_.call(a,s,t,r),i.insert(s,{extent:s.slice()}),a.loading=a.loader_!==L)},a=this,s=0,l=o.length;s<l;++s)n(s)},t.prototype.refresh=function(){this.clear(!0),this.loadedExtentsRtree_.clear(),e.prototype.refresh.call(this)},t.prototype.removeLoadedExtent=function(e){var t,r=this.loadedExtentsRtree_;r.forEachInExtent(e,function(r){if(pt(r.extent,e))return t=r,!0}),t&&r.remove(t)},t.prototype.removeFeature=function(e){var t=n(e);t in this.nullGeometryFeatures_?delete this.nullGeometryFeatures_[t]:this.featuresRtree_&&this.featuresRtree_.remove(e),this.removeFeatureInternal(e),this.changed()},t.prototype.removeFeatureInternal=function(e){var t=n(e);this.featureChangeKeys_[t].forEach(x),delete this.featureChangeKeys_[t];var r=e.getId();void 0!==r&&delete this.idIndex_[r.toString()],delete this.uidIndex_[t],this.dispatchEvent(new iu(eu,e))},t.prototype.removeFromIdIndex_=function(e){var t=!1;for(var r in this.idIndex_)if(this.idIndex_[r]===e){delete this.idIndex_[r],t=!0;break}return t},t.prototype.setLoader=function(e){this.loader_=e},t.prototype.setUrl=function(e){Oe(this.format_,7),this.setLoader(kl(e,this.format_))},t}(Ql),nu=(ql=function(e,t){return(ql=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}ql(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),au=function(e){function t(t){var r=e.call(this)||this;if(r.id_=void 0,r.geometryName_="geometry",r.style_=null,r.styleFunction_=void 0,r.geometryChangeKey_=null,r.addEventListener(Z(r.geometryName_),r.handleGeometryChanged_),t)if("function"==typeof t.getSimplifiedGeometry){var i=t;r.setGeometry(i)}else{var o=t;r.setProperties(o)}return r}return nu(t,e),t.prototype.clone=function(){var e=new t(this.getProperties());e.setGeometryName(this.getGeometryName());var r=this.getGeometry();r&&e.setGeometry(r.clone());var i=this.getStyle();return i&&e.setStyle(i),e},t.prototype.getGeometry=function(){return this.get(this.geometryName_)},t.prototype.getId=function(){return this.id_},t.prototype.getGeometryName=function(){return this.geometryName_},t.prototype.getStyle=function(){return this.style_},t.prototype.getStyleFunction=function(){return this.styleFunction_},t.prototype.handleGeometryChange_=function(){this.changed()},t.prototype.handleGeometryChanged_=function(){this.geometryChangeKey_&&(x(this.geometryChangeKey_),this.geometryChangeKey_=null);var e=this.getGeometry();e&&(this.geometryChangeKey_=m(e,F,this.handleGeometryChange_,this)),this.changed()},t.prototype.setGeometry=function(e){this.set(this.geometryName_,e)},t.prototype.setStyle=function(e){this.style_=e,this.styleFunction_=e?function(e){return"function"==typeof e?e:(Array.isArray(e)?t=e:(Oe("function"==typeof e.getZIndex,41),t=[e]),function(){return t});var t}(e):void 0,this.changed()},t.prototype.setId=function(e){this.id_=e,this.changed()},t.prototype.setGeometryName=function(e){this.removeEventListener(Z(this.geometryName_),this.handleGeometryChanged_),this.geometryName_=e,this.addEventListener(Z(this.geometryName_),this.handleGeometryChanged_),this.handleGeometryChanged_()},t}(re),su=(Jl=function(e,t){return(Jl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Jl(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),lu=function(e){function t(t,r,i){var o=e.call(this)||this,n=i||{};return o.tileCoord=t,o.state=r,o.interimTile=null,o.hifi=!0,o.key="",o.transition_=void 0===n.transition?250:n.transition,o.transitionStarts_={},o}return su(t,e),t.prototype.changed=function(){this.dispatchEvent(F)},t.prototype.release=function(){},t.prototype.getKey=function(){return this.key+"/"+this.tileCoord},t.prototype.getInterimTile=function(){if(!this.interimTile)return this;var e=this.interimTile;do{if(2==e.getState())return this.transition_=0,e;e=e.interimTile}while(e);return this},t.prototype.refreshInterimChain=function(){if(this.interimTile){var e=this.interimTile,t=this;do{if(2==e.getState()){e.interimTile=null;break}1==e.getState()?t=e:e.getState()==Ie?t.interimTile=e.interimTile:t=e,e=t.interimTile}while(e)}},t.prototype.getTileCoord=function(){return this.tileCoord},t.prototype.getState=function(){return this.state},t.prototype.setState=function(e){if(3!==this.state&&this.state>e)throw new Error("Tile load sequence violation");this.state=e,this.changed()},t.prototype.load=function(){i()},t.prototype.getAlpha=function(e,t){if(!this.transition_)return 1;var r=this.transitionStarts_[e];if(r){if(-1===r)return 1}else r=t,this.transitionStarts_[e]=r;var i=t-r+1e3/60;return i>=this.transition_?1:kt(i/this.transition_)},t.prototype.inTransition=function(e){return!!this.transition_&&-1!==this.transitionStarts_[e]},t.prototype.endTransition=function(e){this.transition_&&(this.transitionStarts_[e]=-1)},t}(I),uu=(Zl=function(e,t){return(Zl=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Zl(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),cu=function(e){function t(t,r,i,o,n,a){var s=e.call(this,t,r,a)||this;return s.crossOrigin_=o,s.src_=i,s.image_=new Image,null!==o&&(s.image_.crossOrigin=o),s.unlisten_=null,s.tileLoadFunction_=n,s}return uu(t,e),t.prototype.getImage=function(){return this.image_},t.prototype.getKey=function(){return this.src_},t.prototype.handleImageError_=function(){var e;this.state=3,this.unlistenImage_(),this.image_=((e=Gi(1,1)).fillStyle="rgba(0,0,0,0)",e.fillRect(0,0,1,1),e.canvas),this.changed()},t.prototype.handleImageLoad_=function(){var e=this.image_;e.naturalWidth&&e.naturalHeight?this.state=2:this.state=Fe,this.unlistenImage_(),this.changed()},t.prototype.load=function(){3==this.state&&(this.state=Ie,this.image_=new Image,null!==this.crossOrigin_&&(this.image_.crossOrigin=this.crossOrigin_)),this.state==Ie&&(this.state=1,this.changed(),this.tileLoadFunction_(this,this.src_),this.unlisten_=Tl(this.image_,this.handleImageLoad_.bind(this),this.handleImageError_.bind(this)))},t.prototype.unlistenImage_=function(){this.unlisten_&&(this.unlisten_(),this.unlisten_=null)},t}(lu),du=function(){function e(e){this.highWaterMark=void 0!==e?e:2048,this.count_=0,this.entries_={},this.oldest_=null,this.newest_=null}return e.prototype.canExpireCache=function(){return this.getCount()>this.highWaterMark},e.prototype.clear=function(){this.count_=0,this.entries_={},this.oldest_=null,this.newest_=null},e.prototype.containsKey=function(e){return this.entries_.hasOwnProperty(e)},e.prototype.forEach=function(e){for(var t=this.oldest_;t;)e(t.value_,t.key_,this),t=t.newer},e.prototype.get=function(e,t){var r=this.entries_[e];return Oe(void 0!==r,15),r===this.newest_||(r===this.oldest_?(this.oldest_=this.oldest_.newer,this.oldest_.older=null):(r.newer.older=r.older,r.older.newer=r.newer),r.newer=null,r.older=this.newest_,this.newest_.newer=r,this.newest_=r),r.value_},e.prototype.remove=function(e){var t=this.entries_[e];return Oe(void 0!==t,15),t===this.newest_?(this.newest_=t.older,this.newest_&&(this.newest_.newer=null)):t===this.oldest_?(this.oldest_=t.newer,this.oldest_&&(this.oldest_.older=null)):(t.newer.older=t.older,t.older.newer=t.newer),delete this.entries_[e],--this.count_,t.value_},e.prototype.getCount=function(){return this.count_},e.prototype.getKeys=function(){var e,t=new Array(this.count_),r=0;for(e=this.newest_;e;e=e.older)t[r++]=e.key_;return t},e.prototype.getValues=function(){var e,t=new Array(this.count_),r=0;for(e=this.newest_;e;e=e.older)t[r++]=e.value_;return t},e.prototype.peekLast=function(){return this.oldest_.value_},e.prototype.peekLastKey=function(){return this.oldest_.key_},e.prototype.peekFirstKey=function(){return this.newest_.key_},e.prototype.pop=function(){var e=this.oldest_;return delete this.entries_[e.key_],e.newer&&(e.newer.older=null),this.oldest_=e.newer,this.oldest_||(this.newest_=null),--this.count_,e.value_},e.prototype.replace=function(e,t){this.get(e),this.entries_[e].value_=t},e.prototype.set=function(e,t){Oe(!(e in this.entries_),16);var r={key_:e,newer:null,older:this.newest_,value_:t};this.newest_?this.newest_.newer=r:this.oldest_=r,this.newest_=r,this.entries_[e]=r,++this.count_},e.prototype.setSize=function(e){this.highWaterMark=e},e}();function hu(e,t,r,i){return void 0!==i?(i[0]=e,i[1]=t,i[2]=r,i):[e,t,r]}function fu(e,t,r){return e+"/"+t+"/"+r}function gu(e){return fu(e[0],e[1],e[2])}function pu(e){return(e[1]<<e[0])+e[2]}var mu,vu=(mu=function(e,t){return(mu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}mu(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),xu=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return vu(t,e),t.prototype.expireCache=function(e){for(;this.canExpireCache()&&!(this.peekLast().getKey()in e);)this.pop().release()},t.prototype.pruneExceptNewestZ=function(){if(0!==this.getCount()){var e=function(e){return e.split("/").map(Number)}(this.peekFirstKey())[0];this.forEach(function(t){t.tileCoord[0]!==e&&(this.remove(gu(t.tileCoord)),t.release())}.bind(this))}},t}(du);function _u(e,t,r,i){var o=Nr(r,t,e),n=Rr(t,i,r),a=t.getMetersPerUnit();void 0!==a&&(n*=a);var s=e.getMetersPerUnit();void 0!==s&&(n/=s);var l=e.getExtent();if(!l||ut(l,o)){var u=Rr(e,n,o)/n;isFinite(u)&&u>0&&(n/=u)}return n}function yu(e,t,r,i){var o=r-e,n=i-t,a=Math.sqrt(o*o+n*n);return[Math.round(r+o/a),Math.round(i+n/a)]}var Tu,Cu=function(){function e(e,t,r,i,o,n){this.sourceProj_=e,this.targetProj_=t;var a={},s=Br(this.targetProj_,this.sourceProj_);this.transformInv_=function(e){var t=e[0]+"/"+e[1];return a[t]||(a[t]=s(e)),a[t]},this.maxSourceExtent_=i,this.errorThresholdSquared_=o*o,this.triangles_=[],this.wrapsXInSource_=!1,this.canWrapXInSource_=this.sourceProj_.canWrapX()&&!!i&&!!this.sourceProj_.getExtent()&&St(i)==St(this.sourceProj_.getExtent()),this.sourceWorldWidth_=this.sourceProj_.getExtent()?St(this.sourceProj_.getExtent()):null,this.targetWorldWidth_=this.targetProj_.getExtent()?St(this.targetProj_.getExtent()):null;var l=Lt(r),u=wt(r),c=Ct(r),d=Tt(r),h=this.transformInv_(l),f=this.transformInv_(u),g=this.transformInv_(c),p=this.transformInv_(d),m=10+(n?Math.max(0,Math.ceil(Math.log2(yt(r)/(n*n*256*256)))):0);if(this.addQuad_(l,u,c,d,h,f,g,p,m),this.wrapsXInSource_){var v=1/0;this.triangles_.forEach(function(e,t,r){v=Math.min(v,e.source[0][0],e.source[1][0],e.source[2][0])}),this.triangles_.forEach(function(e){if(Math.max(e.source[0][0],e.source[1][0],e.source[2][0])-v>this.sourceWorldWidth_/2){var t=[[e.source[0][0],e.source[0][1]],[e.source[1][0],e.source[1][1]],[e.source[2][0],e.source[2][1]]];t[0][0]-v>this.sourceWorldWidth_/2&&(t[0][0]-=this.sourceWorldWidth_),t[1][0]-v>this.sourceWorldWidth_/2&&(t[1][0]-=this.sourceWorldWidth_),t[2][0]-v>this.sourceWorldWidth_/2&&(t[2][0]-=this.sourceWorldWidth_);var r=Math.min(t[0][0],t[1][0],t[2][0]);Math.max(t[0][0],t[1][0],t[2][0])-r<this.sourceWorldWidth_/2&&(e.source=t)}}.bind(this))}a={}}return e.prototype.addTriangle_=function(e,t,r,i,o,n){this.triangles_.push({source:[i,o,n],target:[e,t,r]})},e.prototype.addQuad_=function(e,t,r,i,o,n,a,s,l){var u=nt([o,n,a,s]),c=this.sourceWorldWidth_?St(u)/this.sourceWorldWidth_:null,d=this.sourceWorldWidth_,h=this.sourceProj_.canWrapX()&&c>.5&&c<1,f=!1;if(l>0&&(this.targetProj_.isGlobal()&&this.targetWorldWidth_&&(f=St(nt([e,t,r,i]))/this.targetWorldWidth_>.25||f),!h&&this.sourceProj_.isGlobal()&&c&&(f=c>.25||f)),f||!this.maxSourceExtent_||Dt(u,this.maxSourceExtent_)){if(!(f||isFinite(o[0])&&isFinite(o[1])&&isFinite(n[0])&&isFinite(n[1])&&isFinite(a[0])&&isFinite(a[1])&&isFinite(s[0])&&isFinite(s[1]))){if(!(l>0))return;f=!0}if(l>0){if(!f){var g=[(e[0]+r[0])/2,(e[1]+r[1])/2],p=this.transformInv_(g),m=void 0;m=h?(We(o[0],d)+We(a[0],d))/2-We(p[0],d):(o[0]+a[0])/2-p[0];var v=(o[1]+a[1])/2-p[1];f=m*m+v*v>this.errorThresholdSquared_}if(f){if(Math.abs(e[0]-r[0])<=Math.abs(e[1]-r[1])){var x=[(t[0]+r[0])/2,(t[1]+r[1])/2],_=this.transformInv_(x),y=[(i[0]+e[0])/2,(i[1]+e[1])/2],T=this.transformInv_(y);this.addQuad_(e,t,x,y,o,n,_,T,l-1),this.addQuad_(y,x,r,i,T,_,a,s,l-1)}else{var C=[(e[0]+t[0])/2,(e[1]+t[1])/2],b=this.transformInv_(C),M=[(r[0]+i[0])/2,(r[1]+i[1])/2],A=this.transformInv_(M);this.addQuad_(e,C,M,i,o,b,A,s,l-1),this.addQuad_(C,t,r,M,b,n,a,A,l-1)}return}}if(h){if(!this.canWrapXInSource_)return;this.wrapsXInSource_=!0}this.addTriangle_(e,r,i,o,a,s),this.addTriangle_(e,t,r,o,n,a)}},e.prototype.calculateSourceExtent=function(){var e=[1/0,1/0,-1/0,-1/0];return this.triangles_.forEach(function(t,r,i){var o=t.source;vt(e,o[0]),vt(e,o[1]),vt(e,o[2])}),e},e.prototype.getTriangles=function(){return this.triangles_},e}(),bu=(Tu=function(e,t){return(Tu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Tu(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Mu=function(e){function t(t,r,i,o,n,a,s,l,u,c,d){var h=e.call(this,n,Ie)||this;h.renderEdges_=void 0!==d&&d,h.pixelRatio_=s,h.gutter_=l,h.canvas_=null,h.sourceTileGrid_=r,h.targetTileGrid_=o,h.wrappedTileCoord_=a||n,h.sourceTiles_=[],h.sourcesListenerKeys_=null,h.sourceZ_=0;var f=o.getTileCoordExtent(h.wrappedTileCoord_),g=h.targetTileGrid_.getExtent(),p=h.sourceTileGrid_.getExtent(),m=g?Et(f,g):f;if(0===yt(m))return h.state=Fe,h;var v=t.getExtent();v&&(p=p?Et(p,v):v);var x=o.getResolution(h.wrappedTileCoord_[0]),_=_u(t,i,bt(m),x);if(!isFinite(_)||_<=0)return h.state=Fe,h;var y=void 0!==c?c:.5;if(h.triangulation_=new Cu(t,i,m,p,_*y,x),0===h.triangulation_.getTriangles().length)return h.state=Fe,h;h.sourceZ_=r.getZForResolution(_);var T=h.triangulation_.calculateSourceExtent();if(p&&(t.canWrapX()?(T[1]=ze(T[1],p[1],p[3]),T[3]=ze(T[3],p[1],p[3])):T=Et(T,p)),yt(T)){for(var C=r.getTileRangeForExtentAndZ(T,h.sourceZ_),b=C.minX;b<=C.maxX;b++)for(var M=C.minY;M<=C.maxY;M++){var A=u(h.sourceZ_,b,M,s);A&&h.sourceTiles_.push(A)}0===h.sourceTiles_.length&&(h.state=Fe)}else h.state=Fe;return h}return bu(t,e),t.prototype.getImage=function(){return this.canvas_},t.prototype.reproject_=function(){var e=[];if(this.sourceTiles_.forEach(function(t,r,i){t&&2==t.getState()&&e.push({extent:this.sourceTileGrid_.getTileCoordExtent(t.tileCoord),image:t.getImage()})}.bind(this)),this.sourceTiles_.length=0,0===e.length)this.state=3;else{var t=this.wrappedTileCoord_[0],r=this.targetTileGrid_.getTileSize(t),i="number"==typeof r?r:r[0],o="number"==typeof r?r:r[1],n=this.targetTileGrid_.getResolution(t),a=this.sourceTileGrid_.getResolution(this.sourceZ_),s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_);this.canvas_=function(e,t,r,i,o,n,a,s,l,u,c){var d=Gi(Math.round(r*e),Math.round(r*t));if(0===l.length)return d.canvas;d.scale(r,r);var h=[1/0,1/0,-1/0,-1/0];l.forEach(function(e,t,r){mt(h,e.extent)});var f=St(h),g=At(h),p=Gi(Math.round(r*f/i),Math.round(r*g/i)),m=r/i;l.forEach(function(e,t,r){var i=e.extent[0]-h[0],o=-(e.extent[3]-h[3]),n=St(e.extent),a=At(e.extent);p.drawImage(e.image,u,u,e.image.width-2*u,e.image.height-2*u,i*m,o*m,n*m,a*m)});var v=Lt(a);return s.getTriangles().forEach(function(e,t,o){var a=e.source,s=e.target,l=a[0][0],u=a[0][1],c=a[1][0],f=a[1][1],g=a[2][0],m=a[2][1],x=(s[0][0]-v[0])/n,_=-(s[0][1]-v[1])/n,y=(s[1][0]-v[0])/n,T=-(s[1][1]-v[1])/n,C=(s[2][0]-v[0])/n,b=-(s[2][1]-v[1])/n,M=l,A=u;l=0,u=0;var E=function(e){for(var t=e.length,r=0;r<t;r++){for(var i=r,o=Math.abs(e[r][r]),n=r+1;n<t;n++){var a=Math.abs(e[n][r]);a>o&&(o=a,i=n)}if(0===o)return null;var s=e[i];e[i]=e[r],e[r]=s;for(var l=r+1;l<t;l++)for(var u=-e[l][r]/e[r][r],c=r;c<t+1;c++)r==c?e[l][c]=0:e[l][c]+=u*e[r][c]}for(var d=new Array(t),h=t-1;h>=0;h--){d[h]=e[h][t]/e[h][h];for(var f=h-1;f>=0;f--)e[f][t]-=e[f][h]*d[h]}return d}([[c-=M,f-=A,0,0,y-x],[g-=M,m-=A,0,0,C-x],[0,0,c,f,T-_],[0,0,g,m,b-_]]);if(E){d.save(),d.beginPath();var L=(x+y+C)/3,w=(_+T+b)/3,S=yu(L,w,x,_),D=yu(L,w,y,T),R=yu(L,w,C,b);d.moveTo(D[0],D[1]),d.lineTo(S[0],S[1]),d.lineTo(R[0],R[1]),d.clip(),d.transform(E[0],E[2],E[1],E[3],x,_),d.translate(h[0]-M,h[3]-A),d.scale(i/r,-i/r),d.drawImage(p.canvas,0,0),d.restore()}}),c&&(d.save(),d.strokeStyle="black",d.lineWidth=1,s.getTriangles().forEach(function(e,t,r){var i=e.target,o=(i[0][0]-v[0])/n,a=-(i[0][1]-v[1])/n,s=(i[1][0]-v[0])/n,l=-(i[1][1]-v[1])/n,u=(i[2][0]-v[0])/n,c=-(i[2][1]-v[1])/n;d.beginPath(),d.moveTo(s,l),d.lineTo(o,a),d.lineTo(u,c),d.closePath(),d.stroke()}),d.restore()),d.canvas}(i,o,this.pixelRatio_,a,this.sourceTileGrid_.getExtent(),n,s,this.triangulation_,e,this.gutter_,this.renderEdges_),this.state=2}this.changed()},t.prototype.load=function(){if(this.state==Ie){this.state=1,this.changed();var e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(function(t,r,i){var o=t.getState();if(o==Ie||1==o){e++;var n=m(t,F,function(r){var i=t.getState();2!=i&&3!=i&&i!=Fe||(x(n),0==--e&&(this.unlistenSources_(),this.reproject_()))},this);this.sourcesListenerKeys_.push(n)}}.bind(this)),this.sourceTiles_.forEach(function(e,t,r){e.getState()==Ie&&e.load()}),0===e&&setTimeout(this.reproject_.bind(this),0)}},t.prototype.unlistenSources_=function(){this.sourcesListenerKeys_.forEach(x),this.sourcesListenerKeys_=null},t}(lu);function Au(e,t){var r=/\{z\}/g,i=/\{x\}/g,o=/\{y\}/g,n=/\{-y\}/g;return function(a,s,l){return a?e.replace(r,a[0].toString()).replace(i,a[1].toString()).replace(o,a[2].toString()).replace(n,function(){var e=a[0],r=t.getFullTileRange(e);return Oe(r,55),(r.getHeight()-a[2]-1).toString()}):void 0}}function Eu(e,t,r){}var Lu=[0,0,0],wu=function(){function e(e){var t,r,i;if(this.minZoom=void 0!==e.minZoom?e.minZoom:0,this.resolutions_=e.resolutions,Oe((t=this.resolutions_,!0,r=function(e,t){return t-e}||y,t.every(function(e,i){if(0===i)return!0;var o=r(t[i-1],e);return!(o>0||0===o)})),17),!e.origins)for(var o=0,n=this.resolutions_.length-1;o<n;++o)if(i){if(this.resolutions_[o]/this.resolutions_[o+1]!==i){i=void 0;break}}else i=this.resolutions_[o]/this.resolutions_[o+1];this.zoomFactor_=i,this.maxZoom=this.resolutions_.length-1,this.origin_=void 0!==e.origin?e.origin:null,this.origins_=null,void 0!==e.origins&&(this.origins_=e.origins,Oe(this.origins_.length==this.resolutions_.length,20));var a=e.extent;void 0===a||this.origin_||this.origins_||(this.origin_=Lt(a)),Oe(!this.origin_&&this.origins_||this.origin_&&!this.origins_,18),this.tileSizes_=null,void 0!==e.tileSizes&&(this.tileSizes_=e.tileSizes,Oe(this.tileSizes_.length==this.resolutions_.length,19)),this.tileSize_=void 0!==e.tileSize?e.tileSize:this.tileSizes_?null:256,Oe(!this.tileSize_&&this.tileSizes_||this.tileSize_&&!this.tileSizes_,22),this.extent_=void 0!==a?a:null,this.fullTileRanges_=null,this.tmpSize_=[0,0],void 0!==e.sizes?this.fullTileRanges_=e.sizes.map(function(e,t){return new ts(Math.min(0,e[0]),Math.max(e[0]-1,-1),Math.min(0,e[1]),Math.max(e[1]-1,-1))},this):a&&this.calculateTileRanges_(a)}return e.prototype.forEachTileCoord=function(e,t,r){for(var i=this.getTileRangeForExtentAndZ(e,t),o=i.minX,n=i.maxX;o<=n;++o)for(var a=i.minY,s=i.maxY;a<=s;++a)r([t,o,a])},e.prototype.forEachTileCoordParentTileRange=function(e,t,r,i){var o,n,a=null,s=e[0]-1;for(2===this.zoomFactor_?(o=e[1],n=e[2]):a=this.getTileCoordExtent(e,i);s>=this.minZoom;){if(t(s,2===this.zoomFactor_?Ja(o=Math.floor(o/2),o,n=Math.floor(n/2),n,r):this.getTileRangeForExtentAndZ(a,s,r)))return!0;--s}return!1},e.prototype.getExtent=function(){return this.extent_},e.prototype.getMaxZoom=function(){return this.maxZoom},e.prototype.getMinZoom=function(){return this.minZoom},e.prototype.getOrigin=function(e){return this.origin_?this.origin_:this.origins_[e]},e.prototype.getResolution=function(e){return this.resolutions_[e]},e.prototype.getResolutions=function(){return this.resolutions_},e.prototype.getTileCoordChildTileRange=function(e,t,r){if(e[0]<this.maxZoom){if(2===this.zoomFactor_){var i=2*e[1],o=2*e[2];return Ja(i,i+1,o,o+1,t)}var n=this.getTileCoordExtent(e,r);return this.getTileRangeForExtentAndZ(n,e[0]+1,t)}return null},e.prototype.getTileRangeExtent=function(e,t,r){var i=this.getOrigin(e),o=this.getResolution(e),n=so(this.getTileSize(e),this.tmpSize_),a=i[0]+t.minX*n[0]*o,s=i[0]+(t.maxX+1)*n[0]*o;return ft(a,i[1]+t.minY*n[1]*o,s,i[1]+(t.maxY+1)*n[1]*o,r)},e.prototype.getTileRangeForExtentAndZ=function(e,t,r){var i=Lu;this.getTileCoordForXYAndZ_(e[0],e[3],t,!1,i);var o=i[1],n=i[2];return this.getTileCoordForXYAndZ_(e[2],e[1],t,!0,i),Ja(o,i[1],n,i[2],r)},e.prototype.getTileCoordCenter=function(e){var t=this.getOrigin(e[0]),r=this.getResolution(e[0]),i=so(this.getTileSize(e[0]),this.tmpSize_);return[t[0]+(e[1]+.5)*i[0]*r,t[1]-(e[2]+.5)*i[1]*r]},e.prototype.getTileCoordExtent=function(e,t){var r=this.getOrigin(e[0]),i=this.getResolution(e[0]),o=so(this.getTileSize(e[0]),this.tmpSize_),n=r[0]+e[1]*o[0]*i,a=r[1]-(e[2]+1)*o[1]*i;return ft(n,a,n+o[0]*i,a+o[1]*i,t)},e.prototype.getTileCoordForCoordAndResolution=function(e,t,r){return this.getTileCoordForXYAndResolution_(e[0],e[1],t,!1,r)},e.prototype.getTileCoordForXYAndResolution_=function(e,t,r,i,o){var n=this.getZForResolution(r),a=r/this.getResolution(n),s=this.getOrigin(n),l=so(this.getTileSize(n),this.tmpSize_),u=i?.5:0,c=i?.5:0,d=Math.floor((e-s[0])/r+u),h=Math.floor((s[1]-t)/r+c),f=a*d/l[0],g=a*h/l[1];return i?(f=Math.ceil(f)-1,g=Math.ceil(g)-1):(f=Math.floor(f),g=Math.floor(g)),hu(n,f,g,o)},e.prototype.getTileCoordForXYAndZ_=function(e,t,r,i,o){var n=this.getOrigin(r),a=this.getResolution(r),s=so(this.getTileSize(r),this.tmpSize_),l=i?.5:0,u=i?.5:0,c=Math.floor((e-n[0])/a+l),d=Math.floor((n[1]-t)/a+u),h=c/s[0],f=d/s[1];return i?(h=Math.ceil(h)-1,f=Math.ceil(f)-1):(h=Math.floor(h),f=Math.floor(f)),hu(r,h,f,o)},e.prototype.getTileCoordForCoordAndZ=function(e,t,r){return this.getTileCoordForXYAndZ_(e[0],e[1],t,!1,r)},e.prototype.getTileCoordResolution=function(e){return this.resolutions_[e[0]]},e.prototype.getTileSize=function(e){return this.tileSize_?this.tileSize_:this.tileSizes_[e]},e.prototype.getFullTileRange=function(e){return this.fullTileRanges_?this.fullTileRanges_[e]:null},e.prototype.getZForResolution=function(e,t){return ze(T(this.resolutions_,e,t||0),this.minZoom,this.maxZoom)},e.prototype.calculateTileRanges_=function(e){for(var t=this.resolutions_.length,r=new Array(t),i=this.minZoom;i<t;++i)r[i]=this.getTileRangeForExtentAndZ(e,i);this.fullTileRanges_=r},e}();function Su(e){var t=e.getDefaultTileGrid();return t||(t=function(e,t,r,i){return function(e,t,r,i){var o=Je,n=Du(e,void 0,r);return new wu({extent:e,origin:function(e,t){var r;return t===Ke?r=Tt(e):t===Ze?r=Ct(e):t===Je?r=Lt(e):t===Qe?r=wt(e):Oe(!1,13),r}(e,o),resolutions:n,tileSize:r})}(Ru(e),0,void 0)}(e),e.setDefaultTileGrid(t)),t}function Du(e,t,r,i){for(var o=void 0!==t?t:42,n=At(e),a=St(e),s=so(void 0!==r?r:256),l=i>0?i:Math.max(a/s[0],n/s[1]),u=o+1,c=new Array(u),d=0;d<u;++d)c[d]=l/Math.pow(2,d);return c}function Ru(e){var t=(e=Dr(e)).getExtent();if(!t){var r=180*lr[cr.DEGREES]/e.getMetersPerUnit();t=ft(-r,-r,r,r)}return t}var Pu,Iu,Fu,Ou=(Fu=function(e,t){return(Fu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Fu(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Bu=function(e){function t(t){var r=e.call(this,{attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,projection:t.projection,state:t.state,wrapX:t.wrapX})||this;r.opaque_=void 0!==t.opaque&&t.opaque,r.tilePixelRatio_=void 0!==t.tilePixelRatio?t.tilePixelRatio:1,r.tileGrid=void 0!==t.tileGrid?t.tileGrid:null;var i=[256,256],o=t.tileGrid;o&&so(o.getTileSize(o.getMinZoom()),i);var n="undefined"!=typeof screen,a=n?screen.availWidth||screen.width:1920,s=n?screen.availHeight||screen.height:1080,l=4*Math.ceil(a/i[0])*Math.ceil(s/i[1]);return r.tileCache=new xu(Math.max(l,t.cacheSize||0)),r.tmpSize=[0,0],r.key_=t.key||"",r.tileOptions={transition:t.transition},r.zDirection=t.zDirection?t.zDirection:0,r}return Ou(t,e),t.prototype.canExpireCache=function(){return this.tileCache.canExpireCache()},t.prototype.expireCache=function(e,t){var r=this.getTileCacheForProjection(e);r&&r.expireCache(t)},t.prototype.forEachLoadedTile=function(e,t,r,i){var o=this.getTileCacheForProjection(e);if(!o)return!1;for(var n,a,s,l=!0,u=r.minX;u<=r.maxX;++u)for(var c=r.minY;c<=r.maxY;++c)a=fu(t,u,c),s=!1,o.containsKey(a)&&(s=2===(n=o.get(a)).getState())&&(s=!1!==i(n)),s||(l=!1);return l},t.prototype.getGutterForProjection=function(e){return 0},t.prototype.getKey=function(){return this.key_},t.prototype.setKey=function(e){this.key_!==e&&(this.key_=e,this.changed())},t.prototype.getOpaque=function(e){return this.opaque_},t.prototype.getResolutions=function(){return this.tileGrid.getResolutions()},t.prototype.getTile=function(e,t,r,o,n){return i()},t.prototype.getTileGrid=function(){return this.tileGrid},t.prototype.getTileGridForProjection=function(e){return this.tileGrid?this.tileGrid:Su(e)},t.prototype.getTileCacheForProjection=function(e){var t=this.getProjection();return t&&!Fr(t,e)?null:this.tileCache},t.prototype.getTilePixelRatio=function(e){return this.tilePixelRatio_},t.prototype.getTilePixelSize=function(e,t,r){var i=this.getTileGridForProjection(r),o=this.getTilePixelRatio(t),n=so(i.getTileSize(e),this.tmpSize);return 1==o?n:ao(n,o,this.tmpSize)},t.prototype.getTileCoordForTileUrlFunction=function(e,t){var r=void 0!==t?t:this.getProjection(),i=this.getTileGridForProjection(r);return this.getWrapX()&&r.isGlobal()&&(e=function(e,t,r){var i=t[0],o=e.getTileCoordCenter(t),n=Ru(r);if(ut(n,o))return t;var a=St(n),s=Math.ceil((n[0]-o[0])/a);return o[0]+=a*s,e.getTileCoordForCoordAndZ(o,i)}(i,e,r)),function(e,t){var r=e[0],i=e[1],o=e[2];if(t.getMinZoom()>r||r>t.getMaxZoom())return!1;var n,a=t.getExtent();return!(n=a?t.getTileRangeForExtentAndZ(a,r):t.getFullTileRange(r))||n.containsXY(i,o)}(e,i)?e:null},t.prototype.clear=function(){this.tileCache.clear()},t.prototype.refresh=function(){this.clear(),e.prototype.refresh.call(this)},t.prototype.useTile=function(e,t,r,i){},t}(Ql),Nu=function(e){function t(t,r){var i=e.call(this,t)||this;return i.tile=r,i}return Ou(t,e),t}(R),Uu=(Iu=function(e,t){return(Iu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Iu(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Gu=function(e){function t(t){var r=e.call(this,{attributions:t.attributions,cacheSize:t.cacheSize,opaque:t.opaque,projection:t.projection,state:t.state,tileGrid:t.tileGrid,tilePixelRatio:t.tilePixelRatio,wrapX:t.wrapX,transition:t.transition,key:t.key,attributionsCollapsible:t.attributionsCollapsible,zDirection:t.zDirection})||this;return r.generateTileUrlFunction_=!t.tileUrlFunction,r.tileLoadFunction=t.tileLoadFunction,r.tileUrlFunction=t.tileUrlFunction?t.tileUrlFunction.bind(r):Eu,r.urls=null,t.urls?r.setUrls(t.urls):t.url&&r.setUrl(t.url),r.tileLoadingKeys_={},r}return Uu(t,e),t.prototype.getTileLoadFunction=function(){return this.tileLoadFunction},t.prototype.getTileUrlFunction=function(){return this.tileUrlFunction},t.prototype.getUrls=function(){return this.urls},t.prototype.handleTileChange=function(e){var t,r=e.target,i=n(r),o=r.getState();1==o?(this.tileLoadingKeys_[i]=!0,t="tileloadstart"):i in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[i],t=3==o?"tileloaderror":2==o?"tileloadend":void 0),null!=t&&this.dispatchEvent(new Nu(t,r))},t.prototype.setTileLoadFunction=function(e){this.tileCache.clear(),this.tileLoadFunction=e,this.changed()},t.prototype.setTileUrlFunction=function(e,t){this.tileUrlFunction=e,this.tileCache.pruneExceptNewestZ(),void 0!==t?this.setKey(t):this.changed()},t.prototype.setUrl=function(e){var t=function(e){var t=[],r=/\{([a-z])-([a-z])\}/.exec(e);if(r){var i=r[1].charCodeAt(0),o=r[2].charCodeAt(0),n=void 0;for(n=i;n<=o;++n)t.push(e.replace(r[0],String.fromCharCode(n)));return t}if(r=/\{(\d+)-(\d+)\}/.exec(e)){for(var a=parseInt(r[2],10),s=parseInt(r[1],10);s<=a;s++)t.push(e.replace(r[0],s.toString()));return t}return t.push(e),t}(e);this.urls=t,this.setUrls(t)},t.prototype.setUrls=function(e){this.urls=e;var t=e.join("\n");this.generateTileUrlFunction_?this.setTileUrlFunction(function(e,t){for(var r=e.length,i=new Array(r),o=0;o<r;++o)i[o]=Au(e[o],t);return function(e){return 1===e.length?e[0]:function(t,r,i){if(t){var o=We(pu(t),e.length);return e[o](t,r,i)}}}(i)}(e,this.tileGrid),t):this.setKey(t)},t.prototype.useTile=function(e,t,r){var i=fu(e,t,r);this.tileCache.containsKey(i)&&this.tileCache.get(i)},t}(Bu),zu=(Pu=function(e,t){return(Pu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Pu(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Hu(e,t){e.getImage().src=t}var Vu,ku=function(e){function t(t){var r=e.call(this,{attributions:t.attributions,cacheSize:t.cacheSize,opaque:t.opaque,projection:t.projection,state:t.state,tileGrid:t.tileGrid,tileLoadFunction:t.tileLoadFunction?t.tileLoadFunction:Hu,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:t.tileUrlFunction,url:t.url,urls:t.urls,wrapX:t.wrapX,transition:t.transition,key:t.key,attributionsCollapsible:t.attributionsCollapsible,zDirection:t.zDirection})||this;return r.crossOrigin=void 0!==t.crossOrigin?t.crossOrigin:null,r.tileClass=void 0!==t.tileClass?t.tileClass:cu,r.tileCacheForProjection={},r.tileGridForProjection={},r.reprojectionErrorThreshold_=t.reprojectionErrorThreshold,r.renderReprojectionEdges_=!1,r}return zu(t,e),t.prototype.canExpireCache=function(){if(this.tileCache.canExpireCache())return!0;for(var e in this.tileCacheForProjection)if(this.tileCacheForProjection[e].canExpireCache())return!0;return!1},t.prototype.expireCache=function(e,t){var r=this.getTileCacheForProjection(e);for(var i in this.tileCache.expireCache(this.tileCache==r?t:{}),this.tileCacheForProjection){var o=this.tileCacheForProjection[i];o.expireCache(o==r?t:{})}},t.prototype.getGutterForProjection=function(e){return this.getProjection()&&e&&!Fr(this.getProjection(),e)?0:this.getGutter()},t.prototype.getGutter=function(){return 0},t.prototype.getOpaque=function(t){return!(this.getProjection()&&t&&!Fr(this.getProjection(),t))&&e.prototype.getOpaque.call(this,t)},t.prototype.getTileGridForProjection=function(e){var t=this.getProjection();if(!this.tileGrid||t&&!Fr(t,e)){var r=n(e);return r in this.tileGridForProjection||(this.tileGridForProjection[r]=Su(e)),this.tileGridForProjection[r]}return this.tileGrid},t.prototype.getTileCacheForProjection=function(e){var t=this.getProjection();if(!t||Fr(t,e))return this.tileCache;var r=n(e);return r in this.tileCacheForProjection||(this.tileCacheForProjection[r]=new xu(this.tileCache.highWaterMark)),this.tileCacheForProjection[r]},t.prototype.createTile_=function(e,t,r,i,o,n){var a=[e,t,r],s=this.getTileCoordForTileUrlFunction(a,o),l=s?this.tileUrlFunction(s,i,o):void 0,u=new this.tileClass(a,void 0!==l?Ie:Fe,void 0!==l?l:"",this.crossOrigin,this.tileLoadFunction,this.tileOptions);return u.key=n,u.addEventListener(F,this.handleTileChange.bind(this)),u},t.prototype.getTile=function(e,t,r,i,o){var n=this.getProjection();if(n&&o&&!Fr(n,o)){var a=this.getTileCacheForProjection(o),s=[e,t,r],l=void 0,u=gu(s);a.containsKey(u)&&(l=a.get(u));var c=this.getKey();if(l&&l.key==c)return l;var d=this.getTileGridForProjection(n),h=this.getTileGridForProjection(o),f=this.getTileCoordForTileUrlFunction(s,o),g=new Mu(n,d,o,h,s,f,this.getTilePixelRatio(i),this.getGutter(),function(e,t,r,i){return this.getTileInternal(e,t,r,i,n)}.bind(this),this.reprojectionErrorThreshold_,this.renderReprojectionEdges_);return g.key=c,l?(g.interimTile=l,g.refreshInterimChain(),a.replace(u,g)):a.set(u,g),g}return this.getTileInternal(e,t,r,i,n||o)},t.prototype.getTileInternal=function(e,t,r,i,o){var n=null,a=fu(e,t,r),s=this.getKey();if(this.tileCache.containsKey(a)){if((n=this.tileCache.get(a)).key!=s){var l=n;n=this.createTile_(e,t,r,i,o,s),l.getState()==Ie?n.interimTile=l.interimTile:n.interimTile=l,n.refreshInterimChain(),this.tileCache.replace(a,n)}}else n=this.createTile_(e,t,r,i,o,s),this.tileCache.set(a,n);return n},t.prototype.setRenderReprojectionEdges=function(e){if(this.renderReprojectionEdges_!=e){for(var t in this.renderReprojectionEdges_=e,this.tileCacheForProjection)this.tileCacheForProjection[t].clear();this.changed()}},t.prototype.setTileGridForProjection=function(e,t){var r=Dr(e);if(r){var i=n(r);i in this.tileGridForProjection||(this.tileGridForProjection[i]=t)}},t}(Gu),ju=(Vu=function(e,t){return(Vu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Vu(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),Wu=function(e){function t(t){var r=t||{},i=void 0!==r.projection?r.projection:"EPSG:3857",o=void 0!==r.tileGrid?r.tileGrid:function(e){var t=e||{},r=t.extent||Dr("EPSG:3857").getExtent(),i={extent:r,minZoom:t.minZoom,tileSize:t.tileSize,resolutions:Du(r,t.maxZoom,t.tileSize,t.maxResolution)};return new wu(i)}({extent:Ru(i),maxResolution:r.maxResolution,maxZoom:r.maxZoom,minZoom:r.minZoom,tileSize:r.tileSize});return e.call(this,{attributions:r.attributions,cacheSize:r.cacheSize,crossOrigin:r.crossOrigin,opaque:r.opaque,projection:i,reprojectionErrorThreshold:r.reprojectionErrorThreshold,tileGrid:o,tileLoadFunction:r.tileLoadFunction,tilePixelRatio:r.tilePixelRatio,tileUrlFunction:r.tileUrlFunction,url:r.url,urls:r.urls,wrapX:void 0===r.wrapX||r.wrapX,transition:r.transition,attributionsCollapsible:r.attributionsCollapsible,zDirection:r.zDirection})||this}return ju(t,e),t}(ku);function Xu(e,t){var r=[];Object.keys(t).forEach(function(e){null!==t[e]&&void 0!==t[e]&&r.push(e+"="+encodeURIComponent(t[e]))});var i=r.join("&");return(e=-1===(e=e.replace(/[?&]$/,"")).indexOf("?")?e+"?":e+"&")+i}var Yu,qu=(Yu=function(e,t){return(Yu=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}Yu(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});function Ku(e,t,r){var i=this.getTileGrid();if(i||(i=this.getTileGridForProjection(r)),!(i.getResolutions().length<=e[0])){1==t||this.hidpi_&&void 0!==this.serverType_||(t=1);var o=i.getResolution(e[0]),n=i.getTileCoordExtent(e,this.tmpExtent_),a=so(i.getTileSize(e[0]),this.tmpSize),s=this.gutter_;0!==s&&(a=no(a,s,this.tmpSize),n=at(n,o*s,n)),1!=t&&(a=ao(a,t,this.tmpSize));var l={SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetMap",FORMAT:"image/png",TRANSPARENT:!0};return h(l,this.params_),this.getRequestUrl_(e,a,n,t,r,l)}}var Zu=function(e){function t(t){var r=this,i=t||{},o=i.params||{},n=!("TRANSPARENT"in o)||o.TRANSPARENT;return(r=e.call(this,{attributions:i.attributions,cacheSize:i.cacheSize,crossOrigin:i.crossOrigin,opaque:!n,projection:i.projection,reprojectionErrorThreshold:i.reprojectionErrorThreshold,tileClass:i.tileClass,tileGrid:i.tileGrid,tileLoadFunction:i.tileLoadFunction,tileUrlFunction:Ku,url:i.url,urls:i.urls,wrapX:void 0===i.wrapX||i.wrapX,transition:i.transition})||this).gutter_=void 0!==i.gutter?i.gutter:0,r.params_=o,r.v13_=!0,r.serverType_=i.serverType,r.hidpi_=void 0===i.hidpi||i.hidpi,r.tmpExtent_=[1/0,1/0,-1/0,-1/0],r.updateV13_(),r.setKey(r.getKeyForParams_()),r}return qu(t,e),t.prototype.getFeatureInfoUrl=function(e,t,r,i){var o=Dr(r),n=this.getProjection(),a=this.getTileGrid();a||(a=this.getTileGridForProjection(o));var s=a.getZForResolution(t,this.zDirection),l=a.getTileCoordForCoordAndZ(e,s);if(!(a.getResolutions().length<=l[0])){var u=a.getResolution(l[0]),c=a.getTileCoordExtent(l,this.tmpExtent_),d=so(a.getTileSize(l[0]),this.tmpSize),f=this.gutter_;0!==f&&(d=no(d,f,this.tmpSize),c=at(c,u*f,c)),n&&n!==o&&(u=_u(n,o,e,u),c=Ur(c,o,n),e=Nr(e,o,n));var g={SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetFeatureInfo",FORMAT:"image/png",TRANSPARENT:!0,QUERY_LAYERS:this.params_.LAYERS};h(g,this.params_,i);var p=Math.floor((e[0]-c[0])/u),m=Math.floor((c[3]-e[1])/u);return g[this.v13_?"I":"X"]=p,g[this.v13_?"J":"Y"]=m,this.getRequestUrl_(l,d,c,1,n||o,g)}},t.prototype.getLegendUrl=function(e,t){if(void 0!==this.urls[0]){var r={SERVICE:"WMS",VERSION:"1.3.0",REQUEST:"GetLegendGraphic",FORMAT:"image/png"};if(void 0===t||void 0===t.LAYER){var i=this.params_.LAYERS;if(Array.isArray(i)&&1!==i.length)return;r.LAYER=i}if(void 0!==e){var o=this.getProjection()?this.getProjection().getMetersPerUnit():1;r.SCALE=e*o*39.37*(25.4/.28)}return h(r,t),Xu(this.urls[0],r)}},t.prototype.getGutter=function(){return this.gutter_},t.prototype.getParams=function(){return this.params_},t.prototype.getRequestUrl_=function(e,t,r,i,o,n){var a=this.urls;if(a){if(n.WIDTH=t[0],n.HEIGHT=t[1],n[this.v13_?"CRS":"SRS"]=o.getCode(),"STYLES"in this.params_||(n.STYLES=""),1!=i)switch(this.serverType_){case"geoserver":var s=90*i+.5|0;"FORMAT_OPTIONS"in n?n.FORMAT_OPTIONS+=";dpi:"+s:n.FORMAT_OPTIONS="dpi:"+s;break;case"mapserver":n.MAP_RESOLUTION=90*i;break;case"carmentaserver":case"qgis":n.DPI=90*i;break;default:Oe(!1,52)}var l=o.getAxisOrientation(),u=r;if(this.v13_&&"ne"==l.substr(0,2)){var c=void 0;c=r[0],u[0]=r[1],u[1]=c,c=r[2],u[2]=r[3],u[3]=c}return n.BBOX=u.join(","),Xu(1==a.length?a[0]:a[We(pu(e),a.length)],n)}},t.prototype.getTilePixelRatio=function(e){return this.hidpi_&&void 0!==this.serverType_?e:1},t.prototype.getKeyForParams_=function(){var e=0,t=[];for(var r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")},t.prototype.updateParams=function(e){h(this.params_,e),this.updateV13_(),this.setKey(this.getKeyForParams_())},t.prototype.updateV13_=function(){var e=this.params_.VERSION||"1.3.0";this.v13_=function(e,t){for(var r=(""+e).split("."),i="1.3".split("."),o=0;o<Math.max(r.length,i.length);o++){var n=parseInt(r[o]||"0",10),a=parseInt(i[o]||"0",10);if(n>a)return 1;if(a>n)return-1}return 0}(e)>=0},t}(ku),Ju={};Ju.Map=Wa,Ju.View=Ui,Ju.Feature=au,Ju.geom={},Ju.geom.Polygon={},Ju.geom.Polygon.fromExtent=Ii,Ju.layer={},Ju.layer.TileLayer=fs,Ju.layer.VectorLayer=Nl,Ju.source={},Ju.source.XYZ=Wu,Ju.source.TileWMS=Zu,Ju.source.VectorSource=ou,Ju.proj={},Ju.proj.getTransform=Br,Ju.interaction={},Ju.interaction.DragRotate=dn,Ju.interaction.DragPan=un,Ju.interaction.MouseWheelZoom=Nn,Ju.interaction.defaults=Vn,Ju.control={},Ju.control.defaults=Io}})}),"function"!=typeof Promise.prototype.done&&(Promise.prototype.done=function(e,t){(arguments.length?this.then.apply(this,arguments):this).then(null,function(e){setTimeout(function(){throw e},0)})}),In=function(){function e(e){var t=this.constructor;return this.then(function(r){return t.resolve(e()).then(function(){return r})},function(r){return t.resolve(e()).then(function(){return t.reject(r)})})}var t=setTimeout;function r(e){return Boolean(e&&void 0!==e.length)}function i(){}function o(e){if(!(this instanceof o))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],u(e,this)}function n(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,o._immediateFn(function(){var r=1===e._state?t.onFulfilled:t.onRejected;if(null!==r){var i;try{i=r(e._value)}catch(e){return void s(t.promise,e)}a(t.promise,i)}else(1===e._state?a:s)(t.promise,e._value)})):e._deferreds.push(t)}function a(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"===H(t)||"function"==typeof t)){var r=t.then;if(t instanceof o)return e._state=3,e._value=t,void l(e);if("function"==typeof r)return void u((i=r,n=t,function(){i.apply(n,arguments)}),e)}e._state=1,e._value=t,l(e)}catch(t){s(e,t)}var i,n}function s(e,t){e._state=2,e._value=t,l(e)}function l(e){2===e._state&&0===e._deferreds.length&&o._immediateFn(function(){e._handled||o._unhandledRejectionFn(e._value)});for(var t=0,r=e._deferreds.length;t<r;t++)n(e,e._deferreds[t]);e._deferreds=null}function u(e,t){var r=!1;try{e(function(e){r||(r=!0,a(t,e))},function(e){r||(r=!0,s(t,e))})}catch(e){if(r)return;r=!0,s(t,e)}}o.prototype.catch=function(e){return this.then(null,e)},o.prototype.then=function(e,t){var r=new this.constructor(i);return n(this,new function(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}(e,t,r)),r},o.prototype.finally=e,o.prototype.done=function(e,t){(arguments.length?this.then.apply(this,arguments):this).then(null,function(e){setTimeout(function(){throw e},0)})},o.all=function(e){return new o(function(t,i){if(!r(e))return i(new TypeError("Promise.all accepts an array"));var o=Array.prototype.slice.call(e);if(0===o.length)return t([]);var n=o.length;function a(e,r){try{if(r&&("object"===H(r)||"function"==typeof r)){var s=r.then;if("function"==typeof s)return void s.call(r,function(t){a(e,t)},i)}o[e]=r,0==--n&&t(o)}catch(e){i(e)}}for(var s=0;s<o.length;s++)a(s,o[s])})},o.resolve=function(e){return e&&"object"===H(e)&&e.constructor===o?e:new o(function(t){t(e)})},o.reject=function(e){return new o(function(t,r){r(e)})},o.race=function(e){return new o(function(t,i){if(!r(e))return i(new TypeError("Promise.race accepts an array"));for(var n=0,a=e.length;n<a;n++)o.resolve(e[n]).then(t,i)})},o._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){t(e,0)},o._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};var c=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();"function"!=typeof c.Promise?c.Promise=o:c.Promise.prototype.finally||(c.Promise.prototype.finally=e)},"object"===("undefined"==typeof exports?"undefined":H(exports))&&"undefined"!=typeof module?In():"function"==typeof define&&define.amd?define(In):In(),On.prototype.parsingJson=function(e,t){"1.0.1"==t?this.jsonParsor=new Bn(e):"1.0.3"==t?this.jsonParsor=new Nn(e):alert(t+" is not a vailid version!"),this.nodes=this.jsonParsor.parsingNodeData(e),this.edges=this.jsonParsor.parsingEdgeData(e),this.cellSpaceMembers=this.jsonParsor.parsingCellSpaceMember(e),this.max_X=this.jsonParsor.getMaxX(),this.max_Y=this.jsonParsor.getMaxY(),this.max_Z=this.jsonParsor.getMaxZ(),this.min_X=this.jsonParsor.getMinX(),this.min_Y=this.jsonParsor.getMinY(),this.min_Z=this.jsonParsor.getMinZ()},On.prototype.setCenter=function(){this.center_X=(this.min_X+this.max_X)/2,this.center_Y=(this.min_Y+this.max_Y)/2},On.prototype.rotateBuilding=function(e,t,r){var i=e.scene.globe.ellipsoid,o=new Cesium.Matrix4(Math.cos(r),-Math.sin(r),0,0,Math.sin(r),Math.cos(r),0,0,0,0,1,0,0,0,0,1);this.rotateCellSpaceMember(o,t,i),this.rotateCellSpaceBoundaryMembers(o,t,i),this.rotateNodes(o),this.rotateEdges(o)},On.prototype.rotateNodes=function(e){for(var t=this.nodes.length,r=0;r<t;r++){var i=new Cesium.Cartesian3(this.nodes[r].coordinates[0]-this.center_X,this.nodes[r].coordinates[1]-this.center_Y,this.nodes[r].coordinates[2]-this.min_Z),o=Cesium.Matrix4.multiplyByPoint(e,i,new Cesium.Cartesian3),n=Cesium.Matrix4.multiplyByPoint(this.ENU,o,o);this.nodes[r].coordinates[0]=n.x,this.nodes[r].coordinates[1]=n.y,this.nodes[r].coordinates[2]=n.z}},On.prototype.rotateEdges=function(e){for(var t=0;t<this.edges.length;t++)for(var r=0;r<this.edges[t].stateMembers.length;r++){var i=new Cesium.Cartesian3(this.edges[t].stateMembers[r].coordinates[0]-this.center_X,this.edges[t].stateMembers[r].coordinates[1]-this.center_Y,this.edges[t].stateMembers[r].coordinates[2]-this.min_Z),o=Cesium.Matrix4.multiplyByPoint(e,i,new Cesium.Cartesian3),n=Cesium.Matrix4.multiplyByPoint(this.ENU,o,o);this.edges[t].stateMembers[r].coordinates[0]=n.x,this.edges[t].stateMembers[r].coordinates[1]=n.y,this.edges[t].stateMembers[r].coordinates[2]=n.z}},On.prototype.rotateCellSpaceMember=function(e,t,r){Cesium.Transforms.eastNorthUpToFixedFrame(t,r,this.ENU);for(var i=0;i<this.cellSpaceMembers.length;i++)for(var o=this.cellSpaceMembers[i].surfaceMember.length,n=0;n<o;n++)for(var a=this.cellSpaceMembers[i].surfaceMember[n].coordinates.length,s=0;s<a;s+=3){var l=new Cesium.Cartesian3(this.cellSpaceMembers[i].surfaceMember[n].coordinates[s]-this.center_X,this.cellSpaceMembers[i].surfaceMember[n].coordinates[s+1]-this.center_Y,this.cellSpaceMembers[i].surfaceMember[n].coordinates[s+2]-this.min_Z),u=Cesium.Matrix4.multiplyByPoint(e,l,new Cesium.Cartesian3),c=Cesium.Matrix4.multiplyByPoint(this.ENU,u,u);this.cellSpaceMembers[i].surfaceMember[n].coordinates[s]=c.x,this.cellSpaceMembers[i].surfaceMember[n].coordinates[s+1]=c.y,this.cellSpaceMembers[i].surfaceMember[n].coordinates[s+2]=c.z}},On.prototype.rotateCellSpaceBoundaryMembers=function(e,t,r){Cesium.Transforms.eastNorthUpToFixedFrame(t,r,this.ENU);for(var i=0;i<this.cellSpaceBoundaryMembers.length;i++)for(var o=this.cellSpaceBoundaryMembers[i].surfaceMember.length,n=0;n<o;n++)for(var a=this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates.length,s=0;s<a;s+=3){var l=new Cesium.Cartesian3(this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s]-this.center_X,this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s+1]-this.center_Y,this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s+2]-this.min_Z),u=Cesium.Matrix4.multiplyByPoint(e,l,new Cesium.Cartesian3),c=Cesium.Matrix4.multiplyByPoint(this.ENU,u,u);this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s]=c.x,this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s+1]=c.y,this.cellSpaceBoundaryMembers[i].surfaceMember[n].coordinates[s+2]=c.z}},Bn.prototype.parsingNodeData=function(e){for(var t=[],r=e.value.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.nodes[0].stateMember,i=r.length,o=0;o<i;o++){var n=new Gn(r[o].state.geometry.point.pos.value);t.push(n)}return t},Bn.prototype.parsingEdgeData=function(e){for(var t=[],r=e.value.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.edges[0].transitionMember,i=0;i<r.length;i++){for(var o,n=[],a=0;a<r[i].transition.connects.length;a++)n.push(r[i].transition.connects[a].href);null!=r[i].transition.description&&(o=r[i].transition.description.value);for(var s=[],l=0;l<r[i].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep.length;l++){var u=new Gn(r[i].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep[l].value.value);s.push(u)}var c=new Hn(n,o,s);t.push(c)}return t},Bn.prototype.parsingCellSpaceMember=function(e){for(var t=[],r=e.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember.length,i=0;i<r;i++){var o=e.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember[i],n="";null!=o.abstractFeature.value.description&&(n=o.abstractFeature.value.description.value);var a="";null!=o.abstractFeature.value.id&&(a=o.abstractFeature.value.id);var s="";null!=o.abstractFeature.value.duality.href&&(s=o.abstractFeature.value.duality.href);var l=new Un(n,s,a,[]);null!=o.abstractFeature.value.geometry3D?l.surfaceMember=this.getCsmSurfaceMemberFromGeometry3D(o):null!=o.abstractFeature.value.geometry2D&&(l.surfaceMember=this.getCsmSurfaceMemberFromGeometry2D(o)),t.push(l)}return t},Bn.prototype.parsingCellSpaceBoundaryMember=function(e){for(var t=[],r=e.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember.length,i=0;i<r;i++){var o=e.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember[i],n="";null!=o.abstractFeature.value.description&&(n=o.abstractFeature.value.description.value);var a="";null!=o.abstractFeature.value.id&&(a=o.abstractFeature.value.id);var s="";null!=o.abstractFeature.value.duality&&(s=o.abstractFeature.value.duality.href);var l=new Un(n,s,a,[]);null!=o.abstractFeature.value.geometry3D&&(l.surfaceMember=this.getCsbmSurfaceMemberFromGeometry3D(o)),t.push(l)}return t},Bn.prototype.getCsmSurfaceMemberFromGeometry3D=function(e){for(var t=e.abstractFeature.value.geometry3D.abstractSolid.value.exterior.shell.surfaceMember.length,r=[],i=0;i<t;i++){for(var o=e.abstractFeature.value.geometry3D.abstractSolid.value.exterior.shell.surfaceMember[i],n=new zn([]),a=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,s=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep,l=0;l<a;l++)n=this.abstractCoordinate(s[l].value.value,n);r.push(n)}return r},Bn.prototype.getCsmSurfaceMemberFromGeometry2D=function(e){for(var t=[],r=e.abstractFeature.value.geometry2D.abstractSurface.value.exterior.abstractRing,i=new zn([]),o=r.value.posOrPointPropertyOrPointRep.length,n=0;n<o;n++)i=this.abstractCoordinate(r.value.posOrPointPropertyOrPointRep[n].value.value,i);return t.push(i),t},Bn.prototype.getCsbmSurfaceMemberFromGeometry3D=function(e){var t=new zn([]),r=[];if(null!=e.abstractFeature.value.geometry3D.abstractSurface.value.exterior)for(var i=e.abstractFeature.value.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,o=0;o<i;o++)t=this.abstractCoordinate(e.abstractFeature.value.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep[o].value.value,t);return r.push(t),r},Bn.prototype.abstractCoordinate=function(e,t){var r=e[0];t.coordinates.push(r),r>this.max_X?this.max_X=r:r<this.min_X&&(this.min_X=r);var i=e[1];t.coordinates.push(i),i>this.max_Y?this.max_Y=i:i<this.min_Y&&(this.min_Y=i);var o=e[2];return t.coordinates.push(o),o>this.max_Z?this.max_Z=o:o<this.min_Z&&(this.min_Z=o),t},Bn.prototype.getMaxX=function(){return this.max_X},Bn.prototype.getMaxY=function(){return this.max_Y},Bn.prototype.getMaxZ=function(){return this.max_Z},Bn.prototype.getMinX=function(){return this.min_X},Bn.prototype.getMinY=function(){return this.min_Y},Bn.prototype.getMinZ=function(){return this.min_Z},Nn.prototype.parsingNodeData=function(e){for(var t=[],r=e.value.multiLayeredGraph.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.nodes[0].stateMember,i=r.length,o=0;o<i;o++){var n=new Gn(r[o].state.geometry.point.pos.value);n.id=r[o].state.id,t.push(n)}return t},Nn.prototype.parsingEdgeData=function(e){for(var t=[],r=e.value.multiLayeredGraph.multiLayeredGraph.spaceLayers[0].spaceLayerMember[0].spaceLayer.edges[0].transitionMember,i=0;i<r.length;i++){for(var o,n=[],a=0;a<r[i].transition.connects.length;a++)n.push(r[i].transition.connects[a].href);null!=r[i].transition.description&&(o=r[i].transition.description.value);for(var s=[],l=0;l<r[i].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep.length;l++){var u=new Gn(r[i].transition.geometry.abstractCurve.value.posOrPointPropertyOrPointRep[l].value.value);s.push(u)}var c=new Hn(n,o,s);t.push(c)}return t},Nn.prototype.parsingCellSpaceMember=function(e){for(var t=[],r=e.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember.length,i=0;i<r;i++){var o=e.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceMember[i],n="";null!=o.cellSpace.description&&(n=o.cellSpace.description.value);var a="";null!=o.cellSpace.id&&(a=o.cellSpace.id);var s="";null!=o.cellSpace.duality.href&&(s=o.cellSpace.duality.href);var l=new Un(n,s,a,[]);null!=o.cellSpace.cellSpaceGeometry.geometry3D?l.surfaceMember=this.getCsmSurfaceMemberFromGeometry3D(o):null!=o.cellSpace.cellSpaceGeometry.geometry2D&&(l.surfaceMember=this.getCsmSurfaceMemberFromGeometry2D(o)),t.push(l)}return t},Nn.prototype.parsingCellSpaceBoundaryMember=function(e){for(var t=[],r=e.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember.length,i=0;i<r;i++){var o=e.value.primalSpaceFeatures.primalSpaceFeatures.cellSpaceBoundaryMember[i],n="";null!=o.cellSpaceBoundary.description&&(n=o.cellSpaceBoundary.description.value);var a="";null!=o.cellSpaceBoundary.id&&(a=o.cellSpaceBoundary.id);var s="";null!=o.cellSpaceBoundary.duality&&(s=o.cellSpaceBoundary.duality.href);var l=new Un(n,s,a,[]);null!=o.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D&&(l.surfaceMember=this.getCsbmSurfaceMemberFromGeometry3D(o)),t.push(l)}return t},Nn.prototype.getCsmSurfaceMemberFromGeometry3D=function(e){for(var t=e.cellSpace.cellSpaceGeometry.geometry3D.abstractSolid.value.exterior.shell.surfaceMember.length,r=[],i=0;i<t;i++){for(var o=e.cellSpace.cellSpaceGeometry.geometry3D.abstractSolid.value.exterior.shell.surfaceMember[i],n=new zn([]),a=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,s=o.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep,l=0;l<a;l++)n=this.abstractCoordinate(s[l].value.value,n);r.push(n)}return r},Nn.prototype.getCsmSurfaceMemberFromGeometry2D=function(e){for(var t=[],r=e.cellSpace.cellSpaceGeometry.geometry2D.abstractSurface.value.exterior.abstractRing,i=new zn([]),o=r.value.posOrPointPropertyOrPointRep.length,n=0;n<o;n++)i=this.abstractCoordinate(r.value.posOrPointPropertyOrPointRep[n].value.value,i);return t.push(i),t},Nn.prototype.getCsbmSurfaceMemberFromGeometry3D=function(e){var t=new zn([]),r=[];if(null!=e.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior)for(var i=e.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep.length,o=0;o<i;o++)t=this.abstractCoordinate(e.cellSpaceBoundary.cellSpaceBoundaryGeometry.geometry3D.abstractSurface.value.exterior.abstractRing.value.posOrPointPropertyOrPointRep[o].value.value,t);return r.push(t),r},Nn.prototype.abstractCoordinate=function(e,t){var r=e[0];t.coordinates.push(r),r>this.max_X?this.max_X=r:r<this.min_X&&(this.min_X=r);var i=e[1];t.coordinates.push(i),i>this.max_Y?this.max_Y=i:i<this.min_Y&&(this.min_Y=i);var o=e[2];return t.coordinates.push(o),o>this.max_Z?this.max_Z=o:o<this.min_Z&&(this.min_Z=o),t},Nn.prototype.getMaxX=function(){return this.max_X},Nn.prototype.getMaxY=function(){return this.max_Y},Nn.prototype.getMaxZ=function(){return this.max_Z},Nn.prototype.getMinX=function(){return this.min_X},Nn.prototype.getMinY=function(){return this.min_Y},Nn.prototype.getMinZ=function(){return this.min_Z};var Vn={VERSION:"4.0"};return Vn.Emitter=e,Vn.Interaction=t,Vn.MagoRenderable=r,Vn.ViewerInit=i,Vn.AirPollutionLayer=u,Vn.AirPollutionManager=c,Vn.ColorAPI=o,Vn.DrawAPI=n,Vn.LocationAndRotationAPI=a,Vn.LodAPI=s,Vn.MgAccessor=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR)},Vn.MgBuffer=d,Vn.MgBufferDataSet=h,Vn.MgBufferView=f,Vn.MgBufferViewSet=g,Vn.MgMaterial=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR)},Vn.MgMesh=p,Vn.MgNode=m,Vn.MgPrimitive=v,Vn.MgSet=x,Vn.MgSetCollection=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.mgSetsArray=[]},Vn.MgWebGl=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR)},Vn.VertexAttribPointerParameters=function e(t){var r=t.index,i=t.size,o=t.type,n=t.normalized,a=t.stride,s=t.offset;if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.index=r,this.size=i,this.type=o,this.normalized=n,this.stride=a,this.offset=s},Vn.ChemicalAccidentLayer=S,Vn.ChemicalAccidentManager=D,Vn.AbsControl=_,Vn.Attribution=y,Vn.Compass=T,Vn.FullScreen=C,Vn.InitCamera=b,Vn.Measure=M,Vn.OverviewMap=A,Vn.Tools=E,Vn.Zoom=L,Vn.AnimationData=N,Vn.AnimationManager=U,Vn.BoundingBox=G,Vn.BoundingSphere=z,Vn.BrowserEvent=V,Vn.BuildingSeed=k,Vn.BuildingSeedList=j,Vn.BuildingSeedMap=W,Vn.Camera=X,Vn.CCTV=q,Vn.CCTVList=Y,Vn.CesiumViewerInit=K,Vn.CollisionCheckScene=Z,Vn.Color=J,Vn.ColorRamp=Q,Vn.ControlCollection=$,Vn.CubeMapFBO=ee,Vn.DataType=te,Vn.DynamicColor=re,Vn.ExtrudeWorkerManager=ie,Vn.ExtrusionWorkerManager=oe,Vn.F4dController=ne,Vn.FBO=ae,Vn.FileRequestControler=se,Vn.FirstPersonView=he,Vn.Frustum=fe,Vn.FrustumVolumeControl=ge,Vn.GeographicCoord=pe,Vn.GeographicCoordSegment=me,Vn.GeographicCoordsList=ve,Vn.GeographicExtent=xe,Vn.GeoLocationData=_e,Vn.GeoLocationDataManager=ye,Vn.Globe=Te,Vn.HeightReference=Ce,Vn.IdentifierManager=be,Vn.InteractionCollection=Me,Vn.KoreaBuildingMaster=Ae,Vn.KoreaBuildingSeed=Ee,Vn.LightSource=Le,Vn.Mago3d=Se,Vn.MagoEarthViewerInit=De,Vn.MagoEvent=Re,Vn.MagoLayer=Pe,Vn.MagoLayerCollection=Ie,Vn.MagoManager=Fe,Vn.MagoModel=Be,Vn.ManagerFactory=function e(t,r,i,o,n,a,s,l){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);var u=null,c=null,d=I.magoManagerState.INIT,h=l||{};function f(){u.handler.setInputAction(function(e){u.mouseActionLeftDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.LEFT_DOWN),u.handler.setInputAction(function(e){u.mouseActionMiddleDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_DOWN),u.handler.setInputAction(function(e){u.mouseActionRightDown(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.RIGHT_DOWN),u.handler.setInputAction(function(e){var r;u.mouseLeftDown?e.startPosition.x===e.endPosition.x&&e.startPosition.y===e.endPosition.y||(u.manageMouseDragging(e.startPosition.x,e.startPosition.y),u.cameraMoved()):(u.mouseDragging=!1,r=!0,t.scene.screenSpaceCameraController.enableRotate=r,t.scene.screenSpaceCameraController.enableZoom=r,t.scene.screenSpaceCameraController.enableLook=r,t.scene.screenSpaceCameraController.enableTilt=r,t.scene.screenSpaceCameraController.enableTranslate=r,(u.mouseMiddleDown||u.mouseRightDown)&&(u.isCameraMoving=!0,u.cameraMoved()))},Cesium.ScreenSpaceEventType.MOUSE_MOVE),u.handler.setInputAction(function(e){u.mouseActionLeftUp(e.position.x,e.position.y);var t={lat:null,lon:null,alt:null},r=u.scene.camera.pickEllipsoid(e.position);if(r){var o=Cesium.Cartographic.fromCartesian(r);t.lat=Cesium.Math.toDegrees(o.latitude),t.lon=Cesium.Math.toDegrees(o.longitude),t.alt=o.height}"true"===O.getPolicy().geo_callback_enable&&""!==i.geo_callback_clickposition&&clickPositionCallback(i.geo_callback_clickposition,t)},Cesium.ScreenSpaceEventType.LEFT_UP),u.handler.setInputAction(function(e){u.mouseActionMiddleUp(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.MIDDLE_UP),u.handler.setInputAction(function(e){u.mouseActionRightUp(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.RIGHT_UP),u.handler.setInputAction(function(e){u.mouseActionLeftClick(e.position.x,e.position.y)},Cesium.ScreenSpaceEventType.LEFT_CLICK)}function g(){var e,r;O.getPolicy().basicGlobe===F.CESIUM?function(){var e=t.scene.context._gl;if(t.scene.magoManager.postFxShadersManager.gl=e,t.scene.magoManager.postFxShadersManager.createDefaultShaders(e),t.scene.magoManager.createDefaultShaders(e),t.scene.magoManager.scene=t.scene,u=t.scene.magoManager,c=t.scene,t.scene.globe.depthTestAgainstTerrain=!0,t.scene.logarithmicDepthBuffer=!1,t.scene.highDynamicRange=!1,null!==o&&o.length>0)for(var r=0;r<o.length;r++){var s=a[r],l=n[r];l.data_key===s&&l.attributes.isReference||t.scene.magoManager.getObjectIndexFile(o[r],s)}i.geo_tile_path&&""!==i.geo_tile_path&&t.scene.magoManager.getObjectIndexFileSmartTileF4d(i.geo_tile_path),t.scene.magoManager.handler=new Cesium.ScreenSpaceEventHandler(c.canvas),f(),t.clock.onTick.addEventListener(function(e){u.cameraFPV.update(u)}),t.camera.changed.addEventListener(function(e){u.cameraChanged(e)}),t.camera.moveEnd.addEventListener(function(e){u.cameraMoveEnd(e)}),t.camera.moveStart.addEventListener(function(e){u.cameraMoveStart(e)})}():O.getPolicy().basicGlobe===F.MAGOWORLD&&(e=t.magoManager.sceneState.gl,(r=t.magoManager).vboMemoryManager.gl=e,r.postFxShadersManager.gl=e,r.postFxShadersManager.createDefaultShaders(e),r.createDefaultShaders(e))}h.animation=h.animation||!1,h.timeline=h.timeline||!1,O.init(i,o,n);var p,m,v="ESRI World Imagery",x="WGS84 Ellipsoid";if(null===i.basicGlobe||""===i.basicGlobe||i.basicGlobe===F.CESIUM){if((y=document.getElementById(r)).addEventListener("webglcontextlost",function(e){console.log(e)},!1),y.addEventListener("webglcontextrestored",function(e){console.log(e)},!1),"true"===i.geo_server_enable&&null!==i.geo_server_url&&""!==i.geo_server_url){var _=new Cesium.WebMapServiceImageryProvider({url:i.geo_server_url,layers:i.geo_server_layers,parameters:{service:i.geo_server_parameters_service,version:i.geo_server_parameters_version,request:i.geo_server_parameters_request,transparent:i.geo_server_parameters_transparent,format:i.geo_server_parameters_format},enablePickFeatures:!1});h.imageryProvider=_,h.baseLayerPicker=!1,h.antialias=!0,null===t&&(t=new Cesium.Viewer(r,h))}else null!==i.cesiumIonToken&&""!==i.cesiumIonToken&&(Cesium.Ion.defaultAccessToken=i.cesiumIonToken,x="Cesium World Terrain"),h.shouldAnimate=!0,null===t&&(t=new Cesium.Viewer(r,h)),function(){if(null!==O.getPolicy().initDefaultTerrain&&""!==O.getPolicy().initDefaultTerrain&&(x=O.getPolicy().initDefaultTerrain),void 0!==t&&void 0!==t.baseLayerPicker){var e=null,r=t.baseLayerPicker.viewModel.imageryProviderViewModels;for(var i in r)if(r.hasOwnProperty(i)&&(a=r[i]).name===v){e=a;break}e&&(t.baseLayerPicker.viewModel.selectedImagery=e);var o=null,n=t.baseLayerPicker.viewModel.terrainProviderViewModels;for(var i in n){var a;if(n.hasOwnProperty(i)&&(a=n[i]).name===x){o=a;break}}o&&(t.baseLayerPicker.viewModel.selectedTerrain=o)}}();t.scene.magoManager=new Fe,t.scene.magoManager.sceneState.textureFlipYAxis=!1,t.camera.frustum.fov=1.8*Cesium.Math.PI_OVER_THREE,O.getPolicy().initDefaultFov>0&&(t.camera.frustum.fov=Cesium.Math.PI_OVER_THREE*O.getPolicy().initDefaultFov),"true"===i.geo_server_enable&&null!==i.geo_server_add_url&&""!==i.geo_server_add_url&&(m=new Cesium.WebMapServiceImageryProvider({url:O.getPolicy().geo_server_add_url,layers:O.getPolicy().geo_server_add_layers,parameters:{service:O.getPolicy().geo_server_add_parameters_service,version:O.getPolicy().geo_server_add_parameters_version,request:O.getPolicy().geo_server_add_parameters_request,transparent:O.getPolicy().geo_server_add_parameters_transparent,format:O.getPolicy().geo_server_add_parameters_format}}),t.imageryLayers.addImageryProvider(m)),g(),t.entities.add({name:"mago3D",position:Cesium.Cartesian3.fromDegrees(37.521168,126.924185,3e3),box:{dimensions:new Cesium.Cartesian3(3e8,3e8,3e8),fill:!0,material:Cesium.Color.BLUE,outline:!1}}),i.initCameraEnable&&t.camera.flyTo({destination:Cesium.Cartesian3.fromDegrees(parseFloat(O.getPolicy().initLatitude),parseFloat(O.getPolicy().initLongitude),parseFloat(O.getPolicy().initHeight)),duration:parseInt(O.getPolicy().initDuration)}),p=new R("renderMode"),u.callAPI(p)}else if(i.geo_view_library===F.MAGOWORLD){var y,T={antialias:!0,stencil:!0,premultipliedAlpha:!0},C=(y=document.getElementById(r)).getContext("webgl",T);C||(C=y.getContext("experimental-webgl",T)),y.width=y.clientWidth,y.height=y.clientHeight;var b=(u=new Fe).sceneState;b.textureFlipYAxis=!1,b.gl=C,b.drawingBufferWidth[0]=y.clientWidth,b.drawingBufferHeight[0]=y.clientHeight,b.camera.frustum.aspectRatio[0]=y.clientWidth/y.clientHeight,b.camera.frustum.fovRad[0]=Math.PI/3*1.8,b.camera.frustum.fovyRad[0]=b.camera.frustum.fovRad[0]/b.camera.frustum.aspectRatio[0],b.camera.frustum.tangentOfHalfFovy[0]=Math.tan(b.camera.frustum.fovyRad[0]/2),b.camera.position.set(-7586937.743019165,10881859.054284709,5648264.99911627),b.camera.direction.set(.5307589970384617,-.7598419113077192,-.3754132585133587),b.camera.up.set(.23477224008249162,-.29380469331271475,.9265855321012102),b.encodedCamPosHigh[0]=-7536640,b.encodedCamPosHigh[1]=10878976,b.encodedCamPosHigh[2]=5636096,b.encodedCamPosLow[0]=-50297.7421875,b.encodedCamPosLow[1]=2883.05419921875,b.encodedCamPosLow[2]=12168.9990234375,t=new zr(u),u.magoWorld=t,u.globe=new Te,t.updateModelViewMatrixByCamera(b.camera),u.tinTerrainManager=new gr,y.addEventListener("mousedown",function(e){t.mousedown(e)},!1),y.addEventListener("mouseup",function(e){t.mouseup(e)},!1),y.addEventListener("mousewheel",function(e){t.mousewheel(e)},!1),y.addEventListener("mousemove",function(e){t.mousemove(e)},!1),y.addEventListener("click",function(e){t.mouseclick(e)},!1),y.addEventListener("resize",function(e){console.log("resize")},!1),y.addEventListener("keydown",function(e){t.keydown(e)},!1),g()}return u.magoPolicy.imagePath=s,d=I.magoManagerState.READY,document.addEventListener("keydown",function(e){if(!u.magoPolicy.issueInsertEnable&&(u.keyDown(e.keyCode),void 0!==u.buildingSelected)){var t=u.selectionManager.currentNodeSelected;if(void 0!==t){var r=t.getRoot().data.geoLocDataManager.getCurrentGeoLocationData();if(void 0!==r&&u.magoPolicy.objectMoveMode===I.moveMode.ALL){var i=r.heading||0,o=r.pitch||0,n=r.roll||0,a=r.geographicCoord.altitude||0,s=!1;e.keyCode==="Q".charCodeAt(0)?(i+=3,s=!0):e.keyCode==="A".charCodeAt(0)&&(i-=3,s=!0),e.keyCode==="W".charCodeAt(0)?(o+=3,s=!0):e.keyCode==="S".charCodeAt(0)&&(o-=3,s=!0),e.keyCode==="E".charCodeAt(0)?(n+=3,s=!0):e.keyCode==="D".charCodeAt(0)&&(n-=3,s=!0),e.keyCode==="Z".charCodeAt(0)?(a+=.2,s=!0):e.keyCode==="X".charCodeAt(0)&&(a-=.2,s=!0),s&&u.changeLocationAndRotationNode(t,r.geographicCoord.latitude,r.geographicCoord.longitude,a,i,o,n)}}}},!1),{callAPI:function(e){if(e.getReturnable())return u.callAPI(e);u.callAPI(e)},getViewer:function(){return t},getMagoManagerState:function(){return d},getMagoManager:function(){return u}}},Vn.Matrix4=Ne,Vn.Message=Ui,Vn.MouseAction=Ge,Vn.Movement=ze,Vn.ObjectMarker=He,Vn.ObjectMarkerManager=Ve,Vn.OcclusionCullingOctree=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this._ocCulling_box=new ke(null),this._infinite_ocCulling_box=new ke(null)},Vn.OcclusionCullingOctreeCell=ke,Vn.Pin=je,Vn.Plane=We,Vn.Quaternion=Xe,Vn.SelectionColor=Ye,Vn.Settings=qe,Vn.SmartTile=Ke,Vn.SmartTileManager=Ze,Vn.Sphere=Je,Vn.SplitValue=Qe,Vn.SpotLight=$e,Vn.SunSystem=et,Vn.TenelevenExtrudeWorkerManager=tt,Vn.TerranTile=rt,Vn.Texture=it,Vn.TextureLayer=ot,Vn.TextureLayerFilter=nt,Vn.TexturesManager=at,Vn.TexturesStore=st,Vn.TriPolyhedron=ct,Vn.TriSurface=dt,Vn.VboBuffer=ht,Vn.VBOKeysNation=ft,Vn.VBOKeysStore=gt,Vn.VBOKeysWorld=pt,Vn.VBOMemoryManager=mt,Vn.VBOVertexIdxCacheKey=vt,Vn.VBOVertexIdxCacheKeysContainer=xt,Vn.VisibleObjectsController=_t,Vn.WMSLayer=yt,Vn.WorkersManager=Tt,Vn.XYZLayer=Ct,Vn.API=R,Vn.ChangeHistory=P,Vn.CODE=I,Vn.Constant=F,Vn.MagoConfig=O,Vn.Policy=B,Vn.Effect=bt,Vn.EffectsManager=Mt,Vn.ElectroMagnetismLayer=At,Vn.ElectroMagnetismManager=Et,Vn.ElectroMagnetismTimeSlice=Lt,Vn.Accessor=zt,Vn.Block=Ht,Vn.BlocksArrayPartition=Vt,Vn.BlocksList=kt,Vn.CollisionCheckOctree=jt,Vn.HierarchyManager=Wt,Vn.InspectorBox=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR)},Vn.Lego=Xt,Vn.LoadQueue=qt,Vn.LodBuilding=Kt,Vn.LodBuildingData=Zt,Vn.MetaData=Jt,Vn.ModelReferencedGroup=Qt,Vn.MultiBuildings=er,Vn.MultiBuildingsElement=tr,Vn.NeoBuilding=rr,Vn.NeoBuildingsList=ir,Vn.NeoReference=or,Vn.NeoReferencesMotherAndIndices=nr,Vn.NeoSimpleBuilding=ar,Vn.NeoTexture=sr,Vn.Node=lr,Vn.Octree=ur,Vn.ParseQueue=cr,Vn.ProcessQueue=dr,Vn.ProjectTree=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.root,this.nodesArray=[]},Vn.ReaderWriter=hr,Vn.SkinBuilding=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.multiBuildingsOwner,this.indexRange},Vn.TinTerrain=fr,Vn.TinTerrainManager=gr,Vn.Arc2D=vr,Vn.AxisXYZ=xr,Vn.BoundingRectangle=_r,Vn.BoxAux=yr,Vn.BSplineCubic3D=Tr,Vn.Circle2D=Cr,Vn.Cluster=br,Vn.CuttingPlane=Mr,Vn.Excavation=Ar,Vn.Face=Er,Vn.HalfEdge=Lr,Vn.HalfEdgesList=wr,Vn.IndexData=Sr,Vn.IndexRange=Dr,Vn.Intersect={OUTSIDE:0,INTERSECT:1,INSIDE:2,POINT_A:3,POINT_B:4},Vn.Line=Rr,Vn.Line2D=Pr,Vn.MagoGeometry=Ir,Vn.MagoNativeProject=Fr,Vn.MagoPoint=Or,Vn.MagoPolyline=Br,Vn.MagoPolylineGround=Nr,Vn.MagoRectangle=Ur,Vn.MagoRectangleGround=Gr,Vn.MagoWorld=zr,Vn.Material=Hr,Vn.MaterialsManager=Vr,Vn.Mesh=kr,Vn.Modeler=jr,Vn.ParametricMesh=Wr,Vn.Path3D=Xr,Vn.PipeKnot=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.position,this.radius},Vn.PipePath=Yr,Vn.PlaneGrid=qr,Vn.Point2D=Kr,Vn.Point2DList=Zr,Vn.Point3D=Jr,Vn.Point3DList=Qr,Vn.Point4D=function e(t,r,i,o){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.x=void 0!==t?t:0,this.y=void 0!==r?r:0,this.z=void 0!==i?i:0,this.w=void 0!==o?o:0,this.pointType},Vn.Polygon2D=$r,Vn.PolyLine2D=ei,Vn.PolyLine3D=ti,Vn.ProcessCounterManager=ri,Vn.Profile2D=ii,Vn.Profiles2DList=oi,Vn.QuantizedMeshExcavationSet=ni,Vn.QuantizedMeshManager=ai,Vn.QuantizedSurface=ci,Vn.QuatTree=di,Vn.Rectangle2D=hi,Vn.Ring2D=fi,Vn.Ring2DList=gi,Vn.RingType={ARC:0,CIRCLE:1,POLYLINE:2,RECTANGLE:3,Star2D:4,NUMBER_OF_RING_TYPE:5},Vn.ScreenQuad=pi,Vn.Segment2D=mi,Vn.Segment3D=vi,Vn.ShadowMesh=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.name,this.id,this.mesh},Vn.Sky=xi,Vn.Star2D=_i,Vn.StaticModel=yi,Vn.Surface=Ci,Vn.Triangle=bi,Vn.Triangle2D=Mi,Vn.TrianglesList=Ai,Vn.TrianglesMatrix=Ei,Vn.Tunnel=Li,Vn.Vertex=wi,Vn.VertexList=Si,Vn.VertexMatrix=Di,Vn.VertexOctree=Ri,Vn.Voxelizer=Pi,Vn.VtxProfile=Ii,Vn.VtxProfilesList=Fi,Vn.VtxRing=Oi,Vn.VtxRingsList=Bi,Vn.VtxSegment=Ni,Vn.AbsClickInteraction=wt,Vn.AbsPointerInteraction=St,Vn.ClickInteraction=Dt,Vn.DrawGeometryInteraction=Rt,Vn.InteractionActiveType=Pt,Vn.InteractionEventType={LEFTMOUSEUP:"leftmouseup",LEFTMOUSEDOWN:"leftmousedown",MOUSEMOVE:"mousemove",DRAG:"drag"},Vn.LineDrawer=It,Vn.NativeUpDownInteraction=Ft,Vn.PointDrawer=Ot,Vn.PointSelectInteraction=Bt,Vn.RectangleDrawer=Nt,Vn.RotateInteraction=Ut,Vn.TranslateInteraction=Gt,Vn.ItineraryLayer=pr,Vn.ItineraryManager=mr,Vn.Message=Ui,Vn.MessageSource=Gi,Vn.GeoServer=zi,Vn.OceanFluxLayer=Hi,Vn.OceanFluxManager=Vi,Vn.AnimatedIcon=ki,Vn.AnimatedPerson=ji,Vn.Arrow=Wi,Vn.BasicFactory=Xi,Vn.BasicVehicle=Yi,Vn.Box=qi,Vn.ClippingBox=Ki,Vn.ClippingPlane=Zi,Vn.ConcentricTubes=Ji,Vn.Cone=Qi,Vn.Cylinder=$i,Vn.Ellipsoid=eo,Vn.ExtrusionBuilding=to,Vn.ExtrusionWall=ro,Vn.GolfHoleFlag=io,Vn.ImageViewerRectangle=oo,Vn.KoreaBuilding=no,Vn.LegendColorRamp=ao,Vn.LoftObject=so,Vn.MergedObject=lo,Vn.Pipe=uo,Vn.PointMesh=co,Vn.RenderableObject=ho,Vn.SkeletalAnimationObject=fo,Vn.SpeechBubble=go,Vn.TerrainScannerLinear=po,Vn.TestFreeContourWallBuilding=mo,Vn.Tube=vo,Vn.VectorExtrudedMesh=xo,Vn.VectorMesh=_o,Vn.VectorMeshWind=yo,Vn.Vehicle=To,Vn.Wheel=Co,Vn.Renderer=bo,Vn.RenderingSettings=Mo,Vn.SceneState=Ao,Vn.Selection=Eo,Vn.SelectionCandidateFamily=Lo,Vn.SelectionManager=wo,Vn.WebGlController=So,Vn.AttribLocationState=Io,Vn.PostFxShader=Fo,Vn.PostFxShadersManager=Oo,Vn.ShaderSource=Bo,Vn.Uniform1fDataPair=No,Vn.Uniform1iDataPair=Uo,Vn.UniformMatrix4fvDataPair=Go,Vn.UniformVec2fvDataPair=zo,Vn.UniformVec3fvDataPair=Ho,Vn.UniformVec4fvDataPair=Vo,Vn.MagoTexture3D=Do,Vn.SoundLayer=Ro,Vn.SoundManager=Po,Vn.Voxelizer=Pi,Vn.Network=ko,Vn.NetworkEdge=jo,Vn.NetworkNode=Wo,Vn.NetworkSpace=Xo,Vn.ByteColor=Yo,Vn.CameraController=function e(){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.startGeoCoord,this.targetGeoCoord,this.travelDurationInSeconds,this.acceleration,this.velocity},Vn.createGuid=qo,Vn.createWorker=Ko,Vn.defaultValue=Zo,Vn.defaultValueCheckLength=Jo,Vn.defined=Qo,Vn.geobufDecoder=$o,Vn.GeometryUtils=en,Vn.isEmpty=tn,Vn.loadWithXhr=rn,Vn.ManagerUtils=on,Vn.pointInPolygon=nn,Vn.Polyfill=an,Vn.TextUtils=sn,Vn.throwAbstractError=ln,Vn.true=!0,Vn.validateWithScheme=cn,Vn.Water=dn,Vn.WaterManager=hn,Vn.AnimationTimeController=fn,Vn.DustLayer=gn,Vn.DustVolume=pn,Vn.Image3D=xn,Vn.PollutionLayerTest=Tn,Vn.PollutionVolumeTest=Cn,Vn.PrecipitationLayer=Mn,Vn.SoundSurfaceLayer=En,Vn.SoundSurfaceVolume=Ln,Vn.TemperatureLayer=Dn,Vn.WeatherStation=Rn,Vn.WeatherVolume=function e(t){if(!(this instanceof e))throw new Error(Ue.CONSTRUCT_ERROR);this.weatherStation,this.extrusionHeight,this.displayBox,this.displayPlane,this.displayPlanesArray=[]},Vn.WindLayer=Pn,Vn.WindVolume=Fn,Vn.OlMago3d=OlMago3d,Vn["Promise.done"]=Promise.done,Vn.Promise=Promise,Vn.GMLDataContainer=On,Vn.JsonParsor_1_0_1=Bn,Vn.JsonParsor_1_0_3=Nn,Vn.CellSpaceMember=Un,Vn.StateMember=Gn,Vn.SurfaceMember=zn,Vn.TransitionMember=Hn,Vn}();